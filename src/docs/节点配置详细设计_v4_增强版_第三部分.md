# 流程引擎节点配置详细设计 v4.0（增强版）- 第三部分

## 📝 节点8: ALERT_ESCALATION（告警升级）⭐告警升级逻辑增强

### 🎨 节点元信息
- **图标**: 🔔
- **颜色**: #f97316（深橙色）
- **分类**: 告警升级节点
- **动作数量**: 7个
- **⭐特殊增强**: 用户不满意介入、告警级别提升

### 📖 节点描述
根据告警级别自动升级告警，通知更高层级的负责人。

### 🔗 系统联动
- ✅ 告警系统（告警升级）
- ✅ 工作人员联动（通知负责人）
- ✅ 协同系统（协同处理）

---

### ⚡ 自动模式配置（增强版）

```javascript
// ALERT_ESCALATION 自动模式 - 完整默认配置（增强告警升级逻辑）
{
  nodeType: "ALERT_ESCALATION",
  nodeId: "alert_escalation_auto",
  nodeName: "告警升级（自动模式）",
  autoMode: true,
  description: "根据告警级别自动升级告警，支持用户不满意介入和告警级别提升",
  
  actions: [
    {
      actionId: "alert_level_detection",
      actionName: "告警级别检测",
      enabled: true,
      priority: 1,
      config: {
        // 告警级别定义
        alertLevels: [
          {
            levelId: "level_0",
            levelName: "信息",
            levelValue: 0,               // 级别值（数字越大级别越高）
            color: "#10b981",            // 颜色
            priority: 0                  // 优先级
          },
          {
            levelId: "level_1",
            levelName: "警告",
            levelValue: 1,
            color: "#f59e0b",
            priority: 1
          },
          {
            levelId: "level_2",
            levelName: "高级",
            levelValue: 2,
            color: "#f97316",
            priority: 2
          },
          {
            levelId: "level_3",
            levelName: "严重",
            levelValue: 3,
            color: "#ef4444",
            priority: 3
          },
          {
            levelId: "level_4",
            levelName: "紧急",
            levelValue: 4,
            color: "#dc2626",
            priority: 4
          },
          {
            levelId: "level_5",
            levelName: "灾难",
            levelValue: 5,
            color: "#991b1b",
            priority: 5
          }
        ],
        // 当前告警级别
        currentAlertLevel: "level_1",    // 从上下文获取
        // 输出配置
        saveToContext: true,
        contextKey: "alertLevelDetection"
      }
    },
    {
      actionId: "user_dissatisfaction_detection",
      actionName: "用户不满意检测",
      enabled: true,
      priority: 2,
      config: {
        // ⭐用户不满意检测配置（新增）
        enableDetection: true,           // 是否启用用户不满意检测
        // 检测规则列表
        detectionRules: [
          {
            ruleId: "dissatisfaction_001",
            ruleName: "愤怒情绪检测",
            condition: "emotionResult.emotion === 'angry'",
            confidence: 0.8,              // 置信度阈值
            action: "immediate_intervention", // 动作（immediate_intervention: 立即介入, elevate_alert: 提升告警）
            description: "用户情绪愤怒，立即介入",
            enabled: true
          },
          {
            ruleId: "dissatisfaction_002",
            ruleName: "负面情绪检测",
            condition: "emotionResult.emotion === 'negative' && emotionResult.score >= 0.7",
            confidence: 0.7,
            action: "elevate_alert",
            alertLevelIncrement: 1,       // 告警级别提升值
            description: "用户情绪负面，提升告警级别",
            enabled: true
          },
          {
            ruleId: "dissatisfaction_003",
            ruleName: "投诉意图检测",
            condition: "intentResult.intent === 'complaint'",
            confidence: 0.9,
            action: "immediate_intervention",
            description: "用户投诉，立即介入",
            enabled: true
          },
          {
            ruleId: "dissatisfaction_004",
            ruleName: "负面关键词检测",
            condition: "containsNegativeKeywords(content, ['垃圾', '差评', '再也不买', '糟糕']) === true",
            confidence: 0.8,
            action: "elevate_alert",
            alertLevelIncrement: 2,       // 提升两级
            description: "检测到负面关键词，大幅提升告警",
            enabled: true
          }
        ],
        // 立即介入配置（新增）
        immediateIntervention: {
          enabled: true,                 // 是否启用立即介入
          interventionType: "notify_manager", // 介入类型（notify_manager: 通知经理, escalate: 升级, takeover: 接管）
          notifyChannels: ["robot", "email", "wechat"], // 通知渠道
          interventionMessage: "【紧急】用户${senderName}表示不满，请立即处理！", // 介入消息
          escalateTo: "level_3",         // 升级到的告警级别
          notifyStaff: {                 // 通知工作人员配置
            staffId: null,               // 工作人员ID（从上下文获取）
            message: "您的客户表示不满，请立即回复！" // 通知消息
          }
        },
        // 输出配置
        saveToContext: true,
        contextKey: "userDissatisfactionDetection"
      }
    },
    {
      actionId: "escalation_rule_evaluation",
      actionName: "升级规则评估",
      enabled: true,
      priority: 3,
      config: {
        // 升级规则列表
        escalationRules: [
          {
            ruleId: "escalation_001",
            ruleName: "时间自动升级",
            condition: "alertAge > 3600000", // 告警年龄超过1小时（毫秒）
            fromLevel: "level_1",         // 原级别
            toLevel: "level_2",           // 目标级别
            escalateTo: "manager",        // 通知对象（manager: 经理, director: 总监, admin: 管理员）
            description: "告警超过1小时未处理，升级到经理",
            enabled: true
          },
          {
            ruleId: "escalation_002",
            ruleName: "严重自动升级",
            condition: "riskLevel.level === 'critical'",
            fromLevel: "level_2",
            toLevel: "level_4",
            escalateTo: "director",
            description: "严重风险，直接升级到总监",
            enabled: true
          },
          {
            ruleId: "escalation_003",    // ⭐用户不满意升级（新增）
            ruleName: "用户不满意升级",
            condition: "userDissatisfactionDetection.detected === true",
            fromLevel: "level_1",
            toLevel: "level_3",
            escalateTo: "manager",
            description: "用户不满意，升级到经理",
            enabled: true
          },
          {
            ruleId: "escalation_004",    // ⭐连续失败升级（新增）
            ruleName: "连续失败升级",
            condition: "failureCount >= 3",
            fromLevel: "level_2",
            toLevel: "level_4",
            escalateTo: "director",
            description: "连续失败3次，升级到总监",
            enabled: true
          }
        ],
        // 升级条件配置
        escalationConditions: {
          maxEscalationLevel: "level_5", // 最大升级级别
          cooldownPeriod: 1800000,      // 冷却期（毫秒，30分钟）
          // 升级层级定义
          escalationHierarchy: [
            {
              level: "level_1",
              notify: "staff"           // level_1通知工作人员
            },
            {
              level: "level_2",
              notify: "manager"         // level_2通知经理
            },
            {
              level: "level_3",
              notify: "manager"         // level_3通知经理
            },
            {
              level: "level_4",
              notify: "director"        // level_4通知总监
            },
            {
              level: "level_5",
              notify: "admin"           // level_5通知管理员
            }
          ]
        },
        // 输出配置
        saveToContext: true,
        contextKey: "escalationRuleEvaluation"
      }
    },
    {
      actionId: "escalation_notification",
      actionName: "升级通知发送",
      enabled: true,
      priority: 4,
      config: {
        // 通知配置
        enableNotification: true,        // 是否启用通知
        // 通知渠道列表
        notificationChannels: [
          {
            channelId: "robot",
            channelName: "机器人通知",
            enabled: true,
            priority: 1                  // 渠道优先级
          },
          {
            channelId: "email",
            channelName: "邮件通知",
            enabled: true,
            priority: 2
          },
          {
            channelId: "wechat",
            channelName: "微信通知",
            enabled: true,
            priority: 3
          },
          {
            channelId: "sms",
            channelName: "短信通知",
            enabled: false,              // 短信通知默认关闭（成本较高）
            priority: 4
          },
          {
            channelId: "dingtalk",
            channelName: "钉钉通知",
            enabled: true,
            priority: 5
          }
        ],
        // 通知模板配置
        notificationTemplates: {
          email: {
            subject: "【告警升级】${alertName} - 级别：${alertLevel}",
            body: "告警信息：\n\n告警名称：${alertName}\n告警级别：${alertLevel}\n告警内容：${alertMessage}\n用户：${senderName}\n时间：${timestamp}\n\n请立即处理！"
          },
          wechat: {
            templateId: "template_escalation_notify",
            data: {
              alertName: "${alertName}",
              alertLevel: "${alertLevel}",
              senderName: "${senderName}",
              timestamp: "${timestamp}"
            }
          },
          dingtalk: {
            webhookUrl: "https://oapi.dingtalk.com/robot/send?access_token=xxx",
            message: {
              msgtype: "text",
              text: {
                content: "【告警升级】${alertName}（${alertLevel}）\n用户：${senderName}\n时间：${timestamp}"
              }
            }
          }
        },
        // 输出配置
        saveToContext: true,
        contextKey: "escalationNotification"
      }
    },
    {
      actionId: "escalation_logging",
      actionName: "升级记录",
      enabled: true,
      priority: 5,
      config: {
        // 保存配置
        saveToDatabase: true,            // 是否保存到数据库
        tableName: "alert_escalations",  // 目标表名
        // 记录字段列表
        logFields: [
          "escalationId",               // 升级ID
          "alertId",                    // 告警ID
          "fromLevel",                  // 原级别
          "toLevel",                    // 目标级别
          "ruleId",                     // 触发规则ID
          "reason",                     // 升级原因
          "escalationTime",             // 升级时间
          "escalatedBy",                // 升级触发者（system: 系统, manual: 人工）
          "notifiedPersons",            // 通知的人员列表
          "status",                     // 状态
          "timestamp"                   // 时间戳
        ],
        // 输出配置
        saveToContext: true,
        contextKey: "escalationLogging"
      }
    },
    {
      actionId: "escalation_workflow",
      actionName: "升级工作流",
      enabled: true,
      priority: 6,
      config: {
        // 工作流配置
        enableWorkflow: true,            // 是否启用工作流
        // 工作流步骤列表
        workflowSteps: [
          {
            stepId: "step_001",
            stepName: "评估告警",
            action: "evaluate_alert",    // 动作
            timeout: 300000,             // 超时时间（毫秒）
            required: true,              // 是否必需
            enabled: true
          },
          {
            stepId: "step_002",
            stepName: "发送通知",
            action: "send_notification",
            timeout: 60000,
            required: true,
            enabled: true
          },
          {
            stepId: "step_003",
            stepName: "记录升级",
            action: "log_escalation",
            timeout: 30000,
            required: true,
            enabled: true
          },
          {
            stepId: "step_004",         // ⭐人工介入步骤（新增）
            stepName: "人工介入",
            action: "human_intervention",
            timeout: 600000,             // 10分钟超时
            required: false,            // 不是必需步骤
            enabled: true
          }
        ],
        // 工作流执行配置
        executionMode: "sequential",     // 执行模式（sequential: 顺序, parallel: 并行）
        // 失败处理配置
        failureHandling: {
          onStepFailure: "continue",     // 步骤失败时（continue: 继续, stop: 停止, retry: 重试）
          retryCount: 2,                 // 重试次数
          retryDelay: 5000               // 重试延迟（毫秒）
        },
        // 输出配置
        saveToContext: true,
        contextKey: "escalationWorkflow"
      }
    },
    {
      actionId: "escalation_decision",
      actionName: "升级决策",
      enabled: true,
      priority: 7,
      config: {
        // 决策规则列表
        decisionRules: [
          {
            ruleId: "decision_001",
            ruleName: "人工接管",
            condition: "toLevel === 'level_4' || toLevel === 'level_5'", // 高级别告警
            action: "human_handover",     // 动作（human_handover: 人工接管, continue: 继续流程, alert: 发送告警）
            targetNode: "HUMAN_HANDOVER", // 目标节点
            description: "高级别告警，人工接管",
            enabled: true
          },
          {
            ruleId: "decision_002",      // ⭐用户不满意人工接管（新增）
            ruleName: "用户不满意人工接管",
            condition: "userDissatisfactionDetection.immediateIntervention === true",
            action: "human_handover",
            targetNode: "HUMAN_HANDOVER",
            description: "用户不满意，立即人工接管",
            enabled: true
          },
          {
            ruleId: "decision_003",
            ruleName: "继续流程",
            condition: "toLevel === 'level_1' || toLevel === 'level_2'",
            action: "continue",
            targetNode: "MESSAGE_EXIT",
            description: "低级别告警，继续流程",
            enabled: true
          }
        ],
        // 输出配置
        saveToContext: true,
        contextKey: "escalationDecision"
      }
    }
  ],
  
  nodeConfig: {
    enableLogging: true,
    enableMetrics: true,
    timeout: 60000,
    retryCount: 1
  }
}
```

---

## 📝 节点9: HUMAN_HANDOVER（人工接管）

### 🎨 节点元信息
- **图标**: 👥
- **颜色**: #8b5cf6（紫色）
- **分类**: 人工接管节点
- **动作数量**: 6个

### 📖 节点描述
通知工作人员接管会话，分配责任人，记录交接信息。

### 🔗 系统联动
- ✅ 工作人员联动（通知工作人员）
- ✅ 会话管理（会话状态更新）
- ✅ 协同系统（协同处理）

---

### ⚡ 自动模式配置

```javascript
// HUMAN_HANDOVER 自动模式 - 完整默认配置
{
  nodeType: "HUMAN_HANDOVER",
  nodeId: "human_handover_auto",
  nodeName: "人工接管（自动模式）",
  autoMode: true,
  description: "通知工作人员接管会话，分配责任人，记录交接信息",
  
  actions: [
    {
      actionId: "staff_assignment",
      actionName: "工作人员分配",
      enabled: true,
      priority: 1,
      config: {
        // 分配策略
        assignmentStrategy: "round_robin", // 分配策略（round_robin: 轮询, least_loaded: 最少负载, priority: 优先级）
        // 工作人员列表
        staffList: [
          {
            staffId: "staff_001",
            staffName: "张经理",
            role: "manager",             // 角色（manager: 经理, supervisor: 主管, agent: 客服）
            department: "客服部",         // 部门
            status: "active",            // 状态（active: 在线, busy: 忙碌, offline: 离线）
            workload: 5,                 // 当前负载（会话数）
            maxWorkload: 10,             // 最大负载
            priority: 1,                 // 优先级（数字越小优先级越高）
            enabled: true,
            skills: ["complaint", "after_sales"], // 技能标签
            schedule: {                  // 工作时间
              workDays: [1, 2, 3, 4, 5], // 工作日（1-7，周一到周日）
              workHours: {               // 工作时间
                start: "09:00",
                end: "18:00"
              }
            }
          },
          {
            staffId: "staff_002",
            staffName: "李主管",
            role: "supervisor",
            department: "客服部",
            status: "active",
            workload: 3,
            maxWorkload: 10,
            priority: 2,
            enabled: true,
            skills: ["conversion", "service"],
            schedule: {
              workDays: [1, 2, 3, 4, 5],
              workHours: {
                start: "09:00",
                end: "18:00"
              }
            }
          }
        ],
        // 技能匹配配置
        enableSkillMatching: true,       // 是否启用技能匹配
        skillRequirements: {             // 技能需求（根据意图和情绪）
          complaint: ["complaint", "emotional_support"],
          after_sales: ["after_sales"],
          conversion: ["conversion"],
          service: ["service", "technical_support"]
        },
        // 工作时间检查
        checkWorkTime: true,             // 是否检查工作时间
        // 输出配置
        saveToContext: true,
        contextKey: "staffAssignment"
      }
    },
    {
      actionId: "handover_notification",
      actionName: "交接通知发送",
      enabled: true,
      priority: 2,
      config: {
        // 通知配置
        enableNotification: true,        // 是否启用通知
        // 通知渠道列表
        notificationChannels: ["email", "wechat", "dingtalk"],
        // 通知模板配置
        notificationTemplate: {
          email: {
            subject: "【人工接管】会话${sessionId}需要处理",
            body: "会话信息：\n\n会话ID：${sessionId}\n用户：${senderName}\n消息内容：${content}\n意图：${intent}\n情绪：${emotion}\n\n请及时处理！"
          },
          wechat: {
            templateId: "template_handover_notify",
            data: {
              sessionId: "${sessionId}",
              senderName: "${senderName}",
              content: "${content}",
              intent: "${intent}"
            }
          },
          dingtalk: {
            webhookUrl: "https://oapi.dingtalk.com/robot/send?access_token=xxx",
            message: {
              msgtype: "text",
              text: {
                content: "【人工接管】${senderName}需要人工协助\n会话ID：${sessionId}"
              }
            }
          }
        },
        // 用户通知配置
        notifyUser: true,                // 是否通知用户
        userMessage: "您的请求已转接给人工客服，稍后会有专人为您服务。", // 通知用户的消息
        // 输出配置
        saveToContext: true,
        contextKey: "handoverNotification"
      }
    },
    {
      actionId: "session_transfer",
      actionName: "会话转移",
      enabled: true,
      priority: 3,
      config: {
        // 会话转移配置
        transferSession: true,           // 是否转移会话
        tableName: "sessions",           // 目标表名
        // 转移字段列表
        transferFields: [
          "assignedStaffId",             // 分配的工作人员ID
          "assignedStaffName",           // 分配的工作人员名称
          "status",                      // 状态（transferred: 已转移, processing: 处理中）
          "transferTime",                // 转移时间
          "transferReason"               // 转移原因
        ],
        // 输出配置
        saveToContext: true,
        contextKey: "sessionTransfer"
      }
    },
    {
      actionId: "handover_logging",
      actionName: "交接记录",
      enabled: true,
      priority: 4,
      config: {
        // 保存配置
        saveToDatabase: true,            // 是否保存到数据库
        tableName: "handover_records",   // 目标表名
        // 记录字段列表
        logFields: [
          "handoverId",                 // 交接ID
          "sessionId",                  // 会话ID
          "messageId",                  // 消息ID
          "fromRobotId",                // 原机器人ID
          "toStaffId",                  // 目标工作人员ID
          "toStaffName",                // 目标工作人员名称
          "transferReason",             // 转移原因
          "transferTime",               // 转移时间
          "transferedBy",               // 转移触发者（system: 系统, manual: 人工）
          "contextSnapshot",            // 上下文快照（JSON）
          "status",                     // 状态
          "timestamp"                   // 时间戳
        ],
        // 输出配置
        saveToContext: true,
        contextKey: "handoverLogging"
      }
    },
    {
      actionId: "ai_pause",
      actionName: "AI暂停",
      enabled: true,
      priority: 5,
      config: {
        // 暂停配置
        pauseAI: true,                   // 是否暂停AI
        // 暂停原因记录
        pauseReason: "human_handover",   // 暂停原因
        // 暂停时长配置
        pauseDuration: 3600000,         // 暂停时长（毫秒，1小时），0表示永久暂停
        // 暂停期间行为
        pauseBehavior: "listen_only",    // 暂停期间行为（listen_only: 仅监听, disabled: 完全禁用）
        // 输出配置
        saveToContext: true,
        contextKey: "aiPause"
      }
    },
    {
      actionId: "handover_decision",
      actionName: "交接决策",
      enabled: true,
      priority: 6,
      config: {
        // 决策规则列表
        decisionRules: [
          {
            ruleId: "decision_001",
            ruleName: "结束流程",
            condition: "handoverCompleted === true",
            action: "end_flow",          // 动作（end_flow: 结束流程, continue: 继续）
            targetNode: "FLOW_END",      // 目标节点
            description: "交接完成，结束流程",
            enabled: true
          }
        ],
        // 输出配置
        saveToContext: true,
        contextKey: "handoverDecision"
      }
    }
  ],
  
  nodeConfig: {
    enableLogging: true,
    enableMetrics: true,
    timeout: 30000,
    retryCount: 1
  }
}
```

---

## 📝 节点10: FLOW_END（流程结束）

### 🎨 节点元信息
- **图标**: ✅
- **颜色**: #22c55e（绿色）
- **分类**: 结束节点
- **动作数量**: 5个

### 📖 节点描述
结束流程，清理资源，记录完成信息。

### 🔗 系统联动
- ✅ 流程控制（流程结束）
- ✅ 会话管理（会话关闭）

---

### ⚡ 自动模式配置

```javascript
// FLOW_END 自动模式 - 完整默认配置
{
  nodeType: "FLOW_END",
  nodeId: "flow_end_auto",
  nodeName: "流程结束（自动模式）",
  autoMode: true,
  description: "结束流程，清理资源，记录完成信息",
  
  actions: [
    {
      actionId: "session_close",
      actionName: "会话关闭",
      enabled: true,
      priority: 1,
      config: {
        // 关闭配置
        closeSession: true,              // 是否关闭会话
        tableName: "sessions",           // 目标表名
        // 更新字段列表
        updateFields: [
          "status",                      // 状态（closed: 已关闭）
          "endTime",                     // 结束时间
          "duration",                    // 持续时间
          "messageCount",                // 消息总数
          "aiResponseCount",             // AI回复数
          "humanInterventionCount",      // 人工干预数
          "completionReason"             // 完成原因
        ],
        // 输出配置
        saveToContext: true,
        contextKey: "sessionClose"
      }
    },
    {
      actionId: "resource_cleanup",
      actionName: "资源清理",
      enabled: true,
      priority: 2,
      config: {
        // 清理配置
        enableCleanup: true,             // 是否启用清理
        // 清理项列表
        cleanupItems: [
          {
            itemId: "context_cache",
            itemName: "上下文缓存",
            enabled: true,
            description: "清理流程上下文缓存"
          },
          {
            itemId: "temp_files",
            itemName: "临时文件",
            enabled: true,
            description: "清理临时上传的文件"
          },
          {
            itemId: "websocket_connections",
            itemName: "WebSocket连接",
            enabled: false,              // WebSocket连接不自动关闭（前端控制）
            description: "关闭WebSocket连接"
          }
        ],
        // 输出配置
        saveToContext: true,
        contextKey: "resourceCleanup"
      }
    },
    {
      actionId: "flow_logging",
      actionName: "流程记录",
      enabled: true,
      priority: 3,
      config: {
        // 保存配置
        saveToDatabase: true,            // 是否保存到数据库
        tableName: "flow_executions",    // 目标表名
        // 记录字段列表
        logFields: [
          "flowId",                     // 流程ID
          "sessionId",                  // 会话ID
          "messageId",                  // 消息ID
          "startNode",                  // 起始节点
          "endNode",                    // 结束节点
          "nodesExecuted",              // 执行的节点列表
          "startTime",                  // 开始时间
          "endTime",                    // 结束时间
          "duration",                   // 持续时间（毫秒）
          "status",                     // 状态（completed: 已完成, failed: 失败, cancelled: 已取消）
          "completionReason",           // 完成原因
          "error",                      // 错误信息
          "metrics",                    // 指标（JSON）
          "timestamp"                   // 时间戳
        ],
        // 输出配置
        saveToContext: true,
        contextKey: "flowLogging"
      }
    },
    {
      actionId: "statistics_summary",
      actionName: "统计汇总",
      enabled: true,
      priority: 4,
      config: {
        // 汇总配置
        enableSummary: true,             // 是否启用汇总
        // 汇总维度列表
        summaryDimensions: [
          "date",                        // 日期
          "hour",                        // 小时
          "robotId",                     // 机器人ID
          "intent",                      // 意图
          "emotion",                     // 情绪
          "status"                       // 状态
        ],
        // 汇总指标列表
        summaryMetrics: [
          "totalFlows",                 // 总流程数
          "completedFlows",             // 完成的流程数
          "failedFlows",                // 失败的流程数
          "averageDuration",            // 平均持续时间
          "averageNodesExecuted",       // 平均执行节点数
          "aiResponseRate",             // AI回复率
          "humanInterventionRate",      // 人工干预率
          "successRate"                 // 成功率
        ],
        // 输出配置
        saveToContext: true,
        contextKey: "statisticsSummary"
      }
    },
    {
      actionId: "final_output",
      actionName: "最终输出",
      enabled: true,
      priority: 5,
      config: {
        // 输出数据结构
        outputData: {
          flowId: "flowId",             // 流程ID
          sessionId: "sessionId",       // 会话ID
          status: "completed",          // 状态
          message: "流程执行成功",       // 消息
          result: {                     // 结果
            aiResponse: "aiResponse.content",
            humanIntervention: "humanHandover.assigned",
            handover: "handoverDecision.completed"
          },
          metrics: {                    // 指标
            duration: "duration",
            nodesExecuted: "nodesExecuted.length",
            success: "status === 'completed'"
          }
        },
        // 输出配置
        saveToContext: true,
        contextKey: "finalOutput"
      }
    }
  ],
  
  nodeConfig: {
    enableLogging: true,
    enableMetrics: true,
    timeout: 10000,
    retryCount: 0
  }
}
```

---

## 🎯 完整UI配置表单（剩余节点）

### 节点8: ALERT_ESCALATION（告警升级）

**动作1：告警级别检测**

| 配置项 | 中文标签 | 类型 | 默认值 | 可选值 | 说明 |
|--------|---------|------|--------|--------|------|
| `enabled` | 启用此动作 | 开关 | `开启` | 开启/关闭 | 是否执行此动作 |
| `priority` | 执行优先级 | 数字 | `1` | 1-100 | 数字越小优先级越高 |

**动作2：用户不满意检测** ⭐新增

| 配置项 | 中文标签 | 类型 | 默认值 | 可选值 | 说明 |
|--------|---------|------|--------|--------|------|
| `enabled` | 启用此动作 | 开关 | `开启` | 开启/关闭 | 是否执行此动作 |
| `priority` | 执行优先级 | 数字 | `2` | 1-100 | 数字越小优先级越高 |
| `enableDetection` | 启用检测 | 开关 | `开启` | 开启/关闭 | 是否启用用户不满意检测 |

**检测规则配置**

| 配置项 | 中文标签 | 类型 | 默认值 | 说明 |
|--------|---------|------|--------|------|
| `ruleName` | 规则名称 | 文本 | - | 规则的显示名称 |
| `condition` | 条件表达式 | 代码编辑器 | - | JS表达式，如`emotionResult.emotion === 'angry'` |
| `confidence` | 置信度阈值 | 滑块 | `0.8` | 0-1 | 匹配的置信度阈值 |
| `action` | 动作 | 下拉 | `提升告警级别` | 立即介入/提升告警级别 | 触发后的动作 |
| `alertLevelIncrement` | 告警级别提升值 | 数字 | `1` | 1-5 | 提升的告警级别数 |

**立即介入配置** ⭐新增

| 配置项 | 中文标签 | 类型 | 默认值 | 可选值 | 说明 |
|--------|---------|------|--------|--------|------|
| `enabled` | 启用立即介入 | 开关 | `开启` | 开启/关闭 | 是否启用立即介入 |
| `interventionType` | 介入类型 | 下拉 | `通知经理` | 通知经理/升级/接管 | 介入方式 |
| `escalateTo` | 升级到的告警级别 | 下拉 | `严重` | 信息/警告/高级/严重/紧急/灾难 | 升级目标 |

---

### 节点9: HUMAN_HANDOVER（人工接管）

**动作1：工作人员分配**

| 配置项 | 中文标签 | 类型 | 默认值 | 可选值 | 说明 |
|--------|---------|------|--------|--------|------|
| `enabled` | 启用此动作 | 开关 | `开启` | 开启/关闭 | 是否执行此动作 |
| `priority` | 执行优先级 | 数字 | `1` | 1-100 | 数字越小优先级越高 |
| `assignmentStrategy` | 分配策略 | 下拉 | `轮询` | 轮询/最少负载/优先级 | 工作人员分配方式 |
| `enableSkillMatching` | 启用技能匹配 | 开关 | `开启` | 开启/关闭 | 是否根据技能匹配工作人员 |
| `checkWorkTime` | 检查工作时间 | 开关 | `开启` | 开启/关闭 | 是否检查工作人员是否在岗 |

**工作人员列表配置**

| 配置项 | 中文标签 | 类型 | 默认值 | 说明 |
|--------|---------|------|--------|------|
| `staffName` | 工作人员名称 | 文本 | - | 工作人员姓名 |
| `role` | 角色 | 下拉 | `客服` | 经理/主管/客服 | 工作人员角色 |
| `department` | 部门 | 文本 | - | 所属部门 |
| `priority` | 优先级 | 数字 | `1` | 1-10 | 分配优先级 |
| `enabled` | 启用此工作人员 | 开关 | `开启` | 开启/关闭 | 是否参与分配 |

---

### 节点10: FLOW_END（流程结束）

**动作1：会话关闭**

| 配置项 | 中文标签 | 类型 | 默认值 | 可选值 | 说明 |
|--------|---------|------|--------|--------|------|
| `enabled` | 启用此动作 | 开关 | `开启` | 开关 | 是否执行此动作 |
| `priority` | 执行优先级 | 数字 | `1` | 1-100 | 数字越小优先级越高 |
| `closeSession` | 关闭会话 | 开关 | `开启` | 开关 | 是否关闭会话 |

---

## 🚀 实施指南

### 1. 自动模式使用指南

**启用自动模式**:
```javascript
{
  autoMode: true,  // 设置为true启用自动模式
  // 系统将使用预配置的默认JSON
}
```

**自定义配置**:
```javascript
{
  autoMode: false, // 设置为false关闭自动模式
  // 然后可以自由修改每个动作的配置
  actions: [
    {
      actionId: "message_receive",
      // 自定义配置...
    }
  ]
}
```

### 2. 机器人联动逻辑实施

**企业微信官方机器人发送**:
1. 配置Webhook URL（从企业微信群聊设置获取）
2. 选择消息类型（文本/Markdown/图片/文件/图文）
3. 配置@人选项（@特定人员/@所有人）
4. 设置限流参数（每分钟最多20条）

**自定义机器人发送**:
1. 配置API端点（WorkTool API）
2. 设置认证方式（API密钥/Token/OAuth）
3. 配置接收者列表
4. 启用@人功能

**优先级与负载均衡**:
1. 设置消息优先级（严重/高/普通/低）
2. 配置负载均衡策略（轮询/最少负载/加权）
3. 启用队列（超过限流时排队）

### 3. 员工回复监测实施

**监测配置**:
1. 启用员工回复监测
2. 设置回复超时时间（如5分钟）
3. 配置频率调整规则
4. 设置不回复记录阈值

**频率调整**:
- 员工回复后：降低频率到30秒/次，持续10分钟
- 无回复时：提高频率到2秒/次，持续3分钟
- 调整结束：恢复默认频率5秒/次

**不回复记录**:
- 记录阈值：5分钟未回复
- 告警阈值：连续3次不回复触发告警
- 每天最大记录数：10次

### 4. 用户不满意介入实施

**检测规则**:
1. 愤怒情绪：立即介入
2. 负面情绪（得分>=0.7）：提升告警级别1级
3. 投诉意图：立即介入
4. 负面关键词：提升告警级别2级

**立即介入配置**:
1. 介入类型：通知经理/升级/接管
2. 通知渠道：机器人/邮件/微信
3. 告警级别：提升到严重（level_3）
4. 通知工作人员：发送提醒消息

**告警升级**:
1. 升级规则：时间自动升级/严重自动升级/用户不满意升级
2. 升级层级：level_1 → level_2 → level_3 → level_4 → level_5
3. 通知对象：staff → manager → director → admin

### 5. 前端UI集成

**自动模式开关**:
```typescript
const [autoMode, setAutoMode] = useState(true);

const handleAutoModeChange = (enabled: boolean) => {
  setAutoMode(enabled);
  if (enabled) {
    // 加载默认配置
    loadDefaultConfig();
  } else {
    // 允许用户修改
    enableCustomEdit();
  }
};
```

**中文UI渲染**:
```typescript
const renderConfig = (config: any) => {
  return Object.entries(config).map(([key, value]) => {
    const label = getChineseLabel(key);
    const options = getOptions(key);
    
    return (
      <div key={key}>
        <label>{label}</label>
        <Comment>{getDescription(key)}</Comment>
        <Select value={value} onChange={handleChange}>
          {options.map(opt => <Option value={opt.value}>{opt.label}</Option>)}
        </Select>
      </div>
    );
  });
};
```

### 6. 验证与测试

**测试清单**:
- [ ] 自动模式加载默认配置成功
- [ ] 手动模式可以修改配置
- [ ] 企业微信机器人发送成功
- [ ] 自定义机器人发送成功
- [ ] 员工回复监测正常工作
- [ ] 频率调整规则生效
- [ ] 用户不满意检测准确
- [ ] 立即介入触发成功
- [ ] 告警升级流程正常
- [ ] 所有前端UI选项中文化

---

## 📊 配置总结

### 节点配置统计

| 节点ID | 节点名称 | 动作数量 | 自动模式 | 特殊增强 |
|--------|---------|---------|---------|---------|
| 1 | MESSAGE_ENTRY | 6 | ✅ | - |
| 2 | SMART_ANALYZE | 6 | ✅ | - |
| 3 | FLOW_DECISION | 6 | ✅ | - |
| 4 | AI_AGENT | 8 | ✅ | - |
| 5 | RISK_HANDLER | 7 | ✅ | - |
| 6 | MESSAGE_EXIT | 8 | ✅ | ⭐机器人联动 |
| 7 | SMART_MONITOR | 6 | ✅ | ⭐员工回复监测 |
| 8 | ALERT_ESCALATION | 7 | ✅ | ⭐告警升级逻辑 |
| 9 | HUMAN_HANDOVER | 6 | ✅ | - |
| 10 | FLOW_END | 5 | ✅ | - |
| **总计** | **10个节点** | **65个动作** | **全部支持** | **3个节点增强** |

### 增强功能总结

| 功能模块 | 增强内容 | 实现节点 |
|---------|---------|---------|
| 自动模式 | 所有节点支持自动模式配置 | 全部10个节点 |
| 中文UI | 所有配置选项中文化并带注释 | 全部10个节点 |
| 机器人联动 | 企业微信官方机器人、自定义机器人、优先级、负载均衡 | MESSAGE_EXIT |
| 员工回复监测 | 检测员工回复、频率调整、不回复记录 | SMART_MONITOR |
| 用户不满意介入 | 检测用户不满意、立即介入、告警级别提升 | ALERT_ESCALATION |
| 告警升级 | 自动升级、升级层级、通知对象升级 | ALERT_ESCALATION |

---

## ✅ 完成检查

- ✅ 10个节点，65个动作（符合要求10-12个节点）
- ✅ 覆盖所有系统联动（消息处理、上下文管理、AI分析、信息中心、工作人员联动、告警管理、机器人管理、协同系统、监控中心、决策、消息发送、风险处理、流程控制）
- ✅ 所有节点提供自动模式及默认JSON代码
- ✅ 所有前端UI选项中文化并带注释
- ✅ 特别完善机器人联动逻辑（企业微信官方机器人、自定义机器人、@人、限流、重试、优先级、负载均衡）
- ✅ 特别完善员工回复监测逻辑（检测员工回复、降低频率、记录不回复）
- ✅ 特别完善用户不满意介入逻辑（检测不满意、立即介入、提升告警级别）

---

**文档版本**: v4.0（增强版）
**创建日期**: 2025-01-04
**最后更新**: 2025-01-04
**状态**: ✅ 完成
