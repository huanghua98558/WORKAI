# 节点配置面板修复说明

## 问题描述

用户反馈流程节点在可视化面板里没有更多设置选项。

## 问题原因

在 `NodeConfigPanel.tsx` 组件中，使用 `node.type` 来判断节点类型，但实际上：
- React Flow 的 `node.type` 字段被设置为 `'custom'`（自定义节点类型）
- 实际的节点类型存储在 `node.data.type` 字段中

这导致所有节点都被识别为未定义类型，无法显示对应的配置选项。

## 修复内容

### 1. 修复节点类型判断

**修改文件**: `src/app/flow-engine/components/NodeConfigPanel.tsx`

将所有的 `node.type` 判断改为 `node.data.type`：

```typescript
// ❌ 错误的判断方式
{node.type === 'message_receive' && <MessageReceiveConfig />}

// ✅ 正确的判断方式
{node.data.type === 'message_receive' && <MessageReceiveConfig />}
```

### 2. 修正 AI客服回复节点配置

**修改内容**:
- 将 `defaultModel` 改为 `defaultModelId`
- 将 `includeHistory` 和 `historyLimit` 移到 `context` 对象中

**修改前**:
```typescript
onChange('defaultModel', { modelId: e.target.value })
onChange('includeHistory', checked)
onChange('historyLimit', parseInt(e.target.value))
```

**修改后**:
```typescript
onChange('defaultModelId', value)
onChange('context', { ...(config.context || {}), includeHistory: checked })
onChange('context', { ...(config.context || {}), maxHistoryMessages: parseInt(e.target.value) })
```

### 3. 修正消息分发节点配置

**修改内容**:
- 将 `dispatchRules` 改为 `groupDispatch`、`privateDispatch`、`atMe` 三个独立对象
- 统一配置结构，与后端API一致

**修改前**:
```typescript
config.dispatchRules?.groupTarget
config.dispatchRules?.customGroupTarget
config.dispatchRules?.requireAtMe
```

**修改后**:
```typescript
config.groupDispatch?.enabled
config.groupDispatch?.targetNameSource
config.privateDispatch?.enabled
config.privateDispatch?.targetNameSource
config.atMe?.requireAtMe
config.atMe?.onNotAtMe
```

### 4. 修正指令状态记录节点配置

**修改内容**:
- 将 `saveToSessionMessages` 改为 `updateSessionMessages`

### 5. 优化发送指令节点配置

**修改内容**:
- 添加 `@人` 配置的变量提示
- 优化重试配置的条件显示
- 添加输入验证（min、max）

### 6. 添加结束节点提示

为 `end` 节点类型添加友好的提示信息：
```typescript
{node.data.type === 'end' && (
  <div className="text-sm text-slate-500 text-center py-4">
    结束节点无需配置
  </div>
)}
```

### 7. 添加未识别节点类型的提示

```typescript
{!node.data.type && (
  <div className="text-sm text-slate-500 text-center py-4">
    请选择节点类型以查看配置选项
  </div>
)}
```

## 受影响的节点类型

所有10种节点类型的配置选项现在都能正确显示：

1. ✅ **消息接收** (message_receive) - 数据保存、字段提取、WebSocket推送
2. ✅ **意图识别** (intent) - AI模型、温度参数、系统提示词、意图过滤
3. ✅ **决策节点** (decision) - 决策规则（JSON格式）
4. ✅ **AI客服回复** (ai_reply) - 默认模型、上下文配置
5. ✅ **消息分发** (message_dispatch) - 群发配置、私发配置、@机器人配置
6. ✅ **发送指令** (send_command) - 消息来源、@人配置、重试配置
7. ✅ **指令状态记录** (command_status) - 保存配置、WebSocket推送
8. ✅ **结束节点** (end) - 无需配置
9. ✅ **告警入库** (alert_save) - 告警类型、意图类型、告警级别、关键词
10. ✅ **告警规则判断** (alert_rule) - 告警规则（JSON格式）

## 测试方法

1. **打开流程引擎页面**: 访问 `http://localhost:5000/flow-engine`

2. **拖拽节点到画布**: 从左侧节点库拖拽任意节点到画布

3. **点击节点**: 点击节点后，右侧应该显示详细的配置选项

4. **配置节点**: 修改配置选项，观察是否实时更新

5. **保存流程**: 点击"保存流程"按钮，确认配置是否正确保存

## 预期效果

- ✅ 点击任意节点，右侧显示对应的配置选项
- ✅ 配置选项实时更新到flow状态
- ✅ 点击"保存"按钮，配置被正确保存到数据库
- ✅ 保存的配置结构与后端API一致

## 注意事项

1. **配置保存机制**: 修改配置后，配置会自动更新到本地flow状态。需要点击页面右上角的"保存流程"按钮才能将整个流程（包括所有节点配置）保存到数据库。

2. **配置提示**: 节点配置面板中的"保存"按钮只是提示用户配置已更新，实际保存需要点击页面右上角的"保存流程"按钮。

3. **旧数据兼容**: 如果之前保存的流程使用了旧的配置格式，可能需要重新配置节点。

## 相关文件

- `src/app/flow-engine/components/NodeConfigPanel.tsx` - 节点配置面板组件
- `src/app/flow-engine/components/FlowCanvas.tsx` - 流程画布组件
- `src/app/flow-engine/types.ts` - 节点类型定义
- `docs/流程引擎节点配置功能验证指南.md` - 功能验证指南
