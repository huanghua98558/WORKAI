# AI模型管理需求分析报告

## 📋 报告概述

**日期：** 2026-02-05
**目的：** 分析AI模型管理的需求、文档和现状，确定需要修改的功能

---

## 🎯 用户需求总结

### 核心需求
1. ✅ **AI模型应该可以编辑**
   - 模型名字不能编辑（系统标识）
   - 其他内容都可以编辑和调试

2. ✅ **可编辑的内容包括：**
   - 适配AI角色
   - 载入AI提示词
   - AI的细节调整
   - 变量配置
   - Tokens限制
   - 记忆功能（如果有）
   - 其他AI模型API可以调试的内容

3. ✅ **需要添加的功能：**
   - 添加AI模型
   - 删除按钮

---

## 📊 数据库Schema分析

### ai_models 表字段（完整）

| 字段名 | 类型 | 说明 | 可编辑性 |
|--------|------|------|----------|
| id | varchar(36) | 主键 | ❌ 不可编辑 |
| providerId | varchar(36) | 提供商ID | ✅ 可编辑 |
| name | varchar(255) | 模型名称 | ❌ 不可编辑（系统标识） |
| displayName | varchar(255) | 显示名称 | ✅ 可编辑 |
| modelId | varchar(255) | 模型ID（API调用） | ✅ 可编辑 |
| type | varchar(50) | 类型（chat/embedding等） | ✅ 可编辑 |
| capabilities | jsonb | 能力列表 | ✅ 可编辑 |
| maxTokens | integer | 最大token数 | ✅ 可编辑 |
| inputPrice | numeric | 输入价格 | ✅ 可编辑 |
| outputPrice | numeric | 输出价格 | ✅ 可编辑 |
| isEnabled | boolean | 是否启用 | ✅ 可编辑 |
| priority | integer | 优先级 | ✅ 可编辑 |
| config | jsonb | 额外配置 | ✅ 可编辑 |
| description | text | 描述 | ✅ 可编辑 |
| createdAt | timestamp | 创建时间 | ❌ 不可编辑 |
| updatedAt | timestamp | 更新时间 | ❌ 不可编辑 |

### config 字段详细内容（可编辑的AI参数）

根据AI服务工厂代码，config字段可以包含以下参数：

```javascript
{
  // 基础参数
  "temperature": 0.7,      // 温度参数（0-2）
  "topP": 0.9,             // Top P 采样（0-1）
  "topK": 40,              // Top K 采样
  "presencePenalty": 0,    // 存在惩罚（-2到2）
  "frequencyPenalty": 0,   // 频率惩罚（-2到2）

  // 记忆功能
  "memory": {
    "enabled": true,       // 是否启用记忆
    "retentionDays": 30,   // 记忆保留天数
    "maxContextMessages": 20, // 最大上下文消息数
    "summaryEnabled": true,  // 是否启用记忆摘要
    "userProfileEnabled": true // 是否启用用户画像
  },

  // 速率限制
  "rateLimit": {
    "enabled": true,       // 是否启用速率限制
    "maxRequestsPerMinute": 60 // 每分钟最大请求数
  },

  // 重试配置
  "retry": {
    "enabled": true,       // 是否启用重试
    "maxRetries": 3,       // 最大重试次数
    "retryDelay": 1000     // 重试延迟（毫秒）
  },

  // 其他配置
  "timeout": 30000,        // 超时时间（毫秒）
  "streamEnabled": false   // 是否启用流式输出
}
```

### aiRoles 表字段（AI角色关联）

| 字段名 | 类型 | 说明 | 可编辑性 |
|--------|------|------|----------|
| id | varchar(36) | 主键 | ❌ 不可编辑 |
| name | varchar(255) | 角色名称 | ✅ 可编辑 |
| type | varchar(50) | 类型（preset/custom） | ✅ 可编辑 |
| category | varchar(50) | 分类 | ✅ 可编辑 |
| description | text | 描述 | ✅ 可编辑 |
| systemPrompt | text | **系统提示词** | ✅ 可编辑 |
| temperature | numeric | 温度参数 | ✅ 可编辑 |
| maxTokens | integer | 最大token数 | ✅ 可编辑 |
| **modelId** | varchar(36) | **使用的模型ID** | ✅ 可编辑（关联模型） |
| promptTemplateId | varchar(36) | 关联的话术模板ID | ✅ 可编辑 |
| variables | jsonb | 支持的变量列表 | ✅ 可编辑 |
| isActive | boolean | 是否启用 | ✅ 可编辑 |
| isDefault | boolean | 是否为默认角色 | ✅ 可编辑 |

---

## 🔍 现有AI模块实现分析

### 当前实现的问题

#### 1. 模型编辑功能被完全禁用

**当前代码：**
```typescript
// ❌ 内置模型不允许编辑和删除
isBuiltin: true
// 提示信息：这些是系统内置的 AI 模型，内置模型不支持编辑和删除
```

**问题：**
- 完全禁止编辑内置模型
- 用户无法调整模型的配置参数
- 用户无法关联AI角色
- 用户无法配置系统提示词
- 用户无法调整temperature、topP等参数

#### 2. 缺少模型关联功能

**当前代码：**
```typescript
// 模型和角色是完全分离的两个Tab
// 模型无法关联角色
// 角色可以选择modelId，但模型界面看不到关联的角色
```

**问题：**
- 无法在模型管理界面查看关联的角色
- 无法直接为模型分配角色
- 需要到角色管理界面手动选择模型

#### 3. 缺少添加模型功能

**当前代码：**
```typescript
// ❌ 移除了「添加模型」按钮
{/*
  <Button onClick={() => setShowModelDialog(true)}>
    <Plus className="h-4 w-4 mr-2" />
    添加模型
  </Button>
*/}
```

**问题：**
- 用户无法添加自定义模型
- 用户无法使用其他提供商的模型
- 受限于6个内置模型

#### 4. 缺少删除模型功能

**当前代码：**
```typescript
// ❌ 移除了删除按钮
{/*
  <Button onClick={() => handleDeleteModel(model.id)}>
    <Trash2 className="h-4 w-4" />
  </Button>
*/}
```

**问题：**
- 用户无法删除不需要的模型
- 无法清理测试模型

#### 5. 编辑对话框缺失

**当前代码：**
```typescript
// ❌ 只保留了「详情查看」对话框
<Dialog open={showModelDetail} onOpenChange={setShowModelDetail}>
  // 只显示信息，不支持编辑
</Dialog>

// ❌ 移除了编辑对话框
{/*
<Dialog open={showModelDialog} onOpenChange={setShowModelDialog}>
  // 编辑表单
</Dialog>
*/}
```

**问题：**
- 没有编辑界面
- 无法修改模型的配置参数
- 无法调整temperature、topP等参数

---

## 💡 改进方案建议

### 方案1：模型 + 角色关联编辑

**设计思路：**
- 模型和角色保持独立管理
- 角色可以选择使用哪个模型
- 模型管理界面显示关联的角色列表

**优点：**
- 职责清晰，模型是基础配置，角色是应用配置
- 一个模型可以被多个角色使用
- 符合数据库schema设计

**缺点：**
- 模型配置和角色配置分离，需要分别编辑

### 方案2：模型配置 + 独立角色管理

**设计思路：**
- 模型管理界面专注于模型本身的配置
- 包括：提供商、模型ID、temperature、topP、maxTokens、记忆功能等
- 角色管理界面专注于角色的配置
- 包括：系统提示词、变量、使用的模型等

**优点：**
- 配置项清晰分离
- 模型配置和角色配置各司其职
- 符合数据库设计

**缺点：**
- 需要在两个界面分别编辑

### 方案3：综合模型管理界面（推荐）

**设计思路：**
- 模型管理界面包含多个Tab：
  1. **基本配置**：模型名称、提供商、模型ID、类型、描述等
  2. **参数配置**：temperature、topP、topK、maxTokens等
  3. **记忆配置**：启用记忆、记忆保留天数、最大上下文消息数等
  4. **角色关联**：查看和配置使用此模型的AI角色
  5. **提示词配置**：模型的默认系统提示词

**优点：**
- 一个界面完成所有配置
- 配置项分类清晰
- 用户体验好

**缺点：**
- 界面较复杂

---

## 📝 推荐实现方案（方案3的简化版）

### 模型编辑对话框结构

#### Tab 1: 基本配置（不可编辑项只读显示）
- **模型名称**（name）：只读，显示灰色
- **显示名称**（displayName）：可编辑
- **提供商**（providerId）：下拉选择
- **模型ID**（modelId）：可编辑
- **模型类型**（type）：下拉选择（意图识别/对话生成/文本处理/向量化）
- **优先级**（priority）：数字输入
- **描述**（description）：文本框

#### Tab 2: 参数配置
- **温度参数**（config.temperature）：滑块（0-2）
- **Top P**（config.topP）：滑块（0-1）
- **Top K**（config.topK）：数字输入
- **存在惩罚**（config.presencePenalty）：滑块（-2到2）
- **频率惩罚**（config.frequencyPenalty）：滑块（-2到2）
- **最大Token数**（maxTokens）：数字输入
- **超时时间**（config.timeout）：数字输入（毫秒）

#### Tab 3: 记忆配置
- **启用记忆**（config.memory.enabled）：开关
- **记忆保留天数**（config.memory.retentionDays）：数字输入
- **最大上下文消息数**（config.memory.maxContextMessages）：数字输入
- **启用记忆摘要**（config.memory.summaryEnabled）：开关
- **启用用户画像**（config.memory.userProfileEnabled）：开关

#### Tab 4: 角色关联（只读显示）
- 显示使用此模型的AI角色列表
- 每个角色显示名称、类型、是否启用
- 提供快速跳转到角色编辑的链接

#### Tab 5: 速率限制
- **启用速率限制**（config.rateLimit.enabled）：开关
- **每分钟最大请求数**（config.rateLimit.maxRequestsPerMinute）：数字输入

---

## 🔄 修改清单

### 必须修改的项

1. ✅ **恢复「添加模型」按钮**
   - 允许用户添加自定义模型
   - 需要完整的模型配置表单

2. ✅ **恢复「编辑模型」功能**
   - 创建模型编辑对话框
   - 支持多个Tab的配置界面
   - 模型名称（name）设为只读
   - 其他字段可编辑

3. ✅ **恢复「删除模型」按钮**
   - 允许删除自定义模型
   - 内置模型删除需要二次确认

4. ✅ **修改提示信息**
   - 从"内置模型不支持编辑和删除"
   - 改为"模型名称不可编辑，其他配置均可调整"

5. ✅ **移除「内置」徽章的误导性**
   - 保留标识，但明确说明可以编辑配置
   - 区分"内置模型配置"和"系统预设模型"

6. ✅ **添加角色关联显示**
   - 在模型详情中显示使用此模型的AI角色
   - 提供快速跳转链接

### 可选增强项

1. 🔄 **模型测试功能**
   - 在编辑对话框中添加「测试」按钮
   - 实时测试模型配置是否有效

2. 🔄 **配置导入导出**
   - 支持导出模型配置为JSON
   - 支持从JSON导入模型配置

3. 🔄 **配置模板**
   - 预设常用配置模板
   - 一键应用模板

---

## 📊 对比表：当前 vs 建议

| 功能 | 当前实现 | 建议实现 | 优先级 |
|------|----------|----------|--------|
| 查看模型列表 | ✅ | ✅ | - |
| 查看模型详情 | ✅ | ✅ | - |
| 启用/禁用模型 | ✅ | ✅ | - |
| 健康检查 | ✅ | ✅ | - |
| 添加模型 | ❌ | ✅ | 🔴 高 |
| 编辑模型 | ❌ | ✅ | 🔴 高 |
| 删除模型 | ❌ | ✅ | 🔴 高 |
| 编辑模型名称 | ❌ | ❌（只读） | - |
| 编辑显示名称 | ❌ | ✅ | 🔴 高 |
| 编辑模型ID | ❌ | ✅ | 🟡 中 |
| 编辑temperature | ❌ | ✅ | 🔴 高 |
| 编辑topP/topK | ❌ | ✅ | 🟡 中 |
| 编辑maxTokens | ❌ | ✅ | 🔴 高 |
| 配置记忆功能 | ❌ | ✅ | 🟡 中 |
| 配置速率限制 | ❌ | ✅ | 🟢 低 |
| 查看关联角色 | ❌ | ✅ | 🟡 中 |
| 模型测试 | ❌ | ✅ | 🟢 低 |

---

## 🎯 修改后的用户流程

### 场景1：编辑内置模型配置
1. 用户点击模型的「编辑」按钮
2. 打开模型编辑对话框（多个Tab）
3. 用户在「基本配置」Tab中修改显示名称、优先级、描述
4. 用户在「参数配置」Tab中调整temperature、maxTokens等
5. 用户在「记忆配置」Tab中开启记忆功能
6. 用户点击「保存」
7. 系统更新数据库

### 场景2：添加自定义模型
1. 用户点击「添加模型」按钮
2. 打开模型添加对话框（多个Tab）
3. 用户填写模型名称、选择提供商、输入模型ID
4. 用户配置temperature、maxTokens等参数
5. 用户配置记忆功能（可选）
6. 用户点击「保存」
7. 系统创建新模型记录

### 场景3：查看模型关联角色
1. 用户点击模型的「详情」按钮
2. 在对话框中切换到「角色关联」Tab
3. 显示使用此模型的所有AI角色
4. 用户点击角色名称跳转到角色编辑界面

---

## ⚠️ 注意事项

1. **模型名称（name）不可编辑**
   - name字段是系统的唯一标识
   - 编辑时设为只读，显示灰色

2. **内置模型的删除**
   - 内置模型删除需要二次确认
   - 提示：删除内置模型可能影响系统功能

3. **关联角色的处理**
   - 删除模型时需要检查是否有角色在使用
   - 如果有，提示用户先修改或删除相关角色

4. **配置验证**
   - temperature必须在0-2之间
   - topP必须在0-1之间
   - maxTokens必须大于0
   - 模型ID不能为空

---

## 📅 建议实施步骤

1. **第一步：恢复基础功能**
   - 恢复「添加模型」按钮
   - 恢复「编辑模型」按钮
   - 恢复「删除模型」按钮
   - 修改提示信息

2. **第二步：实现编辑对话框**
   - 创建多Tab编辑对话框
   - 实现基本配置Tab
   - 实现参数配置Tab
   - 实现记忆配置Tab

3. **第三步：实现高级功能**
   - 实现角色关联Tab
   - 实现速率限制配置
   - 添加配置验证

4. **第四步：测试和优化**
   - 测试所有编辑功能
   - 测试模型创建
   - 测试模型删除
   - 优化用户体验

---

## ✅ 总结

### 核心问题
- 当前实现完全禁止编辑内置模型，与用户需求不符
- 缺少添加和删除模型功能
- 缺少详细的模型配置界面

### 解决方案
- 恢复编辑、添加、删除功能
- 创建多Tab编辑对话框，支持全面的配置
- 模型名称保持只读，其他配置均可编辑
- 显示模型关联的角色

### 预期效果
- 用户可以灵活配置AI模型
- 支持自定义模型
- 提供详细的参数调整界面
- 模型管理功能完整且合理

---

**请确认此分析报告是否符合您的需求，确认后我将开始实施修改。**
