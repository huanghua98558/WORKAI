# WorkTool AI 2.0 ä¸­æ¢ç³»ç»Ÿ - æ„é€ è¯´æ˜ä¹¦

## ğŸ“‹ æ–‡æ¡£ä¿¡æ¯

- **æ–‡æ¡£ç‰ˆæœ¬**ï¼šv2.0
- **åˆ›å»ºæ—¥æœŸ**ï¼š2025-01-04
- **æœ€åæ›´æ–°**ï¼š2025-01-04
- **æ–‡æ¡£çŠ¶æ€**ï¼šæ­£å¼ç‰ˆ
- **åŸºäºç‰ˆæœ¬**ï¼šv1.0 â†’ v2.0ï¼ˆé‡å¤§å‡çº§ï¼‰

---

## ğŸ“– ç›®å½•

1. [ç³»ç»Ÿæ¦‚è¿°](#1-ç³»ç»Ÿæ¦‚è¿°)
2. [2.0ç‰ˆæœ¬æ ¸å¿ƒå‡çº§](#2-20ç‰ˆæœ¬æ ¸å¿ƒå‡çº§)
3. [ç³»ç»Ÿæ¶æ„](#3-ç³»ç»Ÿæ¶æ„)
4. [èŠ‚ç‚¹æµç¨‹å¼•æ“](#4-èŠ‚ç‚¹æµç¨‹å¼•æ“)
5. [æ•°æ®åº“è®¾è®¡](#5-æ•°æ®åº“è®¾è®¡)
6. [åŒç›‘æ§é¢æ¿ç³»ç»Ÿ](#6-åŒç›‘æ§é¢æ¿ç³»ç»Ÿ)
7. [å®‰å…¨ä½“ç³»](#7-å®‰å…¨ä½“ç³»)
8. [æ€§èƒ½ä¼˜åŒ–](#8-æ€§èƒ½ä¼˜åŒ–)
9. [APIæ¥å£è®¾è®¡](#9-apiæ¥å£è®¾è®¡)
10. [éƒ¨ç½²æ¶æ„](#10-éƒ¨ç½²æ¶æ„)
11. [å¼€å‘è§„èŒƒ](#11-å¼€å‘è§„èŒƒ)
12. [è¿ç»´ç›‘æ§](#12-è¿ç»´ç›‘æ§)

---

## 1. ç³»ç»Ÿæ¦‚è¿°

### 1.1 ç³»ç»Ÿå®šä½

WorkTool AI 2.0 ä¸­æ¢ç³»ç»Ÿæ˜¯åŸºäºä¼ä¸šå¾®ä¿¡çš„æ™ºèƒ½æœåŠ¡å‹ AI å¹³å°ï¼Œé€šè¿‡**èŠ‚ç‚¹æµç¨‹å¼•æ“**ã€**å…¨é“¾è·¯æ•°æ®è¿½è¸ª**ã€**åŒç›‘æ§é¢æ¿**ç­‰æ ¸å¿ƒæŠ€æœ¯ï¼Œå®ç°æ™ºèƒ½åŒ–ã€å¯è§†åŒ–ã€å¯è¿½æº¯çš„æ¶ˆæ¯å¤„ç†å’Œå‘Šè­¦ç®¡ç†ã€‚

### 1.2 æ ¸å¿ƒèƒ½åŠ›ï¼ˆ2.0ï¼‰

#### 1.2.1 æ™ºèƒ½æ¶ˆæ¯å¤„ç†
- âœ… **8èŠ‚ç‚¹æµç¨‹å¼•æ“**ï¼šå¯è§†åŒ–ç¼–æ’æ¶ˆæ¯å¤„ç†æµç¨‹
- âœ… **AIæ„å›¾è¯†åˆ«**ï¼šåŸºäºå¤§æ¨¡å‹çš„ç²¾å‡†æ„å›¾åˆ†æ
- âœ… **æ™ºèƒ½å›å¤ç”Ÿæˆ**ï¼šä¸Šä¸‹æ–‡æ„ŸçŸ¥çš„AIå®¢æœå›å¤
- âœ… **å‘Šè­¦è§„åˆ™å¼•æ“**ï¼šçµæ´»çš„å‘Šè­¦è§¦å‘å’Œå‡çº§æœºåˆ¶

#### 1.2.2 å…¨é“¾è·¯æ•°æ®è¿½è¸ª
- âœ… **ç»Ÿä¸€messageIdè¿½è¸ª**ï¼šè´¯ç©¿æ•´ä¸ªæµç¨‹çš„å”¯ä¸€æ ‡è¯†
- âœ… **å®Œæ•´AIäº¤äº’è®°å½•**ï¼šæ‰€æœ‰AIè¾“å…¥è¾“å‡ºå…¥åº“
- âœ… **æŒ‡ä»¤çŠ¶æ€è¿½è¸ª**ï¼šæœºå™¨äººæŒ‡ä»¤å…¨ç”Ÿå‘½å‘¨æœŸç®¡ç†
- âœ… **æ‰§è¡Œç»“æœå›è°ƒ**ï¼šå¼‚æ­¥å›è°ƒæœºåˆ¶ï¼Œä¸é˜»å¡ä¸»æµç¨‹

#### 1.2.3 åŒç›‘æ§é¢æ¿
- âœ… **ä¸šåŠ¡æ¶ˆæ¯ç›‘æ§**ï¼šé¢å‘ä¸šåŠ¡äººå‘˜ï¼Œå±•ç¤ºç”¨æˆ·æ¶ˆæ¯å’Œæœºå™¨äººå›å¤
- âœ… **AIäº¤äº’ç›‘æ§**ï¼šé¢å‘æŠ€æœ¯äººå‘˜ï¼Œå±•ç¤ºå®Œæ•´çš„6é˜¶æ®µæ‰§è¡Œé“¾è·¯
- âœ… **å®æ—¶æ¨é€**ï¼šWebSocketå®æ—¶æ›´æ–°ï¼Œæ— éœ€åˆ·æ–°
- âœ… **æ€§èƒ½åˆ†æ**ï¼šå„é˜¶æ®µè€—æ—¶ç»Ÿè®¡ï¼Œç“¶é¢ˆè¯†åˆ«

#### 1.2.4 å¢å¼ºçš„é€šçŸ¥ç³»ç»Ÿ
- âœ… **å¤šæ¸ é“é€šçŸ¥**ï¼šå¼¹çª—ã€é‚®ä»¶ã€å£°éŸ³ã€ä¼ä¸šå¾®ä¿¡ã€æœºå™¨äºº
- âœ… **çµæ´»é…ç½®**ï¼šæ”¯æŒç§å‘å’Œç¾¤å‘ï¼Œè‡ªå®šä¹‰æ¶ˆæ¯æ¨¡æ¿
- âœ… **å¼‚æ­¥å¤„ç†**ï¼šé€šçŸ¥åˆ†å‘ä¸é˜»å¡ä¸»æµç¨‹

### 1.3 æŠ€æœ¯æ ˆï¼ˆ2.0ï¼‰

#### å‰ç«¯æŠ€æœ¯æ ˆ
| ç»„ä»¶ | ç‰ˆæœ¬ | è¯´æ˜ |
|------|------|------|
| æ¡†æ¶ | Next.js 16.1.1 | App Router |
| UIåº“ | React 19.2.3 | UIæ¡†æ¶ |
| UIç»„ä»¶ | shadcn/ui | åŸºäºRadix UI |
| æ ·å¼ | Tailwind CSS 4 | æ ·å¼æ¡†æ¶ |
| çŠ¶æ€ç®¡ç† | Zustand | å…¨å±€çŠ¶æ€ç®¡ç† |
| è¡¨å• | react-hook-form + zod | è¡¨å•éªŒè¯ |
| å›¾è¡¨ | recharts | æ•°æ®å¯è§†åŒ– |
| ç¼–è¾‘å™¨ | Monaco Editor | ä»£ç ç¼–è¾‘ |
| HTTPå®¢æˆ·ç«¯ | axios | HTTPè¯·æ±‚ |

#### åç«¯æŠ€æœ¯æ ˆ
| ç»„ä»¶ | ç‰ˆæœ¬ | è¯´æ˜ |
|------|------|------|
| æ¡†æ¶ | Fastify 5.7.2 | Webæ¡†æ¶ |
| ORM | Drizzle ORM 0.45.1 | æ•°æ®åº“ORM |
| æ•°æ®åº“ | PostgreSQL 8.16.3 | ä¸»æ•°æ®åº“ |
| ç¼“å­˜ | Redis (ioredis 5.9.2) | ç¼“å­˜+æ¶ˆæ¯é˜Ÿåˆ— |
| AIé›†æˆ | OpenAI SDK 6.17.0 | AIæœåŠ¡é›†æˆ |
| è®¤è¯ | JWT + bcrypt | è®¤è¯æˆæƒ |
| æ•°æ®éªŒè¯ | zod | æ•°æ®éªŒè¯ |
| å¯¹è±¡å­˜å‚¨ | AWS S3 SDK | æ–‡ä»¶å­˜å‚¨ |

#### å¼€å‘å·¥å…·
| å·¥å…· | ç‰ˆæœ¬ | è¯´æ˜ |
|------|------|------|
| åŒ…ç®¡ç†å™¨ | pnpm 9.0.0 | åŒ…ç®¡ç† |
| TypeScript | 5.x | ç±»å‹ç³»ç»Ÿ |
| è¿è¡Œç¯å¢ƒ | Node.js 24 | è¿è¡Œç¯å¢ƒ |

---

## 2. 2.0ç‰ˆæœ¬æ ¸å¿ƒå‡çº§

### 2.1 æ¶æ„å‡çº§

#### 2.1.1 å‰åç«¯å½»åº•åˆ†ç¦»ï¼ˆP1ï¼‰

**v1.0é—®é¢˜**ï¼š
- å‰ç«¯å’Œåç«¯åœ¨åŒä¸€ä¸ªä»£ç ä»“åº“
- é€šè¿‡Next.js API Routesä»£ç†è¯·æ±‚
- å¼€å‘å’Œéƒ¨ç½²å¤æ‚åº¦é«˜

**v2.0æ”¹è¿›**ï¼š
```
æ–¹æ¡ˆï¼šå‰åç«¯å®Œå…¨åˆ†ç¦»
â”œâ”€â”€ å‰ç«¯ä»“åº“ï¼ˆworktool-ai-frontendï¼‰
â”‚   â”œâ”€â”€ ç‹¬ç«‹éƒ¨ç½²åˆ°CDNæˆ–é™æ€æœåŠ¡å™¨
â”‚   â”œâ”€â”€ é€šè¿‡ç¯å¢ƒå˜é‡é…ç½®APIåœ°å€
â”‚   â””â”€â”€ æ”¯æŒç‹¬ç«‹å¼€å‘å’Œéƒ¨ç½²
â”‚
â””â”€â”€ åç«¯ä»“åº“ï¼ˆworktool-ai-backendï¼‰
    â”œâ”€â”€ ç‹¬ç«‹éƒ¨ç½²ä¸ºå¾®æœåŠ¡
    â”œâ”€â”€ RESTful APIè®¾è®¡
    â””â”€â”€ Swagger APIæ–‡æ¡£
```

**æ”¶ç›Š**ï¼š
- âœ… é™ä½å¼€å‘å’Œéƒ¨ç½²å¤æ‚åº¦
- âœ… å‰åç«¯å¯ç‹¬ç«‹æ‰©å±•
- âœ… æ›´å¥½çš„å›¢é˜Ÿåä½œ

---

#### 2.1.2 ç»Ÿä¸€çŠ¶æ€ç®¡ç†ï¼ˆP1ï¼‰

**v1.0é—®é¢˜**ï¼š
- ä½¿ç”¨Reactå†…ç½®çŠ¶æ€ç®¡ç†
- çŠ¶æ€åˆ†æ•£ï¼Œéš¾ä»¥è¿½è¸ª
- ç»„ä»¶é—´é€šä¿¡å¤æ‚

**v2.0æ”¹è¿›**ï¼š
```
å¼•å…¥Zustandå…¨å±€çŠ¶æ€ç®¡ç†
â”œâ”€â”€ ç”¨æˆ·çŠ¶æ€ï¼ˆuserStoreï¼‰
â”œâ”€â”€ æœºå™¨äººçŠ¶æ€ï¼ˆrobotStoreï¼‰
â”œâ”€â”€ å‘Šè­¦è§„åˆ™çŠ¶æ€ï¼ˆalertRuleStoreï¼‰
â”œâ”€â”€ ç³»ç»Ÿé…ç½®çŠ¶æ€ï¼ˆconfigStoreï¼‰
â”œâ”€â”€ WebSocketè¿æ¥çŠ¶æ€ï¼ˆwsStoreï¼‰
â””â”€â”€ é€šçŸ¥çŠ¶æ€ï¼ˆnotificationStoreï¼‰
```

**æ”¶ç›Š**ï¼š
- âœ… ç»Ÿä¸€çŠ¶æ€ç®¡ç†
- âœ… æ›´å¥½çš„æ•°æ®ç¼“å­˜
- âœ… ç®€åŒ–ç»„ä»¶é€šä¿¡

---

#### 2.1.3 æ¶ˆæ¯é˜Ÿåˆ—å¼•å…¥ï¼ˆP2ï¼‰

**v1.0é—®é¢˜**ï¼š
- æ‰€æœ‰æ“ä½œåŒæ­¥æ‰§è¡Œ
- é«˜å¹¶å‘æ—¶æ€§èƒ½ç“¶é¢ˆ
- é€šçŸ¥å¤±è´¥é‡è¯•å›°éš¾

**v2.0æ”¹è¿›**ï¼š
```
å¼•å…¥Redis Streamä½œä¸ºæ¶ˆæ¯é˜Ÿåˆ—
â”œâ”€â”€ å‘Šè­¦é€šçŸ¥é˜Ÿåˆ—ï¼ˆalertsï¼‰
â”‚   â”œâ”€â”€ å¼‚æ­¥å‘é€é€šçŸ¥
â”‚   â”œâ”€â”€ æ”¯æŒé‡è¯•æœºåˆ¶
â”‚   â””â”€â”€ æ­»ä¿¡é˜Ÿåˆ—å¤„ç†
â”‚
â””â”€â”€ AIè¯·æ±‚é˜Ÿåˆ—ï¼ˆai_requestsï¼‰
    â”œâ”€â”€ æ‰¹é‡å¤„ç†AIè¯·æ±‚
    â”œâ”€â”€ é™æµæ§åˆ¶
    â””â”€â”€ ç»“æœç¼“å­˜
```

**æ”¶ç›Š**ï¼š
- âœ… æé«˜å¹¶å‘å¤„ç†èƒ½åŠ›
- âœ… è§£è€¦æ ¸å¿ƒä¸šåŠ¡
- âœ… æ”¯æŒæ¶ˆæ¯é‡è¯•

---

### 2.2 æ•°æ®åº“å‡çº§

#### 2.2.1 æŸ¥è¯¢ä¼˜åŒ–ï¼ˆP0ï¼‰

**v1.0é—®é¢˜**ï¼š
- éƒ¨åˆ†æŸ¥è¯¢ç¼ºå°‘ç´¢å¼•
- N+1æŸ¥è¯¢é—®é¢˜
- å¤§é‡æ•°æ®æœªåˆ†é¡µ

**v2.0æ”¹è¿›**ï¼š
```sql
-- æ–°å¢ç´¢å¼•
CREATE INDEX idx_alert_history_created_at_level ON alert_history(created_at, alert_level);
CREATE INDEX idx_session_messages_session_created ON session_messages(session_id, created_at);
CREATE INDEX idx_ai_io_logs_message_id ON ai_io_logs(message_id);
CREATE INDEX idx_robot_commands_status_created ON robotCommands(status, created_at);

-- ä¼˜åŒ–æŸ¥è¯¢ï¼ˆä½¿ç”¨JOINï¼‰
WITH user_messages AS (
  -- ç”¨æˆ·æ¶ˆæ¯
  SELECT sm.messageId, sm.content, sm.userName, ...
  FROM session_messages sm
  WHERE sm.isFromUser = true
),
bot_replies AS (
  -- æœºå™¨äººå›å¤
  SELECT sm.messageId, sm.content, ...
  FROM session_messages sm
  WHERE sm.isFromBot = true
)
SELECT * FROM user_messages um
LEFT JOIN bot_replies br ON um.messageId = br.messageId
LIMIT 100;
```

**æ”¶ç›Š**ï¼š
- âœ… æŸ¥è¯¢æ€§èƒ½æå‡50%+
- âœ… å‡å°‘æ•°æ®åº“å‹åŠ›
- âœ… æ›´å¥½çš„ç”¨æˆ·ä½“éªŒ

---

#### 2.2.2 Rediså¼ºåˆ¶ä½¿ç”¨ï¼ˆP1ï¼‰

**v1.0é—®é¢˜**ï¼š
- Redisè¿æ¥å¤±è´¥æ—¶é™çº§åˆ°å†…å­˜æ¨¡å¼
- é‡å¯åæ•°æ®ä¸¢å¤±
- å¯ç”¨æ€§é™ä½

**v2.0æ”¹è¿›**ï¼š
```
Rediså¿…é¡»å¼ºåˆ¶å¯ç”¨
â”œâ”€â”€ ç³»ç»Ÿå¯åŠ¨æ—¶æ£€æŸ¥Redisè¿æ¥
â”‚   â””â”€â”€ è¿æ¥å¤±è´¥åˆ™æ‹’ç»å¯åŠ¨
â”œâ”€â”€ å¥åº·æ£€æŸ¥å’Œè‡ªåŠ¨é‡è¿
â”‚   â””â”€â”€ å®šæœŸæ£€æŸ¥è¿æ¥çŠ¶æ€
â”œâ”€â”€ ç»Ÿä¸€ç¼“å­˜ç­–ç•¥
â”‚   â”œâ”€â”€ ç¼“å­˜é”®è§„èŒƒ
â”‚   â”œâ”€â”€ ç»Ÿä¸€TTLç­–ç•¥
â”‚   â””â”€â”€ ç¼“å­˜ç©¿é€ä¿æŠ¤
â””â”€â”€ ç¼“å­˜é¢„çƒ­
    â”œâ”€â”€ å¯åŠ¨æ—¶åŠ è½½å¸¸ç”¨æ•°æ®
    â””â”€â”€ å®šæ—¶åˆ·æ–°çƒ­ç‚¹æ•°æ®
```

**æ”¶ç›Š**ï¼š
- âœ… æé«˜ç³»ç»Ÿå¯ç”¨æ€§
- âœ… ä¿è¯æ•°æ®ä¸€è‡´æ€§
- âœ… æå‡ç¼“å­˜å‘½ä¸­ç‡

---

### 2.3 å®‰å…¨å‡çº§

#### 2.3.1 å®Œæ•´è®¤è¯æˆæƒï¼ˆP0ï¼‰

**v1.0é—®é¢˜**ï¼š
- å¯†ç æ˜æ–‡å­˜å‚¨
- æ— JWTè®¤è¯
- æ— ç»†ç²’åº¦æƒé™æ§åˆ¶

**v2.0æ”¹è¿›**ï¼š
```
JWT + RBACå®Œæ•´è®¤è¯æˆæƒä½“ç³»
â”œâ”€â”€ JWTè®¤è¯
â”‚   â”œâ”€â”€ Access Tokenï¼ˆçŸ­æœŸï¼‰
â”‚   â”œâ”€â”€ Refresh Tokenï¼ˆé•¿æœŸï¼‰
â”‚   â””â”€â”€ Tokenè¿‡æœŸæœºåˆ¶
â”‚
â”œâ”€â”€ RBACæƒé™æ¨¡å‹
â”‚   â”œâ”€â”€ usersè¡¨ï¼ˆç”¨æˆ·ï¼‰
â”‚   â”œâ”€â”€ rolesè¡¨ï¼ˆè§’è‰²ï¼‰
â”‚   â”œâ”€â”€ permissionsè¡¨ï¼ˆæƒé™ï¼‰
â”‚   â””â”€â”€ user_rolesè¡¨ï¼ˆç”¨æˆ·è§’è‰²å…³è”ï¼‰
â”‚
â””â”€â”€ æƒé™ä¸­é—´ä»¶
    â”œâ”€â”€ å‰ç«¯è·¯ç”±å®ˆå«
    â”œâ”€â”€ åç«¯APIé‰´æƒ
    â””â”€â”€ ç»†ç²’åº¦æƒé™æ§åˆ¶
```

**æ”¶ç›Š**ï¼š
- âœ… æå‡ç³»ç»Ÿå®‰å…¨æ€§
- âœ… æ”¯æŒç»†ç²’åº¦æƒé™æ§åˆ¶
- âœ… å®Œå–„çš„å®¡è®¡æ—¥å¿—

---

#### 2.3.2 å®¡è®¡æ—¥å¿—ï¼ˆP1ï¼‰

**v1.0é—®é¢˜**ï¼š
- æ— å®¡è®¡æ—¥å¿—
- ç”¨æˆ·è¡Œä¸ºæ— æ³•è¿½æº¯

**v2.0æ”¹è¿›**ï¼š
```
å®Œæ•´çš„å®¡è®¡æ—¥å¿—ç³»ç»Ÿ
â”œâ”€â”€ audit_logsè¡¨
â”‚   â”œâ”€â”€ ç”¨æˆ·ID
â”‚   â”œâ”€â”€ æ“ä½œç±»å‹
â”‚   â”œâ”€â”€ æ“ä½œå†…å®¹
â”‚   â”œâ”€â”€ IPåœ°å€
â”‚   â””â”€â”€ æ—¶é—´æˆ³
â”‚
â””â”€â”€ è‡ªåŠ¨è®°å½•
    â”œâ”€â”€ ç™»å½•/ç™»å‡º
    â”œâ”€â”€ æ•°æ®ä¿®æ”¹
    â”œâ”€â”€ æƒé™å˜æ›´
    â””â”€â”€ ç³»ç»Ÿé…ç½®ä¿®æ”¹
```

**æ”¶ç›Š**ï¼š
- âœ… å®Œæ•´çš„æ“ä½œè¿½è¸ª
- âœ… æ”¯æŒåˆè§„å®¡è®¡
- âœ… ä¾¿äºé—®é¢˜æ’æŸ¥

---

### 2.4 æ€§èƒ½å‡çº§

#### 2.4.1 AIè¯·æ±‚ä¼˜åŒ–ï¼ˆP1ï¼‰

**v1.0é—®é¢˜**ï¼š
- æ¯ä¸ªAIè¯·æ±‚ç‹¬ç«‹
- æ— ç»“æœç¼“å­˜
- APIè°ƒç”¨æˆæœ¬é«˜

**v2.0æ”¹è¿›**ï¼š
```
AIè¯·æ±‚ä¼˜åŒ–
â”œâ”€â”€ ç»“æœç¼“å­˜
â”‚   â”œâ”€â”€ ç›¸åŒå†…å®¹ç»“æœç¼“å­˜
â”‚   â”œâ”€â”€ ç¼“å­˜æ—¶é—´10-30åˆ†é’Ÿ
â”‚   â””â”€â”€ å†…å®¹å“ˆå¸Œä½œä¸ºç¼“å­˜é”®
â”‚
â”œâ”€â”€ æ‰¹é‡å¤„ç†
â”‚   â”œâ”€â”€ å¤šä¸ªæ¶ˆæ¯æ‰¹é‡è¯†åˆ«
â”‚   â””â”€â”€ å‡å°‘APIè°ƒç”¨æ¬¡æ•°
â”‚
â””â”€â”€ é™çº§ç­–ç•¥
    â”œâ”€â”€ AIæœåŠ¡ä¸å¯ç”¨æ—¶ä½¿ç”¨è§„åˆ™åŒ¹é…
    â””â”€â”€ ä¼˜å…ˆä¿è¯åŸºæœ¬åŠŸèƒ½
```

**æ”¶ç›Š**ï¼š
- âœ… é™ä½APIè°ƒç”¨æˆæœ¬
- âœ… æå‡å“åº”é€Ÿåº¦
- âœ… æé«˜ç³»ç»Ÿå¯ç”¨æ€§

---

#### 2.4.2 WebSocketä¼˜åŒ–ï¼ˆP2ï¼‰

**v1.0é—®é¢˜**ï¼š
- è¿æ¥ä¸ç¨³å®š
- æ— å¿ƒè·³æœºåˆ¶
- é‡è¿é€»è¾‘ä¸å®Œå–„

**v2.0æ”¹è¿›**ï¼š
```
WebSocketä¼˜åŒ–
â”œâ”€â”€ å¿ƒè·³æœºåˆ¶
â”‚   â”œâ”€â”€ å®¢æˆ·ç«¯å®šæœŸå‘é€å¿ƒè·³
â”‚   â””â”€â”€ æœåŠ¡ç«¯å“åº”å¿ƒè·³
â”‚
â”œâ”€â”€ è‡ªåŠ¨é‡è¿
â”‚   â”œâ”€â”€ æŒ‡æ•°é€€é¿é‡è¿
â”‚   â””â”€â”€ æœ€å¤§é‡è¯•æ¬¡æ•°
â”‚
â””â”€â”€ è¿æ¥ç®¡ç†
    â”œâ”€â”€ è¿æ¥æ± ç®¡ç†
    â”œâ”€â”€ æ–­çº¿é‡è¿
    â””â”€â”€ ä¼˜é›…é™çº§
```

**æ”¶ç›Š**ï¼š
- âœ… æé«˜è¿æ¥ç¨³å®šæ€§
- âœ… æ›´å¥½çš„ç”¨æˆ·ä½“éªŒ
- âœ… å‡å°‘èµ„æºæµªè´¹

---

### 2.5 ä»£ç è´¨é‡å‡çº§

#### 2.5.1 å®Œæ•´çš„ç±»å‹å®šä¹‰ï¼ˆP1ï¼‰

**v1.0é—®é¢˜**ï¼š
- ç±»å‹å®šä¹‰ä¸å®Œæ•´
- TypeScriptç±»å‹ä¸å®‰å…¨

**v2.0æ”¹è¿›**ï¼š
```
å®Œæ•´çš„TypeScriptç±»å‹å®šä¹‰
â”œâ”€â”€ å…±äº«ç±»å‹å®šä¹‰ï¼ˆ@types/sharedï¼‰
â”œâ”€â”€ åç«¯ç±»å‹å®šä¹‰ï¼ˆ@types/backendï¼‰
â”œâ”€â”€ å‰ç«¯ç±»å‹å®šä¹‰ï¼ˆ@types/frontendï¼‰
â””â”€â”€ APIç±»å‹å®šä¹‰ï¼ˆ@types/apiï¼‰
```

**æ”¶ç›Š**ï¼š
- âœ… æé«˜ç±»å‹å®‰å…¨æ€§
- âœ… æ›´å¥½çš„å¼€å‘ä½“éªŒ
- âœ… å‡å°‘è¿è¡Œæ—¶é”™è¯¯

---

#### 2.5.2 å•å…ƒæµ‹è¯•ï¼ˆP1ï¼‰

**v1.0é—®é¢˜**ï¼š
- æ— å•å…ƒæµ‹è¯•
- é‡æ„é£é™©å¤§

**v2.0æ”¹è¿›**ï¼š
```
å®Œæ•´çš„æµ‹è¯•ä½“ç³»
â”œâ”€â”€ å•å…ƒæµ‹è¯•
â”‚   â”œâ”€â”€ åç«¯æœåŠ¡æµ‹è¯•
â”‚   â”œâ”€â”€ å‰ç«¯ç»„ä»¶æµ‹è¯•
â”‚   â””â”€â”€ å·¥å…·å‡½æ•°æµ‹è¯•
â”‚
â”œâ”€â”€ é›†æˆæµ‹è¯•
â”‚   â”œâ”€â”€ APIé›†æˆæµ‹è¯•
â”‚   â”œâ”€â”€ æ•°æ®åº“é›†æˆæµ‹è¯•
â”‚   â””â”€â”€ WebSocketé›†æˆæµ‹è¯•
â”‚
â””â”€â”€ E2Eæµ‹è¯•
    â”œâ”€â”€ å…³é”®æµç¨‹æµ‹è¯•
    â””â”€â”€ å›å½’æµ‹è¯•
```

**æ”¶ç›Š**ï¼š
- âœ… æé«˜ä»£ç è´¨é‡
- âœ… é™ä½é‡æ„é£é™©
- âœ… ä¿è¯åŠŸèƒ½æ­£ç¡®æ€§

---

## 3. ç³»ç»Ÿæ¶æ„

### 3.1 æ•´ä½“æ¶æ„å›¾ï¼ˆ2.0ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        WorkTool å¹³å°                              â”‚
â”‚                  æœºå™¨äººæœåŠ¡ï¼ˆrobot_001, robot_002, ...ï¼‰           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   å›è°ƒä¸æŒ‡ä»¤é€šè®¯            â”‚
                    â”‚   (HTTP POST)              â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      åç«¯æœåŠ¡ (5001ç«¯å£)                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  è®¤è¯æˆæƒå±‚                                                â”‚  â”‚
â”‚  â”‚  â”œâ”€ JWTè®¤è¯ä¸­é—´ä»¶                                        â”‚  â”‚
â”‚  â”‚  â”œâ”€ RBACæƒé™ä¸­é—´ä»¶                                       â”‚  â”‚
â”‚  â”‚  â””â”€ å®¡è®¡æ—¥å¿—ä¸­é—´ä»¶                                       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                          â†“                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Webhookæ¥æ”¶å±‚                                             â”‚  â”‚
â”‚  â”‚  â”œâ”€ /api/worktool/callback/message    (æ¶ˆæ¯å›è°ƒ)          â”‚  â”‚
â”‚  â”‚  â”œâ”€ /api/worktool/callback/result    (æ‰§è¡Œç»“æœå›è°ƒ)       â”‚  â”‚
â”‚  â”‚  â”œâ”€ /api/worktool/callback/status    (ä¸Šä¸‹çº¿å›è°ƒ)         â”‚  â”‚
â”‚  â”‚  â””â”€ /api/worktool/callback/qrcode    (äºŒç»´ç å›è°ƒ)         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                          â†“                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  APIè·¯ç”±å±‚ (RESTful)                                      â”‚  â”‚
â”‚  â”‚  â”œâ”€ /api/robots/*          (æœºå™¨äººç®¡ç†)                   â”‚  â”‚
â”‚  â”‚  â”œâ”€ /api/alerts/*          (å‘Šè­¦ç®¡ç†)                     â”‚  â”‚
â”‚  â”‚  â”œâ”€ /api/ai/*              (AIé…ç½®)                       â”‚  â”‚
â”‚  â”‚  â”œâ”€ /api/sessions/*        (ä¼šè¯ç®¡ç†)                     â”‚  â”‚
â”‚  â”‚  â”œâ”€ /api/monitor/*         (ç›‘æ§æ•°æ®)                     â”‚  â”‚
â”‚  â”‚  â”œâ”€ /api/auth/*           (è®¤è¯æˆæƒ)                     â”‚  â”‚
â”‚  â”‚  â””â”€ /api/admin/*          (ç®¡ç†åå°)                     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                          â†“                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  èŠ‚ç‚¹æµç¨‹å¼•æ“å±‚ (NEW in v2.0)                           â”‚  â”‚
â”‚  â”‚  â”œâ”€ èŠ‚ç‚¹1: æ¶ˆæ¯æ¥æ”¶ä¸æ•°æ®åº“ä¿å­˜                         â”‚  â”‚
â”‚  â”‚  â”œâ”€ èŠ‚ç‚¹2: æ„å›¾AIåˆ†æ                                     â”‚  â”‚
â”‚  â”‚  â”œâ”€ èŠ‚ç‚¹3: å†³ç­–èŠ‚ç‚¹                                       â”‚  â”‚
â”‚  â”‚  â”œâ”€ èŠ‚ç‚¹4: AIå®¢æœå›å¤                                     â”‚  â”‚
â”‚  â”‚  â”œâ”€ èŠ‚ç‚¹5: æ¶ˆæ¯åˆ†å‘åˆ¤æ–­                                   â”‚  â”‚
â”‚  â”‚  â”œâ”€ èŠ‚ç‚¹6: å‘é€æœºå™¨äººæŒ‡ä»¤                                 â”‚  â”‚
â”‚  â”‚  â”œâ”€ èŠ‚ç‚¹7: æŒ‡ä»¤çŠ¶æ€è®°å½•                                   â”‚  â”‚
â”‚  â”‚  â”œâ”€ èŠ‚ç‚¹8: ç»“æŸ                                           â”‚  â”‚
â”‚  â”‚  â”œâ”€ èŠ‚ç‚¹B1: å‘Šè­¦ä¿¡æ¯å…¥åº“                                  â”‚  â”‚
â”‚  â”‚  â”œâ”€ èŠ‚ç‚¹B2: å‘Šè­¦è§„åˆ™åˆ¤æ–­                                  â”‚  â”‚
â”‚  â”‚  â””â”€ èŠ‚ç‚¹B3: å‘Šè­¦é€šçŸ¥æ‰§è¡Œ                                  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                          â†“                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  æœåŠ¡å±‚                                                   â”‚  â”‚
â”‚  â”‚  â”œâ”€ worktool.service.js      (WorkTool APIè°ƒç”¨)           â”‚  â”‚
â”‚  â”‚  â”œâ”€ robot.service.js         (æœºå™¨äººç®¡ç†)                 â”‚  â”‚
â”‚  â”‚  â”œâ”€ robot-command.service.js (æŒ‡ä»¤é˜Ÿåˆ—ç®¡ç†)               â”‚  â”‚
â”‚  â”‚  â”œâ”€ ai.service.js            (AIæœåŠ¡è°ƒç”¨)                 â”‚  â”‚
â”‚  â”‚  â”œâ”€ alert.service.js         (å‘Šè­¦æœåŠ¡)                   â”‚  â”‚
â”‚  â”‚  â”œâ”€ websocket.service.js     (å®æ—¶æ¨é€)                   â”‚  â”‚
â”‚  â”‚  â”œâ”€ message-queue.service.js (æ¶ˆæ¯é˜Ÿåˆ— NEW)              â”‚  â”‚
â”‚  â”‚  â””â”€ audit-log.service.js     (å®¡è®¡æ—¥å¿— NEW)              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                          â†“                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  æ•°æ®å±‚                                                   â”‚  â”‚
â”‚  â”‚  â”œâ”€ PostgreSQL (ä¸»æ•°æ®åº“)                                â”‚  â”‚
â”‚  â”‚  â”‚   â”œâ”€ å®Œæ•´çš„ç´¢å¼•ä¼˜åŒ–                                    â”‚  â”‚
â”‚  â”‚  â”‚   â””â”€ åˆ†é¡µæŸ¥è¯¢æ”¯æŒ                                      â”‚  â”‚
â”‚  â”‚  â””â”€ Redis (å¼ºåˆ¶ä½¿ç”¨)                                     â”‚  â”‚
â”‚  â”‚       â”œâ”€ ç¼“å­˜                                             â”‚  â”‚
â”‚  â”‚       â”œâ”€ ä¼šè¯                                             â”‚  â”‚
â”‚  â”‚       â””â”€ æ¶ˆæ¯é˜Ÿåˆ— (NEW)                                   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   WebSocketæ¨é€            â”‚
                    â”‚   (å®æ—¶æ›´æ–°ç›‘æ§é¢æ¿)        â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        å‰ç«¯æœåŠ¡ (5000ç«¯å£)                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  è®¤è¯æˆæƒæ¨¡å— (NEW in v2.0)                             â”‚  â”‚
â”‚  â”‚  â”œâ”€ ç™»å½•/ç™»å‡º                                             â”‚  â”‚
â”‚  â”‚  â”œâ”€ Tokenç®¡ç†                                             â”‚  â”‚
â”‚  â”‚  â””â”€ æƒé™æ§åˆ¶                                             â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  çŠ¶æ€ç®¡ç†æ¨¡å— (NEW in v2.0)                              â”‚  â”‚
â”‚  â”‚  â”œâ”€ userStore                                             â”‚  â”‚
â”‚  â”‚  â”œâ”€ robotStore                                            â”‚  â”‚
â”‚  â”‚  â”œâ”€ alertRuleStore                                        â”‚  â”‚
â”‚  â”‚  â”œâ”€ configStore                                           â”‚  â”‚
â”‚  â”‚  â””â”€ wsStore                                               â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  ç›‘æ§é¢æ¿1: ä¸šåŠ¡æ¶ˆæ¯ç›‘æ§                                   â”‚  â”‚
â”‚  â”‚  - ç”¨æˆ·æ¶ˆæ¯åˆ—è¡¨                                            â”‚  â”‚
â”‚  â”‚  - æœºå™¨äººå›å¤åˆ—è¡¨                                          â”‚  â”‚
â”‚  â”‚  - æ‰§è¡ŒçŠ¶æ€æ˜¾ç¤º                                            â”‚  â”‚
â”‚  â”‚  - ç­›é€‰å’Œæœç´¢                                              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  ç›‘æ§é¢æ¿2: AIäº¤äº’ç›‘æ§                                    â”‚  â”‚
â”‚  â”‚  - å®Œæ•´æ‰§è¡Œé“¾è·¯ï¼ˆæ—¶é—´çº¿ï¼‰                                 â”‚  â”‚
â”‚  â”‚  - AIè¾“å…¥è¾“å‡ºæŸ¥çœ‹                                         â”‚  â”‚
â”‚  â”‚  - æ€§èƒ½ç»Ÿè®¡                                               â”‚  â”‚
â”‚  â”‚  - è°ƒè¯•å·¥å…·                                               â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 3.2 æ•°æ®æµæ¶æ„ï¼ˆ2.0ï¼‰

```
WorkTool æ¶ˆæ¯æ¨é€
    â†“
Webhook æ¥æ”¶ (æ¶ˆæ¯å›è°ƒ)
    â†“
ç”Ÿæˆ messageId (å”¯ä¸€è¿½è¸ªID)
    â†“
ä¿å­˜åˆ° session_messages (ç”¨æˆ·æ¶ˆæ¯)
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  èŠ‚ç‚¹1: æ¶ˆæ¯æ¥æ”¶ä¸æ•°æ®åº“ä¿å­˜    â”‚
â”‚  âœ“ WebSocketæ¨é€ï¼ˆé˜¶æ®µ1ï¼‰       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  èŠ‚ç‚¹2: æ„å›¾AIåˆ†æ              â”‚
â”‚  â”œâ”€ è°ƒç”¨æ„å›¾AI                  â”‚
â”‚  â”œâ”€ ä¿å­˜ ai_io_logs (è¾“å…¥/è¾“å‡º) â”‚
â”‚  â”œâ”€ æ›´æ–° session_messages        â”‚
â”‚  â””â”€ âœ“ WebSocketæ¨é€ï¼ˆé˜¶æ®µ2ï¼‰    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  èŠ‚ç‚¹3: å†³ç­–èŠ‚ç‚¹                â”‚
â”‚  â”œâ”€ è·¯å¾„A: æ ‡å‡†å®¢æœ              â”‚
â”‚  â”œâ”€ è·¯å¾„B: éœ€è¦å‘Šè­¦              â”‚
â”‚  â””â”€ è·¯å¾„C: è·³è¿‡                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“ (è·¯å¾„A/B)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  èŠ‚ç‚¹4: AIå®¢æœå›å¤              â”‚
â”‚  â”œâ”€ è·å–ä¼šè¯å†å²                 â”‚
â”‚  â”œâ”€ è°ƒç”¨å®¢æœAI                  â”‚
â”‚  â”œâ”€ ä¿å­˜ ai_io_logs (è¾“å…¥/è¾“å‡º) â”‚
â”‚  â”œâ”€ ç”Ÿæˆå›å¤å†…å®¹                 â”‚
â”‚  â””â”€ âœ“ WebSocketæ¨é€ï¼ˆé˜¶æ®µ4ï¼‰    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  èŠ‚ç‚¹5: æ¶ˆæ¯åˆ†å‘åˆ¤æ–­            â”‚
â”‚  â”œâ”€ åˆ¤æ–­ç¾¤å‘/ç§å‘                â”‚
â”‚  â””â”€ ç¡®å®š targetName             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  èŠ‚ç‚¹6: å‘é€æœºå™¨äººæŒ‡ä»¤          â”‚
â”‚  â”œâ”€ æ„é€ æŒ‡ä»¤æ•°æ®                 â”‚
â”‚  â”œâ”€ ä¿å­˜ robotCommands           â”‚
â”‚  â”œâ”€ è°ƒç”¨ WorkTool API            â”‚
â”‚  â”œâ”€ ä¿å­˜ api_call_logs           â”‚
â”‚  â”œâ”€ ä¿å­˜ session_messages (å›å¤) â”‚
â”‚  â”œâ”€ âœ“ WebSocketæ¨é€é¢æ¿1        â”‚
â”‚  â””â”€ âœ“ WebSocketæ¨é€é¢æ¿2ï¼ˆé˜¶æ®µ5ï¼‰â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
è¿”å›æˆåŠŸå“åº”ç»™ WorkTool
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç‹¬ç«‹å›è°ƒç›‘å¬æœåŠ¡              â”‚
â”‚  â”œâ”€ æ¥æ”¶æ‰§è¡Œç»“æœå›è°ƒ             â”‚
â”‚  â”œâ”€ ä¿å­˜ callback_history        â”‚
â”‚  â”œâ”€ æ›´æ–° robotCommands çŠ¶æ€      â”‚
â”‚  â”œâ”€ æ›´æ–° session_messages        â”‚
â”‚  â”œâ”€ âœ“ WebSocketæ¨é€é¢æ¿1        â”‚
â”‚  â””â”€ âœ“ WebSocketæ¨é€é¢æ¿2ï¼ˆé˜¶æ®µ6ï¼‰â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 4. èŠ‚ç‚¹æµç¨‹å¼•æ“

### 4.1 èŠ‚ç‚¹æµç¨‹æ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    WorkTool Webhookï¼ˆæ¶ˆæ¯å›è°ƒï¼‰                  â”‚
â”‚                  /api/worktool/callback/message?robotId={id}     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â†“
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  èŠ‚ç‚¹1: æ¶ˆæ¯æ¥æ”¶     â”‚
                    â”‚  + æ•°æ®åº“å®Œæ•´ä¿å­˜    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â†“
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  èŠ‚ç‚¹2: æ„å›¾AIåˆ†æ   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â†“
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   èŠ‚ç‚¹3: å†³ç­–èŠ‚ç‚¹    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â†“               â†“               â†“
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ è·¯å¾„Aï¼šæ ‡å‡†   â”‚ â”‚ è·¯å¾„Bï¼šéœ€è¦   â”‚ â”‚ è·¯å¾„Cï¼šè·³è¿‡   â”‚
   â”‚   å®¢æœå›å¤    â”‚ â”‚   å‘Šè­¦å¤„ç†    â”‚ â”‚    å¤„ç†      â”‚
   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
          â†“                â†“                â†“
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ èŠ‚ç‚¹4: AI    â”‚ â”‚ èŠ‚ç‚¹B1: å‘Šè­¦å…¥åº“     â”‚ â”‚ èŠ‚ç‚¹8: ç»“æŸ   â”‚
   â”‚  å®¢æœå›å¤    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  (è·³è¿‡å›å¤)   â”‚
   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜            â†“            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â†“             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚ èŠ‚ç‚¹B2: å‘Šè­¦  â”‚
   â”‚ èŠ‚ç‚¹5: æ¶ˆæ¯   â”‚     â”‚   è§„åˆ™åˆ¤æ–­    â”‚
   â”‚  åˆ†å‘åˆ¤æ–­    â”‚     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜            â†“
          â†“             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚ èŠ‚ç‚¹B3: å‘Šè­¦  â”‚
   â”‚ èŠ‚ç‚¹6: å‘é€   â”‚     â”‚   é€šçŸ¥æ‰§è¡Œ    â”‚
   â”‚  æœºå™¨äººæŒ‡ä»¤   â”‚     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜            â†“
          â†“             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚ åŒæ—¶ä¹Ÿå»     â”‚
   â”‚ èŠ‚ç‚¹7: æŒ‡ä»¤   â”‚     â”‚ èŠ‚ç‚¹4 (AI)   â”‚
   â”‚  çŠ¶æ€è®°å½•    â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜            â†“
          â†“             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚ èŠ‚ç‚¹5-7      â”‚
   â”‚ èŠ‚ç‚¹8: ç»“æŸ   â”‚     â”‚ (æ ‡å‡†æµç¨‹)   â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â†“
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ ç‹¬ç«‹çš„å›è°ƒç›‘å¬æœåŠ¡ï¼ˆå¼‚æ­¥ï¼‰            â”‚
   â”‚ WorkTool æ‰§è¡Œç»“æœå›è°ƒ â†’ æ›´æ–°æŒ‡ä»¤çŠ¶æ€ â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 ç»Ÿä¸€æ¶ˆæ¯æ ¼å¼

æ‰€æœ‰èŠ‚ç‚¹ä¼ é€’çš„æ¶ˆæ¯éƒ½éµå¾ªç»Ÿä¸€æ ¼å¼ï¼ŒåŒ…å«å®Œæ•´çš„è¿½è¸ªä¿¡æ¯å’Œä¸Šä¸‹æ–‡ã€‚

```typescript
interface MessageContext {
  // ===== æ¶ˆæ¯è¿½è¸ª =====
  messageId: string;           // æ¶ˆæ¯å”¯ä¸€IDï¼ˆè´¯ç©¿æ•´ä¸ªæµç¨‹ï¼‰
  sessionId: string;          // ä¼šè¯ID
  currentNodeId: string;      // å½“å‰èŠ‚ç‚¹ID
  previousNodeId: string;     // ä¸Šä¸€ä¸ªèŠ‚ç‚¹ID
  
  // ===== æ¶ˆæ¯æ¥æºä¿¡æ¯ =====
  robotId: string;            // æœºå™¨äººIDï¼ˆç”¨äºè¯†åˆ«æ˜¯å“ªä¸ªæœºå™¨äººï¼‰
  groupName: string | null;   // ç¾¤åç§°ï¼ˆç¾¤å‘æ—¶æœ‰å€¼ï¼Œç§å‘ä¸ºnullï¼‰
  userName: string;          // å‘é€æ¶ˆæ¯çš„ç”¨æˆ·å
  
  // ===== æ¶ˆæ¯å†…å®¹ =====
  messageType: 'text' | 'image' | 'file';  // æ¶ˆæ¯ç±»å‹
  messageContent: string;    // åŸå§‹æ¶ˆæ¯å†…å®¹
  messageRaw: string;        // åŸå§‹æ¶ˆæ¯å®Œæ•´JSONï¼ˆç”¨äºè°ƒè¯•ï¼‰
  
  // ===== æ—¶é—´ä¿¡æ¯ =====
  timestamp: number;         // æ¶ˆæ¯æ—¶é—´æˆ³
  
  // ===== ä¸Šä¸‹æ–‡æ‰©å±•å­—æ®µ =====
  intent?: string;           // æ„å›¾ç±»å‹ï¼ˆèŠ‚ç‚¹2æ·»åŠ ï¼‰
  intentConfidence?: number; // æ„å›¾ç½®ä¿¡åº¦ï¼ˆèŠ‚ç‚¹2æ·»åŠ ï¼‰
  alertLevel?: string;       // å‘Šè­¦ç­‰çº§ï¼ˆèŠ‚ç‚¹3æ·»åŠ ï¼‰
  aiReply?: string;          // AIå›å¤å†…å®¹ï¼ˆèŠ‚ç‚¹4æ·»åŠ ï¼‰
  sendType?: 'group' | 'private';  // å‘é€ç±»å‹ï¼ˆèŠ‚ç‚¹5æ·»åŠ ï¼‰
  targetName?: string;       // ç›®æ ‡åç§°ï¼ˆèŠ‚ç‚¹5æ·»åŠ ï¼‰
  
  // ===== æ‰§è¡Œç»“æœ =====
  commandResult?: {
    status: 'pending' | 'success' | 'failed' | 'timeout';
    commandId: string;
    sentAt: number;
    completedAt?: number;
    errorReason?: string;
  };
  
  // ===== æœºå™¨äººé…ç½®ä¿¡æ¯ =====
  robotConfig: {
    apiBaseUrl: string;
    apiToken: string;
    webhookUrl: string;
    robotName: string;
    isActive: boolean;
    status: string;
  };
}
```

---

## 5. æ•°æ®åº“è®¾è®¡

### 5.1 æ ¸å¿ƒæ•°æ®è¡¨ï¼ˆ2.0ï¼‰

#### 5.1.1 session_messages - ä¼šè¯æ¶ˆæ¯è®°å½•è¡¨

**ç”¨é€”**ï¼šè®°å½•æ‰€æœ‰æ¶ˆæ¯ï¼ˆç”¨æˆ·æ¶ˆæ¯ã€æœºå™¨äººæ¶ˆæ¯ã€ç³»ç»Ÿæ¶ˆæ¯ï¼‰

| å­—æ®µå | ç±»å‹ | è¯´æ˜ | ç´¢å¼• |
|--------|------|------|------|
| id | varchar(36) | ä¸»é”® | PK |
| messageId | varchar(255) | æ¶ˆæ¯IDï¼ˆç”¨äºè¿½è¸ªï¼‰ | INDEX |
| sessionId | varchar(255) | ä¼šè¯ID | INDEX |
| userId | varchar(255) | ç”¨æˆ·ID | INDEX |
| groupId | varchar(255) | ç¾¤ç»„ID | INDEX |
| userName | varchar(255) | ç”¨æˆ·å | - |
| groupName | varchar(255) | ç¾¤ç»„å | - |
| robotId | varchar(64) | æœºå™¨äººID | INDEX |
| robotName | varchar(255) | æœºå™¨äººåç§° | - |
| content | text | æ¶ˆæ¯å†…å®¹ | - |
| isFromUser | boolean | æ˜¯å¦æ¥è‡ªç”¨æˆ· | - |
| isFromBot | boolean | æ˜¯å¦æ¥è‡ªæœºå™¨äºº | - |
| isHuman | boolean | æ˜¯å¦äººå·¥å›å¤ | - |
| intent | varchar(50) | æ„å›¾è¯†åˆ«ç»“æœ | INDEX |
| confidence | integer | æ„å›¾è¯†åˆ«ç½®ä¿¡åº¦ï¼ˆ0-100ï¼‰ | - |
| timestamp | timestamp | æ¶ˆæ¯æ—¶é—´æˆ³ | INDEX |
| extraData | jsonb | é¢å¤–æ•°æ®ï¼ˆJSONæ ¼å¼ï¼‰ | - |
| createdAt | timestamp | åˆ›å»ºæ—¶é—´ | - |

**extraData å­—æ®µç»“æ„**ï¼š
```json
{
  "rawSpoken": "åŸå§‹é—®é¢˜",
  "roomType": 1,
  "atMe": false,
  "textType": 1,
  "commandId": "cmd_xxx",
  "sendType": "group",
  "targetName": "å®¢æœç¾¤",
  "deliveryStatus": "delivered"
}
```

**æ–°å¢ç´¢å¼•ï¼ˆv2.0ï¼‰**ï¼š
```sql
CREATE INDEX idx_session_messages_session_created ON session_messages(session_id, created_at);
CREATE INDEX idx_session_messages_robot_created ON session_messages(robot_id, created_at);
CREATE INDEX idx_session_messages_intent_created ON session_messages(intent, created_at);
```

---

#### 5.1.2 ai_io_logs - AI IO æ—¥å¿—è¡¨

**ç”¨é€”**ï¼šè®°å½•æ‰€æœ‰ AI äº¤äº’ï¼ˆè¾“å…¥å’Œè¾“å‡ºï¼‰

| å­—æ®µå | ç±»å‹ | è¯´æ˜ | ç´¢å¼• |
|--------|------|------|------|
| id | varchar(36) | ä¸»é”® | PK |
| sessionId | varchar(255) | ä¼šè¯ID | INDEX |
| messageId | varchar(255) | å…³è”çš„æ¶ˆæ¯ID | INDEX (NEW) |
| robotId | varchar(64) | æœºå™¨äººID | - |
| robotName | varchar(255) | æœºå™¨äººåç§° | - |
| operationType | varchar(50) | æ“ä½œç±»å‹ | - |
| aiInput | text | å‘é€ç»™ AI çš„è¾“å…¥ | - |
| aiOutput | text | AI è¿”å›çš„è¾“å‡º | - |
| modelId | varchar(255) | ä½¿ç”¨çš„ AI æ¨¡å‹ ID | - |
| temperature | varchar(10) | æ¸©åº¦å‚æ•° | - |
| requestDuration | integer | è¯·æ±‚è€—æ—¶ï¼ˆæ¯«ç§’ï¼‰ | - |
| status | varchar(20) | çŠ¶æ€ | - |
| errorMessage | text | é”™è¯¯ä¿¡æ¯ | - |
| createdAt | timestamp | åˆ›å»ºæ—¶é—´ | INDEX |

**operationType æšä¸¾å€¼**ï¼š
- `intent_recognition`ï¼šæ„å›¾è¯†åˆ«
- `service_reply`ï¼šå®¢æœå›å¤
- `chat_reply`ï¼šèŠå¤©å›å¤
- `help_reply`ï¼šå¸®åŠ©å›å¤
- `report`ï¼šæŠ¥å‘Šç”Ÿæˆ

**æ–°å¢ç´¢å¼•ï¼ˆv2.0ï¼‰**ï¼š
```sql
CREATE INDEX idx_ai_io_logs_message_id ON ai_io_logs(message_id);
CREATE INDEX idx_ai_io_logs_operation_created ON ai_io_logs(operation_type, created_at);
```

---

#### 5.1.3 robotCommands - æœºå™¨äººæŒ‡ä»¤è¡¨

**ç”¨é€”**ï¼šè®°å½•æ‰€æœ‰å‘é€ç»™æœºå™¨äººçš„æŒ‡ä»¤

| å­—æ®µå | ç±»å‹ | è¯´æ˜ | ç´¢å¼• |
|--------|------|------|------|
| id | varchar(36) | ä¸»é”® | PK |
| robotId | varchar(64) | æœºå™¨äººID | INDEX |
| commandType | varchar(50) | æŒ‡ä»¤ç±»å‹ | - |
| commandData | jsonb | æŒ‡ä»¤æ•°æ® | - |
| status | varchar(20) | çŠ¶æ€ | INDEX |
| priority | integer | ä¼˜å…ˆçº§ï¼ˆ1-10ï¼Œ1æœ€é«˜ï¼‰ | - |
| retryCount | integer | é‡è¯•æ¬¡æ•° | - |
| maxRetries | integer | æœ€å¤§é‡è¯•æ¬¡æ•° | - |
| executedAt | timestamp | æ‰§è¡Œæ—¶é—´ | - |
| completedAt | timestamp | å®Œæˆæ—¶é—´ | - |
| createdAt | timestamp | åˆ›å»ºæ—¶é—´ | INDEX |
| updatedAt | timestamp | æ›´æ–°æ—¶é—´ | - |

**status æšä¸¾å€¼**ï¼š
- `pending`ï¼šç­‰å¾…ä¸­
- `processing`ï¼šå¤„ç†ä¸­
- `completed`ï¼šå·²å®Œæˆ
- `failed`ï¼šå¤±è´¥
- `timeout`ï¼šè¶…æ—¶

**æ–°å¢ç´¢å¼•ï¼ˆv2.0ï¼‰**ï¼š
```sql
CREATE INDEX idx_robot_commands_status_created ON robotCommands(status, created_at);
```

---

#### 5.1.4 callbackHistory - å›è°ƒå†å²è®°å½•è¡¨

**ç”¨é€”**ï¼šè®°å½•æ‰€æœ‰ WorkTool å›è°ƒ

| å­—æ®µå | ç±»å‹ | è¯´æ˜ | ç´¢å¼• |
|--------|------|------|------|
| id | varchar(36) | ä¸»é”® | PK |
| robotId | varchar(64) | æœºå™¨äººID | INDEX |
| messageId | varchar(128) | æ¶ˆæ¯ID | INDEX |
| callbackType | integer | å›è°ƒç±»å‹ | INDEX |
| errorCode | integer | é”™è¯¯ç  | INDEX |
| errorReason | text | é”™è¯¯åŸå›  | - |
| runTime | integer | æ‰§è¡Œæ—¶é—´æˆ³ï¼ˆæ¯«ç§’ï¼‰ | - |
| timeCost | integer | æŒ‡ä»¤æ‰§è¡Œè€—æ—¶ï¼ˆæ¯«ç§’ï¼‰ | - |
| commandType | integer | æŒ‡ä»¤ç±»å‹ | - |
| rawMsg | text | åŸå§‹æŒ‡ä»¤ | - |
| extraData | jsonb | é¢å¤–æ•°æ® | - |
| createdAt | timestamp | åˆ›å»ºæ—¶é—´ | INDEX |

**callbackType æšä¸¾å€¼**ï¼š
- 0ï¼šç¾¤äºŒç»´ç 
- 1ï¼šæŒ‡ä»¤ç»“æœ
- 5ï¼šä¸Šçº¿
- 6ï¼šä¸‹çº¿
- 11ï¼šæ¶ˆæ¯

---

#### 5.1.5 alertHistory - å‘Šè­¦å†å²è¡¨

**ç”¨é€”**ï¼šè®°å½•æ‰€æœ‰å‘Šè­¦ä¿¡æ¯

| å­—æ®µå | ç±»å‹ | è¯´æ˜ | ç´¢å¼• |
|--------|------|------|------|
| id | varchar(36) | ä¸»é”® | PK |
| sessionId | varchar(255) | ä¼šè¯ID | INDEX |
| alertRuleId | varchar(36) | å…³è”çš„å‘Šè­¦è§„åˆ™ID | INDEX |
| intentType | varchar(50) | è§¦å‘å‘Šè­¦çš„æ„å›¾ç±»å‹ | INDEX |
| alertLevel | varchar(20) | å‘Šè­¦çº§åˆ« | INDEX |
| groupId | varchar(255) | ç¾¤ç»„ID | - |
| groupName | varchar(255) | ç¾¤ç»„å | - |
| userId | varchar(255) | è§¦å‘å‘Šè­¦çš„ç”¨æˆ·ID | - |
| userName | varchar(255) | è§¦å‘å‘Šè­¦çš„ç”¨æˆ·å | - |
| messageContent | text | è§¦å‘å‘Šè­¦çš„æ¶ˆæ¯å†…å®¹ | - |
| alertMessage | text | å‘Šè­¦æ¶ˆæ¯ | - |
| notificationStatus | varchar(20) | é€šçŸ¥çŠ¶æ€ | INDEX |
| notificationResult | jsonb | é€šçŸ¥ç»“æœ | - |
| status | varchar(20) | çŠ¶æ€ | - |
| isHandled | boolean | æ˜¯å¦å·²å¤„ç† | - |
| handledBy | varchar(36) | å¤„ç†äººID | - |
| handledAt | timestamp | å¤„ç†æ—¶é—´ | - |
| confidence | integer | æ„å›¾è¯†åˆ«ç½®ä¿¡åº¦ | - |
| robotId | varchar(64) | å…³è”çš„æœºå™¨äººID | - |
| createdAt | timestamp | åˆ›å»ºæ—¶é—´ | INDEX |

**æ–°å¢ç´¢å¼•ï¼ˆv2.0ï¼‰**ï¼š
```sql
CREATE INDEX idx_alert_history_created_level ON alert_history(created_at, alert_level);
```

---

### 5.2 æ–°å¢æ•°æ®è¡¨ï¼ˆv2.0ï¼‰

#### 5.2.1 users - ç”¨æˆ·è¡¨ï¼ˆå®‰å…¨å‡çº§ï¼‰

**ç”¨é€”**ï¼šå­˜å‚¨ç”¨æˆ·ä¿¡æ¯å’Œè®¤è¯æ•°æ®

| å­—æ®µå | ç±»å‹ | è¯´æ˜ | ç´¢å¼• |
|--------|------|------|------|
| id | varchar(36) | ä¸»é”® | PK |
| username | varchar(64) | ç”¨æˆ·å | UNIQUE, INDEX |
| email | varchar(255) | é‚®ç®± | UNIQUE, INDEX |
| password | text | å¯†ç ï¼ˆbcryptåŠ å¯†ï¼‰ | - |
| role | varchar(20) | è§’è‰² | INDEX |
| isActive | boolean | æ˜¯å¦æ¿€æ´» | - |
| lastLoginAt | timestamp | æœ€åç™»å½•æ—¶é—´ | - |
| createdAt | timestamp | åˆ›å»ºæ—¶é—´ | - |
| updatedAt | timestamp | æ›´æ–°æ—¶é—´ | - |

**role æšä¸¾å€¼**ï¼š
- `admin`ï¼šç®¡ç†å‘˜
- `operator`ï¼šæ“ä½œå‘˜
- `viewer`ï¼šæŸ¥çœ‹è€…ï¼ˆNEWï¼‰

---

#### 5.2.2 roles - è§’è‰²è¡¨ï¼ˆå®‰å…¨å‡çº§ï¼‰

**ç”¨é€”**ï¼šå®šä¹‰ç³»ç»Ÿè§’è‰²å’Œæƒé™å…³è”

| å­—æ®µå | ç±»å‹ | è¯´æ˜ | ç´¢å¼• |
|--------|------|------|------|
| id | varchar(36) | ä¸»é”® | PK |
| name | varchar(50) | è§’è‰²åç§° | UNIQUE |
| description | text | è§’è‰²æè¿° | - |
| createdAt | timestamp | åˆ›å»ºæ—¶é—´ | - |
| updatedAt | timestamp | æ›´æ–°æ—¶é—´ | - |

---

#### 5.2.3 permissions - æƒé™è¡¨ï¼ˆå®‰å…¨å‡çº§ï¼‰

**ç”¨é€”**ï¼šå®šä¹‰ç³»ç»Ÿæƒé™

| å­—æ®µå | ç±»å‹ | è¯´æ˜ | ç´¢å¼• |
|--------|------|------|------|
| id | varchar(36) | ä¸»é”® | PK |
| name | varchar(50) | æƒé™åç§° | UNIQUE |
| resource | varchar(50) | èµ„æºç±»å‹ | - |
| action | varchar(50) | æ“ä½œç±»å‹ | - |
| description | text | æƒé™æè¿° | - |
| createdAt | timestamp | åˆ›å»ºæ—¶é—´ | - |

**resource æšä¸¾å€¼**ï¼š
- `robots`ï¼šæœºå™¨äºº
- `alerts`ï¼šå‘Šè­¦
- `ai`ï¼šAIé…ç½®
- `sessions`ï¼šä¼šè¯
- `monitor`ï¼šç›‘æ§
- `admin`ï¼šç®¡ç†

**action æšä¸¾å€¼**ï¼š
- `read`ï¼šè¯»å–
- `create`ï¼šåˆ›å»º
- `update`ï¼šæ›´æ–°
- `delete`ï¼šåˆ é™¤

---

#### 5.2.4 user_roles - ç”¨æˆ·è§’è‰²å…³è”è¡¨ï¼ˆå®‰å…¨å‡çº§ï¼‰

**ç”¨é€”**ï¼šå…³è”ç”¨æˆ·å’Œè§’è‰²ï¼ˆå¤šå¯¹å¤šï¼‰

| å­—æ®µå | ç±»å‹ | è¯´æ˜ | ç´¢å¼• |
|--------|------|------|------|
| userId | varchar(36) | ç”¨æˆ·ID | FK, INDEX |
| roleId | varchar(36) | è§’è‰²ID | FK, INDEX |
| createdAt | timestamp | åˆ›å»ºæ—¶é—´ | - |

---

#### 5.2.5 role_permissions - è§’è‰²æƒé™å…³è”è¡¨ï¼ˆå®‰å…¨å‡çº§ï¼‰

**ç”¨é€”**ï¼šå…³è”è§’è‰²å’Œæƒé™ï¼ˆå¤šå¯¹å¤šï¼‰

| å­—æ®µå | ç±»å‹ | è¯´æ˜ | ç´¢å¼• |
|--------|------|------|------|
| roleId | varchar(36) | è§’è‰²ID | FK, INDEX |
| permissionId | varchar(36) | æƒé™ID | FK, INDEX |
| createdAt | timestamp | åˆ›å»ºæ—¶é—´ | - |

---

#### 5.2.6 audit_logs - å®¡è®¡æ—¥å¿—è¡¨ï¼ˆå®‰å…¨å‡çº§ï¼‰

**ç”¨é€”**ï¼šè®°å½•ç”¨æˆ·æ“ä½œæ—¥å¿—

| å­—æ®µå | ç±»å‹ | è¯´æ˜ | ç´¢å¼• |
|--------|------|------|------|
| id | varchar(36) | ä¸»é”® | PK |
| userId | varchar(36) | ç”¨æˆ·ID | INDEX |
| action | varchar(50) | æ“ä½œç±»å‹ | INDEX |
| resource | varchar(50) | èµ„æºç±»å‹ | - |
| resourceId | varchar(255) | èµ„æºID | - |
| details | jsonb | æ“ä½œè¯¦æƒ… | - |
| ipAddress | varchar(45) | IPåœ°å€ | - |
| userAgent | text | User Agent | - |
| createdAt | timestamp | åˆ›å»ºæ—¶é—´ | INDEX |

**action æšä¸¾å€¼**ï¼š
- `login`ï¼šç™»å½•
- `logout`ï¼šç™»å‡º
- `create`ï¼šåˆ›å»º
- `update`ï¼šæ›´æ–°
- `delete`ï¼šåˆ é™¤
- `export`ï¼šå¯¼å‡º

---

### 5.3 æ•°æ®å…³ç³»å›¾ï¼ˆv2.0ï¼‰

```
session_messages (æ¶ˆæ¯è¡¨)
    â†“
    â”œâ”€â†’ ai_io_logs (AIäº¤äº’) [é€šè¿‡messageIdå…³è”]
    â”œâ”€â†’ robotCommands (æŒ‡ä»¤) [é€šè¿‡extraData.commandIdå…³è”]
    â””â”€â†’ alertHistory (å‘Šè­¦) [é€šè¿‡sessionIdå…³è”]

robotCommands (æŒ‡ä»¤è¡¨)
    â†“
    â”œâ”€â†’ callbackHistory (å›è°ƒ) [é€šè¿‡id=messageIdå…³è”]
    â””â”€â†’ api_call_logs (APIæ—¥å¿—) [é€šè¿‡id=messageIdå…³è”]

ai_io_logs (AIäº¤äº’è¡¨)
    â†“
    â””â”€â†’ session_messages [é€šè¿‡messageIdå…³è”]

alertHistory (å‘Šè­¦è¡¨)
    â†“
    â””â”€â†’ session_messages [é€šè¿‡sessionIdå…³è”]

users (ç”¨æˆ·è¡¨)
    â†“
    â”œâ”€â†’ user_roles (ç”¨æˆ·è§’è‰²å…³è”)
    â”‚    â†“
    â”‚    â””â”€â†’ roles (è§’è‰²è¡¨)
    â”‚         â†“
    â”‚         â””â”€â†’ role_permissions (è§’è‰²æƒé™å…³è”)
    â”‚              â†“
    â”‚              â””â”€â†’ permissions (æƒé™è¡¨)
    â”‚
    â””â”€â†’ audit_logs (å®¡è®¡æ—¥å¿—) [é€šè¿‡userIdå…³è”]
```

---

## 6. åŒç›‘æ§é¢æ¿ç³»ç»Ÿ

### 6.1 é¢æ¿1ï¼šä¸šåŠ¡æ¶ˆæ¯ç›‘æ§

#### 6.1.1 åŠŸèƒ½å®šä½

- å±•ç¤ºç”¨æˆ·çš„åŸå§‹æ¶ˆæ¯
- å±•ç¤ºæœºå™¨äººçš„å›å¤æ¶ˆæ¯
- å±•ç¤ºæ¶ˆæ¯çš„æ‰§è¡ŒçŠ¶æ€ï¼ˆpending/success/failedï¼‰
- æ”¯æŒæŒ‰æœºå™¨äººã€ç”¨æˆ·ã€ç¾¤ç»„ç­›é€‰
- æ”¯æŒå®æ—¶æ›´æ–°

#### 6.1.2 æ•°æ®ç»“æ„

```typescript
interface BusinessMessage {
  messageId: string;
  sessionId: string;
  timestamp: number;
  
  // ç”¨æˆ·æ¶ˆæ¯
  userMessage: {
    messageId: string;
    userName: string;
    groupName: string | null;
    content: string;
    roomType: number;
    atMe: boolean;
    intent: string | null;
    confidence: number | null;
  };
  
  // æœºå™¨äººå›å¤
  botReply: {
    messageId: string;
    content: string;
    robotName: string;
    sendType: 'group' | 'private';
    targetName: string;
  } | null;
  
  // æ‰§è¡ŒçŠ¶æ€
  deliveryStatus: {
    status: 'pending' | 'success' | 'failed' | 'timeout';
    commandId: string;
    sentAt: number;
    completedAt?: number;
    timeCost?: number;
    errorReason?: string | null;
  };
  
  // æœºå™¨äººä¿¡æ¯
  robot: {
    robotId: string;
    name: string;
    status: string;
  };
}
```

#### 6.1.3 WebSocketäº‹ä»¶

| äº‹ä»¶ç±»å‹ | è¯´æ˜ | æ•°æ®ç»“æ„ |
|----------|------|----------|
| `new_message` | æ–°æ¶ˆæ¯ | BusinessMessage |
| `delivery_status_update` | æ‰§è¡ŒçŠ¶æ€æ›´æ–° | { messageId, deliveryStatus } |

---

### 6.2 é¢æ¿2ï¼šAIäº¤äº’ç›‘æ§

#### 6.2.1 åŠŸèƒ½å®šä½

- å±•ç¤ºå®Œæ•´çš„ AI äº¤äº’é“¾è·¯ï¼ˆ6ä¸ªé˜¶æ®µï¼‰
- å±•ç¤ºæ„å›¾è¯†åˆ«è¿‡ç¨‹
- å±•ç¤ºå®¢æœå›å¤è¿‡ç¨‹
- å±•ç¤ºæ‰€æœ‰ AI è¾“å…¥è¾“å‡º
- æ”¯æŒè°ƒè¯•å’Œæ€§èƒ½åˆ†æ

#### 6.2.2 æ‰§è¡Œé˜¶æ®µå®šä¹‰

| é˜¶æ®µ | è¯´æ˜ | æ•°æ®æ¥æº |
|------|------|----------|
| `stage1_receive` | æ¥æ”¶æ¶ˆæ¯ | session_messages |
| `stage2_intent` | æ„å›¾è¯†åˆ« | ai_io_logs (operationType=intent_recognition) |
| `stage3_decision` | å†³ç­– | session_messages (intent, confidence) |
| `stage4_service` | AIå®¢æœå›å¤ | ai_io_logs (operationType=service_reply) |
| `stage5_command` | å‘é€æŒ‡ä»¤ | robotCommands + api_call_logs |
| `stage6_callback` | æ‰§è¡Œç»“æœå›è°ƒ | callback_history |

#### 6.2.3 WebSocketäº‹ä»¶

| äº‹ä»¶ç±»å‹ | è¯´æ˜ | æ•°æ®ç»“æ„ |
|----------|------|----------|
| `stage_start` | é˜¶æ®µå¼€å§‹ | { messageId, stage, data } |
| `stage_complete` | é˜¶æ®µå®Œæˆ | { messageId, stage, data } |

---

### 6.3 æ¨é€æ—¶æœºæ€»ç»“

| é˜¶æ®µ | é¢æ¿1æ¨é€ | é¢æ¿2æ¨é€ | æ•°æ®å†™å…¥ |
|------|----------|----------|----------|
| èŠ‚ç‚¹1: æ¶ˆæ¯æ¥æ”¶ | - | `stage_start` (stage1) | session_messages |
| èŠ‚ç‚¹2: æ„å›¾è¯†åˆ« | - | `stage_complete` (stage2) | ai_io_logs, session_messages |
| èŠ‚ç‚¹3: å†³ç­– | - | `stage_complete` (stage3) | - |
| èŠ‚ç‚¹4: AIå®¢æœå›å¤ | - | `stage_complete` (stage4) | ai_io_logs |
| èŠ‚ç‚¹6: å‘é€æŒ‡ä»¤ | `new_message` | `stage_complete` (stage5) | robotCommands, api_call_logs, session_messages |
| å›è°ƒ: æ‰§è¡Œç»“æœ | `delivery_status_update` | `stage_complete` (stage6) | callback_history, robotCommands, session_messages |

---

## 7. å®‰å…¨ä½“ç³»

### 7.1 è®¤è¯æˆæƒä½“ç³»

#### 7.1.1 JWTè®¤è¯

**Access Token**ï¼š
- æœ‰æ•ˆæœŸï¼š24å°æ—¶
- å­˜å‚¨ä½ç½®ï¼šå‰ç«¯å†…å­˜
- ç”¨é€”ï¼šAPIè¯·æ±‚è®¤è¯

**Refresh Token**ï¼š
- æœ‰æ•ˆæœŸï¼š7å¤©
- å­˜å‚¨ä½ç½®ï¼šHttpOnly Cookie
- ç”¨é€”ï¼šåˆ·æ–°Access Token

**ç™»å½•æµç¨‹**ï¼š
```
1. ç”¨æˆ·æäº¤ç”¨æˆ·åå¯†ç 
2. åç«¯éªŒè¯å¯†ç ï¼ˆbcrypt.compareï¼‰
3. ç”ŸæˆAccess Tokenå’ŒRefresh Token
4. Access Tokenè¿”å›ç»™å‰ç«¯
5. Refresh Tokenå­˜å‚¨åœ¨HttpOnly Cookie
6. å‰ç«¯ä½¿ç”¨Access Tokenè®¿é—®API
7. Access Tokenè¿‡æœŸåï¼Œä½¿ç”¨Refresh Tokenåˆ·æ–°
```

---

#### 7.1.2 RBACæƒé™æ¨¡å‹

**æƒé™è¡¨ç»“æ„**ï¼š
```
permissions (æƒé™è¡¨)
    â†“
roles (è§’è‰²è¡¨)
    â†“
user_roles (ç”¨æˆ·è§’è‰²å…³è”)
    â†“
users (ç”¨æˆ·è¡¨)
```

**æƒé™ç¤ºä¾‹**ï¼š
```
adminè§’è‰²ï¼š
  - robots:read/create/update/delete
  - alerts:read/create/update/delete
  - ai:read/create/update/delete
  - sessions:read/delete
  - monitor:read
  - admin:read/create/update/delete

operatorè§’è‰²ï¼š
  - robots:read
  - alerts:read/create
  - ai:read
  - sessions:read
  - monitor:read

viewerè§’è‰²ï¼š
  - robots:read
  - alerts:read
  - monitor:read
```

---

### 7.2 å®¡è®¡æ—¥å¿—

**è‡ªåŠ¨è®°å½•çš„æ“ä½œ**ï¼š
- ç”¨æˆ·ç™»å½•/ç™»å‡º
- æ•°æ®åˆ›å»º/æ›´æ–°/åˆ é™¤
- æƒé™å˜æ›´
- ç³»ç»Ÿé…ç½®ä¿®æ”¹

**æ—¥å¿—å†…å®¹**ï¼š
```typescript
interface AuditLog {
  userId: string;
  action: 'login' | 'logout' | 'create' | 'update' | 'delete';
  resource: string;
  resourceId: string;
  details: {
    before?: any;
    after?: any;
    changes?: any;
  };
  ipAddress: string;
  userAgent: string;
  createdAt: Date;
}
```

---

### 7.3 æ•°æ®å®‰å…¨

#### 7.3.1 å¯†ç å®‰å…¨

- ä½¿ç”¨bcryptåŠ å¯†ï¼ˆsalt rounds: 10ï¼‰
- ä¸å…è®¸æ˜æ–‡å­˜å‚¨å¯†ç 
- å¯†ç éªŒè¯ä½¿ç”¨bcrypt.compare

#### 7.3.2 æ•æ„Ÿä¿¡æ¯ä¿æŠ¤

- æ‰€æœ‰æ•æ„Ÿé…ç½®é€šè¿‡ç¯å¢ƒå˜é‡
- ä¸åœ¨ä»£ç ä¸­ç¡¬ç¼–ç å¯†é’¥å’ŒToken
- APIå“åº”ä¸­è¿‡æ»¤æ•æ„Ÿå­—æ®µ

#### 7.3.3 CORSé…ç½®

```javascript
// å¼€å‘ç¯å¢ƒ
fastify.register(cors, {
  origin: '*',
  credentials: true
});

// ç”Ÿäº§ç¯å¢ƒ
fastify.register(cors, {
  origin: 'https://your-domain.com',
  credentials: true
});
```

---

## 8. æ€§èƒ½ä¼˜åŒ–

### 8.1 ç¼“å­˜ç­–ç•¥

#### 8.1.1 Redisç¼“å­˜è§„èŒƒ

**ç¼“å­˜é”®è§„èŒƒ**ï¼š
```
{prefix}:{resource}:{id}:{hash}

ç¤ºä¾‹ï¼š
- cache:robot:robot_001
- cache:alert:rule_001
- cache:session:session_001
```

**TTLç­–ç•¥**ï¼š
- æœºå™¨äººé…ç½®ï¼š1å°æ—¶
- å‘Šè­¦è§„åˆ™ï¼š30åˆ†é’Ÿ
- æ„å›¾é…ç½®ï¼š1å°æ—¶
- ä¼šè¯æ•°æ®ï¼š2å°æ—¶
- AIç»“æœç¼“å­˜ï¼š10-30åˆ†é’Ÿ

**ç¼“å­˜ç©¿é€ä¿æŠ¤**ï¼š
```javascript
// ä½¿ç”¨å¸ƒéš†è¿‡æ»¤å™¨æˆ–ç©ºå€¼ç¼“å­˜
async function getWithCache(key, ttl, fetchFn) {
  const cached = await redis.get(key);
  if (cached !== null) {
    return cached === 'NULL' ? null : JSON.parse(cached);
  }
  
  const data = await fetchFn();
  if (data === null) {
    await redis.set(key, 'NULL', 'EX', 60);  // ç©ºå€¼ç¼“å­˜60ç§’
    return null;
  }
  
  await redis.set(key, JSON.stringify(data), 'EX', ttl);
  return data;
}
```

---

#### 8.1.2 ç¼“å­˜é¢„çƒ­

**å¯åŠ¨æ—¶åŠ è½½å¸¸ç”¨æ•°æ®**ï¼š
```javascript
async function warmupCache() {
  // åŠ è½½æ‰€æœ‰æœºå™¨äºº
  const robots = await getActiveRobots();
  for (const robot of robots) {
    await cache.set(`cache:robot:${robot.robotId}`, JSON.stringify(robot), 'EX', 3600);
  }
  
  // åŠ è½½æ‰€æœ‰å‘Šè­¦è§„åˆ™
  const alertRules = await getActiveAlertRules();
  for (const rule of alertRules) {
    await cache.set(`cache:alert:${rule.id}`, JSON.stringify(rule), 'EX', 1800);
  }
  
  console.log('Cache warmed up');
}
```

---

### 8.2 æ•°æ®åº“ä¼˜åŒ–

#### 8.2.1 ç´¢å¼•ä¼˜åŒ–

**v2.0æ–°å¢ç´¢å¼•**ï¼š
```sql
-- session_messages
CREATE INDEX idx_session_messages_session_created ON session_messages(session_id, created_at);
CREATE INDEX idx_session_messages_robot_created ON session_messages(robot_id, created_at);
CREATE INDEX idx_session_messages_intent_created ON session_messages(intent, created_at);

-- ai_io_logs
CREATE INDEX idx_ai_io_logs_message_id ON ai_io_logs(message_id);
CREATE INDEX idx_ai_io_logs_operation_created ON ai_io_logs(operation_type, created_at);

-- alert_history
CREATE INDEX idx_alert_history_created_level ON alert_history(created_at, alert_level);

-- robotCommands
CREATE INDEX idx_robot_commands_status_created ON robotCommands(status, created_at);
```

#### 8.2.2 æŸ¥è¯¢ä¼˜åŒ–

**é¿å…N+1æŸ¥è¯¢**ï¼š
```javascript
// âŒ é”™è¯¯ï¼šN+1æŸ¥è¯¢
const messages = await db.select().from(session_messages);
for (const msg of messages) {
  const aiLog = await db.select().from(ai_io_logs).where(eq(ai_io_logs.messageId, msg.messageId));
  // ...
}

// âœ… æ­£ç¡®ï¼šä½¿ç”¨JOIN
const messages = await db
  .select()
  .from(session_messages)
  .leftJoin(ai_io_logs, eq(session_messages.messageId, ai_io_logs.messageId));
```

**åˆ†é¡µæŸ¥è¯¢**ï¼š
```javascript
const page = 1;
const limit = 50;
const offset = (page - 1) * limit;

const messages = await db
  .select()
  .from(session_messages)
  .orderBy(desc(session_messages.createdAt))
  .limit(limit)
  .offset(offset);
```

---

### 8.3 AIè¯·æ±‚ä¼˜åŒ–

#### 8.3.1 ç»“æœç¼“å­˜

```javascript
async function recognizeIntentWithCache(messageContext) {
  const contentHash = crypto.createHash('md5').update(messageContext.messageContent).digest('hex');
  const cacheKey = `cache:ai:intent:${contentHash}`;
  
  // æ£€æŸ¥ç¼“å­˜
  const cached = await redis.get(cacheKey);
  if (cached) {
    console.log('AI intent cache hit');
    return JSON.parse(cached);
  }
  
  // è°ƒç”¨AI
  const result = await callAI(messageContext);
  
  // ç¼“å­˜ç»“æœï¼ˆ10åˆ†é’Ÿï¼‰
  await redis.set(cacheKey, JSON.stringify(result), 'EX', 600);
  
  return result;
}
```

#### 8.3.2 æ‰¹é‡å¤„ç†

```javascript
// æ‰¹é‡è¯†åˆ«æ„å›¾
async function batchRecognizeIntents(messages) {
  const results = await Promise.allSettled(
    messages.map(msg => recognizeIntentWithCache(msg))
  );
  
  return results.map((result, index) => ({
    messageId: messages[index].messageId,
    success: result.status === 'fulfilled',
    result: result.status === 'fulfilled' ? result.value : null,
    error: result.status === 'rejected' ? result.reason : null
  }));
}
```

---

### 8.4 WebSocketä¼˜åŒ–

#### 8.4.1 å¿ƒè·³æœºåˆ¶

```javascript
// å®¢æˆ·ç«¯
setInterval(() => {
  if (ws.readyState === WebSocket.OPEN) {
    ws.send(JSON.stringify({ type: 'ping' }));
  }
}, 30000);

// æœåŠ¡ç«¯
ws.on('message', (data) => {
  const message = JSON.parse(data);
  if (message.type === 'ping') {
    ws.send(JSON.stringify({ type: 'pong' }));
  }
});
```

#### 8.4.2 è‡ªåŠ¨é‡è¿

```javascript
// å®¢æˆ·ç«¯è‡ªåŠ¨é‡è¿
class WebSocketManager {
  constructor(url) {
    this.url = url;
    this.ws = null;
    this.reconnectAttempts = 0;
    this.maxReconnectAttempts = 5;
    this.reconnectDelay = 1000;
  }
  
  connect() {
    this.ws = new WebSocket(this.url);
    
    this.ws.onopen = () => {
      console.log('WebSocket connected');
      this.reconnectAttempts = 0;
      this.reconnectDelay = 1000;
    };
    
    this.ws.onclose = () => {
      console.log('WebSocket disconnected');
      this.reconnect();
    };
    
    this.ws.onerror = (error) => {
      console.error('WebSocket error:', error);
    };
  }
  
  reconnect() {
    if (this.reconnectAttempts >= this.maxReconnectAttempts) {
      console.error('Max reconnection attempts reached');
      return;
    }
    
    this.reconnectAttempts++;
    
    setTimeout(() => {
      console.log(`Reconnecting... (attempt ${this.reconnectAttempts})`);
      this.connect();
    }, this.reconnectDelay);
    
    // æŒ‡æ•°é€€é¿
    this.reconnectDelay *= 2;
  }
}
```

---

## 9. APIæ¥å£è®¾è®¡

### 9.1 è®¤è¯æˆæƒAPIï¼ˆNEW in v2.0ï¼‰

#### 9.1.1 ç™»å½•

**æ¥å£**ï¼š`POST /api/auth/login`

**è¯·æ±‚ä½“**ï¼š
```json
{
  "username": "admin",
  "password": "password"
}
```

**å“åº”**ï¼š
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "user": {
      "id": "user_001",
      "username": "admin",
      "email": "admin@example.com",
      "role": "admin"
    }
  }
}
```

---

#### 9.1.2 åˆ·æ–°Token

**æ¥å£**ï¼š`POST /api/auth/refresh`

**è¯·æ±‚å¤´**ï¼š
```
Cookie: refreshToken=xxx
```

**å“åº”**ï¼š
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
  }
}
```

---

#### 9.1.3 ç™»å‡º

**æ¥å£**ï¼š`POST /api/auth/logout`

**è¯·æ±‚å¤´**ï¼š
```
Authorization: Bearer {token}
```

**å“åº”**ï¼š
```json
{
  "code": 0,
  "message": "success"
}
```

---

### 9.2 Webhookæ¥å£

#### 9.2.1 æ¶ˆæ¯å›è°ƒ

**æ¥å£**ï¼š`POST /api/worktool/callback/message`

**è¯·æ±‚å‚æ•°**ï¼š
- Query: `robotId` (æœºå™¨äººID)

**è¯·æ±‚ä½“**ï¼š
```json
{
  "spoken": "å¸®æˆ‘æŸ¥è®¢å•",
  "rawSpoken": "å¸®æˆ‘æŸ¥è®¢å•",
  "receivedName": "å¼ ä¸‰",
  "groupName": "å®¢æœç¾¤",
  "roomType": 1,
  "atMe": false,
  "textType": 1
}
```

**å“åº”**ï¼š
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "messageId": "msg_xxx",
    "sessionId": "session_xxx"
  }
}
```

---

#### 9.2.2 æ‰§è¡Œç»“æœå›è°ƒ

**æ¥å£**ï¼š`POST /api/worktool/callback/result`

**è¯·æ±‚å‚æ•°**ï¼š
- Query: `robotId` (æœºå™¨äººID)

**è¯·æ±‚ä½“**ï¼š
```json
{
  "robotId": "robot_xxx",
  "messageId": "cmd_xxx",
  "callbackType": 1,
  "errorCode": 0,
  "errorReason": "success",
  "runTime": 1234567890,
  "timeCost": 1000,
  "commandType": 203,
  "rawMsg": "...",
  "extraData": {...}
}
```

**å“åº”**ï¼š
```json
{
  "code": 0,
  "message": "success"
}
```

---

### 9.3 ç›‘æ§æŸ¥è¯¢APIï¼ˆNEW in v2.0ï¼‰

#### 9.3.1 æŸ¥è¯¢ä¸šåŠ¡æ¶ˆæ¯åˆ—è¡¨

**æ¥å£**ï¼š`GET /api/monitor/business/messages`

**è¯·æ±‚å‚æ•°**ï¼š
```json
{
  "robotId": "robot_123",
  "userName": "å¼ ä¸‰",
  "groupName": "å®¢æœç¾¤",
  "timeRange": "24h",
  "status": "all",
  "limit": 100,
  "offset": 0
}
```

**å“åº”**ï¼š
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "total": 156,
    "list": [
      {
        "messageId": "msg_xxx",
        "sessionId": "session_xxx",
        "timestamp": 1234567890,
        "userMessage": {...},
        "botReply": {...},
        "deliveryStatus": {...},
        "robot": {...}
      }
    ]
  }
}
```

---

#### 9.3.2 æŸ¥è¯¢AIäº¤äº’è¯¦æƒ…

**æ¥å£**ï¼š`GET /api/monitor/ai/details/:messageId`

**å“åº”**ï¼š
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "messageId": "msg_xxx",
    "sessionId": "session_xxx",
    "stage1_receive": {...},
    "stage2_intent": {...},
    "stage3_decision": {...},
    "stage4_service": {...},
    "stage5_command": {...},
    "stage6_callback": {...},
    "performance": {...}
  }
}
```

---

## 10. éƒ¨ç½²æ¶æ„

### 10.1 ç«¯å£åˆ†é…

| æœåŠ¡ | ç«¯å£ | è¯´æ˜ |
|------|------|------|
| å‰ç«¯ | 5000 | Next.jså¼€å‘æœåŠ¡å™¨ |
| åç«¯ | 5001 | Fastify APIæœåŠ¡å™¨ |
| ç³»ç»ŸæœåŠ¡ | 9000 | å†…ç½®æœåŠ¡ï¼ˆç¦æ­¢ä½¿ç”¨ï¼‰ |

### 10.2 ç¯å¢ƒé…ç½®

**ç¯å¢ƒå˜é‡**ï¼š
```bash
# æ•°æ®åº“é…ç½®
DATABASE_URL=postgresql://user:pass@localhost:5432/dbname

# Redisé…ç½®ï¼ˆv2.0å¼ºåˆ¶è¦æ±‚ï¼‰
REDIS_URL=redis://localhost:6379

# WorkToolå›è°ƒåœ°å€
CALLBACK_BASE_URL=https://your-domain.com

# AIæœåŠ¡é…ç½®
AI_API_KEY=your_api_key
AI_MODEL_INTENT=doubao-pro-4k
AI_MODEL_SERVICE=doubao-pro-32k

# JWTé…ç½®ï¼ˆv2.0æ–°å¢ï¼‰
JWT_SECRET=your_jwt_secret
JWT_ACCESS_EXPIRY=24h
JWT_REFRESH_EXPIRY=7d

# å‰ç«¯é…ç½®
NEXT_PUBLIC_API_URL=https://api.your-domain.com
NEXT_PUBLIC_WS_URL=wss://api.your-domain.com
```

---

### 10.3 å¯åŠ¨è„šæœ¬

**å‰ç«¯**ï¼š
```bash
# å¼€å‘æ¨¡å¼
pnpm dev

# æ„å»ºç”Ÿäº§ç‰ˆæœ¬
pnpm build

# å¯åŠ¨ç”Ÿäº§ç¯å¢ƒ
pnpm start
```

**åç«¯**ï¼š
```bash
# å¼€å‘æ¨¡å¼
pnpm --filter server run dev

# æ„å»ºç”Ÿäº§ç‰ˆæœ¬
pnpm --filter server run build

# å¯åŠ¨ç”Ÿäº§ç¯å¢ƒ
pnpm --filter server run start
```

---

## 11. å¼€å‘è§„èŒƒ

### 11.1 ä»£ç è§„èŒƒ

**TypeScriptè§„èŒƒ**ï¼š
- ä½¿ç”¨ä¸¥æ ¼æ¨¡å¼ï¼ˆstrict: trueï¼‰
- å®Œæ•´çš„ç±»å‹å®šä¹‰
- é¿å…ä½¿ç”¨anyç±»å‹
- ä½¿ç”¨æ¥å£è€Œéç±»å‹åˆ«å

**å‘½åè§„èŒƒ**ï¼š
- æ–‡ä»¶åï¼škebab-caseï¼ˆå¦‚ message-processing.service.tsï¼‰
- å˜é‡åï¼šcamelCaseï¼ˆå¦‚ messageIdï¼‰
- å¸¸é‡åï¼šUPPER_SNAKE_CASEï¼ˆå¦‚ MAX_RETRIESï¼‰
- ç±»åï¼šPascalCaseï¼ˆå¦‚ MessageServiceï¼‰

**Gitè§„èŒƒ**ï¼š
```
feat: æ–°åŠŸèƒ½
fix: ä¿®å¤bug
refactor: é‡æ„
docs: æ–‡æ¡£
chore: æ„å»º/å·¥å…·
test: æµ‹è¯•
perf: æ€§èƒ½ä¼˜åŒ–
security: å®‰å…¨ä¿®å¤
```

---

### 11.2 æµ‹è¯•è§„èŒƒ

**å•å…ƒæµ‹è¯•**ï¼š
- æ‰€æœ‰å·¥å…·å‡½æ•°å¿…é¡»æœ‰å•å…ƒæµ‹è¯•
- è¦†ç›–ç‡è¦æ±‚ï¼š>80%
- ä½¿ç”¨Jestæ¡†æ¶

**é›†æˆæµ‹è¯•**ï¼š
- APIæ¥å£å¿…é¡»æœ‰é›†æˆæµ‹è¯•
- æ•°æ®åº“æ“ä½œå¿…é¡»æœ‰é›†æˆæµ‹è¯•
- WebSocketè¿æ¥å¿…é¡»æœ‰é›†æˆæµ‹è¯•

---

## 12. è¿ç»´ç›‘æ§

### 12.1 å¥åº·æ£€æŸ¥

**æ¥å£**ï¼š`GET /health`

**å“åº”**ï¼š
```json
{
  "status": "ok",
  "version": "2.0.0",
  "timestamp": 1234567890,
  "checks": {
    "database": "ok",
    "redis": "ok",
    "worktool_api": "ok",
    "ai_service": "ok"
  }
}
```

---

### 12.2 ç›‘æ§æŒ‡æ ‡

**ä¸šåŠ¡æŒ‡æ ‡**ï¼š
- æ´»è·ƒä¼šè¯æ•°
- ä»Šæ—¥æ¶ˆæ¯æ•°
- å‘Šè­¦è§¦å‘æ¬¡æ•°
- æœºå™¨äººçŠ¶æ€

**æ€§èƒ½æŒ‡æ ‡**ï¼š
- APIå“åº”æ—¶é—´ï¼ˆP50, P95, P99ï¼‰
- æ•°æ®åº“æŸ¥è¯¢æ—¶é—´
- Rediså‘½ä¸­ç‡
- AIè°ƒç”¨æ¬¡æ•°

**ç³»ç»ŸæŒ‡æ ‡**ï¼š
- CPUä½¿ç”¨ç‡
- å†…å­˜ä½¿ç”¨ç‡
- ç£ç›˜I/O
- ç½‘ç»œæµé‡

---

### 12.3 æ—¥å¿—è§„èŒƒ

**æ—¥å¿—çº§åˆ«**ï¼š
- DEBUGï¼šè°ƒè¯•ä¿¡æ¯
- INFOï¼šä¸€èˆ¬ä¿¡æ¯
- WARNï¼šè­¦å‘Šä¿¡æ¯
- ERRORï¼šé”™è¯¯ä¿¡æ¯
- FATALï¼šè‡´å‘½é”™è¯¯

**æ—¥å¿—æ ¼å¼**ï¼š
```json
{
  "timestamp": "2025-01-04T10:30:00Z",
  "level": "INFO",
  "service": "message-processing",
  "message": "Message processed successfully",
  "context": {
    "messageId": "msg_xxx",
    "robotId": "robot_123"
  }
}
```

---

## 13. ç‰ˆæœ¬å‡çº§æ€»ç»“

### 13.1 v1.0 â†’ v2.0 ä¸»è¦å‡çº§ç‚¹

| ç±»åˆ« | å‡çº§é¡¹ | ä¼˜å…ˆçº§ | å½±å“ |
|------|--------|--------|------|
| **æ¶æ„** | å‰åç«¯å½»åº•åˆ†ç¦» | P1 | é™ä½å¤æ‚åº¦ |
| **æ¶æ„** | ç»Ÿä¸€çŠ¶æ€ç®¡ç†ï¼ˆZustandï¼‰ | P1 | æé«˜å¯ç»´æŠ¤æ€§ |
| **æ¶æ„** | æ¶ˆæ¯é˜Ÿåˆ—å¼•å…¥ | P2 | æé«˜å¹¶å‘èƒ½åŠ› |
| **æ•°æ®åº“** | æŸ¥è¯¢ä¼˜åŒ–ï¼ˆæ–°å¢ç´¢å¼•ï¼‰ | P0 | æå‡æ€§èƒ½ |
| **æ•°æ®åº“** | Rediså¼ºåˆ¶ä½¿ç”¨ | P1 | ä¿è¯ä¸€è‡´æ€§ |
| **æ•°æ®åº“** | å®Œæ•´çš„æ•°æ®è®°å½• | P1 | æé«˜å¯è¿½æº¯æ€§ |
| **å®‰å…¨** | JWTè®¤è¯ | P0 | æé«˜å®‰å…¨æ€§ |
| **å®‰å…¨** | RBACæƒé™æ¨¡å‹ | P0 | ç»†ç²’åº¦æ§åˆ¶ |
| **å®‰å…¨** | å®¡è®¡æ—¥å¿— | P1 | æ“ä½œè¿½è¸ª |
| **å®‰å…¨** | å¯†ç åŠ å¯†ï¼ˆbcryptï¼‰ | P0 | æ•°æ®å®‰å…¨ |
| **æ€§èƒ½** | AIç»“æœç¼“å­˜ | P1 | é™ä½æˆæœ¬ |
| **æ€§èƒ½** | æ‰¹é‡å¤„ç† | P1 | æé«˜æ•ˆç‡ |
| **æ€§èƒ½** | WebSocketä¼˜åŒ– | P2 | æé«˜ç¨³å®šæ€§ |
| **ä»£ç ** | å®Œæ•´ç±»å‹å®šä¹‰ | P1 | æé«˜å®‰å…¨æ€§ |
| **ä»£ç ** | å•å…ƒæµ‹è¯• | P1 | ä¿è¯è´¨é‡ |
| **åŠŸèƒ½** | èŠ‚ç‚¹æµç¨‹å¼•æ“ | P0 | å¯è§†åŒ–ç¼–æ’ |
| **åŠŸèƒ½** | åŒç›‘æ§é¢æ¿ | P1 | å®æ—¶ç›‘æ§ |
| **åŠŸèƒ½** | å…¨é“¾è·¯æ•°æ®è¿½è¸ª | P1 | å®Œæ•´è¿½è¸ª |

---

### 13.2 æ ¸å¿ƒç›®æ ‡è¾¾æˆ

âœ… **ç»Ÿä¸€æ€§**ï¼š
- ç»Ÿä¸€çš„æ¶ˆæ¯æ ¼å¼
- ç»Ÿä¸€çš„çŠ¶æ€ç®¡ç†
- ç»Ÿä¸€çš„APIè®¾è®¡
- ç»Ÿä¸€çš„é”™è¯¯å¤„ç†

âœ… **å¯è¿½æº¯æ€§**ï¼š
- messageIdå…¨é“¾è·¯è¿½è¸ª
- å®Œæ•´çš„AIäº¤äº’è®°å½•
- æŒ‡ä»¤çŠ¶æ€è¿½è¸ª
- å®¡è®¡æ—¥å¿—

âœ… **ç¨³å®šæ€§**ï¼š
- Rediså¼ºåˆ¶ä½¿ç”¨
- å®Œå–„çš„é”™è¯¯å¤„ç†
- WebSocketè‡ªåŠ¨é‡è¿
- æ¶ˆæ¯é˜Ÿåˆ—è§£è€¦

âœ… **å¯ç»´æŠ¤æ€§**ï¼š
- å‰åç«¯åˆ†ç¦»
- å®Œæ•´çš„ç±»å‹å®šä¹‰
- å•å…ƒæµ‹è¯•è¦†ç›–
- ä»£ç è§„èŒƒç»Ÿä¸€

---

## é™„å½•

### A. ç¯å¢ƒå˜é‡é…ç½®ï¼ˆå®Œæ•´ç‰ˆï¼‰

```bash
# ===== æ•°æ®åº“é…ç½® =====
DATABASE_URL=postgresql://user:pass@localhost:5432/worktool_ai
DATABASE_POOL_MIN=2
DATABASE_POOL_MAX=10

# ===== Redisé…ç½®ï¼ˆv2.0å¼ºåˆ¶è¦æ±‚ï¼‰ =====
REDIS_URL=redis://localhost:6379
REDIS_PASSWORD=
REDIS_DB=0

# ===== WorkToolé…ç½® =====
WORKTOOL_CALLBACK_BASE_URL=https://your-domain.com
WORKTOOL_SIGNATURE_SECRET=your_secret

# ===== AIæœåŠ¡é…ç½® =====
AI_API_KEY=your_api_key
AI_API_BASE_URL=https://api.example.com
AI_MODEL_INTENT=doubao-pro-4k
AI_MODEL_SERVICE=doubao-pro-32k
AI_TEMPERATURE=0.7

# ===== JWTé…ç½®ï¼ˆv2.0æ–°å¢ï¼‰ =====
JWT_SECRET=your_jwt_secret_change_this
JWT_ACCESS_EXPIRY=24h
JWT_REFRESH_EXPIRY=7d

# ===== å‰ç«¯é…ç½® =====
NEXT_PUBLIC_API_URL=https://api.your-domain.com
NEXT_PUBLIC_WS_URL=wss://api.your-domain.com

# ===== CORSé…ç½® =====
CORS_ORIGIN=https://your-domain.com
CORS_CREDENTIALS=true

# ===== æ—¥å¿—é…ç½® =====
LOG_LEVEL=INFO
LOG_FORMAT=json

# ===== é™æµé…ç½® =====
RATE_LIMIT_MAX=100
RATE_LIMIT_WINDOW=60000
```

---

### B. æ•°æ®åº“è¿ç§»è„šæœ¬

**æ–°å¢è¡¨ï¼ˆv2.0ï¼‰**ï¼š
```sql
-- ç”¨æˆ·è¡¨
CREATE TABLE users (
  id varchar(36) PRIMARY KEY DEFAULT gen_random_uuid(),
  username varchar(64) NOT NULL UNIQUE,
  email varchar(255) UNIQUE,
  password text NOT NULL,
  role varchar(20) NOT NULL DEFAULT 'viewer',
  isActive boolean NOT NULL DEFAULT true,
  lastLoginAt timestamp with time zone,
  createdAt timestamp with time zone NOT NULL DEFAULT NOW(),
  updatedAt timestamp with time zone
);

CREATE INDEX idx_users_username ON users(username);
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_role ON users(role);

-- è§’è‰²è¡¨
CREATE TABLE roles (
  id varchar(36) PRIMARY KEY DEFAULT gen_random_uuid(),
  name varchar(50) NOT NULL UNIQUE,
  description text,
  createdAt timestamp with time zone NOT NULL DEFAULT NOW(),
  updatedAt timestamp with time zone
);

-- æƒé™è¡¨
CREATE TABLE permissions (
  id varchar(36) PRIMARY KEY DEFAULT gen_random_uuid(),
  name varchar(50) NOT NULL UNIQUE,
  resource varchar(50) NOT NULL,
  action varchar(50) NOT NULL,
  description text,
  createdAt timestamp with time zone NOT NULL DEFAULT NOW()
);

-- ç”¨æˆ·è§’è‰²å…³è”è¡¨
CREATE TABLE user_roles (
  userId varchar(36) NOT NULL,
  roleId varchar(36) NOT NULL,
  createdAt timestamp with time zone NOT NULL DEFAULT NOW(),
  PRIMARY KEY (userId, roleId),
  FOREIGN KEY (userId) REFERENCES users(id) ON DELETE CASCADE,
  FOREIGN KEY (roleId) REFERENCES roles(id) ON DELETE CASCADE
);

CREATE INDEX idx_user_roles_userId ON user_roles(userId);
CREATE INDEX idx_user_roles_roleId ON user_roles(roleId);

-- è§’è‰²æƒé™å…³è”è¡¨
CREATE TABLE role_permissions (
  roleId varchar(36) NOT NULL,
  permissionId varchar(36) NOT NULL,
  createdAt timestamp with time zone NOT NULL DEFAULT NOW(),
  PRIMARY KEY (roleId, permissionId),
  FOREIGN KEY (roleId) REFERENCES roles(id) ON DELETE CASCADE,
  FOREIGN KEY (permissionId) REFERENCES permissions(id) ON DELETE CASCADE
);

CREATE INDEX idx_role_permissions_roleId ON role_permissions(roleId);
CREATE INDEX idx_role_permissions_permissionId ON role_permissions(permissionId);

-- å®¡è®¡æ—¥å¿—è¡¨
CREATE TABLE audit_logs (
  id varchar(36) PRIMARY KEY DEFAULT gen_random_uuid(),
  userId varchar(36),
  action varchar(50) NOT NULL,
  resource varchar(50) NOT NULL,
  resourceId varchar(255),
  details jsonb,
  ipAddress varchar(45),
  userAgent text,
  createdAt timestamp with time zone NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_audit_logs_userId ON audit_logs(userId);
CREATE INDEX idx_audit_logs_action ON audit_logs(action);
CREATE INDEX idx_audit_logs_createdAt ON audit_logs(createdAt);
```

**æ–°å¢ç´¢å¼•ï¼ˆv2.0ï¼‰**ï¼š
```sql
-- session_messages
CREATE INDEX idx_session_messages_session_created ON session_messages(session_id, created_at);
CREATE INDEX idx_session_messages_robot_created ON session_messages(robot_id, created_at);
CREATE INDEX idx_session_messages_intent_created ON session_messages(intent, created_at);

-- ai_io_logs
CREATE INDEX idx_ai_io_logs_message_id ON ai_io_logs(message_id);
CREATE INDEX idx_ai_io_logs_operation_created ON ai_io_logs(operation_type, created_at);

-- alert_history
CREATE INDEX idx_alert_history_created_level ON alert_history(created_at, alert_level);

-- robotCommands
CREATE INDEX idx_robot_commands_status_created ON robotCommands(status, created_at);
```

---

### C. å¸¸ç”¨å‘½ä»¤

**å¼€å‘æ¨¡å¼**ï¼š
```bash
# å‰ç«¯å¼€å‘
pnpm dev

# åç«¯å¼€å‘
pnpm --filter server run dev

# åŒæ—¶å¯åŠ¨å‰åç«¯
pnpm dev
```

**æ„å»º**ï¼š
```bash
# å‰ç«¯æ„å»º
pnpm build

# åç«¯æ„å»º
pnpm --filter server run build

# å…¨éƒ¨æ„å»º
pnpm build
```

**ç”Ÿäº§æ¨¡å¼**ï¼š
```bash
# å‰ç«¯ç”Ÿäº§
pnpm start

# åç«¯ç”Ÿäº§
pnpm --filter server run start
```

**ç±»å‹æ£€æŸ¥**ï¼š
```bash
# å‰ç«¯ç±»å‹æ£€æŸ¥
pnpm tsc --noEmit

# åç«¯ç±»å‹æ£€æŸ¥
pnpm --filter server run tsc --noEmit
```

**æµ‹è¯•**ï¼š
```bash
# è¿è¡Œæµ‹è¯•
pnpm test

# æµ‹è¯•è¦†ç›–ç‡
pnpm test:coverage
```

**æ•°æ®åº“è¿ç§»**ï¼š
```bash
# ç”Ÿæˆè¿ç§»æ–‡ä»¶
pnpm drizzle-kit generate

# æ‰§è¡Œè¿ç§»
pnpm drizzle-kit migrate

# æ¨é€schema
pnpm drizzle-kit push
```

---

### D. æ•…éšœæ’æŸ¥

**é—®é¢˜1ï¼šRedisè¿æ¥å¤±è´¥**

**ç°è±¡**ï¼šç³»ç»Ÿå¯åŠ¨æ—¶æŠ¥é”™"Redis connection failed"

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# æ£€æŸ¥Redisæ˜¯å¦è¿è¡Œ
redis-cli ping

# æ£€æŸ¥Redisé…ç½®
cat .env | grep REDIS_URL

# é‡å¯Redis
systemctl restart redis
```

**é—®é¢˜2ï¼šæ•°æ®åº“è¿æ¥è¶…æ—¶**

**ç°è±¡**ï¼šAPIå“åº”æ…¢ï¼Œæ—¥å¿—æ˜¾ç¤º"Database timeout"

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# æ£€æŸ¥æ•°æ®åº“è¿æ¥æ•°
psql -U user -d dbname -c "SELECT count(*) FROM pg_stat_activity;"

# æ£€æŸ¥æ…¢æŸ¥è¯¢
psql -U user -d dbname -c "SELECT * FROM pg_stat_statements ORDER BY total_time DESC LIMIT 10;"

# å¢åŠ è¿æ¥æ± å¤§å°
DATABASE_POOL_MIN=5
DATABASE_POOL_MAX=20
```

**é—®é¢˜3ï¼šWebSocketè¿æ¥ä¸ç¨³å®š**

**ç°è±¡**ï¼šç›‘æ§é¢æ¿é¢‘ç¹æ–­çº¿

**è§£å†³æ–¹æ¡ˆ**ï¼š
- æ£€æŸ¥ç½‘ç»œè¿æ¥
- å¢åŠ å¿ƒè·³é—´éš”
- æ£€æŸ¥é˜²ç«å¢™è®¾ç½®
- ä½¿ç”¨HTTPSåè®®

---

### E. æ€§èƒ½åŸºå‡†

**é¢„æœŸæ€§èƒ½æŒ‡æ ‡**ï¼š

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | å¤‡æ³¨ |
|------|--------|------|
| APIå“åº”æ—¶é—´ | <200ms | P95 |
| æ•°æ®åº“æŸ¥è¯¢æ—¶é—´ | <100ms | P95 |
| Rediså‘½ä¸­ç‡ | >90% | çƒ­ç‚¹æ•°æ® |
| AIå“åº”æ—¶é—´ | <3000ms | P95 |
| WebSocketè¿æ¥ç¨³å®šæ€§ | >99% | 24å°æ—¶ |

---

**æ–‡æ¡£ç»“æŸ**

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv2.0  
**æœ€åæ›´æ–°**ï¼š2025-01-04  
**ç»´æŠ¤è€…**ï¼šWorkTool AI å¼€å‘å›¢é˜Ÿ
