# 话术模板联动关系图

## 1. 系统架构概览

```
┌─────────────────────────────────────────────────────────────────┐
│                     WorkTool AI 2.1 平台                        │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                     消息处理主流程                              │
└─────────────────────────────────────────────────────────────────┘
                              ↓
         ┌────────────────────┼────────────────────┐
         ↓                    ↓                    ↓
   ┌──────────┐        ┌──────────┐        ┌──────────┐
   │意图识别  │        │ 告警触发 │        │ 决策逻辑 │
   │          │        │          │        │          │
   │intentRec │        │ alertTrig │        │makeDecis │
   └────┬─────┘        └────┬─────┘        └────┬─────┘
        ↓                   ↓                   ↓
   [提示词1]           [可选]               [提示词2/3/4]
```

---

## 2. 话术模板与各板块的详细联动

### 2.1 消息处理流程

```
用户发送消息
    ↓
┌──────────────────────────────────────┐
│  WorkRobot 消息回调                  │
│  (robot/messageCallbackUrl)          │
└──────────────┬───────────────────────┘
               ↓
┌──────────────────────────────────────┐
│  消息处理服务 (message-processing)   │
│  - 解析消息内容                      │
│  - 获取/创建会话                     │
│  - 保存用户消息                      │
└──────────────┬───────────────────────┘
               ↓
┌──────────────────────────────────────┐
│  意图识别 (ai.service)               │
│  [使用提示词1]                       │
│  - intentRecognition提示词           │
└──────────────┬───────────────────────┘
               ↓
         返回意图类型
   (chat/service/help/risk/spam/...)
               ↓
┌──────────────────────────────────────┐
│  告警触发检查 (alert-trigger)        │
│  - 根据意图类型判断是否告警         │
└──────────────┬───────────────────────┘
               ↓
┌──────────────────────────────────────┐
│  决策逻辑 (makeDecision)             │
│  - 根据意图决定是否回复             │
│  - 根据意图选择回复策略             │
└──────────────┬───────────────────────┘
               ↓
    ┌──────────┼──────────┐
    ↓          ↓          ↓
  情况A      情况B       情况C
  (risk)     (spam)     (常规)
    ↓          ↓          ↓
[提示词3]   [提示词4]   [提示词2]
 风险提示   垃圾提示   服务提示
    ↓          ↓          ↓
  生成回复    生成回复    生成回复
    ↓          ↓          ↓
  发送回复    发送回复    发送回复
```

---

### 2.2 话术模板类型与使用场景

```
┌─────────────────────────────────────────────────────────────┐
│                    话术模板类型                               │
└─────────────────────────────────────────────────────────────┘
                          ↓
    ┌─────────────────────┼─────────────────────┐
    ↓                     ↓                     ↓
┌──────────┐        ┌──────────┐        ┌──────────┐
│提示词1   │        │提示词2   │        │提示词5   │
│意图识别  │        │服务回复  │        │转化客服  │
└────┬─────┘        └────┬─────┘        └────┬─────┘
     │                   │                   │
     ↓                   ↓                   ↓
  intentRec        serviceReply         conversion
     │                   │                   │
     ↓                   ↓                   ↓
识别7种意图      根据意图调整          引导转化
chat/service    回复风格               购买/表单
help/risk/      专业/友好              活动/咨询
spam/welcome/   简洁明了              热情专业
admin
     │                   │                   │
     └───────────────────┼───────────────────┘
                         ↓
                    ┌──────────┐
                    │提示词6   │
                    │报告生成  │
                    └────┬─────┘
                         │
                         ↓
                     日终总结
                     数据分析
                     趋势总结

    ┌─────────────────────┴─────────────────────┐
    ↓                                           ↓
┌──────────┐                                ┌──────────┐
│提示词3   │                                │提示词4   │
│风险处理  │                                │垃圾处理  │
└────┬─────┘                                └────┬─────┘
     │                                           │
     ↓                                           ↓
   risk                                        spam
     │                                           │
     ↓                                           ↓
严肃提醒                                      温和提醒
社群规则                                      社群价值
转人工处理                                    引导交流
     │                                           │
     └───────────────────┬───────────────────────┘
                         ↓
                  硬编码在
          message-processing.service.js
```

---

### 2.3 数据库表关系

```
┌──────────────────────────────────────────────────────────────┐
│                      数据库表关系                             │
└──────────────────────────────────────────────────────────────┘
                              ↓
                    ┌─────────────────┐
                    │   ai_models     │
                    │   (AI模型配置)  │
                    └────────┬────────┘
                             │ modelId
                             ↓
                    ┌─────────────────┐
                    │   ai_roles      │
                    │   (AI角色配置)  │
                    └────────┬────────┘
                             │
          ┌──────────────────┼──────────────────┐
          ↓                  ↓                  ↓
    ┌──────────┐      ┌──────────┐      ┌──────────┐
    │systemPro │      │promptTem │      │ modelId  │
    │mpt字段   │      │plateId   │      │          │
    │(未使用)  │      │(未使用)  │      │(使用中)  │
    └──────────┘      └────┬─────┘      └──────────┘
                             │
                             ↓
                    ┌─────────────────┐
                    │ prompt_templates│
                    │ (Prompt模板)    │
                    │ (未使用)        │
                    └────────┬────────┘
                             │
                             ↓
                    ┌─────────────────┐
                    │ prompt_tests    │
                    │ (测试记录)      │
                    │ (未使用)        │
                    └─────────────────┘

                    ┌─────────────────┐
                    │prompt_category_ │
                    │templates       │
                    │(话术分类模板)  │
                    │(未使用)        │
                    └─────────────────┘
```

---

### 2.4 当前实现 vs 预留功能

```
┌──────────────────────────────────────────────────────────────┐
│                  当前实现 vs 预留功能                          │
└──────────────────────────────────────────────────────────────┘

当前使用（硬编码配置文件）                    预留功能（数据库表）
┌─────────────────────────────┐      ┌──────────────────────────────┐
│ default-prompts.js          │      │ prompt_templates 表          │
│                             │      │                              │
│ - intentRecognition         │      │ - intentRecognition          │
│ - serviceReply              │      │ - serviceReply               │
│ - conversion                │      │ - report                     │
│ - report                    │      │                              │
│                             │      │ - 支持自定义                  │
│ ❌ 无法动态修改             │      │ ✅ 可通过UI修改               │
│ ❌ 需要重启服务             │      │ ✅ 实时生效                   │
│ ✅ 简单直接                 │      │ ⚠️  需要实现逻辑              │
└─────────────────────────────┘      └──────────────────────────────┘

硬编码提示词（代码中）                      数据库表
┌─────────────────────────────┐      ┌──────────────────────────────┐
│ message-processing.js       │      │ prompt_category_templates   │
│                             │      │                              │
│ - conversion提示词          │      │ - general                    │
│ - risk提示词                │      │ - after_sales                │
│ - spam提示词                │      │ - faq                        │
│                             │      │ - chatbot                    │
│ ❌ 代码耦合                 │      │ - welcome                    │
│ ❌ 修改需要重新部署         │      │                              │
│ ✅ 实现简单                 │      │ ✅ 24类场景支持              │
└─────────────────────────────┘      │ ❌ 未被使用                  │
                                    └──────────────────────────────┘

AI角色提示词
┌─────────────────────────────┐      ┌──────────────────────────────┐
│ ai_roles.system_prompt      │      │ (预留关联)                   │
│                             │      │                              │
│ ❌ 未被使用                 │      │ ✅ 可实现角色个性化           │
│ ❌ 无法实现个性化           │      │ ✅ 不同角色不同话术          │
└─────────────────────────────┘      └──────────────────────────────┘
```

---

### 2.5 意图类型与回复策略映射

```
┌──────────────────────────────────────────────────────────────┐
│              意图类型与回复策略映射表                          │
└──────────────────────────────────────────────────────────────┘

意图类型    是否回复    回复策略          提示词类型           模型
──────────────────────────────────────────────────────────────
chat        ✅ 是      闲聊风格          serviceReply         豆包
service     ✅ 是      服务咨询风格      serviceReply         豆包
help        ✅ 是      帮助请求风格      serviceReply         豆包
risk        ❌ 否      风险提示+转人工    risk (硬编码)        豆包
spam        ❌ 否      社群规矩回复        spam (硬编码)        豆包
welcome     ✅ 是      欢迎风格          serviceReply         豆包
admin       ❌ 否      转人工处理         -                   -

特殊场景：
──────────────────────────────────────────────────────────────
转化客服    ✅ 是      转化引导          conversion           DeepSeek
日终报告    ✅ 是      数据分析          report               Kimi
```

---

### 2.6 机器人模式与提示词选择

```
┌──────────────────────────────────────────────────────────────┐
│              机器人模式与提示词选择                            │
└──────────────────────────────────────────────────────────────┘

机器人配置
    ↓
┌──────────────────────────────────────┐
│ 检查机器人模式                       │
└──────────────────┬───────────────────┘
                   ↓
         ┌─────────┼─────────┐
         ↓         ↓         ↓
    转化模式    常规模式    其他模式
         ↓         ↓         ↓
  ┌──────────┐ ┌──────────┐ ┌──────────┐
  │conversion │ │根据意图  │ │默认处理  │
  │提示词     │ │选择策略  │ │          │
  └────┬─────┘ └────┬─────┘ └──────────┘
       │            │
       ↓            ↓
  DeepSeek模型   豆包模型
       │            │
       ↓            ↓
  引导转化       专业回复
  购买/表单      根据意图
  活动/咨询      调整风格

触发条件：
──────────────────────────────────────────────────────────────
转化模式：
  ✅ robot.conversionMode = true
  ✅ robot.robotGroup = '营销'
  ✅ robot.robotType = '角色'

常规模式：
  ✅ 其他所有情况
```

---

### 2.7 完整的消息处理流程图

```
┌──────────────────────────────────────────────────────────────┐
│                   完整的消息处理流程                          │
└──────────────────────────────────────────────────────────────┘

用户发送消息
    ↓
[1] WorkRobot 回调
    ↓
[2] 消息处理服务 (message-processing)
    ├─ 解析消息内容
    ├─ 获取/创建会话
    └─ 保存用户消息
    ↓
[3] 意图识别 (ai.service - recognizeIntent)
    ├─ 使用提示词1: intentRecognition
    ├─ 调用模型: 豆包
    └─ 返回: {intent, needReply, needHuman, confidence}
    ↓
[4] 告警触发检查 (alert-trigger)
    ├─ 根据意图类型判断
    ├─ risk → 触发告警
    ├─ spam → 触发告警
    └─ 其他 → 可选告警
    ↓
[5] 决策逻辑 (makeDecision)
    ├─ 检查机器人模式
    ├─ 转化模式 → 使用转化客服
    ├─ 常规模式 → 根据意图决策
    └─ 返回决策结果
    ↓
[6] 回复生成
    │
    ├─ [分支1] 转化客服
    │   ├─ 使用提示词5: conversion
    │   ├─ 调用模型: DeepSeek
    │   └─ 生成转化回复
    │
    ├─ [分支2] 风险内容
    │   ├─ 使用提示词3: risk (硬编码)
    │   ├─ 调用模型: 豆包
    │   └─ 生成风险回复 + 转人工
    │
    ├─ [分支3] 垃圾信息
    │   ├─ 使用提示词4: spam (硬编码)
    │   ├─ 调用模型: 豆包
    │   └─ 生成垃圾回复
    │
    └─ [分支4] 常规回复
        ├─ 使用提示词2: serviceReply
        ├─ 调用模型: 豆包
        └─ 根据意图调整风格
            ├─ service → 专业详细
            ├─ help → 清晰易懂
            ├─ welcome → 热情友好
            └─ chat → 轻松自然
    ↓
[7] 发送回复 (worktool-service)
    ├─ 发送到WorkRobot
    └─ 保存机器人消息
    ↓
[8] 更新会话状态
    ├─ 更新最后意图
    ├─ 更新回复计数
    └─ 更新活跃时间
    ↓
处理完成
```

---

### 2.8 话术模板管理界面

```
┌──────────────────────────────────────────────────────────────┐
│              话术模板管理界面 (AI模块)                        │
└──────────────────────────────────────────────────────────────┘

AI模块页面
    ↓
┌──────────────────────────────────────┐
│ Tabs List                             │
│ ┌────┬────┬────┬────┬────┐           │
│ │模型│角色│话术│测试│调试│           │
│ └────┴────┴────┴────┴────┘           │
└──────────────────┬───────────────────┘
                   ↓
            点击"话术"标签
                   ↓
┌──────────────────────────────────────┐
│ 话术模板管理                          │
│                                      │
│ [+ 添加模板]  [批量删除]             │
│                                      │
│ ┌────────────────────────────────┐  │
│ │ 分类 | 名称 | 优先级 | 操作     │  │
│ ├────────────────────────────────┤  │
│ │ 通用 | 温馨提示 |  5  | 编辑 |  │
│ │ 售后 | 售后通知 | 10  | 编辑 |  │
│ │ FAQ  | 知识库   |  8  | 编辑 |  │
│ │ 欢迎语| 温馨型  |  9  | 编辑 |  │
│ └────────────────────────────────┘  │
│                                      │
│ [模板详情预览]                        │
│                                      │
└──────────────────────────────────────┘
```

---

### 2.9 改进建议的实现方案

```
┌──────────────────────────────────────────────────────────────┐
│              改进建议：激活数据库话术模板                    │
└──────────────────────────────────────────────────────────────┘

当前实现
    ↓
硬编码提示词
    ↓
┌──────────────────────────────────────┐
│ 建议改进                            │
└──────────────────┬───────────────────┘
                   ↓
┌──────────────────────────────────────┐
│ 1. 修改 AI 服务初始化逻辑           │
│    - 从数据库加载提示词             │
│    - 支持角色级别的个性化           │
└──────────────────┬───────────────────┘
                   ↓
┌──────────────────────────────────────┐
│ 2. 实现提示词缓存机制               │
│    - Redis缓存                      │
│    - 热更新支持                     │
│    - 定期刷新                       │
└──────────────────┬───────────────────┘
                   ↓
┌──────────────────────────────────────┐
│ 3. 支持变量替换                     │
│    - {{userName}}                   │
│    - {{groupName}}                  │
│    - {{robotName}}                  │
└──────────────────┬───────────────────┘
                   ↓
┌──────────────────────────────────────┐
│ 4. 实现版本管理                     │
│    - 自动保存历史版本               │
│    - 支持版本回滚                   │
│    - 版本对比功能                   │
└──────────────────┬───────────────────┘
                   ↓
┌──────────────────────────────────────┐
│ 5. 支持A/B测试                      │
│    - 多版本提示词                   │
│    - 自动分配流量                   │
│    - 效果数据记录                   │
└──────────────────────────────────────┘
```

---

## 3. 总结

### 话术模板的核心作用

1. **统一回复风格** → 提高专业性
2. **提高回复质量** → 增强用户体验
3. **降低运营成本** → 减少人工干预
4. **支持快速迭代** → 灵活调整策略
5. **实现个性化** → 不同场景不同话术

### 需要调用话术模板的板块

1. ✅ **消息处理服务**：5种核心场景
2. ✅ **AI服务层**：4种提示词类型
3. ⚠️ **流程引擎**：待扩展支持
4. ✅ **AI模块界面**：管理UI已实现

### 当前状态

- ✅ 功能完整：支持所有核心场景
- ❌ 数据库未用：使用配置文件
- ⚠️ 个性化缺失：角色提示词未启用
- ⚠️ 版本管理缺失：虽有表但未实现
