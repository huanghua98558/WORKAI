# WorkTool AI 2.1 æµç¨‹å¼•æ“ - å®Œå–„ä¼˜åŒ–è®¾è®¡æ–¹æ¡ˆ

## ğŸ“‹ è®¾è®¡åŸåˆ™

### 1. ç»Ÿä¸€ä¸Šä¸‹æ–‡ä¼ é€’æœºåˆ¶
**é—®é¢˜**ï¼šå¦‚ä½•è¯†åˆ«æ˜¯å“ªä¸ªæœºå™¨äººå‘é€çš„æ¶ˆæ¯ï¼Ÿ
**è§£å†³æ–¹æ¡ˆ**ï¼šæ‰€æœ‰èŠ‚ç‚¹ä½¿ç”¨ç»Ÿä¸€çš„ä¸Šä¸‹æ–‡å¯¹è±¡ï¼ŒåŒ…å«å®Œæ•´çš„è¯†åˆ«ä¿¡æ¯ã€‚

### 2. å¹¶å‘å¤„ç†æœºåˆ¶
**é—®é¢˜**ï¼šåŒæ—¶é—´å¾ˆå¤šæ¶ˆæ¯æ€ä¹ˆå¤„ç†ï¼Ÿ
**è§£å†³æ–¹æ¡ˆ**ï¼š
- æ¶ˆæ¯é˜Ÿåˆ—å¼‚æ­¥å¤„ç†
- AIæ¨¡å‹æ”¯æŒå•æœºå™¨äººä¸“ç”¨æˆ–å¤šæœºå™¨äººå…±äº«
- æŒ‡ä»¤å‘é€æ”¯æŒå¼‚æ­¥å›è°ƒå’ŒçŠ¶æ€è¿½è¸ª

### 3. æ‰§è¡Œç»“æœéªŒè¯æœºåˆ¶
**é—®é¢˜**ï¼šæœºå™¨äººæ‰§è¡Œç»“æœæ€ä¹ˆè·å–ï¼Ÿ
**è§£å†³æ–¹æ¡ˆ**ï¼š
- åŸºäºæ–‡æ¡£æ¨æ–­ï¼šæœºå™¨äººä¼šå¼‚æ­¥å›è°ƒæ‰§è¡Œç»“æœ
- ä½¿ç”¨`robotCommands`è¡¨è®°å½•æŒ‡ä»¤çŠ¶æ€
- æ”¯æŒè½®è¯¢å’Œå›è°ƒä¸¤ç§æ–¹å¼

### 4. èŠ‚ç‚¹è®¾è®¡åŸåˆ™
- **èŒè´£å•ä¸€**ï¼šæ¯ä¸ªèŠ‚ç‚¹åªåšä¸€ä»¶äº‹
- **å¯é…ç½®**ï¼šæ‰€æœ‰è¡Œä¸ºéƒ½å¯é€šè¿‡é…ç½®æ§åˆ¶
- **å¯è¿½æº¯**ï¼šæ¯ä¸ªæ­¥éª¤éƒ½æœ‰æ—¥å¿—è®°å½•

---

## ğŸ¯ æ ¸å¿ƒæ¦‚å¿µ

### ç»Ÿä¸€ä¸Šä¸‹æ–‡å¯¹è±¡ï¼ˆContextï¼‰

æ‰€æœ‰èŠ‚ç‚¹é€šè¿‡ä¸Šä¸‹æ–‡å¯¹è±¡ä¼ é€’ä¿¡æ¯ï¼š

```typescript
interface FlowContext {
  // ============ æœºå™¨äººè¯†åˆ«ä¿¡æ¯ ============
  robotId: string;              // æœºå™¨äººIDï¼ˆæ ¸å¿ƒæ ‡è¯†ï¼‰
  robotName: string;            // æœºå™¨äººåç§°

  // ============ ä¼šè¯ä¿¡æ¯ ============
  sessionId: string;            // ä¼šè¯IDï¼ˆå”¯ä¸€æ ‡è¯†ï¼‰
  messageId: string;            // æ¶ˆæ¯IDï¼ˆå”¯ä¸€æ ‡è¯†ï¼Œè´¯ç©¿å…¨æµç¨‹ï¼‰

  // ============ ç”¨æˆ·ä¿¡æ¯ ============
  userId: string;               // ç”¨æˆ·ID
  userName: string;             // ç”¨æˆ·å
  userAvatar?: string;          // ç”¨æˆ·å¤´åƒ

  // ============ ç¾¤ç»„ä¿¡æ¯ ============
  groupId?: string;             // ç¾¤ç»„ID
  groupName?: string;           // ç¾¤ç»„åç§°
  roomType?: 'group' | 'person'; // æˆ¿é—´ç±»å‹

  // ============ æ¶ˆæ¯ä¿¡æ¯ ============
  originalMessage: string;      // åŸå§‹æ¶ˆæ¯å†…å®¹
  messageType?: 'text' | 'image' | 'file'; // æ¶ˆæ¯ç±»å‹
  atMe: boolean;                // æ˜¯å¦@æœºå™¨äºº

  // ============ AIè¯†åˆ«ç»“æœ ============
  intent?: string;              // æ„å›¾ç±»å‹
  intentConfidence?: number;    // æ„å›¾ç½®ä¿¡åº¦
  aiResponse?: string;          // AIå›å¤å†…å®¹

  // ============ å‘Šè­¦ä¿¡æ¯ ============
  alertLevel?: 'critical' | 'warning' | 'info';
  alertCode?: string;
  alertData?: any;

  // ============ æŒ‡ä»¤ä¿¡æ¯ ============
  targetName?: string;          // å‘é€ç›®æ ‡ï¼ˆç¾¤åæˆ–ç”¨æˆ·åï¼‰
  sendId?: string;              // å‘é€IDï¼ˆæœºå™¨äººè¿”å›çš„ï¼‰
  commandStatus?: 'pending' | 'sent' | 'failed';

  // ============ æ‰§è¡Œå…ƒæ•°æ® ============
  executionPath: string[];      // æ‰§è¡Œè·¯å¾„ï¼ˆèŠ‚ç‚¹IDåˆ—è¡¨ï¼‰
  startTime: number;            // å¼€å§‹æ—¶é—´
  currentNodeId: string;        // å½“å‰èŠ‚ç‚¹ID

  // ============ è‡ªå®šä¹‰å˜é‡ ============
  variables: Record<string, any>; // æµç¨‹è‡ªå®šä¹‰å˜é‡
}
```

**ä¸Šä¸‹æ–‡ä¼ é€’è§„åˆ™**ï¼š
1. âœ… æ¯ä¸ªèŠ‚ç‚¹**åªè¯»**ä¸Šæ¸¸èŠ‚ç‚¹çš„ä¸Šä¸‹æ–‡
2. âœ… æ¯ä¸ªèŠ‚ç‚¹è¿”å›**æ–°**çš„ä¸Šä¸‹æ–‡å¯¹è±¡ï¼ˆä¸ä¿®æ”¹åŸå¯¹è±¡ï¼‰
3. âœ… æ‰€æœ‰è¯†åˆ«ä¿¡æ¯ï¼ˆrobotId, sessionId, messageIdï¼‰**ä¸å¯å˜**
4. âœ… èŠ‚ç‚¹å¯ä»¥æ·»åŠ è‡ªå®šä¹‰å˜é‡åˆ°`variables`å­—æ®µ

---

## ğŸ”§ èŠ‚ç‚¹è®¾è®¡æ–¹æ¡ˆï¼ˆä¼˜åŒ–ç‰ˆï¼‰

### æ€»è§ˆï¼š10ç§èŠ‚ç‚¹ + 3ä¸ªé€»è¾‘åˆ†æ”¯

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     WorkTool Webhook (æ¶ˆæ¯å…¥å£)                  â”‚
â”‚                  /api/worktool/callback/message?robotId={id}     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â†“
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  èŠ‚ç‚¹1: æ¶ˆæ¯æ¥æ”¶ä¸æ•°æ®åº“ä¿å­˜            â”‚
         â”‚  (message_receive)                     â”‚
         â”‚  - æ¥æ”¶æ¶ˆæ¯                           â”‚
         â”‚  - æ„é€ ä¸Šä¸‹æ–‡                         â”‚
         â”‚  - ä¿å­˜åˆ°session_messagesè¡¨          â”‚
         â”‚  - WebSocketæ¨é€                      â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â†“
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  èŠ‚ç‚¹2: æ„å›¾AIåˆ†æ                     â”‚
         â”‚  (intent)                             â”‚
         â”‚  - AIè¯†åˆ«æ„å›¾                         â”‚
         â”‚  - è¿”å›intent + confidence            â”‚
         â”‚  - ä¿å­˜åˆ°ai_io_logsè¡¨                 â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â†“
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  èŠ‚ç‚¹3: å†³ç­–èŠ‚ç‚¹                       â”‚
         â”‚  (decision)                           â”‚
         â”‚  - åˆ¤æ–­æ„å›¾ç±»å‹                       â”‚
         â”‚  - åˆ†å‘åˆ°ä¸åŒåˆ†æ”¯                     â”‚
         â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â†“               â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ è·¯å¾„A: æ ‡å‡†å›å¤  â”‚ â”‚ è·¯å¾„B: å‘Šè­¦å¤„ç†                 â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â†“                      â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ èŠ‚ç‚¹4: AIå®¢æœå›å¤â”‚ â”‚ èŠ‚ç‚¹B1: å‘Šè­¦å…¥åº“                â”‚
    â”‚  (ai_reply)    â”‚ â”‚  (alert_save)                  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ - ä¿å­˜åˆ°alert_historyè¡¨        â”‚
             â†“         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â†“
    â”‚ èŠ‚ç‚¹5: æ¶ˆæ¯åˆ†å‘ â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ (message_      â”‚  â”‚ èŠ‚ç‚¹B2: å‘Šè­¦è§„åˆ™åˆ¤æ–­             â”‚
    â”‚  dispatch)     â”‚  â”‚  (alert_rule)                  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ - åˆ¤æ–­é€šçŸ¥è§„åˆ™                 â”‚
             â†“          â”‚ - ç¡®å®šå‘Šè­¦çº§åˆ«                 â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚ èŠ‚ç‚¹6: å‘é€æŒ‡ä»¤ â”‚               â†“
    â”‚ (send_command) â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ èŠ‚ç‚¹B3: æ‰§è¡Œé€šçŸ¥                â”‚
             â†“          â”‚  (execute_notification)         â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ - å¼¹çª—/é‚®ä»¶/å£°éŸ³/ä¼ä¸šå¾®ä¿¡       â”‚
    â”‚ èŠ‚ç‚¹7: æŒ‡ä»¤çŠ¶æ€ â”‚  â”‚ - æœºå™¨äººé€šçŸ¥                    â”‚
    â”‚ (command_      â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚  status)       â”‚               â†“
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
             â†“          â”‚ å›åˆ°èŠ‚ç‚¹4 (ç»§ç»­æ ‡å‡†æµç¨‹)        â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚ èŠ‚ç‚¹8: ç»“æŸ     â”‚
    â”‚  (end)         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“¦ èŠ‚ç‚¹è¯¦ç»†è®¾è®¡

### èŠ‚ç‚¹1: æ¶ˆæ¯æ¥æ”¶ä¸æ•°æ®åº“ä¿å­˜ (message_receive) â­

**èŒè´£**ï¼š
1. æ¥æ”¶WorkTool Webhookæ¶ˆæ¯
2. æ„é€ ç»Ÿä¸€ä¸Šä¸‹æ–‡å¯¹è±¡
3. ä¿å­˜åˆ°`session_messages`è¡¨
4. WebSocketæ¨é€åˆ°ç›‘æ§é¢æ¿

**è¾“å…¥**ï¼šWebhookæ¶ˆæ¯ä½“
```javascript
{
  robotId: "robot_123",
  fromName: "å¼ ä¸‰",
  groupName: "å®¢æœç¾¤",
  roomId: "room_456",
  roomType: "group",
  atMe: true,
  spoken: "å¦‚ä½•é€€æ¬¾ï¼Ÿ",
  messageType: "text",
  timestamp: 1704067200000
}
```

**è¾“å‡º**ï¼šä¸Šä¸‹æ–‡å¯¹è±¡
```javascript
{
  robotId: "robot_123",
  robotName: "å®¢æœæœºå™¨äºº",
  sessionId: "session_789",
  messageId: "msg_1704067200000_123",
  userId: "user_456",
  userName: "å¼ ä¸‰",
  groupId: "room_456",
  groupName: "å®¢æœç¾¤",
  roomType: "group",
  originalMessage: "å¦‚ä½•é€€æ¬¾ï¼Ÿ",
  atMe: true,
  executionPath: ["node_1"],
  startTime: 1704067200000,
  currentNodeId: "node_2",
  variables: {}
}
```

**é…ç½®é¡¹è®¾è®¡**ï¼š
```typescript
interface MessageReceiveNodeConfig {
  // åŸºç¡€é…ç½®
  name: string;
  description?: string;

  // æ•°æ®ä¿å­˜é…ç½®
  saveToDatabase: boolean;       // ä¿å­˜åˆ°session_messagesè¡¨
  saveToContext: boolean;        // ä¿å­˜åˆ°æµç¨‹ä¸Šä¸‹æ–‡

  // WebSocketæ¨é€é…ç½®
  enableWebSocketPush: boolean;  // å¯ç”¨WebSocketæ¨é€
  pushTarget: 'panel1' | 'panel2' | 'both'; // æ¨é€ç›®æ ‡

  // å­—æ®µæå–é…ç½®ï¼ˆå…¨éƒ¨é»˜è®¤trueï¼‰
  extractFields: {
    messageId: boolean;
    sessionId: boolean;
    userName: boolean;
    groupName: boolean;
    roomType: boolean;
    atMe: boolean;
  };
}
```

**é…ç½®é¢æ¿UI**ï¼š
```
â”Œâ”€ æ¶ˆæ¯æ¥æ”¶èŠ‚ç‚¹é…ç½® â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ èŠ‚ç‚¹åç§°: [æ¶ˆæ¯æ¥æ”¶ä¸æ•°æ®åº“ä¿å­˜_______________]â”‚
â”‚ æè¿°: [æ¥æ”¶WorkToolæ¶ˆæ¯å¹¶ä¿å­˜åˆ°æ•°æ®åº“_________]â”‚
â”‚                                                â”‚
â”‚ â”Œâ”€ æ•°æ®ä¿å­˜é…ç½® â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ [â˜‘] ä¿å­˜åˆ°æ•°æ®åº“ (session_messages)  â”‚  â”‚
â”‚  â”‚ [â˜‘] ä¿å­˜åˆ°æµç¨‹ä¸Šä¸‹æ–‡                   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                â”‚
â”‚ â”Œâ”€ å­—æ®µæå–é…ç½® â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ [â˜‘] messageId (æ¶ˆæ¯ID)                 â”‚  â”‚
â”‚  â”‚ [â˜‘] sessionId (ä¼šè¯ID)                 â”‚  â”‚
â”‚  â”‚ [â˜‘] userName (ç”¨æˆ·å)                   â”‚  â”‚
â”‚  â”‚ [â˜‘] groupName (ç¾¤å)                   â”‚  â”‚
â”‚  â”‚ [â˜‘] roomType (æˆ¿é—´ç±»å‹)                 â”‚  â”‚
â”‚  â”‚ [â˜‘] atMe (æ˜¯å¦@æœºå™¨äºº)                  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                â”‚
â”‚ â”Œâ”€ WebSocketæ¨é€é…ç½® â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ [â˜‘] å¯ç”¨WebSocketå®æ—¶æ¨é€              â”‚  â”‚
â”‚  â”‚ æ¨é€ç›®æ ‡: [ä¸‹æ‹‰é€‰æ‹©]                   â”‚  â”‚
â”‚  â”‚   â—‹ ä»…é¢æ¿1 (ä¸šåŠ¡æ¶ˆæ¯ç›‘æ§)             â”‚  â”‚
â”‚  â”‚   â— ä»…é¢æ¿2 (AIäº¤äº’ç›‘æ§)               â”‚  â”‚
â”‚  â”‚   â—‹ åŒé¢æ¿                             â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å®ç°é€»è¾‘**ï¼š
```javascript
async handleMessageReceiveNode(node, context, input) {
  const { data } = node;

  // 1. ç”Ÿæˆå”¯ä¸€ID
  const messageId = `msg_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
  const sessionId = await sessionService.getOrCreateSessionId(
    input.robotId,
    input.userName,
    input.groupName
  );

  // 2. æ„é€ ä¸Šä¸‹æ–‡å¯¹è±¡
  const newContext = {
    robotId: input.robotId,
    robotName: input.robotName || '', // ä»æ•°æ®åº“è·å–
    sessionId: sessionId,
    messageId: messageId,
    userId: input.userId || `user_${input.fromName}`,
    userName: input.fromName,
    groupId: input.roomId,
    groupName: input.groupName,
    roomType: input.roomType || 'group',
    originalMessage: input.spoken || input.content,
    messageType: input.messageType || 'text',
    atMe: input.atMe || false,
    executionPath: [node.id],
    startTime: Date.now(),
    currentNodeId: node.id,
    variables: {}
  };

  // 3. ä¿å­˜åˆ°æ•°æ®åº“
  if (data.saveToDatabase) {
    await sessionMessageService.saveUserMessage({
      sessionId: newContext.sessionId,
      messageId: newContext.messageId,
      robotId: newContext.robotId,
      content: newContext.originalMessage,
      userName: newContext.userName,
      groupName: newContext.groupName,
      isFromBot: false
    });
  }

  // 4. WebSocketæ¨é€
  if (data.enableWebSocketPush) {
    await websocketService.push(data.pushTarget, {
      type: 'message_received',
      data: {
        sessionId: newContext.sessionId,
        messageId: newContext.messageId,
        robotId: newContext.robotId,
        userName: newContext.userName,
        groupName: newContext.groupName,
        content: newContext.originalMessage,
        timestamp: new Date()
      }
    });
  }

  // 5. è¿”å›ä¸Šä¸‹æ–‡
  return {
    success: true,
    context: data.saveToContext ? newContext : context,
    message: 'æ¶ˆæ¯æ¥æ”¶æˆåŠŸ'
  };
}
```

---

### èŠ‚ç‚¹2: æ„å›¾AIåˆ†æ (intent)

**èŒè´£**ï¼š
1. æ¥æ”¶ä¸Šä¸‹æ–‡å¯¹è±¡
2. è°ƒç”¨æ„å›¾è¯†åˆ«AI
3. è¿”å›æ„å›¾ç±»å‹å’Œç½®ä¿¡åº¦
4. ä¿å­˜åˆ°`ai_io_logs`è¡¨

**è¾“å…¥**ï¼šä¸Šä¸‹æ–‡å¯¹è±¡
**è¾“å‡º**ï¼šæ›´æ–°åçš„ä¸Šä¸‹æ–‡å¯¹è±¡
```javascript
{
  ...previousContext,
  intent: "service",
  intentConfidence: 0.95,
  executionPath: ["node_1", "node_2"],
  currentNodeId: "node_3"
}
```

**é…ç½®é¡¹è®¾è®¡**ï¼š
```typescript
interface IntentNodeConfig {
  name: string;
  description?: string;

  // AIé…ç½®
  modelId: string;              // AIæ¨¡å‹ID
  temperature?: number;         // æ¸©åº¦å‚æ•°ï¼ˆé»˜è®¤0.1ï¼‰
  systemPrompt?: string;        // è‡ªå®šä¹‰ç³»ç»Ÿæç¤ºè¯

  // æ„å›¾é…ç½®
  allowedIntents?: string[];    // å…è®¸çš„æ„å›¾ç±»å‹ï¼ˆç©ºæ•°ç»„è¡¨ç¤ºå…¨éƒ¨ï¼‰
  fallbackIntent?: string;      // å¤±è´¥æ—¶çš„é»˜è®¤æ„å›¾

  // æ—¥å¿—é…ç½®
  saveToAiIoLogs: boolean;      // ä¿å­˜åˆ°ai_io_logsè¡¨
}
```

**é…ç½®é¢æ¿UI**ï¼š
```
â”Œâ”€ æ„å›¾è¯†åˆ«èŠ‚ç‚¹é…ç½® â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ èŠ‚ç‚¹åç§°: [æ„å›¾AIåˆ†æ___________________]     â”‚
â”‚ æè¿°: [è¯†åˆ«ç”¨æˆ·æ¶ˆæ¯æ„å›¾_______________]      â”‚
â”‚                                                â”‚
â”‚ â”Œâ”€ AIæ¨¡å‹é…ç½® â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ AIæ¨¡å‹: [ä¸‹æ‹‰é€‰æ‹©]                   â”‚  â”‚
â”‚  â”‚   â— é»˜è®¤æ„å›¾è¯†åˆ«æ¨¡å‹ (model_intent)  â”‚  â”‚
â”‚  â”‚   â—‹ è‡ªå®šä¹‰æ¨¡å‹                       â”‚  â”‚
â”‚  â”‚                                       â”‚  â”‚
â”‚  â”‚ æ¸©åº¦å‚æ•°: [0.1] (0.0-1.0)            â”‚  â”‚
â”‚  â”‚                                       â”‚  â”‚
â”‚  â”‚ è‡ªå®šä¹‰æç¤ºè¯:                          â”‚  â”‚
â”‚  â”‚ [ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ„å›¾è¯†åˆ«åŠ©æ‰‹..._______]â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                â”‚
â”‚ â”Œâ”€ æ„å›¾è¿‡æ»¤é…ç½® â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ä»…å…è®¸ä»¥ä¸‹æ„å›¾:                       â”‚  â”‚
â”‚  â”‚ [â˜‘] service (æœåŠ¡å’¨è¯¢)                â”‚  â”‚
â”‚  â”‚ [â˜‘] help (å¸®åŠ©è¯·æ±‚)                   â”‚  â”‚
â”‚  â”‚ [â˜‘] chat (é—²èŠ)                       â”‚  â”‚
â”‚  â”‚ [â˜‘] risk (é£é™©å†…å®¹)                   â”‚  â”‚
â”‚  â”‚ [â˜‘] spam (åƒåœ¾ä¿¡æ¯)                   â”‚  â”‚
â”‚  â”‚                                       â”‚  â”‚
â”‚  â”‚ å¤±è´¥é»˜è®¤æ„å›¾: [service â–¼]            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                â”‚
â”‚ â”Œâ”€ æ—¥å¿—é…ç½® â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ [â˜‘] ä¿å­˜åˆ°ai_io_logsè¡¨               â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å®ç°é€»è¾‘**ï¼š
```javascript
async handleIntentNode(node, context, input) {
  const { data } = node;

  // 1. è°ƒç”¨AIæœåŠ¡
  const aiResult = await aiService.recognizeIntent(
    context.originalMessage,
    {
      sessionId: context.sessionId,
      messageId: context.messageId,
      robotId: context.robotId,
      robotName: context.robotName,
      userName: context.userName,
      groupName: context.groupName
    }
  );

  // 2. éªŒè¯æ„å›¾
  let finalIntent = aiResult.intent;
  if (data.allowedIntents && data.allowedIntents.length > 0) {
    if (!data.allowedIntents.includes(finalIntent)) {
      finalIntent = data.fallbackIntent || 'service';
    }
  }

  // 3. ä¿å­˜åˆ°ai_io_logsè¡¨
  if (data.saveToAiIoLogs) {
    await aiIoLogService.saveLog({
      sessionId: context.sessionId,
      messageId: context.messageId,
      robotId: context.robotId,
      operationType: 'intent_recognition',
      input: context.originalMessage,
      output: JSON.stringify({
        intent: finalIntent,
        confidence: aiResult.confidence
      }),
      status: 'success',
      modelId: data.modelId,
      requestDuration: aiResult.duration
    });
  }

  // 4. è¿”å›æ›´æ–°åçš„ä¸Šä¸‹æ–‡
  return {
    success: true,
    context: {
      ...context,
      intent: finalIntent,
      intentConfidence: aiResult.confidence,
      executionPath: [...context.executionPath, node.id],
      currentNodeId: node.id
    },
    message: 'æ„å›¾è¯†åˆ«æˆåŠŸ'
  };
}
```

---

### èŠ‚ç‚¹3: å†³ç­–èŠ‚ç‚¹ (decision)

**èŒè´£**ï¼š
1. æ ¹æ®æ„å›¾ç±»å‹åˆ¤æ–­åç»­æµç¨‹
2. åˆ†å‘åˆ°æ ‡å‡†å›å¤åˆ†æ”¯æˆ–å‘Šè­¦å¤„ç†åˆ†æ”¯
3. æ”¯æŒè‡ªå®šä¹‰å†³ç­–è§„åˆ™

**è¾“å…¥**ï¼šä¸Šä¸‹æ–‡å¯¹è±¡
**è¾“å‡º**ï¼šå†³ç­–ç»“æœ + æ›´æ–°çš„ä¸Šä¸‹æ–‡

**é…ç½®é¡¹è®¾è®¡**ï¼š
```typescript
interface DecisionNodeConfig {
  name: string;
  description?: string;

  // å†³ç­–è§„åˆ™
  rules: DecisionRule[];
}

interface DecisionRule {
  id: string;
  name: string;
  condition: string;              // æ¡ä»¶è¡¨è¾¾å¼
  targetNodeId: string;           // ç›®æ ‡èŠ‚ç‚¹ID
}
```

**é…ç½®é¢æ¿UI**ï¼š
```
â”Œâ”€ å†³ç­–èŠ‚ç‚¹é…ç½® â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ èŠ‚ç‚¹åç§°: [æ„å›¾å†³ç­–åˆ¤æ–­_______________]    â”‚
â”‚ æè¿°: [æ ¹æ®æ„å›¾ç±»å‹åˆ†å‘åç»­æµç¨‹_________]  â”‚
â”‚                                                â”‚
â”‚ â”Œâ”€ è§„åˆ™1 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ è§„åˆ™åç§°: [é£é™©å‘Šè­¦å¤„ç†____________]  â”‚ â”‚
â”‚  â”‚ æ¡ä»¶è¡¨è¾¾å¼: [intent == "risk" || intent == "spam"] â”‚ â”‚
â”‚  â”‚ ç›®æ ‡èŠ‚ç‚¹: [å‘Šè­¦å…¥åº“èŠ‚ç‚¹ â–¼]            â”‚ â”‚
â”‚  â”‚ [åˆ é™¤è§„åˆ™]                           â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                â”‚
â”‚ â”Œâ”€ è§„åˆ™2 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ è§„åˆ™åç§°: [æ ‡å‡†å®¢æœå›å¤____________]  â”‚ â”‚
â”‚  â”‚ æ¡ä»¶è¡¨è¾¾å¼: [intent != "risk" && intent != "spam"] â”‚ â”‚
â”‚  â”‚ ç›®æ ‡èŠ‚ç‚¹: [AIå®¢æœå›å¤èŠ‚ç‚¹ â–¼]          â”‚ â”‚
â”‚  â”‚ [åˆ é™¤è§„åˆ™]                           â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                â”‚
â”‚ [+ æ·»åŠ è§„åˆ™]                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å®ç°é€»è¾‘**ï¼š
```javascript
async handleDecisionNode(node, context, input) {
  const { data } = node;
  const { rules } = data;

  // 1. éå†è§„åˆ™ï¼Œæ‰¾åˆ°åŒ¹é…çš„è§„åˆ™
  let matchedRule = null;
  for (const rule of rules) {
    if (this.evaluateCondition(rule.condition, context)) {
      matchedRule = rule;
      break;
    }
  }

  // 2. è¿”å›å†³ç­–ç»“æœ
  return {
    success: true,
    matchedRule: matchedRule,
    conditionResult: matchedRule ? matchedRule.id : 'default',
    context: {
      ...context,
      executionPath: [...context.executionPath, node.id],
      currentNodeId: node.id
    },
    nextNodeId: matchedRule?.targetNodeId
  };
}

// æ¡ä»¶è¡¨è¾¾å¼æ±‚å€¼
evaluateCondition(expression, context) {
  try {
    // æ„é€ å®‰å…¨çš„æ±‚å€¼ç¯å¢ƒ
    const env = {
      intent: context.intent,
      userName: context.userName,
      groupName: context.groupName,
      atMe: context.atMe,
      // ... å…¶ä»–ä¸Šä¸‹æ–‡å˜é‡
    };

    // ä½¿ç”¨Functionæ„é€ å‡½æ•°ï¼ˆä»…æ”¯æŒç®€å•è¡¨è¾¾å¼ï¼‰
    const func = new Function(...Object.keys(env), `return ${expression}`);
    return func(...Object.values(env));
  } catch (error) {
    console.error('æ¡ä»¶è¡¨è¾¾å¼æ±‚å€¼å¤±è´¥:', error);
    return false;
  }
}
```

---

### èŠ‚ç‚¹4: AIå®¢æœå›å¤ (ai_reply)

**èŒè´£**ï¼š
1. æ¥æ”¶ä¸Šä¸‹æ–‡å¯¹è±¡
2. æ ¹æ®æ„å›¾ç±»å‹é€‰æ‹©åˆé€‚çš„AIæ¨¡å‹
3. ç”Ÿæˆå›å¤å†…å®¹
4. ä¿å­˜åˆ°`ai_io_logs`è¡¨

**è¾“å…¥**ï¼šä¸Šä¸‹æ–‡å¯¹è±¡
**è¾“å‡º**ï¼šæ›´æ–°åçš„ä¸Šä¸‹æ–‡å¯¹è±¡ï¼ˆåŒ…å«aiResponseï¼‰

**é…ç½®é¡¹è®¾è®¡**ï¼š
```typescript
interface AiReplyNodeConfig {
  name: string;
  description?: string;

  // AIæ¨¡å‹é…ç½®ï¼ˆæŒ‰æ„å›¾ç±»å‹ï¼‰
  aiModels: {
    [intent: string]: {
      modelId: string;
      temperature?: number;
      systemPrompt?: string;
    }
  };

  // é»˜è®¤æ¨¡å‹ï¼ˆæœªåŒ¹é…åˆ°æ„å›¾æ—¶ä½¿ç”¨ï¼‰
  defaultModel: {
    modelId: string;
    temperature?: number;
    systemPrompt?: string;
  };

  // æç¤ºè¯æ¨¡æ¿
  promptTemplates?: {
    [intent: string]: string;   // æ„å›¾ä¸“å±æç¤ºè¯
  };

  // ä¸Šä¸‹æ–‡é…ç½®
  includeHistory: boolean;      // æ˜¯å¦åŒ…å«å†å²æ¶ˆæ¯
  historyLimit: number;         // å†å²æ¶ˆæ¯æ¡æ•°

  // æ—¥å¿—é…ç½®
  saveToAiIoLogs: boolean;
}
```

**é…ç½®é¢æ¿UI**ï¼š
```
â”Œâ”€ AIå®¢æœå›å¤èŠ‚ç‚¹é…ç½® â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ èŠ‚ç‚¹åç§°: [AIå®¢æœå›å¤_______________]        â”‚
â”‚ æè¿°: [æ ¹æ®æ„å›¾ç”Ÿæˆæ™ºèƒ½å›å¤____________]    â”‚
â”‚                                                â”‚
â”‚ â”Œâ”€ æ„å›¾-æ¨¡å‹æ˜ å°„ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ service (æœåŠ¡å’¨è¯¢) â†’ [model_service â–¼]â”‚  â”‚
â”‚  â”‚ help (å¸®åŠ©è¯·æ±‚) â†’ [model_service â–¼]   â”‚  â”‚
â”‚  â”‚ chat (é—²èŠ) â†’ [model_chat â–¼]          â”‚  â”‚
â”‚  â”‚ welcome (æ¬¢è¿) â†’ [model_service â–¼]   â”‚  â”‚
â”‚  â”‚ risk (é£é™©å†…å®¹) â†’ [model_risk â–¼]     â”‚  â”‚
â”‚  â”‚ spam (åƒåœ¾ä¿¡æ¯) â†’ [model_spam â–¼]     â”‚  â”‚
â”‚  â”‚                                       â”‚  â”‚
â”‚  â”‚ é»˜è®¤æ¨¡å‹: [model_service â–¼]          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                â”‚
â”‚ â”Œâ”€ æç¤ºè¯æ¨¡æ¿é…ç½® â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ æ„å›¾: [service â–¼]                     â”‚  â”‚
â”‚  â”‚                                       â”‚  â”‚
â”‚  â”‚ æç¤ºè¯æ¨¡æ¿:                           â”‚  â”‚
â”‚  â”‚ [ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„å®¢æœåŠ©æ‰‹...___________]â”‚  â”‚
â”‚  â”‚                                       â”‚  â”‚
â”‚  â”‚ æ”¯æŒçš„å˜é‡: {{userName}}, {{groupName}} â”‚  â”‚
â”‚  â”‚             {{intent}}, {{originalMessage}}â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                â”‚
â”‚ â”Œâ”€ ä¸Šä¸‹æ–‡é…ç½® â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ [â˜‘] åŒ…å«å†å²æ¶ˆæ¯                     â”‚  â”‚
â”‚  â”‚ å†å²æ¶ˆæ¯æ¡æ•°: [5]                     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                â”‚
â”‚ â”Œâ”€ æ—¥å¿—é…ç½® â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ [â˜‘] ä¿å­˜åˆ°ai_io_logsè¡¨               â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å®ç°é€»è¾‘**ï¼š
```javascript
async handleAiReplyNode(node, context, input) {
  const { data } = node;
  const intent = context.intent || 'service';

  // 1. è·å–AIæ¨¡å‹é…ç½®
  const modelConfig = data.aiModels[intent] || data.defaultModel;

  // 2. æ„é€ æç¤ºè¯
  let prompt = data.systemPrompt || '';
  if (data.promptTemplates && data.promptTemplates[intent]) {
    prompt = data.promptTemplates[intent];
  }

  // æ›¿æ¢å˜é‡
  prompt = this.renderTemplate(prompt, context);

  // 3. æ„é€ è¾“å…¥æ¶ˆæ¯
  let messages = [
    { role: 'system', content: prompt }
  ];

  // åŒ…å«å†å²æ¶ˆæ¯
  if (data.includeHistory) {
    const history = await sessionMessageService.getHistory(
      context.sessionId,
      data.historyLimit
    );
    messages = messages.concat(history);
  }

  // æ·»åŠ å½“å‰æ¶ˆæ¯
  messages.push({
    role: 'user',
    content: context.originalMessage
  });

  // 4. è°ƒç”¨AIæœåŠ¡
  const aiResult = await aiService.generateReply(messages, {
    modelId: modelConfig.modelId,
    temperature: modelConfig.temperature || 0.7
  });

  // 5. ä¿å­˜åˆ°ai_io_logsè¡¨
  if (data.saveToAiIoLogs) {
    await aiIoLogService.saveLog({
      sessionId: context.sessionId,
      messageId: context.messageId,
      robotId: context.robotId,
      operationType: 'service_reply',
      input: JSON.stringify(messages),
      output: aiResult.reply,
      status: 'success',
      modelId: modelConfig.modelId,
      requestDuration: aiResult.duration
    });
  }

  // 6. è¿”å›æ›´æ–°åçš„ä¸Šä¸‹æ–‡
  return {
    success: true,
    context: {
      ...context,
      aiResponse: aiResult.reply,
      executionPath: [...context.executionPath, node.id],
      currentNodeId: node.id
    },
    message: 'AIå›å¤ç”ŸæˆæˆåŠŸ'
  };
}

// æ¨¡æ¿æ¸²æŸ“
renderTemplate(template, context) {
  return template.replace(/\{\{(\w+)\}\}/g, (match, key) => {
    return context[key] || match;
  });
}
```

---

### èŠ‚ç‚¹5: æ¶ˆæ¯åˆ†å‘ (message_dispatch)

**èŒè´£**ï¼š
1. åˆ¤æ–­ç¾¤å‘/ç§å‘
2. ç¡®å®š`targetName`
3. åˆ¤æ–­æ˜¯å¦éœ€è¦@æœºå™¨äºº

**è¾“å…¥**ï¼šä¸Šä¸‹æ–‡å¯¹è±¡
**è¾“å‡º**ï¼šæ›´æ–°åçš„ä¸Šä¸‹æ–‡å¯¹è±¡ï¼ˆåŒ…å«targetNameï¼‰

**é…ç½®é¡¹è®¾è®¡**ï¼š
```typescript
interface MessageDispatchNodeConfig {
  name: string;
  description?: string;

  // åˆ†å‘è§„åˆ™
  dispatchRules: {
    // ç¾¤å‘é…ç½®
    groupTarget?: 'original' | 'custom'; // åŸå§‹ç¾¤åæˆ–è‡ªå®šä¹‰
    customGroupTarget?: string;          // è‡ªå®šä¹‰ç¾¤å

    // ç§å‘é…ç½®
    privateTarget?: 'original' | 'custom'; // åŸå§‹ç”¨æˆ·åæˆ–è‡ªå®šä¹‰
    customPrivateTarget?: string;        // è‡ªå®šä¹‰ç§å‘ç›®æ ‡

    // @æœºå™¨äººé…ç½®
    requireAtMe?: boolean;               // æ˜¯å¦å¿…é¡»@æœºå™¨äººæ‰å›å¤
    ignoreIfNotAtMe?: boolean;           // å¦‚æœæ²¡@æ˜¯å¦å¿½ç•¥
  };

  // é»˜è®¤ç›®æ ‡
  defaultTarget: string;
}
```

**é…ç½®é¢æ¿UI**ï¼š
```
â”Œâ”€ æ¶ˆæ¯åˆ†å‘èŠ‚ç‚¹é…ç½® â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ èŠ‚ç‚¹åç§°: [æ¶ˆæ¯åˆ†å‘åˆ¤æ–­_______________]    â”‚
â”‚ æè¿°: [åˆ¤æ–­ç¾¤å‘/ç§å‘ï¼Œç¡®å®štargetName_____]â”‚
â”‚                                                â”‚
â”‚ â”Œâ”€ ç¾¤å‘é…ç½® â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ç›®æ ‡åç§°æ¥æº: [ä¸‹æ‹‰é€‰æ‹©]               â”‚  â”‚
â”‚  â”‚   â— ä½¿ç”¨åŸå§‹ç¾¤å (groupName)          â”‚  â”‚
â”‚  â”‚   â—‹ ä½¿ç”¨è‡ªå®šä¹‰ç¾¤å                    â”‚  â”‚
â”‚  â”‚                                       â”‚  â”‚
â”‚  â”‚ è‡ªå®šä¹‰ç¾¤å: [_______________]          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                â”‚
â”‚ â”Œâ”€ ç§å‘é…ç½® â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ç›®æ ‡åç§°æ¥æº: [ä¸‹æ‹‰é€‰æ‹©]               â”‚  â”‚
â”‚  â”‚   â— ä½¿ç”¨ç”¨æˆ·å (userName)              â”‚  â”‚
â”‚  â”‚   â—‹ ä½¿ç”¨è‡ªå®šä¹‰ç§å‘ç›®æ ‡                  â”‚  â”‚
â”‚  â”‚                                       â”‚  â”‚
â”‚  â”‚ è‡ªå®šä¹‰ç›®æ ‡: [_______________]          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                â”‚
â”‚ â”Œâ”€ @æœºå™¨äººé…ç½® â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ [â˜‘] å¿…é¡»@æœºå™¨äººæ‰å›å¤                 â”‚  â”‚
â”‚  â”‚ å¦‚æœæ²¡@æœºå™¨äºº: [ç»§ç»­å¤„ç† â–¼]           â”‚  â”‚
â”‚  â”‚   â—‹ ç»§ç»­å¤„ç†                          â”‚  â”‚
â”‚  â”‚   â—‹ å¿½ç•¥æ¶ˆæ¯ï¼Œä¸å›å¤                  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                â”‚
â”‚ é»˜è®¤ç›®æ ‡: [{{userName}}________________]     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å®ç°é€»è¾‘**ï¼š
```javascript
async handleMessageDispatchNode(node, context, input) {
  const { data } = node;
  const { dispatchRules, defaultTarget } = data;

  let targetName = defaultTarget;
  let shouldDispatch = true;

  // 1. åˆ¤æ–­æ˜¯å¦éœ€è¦@æœºå™¨äºº
  if (dispatchRules?.requireAtMe && !context.atMe) {
    if (dispatchRules.ignoreIfNotAtMe) {
      shouldDispatch = false;
    }
  }

  // 2. ç¡®å®šå‘é€ç›®æ ‡
  if (shouldDispatch) {
    if (context.groupName) {
      // ç¾¤å‘
      if (dispatchRules?.groupTarget === 'custom') {
        targetName = dispatchRules.customGroupTarget;
      } else {
        targetName = context.groupName;
      }
    } else {
      // ç§å‘
      if (dispatchRules?.privateTarget === 'custom') {
        targetName = dispatchRules.customPrivateTarget;
      } else {
        targetName = context.userName;
      }
    }
  }

  // 3. è¿”å›æ›´æ–°åçš„ä¸Šä¸‹æ–‡
  return {
    success: true,
    context: {
      ...context,
      targetName: targetName,
      shouldDispatch: shouldDispatch,
      executionPath: [...context.executionPath, node.id],
      currentNodeId: node.id
    },
    message: 'æ¶ˆæ¯åˆ†å‘æˆåŠŸ'
  };
}
```

---

### èŠ‚ç‚¹6: å‘é€æŒ‡ä»¤ (send_command)

**èŒè´£**ï¼š
1. è°ƒç”¨`worktoolService.sendTextMessage()`å‘é€æ¶ˆæ¯
2. æ”¯æŒ@äºº
3. æ”¯æŒé‡è¯•æœºåˆ¶

**è¾“å…¥**ï¼šä¸Šä¸‹æ–‡å¯¹è±¡
**è¾“å‡º**ï¼šæ›´æ–°åçš„ä¸Šä¸‹æ–‡å¯¹è±¡ï¼ˆåŒ…å«sendIdå’ŒcommandStatusï¼‰

**é…ç½®é¡¹è®¾è®¡**ï¼š
```typescript
interface SendCommandNodeConfig {
  name: string;
  description?: string;

  // æ¶ˆæ¯æ¥æº
  messageSource: 'ai_response' | 'fixed' | 'template' | 'custom';
  fixedMessage?: string;
  messageTemplate?: string;
  customVariable?: string;           // è‡ªå®šä¹‰å˜é‡å

  // @äººé…ç½®
  enableAtList?: boolean;
  atListSource: 'fixed' | 'dynamic';
  fixedAtList?: string[];
  dynamicAtListExpression?: string;

  // é‡è¯•é…ç½®
  enableRetry?: boolean;
  maxRetries?: number;
  retryDelay?: number;              // æ¯«ç§’
}
```

**é…ç½®é¢æ¿UI**ï¼š
```
â”Œâ”€ å‘é€æŒ‡ä»¤èŠ‚ç‚¹é…ç½® â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ èŠ‚ç‚¹åç§°: [å‘é€WorkToolæŒ‡ä»¤_____________]  â”‚
â”‚ æè¿°: [è°ƒç”¨WorkTool APIå‘é€æ¶ˆæ¯_________]â”‚
â”‚                                                â”‚
â”‚ æ¶ˆæ¯æ¥æº: [ä¸‹æ‹‰é€‰æ‹©]                            â”‚
â”‚   â— AIå›å¤ç»“æœ ({{aiResponse}})              â”‚
â”‚   â—‹ å›ºå®šæ¶ˆæ¯å†…å®¹                              â”‚
â”‚   â—‹ æ¶ˆæ¯æ¨¡æ¿                                  â”‚
â”‚   â—‹ è‡ªå®šä¹‰å˜é‡                                â”‚
â”‚                                                â”‚
â”‚ â”Œâ”€ å›ºå®šæ¶ˆæ¯å†…å®¹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ [_____________________________________] â”‚  â”‚
â”‚  â”‚ (æ”¯æŒå˜é‡: {{userName}}, {{intent}}...)  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                â”‚
â”‚ â”Œâ”€ @äººé…ç½® â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ [â˜‘] å¯ç”¨@äººåŠŸèƒ½                       â”‚  â”‚
â”‚  â”‚ @äººæ¥æº: [ä¸‹æ‹‰é€‰æ‹©]                   â”‚  â”‚
â”‚  â”‚   â—‹ å›ºå®š@äººåˆ—è¡¨                       â”‚  â”‚
â”‚  â”‚   â— åŠ¨æ€@äººè¡¨è¾¾å¼                     â”‚  â”‚
â”‚  â”‚                                       â”‚  â”‚
â”‚  â”‚ å›ºå®š@äººåˆ—è¡¨:                          â”‚  â”‚
â”‚  â”‚ [å¼ ä¸‰, æå››, ç‹äº”____________________]  â”‚  â”‚
â”‚  â”‚                                       â”‚  â”‚
â”‚  â”‚ åŠ¨æ€è¡¨è¾¾å¼: [{{userName}}___________]  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                â”‚
â”‚ â”Œâ”€ é‡è¯•é…ç½® â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ [â˜‘] å¯ç”¨å¤±è´¥é‡è¯•                       â”‚  â”‚
â”‚  â”‚ æœ€å¤§é‡è¯•æ¬¡æ•°: [3]                       â”‚  â”‚
â”‚  â”‚ é‡è¯•å»¶è¿Ÿ: [2000] æ¯«ç§’ (2ç§’)              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å®ç°é€»è¾‘**ï¼š
```javascript
async handleSendCommandNode(node, context, input) {
  const { data } = node;
  const robotId = context.robotId;

  // 1. è·å–æ¶ˆæ¯å†…å®¹
  let messageContent = '';
  switch (data.messageSource) {
    case 'ai_response':
      messageContent = context.aiResponse || '';
      break;
    case 'fixed':
      messageContent = data.fixedMessage || '';
      break;
    case 'template':
      messageContent = this.renderTemplate(data.messageTemplate, context);
      break;
    case 'custom':
      messageContent = context[data.customVariable || 'messageContent'] || '';
      break;
  }

  // 2. è·å–@äººåˆ—è¡¨
  let atList = [];
  if (data.enableAtList) {
    if (data.atListSource === 'fixed') {
      atList = data.fixedAtList || [];
    } else {
      atList = this.evaluateExpression(data.dynamicAtListExpression, context);
    }
  }

  // 3. è°ƒç”¨WorkToolæœåŠ¡å‘é€æ¶ˆæ¯
  const sendResult = await worktoolService.sendTextMessage(
    robotId,
    context.targetName || context.userName,
    messageContent,
    atList
  );

  // 4. å¦‚æœå¤±è´¥ï¼Œæ‰§è¡Œé‡è¯•
  if (!sendResult.success && data.enableRetry) {
    for (let i = 0; i < data.maxRetries; i++) {
      await new Promise(resolve => setTimeout(resolve, data.retryDelay));
      sendResult = await worktoolService.sendTextMessage(
        robotId,
        context.targetName || context.userName,
        messageContent,
        atList
      );
      if (sendResult.success) break;
    }
  }

  // 5. è¿”å›æ›´æ–°åçš„ä¸Šä¸‹æ–‡
  return {
    success: sendResult.success,
    context: {
      ...context,
      sendId: sendResult.sendId,
      commandStatus: sendResult.success ? 'sent' : 'failed',
      sentMessage: messageContent,
      executionPath: [...context.executionPath, node.id],
      currentNodeId: node.id
    },
    message: sendResult.success ? 'æŒ‡ä»¤å‘é€æˆåŠŸ' : 'æŒ‡ä»¤å‘é€å¤±è´¥'
  };
}
```

---

### èŠ‚ç‚¹7: æŒ‡ä»¤çŠ¶æ€è®°å½• (command_status)

**èŒè´£**ï¼š
1. ä¿å­˜æŒ‡ä»¤çŠ¶æ€åˆ°`robotCommands`è¡¨
2. æ›´æ–°`session_messages`è¡¨
3. WebSocketæ¨é€åˆ°ç›‘æ§é¢æ¿

**è¾“å…¥**ï¼šä¸Šä¸‹æ–‡å¯¹è±¡
**è¾“å‡º**ï¼šæ›´æ–°åçš„ä¸Šä¸‹æ–‡å¯¹è±¡

**é…ç½®é¡¹è®¾è®¡**ï¼š
```typescript
interface CommandStatusNodeConfig {
  name: string;
  description?: string;

  // ä¿å­˜é…ç½®
  saveToRobotCommands: boolean;
  saveToSessionMessages: boolean;

  // WebSocketæ¨é€é…ç½®
  enableWebSocketPush: boolean;
  pushTarget: 'panel1' | 'panel2' | 'both';
}
```

**å®ç°é€»è¾‘**ï¼š
```javascript
async handleCommandStatusNode(node, context, input) {
  const { data } = node;

  // 1. ä¿å­˜åˆ°robotCommandsè¡¨
  if (data.saveToRobotCommands && context.sendId) {
    await robotCommandService.saveCommand({
      robotId: context.robotId,
      commandType: 'sendMessage',
      targetName: context.targetName,
      messageContent: context.sentMessage,
      status: context.commandStatus || 'sent',
      sendId: context.sendId,
      sessionId: context.sessionId,
      messageId: context.messageId
    });
  }

  // 2. æ›´æ–°session_messagesè¡¨
  if (data.saveToSessionMessages && context.sentMessage) {
    await sessionMessageService.saveBotMessage({
      sessionId: context.sessionId,
      messageId: context.messageId,
      robotId: context.robotId,
      content: context.sentMessage,
      isFromBot: true
    });
  }

  // 3. WebSocketæ¨é€
  if (data.enableWebSocketPush) {
    await websocketService.push(data.pushTarget, {
      type: 'command_sent',
      data: {
        robotId: context.robotId,
        targetName: context.targetName,
        messageContent: context.sentMessage,
        status: context.commandStatus
      }
    });
  }

  // 4. è¿”å›æ›´æ–°åçš„ä¸Šä¸‹æ–‡
  return {
    success: true,
    context: {
      ...context,
      executionPath: [...context.executionPath, node.id],
      currentNodeId: node.id
    },
    message: 'æŒ‡ä»¤çŠ¶æ€è®°å½•æˆåŠŸ'
  };
}
```

---

### èŠ‚ç‚¹8: ç»“æŸèŠ‚ç‚¹ (end)

**èŒè´£**ï¼š
1. æµç¨‹ç»“æŸ
2. è®°å½•æµç¨‹æ‰§è¡Œç»“æœ

**è¾“å…¥**ï¼šä¸Šä¸‹æ–‡å¯¹è±¡
**è¾“å‡º**ï¼šæµç¨‹ç»“æŸä¿¡å·

---

### èŠ‚ç‚¹B1: å‘Šè­¦å…¥åº“ (alert_save)

**èŒè´£**ï¼š
1. ä¿å­˜å‘Šè­¦ä¿¡æ¯åˆ°`alert_history`è¡¨
2. WebSocketæ¨é€åˆ°ç›‘æ§é¢æ¿

**è¾“å…¥**ï¼šä¸Šä¸‹æ–‡å¯¹è±¡
**è¾“å‡º**ï¼šæ›´æ–°åçš„ä¸Šä¸‹æ–‡å¯¹è±¡ï¼ˆåŒ…å«alertId, alertLevelï¼‰

**é…ç½®é¡¹è®¾è®¡**ï¼š
```typescript
interface AlertSaveNodeConfig {
  name: string;
  description?: string;

  // å‘Šè­¦é…ç½®
  alertType: 'intent' | 'keyword' | 'frequency' | 'custom';
  alertLevel?: 'critical' | 'warning' | 'info';

  // æ„å›¾é…ç½®
  intentType?: string;

  // å…³é”®è¯é…ç½®
  keywords?: string[];
  matchMode?: 'exact' | 'contains';

  // é¢‘ç‡é…ç½®
  frequencyThreshold?: number;
  timeWindow?: number;
}
```

**å®ç°é€»è¾‘**ï¼š
```javascript
async handleAlertSaveNode(node, context, input) {
  const { data } = node;

  // 1. ä¿å­˜å‘Šè­¦ä¿¡æ¯åˆ°alert_historyè¡¨
  const alertResult = await alertService.saveAlert({
    sessionId: context.sessionId,
    robotId: context.robotId,
    userId: context.userId,
    userName: context.userName,
    groupId: context.groupId,
    groupName: context.groupName,
    messageContent: context.originalMessage,
    alertType: data.alertType,
    intentType: data.intentType || context.intent,
    alertLevel: data.alertLevel || 'warning',
    alertCode: `alert_${context.intent}`,
    alertData: {
      intent: context.intent,
      confidence: context.intentConfidence
    }
  });

  // 2. WebSocketæ¨é€
  await websocketService.push('panel1', {
    type: 'alert_triggered',
    data: {
      alertId: alertResult.alertId,
      alertLevel: data.alertLevel,
      userName: context.userName,
      groupName: context.groupName,
      messageContent: context.originalMessage
    }
  });

  // 3. è¿”å›æ›´æ–°åçš„ä¸Šä¸‹æ–‡
  return {
    success: true,
    context: {
      ...context,
      alertId: alertResult.alertId,
      alertLevel: data.alertLevel || 'warning',
      alertCode: `alert_${context.intent}`,
      executionPath: [...context.executionPath, node.id],
      currentNodeId: node.id
    },
    message: 'å‘Šè­¦å…¥åº“æˆåŠŸ'
  };
}
```

---

### èŠ‚ç‚¹B2: å‘Šè­¦è§„åˆ™åˆ¤æ–­ (alert_rule)

**èŒè´£**ï¼š
1. åˆ¤æ–­å‘Šè­¦è§„åˆ™æ˜¯å¦åŒ¹é…
2. ç¡®å®šéœ€è¦å‘é€çš„é€šçŸ¥æ–¹å¼

**è¾“å…¥**ï¼šä¸Šä¸‹æ–‡å¯¹è±¡
**è¾“å‡º**ï¼šæ›´æ–°åçš„ä¸Šä¸‹æ–‡å¯¹è±¡ï¼ˆåŒ…å«matchedRulesï¼‰

**é…ç½®é¡¹è®¾è®¡**ï¼š
```typescript
interface AlertRuleNodeConfig {
  name: string;
  description?: string;

  // è§„åˆ™é…ç½®
  rules: AlertRule[];
}

interface AlertRule {
  id: string;
  name: string;
  condition: string;
  alertLevel: 'critical' | 'warning' | 'info';
  targetNodeId: string;
  notifications: NotificationConfig[];
}
```

**å®ç°é€»è¾‘**ï¼š
```javascript
async handleAlertRuleNode(node, context, input) {
  const { data } = node;
  const { rules } = data;

  // 1. éå†è§„åˆ™ï¼Œæ‰¾åˆ°åŒ¹é…çš„è§„åˆ™
  let matchedRules = [];
  for (const rule of rules) {
    if (this.evaluateCondition(rule.condition, context)) {
      matchedRules.push(rule);
    }
  }

  // 2. è¿”å›æ›´æ–°åçš„ä¸Šä¸‹æ–‡
  return {
    success: true,
    matchedRules: matchedRules,
    context: {
      ...context,
      matchedRules: matchedRules,
      executionPath: [...context.executionPath, node.id],
      currentNodeId: node.id
    },
    message: `åŒ¹é…åˆ°${matchedRules.length}æ¡å‘Šè­¦è§„åˆ™`
  };
}
```

---

### èŠ‚ç‚¹B3: æ‰§è¡Œé€šçŸ¥ (execute_notification) â­æ–°å¢

**èŒè´£**ï¼š
1. æ‰§è¡Œå¤šç§é€šçŸ¥æ–¹å¼
2. æ”¯æŒæœºå™¨äººé€šçŸ¥ï¼ˆç§å‘/ç¾¤å‘ï¼‰
3. æ”¯æŒé‚®ä»¶ã€å£°éŸ³ã€ä¼ä¸šå¾®ä¿¡ç­‰

**è¾“å…¥**ï¼šä¸Šä¸‹æ–‡å¯¹è±¡
**è¾“å‡º**ï¼šæ‰§è¡Œç»“æœ

**é…ç½®é¡¹è®¾è®¡**ï¼š
```typescript
interface ExecuteNotificationNodeConfig {
  name: string;
  description?: string;

  // é€šçŸ¥æ–¹å¼é…ç½®
  notificationMethods: NotificationMethodConfig[];
}

interface NotificationMethodConfig {
  type: 'popup' | 'email' | 'sound' | 'wechat' | 'robot'; // é€šçŸ¥æ–¹å¼
  enabled: boolean;
  priority: number;             // ä¼˜å…ˆçº§ï¼ˆ1-10ï¼‰

  // æœºå™¨äººé€šçŸ¥ä¸“ç”¨é…ç½®
  robotConfig?: {
    sendType: 'private' | 'group'; // ç§å‘æˆ–ç¾¤å‘
    targetName?: string;          // ç›®æ ‡åç§°ï¼ˆç¾¤åæˆ–ç”¨æˆ·åï¼‰
    messageTemplate?: string;     // æ¶ˆæ¯æ¨¡æ¿
  };

  // é‚®ä»¶é€šçŸ¥ä¸“ç”¨é…ç½®
  emailConfig?: {
    to: string[];                // æ”¶ä»¶äººåˆ—è¡¨
    subject?: string;            // é‚®ä»¶ä¸»é¢˜
    body?: string;               // é‚®ä»¶å†…å®¹
  };

  // ä¼ä¸šå¾®ä¿¡é€šçŸ¥ä¸“ç”¨é…ç½®
  wechatConfig?: {
    webhookUrl: string;          // Webhookåœ°å€
    message?: any;               // æ¶ˆæ¯å†…å®¹
  };
}
```

**é…ç½®é¢æ¿UI**ï¼š
```
â”Œâ”€ æ‰§è¡Œé€šçŸ¥èŠ‚ç‚¹é…ç½® â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ èŠ‚ç‚¹åç§°: [æ‰§è¡Œå‘Šè­¦é€šçŸ¥_______________]    â”‚
â”‚ æè¿°: [æ‰§è¡Œå¤šç§é€šçŸ¥æ–¹å¼_______________]â”‚
â”‚                                                â”‚
â”‚ â”Œâ”€ é€šçŸ¥æ–¹å¼1 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ é€šçŸ¥æ–¹å¼: [æœºå™¨äººé€šçŸ¥ â–¼]              â”‚  â”‚
â”‚  â”‚ [â˜‘] å¯ç”¨                               â”‚  â”‚
â”‚  â”‚ ä¼˜å…ˆçº§: [1]                            â”‚  â”‚
â”‚  â”‚                                       â”‚  â”‚
â”‚  â”‚ å‘é€ç±»å‹: [ä¸‹æ‹‰é€‰æ‹©]                   â”‚  â”‚
â”‚  â”‚   â— ç§å‘é€šçŸ¥ (éœ€è¦å¡«å†™ç”¨æˆ·å)          â”‚  â”‚
â”‚  â”‚   â—‹ ç¾¤å‘é€šçŸ¥ (éœ€è¦å¡«å†™ç¾¤å)            â”‚  â”‚
â”‚  â”‚                                       â”‚  â”‚
â”‚  â”‚ ç›®æ ‡åç§°: [{{userName}}___________]   â”‚  â”‚
â”‚  â”‚                                       â”‚  â”‚
â”‚  â”‚ æ¶ˆæ¯æ¨¡æ¿:                             â”‚  â”‚
â”‚  â”‚ [å‘Šè­¦é€šçŸ¥ï¼š{{originalMessage}}____]  â”‚  â”‚
â”‚  â”‚                                       â”‚  â”‚
â”‚  â”‚ [åˆ é™¤é€šçŸ¥æ–¹å¼]                        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                â”‚
â”‚ â”Œâ”€ é€šçŸ¥æ–¹å¼2 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ é€šçŸ¥æ–¹å¼: [å¼¹çª—é€šçŸ¥ â–¼]                â”‚  â”‚
â”‚  â”‚ [â˜‘] å¯ç”¨                               â”‚  â”‚
â”‚  â”‚ ä¼˜å…ˆçº§: [2]                            â”‚  â”‚
â”‚  â”‚                                       â”‚  â”‚
â”‚  â”‚ [åˆ é™¤é€šçŸ¥æ–¹å¼]                        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                â”‚
â”‚ [+ æ·»åŠ é€šçŸ¥æ–¹å¼]                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å®ç°é€»è¾‘**ï¼š
```javascript
async handleExecuteNotificationNode(node, context, input) {
  const { data } = node;
  const { notificationMethods } = data;

  const results = [];

  // 1. æŒ‰ä¼˜å…ˆçº§æ’åº
  const sortedMethods = notificationMethods
    .filter(m => m.enabled)
    .sort((a, b) => a.priority - b.priority);

  // 2. æ‰§è¡Œæ¯ä¸ªé€šçŸ¥æ–¹å¼
  for (const method of sortedMethods) {
    try {
      let result;

      switch (method.type) {
        case 'robot':
          result = await this.sendRobotNotification(method, context);
          break;
        case 'email':
          result = await this.sendEmailNotification(method, context);
          break;
        case 'wechat':
          result = await this.sendWeChatNotification(method, context);
          break;
        case 'popup':
          result = await this.sendPopupNotification(method, context);
          break;
        case 'sound':
          result = await this.playSoundNotification(method, context);
          break;
        default:
          result = { success: false, error: 'æœªçŸ¥çš„é€šçŸ¥æ–¹å¼' };
      }

      results.push({
        type: method.type,
        ...result
      });
    } catch (error) {
      results.push({
        type: method.type,
        success: false,
        error: error.message
      });
    }
  }

  // 3. è¿”å›æ‰§è¡Œç»“æœ
  return {
    success: true,
    notificationResults: results,
    context: {
      ...context,
      executionPath: [...context.executionPath, node.id],
      currentNodeId: node.id
    },
    message: `æ‰§è¡Œäº†${results.length}ä¸ªé€šçŸ¥ï¼ŒæˆåŠŸ${results.filter(r => r.success).length}ä¸ª`
  };
}

// å‘é€æœºå™¨äººé€šçŸ¥
async sendRobotNotification(method, context) {
  const { robotConfig } = method;

  // ç¡®å®šç›®æ ‡åç§°
  let targetName = robotConfig.targetName;
  if (!targetName) {
    if (robotConfig.sendType === 'private') {
      targetName = context.userName;
    } else {
      targetName = context.groupName;
    }
  }

  // æ„é€ æ¶ˆæ¯å†…å®¹
  let message = robotConfig.messageTemplate || '';
  message = this.renderTemplate(message, context);

  // è°ƒç”¨WorkToolæœåŠ¡å‘é€æ¶ˆæ¯
  const sendResult = await worktoolService.sendTextMessage(
    context.robotId,
    targetName,
    message,
    [] // @äººåˆ—è¡¨
  );

  return {
    success: sendResult.success,
    sendId: sendResult.sendId,
    targetName: targetName,
    message: message
  };
}

// å‘é€é‚®ä»¶é€šçŸ¥
async sendEmailNotification(method, context) {
  const { emailConfig } = method;

  // TODO: å®ç°é‚®ä»¶å‘é€
  return {
    success: false,
    error: 'é‚®ä»¶é€šçŸ¥åŠŸèƒ½å¾…å®ç°'
  };
}

// å‘é€ä¼ä¸šå¾®ä¿¡é€šçŸ¥
async sendWeChatNotification(method, context) {
  const { wechatConfig } = method;

  // TODO: å®ç°ä¼ä¸šå¾®ä¿¡é€šçŸ¥
  return {
    success: false,
    error: 'ä¼ä¸šå¾®ä¿¡é€šçŸ¥åŠŸèƒ½å¾…å®ç°'
  };
}
```

---

## ğŸ”§ å¹¶å‘å¤„ç†æœºåˆ¶

### é—®é¢˜ï¼šåŒæ—¶é—´å¾ˆå¤šæ¶ˆæ¯æ€ä¹ˆå¤„ç†ï¼Ÿ

### è§£å†³æ–¹æ¡ˆ1: æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆRedis Streamï¼‰

```javascript
// ç”Ÿäº§è€…ï¼šæ¥æ”¶æ¶ˆæ¯å¹¶æ¨é€åˆ°é˜Ÿåˆ—
async function handleWebhookMessage(message) {
  // 1. ç”ŸæˆmessageId
  const messageId = `msg_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;

  // 2. æ¨é€åˆ°Redis Stream
  await redis.xadd('message_queue', '*', {
    messageId,
    robotId: message.robotId,
    payload: JSON.stringify(message),
    timestamp: Date.now().toString()
  });

  // 3. ç«‹å³è¿”å›å“åº”ï¼ˆä¸é˜»å¡ï¼‰
  return {
    success: true,
    messageId,
    message: 'æ¶ˆæ¯å·²æ¥æ”¶ï¼Œæ­£åœ¨å¤„ç†'
  };
}

// æ¶ˆè´¹è€…ï¼šä»é˜Ÿåˆ—ä¸­æ¶ˆè´¹æ¶ˆæ¯
async function startMessageConsumer() {
  while (true) {
    const results = await redis.xreadgroup(
      'GROUP',
      'message_consumers',
      'consumer_1',
      'COUNT',
      10,
      'BLOCK',
      5000,
      'STREAMS',
      'message_queue',
      '>'
    );

    if (results && results.length > 0) {
      for (const result of results) {
        const [stream, messages] = result;
        for (const [id, fields] of messages) {
          // å¤„ç†æ¶ˆæ¯
          const payload = JSON.parse(fields.payload);
          await processMessage(payload);

          // ç¡®è®¤æ¶ˆæ¯
          await redis.xack('message_queue', 'message_consumers', id);
        }
      }
    }
  }
}
```

### è§£å†³æ–¹æ¡ˆ2: AIæ¨¡å‹é…ç½®ç­–ç•¥

#### ç­–ç•¥Aï¼šå•æœºå™¨äººä¸“ç”¨ï¼ˆæ¨èï¼‰
```javascript
// ç³»ç»Ÿè®¾ç½®
{
  "aiModels": {
    "robot_123": {
      "modelId": "model_service_123",
      "mode": "dedicated"  // ä¸“ç”¨æ¨¡å¼
    },
    "robot_456": {
      "modelId": "model_service_456",
      "mode": "dedicated"  // ä¸“ç”¨æ¨¡å¼
    }
  }
}

// å¤„ç†é€»è¾‘
async function getAIModel(robotId) {
  const config = await systemConfigService.getAIModelConfig(robotId);

  if (config.mode === 'dedicated') {
    // ä½¿ç”¨æœºå™¨äººä¸“ç”¨æ¨¡å‹
    return config.modelId;
  } else {
    // ä½¿ç”¨å…±äº«æ¨¡å‹
    return config.sharedModelId;
  }
}
```

#### ç­–ç•¥Bï¼šå¤šæœºå™¨äººå…±äº«
```javascript
// ç³»ç»Ÿè®¾ç½®
{
  "aiModels": {
    "shared": {
      "modelId": "model_service_shared",
      "mode": "shared",  // å…±äº«æ¨¡å¼
      "rateLimit": 100,   // æ¯ç§’æœ€å¤§è¯·æ±‚æ•°
      "concurrent": 10    // æœ€å¤§å¹¶å‘æ•°
    }
  }
}

// å¤„ç†é€»è¾‘
async function processWithSharedModel(robotId, message) {
  // ä½¿ç”¨é™æµå™¨æ§åˆ¶å¹¶å‘
  await rateLimiter.acquire();

  // è°ƒç”¨å…±äº«æ¨¡å‹
  const result = await aiService.generateReply(message);

  return result;
}
```

### æ¨èé…ç½®
| åœºæ™¯ | æ¨èç­–ç•¥ | è¯´æ˜ |
|------|---------|------|
| é«˜å¹¶å‘ï¼ˆ>100 QPSï¼‰ | æ¶ˆæ¯é˜Ÿåˆ— + å…±äº«æ¨¡å‹ | ä½¿ç”¨Redis Stream + å…±äº«AIæ¨¡å‹ |
| ä¸­ç­‰å¹¶å‘ï¼ˆ10-100 QPSï¼‰ | æ¶ˆæ¯é˜Ÿåˆ— + ä¸“ç”¨æ¨¡å‹ | ä½¿ç”¨Redis Stream + æ¯ä¸ªæœºå™¨äººä¸“ç”¨æ¨¡å‹ |
| ä½å¹¶å‘ï¼ˆ<10 QPSï¼‰ | ç›´æ¥å¤„ç† | ä¸éœ€è¦æ¶ˆæ¯é˜Ÿåˆ— |

---

## ğŸ” æ‰§è¡Œç»“æœéªŒè¯æœºåˆ¶

### é—®é¢˜ï¼šæœºå™¨äººæ‰§è¡Œç»“æœæ€ä¹ˆè·å–ï¼Ÿ

### æ¨æµ‹ï¼šåŸºäºæ–‡æ¡£çš„å¼‚æ­¥å›è°ƒæœºåˆ¶

æ ¹æ®æ–‡æ¡£æ¨æ–­ï¼Œæœºå™¨äººåº”è¯¥æ˜¯å¼‚æ­¥å›è°ƒæ‰§è¡Œç»“æœï¼š

1. **å‘é€æŒ‡ä»¤æ—¶**ï¼šè¿”å›`sendId`
2. **æœºå™¨äººæ‰§è¡Œå**ï¼šè‡ªåŠ¨å›è°ƒæˆ‘ä»¬çš„`/api/worktool/callback/command`æ¥å£
3. **æˆ‘ä»¬çš„å¤„ç†**ï¼šæ”¶åˆ°å›è°ƒåæ›´æ–°`robotCommands`è¡¨çŠ¶æ€

### å®ç°æ–¹æ¡ˆ

#### æ–¹æ¡ˆ1ï¼šå¼‚æ­¥å›è°ƒï¼ˆæ¨èï¼‰

```javascript
// 1. å‘é€æŒ‡ä»¤èŠ‚ç‚¹ï¼šè¿”å›sendId
async handleSendCommandNode(node, context, input) {
  const sendResult = await worktoolService.sendTextMessage(...);

  return {
    success: true,
    context: {
      ...context,
      sendId: sendResult.sendId,
      commandStatus: 'pending'  // ç­‰å¾…å›è°ƒ
    }
  };
}

// 2. æœºå™¨äººå›è°ƒæ¥å£ï¼šæ¥æ”¶æ‰§è¡Œç»“æœ
async function handleCommandCallback(req, res) {
  const { sendId, status, result } = req.body;

  // æ›´æ–°robotCommandsè¡¨
  await robotCommandService.updateCommandStatus(sendId, status, result);

  // WebSocketæ¨é€
  await websocketService.push('panel2', {
    type: 'command_result',
    data: {
      sendId,
      status,
      result
    }
  });

  res.json({ success: true });
}

// 3. æŒ‡ä»¤çŠ¶æ€è®°å½•èŠ‚ç‚¹ï¼šä»æ•°æ®åº“æŸ¥è¯¢çŠ¶æ€
async handleCommandStatusNode(node, context, input) {
  // æŸ¥è¯¢æŒ‡ä»¤çŠ¶æ€
  const command = await robotCommandService.getCommand(context.sendId);

  return {
    success: true,
    context: {
      ...context,
      commandStatus: command.status,
      commandResult: command.result
    }
  };
}
```

#### æ–¹æ¡ˆ2ï¼šè½®è¯¢æŸ¥è¯¢ï¼ˆå¤‡ç”¨ï¼‰

```javascript
// æŒ‡ä»¤çŠ¶æ€è®°å½•èŠ‚ç‚¹ï¼šå®šæ—¶è½®è¯¢çŠ¶æ€
async handleCommandStatusNode(node, context, input) {
  const maxRetries = 10;
  const retryDelay = 1000;

  for (let i = 0; i < maxRetries; i++) {
    // æŸ¥è¯¢æŒ‡ä»¤çŠ¶æ€
    const command = await robotCommandService.getCommand(context.sendId);

    if (command.status !== 'pending') {
      return {
        success: true,
        context: {
          ...context,
          commandStatus: command.status,
          commandResult: command.result
        }
      };
    }

    // ç­‰å¾…åé‡è¯•
    await new Promise(resolve => setTimeout(resolve, retryDelay));
  }

  // è¶…æ—¶
  return {
    success: false,
    context: {
      ...context,
      commandStatus: 'timeout'
    }
  };
}
```

### æ¨èæ–¹æ¡ˆ
**å¼‚æ­¥å›è°ƒ + è½®è¯¢æŸ¥è¯¢ï¼ˆæ··åˆï¼‰**
- ä¼˜å…ˆä½¿ç”¨å¼‚æ­¥å›è°ƒï¼ˆæ€§èƒ½å¥½ï¼‰
- å¦‚æœå›è°ƒè¶…æ—¶ï¼Œè‡ªåŠ¨åˆ‡æ¢åˆ°è½®è¯¢æŸ¥è¯¢ï¼ˆå¯é æ€§é«˜ï¼‰

---

## ğŸ¨ èŠ‚ç‚¹é…ç½®é¢æ¿è®¾è®¡æ€»ç»“

### ç»Ÿä¸€UIé£æ ¼
æ‰€æœ‰èŠ‚ç‚¹é…ç½®é¢æ¿éµå¾ªç»Ÿä¸€çš„UIé£æ ¼ï¼š

```
â”Œâ”€ [èŠ‚ç‚¹åç§°] é…ç½® â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ èŠ‚ç‚¹åç§°: [___________________]              â”‚
â”‚ æè¿°: [___________________]                  â”‚
â”‚                                                â”‚
â”‚ â”Œâ”€ [é…ç½®åŒºå—1] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ [å¤é€‰æ¡†] é…ç½®é¡¹1                       â”‚  â”‚
â”‚  â”‚ [ä¸‹æ‹‰é€‰æ‹©] é…ç½®é¡¹2                     â”‚  â”‚
â”‚  â”‚ [è¾“å…¥æ¡†] é…ç½®é¡¹3                       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                â”‚
â”‚ â”Œâ”€ [é…ç½®åŒºå—2] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ [å¤é€‰æ¡†] é…ç½®é¡¹4                       â”‚  â”‚
â”‚  â”‚ [ä¸‹æ‹‰é€‰æ‹©] é…ç½®é¡¹5                     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### é…ç½®é¡¹åˆ†ç±»
1. **åŸºç¡€é…ç½®**ï¼šèŠ‚ç‚¹åç§°ã€æè¿°
2. **åŠŸèƒ½é…ç½®**ï¼šæ ¸å¿ƒåŠŸèƒ½é…ç½®é¡¹
3. **é«˜çº§é…ç½®**ï¼šå¯é€‰çš„é«˜çº§åŠŸèƒ½
4. **æ—¥å¿—é…ç½®**ï¼šæ—¥å¿—è®°å½•é…ç½®

---

## ğŸ“Š å®Œæ•´ä¸šåŠ¡æµç¨‹ç¤ºä¾‹

### åœºæ™¯1ï¼šæ ‡å‡†å®¢æœæµç¨‹ï¼ˆ8ä¸ªèŠ‚ç‚¹ï¼‰

```
æ¶ˆæ¯æ¥æ”¶ â†’ æ„å›¾è¯†åˆ« â†’ å†³ç­–èŠ‚ç‚¹ â†’ AIå®¢æœå›å¤ â†’ æ¶ˆæ¯åˆ†å‘ â†’ å‘é€æŒ‡ä»¤ â†’ æŒ‡ä»¤çŠ¶æ€è®°å½• â†’ ç»“æŸ
(1)       (2)       (3)        (4)         (5)       (6)        (7)           (8)

ä¸Šä¸‹æ–‡å˜åŒ–ï¼š
1. message_receive: æ„é€ ä¸Šä¸‹æ–‡ + ä¿å­˜æ•°æ®åº“
2. intent: æ·»åŠ intent + intentConfidence
3. decision: åˆ¤æ–­åˆ†å‘åˆ°æ ‡å‡†å›å¤åˆ†æ”¯
4. ai_reply: æ·»åŠ aiResponse
5. message_dispatch: æ·»åŠ targetName
6. send_command: æ·»åŠ sendId + commandStatus
7. command_status: æ›´æ–°session_messagesè¡¨
8. end: æµç¨‹ç»“æŸ
```

### åœºæ™¯2ï¼šå‘Šè­¦å¤„ç†æµç¨‹ï¼ˆ10ä¸ªèŠ‚ç‚¹ï¼‰

```
æ¶ˆæ¯æ¥æ”¶ â†’ æ„å›¾è¯†åˆ« â†’ å†³ç­–èŠ‚ç‚¹ â†’ å‘Šè­¦å…¥åº“ â†’ å‘Šè­¦è§„åˆ™åˆ¤æ–­ â†’ æ‰§è¡Œé€šçŸ¥ â†’ AIå®¢æœå›å¤ â†’ æ¶ˆæ¯åˆ†å‘ â†’ å‘é€æŒ‡ä»¤ â†’ æŒ‡ä»¤çŠ¶æ€è®°å½• â†’ ç»“æŸ
(1)       (2)       (3)        (4)       (5)           (6)        (4)         (5)       (6)        (7)           (8)

ä¸Šä¸‹æ–‡å˜åŒ–ï¼š
1. message_receive: æ„é€ ä¸Šä¸‹æ–‡
2. intent: æ·»åŠ intent
3. decision: åˆ¤æ–­åˆ†å‘åˆ°å‘Šè­¦å¤„ç†åˆ†æ”¯
4. alert_save: æ·»åŠ alertId + alertLevel + alertCode
5. alert_rule: æ·»åŠ matchedRules
6. execute_notification: æ‰§è¡Œå¤šç§é€šçŸ¥
7. å›åˆ°ai_reply: ç”Ÿæˆé£é™©å›å¤
8. message_dispatch: æ·»åŠ targetName
9. send_command: æ·»åŠ sendId
10. command_status: æ›´æ–°æ•°æ®åº“
11. end: æµç¨‹ç»“æŸ
```

---

## âœ… æ€»ç»“

### æ ¸å¿ƒè®¾è®¡è¦ç‚¹

1. **ç»Ÿä¸€ä¸Šä¸‹æ–‡ä¼ é€’**
   - æ‰€æœ‰èŠ‚ç‚¹é€šè¿‡ä¸Šä¸‹æ–‡å¯¹è±¡ä¼ é€’ä¿¡æ¯
   - åŒ…å«å®Œæ•´çš„è¯†åˆ«ä¿¡æ¯ï¼ˆrobotId, sessionId, messageIdç­‰ï¼‰

2. **å¹¶å‘å¤„ç†æœºåˆ¶**
   - ä½¿ç”¨Redis Streamæ¶ˆæ¯é˜Ÿåˆ—
   - AIæ¨¡å‹æ”¯æŒä¸“ç”¨å’Œå…±äº«ä¸¤ç§æ¨¡å¼

3. **æ‰§è¡Œç»“æœéªŒè¯**
   - ä¼˜å…ˆä½¿ç”¨å¼‚æ­¥å›è°ƒ
   - å¤‡ç”¨è½®è¯¢æŸ¥è¯¢

4. **èŠ‚ç‚¹è®¾è®¡åŸåˆ™**
   - èŒè´£å•ä¸€
   - å¯é…ç½®
   - å¯è¿½æº¯

### 10ç§èŠ‚ç‚¹æ€»ç»“

| åºå· | èŠ‚ç‚¹åç§° | èŠ‚ç‚¹ä»£ç  | æ ¸å¿ƒèŒè´£ | é…ç½®é¡¹æ•°é‡ |
|-----|---------|---------|---------|----------|
| 1 | æ¶ˆæ¯æ¥æ”¶ä¸æ•°æ®åº“ä¿å­˜ | `message_receive` | æ¥æ”¶æ¶ˆæ¯ + æ„é€ ä¸Šä¸‹æ–‡ + ä¿å­˜æ•°æ®åº“ | 4ä¸ªé…ç½®åŒºå— |
| 2 | æ„å›¾AIåˆ†æ | `intent` | AIè¯†åˆ«æ„å›¾ | 4ä¸ªé…ç½®åŒºå— |
| 3 | å†³ç­–èŠ‚ç‚¹ | `decision` | åˆ¤æ–­åˆ†å‘ | 2ä¸ªé…ç½®åŒºå— |
| 4 | AIå®¢æœå›å¤ | `ai_reply` | ç”ŸæˆAIå›å¤ | 5ä¸ªé…ç½®åŒºå— |
| 5 | æ¶ˆæ¯åˆ†å‘ | `message_dispatch` | åˆ¤æ–­ç¾¤å‘/ç§å‘ | 4ä¸ªé…ç½®åŒºå— |
| 6 | å‘é€æŒ‡ä»¤ | `send_command` | å‘é€WorkToolæŒ‡ä»¤ | 4ä¸ªé…ç½®åŒºå— |
| 7 | æŒ‡ä»¤çŠ¶æ€è®°å½• | `command_status` | ä¿å­˜æŒ‡ä»¤çŠ¶æ€ | 3ä¸ªé…ç½®åŒºå— |
| 8 | ç»“æŸèŠ‚ç‚¹ | `end` | æµç¨‹ç»“æŸ | 0ä¸ªé…ç½®é¡¹ |
| 9 | å‘Šè­¦å…¥åº“ | `alert_save` | ä¿å­˜å‘Šè­¦ä¿¡æ¯ | 4ä¸ªé…ç½®åŒºå— |
| 10 | å‘Šè­¦è§„åˆ™åˆ¤æ–­ | `alert_rule` | åˆ¤æ–­å‘Šè­¦è§„åˆ™ | 2ä¸ªé…ç½®åŒºå— |
| 11 | æ‰§è¡Œé€šçŸ¥ | `execute_notification` | æ‰§è¡Œå¤šç§é€šçŸ¥ | 1ä¸ªé…ç½®åŒºå— |

### ç”¨æˆ·é—®é¢˜è§£ç­”

**Q1: å¦‚ä½•è¯†åˆ«æ˜¯å“ªä¸ªæœºå™¨äººå‘é€çš„ï¼Ÿ**
A: ä½¿ç”¨ç»Ÿä¸€ä¸Šä¸‹æ–‡å¯¹è±¡ï¼Œæ¯ä¸ªèŠ‚ç‚¹éƒ½åŒ…å«`robotId`ã€`sessionId`ã€`messageId`ç­‰è¯†åˆ«ä¿¡æ¯ã€‚

**Q2: åŒæ—¶é—´å¾ˆå¤šæ¶ˆæ¯æ€ä¹ˆå¤„ç†ï¼Ÿ**
A: ä½¿ç”¨Redis Streamæ¶ˆæ¯é˜Ÿåˆ—å¼‚æ­¥å¤„ç†ï¼ŒAIæ¨¡å‹æ”¯æŒä¸“ç”¨å’Œå…±äº«ä¸¤ç§æ¨¡å¼ã€‚

**Q3: æœºå™¨äººæ‰§è¡Œç»“æœæ€ä¹ˆè·å–ï¼Ÿ**
A: æœºå™¨äººå¼‚æ­¥å›è°ƒæ‰§è¡Œç»“æœåˆ°æˆ‘ä»¬çš„å›è°ƒæ¥å£ï¼Œæˆ‘ä»¬æ›´æ–°`robotCommands`è¡¨çŠ¶æ€ã€‚

**Q4: AIæ¨¡å‹é…ç½®ç­–ç•¥ï¼Ÿ**
A: æ”¯æŒå•æœºå™¨äººä¸“ç”¨å’Œå¤šæœºå™¨äººå…±äº«ä¸¤ç§æ¨¡å¼ï¼Œæ ¹æ®å¹¶å‘é‡é€‰æ‹©ã€‚

---

## ğŸš€ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

**è¯·ç¡®è®¤ï¼š**
1. âœ… ç»Ÿä¸€ä¸Šä¸‹æ–‡ä¼ é€’æœºåˆ¶æ˜¯å¦ç¬¦åˆéœ€æ±‚ï¼Ÿ
2. âœ… 10ç§èŠ‚ç‚¹è®¾è®¡æ˜¯å¦å®Œæ•´ï¼Ÿ
3. âœ… å¹¶å‘å¤„ç†æœºåˆ¶æ˜¯å¦å¯è¡Œï¼Ÿ
4. âœ… æ‰§è¡Œç»“æœéªŒè¯æ–¹æ¡ˆæ˜¯å¦åˆç†ï¼Ÿ
5. âœ… é…ç½®é¢æ¿UIè®¾è®¡æ˜¯å¦ç¬¦åˆè¦æ±‚ï¼Ÿ

**ç¡®è®¤åï¼Œæˆ‘å°†å¼€å§‹å®ç°ä»£ç ï¼**
