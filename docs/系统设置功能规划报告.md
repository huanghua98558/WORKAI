# WorkTool AI 2.1 - 系统设置功能规划与布局设计报告

## 📋 报告概述

**文档版本**：v1.0  
**创建日期**：2025-02-05  
**文档状态**：规划阶段（未开发）  
**规划范围**：系统设置功能的完整规划

---

## 1. 系统全景分析

### 1.1 系统架构概览

```
WorkTool AI 2.1 企业级机器人运营平台
│
├── 前端
│   ├── 仪表盘 - 系统概览、实时数据
│   ├── 会话管理 - 会话列表、业务消息监控
│   ├── 机器人管理 - 多机器人、负载均衡、角色管理
│   ├── 监控告警 - 业务消息监控、AI交互监控、告警规则
│   ├── AI模块 - AI模型、角色、话术模板、调试工具
│   ├── 流程引擎 - 流程定义、流程实例、节点配置
│   ├── 系统日志 - 日志查询、统计分析、日志管理
│   └── 系统设置 - 系统配置、功能开关、集成设置 ⭐
│
├── 后端
│   ├── 机器人管理 API (/api/admin/robots)
│   ├── 会话管理 API (/api/admin/sessions)
│   ├── AI服务 API (/api/ai/*)
│   ├── 流程引擎 API (/api/flow-engine/*)
│   ├── 监控告警 API (/api/monitoring/*, /api/alerts/*)
│   ├── 知识库 API (/api/knowledge/*)
│   ├── 通知服务 API (/api/notifications/*)
│   ├── 操作日志 API (/api/operation-logs/*)
│   └── 系统配置 API (/api/admin/config)
│
├── 核心能力
│   ├── AI智能回复系统（核心）
│   ├── 节点流程引擎（8节点）
│   ├── 全链路数据追踪
│   ├── 双监控面板
│   └── 高并发支持
│
└── 数据存储
    ├── PostgreSQL - 主数据库
    ├── Redis - 缓存+消息队列+限流
    └── S3 - 对象存储
```

### 1.2 现有导航结构

```
当前8个导航项：
1. 仪表盘 - 系统概览
2. 会话管理 - 会话列表 + 业务消息监控
3. 机器人管理 - 机器人管理
4. 监控告警 - 监控面板 + 告警管理
5. AI模块 - AI配置 + AI交互监控
6. 流程引擎 - 流程管理
7. 系统日志 - 日志管理
8. 系统设置 - 系统配置
```

---

## 2. 系统设置功能定位分析

### 2.1 需要移除的功能

#### ❌ **告警设置** 
**原因**：告警设置已经完整集成在"监控告警"模块中
- 告警规则管理：`/api/alerts/rules`
- 告警统计：`/api/alerts/stats`
- 告警历史：`/api/alerts/history`
- 通知方式配置：`/api/notifications/methods`

**现状**：
- 监控告警模块已经包含完整的告警管理功能
- 有独立的"告警规则"对话框
- 有通知方式设置（邮件、短信、企业微信等）

**结论**：系统设置中不需要告警设置功能

---

### 2.2 需要集成的功能

#### ✅ **系统日志**
**原因**：日志管理适合放在系统设置中，属于系统运维配置
**现状**：独立导航项"系统日志"
**整合方式**：作为系统设置的一个Tab页

**功能包含**：
- 日志查询（按级别、模块、时间、关键词）
- 日志统计分析
- 日志清理策略
- 日志导出
- 后端日志查看

---

### 2.3 需要保留的功能

#### ✅ **自动回复配置**
**原因**：自动回复是系统的核心配置，影响AI回复行为
**对接功能**：
1. **AI模块** - AI模型选择、角色配置
2. **流程引擎** - 决策节点使用自动回复配置
3. **话术模板** - 不同意图类型的回复模板

**详细分析**：

```
自动回复配置对接关系：
┌─────────────────────────────────────────────────┐
│           自动回复配置（系统设置）               │
│  ┌───────────────────────────────────────────┐  │
│  │ 闲聊配置                                   │  │
│  │ - 模式：AI/概率/固定/不回复                │  │
│  │ - 概率：0-100%                             │  │
│  │ - 固定话术                                 │  │
│  └───────────────────────────────────────────┘  │
│  ┌───────────────────────────────────────────┐  │
│  │ 服务配置                                   │  │
│  │ - 模式：AI/人工/不回复                     │  │
│  │ - AI模型选择（来自AI模块）                │  │
│  │ - 角色选择（来自AI模块）                  │  │
│  └───────────────────────────────────────────┘  │
│  ┌───────────────────────────────────────────┐  │
│  │ 风险配置                                   │  │
│  │ - 模式：人工/忽略/自动                     │  │
│  │ - 触发人工接管                            │  │
│  └───────────────────────────────────────────┘  │
└─────────────────────────────────────────────────┘
                    │
                    ├─→ AI模块：获取模型和角色
                    ├─→ 流程引擎：决策节点使用配置
                    └─→ 话术模板：不同意图的回复策略
```

**结论**：自动回复配置必须保留，是核心配置功能

---

## 3. 系统设置完整功能规划

### 3.1 功能架构设计

```
系统设置
│
├── Tab 1: 自动回复配置 ⭐
│   ├── 闲聊配置
│   │   ├── 闲聊模式（AI智能回复/概率回复/固定话术/不回复）
│   │   ├── 回复概率（0-100%）
│   │   └── 固定回复内容
│   │
│   ├── 服务配置
│   │   ├── 服务模式（AI自动回复/人工接管/不回复）
│   │   ├── AI模型选择（来自AI模块）
│   │   └── AI角色选择（来自AI模块）
│   │
│   ├── 风险配置
│   │   ├── 风险模式（人工接管/忽略/自动回复）
│   │   └── 触发条件
│   │
│   └── 其他意图配置
│       ├── 欢迎意图
│       ├── 帮助意图
│       └── 管理指令意图
│
├── Tab 2: AI配置 ⭐
│   ├── 默认AI模型
│   │   ├── 意图识别模型
│   │   ├── 服务回复模型
│   │   └── 闲聊模型
│   │
│   ├── 默认AI角色
│   │   ├── 服务咨询角色
│   │   ├── 闲聊角色
│   │   └── 转化客服角色
│   │
│   ├── AI预算控制
│   │   ├── 每日预算上限
│   │   ├── 单次成本上限
│   │   └── 超限策略（停止/降级/通知）
│   │
│   └── AI保护机制
│       ├── 限流配置
│       ├── 熔断配置
│       └── 重试策略
│
├── Tab 3: 流程配置 ⭐
│   ├── 流程引擎设置
│   │   ├── 默认流程
│   │   ├── 流程超时时间
│   │   ├── 错误重试次数
│   │   └── 流程版本管理
│   │
│   ├── 节点配置
│   │   ├── AI节点超时
│   │   ├── Webhook节点超时
│   │   └── 条件节点表达式
│   │
│   └── 流程模板管理
│       ├── 客服回复流程
│       ├── 告警流程
│       └── 指令执行流程
│
├── Tab 4: 系统日志 ⭐（从导航集成）
│   ├── 日志查询
│   │   ├── 按级别过滤（INFO/WARN/ERROR）
│   │   ├── 按模块过滤（机器人/AI/流程/监控等）
│   │   ├── 按时间范围
│   │   └── 关键词搜索
│   │
│   ├── 日志统计
│   │   ├── 各级别日志数量
│   │   ├── 各模块日志数量
│   │   └── 时间趋势分析
│   │
│   ├── 日志管理
│   │   ├── 日志清理策略（按天数）
│   │   ├── 批量删除
│   │   └── 日志导出（CSV/JSON）
│   │
│   └── 后端日志
│       ├── 查看后端运行日志
│       ├── 查看错误日志
│       └── 实时日志流
│
├── Tab 5: 数据管理 ⭐
│   ├── 数据备份
│   │   ├── 自动备份配置
│   │   ├── 备份频率（每天/每周）
│   │   ├── 保留策略
│   │   └── 手动备份
│   │
│   ├── 数据清理
│   │   ├── 消息历史清理
│   │   ├── 日志清理
│   │   ├── AI交互记录清理
│   │   └── 操作日志清理
│   │
│   └── 数据导出
│       ├── 会话数据导出
│       ├── 消息数据导出
│       ├── AI交互记录导出
│       └── 操作日志导出
│
├── Tab 6: 用户管理 ⭐
│   ├── 用户管理
│   │   ├── 用户列表（搜索、筛选、导出）
│   │   ├── 添加用户
│   │   ├── 编辑用户
│   │   ├── 重置密码
│   │   ├── 启用/禁用用户
│   │   └── 删除用户
│   │
│   ├── 角色管理
│   │   ├── 角色列表
│   │   ├── 添加角色
│   │   ├── 编辑角色
│   │   ├── 权限配置
│   │   └── 删除角色
│   │
│   ├── 权限管理
│   │   ├── 权限列表
│   │   ├── 权限分类（机器人/会话/AI/流程/监控/系统/用户）
│   │   └── 权限配置
│   │
│   ├── 登录管理
│   │   ├── 登录日志
│   │   ├── 在线用户
│   │   └── 登录历史
│   │
│   ├── 操作审计
│   │   ├── 操作日志
│   │   ├── 用户行为追踪
│   │   └── 安全审计
│   │
│   └── 安全设置
│       ├── 密码策略（最小长度、复杂度要求）
│       ├── 登录限制（最大尝试次数、锁定时间）
│       ├── 会话超时
│       ├── IP白名单
│       └── 双因素认证
│
├── Tab 7: 通知配置 ⭐
│   ├── 通知方式
│   │   ├── 邮件通知配置（SMTP）
│   │   ├── 短信通知配置（SMS）
│   │   ├── 企业微信通知配置（Webhook）
│   │   ├── 钉钉通知配置（Webhook）
│   │   └── 飞书通知配置（Webhook）
│   │
│   ├── 通知规则
│   │   ├── 通知触发条件
│   │   ├── 通知模板
│   │   └── 通知频率限制
│   │
│   └── 通知测试
│       ├── 测试邮件发送
│       ├── 测试短信发送
│       └── 测试企业微信发送
│
└── Tab 8: 高级设置 ⭐
    ├── 系统性能
    │   ├── 并发限制
    │   ├── 缓存策略
    │   └── 连接池配置
    │
    ├── 集成配置
    │   ├── 对象存储配置（S3）
    │   ├── 数据库配置（只读）
    │   └── Redis配置（只读）
    │
    ├── 调试模式
    │   ├── 开启/关闭调试日志
    │   ├── API响应详细信息
    │   └── 性能追踪
    │
    └── 系统信息
        ├── 系统版本
        ├── 运行时间
        ├── 数据库连接状态
        ├── Redis连接状态
        └── 磁盘使用情况
```

---

### 3.2 布局设计

```
┌─────────────────────────────────────────────────────────────────────┐
│  WorkTool AI 2.1 - 系统设置                                      │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │  标题栏                                                        │  │
│  │  ⚙️ 系统设置                                                  │  │
│  │  配置系统参数、自动回复、AI、流程、日志等                    │  │
│  │                                                              │  │
│  │  [刷新配置] [保存所有配置]                                   │  │
│  └───────────────────────────────────────────────────────────────┘  │
│                                                                     │
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │  Tab切换栏（横向）                                             │  │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐       │  │
│  │  │自动回复  │ │  AI配置  │ │ 流程配置  │ │ 系统日志  │ ... │  │
│  │  └──────────┘ └──────────┘ └──────────┘ └──────────┘       │  │
│  └───────────────────────────────────────────────────────────────┘  │
│                                                                     │
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │                                                               │  │
│  │  Tab内容区域（根据选择的Tab显示不同内容）                      │  │
│  │                                                               │  │
│  │  示例：自动回复配置                                            │  │
│  │  ┌─────────────────┬─────────────────┐                        │  │
│  │  │  闲聊配置       │  服务配置        │                        │  │
│  │  │  - 模式选择     │  - 模式选择     │                        │  │
│  │  │  - 概率设置     │  - AI模型选择   │                        │  │
│  │  │  - 固定话术     │  - AI角色选择   │                        │  │
│  │  │                 │                 │                        │  │
│  │  │  风险配置       │  其他意图配置   │                        │  │
│  │  │  - 模式选择     │  - 欢迎         │                        │  │
│  │  │  - 触发条件     │  - 帮助         │                        │  │
│  │  │                 │  - 管理指令     │                        │  │
│  │  └─────────────────┴─────────────────┘                        │  │
│  │                                                               │  │
│  └───────────────────────────────────────────────────────────────┘  │
│                                                                     │
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │  底部状态栏                                                    │  │
│  │  配置最后更新时间: 2025-02-05 14:30:00                        │  │
│  │  配置版本: v2.1.0                                              │  │
│  └───────────────────────────────────────────────────────────────┘  │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 4. 功能详细说明

### 4.1 自动回复配置（核心功能）

#### 功能说明
配置不同意图类型的自动回复策略，影响整个系统的AI回复行为。

#### 对接关系
- **AI模块**：获取可用的AI模型和AI角色
- **流程引擎**：决策节点读取自动回复配置进行路由
- **话术模板**：不同意图使用不同的回复模板

#### 配置项详细说明

| 配置项 | 类型 | 说明 | 默认值 | 对接功能 |
|--------|------|------|--------|----------|
| **闲聊模式** | 枚举 | AI智能回复/概率回复/固定话术/不回复 | AI智能回复 | AI模块 |
| **闲聊概率** | 数字 | 0-100，只在概率回复模式下生效 | 30% | - |
| **闲聊固定话术** | 文本 | 固定回复内容，只在固定话术模式下生效 | 您好！ | 话术模板 |
| **服务模式** | 枚举 | AI自动回复/人工接管/不回复 | AI自动回复 | AI模块 |
| **服务AI模型** | 选择器 | 服务咨询使用的AI模型 | 豆包-pro-4k | AI模块-模型管理 |
| **服务AI角色** | 选择器 | 服务咨询使用的AI角色 | 社群运营 | AI模块-角色管理 |
| **风险模式** | 枚举 | 人工接管/忽略/自动回复 | 人工接管 | 流程引擎 |
| **风险触发条件** | 文本 | 触发风险模式的关键词/规则 | 敏感词列表 | AI模块-意图识别 |
| **欢迎模式** | 枚举 | AI回复/固定话术/不回复 | AI回复 | AI模块 |
| **帮助模式** | 枚举 | AI回复/固定话术/不回复 | AI回复 | AI模块 |
| **管理指令模式** | 枚举 | AI回复/固定话术/不回复 | AI回复 | AI模块 |

---

### 4.2 AI配置

#### 功能说明
配置AI服务相关的全局参数，包括模型选择、角色配置、预算控制、保护机制等。

#### 配置项详细说明

| 配置项 | 类型 | 说明 | 默认值 | 对接功能 |
|--------|------|------|--------|----------|
| **意图识别模型** | 选择器 | 用于意图识别的AI模型 | 豆包-pro-4k | AI模块-模型管理 |
| **服务回复模型** | 选择器 | 用于服务回复的AI模型 | 豆包-pro-4k | AI模块-模型管理 |
| **闲聊模型** | 选择器 | 用于闲聊的AI模型 | 豆包-pro-4k | AI模块-模型管理 |
| **服务咨询角色** | 选择器 | 服务咨询使用的AI角色 | 社群运营 | AI模块-角色管理 |
| **闲聊角色** | 选择器 | 闲聊使用的AI角色 | 友好助手 | AI模块-角色管理 |
| **转化客服角色** | 选择器 | 转化客服使用的AI角色 | 转化客服 | AI模块-角色管理 |
| **每日预算上限** | 数字 | 每日AI调用成本上限（元） | 100 | AI模块-统计 |
| **单次成本上限** | 数字 | 单次AI调用成本上限（元） | 10 | AI模块-统计 |
| **超限策略** | 枚举 | 停止/降级/通知 | 降级 | AI模块-保护 |
| **限流QPS** | 数字 | 每秒最大请求数 | 10 | AI模块-保护 |
| **熔断阈值** | 数字 | 失败率达到此值触发熔断 | 0.5 | AI模块-保护 |
| **熔断恢复时间** | 数字 | 熔断后恢复时间（秒） | 60 | AI模块-保护 |
| **最大重试次数** | 数字 | 失败后最大重试次数 | 3 | AI模块-保护 |

---

### 4.3 流程配置

#### 功能说明
配置流程引擎的全局参数，影响流程执行行为。

#### 配置项详细说明

| 配置项 | 类型 | 说明 | 默认值 | 对接功能 |
|--------|------|------|--------|----------|
| **默认流程** | 选择器 | 新会话使用的默认流程 | 客服回复流程 | 流程引擎 |
| **流程超时时间** | 数字 | 流程执行超时时间（秒） | 300 | 流程引擎 |
| **错误重试次数** | 数字 | 节点执行失败后的重试次数 | 3 | 流程引擎 |
| **流程版本管理** | 开关 | 是否启用流程版本管理 | 开启 | 流程引擎 |
| **AI节点超时** | 数字 | AI节点执行超时时间（秒） | 30 | 流程引擎 |
| **Webhook节点超时** | 数字 | Webhook节点执行超时时间（秒） | 10 | 流程引擎 |
| **条件节点表达式** | 文本 | 条件节点支持的表达式语法 | JavaScript | 流程引擎 |

---

### 4.4 系统日志（集成）

#### 功能说明
集成现有的系统日志功能，提供日志查询、统计、管理和导出功能。

#### 功能清单
- ✅ 日志查询（按级别、模块、时间、关键词）
- ✅ 日志统计（各级别、各模块、时间趋势）
- ✅ 日志管理（清理策略、批量删除、导出）
- ✅ 后端日志（查看运行日志、错误日志、实时流）

#### 对接API
- `/api/system-logs` - 获取系统日志
- `/api/admin/logs/[logType]` - 获取指定类型日志
- `/api/operation-logs/*` - 操作日志管理

---

### 4.5 数据管理

#### 功能说明
提供数据备份、清理、导出功能，保证数据安全和系统性能。

#### 功能清单
- ✅ 自动备份配置
- ✅ 手动备份
- ✅ 数据清理策略
- ✅ 数据导出

#### 对接API
- 需要新增：
  - `/api/admin/backup` - 数据备份
  - `/api/admin/cleanup` - 数据清理
  - `/api/admin/export` - 数据导出

---

### 4.6 用户管理中心 ⭐

#### 功能说明
管理系统的用户、角色、权限，支持多人协作和权限隔离。

#### 功能架构
```
用户管理中心
│
├── 用户管理
│   ├── 用户列表
│   │   ├── 查看所有用户
│   │   ├── 搜索用户
│   │   ├── 筛选用户（按角色、状态）
│   │   └── 导出用户列表
│   │
│   ├── 添加用户
│   │   ├── 用户名（唯一）
│   │   ├── 密码
│   │   ├── 真实姓名
│   │   ├── 邮箱
│   │   ├── 手机号
│   │   ├── 角色
│   │   ├── 部门
│   │   └── 状态（启用/禁用）
│   │
│   ├── 编辑用户
│   │   ├── 修改用户信息
│   │   ├── 重置密码
│   │   ├── 修改角色
│   │   └── 启用/禁用用户
│   │
│   └── 删除用户
│       └── 删除用户及相关数据
│
├── 角色管理
│   ├── 角色列表
│   ├── 添加角色
│   ├── 编辑角色
│   ├── 删除角色
│   └── 权限配置
│
├── 权限管理
│   ├── 权限列表
│   ├── 权限分类
│   │   ├── 机器人管理权限
│   │   ├── 会话管理权限
│   │   ├── AI模块权限
│   │   ├── 流程引擎权限
│   │   ├── 监控告警权限
│   │   ├── 系统设置权限
│   │   └── 用户管理权限
│   ├── 添加权限
│   └── 删除权限
│
├── 登录管理
│   ├── 登录日志
│   ├── 在线用户
│   └── 登录历史
│
├── 操作审计
│   ├── 操作日志
│   ├── 用户行为追踪
│   └── 安全审计
│
└── 安全设置
    ├── 密码策略
    ├── 登录限制（IP白名单）
    ├── 会话超时
    ├── 双因素认证
    └── 安全日志
```

#### 预设角色

| 角色 | 说明 | 权限范围 |
|------|------|---------|
| **超级管理员** | 系统最高权限 | 所有权限 |
| **管理员** | 管理机器人、配置 | 机器人管理、系统设置 |
| **客服** | 处理用户消息 | 会话管理、消息历史 |
| **运营** | 数据分析、报表 | 监控面板、数据统计 |
| **开发者** | 调试、API开发 | 流程引擎、AI调试 |
| **只读用户** | 仅查看数据 | 查看权限，无操作权限 |

#### 权限矩阵

```
┌─────────────────────────────────────────────────────────────┐
│                      权限矩阵                               │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  权限模块              超管   管理员  客服   运营   开发    │
│  ───────────────────────────────────────────────────────   │
│  仪表盘               ✓     ✓      ✓     ✓     ✓         │
│  机器人管理           ✓     ✓      ✗     ✗     ✓         │
│  会话管理             ✓     ✓      ✓     ✓     ✓         │
│  AI模块               ✓     ✓      ✗     ✗     ✓         │
│  流程引擎             ✓     ✓      ✗     ✗     ✓         │
│  监控告警             ✓     ✓      ✓     ✓     ✓         │
│  系统日志             ✓     ✓      ✓     ✓     ✓         │
│  系统设置             ✓     ✓      ✗     ✗     ✗         │
│  用户管理             ✓     ✗      ✗     ✗     ✗         │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

#### 功能清单
- ✅ 用户管理（添加、编辑、删除、启用/禁用）
- ✅ 角色管理（创建、编辑、删除、权限配置）
- ✅ 权限管理（模块权限、操作权限）
- ✅ 登录管理（登录日志、在线用户）
- ✅ 操作审计（操作日志、行为追踪）
- ✅ 安全设置（密码策略、登录限制、会话超时）

#### 对接API
- 需要新增：
  - `/api/auth/login` - 用户登录
  - `/api/auth/logout` - 用户登出
  - `/api/auth/me` - 获取当前用户信息
  - `/api/auth/change-password` - 修改密码
  - `/api/admin/users` - 用户管理
  - `/api/admin/roles` - 角色管理
  - `/api/admin/permissions` - 权限管理
  - `/api/admin/operation-logs` - 操作日志

---

### 4.7 通知配置

#### 功能说明
配置系统通知方式，支持邮件、短信、企业微信、钉钉、飞书等多种通知方式。

#### 功能清单
- ✅ 邮件通知配置（SMTP）
- ✅ 短信通知配置（SMS）
- ✅ 企业微信通知配置（Webhook）
- ✅ 钉钉通知配置（Webhook）
- ✅ 飞书通知配置（Webhook）
- ✅ 通知规则配置
- ✅ 通知测试

#### 对接API
- 现有：
  - `/api/notifications/methods` - 通知方式管理
  - `/api/notifications/send` - 发送通知
  - `/api/notifications/test` - 测试通知

---

### 4.8 高级设置

#### 功能说明
配置系统高级参数，包括性能、集成、调试等。

#### 功能清单
- ✅ 系统性能（并发限制、缓存策略、连接池配置）
- ✅ 集成配置（S3、数据库、Redis，只读）
- ✅ 调试模式（调试日志、API详细信息、性能追踪）
- ✅ 系统信息（版本、运行时间、连接状态、磁盘使用）

#### 对接API
- 现有：
  - `/api/proxy/health` - 系统健康检查
  - `/api/proxy/ai/protection` - AI保护机制

---

## 5. 自动回复功能深度分析

### 5.1 为什么需要保留自动回复配置？

**理由1：系统核心功能**
- 自动回复是整个系统AI回复行为的控制中心
- 影响所有会话的回复策略
- 是用户体验的核心配置

**理由2：与多个模块深度耦合**
- AI模块：需要知道使用哪个模型和角色
- 流程引擎：决策节点根据自动回复配置进行路由
- 话术模板：不同意图使用不同模板
- 监控告警：根据自动回复策略触发告警

**理由3：灵活的业务需求**
- 不同企业需要不同的回复策略
- 需要根据场景灵活切换AI/人工/固定话术
- 需要控制成本和响应速度

### 5.2 自动回复与AI模块的关系

```
自动回复配置（控制策略）
    │
    ├─→ 选择AI模型 → AI模块（模型管理）
    │
    ├─→ 选择AI角色 → AI模块（角色管理）
    │
    └─→ 回复策略 → 流程引擎（决策节点）
```

**关键点**：
- 自动回复配置**选择**使用哪个AI模型和角色
- AI模型和角色的**管理**在AI模块中
- 自动回复配置**不直接管理**AI模型和角色
- 这是一个**配置-管理分离**的设计

### 5.3 自动回复与流程引擎的关系

```
流程引擎（执行层）
    │
    ├─→ 接收用户消息
    │
    ├─→ 意图识别节点 → AI模块
    │
    ├─→ 决策节点 → 读取自动回复配置
    │   │
    │   ├─→ 闲聊意图 → 闲聊配置 → AI节点
    │   ├─→ 服务意图 → 服务配置 → AI节点
    │   ├─→ 风险意图 → 风险配置 → 人工接管节点
    │   └─→ 其他意图 → 其他配置 → 对应节点
    │
    └─→ 回复节点 → 发送回复
```

**关键点**：
- 流程引擎**读取**自动回复配置
- 决策节点根据配置选择执行路径
- 自动回复配置**不直接控制**流程执行
- 这是一个**配置-执行分离**的设计

---

## 6. 导航优化建议

### 6.1 当前导航问题

```
当前导航（8项）：
1. 仪表盘
2. 会话管理
3. 机器人管理
4. 监控告警
5. AI模块
6. 流程引擎
7. 系统日志 ← 独立导航项，更适合放在系统设置
8. 系统设置
```

### 6.2 优化后的导航

```
优化后导航（7项）：
1. 仪表盘
2. 会话管理
3. 机器人管理
4. 监控告警
5. AI模块
6. 流程引擎
7. 系统设置 ← 系统日志集成到这里
```

**改动说明**：
- 移除"系统日志"独立导航项
- "系统日志"作为系统设置的一个Tab页
- 符合7±2原则，导航更清晰

---

## 7. 数据存储设计

### 7.1 系统配置表

```sql
CREATE TABLE system_configs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  config_key VARCHAR(100) UNIQUE NOT NULL,
  config_value JSONB NOT NULL,
  config_type VARCHAR(50) NOT NULL, -- 'autoreply' | 'ai' | 'flow' | 'log' | 'user' | 'notification' | 'advanced'
  description TEXT,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),
  version INTEGER DEFAULT 1
);

CREATE INDEX idx_system_configs_key ON system_configs(config_key);
CREATE INDEX idx_system_configs_type ON system_configs(config_type);
```

### 7.2 配置版本历史表

```sql
CREATE TABLE system_config_versions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  config_key VARCHAR(100) NOT NULL,
  config_value JSONB NOT NULL,
  version INTEGER NOT NULL,
  changed_by VARCHAR(100),
  change_reason TEXT,
  created_at TIMESTAMP DEFAULT NOW(),
  FOREIGN KEY (config_key) REFERENCES system_configs(config_key)
);

CREATE INDEX idx_config_versions_key ON system_config_versions(config_key);
CREATE INDEX idx_config_versions_created ON system_config_versions(created_at DESC);
```

### 7.3 用户管理数据库设计 ⭐

```sql
-- 用户表
CREATE TABLE users (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  username VARCHAR(50) UNIQUE NOT NULL,
  password_hash VARCHAR(255) NOT NULL,
  real_name VARCHAR(100),
  email VARCHAR(100),
  phone VARCHAR(20),
  avatar_url TEXT,
  department VARCHAR(100),
  status VARCHAR(20) DEFAULT 'active', -- 'active' | 'disabled' | 'deleted'
  last_login_at TIMESTAMP,
  last_login_ip VARCHAR(45),
  failed_login_attempts INTEGER DEFAULT 0,
  locked_until TIMESTAMP,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),
  created_by UUID,
  tenant_id UUID -- 多租户模式使用
);

CREATE INDEX idx_users_username ON users(username);
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_status ON users(status);

-- 角色表
CREATE TABLE roles (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name VARCHAR(50) UNIQUE NOT NULL,
  display_name VARCHAR(100),
  description TEXT,
  is_system BOOLEAN DEFAULT FALSE, -- 系统角色不可删除
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_roles_name ON roles(name);

-- 权限表
CREATE TABLE permissions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  module VARCHAR(50) NOT NULL, -- 模块名
  action VARCHAR(50) NOT NULL, -- 动作名
  resource VARCHAR(50), -- 资源名
  description TEXT,
  created_at TIMESTAMP DEFAULT NOW(),
  UNIQUE(module, action, resource)
);

CREATE INDEX idx_permissions_module ON permissions(module);

-- 角色权限关联表
CREATE TABLE role_permissions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  role_id UUID NOT NULL,
  permission_id UUID NOT NULL,
  created_at TIMESTAMP DEFAULT NOW(),
  FOREIGN KEY (role_id) REFERENCES roles(id) ON DELETE CASCADE,
  FOREIGN KEY (permission_id) REFERENCES permissions(id) ON DELETE CASCADE,
  UNIQUE(role_id, permission_id)
);

CREATE INDEX idx_role_permissions_role ON role_permissions(role_id);

-- 用户角色关联表
CREATE TABLE user_roles (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL,
  role_id UUID NOT NULL,
  created_at TIMESTAMP DEFAULT NOW(),
  created_by UUID,
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
  FOREIGN KEY (role_id) REFERENCES roles(id) ON DELETE CASCADE,
  UNIQUE(user_id, role_id)
);

CREATE INDEX idx_user_roles_user ON user_roles(user_id);

-- 登录日志表
CREATE TABLE login_logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID,
  username VARCHAR(50),
  ip VARCHAR(45),
  user_agent TEXT,
  login_status VARCHAR(20), -- 'success' | 'failed'
  failure_reason VARCHAR(255),
  created_at TIMESTAMP DEFAULT NOW(),
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE SET NULL
);

CREATE INDEX idx_login_logs_user ON login_logs(user_id);
CREATE INDEX idx_login_logs_created ON login_logs(created_at DESC);

-- 操作日志表（扩展现有）
CREATE TABLE operation_logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL,
  username VARCHAR(50),
  module VARCHAR(50),
  action VARCHAR(50),
  resource_id VARCHAR(100),
  details JSONB,
  ip VARCHAR(45),
  user_agent TEXT,
  created_at TIMESTAMP DEFAULT NOW(),
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE SET NULL
);

CREATE INDEX idx_operation_logs_user ON operation_logs(user_id);
CREATE INDEX idx_operation_logs_module ON operation_logs(module);
CREATE INDEX idx_operation_logs_created ON operation_logs(created_at DESC);
```

---

## 8. API设计

### 8.1 系统配置API

```
GET    /api/admin/config                    # 获取系统配置
POST   /api/admin/config                    # 保存系统配置
GET    /api/admin/config/history           # 获取配置历史
POST   /api/admin/config/rollback          # 配置回滚
POST   /api/admin/config/reset             # 重置配置为默认
```

### 8.2 系统日志API（已存在，集成）

```
GET    /api/system-logs                    # 获取系统日志
GET    /api/admin/logs/:type               # 获取指定类型日志
POST   /api/admin/logs/cleanup             # 清理日志
GET    /api/admin/logs/stats               # 日志统计
```

### 8.3 数据管理API（新增）

```
POST   /api/admin/backup                   # 创建备份
GET    /api/admin/backups                  # 获取备份列表
POST   /api/admin/backup/restore          # 恢复备份
POST   /api/admin/cleanup                  # 清理数据
POST   /api/admin/export                   # 导出数据
```

### 8.4 用户管理API（新增）

```
# 认证相关
POST   /api/auth/login                     # 用户登录
POST   /api/auth/logout                    # 用户登出
GET    /api/auth/me                        # 获取当前用户信息
POST   /api/auth/change-password           # 修改密码

# 用户管理
GET    /api/admin/users                    # 获取用户列表
POST   /api/admin/users                    # 创建用户
GET    /api/admin/users/:id                # 获取用户详情
PUT    /api/admin/users/:id                # 更新用户
DELETE /api/admin/users/:id                # 删除用户
POST   /api/admin/users/:id/reset-password # 重置密码
POST   /api/admin/users/:id/enable         # 启用用户
POST   /api/admin/users/:id/disable        # 禁用用户

# 角色管理
GET    /api/admin/roles                    # 获取角色列表
POST   /api/admin/roles                    # 创建角色
GET    /api/admin/roles/:id                # 获取角色详情
PUT    /api/admin/roles/:id                # 更新角色
DELETE /api/admin/roles/:id                # 删除角色
POST   /api/admin/roles/:id/permissions    # 配置角色权限

# 权限管理
GET    /api/admin/permissions              # 获取权限列表
GET    /api/admin/permissions/:id          # 获取权限详情

# 登录管理
GET    /api/admin/login-logs               # 获取登录日志
GET    /api/admin/online-users             # 获取在线用户

# 操作审计
GET    /api/admin/operation-logs           # 获取操作日志
GET    /api/admin/operation-logs/user/:id  # 获取用户操作日志
POST   /api/admin/operation-logs/clear-all # 清空操作日志
```

---

## 9. 实施建议

### 9.1 实施优先级

**P0（核心功能）**：
1. 自动回复配置优化
2. AI配置
3. 流程配置
4. 系统日志集成
5. 用户管理（用户、角色、权限）

**P1（重要功能）**：
6. 数据管理
7. 导航优化

**P2（可选功能）**：
8. 通知配置优化
9. 高级设置

### 9.2 实施步骤

**阶段1：基础重构（1-2天）**
1. 移除系统设置的"告警"Tab
2. 将系统日志集成到系统设置
3. 优化自动回复配置UI
4. 优化导航结构

**阶段2：功能增强（2-3天）**
5. 实现AI配置功能
6. 实现流程配置功能
7. 实现用户管理功能（用户、角色、权限）
8. 实现数据管理功能

**阶段3：测试和优化（1-2天）**
9. 功能测试
10. 性能测试
11. UI优化
12. 文档更新

### 9.3 注意事项

1. **保持向后兼容**：不要破坏现有功能
2. **配置版本管理**：支持配置回滚
3. **实时生效**：配置修改后立即生效（无需重启）
4. **数据验证**：确保配置数据的有效性
5. **权限控制**：敏感配置需要权限验证
6. **操作审计**：记录所有配置修改操作

---

## 10. 总结

### 10.1 核心观点

1. **系统设置是系统的控制中心**：集中管理所有系统级配置
2. **自动回复必须保留**：是核心配置，与AI模块和流程引擎深度耦合
3. **系统日志适合放在系统设置**：属于系统运维配置
4. **告警设置不需要**：已在监控告警模块中完整实现
5. **配置-管理分离**：系统设置配置参数，模块管理具体资源

### 10.2 功能清单

| Tab页 | 功能 | 优先级 | 是否新增 |
|--------|------|--------|----------|
| 自动回复 | 闲聊/服务/风险/其他意图配置 | P0 | 优化 |
| AI配置 | 模型/角色/预算/保护 | P0 | 新增 |
| 流程配置 | 流程/节点/模板 | P0 | 新增 |
| 系统日志 | 查询/统计/管理/导出 | P0 | 集成 |
| 用户管理 | 用户/角色/权限/审计 | P0 | 新增 |
| 数据管理 | 备份/清理/导出 | P1 | 新增 |
| 通知配置 | 邮件/短信/企微/钉钉/飞书 | P2 | 优化 |
| 高级设置 | 性能/集成/调试/信息 | P2 | 新增 |

### 10.3 导航优化

```
优化前：8个导航项
优化后：7个导航项

移除：系统日志（集成到系统设置）
```

---

**报告结束**

此报告提供了系统设置的完整规划，包括功能设计、布局设计、对接关系、实施建议等。建议先审阅此报告，确认规划后再进行开发。
