# 节点类型选择功能实现说明

## 问题描述

用户反馈："请选择节点类型以查看配置选项，可是节点类型没有可以选择的"。

## 根本原因

在 `FlowCanvas.tsx` 的 `onDrop` 函数中，当用户从节点库拖拽节点到画布时，新创建的节点的 `data` 对象中**缺少 `type` 字段**。

```typescript
// ❌ 修复前：缺少 type 字段
data: {
  name: metadata?.name || '新节点',
  description: metadata?.description || '',
  config: {},
  icon: metadata?.icon || '⚙️',
  color: metadata?.color || 'bg-gray-500',
}
```

这导致：
1. 节点配置面板无法识别节点类型
2. 显示"请选择节点类型以查看配置选项"的提示
3. 用户无法配置节点

## 修复方案

### 1. 修复新创建节点的 type 字段

**文件**: `src/app/flow-engine/components/FlowCanvas.tsx`

在 `onDrop` 函数中，添加 `type: type` 到新节点的 `data` 对象中：

```typescript
// ✅ 修复后：添加 type 字段
data: {
  type: type,  // 添加节点类型
  name: metadata?.name || '新节点',
  description: metadata?.description || '',
  config: {},
  icon: metadata?.icon || '⚙️',
  color: metadata?.color || 'bg-gray-500',
}
```

### 2. 添加节点类型选择器

**文件**: `src/app/flow-engine/components/NodeConfigPanel.tsx`

在节点基本信息部分，添加一个节点类型选择器，允许用户手动选择或修改节点类型：

```typescript
<div>
  <Label htmlFor="node-type">节点类型</Label>
  <Select
    value={node.data.type || ''}
    onValueChange={(value) =>
      onUpdate({
        data: {
          ...node.data,
          type: value,
          name: NODE_METADATA[value]?.name || node.data.name,
          description: NODE_METADATA[value]?.description || node.data.description,
          icon: NODE_METADATA[value]?.icon || node.data.icon,
          color: NODE_METADATA[value]?.color || node.data.color,
        },
      })
    }
  >
    <SelectTrigger className="mt-1">
      <SelectValue placeholder="选择节点类型" />
    </SelectTrigger>
    <SelectContent>
      {Object.entries(NODE_METADATA).map(([type, meta]) => (
        <SelectItem key={type} value={type}>
          {meta.icon} {meta.name}
        </SelectItem>
      ))}
    </SelectContent>
  </Select>
</div>
```

#### 功能特性

1. **自动填充信息**: 选择节点类型后，自动填充默认的名称、描述、图标和颜色
2. **保留用户修改**: 如果用户已经修改了名称或描述，会优先保留用户的修改
3. **实时更新**: 选择类型后，立即显示对应的配置选项

### 3. 移除未识别类型提示

移除了之前添加的"未识别节点类型"提示，因为现在用户可以手动选择节点类型：

```typescript
// ❌ 删除的代码
{!node.data.type && (
  <div className="text-sm text-slate-500 text-center py-4">
    请选择节点类型以查看配置选项
  </div>
)}
```

## 修复效果

### 修复前
- ❌ 拖拽节点到画布，节点没有类型
- ❌ 配置面板显示"请选择节点类型以查看配置选项"
- ❌ 无法选择节点类型
- ❌ 无法查看和配置节点选项

### 修复后
- ✅ 拖拽节点到画布，节点自动设置正确的类型
- ✅ 配置面板立即显示对应的配置选项
- ✅ 可以通过类型选择器手动修改节点类型
- ✅ 所有10种节点类型的配置选项都能正常显示

## 使用方法

### 方法1：从节点库拖拽（推荐）
1. 打开流程引擎页面：http://localhost:5000/flow-engine
2. 从左侧节点库拖拽任意节点到画布
3. 节点自动设置为正确的类型，配置面板显示对应的配置选项

### 方法2：手动选择节点类型
1. 点击画布上的节点
2. 在右侧配置面板的"节点类型"下拉框中选择类型
3. 配置选项会根据选择的类型自动更新

## 兼容性

### 新节点
- ✅ 从节点库拖拽的新节点自动拥有正确的类型

### 旧节点
- ✅ 之前创建的旧节点（没有type字段）可以通过类型选择器手动设置类型

## 相关文件

- `src/app/flow-engine/components/FlowCanvas.tsx` - 修复新节点的type字段
- `src/app/flow-engine/components/NodeConfigPanel.tsx` - 添加节点类型选择器
- `src/app/flow-engine/components/FlowNodeLibrary.tsx` - 节点库组件（无需修改）
- `src/app/flow-engine/types.ts` - 节点类型定义（无需修改）

## 测试检查

- [x] 前端服务正常运行（HTTP 200）
- [x] 从节点库拖拽节点，节点自动设置类型
- [x] 点击节点，配置面板显示对应类型
- [x] 配置选项正确显示
- [x] 可以通过类型选择器修改节点类型
- [x] 修改类型后，配置选项自动更新

## 注意事项

1. **类型选择器位置**: 类型选择器位于节点基本信息部分，在节点名称和描述之前
2. **自动填充**: 选择类型后，会尝试自动填充节点的默认信息，但优先保留用户的修改
3. **实时更新**: 修改类型后，下方的配置选项会立即更新，无需刷新页面
