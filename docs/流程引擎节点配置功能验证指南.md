# 流程引擎节点配置功能验证指南

## 📋 功能概述

流程引擎节点配置已实现完整的功能，包括：
1. ✅ 10种节点类型的详细配置选项
2. ✅ 节点配置自动更新到本地状态
3. ✅ 流程保存功能调用真实API
4. ✅ 节点配置保存到数据库

## 🔍 检查结果

### 1. 节点配置面板实现

已为所有10种节点类型实现了详细的配置选项：

#### 节点1：消息接收 (message_receive)
- ✅ 数据保存配置（保存到数据库、保存到上下文）
- ✅ 字段提取配置（messageId、sessionId、userName、groupName、roomType、atMe）
- ✅ WebSocket推送配置（启用实时推送、推送目标选择）

#### 节点2：意图识别 (intent)
- ✅ AI模型选择
- ✅ 温度参数配置
- ✅ 自定义系统提示词
- ✅ 意图过滤配置（service、help、chat、welcome、risk、spam）

#### 节点3：决策节点 (decision)
- ✅ 决策规则配置（JSON格式）
- ✅ 支持多条件判断

#### 节点4：AI客服回复 (ai_reply)
- ✅ 默认模型配置
- ✅ 上下文配置（包含历史消息、历史消息条数限制）

#### 节点5：消息分发 (message_dispatch)
- ✅ 群发配置（目标名称来源、自定义群名）
- ✅ 私发配置（目标名称来源、自定义私发目标）
- ✅ @机器人配置（是否必须@机器人、未@时的处理方式）

#### 节点6：发送指令 (send_command)
- ✅ 消息来源配置（AI回复、固定消息、消息模板、自定义变量）
- ✅ 固定消息内容配置
- ✅ 消息模板配置
- ✅ @人配置（启用@人功能、动态表达式）
- ✅ 重试配置（启用失败重试、最大重试次数、重试延迟）

#### 节点7：指令状态记录 (command_status)
- ✅ 保存配置（保存到robotCommands表、更新sessionMessages表）
- ✅ WebSocket推送配置（启用实时推送、推送目标选择）

#### 节点8：结束节点 (end)
- ✅ 无需配置（结束节点）

#### 节点9：告警入库 (alert_save)
- ✅ 告警类型配置（intent、keyword、frequency、custom）
- ✅ 意图类型配置
- ✅ 告警级别配置（critical、warning、info）
- ✅ 关键词列表配置

#### 节点10：告警规则判断 (alert_rule)
- ✅ 告警规则配置（JSON格式）

### 2. 配置保存机制

#### 前端保存流程
```typescript
1. 用户修改节点配置
   ↓
2. handleConfigChange 更新 config 状态
   ↓
3. 调用 onUpdate 回调
   ↓
4. 更新 flow 状态中的节点数据
   ↓
5. 点击"保存流程"按钮
   ↓
6. handleSaveFlow 函数
   ↓
7. 调用 /api/flow-engine/definitions POST API
   ↓
8. 后端保存到 flow_engine_definitions 表
```

#### 数据保存格式
```json
{
  "id": "flow_1234567890",
  "name": "客服处理流程",
  "description": "处理用户消息的客服流程",
  "status": "active",
  "triggerType": "webhook",
  "triggerConfig": {},
  "nodes": [
    {
      "id": "node_1",
      "type": "message_receive",
      "position": { "x": 100, "y": 100 },
      "data": {
        "name": "消息接收",
        "description": "接收WorkTool消息",
        "config": {
          "saveToDatabase": true,
          "saveToContext": true,
          "extractFields": {
            "messageId": true,
            "sessionId": true,
            "userName": true,
            "groupName": true,
            "roomType": true,
            "atMe": true
          },
          "enableWebSocketPush": true,
          "pushTarget": "both"
        }
      }
    },
    {
      "id": "node_2",
      "type": "intent",
      "position": { "x": 300, "y": 100 },
      "data": {
        "name": "意图识别",
        "description": "AI识别用户意图",
        "config": {
          "modelId": "default",
          "temperature": 0.1,
          "systemPrompt": "你是一个意图识别专家...",
          "allowedIntents": ["service", "help", "chat", "welcome", "risk", "spam"]
        }
      }
    }
  ],
  "edges": [
    {
      "id": "edge_1",
      "source": "node_1",
      "target": "node_2"
    }
  ]
}
```

### 3. 后端调用机制

根据设计文档，流程执行时会调用节点配置：

#### 消息接收节点执行
```javascript
async handleMessageReceiveNode(node, context) {
  const config = node.data.config;

  // 1. 提取字段
  if (config.extractFields) {
    context.messageId = extractField(context.message, 'messageId');
    context.sessionId = extractField(context.message, 'sessionId');
    // ... 其他字段
  }

  // 2. 保存到数据库
  if (config.saveToDatabase) {
    await sessionMessageService.saveUserMessage(
      context.sessionId,
      { ... },
      context.messageId,
      robot
    );
  }

  // 3. WebSocket推送
  if (config.enableWebSocketPush) {
    await websocketService.push(config.pushTarget, message);
  }

  return { success: true, context };
}
```

#### 意图识别节点执行
```javascript
async handleIntentNode(node, context) {
  const config = node.data.config;
  const userMessage = context.message?.spoken || context.userMessage;

  // 1. 获取AI服务
  const aiService = await AIServiceFactory.createServiceByModelId(config.modelId);

  // 2. 调用意图识别
  const result = await aiService.recognizeIntent(userMessage, {
    temperature: config.temperature,
    systemPrompt: config.systemPrompt,
    allowedIntents: config.allowedIntents
  });

  return {
    success: true,
    intent: result.intent,
    confidence: result.confidence,
    context: { ...context, intent: result.intent }
  };
}
```

#### 发送指令节点执行
```javascript
async handleSendCommandNode(node, context) {
  const config = node.data.config;

  // 1. 获取消息内容
  let message;
  if (config.messageSource === 'ai_response') {
    message = context.aiResponse;
  } else if (config.messageSource === 'fixed') {
    message = replaceVariables(config.fixedMessage, context);
  } else if (config.messageSource === 'template') {
    message = replaceVariables(config.messageTemplate, context);
  }

  // 2. 获取发送目标
  let target;
  if (context.groupName) {
    target = context.groupName;
  }

  // 3. @人列表
  let atList = [];
  if (config.enableAtList) {
    atList = parseExpression(config.dynamicAtListExpression, context);
  }

  // 4. 发送消息（带重试）
  await sendWithRetry(
    () => worktoolService.sendTextMessage(
      context.robotId,
      target,
      message,
      atList
    ),
    config.maxRetries,
    config.retryDelay
  );

  return { success: true, context };
}
```

## 🎯 验证步骤

### 前端验证

1. **访问流程引擎页面**
   - URL: http://localhost:5000/flow-engine

2. **创建新节点**
   - 从左侧节点库拖拽节点到画布

3. **配置节点**
   - 点击节点打开右侧配置面板
   - 修改节点名称和描述
   - 根据节点类型配置详细选项

4. **验证配置更新**
   - 修改配置后，检查配置是否实时更新
   - 查看浏览器控制台是否有日志输出

5. **保存流程**
   - 点击"保存流程"按钮
   - 查看浏览器控制台的请求日志
   - 验证请求格式是否正确

6. **检查保存结果**
   - 查看返回的响应数据
   - 验证流程ID是否正确
   - 检查节点配置是否完整保存

### 后端验证

1. **查看数据库**
   ```sql
   SELECT * FROM flow_engine_definitions
   WHERE name = '流程名称';
   ```

2. **验证节点配置**
   - 检查 `nodes` 字段（JSON格式）
   - 验证每个节点的 `config` 字段是否包含所有配置项

3. **测试流程执行**
   - 触发流程执行
   - 查看后端日志，验证节点是否正确读取配置

## 📝 注意事项

### 配置更新时机
- ✅ 配置通过 `onUpdate` 回调实时更新到 `flow` 状态
- ✅ 修改配置后，无需手动点击"保存"按钮（流程保存按钮）
- ✅ 点击"保存流程"按钮会保存整个流程（包括所有节点配置）

### 配置数据格式
- 所有配置项都存储在 `node.data.config` 对象中
- 配置使用扁平结构，便于访问和修改
- 复杂配置（如规则、列表）使用JSON格式

### API接口
- **创建/更新流程**: `POST /api/flow-engine/definitions`
- **获取流程列表**: `GET /api/flow-engine/definitions`
- **获取流程详情**: `GET /api/flow-engine/definitions/{id}`
- **删除流程**: `DELETE /api/flow-engine/definitions/{id}`

## 🔧 已优化内容

### 1. 流程保存功能
- ✅ 实现真实的API调用
- ✅ 添加数据验证（流程名称、描述必填）
- ✅ 正确转换数据格式（符合后端要求）
- ✅ 错误处理和用户提示

### 2. 节点配置保存
- ✅ 配置自动更新到本地状态
- ✅ 保存按钮提示用户保存整个流程
- ✅ 配置数据正确传递到后端

### 3. 数据格式转换
- ✅ 节点数据格式转换（符合API要求）
- ✅ 边数据格式转换（包含所有必要字段）
- ✅ 流程元数据字段转换

## 🚀 下一步优化建议

1. **添加流程测试功能**
   - 前端模拟流程执行
   - 验证节点配置是否正确应用

2. **添加配置校验**
   - 必填项检查
   - 格式验证
   - 逻辑一致性检查

3. **添加配置导入/导出**
   - 支持从JSON文件导入节点配置
   - 支持导出节点配置为JSON

4. **添加配置模板**
   - 预设常用节点配置模板
   - 快速应用标准配置

## 📚 相关文档

- [流程引擎优化设计方案 v3.0](docs/流程引擎优化设计方案_v3_基于架构联动.md)
- [节点流程与监控面板完整设计文档](docs/节点流程与监控面板完整设计文档.md)
- [AI模块与流程引擎架构关系分析](docs/AI模块与流程引擎架构关系分析.md)
