# å¯è§†åŒ–æµç¨‹ç¼–æ’ä¼˜åŒ–

## ä¼˜åŒ–ç›®æ ‡

1. åˆ é™¤ç‹¬ç«‹é¡µé¢ `/flow-engine/page.tsx`
2. ä¿ç•™ä¸»é¡µ `/flow-engine-manage.tsx` ä¸­çš„åˆ›å»ºæµç¨‹å¯è§†åŒ–ç¼–è¾‘å™¨å…¥å£
3. ä¿®å¤ä¿å­˜æµç¨‹åæ‰“å¼€æ—¶èŠ‚ç‚¹è¯¦æƒ…ä¸¢å¤±çš„é—®é¢˜

## é—®é¢˜åˆ†æ

### é—®é¢˜1ï¼šèŠ‚ç‚¹è¯¦æƒ…ä¸¢å¤±

**æ ¹æœ¬åŸå› **ï¼š

èŠ‚ç‚¹ç±»å‹çš„æ•°æ®ç»“æ„ä¸ä¸€è‡´å¯¼è‡´èŠ‚ç‚¹è¯¦æƒ…ä¸¢å¤±ï¼š

1. **FlowCanvas ç»„ä»¶**ï¼ˆåŸºäº React Flowï¼‰ï¼š
   - React Flow çš„ `node.type` æ˜¯ `'custom'`ï¼ˆè‡ªå®šä¹‰èŠ‚ç‚¹ç±»å‹ï¼‰
   - ä¸šåŠ¡èŠ‚ç‚¹ç±»å‹å­˜å‚¨åœ¨ `node.data.type` ä¸­ï¼ˆå¦‚ `'message_receive'`, `'intent'` ç­‰ï¼‰

2. **FlowEditor ç»„ä»¶**ï¼ˆä¸šåŠ¡é€»è¾‘ï¼‰ï¼š
   - `NodeData` ç±»å‹å®šä¹‰ä¸­ï¼Œ`type` å­—æ®µè¡¨ç¤ºä¸šåŠ¡èŠ‚ç‚¹ç±»å‹
   - ä¸ FlowCanvas çš„å®é™…ä½¿ç”¨ä¸ä¸€è‡´

3. **ä¿å­˜æµç¨‹æ—¶**ï¼š
   - `convertToBackendNodes` å‡½æ•°ä½¿ç”¨ `node.type`
   - å¯¼è‡´ä¿å­˜çš„èŠ‚ç‚¹ç±»å‹å˜æˆ `'custom'` è€Œä¸æ˜¯å®é™…çš„ä¸šåŠ¡èŠ‚ç‚¹ç±»å‹

### é—®é¢˜2ï¼šèŠ‚ç‚¹ä½ç½®ä¿¡æ¯ä¸¢å¤±

**æ ¹æœ¬åŸå› **ï¼š

1. **FlowNode æ¥å£**ï¼šç¼ºå°‘ `position` å­—æ®µ
2. **convertToEditorNodes å‡½æ•°**ï¼šæ²¡æœ‰ä½¿ç”¨åç«¯è¿”å›çš„ `position` ä¿¡æ¯ï¼Œè€Œæ˜¯ä½¿ç”¨è®¡ç®—å‡ºçš„å›ºå®šä½ç½®

## ä¿®å¤æ–¹æ¡ˆ

### 1. åˆ é™¤ç‹¬ç«‹é¡µé¢ âœ…

```bash
rm -f src/app/flow-engine/page.tsx
```

ä¿ç•™ä»¥ä¸‹æ–‡ä»¶ï¼š
- `src/app/flow-engine/components/` - FlowEditor ç»„ä»¶ä¾èµ–çš„ç»„ä»¶
- `src/app/flow-engine/types.ts` - èŠ‚ç‚¹ç±»å‹å®šä¹‰
- `src/components/flow-engine-editor.tsx` - æµç¨‹ç¼–è¾‘å™¨æ ¸å¿ƒç»„ä»¶

### 2. ä¿®å¤ FlowNode æ¥å£ âœ…

**æ–‡ä»¶**: `src/lib/api/flow-engine.ts`

æ·»åŠ  `position` å­—æ®µï¼š

```typescript
export interface FlowNode {
  id: string;
  type: string;
  name: string;
  config?: Record<string, any>;
  position?: { x: number; y: number };  // â† æ–°å¢
}
```

### 3. ä¿®å¤ convertToEditorNodes å‡½æ•° âœ…

**æ–‡ä»¶**: `src/components/flow-engine-manage.tsx`

ä½¿ç”¨åç«¯è¿”å›çš„ `position` ä¿¡æ¯ï¼š

```typescript
const convertToEditorNodes = (flowNodes: FlowNode[]) => {
  return flowNodes.map((node, index) => ({
    id: node.id,
    type: 'custom',  // React Flow èŠ‚ç‚¹ç±»å‹
    position: node.position || {  // â† ä½¿ç”¨åç«¯è¿”å›çš„ä½ç½®
      x: 100 + (index % 3) * 250,
      y: 100 + Math.floor(index / 3) * 150
    },
    data: {
      type: node.type,  // ä¸šåŠ¡èŠ‚ç‚¹ç±»å‹
      name: node.name,
      description: '',
      config: node.config || {},
    },
  }));
};
```

### 4. ä¿®å¤ convertToBackendNodes å‡½æ•° âœ…

**æ–‡ä»¶**: `src/components/flow-engine-manage.tsx`

ä½¿ç”¨ `node.data.type` ä½œä¸ºä¸šåŠ¡èŠ‚ç‚¹ç±»å‹ï¼š

```typescript
const convertToBackendNodes = (editorNodes: any[]) => {
  return editorNodes.map(node => ({
    id: node.id,
    type: node.data.type || node.type,  // â† ä½¿ç”¨ node.data.type
    name: node.data.name,
    config: node.data.config || {},
    position: node.position,  // â† ä¿å­˜ä½ç½®ä¿¡æ¯
  }));
};
```

### 5. æ›´æ–° FlowEditor çš„ NodeData ç±»å‹ âœ…

**æ–‡ä»¶**: `src/components/flow-engine-editor.tsx`

ç»Ÿä¸€æ•°æ®ç»“æ„ï¼š

```typescript
// èŠ‚ç‚¹æ•°æ®ç±»å‹ï¼ˆé€‚é… React Flowï¼‰
export interface NodeData {
  id: string;
  type: string;  // React Flow èŠ‚ç‚¹ç±»å‹ï¼ˆ'custom'ï¼‰
  position: { x: number; y: number };
  data: {
    type: string;  // ä¸šåŠ¡èŠ‚ç‚¹ç±»å‹ï¼ˆ'message_receive', 'intent' ç­‰ï¼‰
    name: string;
    description?: string;
    config?: Record<string, any>;
    icon?: string;
    color?: string;
  };
}
```

### 6. æ›´æ–° NodeConfigPanel ç»„ä»¶ âœ…

**æ–‡ä»¶**: `src/app/flow-engine/components/NodeConfigPanel.tsx`

1. æ›´æ–° props ç±»å‹ï¼š
```typescript
interface NodeData {
  id: string;
  type: string;  // React Flow èŠ‚ç‚¹ç±»å‹
  position: { x: number; y: number };
  data: {
    type: string;  // ä¸šåŠ¡èŠ‚ç‚¹ç±»å‹
    name: string;
    description?: string;
    config?: Record<string, any>;
    icon?: string;
    color?: string;
  };
}
```

2. ä½¿ç”¨ `node.data.type` åˆ¤æ–­èŠ‚ç‚¹ç±»å‹ï¼š
```typescript
{node.data.type === 'message_receive' && (
  <MessageReceiveConfig config={config} onChange={handleConfigChange} />
)}
```

3. æ›´æ–°èŠ‚ç‚¹ç±»å‹é€‰æ‹©å™¨ï¼š
```typescript
<Select
  value={node.data.type || ''}
  onValueChange={(value) =>
    onUpdate({
      data: {
        ...node.data,
        type: value,  // â† æ›´æ–° data.type
        // ...
      },
    })
  }
>
```

### 7. ä¿®å¤ simulateFlowExecution å‡½æ•° âœ…

**æ–‡ä»¶**: `src/components/flow-engine-editor.tsx`

ä½¿ç”¨ `node.data.type` è€Œä¸æ˜¯ `node.type`ï¼š

```typescript
for (const node of flowData.nodes) {
  results.push({
    nodeId: node.id,
    nodeName: node.data.name,
    nodeType: node.data.type,  // â† ä½¿ç”¨ data.type
    status: 'running',
    // ...
  });

  // æ ¹æ®èŠ‚ç‚¹ç±»å‹è¿”å›ä¸åŒçš„ç»“æœ
  switch (node.data.type) {  // â† ä½¿ç”¨ data.type
    case 'message_receive':
      // ...
  }
}
```

### 8. ä¿®å¤åˆ›å»ºæµç¨‹çš„æ•°æ®ä¼ é€’ âœ…

**æ–‡ä»¶**: `src/components/flow-engine-manage.tsx`

ä½¿ç”¨ `convertToBackendNodes` è€Œä¸æ˜¯æ‰‹åŠ¨è½¬æ¢ï¼š

```typescript
onSave={async (flow) => {
  await handleCreateFlow({
    id: flow.id,
    name: flow.name,
    description: flow.description,
    status: 'active',
    trigger_type: flow.triggerType,
    trigger_config: {},
    version: '1.0.0',
    nodes: convertToBackendNodes(flow.nodes),  // â† ä½¿ç”¨è½¬æ¢å‡½æ•°
  });
}}
```

## æ•°æ®ç»“æ„è¯´æ˜

### FlowCanvas (React Flow)

```typescript
{
  id: 'node_1',
  type: 'custom',  // React Flow èŠ‚ç‚¹ç±»å‹
  position: { x: 100, y: 100 },
  data: {
    type: 'message_receive',  // ä¸šåŠ¡èŠ‚ç‚¹ç±»å‹
    name: 'æ¶ˆæ¯æ¥æ”¶',
    description: 'æ¥æ”¶WorkToolæ¶ˆæ¯',
    config: { /* é…ç½®æ•°æ® */ },
    icon: 'ğŸ“¥',
    color: 'bg-green-500',
  },
}
```

### åç«¯ API (FlowNode)

```typescript
{
  id: 'node_1',
  type: 'message_receive',  // ä¸šåŠ¡èŠ‚ç‚¹ç±»å‹
  name: 'æ¶ˆæ¯æ¥æ”¶',
  config: { /* é…ç½®æ•°æ® */ },
  position: { x: 100, y: 100 },
}
```

### FlowEditor (NodeData)

```typescript
{
  id: 'node_1',
  type: 'custom',  // React Flow èŠ‚ç‚¹ç±»å‹
  position: { x: 100, y: 100 },
  data: {
    type: 'message_receive',  // ä¸šåŠ¡èŠ‚ç‚¹ç±»å‹
    name: 'æ¶ˆæ¯æ¥æ”¶',
    description: 'æ¥æ”¶WorkToolæ¶ˆæ¯',
    config: { /* é…ç½®æ•°æ® */ },
    icon: 'ğŸ“¥',
    color: 'bg-green-500',
  },
}
```

## ä¿®å¤æ•ˆæœ

### ä¿®å¤å‰

- âŒ èŠ‚ç‚¹ç±»å‹ä¿å­˜ä¸º `'custom'`ï¼Œä¸¢å¤±ä¸šåŠ¡èŠ‚ç‚¹ç±»å‹
- âŒ èŠ‚ç‚¹é…ç½®ä¿¡æ¯ä¸¢å¤±
- âŒ èŠ‚ç‚¹ä½ç½®ä¿¡æ¯ä¸¢å¤±
- âŒ ç¼–è¾‘æµç¨‹æ—¶èŠ‚ç‚¹è¯¦æƒ…æ— æ³•æ­£ç¡®æ˜¾ç¤º
- âŒ å­˜åœ¨ç‹¬ç«‹é¡µé¢ï¼Œé€ æˆæ··æ·†

### ä¿®å¤å

- âœ… èŠ‚ç‚¹ç±»å‹æ­£ç¡®ä¿å­˜ä¸ºä¸šåŠ¡èŠ‚ç‚¹ç±»å‹ï¼ˆå¦‚ `'message_receive'`ï¼‰
- âœ… èŠ‚ç‚¹é…ç½®ä¿¡æ¯æ­£ç¡®ä¿å­˜å’ŒåŠ è½½
- âœ… èŠ‚ç‚¹ä½ç½®ä¿¡æ¯æ­£ç¡®ä¿å­˜å’ŒåŠ è½½
- âœ… ç¼–è¾‘æµç¨‹æ—¶èŠ‚ç‚¹è¯¦æƒ…æ­£ç¡®æ˜¾ç¤º
- âœ… åˆ é™¤ç‹¬ç«‹é¡µé¢ï¼Œç»Ÿä¸€ä½¿ç”¨ä¸»é¡µå¯¹è¯æ¡†

## æ³¨æ„äº‹é¡¹

1. **èŠ‚ç‚¹ç±»å‹åŒºåˆ†**ï¼š
   - React Flow èŠ‚ç‚¹ç±»å‹ï¼š`node.type`ï¼ˆå§‹ç»ˆä¸º `'custom'`ï¼‰
   - ä¸šåŠ¡èŠ‚ç‚¹ç±»å‹ï¼š`node.data.type`ï¼ˆå¦‚ `'message_receive'`, `'intent'` ç­‰ï¼‰

2. **æ•°æ®è½¬æ¢**ï¼š
   - FlowEditor â†’ åç«¯ï¼šä½¿ç”¨ `convertToBackendNodes` å‡½æ•°
   - åç«¯ â†’ FlowEditorï¼šä½¿ç”¨ `convertToEditorNodes` å‡½æ•°

3. **èŠ‚ç‚¹é…ç½®**ï¼š
   - èŠ‚ç‚¹é…ç½®å­˜å‚¨åœ¨ `node.data.config` ä¸­
   - ä½¿ç”¨ `node.data.type` åˆ¤æ–­èŠ‚ç‚¹ç±»å‹ä»¥æ˜¾ç¤ºå¯¹åº”çš„é…ç½®é¡¹

## ç›¸å…³æ–‡ä»¶

- `src/lib/api/flow-engine.ts` - FlowNode æ¥å£å®šä¹‰
- `src/components/flow-engine-manage.tsx` - æµç¨‹ç®¡ç†ç»„ä»¶
- `src/components/flow-engine-editor.tsx` - æµç¨‹ç¼–è¾‘å™¨æ ¸å¿ƒç»„ä»¶
- `src/app/flow-engine/components/FlowCanvas.tsx` - æµç¨‹ç”»å¸ƒç»„ä»¶
- `src/app/flow-engine/components/NodeConfigPanel.tsx` - èŠ‚ç‚¹é…ç½®é¢æ¿
- `src/app/flow-engine/components/CustomNode.tsx` - è‡ªå®šä¹‰èŠ‚ç‚¹ç»„ä»¶
- `src/app/flow-engine/types.ts` - èŠ‚ç‚¹ç±»å‹å®šä¹‰
