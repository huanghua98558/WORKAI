# WorkTool AI 中枢系统 - 构造说明书

## 1. 系统概述

### 1.1 系统定位
WorkTool AI 中枢系统是一个基于企业微信的智能服务型 AI 中枢系统，通过 AI 能力识别用户意图、自动回复、监控告警，实现智能化的群组管理和用户服务。

### 1.2 核心功能
- **AI 意图识别**：识别用户消息的意图类型（服务请求、闲聊、风险、垃圾信息等）
- **智能回复**：根据意图类型自动生成合适的回复
- **监控告警**：实时监控群组消息，对异常情况（风险内容、垃圾信息、管理指令）触发告警
- **机器人管理**：管理多个企业微信机器人，支持配置和调度
- **会话管理**：维护用户与 AI 的会话上下文，支持多轮对话
- **执行追踪**：追踪每个请求的执行过程，便于调试和优化
- **数据统计**：提供系统运行数据的统计和分析

---

## 2. 系统架构

### 2.1 整体架构图

```
┌─────────────────────────────────────────────────────────┐
│                      用户层                               │
│  企业微信群聊 / 用户私聊                                   │
└────────────────────┬────────────────────────────────────┘
                     │ WorkTool Webhook
                     ↓
┌─────────────────────────────────────────────────────────┐
│                   接入层 (API Gateway)                    │
│  Fastify Server (Port 5001)                              │
│  - 认证授权                                              │
│  - 请求路由                                              │
│  - 限流防护                                              │
└────────────┬────────────────────────────────────┬────────┘
             │                                    │
             ↓                                    ↓
┌──────────────────────┐           ┌──────────────────────┐
│    业务逻辑层        │           │    告警系统层         │
│  - 消息处理服务     │           │  - 告警规则引擎      │
│  - AI 意图识别      │           │  - 通知分发服务      │
│  - 会话管理         │           │  - 告警去重          │
│  - 决策引擎         │           │  - 告警升级          │
└──────┬──────────────┘           └──────────────────────┘
       │
       ├─────────────────────────────────────────┐
       │                                         │
       ↓                                         ↓
┌──────────────┐                       ┌──────────────────┐
│  数据访问层  │                       │  外部服务集成    │
│  - Drizzle ORM                       │  - WorkTool API  │
│  - Redis 缓存 │                       │  - AI 服务 (大模型)│
│  - PostgreSQL│                       │  - 对象存储      │
└──────────────┘                       └──────────────────┘
       │
       ↓
┌──────────────┐
│  数据存储层  │
│  - PostgreSQL│
│  - Redis     │
│  - 对象存储  │
└──────────────┘
```

### 2.2 技术栈

#### 前端技术栈
- **框架**：Next.js 16.1.1 (App Router)
- **UI 库**：React 19.2.3
- **UI 组件**：shadcn/ui (基于 Radix UI)
- **样式**：Tailwind CSS 4
- **表单**：react-hook-form + zod
- **图表**：recharts
- **编辑器**：Monaco Editor
- **HTTP 客户端**：axios

#### 后端技术栈
- **框架**：Fastify 5.7.2
- **数据库 ORM**：Drizzle ORM 0.45.1
- **数据库**：PostgreSQL 8.16.3
- **缓存**：Redis (ioredis 5.9.2)
- **AI 集成**：OpenAI SDK 6.17.0
- **HTTP 客户端**：axios
- **对象存储**：AWS S3 SDK
- **数据验证**：zod

#### 开发工具
- **包管理器**：pnpm 9.0.0
- **TypeScript**：5.x
- **运行环境**：Node.js 24

---

## 3. 前端架构

### 3.1 目录结构

```
src/
├── app/                          # Next.js App Router 页面
│   ├── alerts/                   # 告警管理页面
│   │   ├── center/              # 告警中心
│   │   └── rules/               # 告警规则管理
│   ├── admin/                    # 管理后台
│   ├── ai/                       # AI 配置
│   ├── api/                      # API 路由（前端代理）
│   │   └── alerts/              # 告警相关 API 代理
│   ├── monitoring/               # 监控仪表盘
│   ├── robots/                   # 机器人管理
│   └── sessions/                 # 会话管理
├── components/                   # 可复用组件
│   ├── ui/                       # shadcn/ui 基础组件
│   ├── ai/                       # AI 相关组件
│   ├── monitoring/               # 监控相关组件
│   └── ...                       # 其他业务组件
├── lib/                          # 工具库
└── public/                       # 静态资源
```

### 3.2 核心组件

#### 3.2.1 监控组件
- **MonitoringPage**: 主监控页面，展示实时告警和系统状态
- **AlertRulesDialog**: 告警规则管理对话框
- **NotificationSettingsDialog**: 通知设置对话框
- **MonitoringAlertCard**: 告警卡片组件

#### 3.2.2 AI 配置组件
- **IntentConfigDialog**: 意图配置对话框
- **PromptEditor**: 提示词编辑器

### 3.3 状态管理

- 使用 React 内置状态管理（useState, useEffect）
- 局部状态为主，暂未使用全局状态管理库

### 3.4 API 代理层

前端通过 Next.js API Routes 代理后端请求，解决 CORS 问题：
```
前端请求 → /api/* → Next.js Route → 后端 5001 端口
```

---

## 4. 后端架构

### 4.1 目录结构

```
server/
├── app.js                        # 应用入口
├── routes/                       # API 路由
│   ├── admin.api.js             # 管理后台 API
│   ├── ai-io.api.js             # AI 输入输出 API
│   ├── alert-config.api.js      # 告警配置 API
│   ├── alert-enhanced.api.js    # 增强告警 API
│   ├── qa.api.js                # 问答 API
│   ├── robot-command.api.js     # 机器人指令 API
│   ├── worktool.callback.js     # WorkTool 回调处理
│   └── ...                      # 其他路由
├── services/                     # 业务逻辑服务
│   ├── ai.service.js            # AI 服务
│   ├── message-processing.service.js  # 消息处理服务
│   ├── session.service.js       # 会话管理服务
│   ├── alert-config.service.js  # 告警配置服务
│   ├── alert-trigger.service.js # 告警触发服务
│   ├── notification.service.js  # 通知服务
│   ├── decision.service.js      # 决策引擎服务
│   ├── execution-tracker.service.js # 执行追踪服务
│   └── ...                      # 其他服务
├── lib/                          # 工具库
│   ├── config.js                # 配置管理
│   ├── logger.js                # 日志管理
│   └── redis.js                 # Redis 客户端
└── database/                     # 数据库相关
    ├── schema.js                # 数据库表定义
    └── migrations/              # 数据库迁移脚本
```

### 4.2 核心服务

#### 4.2.1 消息处理服务 (message-processing.service.js)
**职责**：统一消息处理流程

**流程**：
```
用户消息 → 解析消息内容 → 获取/创建会话 → 添加到上下文
    → 保存用户消息 → AI 意图识别 → 告警检查（如需要）
    → 决策是否回复 → 生成回复 → 发送回复 → 保存回复
    → 执行追踪完成
```

#### 4.2.2 AI 服务 (ai.service.js)
**职责**：提供 AI 相关能力

**核心方法**：
- `recognizeIntent()`: 识别消息意图
- `generateReply()`: 生成回复内容
- `analyzeContent()`: 分析内容（风险、垃圾信息等）

#### 4.2.3 会话管理服务 (session.service.js)
**职责**：管理用户与 AI 的会话

**功能**：
- 创建会话
- 添加上下文
- 获取会话
- 维护会话超时

#### 4.2.4 告警系统服务
##### alert-config.service.js
**职责**：告警配置管理

**核心方法**：
- `getAlertRuleByIntent()`: 获取意图对应的告警规则
- `upsertAlertRule()`: 创建或更新告警规则
- `deleteAlertRuleById()`: 删除告警规则
- `updateAlertRuleById()`: 更新告警规则

##### alert-trigger.service.js
**职责**：告警触发逻辑

**核心方法**：
- `shouldTriggerAlert()`: 判断是否应该触发告警
- `triggerAlert()`: 触发告警
- `formatAlertMessage()`: 格式化告警消息

##### notification.service.js
**职责**：通知分发

**支持的通知方式**：
- 机器人通知（企业微信群聊/私聊）
- 声音通知
- 桌面弹窗
- 企业微信通知
- 其他通知方式（邮件、短信等预留）

#### 4.2.5 决策引擎服务 (decision.service.js)
**职责**：决策是否回复以及回复方式

**决策因素**：
- 意图类型
- 用户历史行为
- 会话上下文
- 机器人配置
- 人工干预状态

#### 4.2.6 执行追踪服务 (execution-tracker.service.js)
**职责**：追踪请求执行过程

**追踪步骤**：
- user_message: 用户消息
- intent_recognition: 意图识别
- decision: 决策
- ai_reply: AI 回复
- send_reply: 发送回复

---

## 5. 数据库设计

### 5.1 核心表结构

#### 5.1.1 intent_configs（意图配置表）
```javascript
{
  id: varchar(36) PK,
  intentType: varchar(50) UNIQUE,  // 意图类型: service, help, chat, welcome, risk, spam, admin, keyword
  intentName: varchar(100),         // 意图名称
  intentDescription: text,         // 意图描述
  systemPrompt: text,              // 系统提示词
  isEnabled: boolean,              // 是否启用
  createdAt: timestamp,
  updatedAt: timestamp
}
```

#### 5.1.2 alert_rules（告警规则表）
```javascript
{
  id: varchar(36) PK,
  intentType: varchar(50),          // 关联的意图类型
  ruleName: varchar(255),           // 规则名称
  isEnabled: boolean,               // 是否启用
  alertLevel: varchar(20),          // 告警级别: critical, warning, info
  threshold: integer,               // 触发阈值
  cooldownPeriod: integer,          // 冷却时间（秒）
  messageTemplate: text,            // 消息模板
  keywords: text,                   // 关键词（keyword 类型使用）
  groupId: varchar(36),             // 告警分组 ID
  enableEscalation: boolean,        // 是否启用升级
  escalationLevel: integer,         // 当前升级级别
  escalationThreshold: integer,     // 最大升级次数
  escalationInterval: integer,      // 升级间隔（秒）
  escalationConfig: jsonb,          // 升级配置
  createdAt: timestamp,
  updatedAt: timestamp
}
```

#### 5.1.3 notification_methods（通知方式配置表）
```javascript
{
  id: varchar(36) PK,
  alertRuleId: varchar(36) FK,      // 关联告警规则
  methodType: varchar(50),          // 通知方式: robot, sound, desktop, wechat, dingtalk, feishu
  isEnabled: boolean,               // 是否启用
  recipientConfig: jsonb,           // 接收人配置
  messageTemplate: text,            // 消息模板
  priority: integer,                // 优先级
  createdAt: timestamp,
  updatedAt: timestamp
}
```

#### 5.1.4 alert_history（告警历史表）
```javascript
{
  id: varchar(36) PK,
  sessionId: varchar(255),          // 会话 ID
  alertRuleId: varchar(36) FK,      // 告警规则 ID
  intentType: varchar(50),          // 意图类型
  alertLevel: varchar(20),          // 告警级别
  groupId: varchar(255),            // 群组 ID
  groupName: varchar(255),          // 群组名称
  alertMessage: text,               // 告警消息
  notificationStatus: varchar(20),  // 通知状态
  status: varchar(20),              // 告警状态
  createdAt: timestamp
}
```

#### 5.1.5 其他重要表
- **robots**: 机器人配置表
- **sessions**: 会话表（Redis 中）
- **session_messages**: 会话消息表
- **execution_steps**: 执行追踪步骤表
- **operation_logs**: 操作日志表

### 5.2 数据库索引

**已创建的索引**：
- intent_configs: intent_type, is_enabled
- alert_rules: intent_type, alert_level, is_enabled, group_id
- notification_methods: alert_rule_id, method_type, is_enabled, priority

---

## 6. 核心业务流程

### 6.1 消息处理完整流程

```
1. WorkTool 推送消息到后端 Webhook
   ↓
2. worktool.callback.js 接收并验证消息
   ↓
3. message-processing.service.js 开始处理
   ↓
4. 解析消息内容（用户、群组、@机器人、消息内容等）
   ↓
5. 获取或创建会话（session.service.js）
   ↓
6. 添加消息到会话上下文
   ↓
7. 保存用户消息到数据库（session-message.service.js）
   ↓
8. AI 意图识别（ai.service.js）
   ↓
9. 检查是否需要告警（alert-trigger.service.js）
   - 如果需要触发告警：
     - 检查规则是否启用
     - 检查是否在冷却期
     - 触发告警
     - 分发通知
   ↓
10. 决策是否回复（decision.service.js）
    - 根据意图类型
    - 根据用户历史
    - 根据会话上下文
    ↓
11. 如果需要回复：
    - 生成 AI 回复（ai.service.js）
    - 发送回复到 WorkTool（worktool.service.js）
    - 保存回复到数据库
    ↓
12. 完成执行追踪（execution-tracker.service.js）
```

### 6.2 告警触发流程

```
1. 消息处理完成后，检查是否需要告警
   ↓
2. 根据意图类型查找对应的告警规则
   ↓
3. 检查规则是否启用
   ↓
4. 检查是否在冷却期内（Redis）
   ↓
5. 如果满足触发条件：
   - 生成告警记录（alertHistory）
   - 查找通知方式
   - 分发通知（notification.service.js）
   ↓
6. 通知分发流程：
   - 获取通知配置
   - 根据通知类型发送通知
   - 机器人通知：调用 WorkTool API
   - 声音通知：触发前端播放
   - 桌面弹窗：通过 WebSocket 推送
   ↓
7. 记录通知结果
```

### 6.3 AI 意图识别流程

```
1. 接收用户消息
   ↓
2. 构造 AI 请求上下文：
   - 用户消息内容
   - 用户历史消息（最近 5 条）
   - 会话信息
   - 用户画像（如果有）
   - 意图配置（systemPrompt）
   ↓
3. 调用大模型 API
   ↓
4. 解析 AI 返回结果：
   - intent: 意图类型
   - confidence: 置信度
   - reasoning: 推理过程（可选）
   ↓
5. 返回意图识别结果
```

---

## 7. API 接口设计

### 7.1 后端 API（端口 5001）

#### 告警相关
- `GET /api/alerts/rules` - 获取所有告警规则
- `POST /api/alerts/rules` - 创建或更新告警规则
- `PUT /api/alerts/rules/:id` - 更新指定告警规则
- `DELETE /api/alerts/rules/:id` - 删除告警规则
- `GET /api/alerts/rules/:ruleId/notifications` - 获取通知方式
- `POST /api/notifications/test` - 测试通知

#### 意图相关
- `GET /api/ai/intents` - 获取所有意图配置
- `GET /api/ai/intents/:intentType` - 获取指定意图配置
- `POST /api/ai/intents` - 创建或更新意图配置
- `PUT /api/ai/intents/:intentType` - 更新意图配置

#### 会话相关
- `GET /api/sessions/:sessionId` - 获取会话信息
- `GET /api/admin/sessions/active` - 获取活跃会话

#### 系统相关
- `GET /api/alerts/stats` - 获取告警统计
- `GET /health` - 健康检查

### 7.2 前端 API 代理（端口 5000）

前端通过 Next.js API Routes 代理后端请求，路径结构与后端一致。

---

## 8. 部署架构

### 8.1 端口分配
- **前端服务**：5000 端口（Next.js）
- **后端服务**：5001 端口（Fastify）
- **系统服务**：9000 端口（禁止使用）

### 8.2 启动脚本
- `pnpm dev` - 开发环境启动
- `pnpm build` - 构建生产版本
- `pnpm start` - 启动生产环境

### 8.3 环境配置
- `.coze` 文件定义构建和运行命令
- 支持 `.env` 环境变量配置

---

## 9. 系统特性

### 9.1 已实现特性
✅ AI 意图识别（基于大模型）  
✅ 自动回复生成  
✅ 告警规则配置  
✅ 多种通知方式（机器人、声音、弹窗、企业微信）  
✅ 会话上下文管理  
✅ 执行过程追踪  
✅ 告警去重和冷却  
✅ 告警升级机制  
✅ 实时监控仪表盘  
✅ 历史记录查询  

### 9.2 可扩展特性
📋 邮件通知（预留接口）  
📋 短信通知（预留接口）  
📋 钉钉通知（预留接口）  
📋 飞书通知（预留接口）  
📋 更多告警规则类型（通过扩展 intentType）  

---

## 10. 系统限制和约束

### 10.1 技术限制
- 使用 PostgreSQL 作为主数据库，必须使用数据库模式（不支持纯内存模式）
- Redis 可选，如不可用会降级到内存模式
- 必须通过 Fastify 框架处理 HTTP 请求
- 必须使用 Drizzle ORM 进行数据库操作

### 10.2 业务限制
- 每个意图类型只能有一个启用的告警规则（通过 intentType 唯一性约束）
- 告警冷却时间最少 1 秒
- 消息模板支持变量替换，但需要遵循固定格式
- 机器人通知需要预先配置 WorkToken

---

## 11. 日志和监控

### 11.1 日志系统
- 使用自定义日志服务（system-logger.service.js）
- 日志级别：INFO, WARN, ERROR
- 日志存储：数据库 + 控制台输出

### 11.2 执行追踪
- 使用 execution-tracker.service.js 追踪每个请求
- 记录每个步骤的开始时间、结束时间、状态
- 支持查询历史执行记录

### 11.3 监控指标
- 活跃会话数
- 告警触发次数
- 机器人状态
- 系统响应时间

---

## 12. 安全机制

### 12.1 接口安全
- 使用 @fastify/helmet 添加安全头
- 使用 @fastify/rate-limit 实现限流
- CORS 配置（开发环境允许所有域名）

### 12.2 数据安全
- 数据库连接使用 SSL（生产环境建议）
- 敏感信息通过环境变量配置
- 不在代码中硬编码密钥和 Token

### 12.3 业务安全
- 告警冷却机制防止频繁告警
- 去重机制防止重复通知
- 输入验证使用 zod schema

---

## 13. 性能优化

### 13.1 缓存策略
- Redis 缓存会话数据（TTL 2小时）
- 意图配置缓存（内存）
- 机器人配置缓存（内存）

### 13.2 数据库优化
- 合理使用索引
- 分页查询
- 连接池管理

### 13.3 异步处理
- 非阻塞的消息处理
- 异步通知分发
- WebSocket 实时推送

---

## 14. 开发规范

### 14.1 代码规范
- 使用 TypeScript（后端使用 JSDoc）
- 统一的错误处理
- 详细的注释和文档

### 14.2 命名规范
- 文件名：kebab-case（如 alert-config.service.js）
- 函数名：camelCase（如 getAlertRules）
- 常量名：UPPER_SNAKE_CASE（如 MAX_RETRIES）

### 14.3 Git 规范
- 使用 Conventional Commits 格式
- 提交前运行类型检查
- 保持提交历史清晰

---

## 15. 维护和扩展

### 15.1 添加新的意图类型
1. 在 intent_configs 表中添加配置
2. 在 alert_rules 表中创建对应规则
3. 更新前端意图类型选项
4. 添加对应的 systemPrompt

### 15.2 添加新的通知方式
1. 在 notification_methods 表中添加配置
2. 在 notification.service.js 中实现发送逻辑
3. 更新前端通知方式选项

### 15.3 添加新的告警规则类型
1. 扩展 intentType 枚举
2. 在 alert-rule-engine.service.js 中添加检查逻辑
3. 更新前端规则类型选项

---

## 16. 技术债务和已知问题

### 16.1 技术债务
- 部分服务依赖全局状态，不利于测试
- 错误处理不够统一
- 缺少集成测试
- 日志格式不够标准化

### 16.2 已知问题
- Redis 连接失败时降级到内存模式，重启后数据丢失
- 某些场景下 WebSocket 连接可能不稳定
- 大量并发请求时可能出现性能瓶颈

---

## 17. 未来规划

### 17.1 短期规划
- 完善单元测试和集成测试
- 优化日志系统
- 改进错误处理机制
- 添加性能监控和告警

### 17.2 中期规划
- 支持多租户
- 支持 AI 模型切换
- 优化数据库查询性能
- 添加更多告警规则类型

### 17.3 长期规划
- 支持分布式部署
- 实现高可用架构
- 支持 AI 模型微调
- 建立完整的数据分析平台

---

## 18. 联系和支持

### 18.1 文档资源
- 项目根目录：/workspace/projects/
- 技术文档：docs/ 目录
- API 文档：待完善

### 18.2 问题反馈
- 通过项目 Issue 反馈问题
- 定期更新文档和示例

---

## 附录

### A. 环境变量配置
```
DATABASE_URL=postgresql://...
REDIS_URL=redis://...
WORKTOOL_API_URL=...
WORKTOOL_API_TOKEN=...
AI_API_KEY=...
AI_API_BASE_URL=...
```

### B. 数据库迁移
```bash
# 生成迁移文件
pnpm drizzle-kit generate

# 执行迁移
pnpm drizzle-kit migrate

# 推送 schema
pnpm drizzle-kit push
```

### C. 常用命令
```bash
# 开发模式
pnpm dev

# 构建生产版本
pnpm build

# 启动生产环境
pnpm start

# 类型检查
pnpm ts-check
```

---

**文档版本**：v1.0  
**最后更新**：2026-02-04  
**维护者**：开发团队
