# ååŒåˆ†ææ¿å—ä¼˜åŒ–å‡çº§æ–¹æ¡ˆ

## ğŸ“Š ç›®å½•
- [ä¸€ã€ç°çŠ¶åˆ†æ](#ä¸€ç°çŠ¶åˆ†æ)
- [äºŒã€ä¼˜åŒ–å»ºè®®](#äºŒä¼˜åŒ–å»ºè®®)
- [ä¸‰ã€æ‰£å­éƒ¨ç½²ç¯å¢ƒæ”¯æŒ](#ä¸‰æ‰£å­éƒ¨ç½²ç¯å¢ƒæ”¯æŒ)
- [å››ã€å†…å­˜æ¨¡å¼æ•°æ®é£é™©](#å››å†…å­˜æ¨¡å¼æ•°æ®é£é™©)
- [äº”ã€æ¨èå®æ–½è·¯çº¿](#äº”æ¨èå®æ–½è·¯çº¿)

---

## ä¸€ã€ç°çŠ¶åˆ†æ

### 1.1 å‰ç«¯æ¶æ„åˆ†æ

#### âœ… ä¼˜ç‚¹
1. **ç»„ä»¶åŒ–è®¾è®¡æ¸…æ™°**
   - 6ä¸ªæ ‡ç­¾é¡µï¼šæ€»è§ˆã€å·¥ä½œäººå‘˜ã€å†³ç­–æ—¥å¿—ã€æ™ºèƒ½æ¨èã€æœºå™¨äººæ»¡æ„åº¦ã€ä¸šåŠ¡è§’è‰²
   - æ•°æ®ç±»å‹å®šä¹‰å®Œæ•´ï¼ˆCollabStats, StaffActivity, DecisionLog ç­‰ï¼‰
   - ä½¿ç”¨ React lazy() æ‡’åŠ è½½ç»„ä»¶

2. **åŠŸèƒ½å®Œå–„**
   - è‡ªåŠ¨åˆ·æ–°åŠŸèƒ½ï¼ˆuseEffect + setIntervalï¼‰
   - æ—¶é—´èŒƒå›´åˆ‡æ¢
   - æ•°æ®å¯¼å‡ºåŠŸèƒ½ï¼ˆCSVï¼‰
   - åˆ†é¡µåŠ è½½

3. **UI è§„èŒƒ**
   - ä½¿ç”¨ shadcn/ui ç»„ä»¶åº“
   - å“åº”å¼è®¾è®¡
   - éª¨æ¶å±åŠ è½½çŠ¶æ€

#### âŒ ä¸è¶³ä¹‹å¤„
1. **API ä»£ç†æ¨¡å¼**
   - æ‰€æœ‰è¯·æ±‚é€šè¿‡ Next.js API Route ä»£ç†
   - ä¸‰å±‚ç½‘ç»œè°ƒç”¨ï¼šå‰ç«¯ â†’ Next.js API â†’ åç«¯æœåŠ¡ (5001ç«¯å£)
   - å¢åŠ ç½‘ç»œå¼€é”€ 20-30ms

2. **ç¼ºä¹æ•°æ®ç¼“å­˜**
   - æ¯æ¬¡åˆ‡æ¢æ ‡ç­¾éƒ½é‡æ–°è¯·æ±‚
   - æ— è¯·æ±‚å»é‡
   - æ— è¿‡æœŸæ—¶é—´æ§åˆ¶

3. **æ— ç¦»çº¿æ”¯æŒ**
   - ç½‘ç»œå¼‚å¸¸æ—¶é¡µé¢ä¸å¯ç”¨
   - æ— æœ¬åœ°ç¼“å­˜

4. **é”™è¯¯å¤„ç†ç®€å•**
   - ä»…æœ‰åŸºæœ¬çš„ try-catch
   - æ— é”™è¯¯é‡è¯•æœºåˆ¶
   - æ— é™çº§æ–¹æ¡ˆ

### 1.2 åç«¯æ¶æ„åˆ†æ

#### âœ… ä¼˜ç‚¹
- RESTful API è®¾è®¡è§„èŒƒ
- ç»Ÿä¸€çš„é”™è¯¯å¤„ç†
- TypeScript ç±»å‹å®šä¹‰

#### âŒ ä¸è¶³ä¹‹å¤„
1. **ä»£ç†è½¬å‘å¼€é”€**
   - å‰ç«¯ â†’ Next.js API â†’ åç«¯æœåŠ¡ (5001ç«¯å£)
   - æ¯ä¸ªè¯·æ±‚å¤šä¸€æ¬¡ç½‘ç»œå¾€è¿”

2. **ç¼ºä¹ç¼“å­˜æœºåˆ¶**
   - ç»Ÿè®¡æ•°æ®å¯èƒ½éœ€è¦é¢‘ç¹è®¡ç®—
   - æ—  Redis ç¼“å­˜
   - æ— æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–

3. **æ— æ‰¹é‡æŸ¥è¯¢**
   - å¤šä¸ªç‹¬ç«‹è¯·æ±‚å¢åŠ ç½‘ç»œå»¶è¿Ÿ
   - å‰ç«¯éœ€è¦ 5-6 æ¬¡è¯·æ±‚æ‰èƒ½åŠ è½½å®Œæ•´æ•°æ®

4. **æ€§èƒ½ä¼˜åŒ–ä¸è¶³**
   - å¤§æ•°æ®é‡åœºæ™¯ä¸‹å¯èƒ½æ€§èƒ½ç“¶é¢ˆ
   - æ— æ•°æ®åº“ç´¢å¼•ä¼˜åŒ–
   - æ— æ•°æ®é¢„èšåˆ

---

## äºŒã€ä¼˜åŒ–å»ºè®®

### 2.1 å‰ç«¯ä¼˜åŒ–

#### ğŸš€ 1. å®ç°æ™ºèƒ½æ•°æ®ç¼“å­˜ï¼ˆä¼˜å…ˆçº§ï¼šâ­â­â­â­â­ï¼‰

**æ–¹æ¡ˆï¼šä½¿ç”¨ React Query**

```typescript
// å®‰è£…ä¾èµ–
pnpm add @tanstack/react-query

// src/lib/api/react-query.ts
import { QueryClient } from '@tanstack/react-query';

export const queryClient = new QueryClient({
  defaultOptions: {
    queries: {
      staleTime: 5 * 60 * 1000,      // 5åˆ†é’Ÿå†…è®¤ä¸ºæ•°æ®æ˜¯æ–°é²œçš„
      cacheTime: 10 * 60 * 1000,     // ç¼“å­˜10åˆ†é’Ÿ
      refetchOnWindowFocus: false,   // çª—å£èšç„¦æ—¶ä¸è‡ªåŠ¨åˆ·æ–°
      retry: 2,                       // å¤±è´¥é‡è¯•2æ¬¡
    },
  },
});

// src/app/collab-analytics/page.tsx
import { useQuery } from '@tanstack/react-query';

const useCollabStats = (timeRange: string) => {
  return useQuery({
    queryKey: ['collab-stats', timeRange],
    queryFn: async () => {
      const response = await fetch(`/api/collab/stats?timeRange=${timeRange}`);
      if (!response.ok) throw new Error('è·å–ç»Ÿè®¡æ•°æ®å¤±è´¥');
      return response.json();
    },
    staleTime: 5 * 60 * 1000,
  });
};
```

**é¢„æœŸæ”¶ç›Šï¼š**
- å‡å°‘ 60-80% çš„é‡å¤è¯·æ±‚
- æå‡é¡µé¢åˆ‡æ¢é€Ÿåº¦ 5-10å€
- é™ä½æœåŠ¡å™¨è´Ÿè½½

#### ğŸš€ 2. ä¼˜åŒ– API æ‰¹é‡æŸ¥è¯¢ï¼ˆä¼˜å…ˆçº§ï¼šâ­â­â­â­â­ï¼‰

**æ–¹æ¡ˆï¼šåˆå¹¶å¤šä¸ª API ä¸ºä¸€ä¸ªæ‰¹é‡æ¥å£**

```typescript
// å‰ç«¯ï¼šsrc/lib/api/collab.ts
export const fetchDashboardData = async (timeRange: string) => {
  const response = await fetch(`/api/collab/batch?timeRange=${timeRange}`);
  if (!response.ok) throw new Error('è·å–æ•°æ®å¤±è´¥');
  return response.json();
  // åç«¯ä¸€æ¬¡æ€§è¿”å›ï¼šstats, staffActivity, decisionLogs, recommendations
};

// ä½¿ç”¨
const { data, isLoading } = useQuery({
  queryKey: ['collab-dashboard', timeRange],
  queryFn: () => fetchDashboardData(timeRange),
});
```

**åç«¯å®ç°ï¼š**
```javascript
// server/routes/collab.api.js
app.get('/api/collab/batch', async (req, res) => {
  const { timeRange } = req.query;
  
  try {
    // å¹¶è¡ŒæŸ¥è¯¢æ‰€æœ‰æ•°æ®
    const [stats, staffActivity, decisionLogs, recommendations] = await Promise.all([
      getCollabStats(timeRange),
      getStaffActivity(timeRange),
      getDecisionLogs(timeRange),
      getRecommendations(timeRange)
    ]);
    
    res.json({
      stats,
      staffActivity,
      decisionLogs,
      recommendations
    });
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
});
```

**é¢„æœŸæ”¶ç›Šï¼š**
- å‡å°‘ç½‘ç»œè¯·æ±‚æ¬¡æ•°ï¼ˆä» 5-6 æ¬¡å‡å°‘åˆ° 1 æ¬¡ï¼‰
- é™ä½å»¶è¿Ÿ 50-70%

#### ğŸš€ 3. å®ç°è™šæ‹Ÿæ»šåŠ¨ï¼ˆä¼˜å…ˆçº§ï¼šâ­â­â­ï¼‰

**æ–¹æ¡ˆï¼šä½¿ç”¨ @tanstack/react-virtual**

```bash
pnpm add @tanstack/react-virtual
```

```typescript
// src/components/collab/staff-activity-table.tsx
import { useVirtualizer } from '@tanstack/react-virtual';

export function StaffActivityTable({ activities }) {
  const parentRef = useRef<HTMLDivElement>(null);

  const rowVirtualizer = useVirtualizer({
    count: activities.length,
    getScrollElement: () => parentRef.current,
    estimateSize: () => 50,  // æ¯è¡Œé«˜åº¦
    overscan: 10,            // é¢„æ¸²æŸ“10è¡Œ
  });

  return (
    <div ref={parentRef} className="h-600 overflow-auto">
      <div style={{ height: `${rowVirtualizer.getTotalSize()}px` }}>
        {rowVirtualizer.getVirtualItems().map((virtualRow) => {
          const activity = activities[virtualRow.index];
          return (
            <div
              key={activity.id}
              style={{
                position: 'absolute',
                top: 0,
                left: 0,
                width: '100%',
                height: `${virtualRow.size}px`,
                transform: `translateY(${virtualRow.start}px)`,
              }}
            >
              <ActivityRow activity={activity} />
            </div>
          );
        })}
      </div>
    </div>
  );
}
```

**é¢„æœŸæ”¶ç›Šï¼š**
- å¤§æ•°æ®é‡ä¸‹æ€§èƒ½æå‡ 10å€+
- å†…å­˜å ç”¨é™ä½ 80%

#### ğŸš€ 4. æ·»åŠ éª¨æ¶å±åŠ è½½ï¼ˆä¼˜å…ˆçº§ï¼šâ­â­â­â­ï¼‰

**æ–¹æ¡ˆï¼šä½¿ç”¨ shadcn/ui çš„ Skeleton ç»„ä»¶**

```typescript
import { Skeleton } from '@/components/ui/skeleton';

export function CollabStatsCard({ stats, loading }) {
  return (
    <Card>
      <CardHeader>
        <CardTitle>ååŒç»Ÿè®¡æ•°æ®</CardTitle>
      </CardHeader>
      <CardContent>
        {loading ? (
          <div className="space-y-2">
            <Skeleton className="h-4 w-full" />
            <Skeleton className="h-4 w-3/4" />
            <Skeleton className="h-4 w-1/2" />
          </div>
        ) : (
          <div>
            <div className="text-2xl font-bold">{stats.totalDecisions}</div>
            <div className="text-sm text-muted-foreground">
              æ€»å†³ç­–æ•°
            </div>
          </div>
        )}
      </CardContent>
    </Card>
  );
}
```

**é¢„æœŸæ”¶ç›Šï¼š**
- æå‡ç”¨æˆ·ä½“éªŒ
- å‡å°‘é¡µé¢æŠ–åŠ¨

### 2.2 åç«¯ä¼˜åŒ–

#### ğŸš€ 1. å¼•å…¥ Redis ç¼“å­˜å±‚ï¼ˆä¼˜å…ˆçº§ï¼šâ­â­â­â­â­ï¼‰

**æ–¹æ¡ˆï¼šæ·»åŠ ç¼“å­˜è£…é¥°å™¨**

```javascript
// server/lib/cache.js
const redisClient = require('../lib/redis');

class CacheManager {
  constructor(ttl = 300) {
    this.ttl = ttl; // é»˜è®¤5åˆ†é’Ÿ
  }

  async get(key) {
    try {
      const redis = await redisClient.getClient();
      const cached = await redis.get(key);
      return cached ? JSON.parse(cached) : null;
    } catch (error) {
      console.error('ç¼“å­˜è¯»å–å¤±è´¥:', error);
      return null;
    }
  }

  async set(key, value, ttl = this.ttl) {
    try {
      const redis = await redisClient.getClient();
      await redis.setex(key, ttl, JSON.stringify(value));
      return true;
    } catch (error) {
      console.error('ç¼“å­˜å†™å…¥å¤±è´¥:', error);
      return false;
    }
  }

  async del(key) {
    try {
      const redis = await redisClient.getClient();
      await redis.del(key);
      return true;
    } catch (error) {
      console.error('ç¼“å­˜åˆ é™¤å¤±è´¥:', error);
      return false;
    }
  }
}

// ç¼“å­˜è£…é¥°å™¨
function cacheResult(keyPrefix, ttl = 300) {
  const cacheManager = new CacheManager(ttl);

  return function(target, propertyKey, descriptor) {
    const originalMethod = descriptor.value;

    descriptor.value = async function(...args) {
      // ç”Ÿæˆç¼“å­˜é”®
      const cacheKey = `${keyPrefix}:${JSON.stringify(args)}`;

      // å°è¯•ä»ç¼“å­˜è¯»å–
      const cached = await cacheManager.get(cacheKey);
      if (cached) {
        console.log(`[ç¼“å­˜å‘½ä¸­] ${cacheKey}`);
        return cached;
      }

      // æ‰§è¡ŒåŸæ–¹æ³•
      const result = await originalMethod.apply(this, args);

      // å†™å…¥ç¼“å­˜
      await cacheManager.set(cacheKey, result, ttl);

      return result;
    };

    return descriptor;
  };
}

module.exports = { CacheManager, cacheResult };
```

**ä½¿ç”¨ç¤ºä¾‹ï¼š**
```javascript
// server/services/collab.service.js
const { cacheResult } = require('../lib/cache');

class CollabService {
  @cacheResult('collab:stats', 60) // ç¼“å­˜60ç§’
  async getStats(timeRange) {
    // æ•°æ®åº“æŸ¥è¯¢
    const stats = await db.query(`
      SELECT
        COUNT(*) as total_decisions,
        SUM(CASE WHEN should_ai_reply THEN 1 ELSE 0 END) as ai_replies,
        SUM(CASE WHEN staff_intervened THEN 1 ELSE 0 END) as staff_interventions
      FROM collaboration_decision_logs
      WHERE created_at >= NOW() - INTERVAL '${timeRange}'
    `);

    return stats;
  }
}
```

**é¢„æœŸæ”¶ç›Šï¼š**
- æ•°æ®åº“æŸ¥è¯¢å‡å°‘ 90%+
- å“åº”é€Ÿåº¦æå‡ 10-100å€

#### ğŸš€ 2. æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–ï¼ˆä¼˜å…ˆçº§ï¼šâ­â­â­â­â­ï¼‰

**æ–¹æ¡ˆï¼šæ·»åŠ å¤åˆç´¢å¼•**

```sql
-- ä¼˜åŒ–å†³ç­–æ—¥å¿—æŸ¥è¯¢
CREATE INDEX IF NOT EXISTS idx_decision_logs_time_range
ON collaboration_decision_logs(created_at DESC);

CREATE INDEX IF NOT EXISTS idx_decision_logs_session_time
ON collaboration_decision_logs(session_id, created_at DESC);

-- ä¼˜åŒ–å·¥ä½œäººå‘˜æ´»åŠ¨æŸ¥è¯¢
CREATE INDEX IF NOT EXISTS idx_staff_activity_time_range
ON staff_activities(created_at DESC, staff_user_id);

CREATE INDEX IF NOT EXISTS idx_staff_activity_session_time
ON staff_activities(session_id, created_at DESC);

-- ä¼˜åŒ–æ¶ˆæ¯æŸ¥è¯¢
CREATE INDEX IF NOT EXISTS idx_messages_session_created
ON messages(session_id, created_at DESC);

CREATE INDEX IF NOT EXISTS idx_messages_user_session_created
ON messages(user_session_id, created_at DESC);
```

**åˆ›å»ºè¿ç§»è„šæœ¬ï¼š**
```javascript
// server/database/migrations/019_add_collab_indexes.sql
CREATE INDEX IF NOT EXISTS idx_decision_logs_time_range
ON collaboration_decision_logs(created_at DESC);

CREATE INDEX IF NOT EXISTS idx_decision_logs_session_time
ON collaboration_decision_logs(session_id, created_at DESC);

CREATE INDEX IF NOT EXISTS idx_staff_activity_time_range
ON staff_activities(created_at DESC, staff_user_id);

CREATE INDEX IF NOT EXISTS idx_staff_activity_session_time
ON staff_activities(session_id, created_at DESC);
```

**é¢„æœŸæ”¶ç›Šï¼š**
- æŸ¥è¯¢é€Ÿåº¦æå‡ 5-10å€
- é™ä½æ•°æ®åº“è´Ÿè½½

#### ğŸš€ 3. å®ç°æ•°æ®é¢„èšåˆï¼ˆä¼˜å…ˆçº§ï¼šâ­â­â­ï¼‰

**æ–¹æ¡ˆï¼šä½¿ç”¨ç‰©åŒ–è§†å›¾**

```sql
-- åˆ›å»ºå°æ—¶çº§ç»Ÿè®¡ç‰©åŒ–è§†å›¾
CREATE MATERIALIZED VIEW IF NOT EXISTS mv_collab_stats_hourly AS
SELECT
  date_trunc('hour', created_at) as hour,
  COUNT(*) as total_decisions,
  SUM(CASE WHEN should_ai_reply THEN 1 ELSE 0 END) as ai_replies,
  SUM(CASE WHEN staff_intervened THEN 1 ELSE 0 END) as staff_interventions,
  AVG(CASE WHEN staff_intervened THEN response_time ELSE NULL END) as avg_response_time
FROM collaboration_decision_logs
GROUP BY date_trunc('hour', created_at);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX IF NOT EXISTS mv_collab_stats_hourly_hour_idx
ON mv_collab_stats_hourly(hour DESC);

-- å®šæœŸåˆ·æ–°ï¼ˆéœ€è¦ cron job æˆ–å¤–éƒ¨è§¦å‘å™¨ï¼‰
REFRESH MATERIALIZED VIEW CONCURRENTLY mv_collab_stats_hourly;
```

**ä½¿ç”¨ç¤ºä¾‹ï¼š**
```javascript
// server/services/collab.service.js
async getStatsFromMaterializedView(timeRange) {
  const stats = await db.query(`
    SELECT
      SUM(total_decisions) as total_decisions,
      SUM(ai_replies) as ai_replies,
      SUM(staff_interventions) as staff_interventions,
      AVG(avg_response_time) as avg_response_time
    FROM mv_collab_stats_hourly
    WHERE hour >= NOW() - INTERVAL '${timeRange}'
  `);

  return stats;
}
```

**é¢„æœŸæ”¶ç›Šï¼š**
- å®æ—¶æŸ¥è¯¢é€Ÿåº¦æå‡ 100å€+
- æ”¯æŒæ›´å¤æ‚çš„æ•°æ®åˆ†æ

#### ğŸš€ 4. å®ç° SSE å®æ—¶æ¨é€ï¼ˆä¼˜å…ˆçº§ï¼šâ­â­â­ï¼‰

**æ–¹æ¡ˆï¼šä½¿ç”¨ Server-Sent Events**

**åç«¯å®ç°ï¼š**
```javascript
// server/routes/collab.api.js
app.get('/api/collab/sse-updates', async (req, res) => {
  res.setHeader('Content-Type', 'text/event-stream');
  res.setHeader('Cache-Control', 'no-cache');
  res.setHeader('Connection', 'keep-alive');
  res.setHeader('X-Accel-Buffering', 'no'); // Nginx ç¦ç”¨ç¼“å†²

  // ç›‘å¬ Redis å‘å¸ƒ/è®¢é˜…
  const redis = await redisClient.getClient();
  const subscriber = redis.duplicate();

  await subscriber.subscribe('collab:updates');

  subscriber.on('message', (channel, message) => {
    try {
      res.write(`data: ${message}\n\n`);
    } catch (error) {
      // å®¢æˆ·ç«¯æ–­å¼€è¿æ¥
      subscriber.unsubscribe();
    }
  });

  req.on('close', () => {
    subscriber.unsubscribe();
    subscriber.quit();
  });

  // å‘é€å¿ƒè·³ï¼ˆé˜²æ­¢è¶…æ—¶ï¼‰
  const heartbeat = setInterval(() => {
    res.write(': heartbeat\n\n');
  }, 30000);

  req.on('close', () => {
    clearInterval(heartbeat);
  });
});

// å‘å¸ƒæ›´æ–°
async publishUpdate(type, data) {
  const redis = await redisClient.getClient();
  await redis.publish('collab:updates', JSON.stringify({ type, data }));
}
```

**å‰ç«¯å®ç°ï¼š**
```typescript
// src/hooks/useCollabUpdates.ts
export function useCollabUpdates(onUpdate: (update: any) => void) {
  useEffect(() => {
    const eventSource = new EventSource('/api/collab/sse-updates');

    eventSource.onmessage = (event) => {
      try {
        const update = JSON.parse(event.data);
        onUpdate(update);
      } catch (error) {
        console.error('è§£ææ›´æ–°å¤±è´¥:', error);
      }
    };

    eventSource.onerror = (error) => {
      console.error('SSE è¿æ¥é”™è¯¯:', error);
      // 5ç§’åé‡è¿
      setTimeout(() => {
        eventSource.close();
      }, 5000);
    };

    return () => {
      eventSource.close();
    };
  }, [onUpdate]);
}

// ä½¿ç”¨
function CollabDashboard() {
  const [stats, setStats] = useState(null);

  useCollabUpdates((update) => {
    if (update.type === 'stats_updated') {
      setStats(update.data);
    }
  });

  // ...
}
```

**é¢„æœŸæ”¶ç›Šï¼š**
- å®æ—¶æ•°æ®æ›´æ–°
- å‡å°‘è½®è¯¢å¼€é”€ 90%

---

## ä¸‰ã€æ‰£å­éƒ¨ç½²ç¯å¢ƒæ”¯æŒ

### 3.1 éƒ¨ç½²ç¯å¢ƒç‰¹æ€§

| ç‰¹æ€§ | æ”¯æŒæƒ…å†µ | è¯´æ˜ |
|------|---------|------|
| **Redis** | âœ… å·²æ”¯æŒ | åç«¯å·²é›†æˆ Redisï¼Œæ”¯æŒé™çº§åˆ°å†…å­˜æ¨¡å¼ |
| **Next.js** | âœ… å·²æ”¯æŒ | ä½¿ç”¨ Next.js 16ï¼Œå·²é…ç½®éƒ¨ç½²è„šæœ¬ |
| **å‰åç«¯åˆ†ç¦»** | âœ… å·²æ”¯æŒ | å‰ç«¯ 5000 ç«¯å£ï¼Œåç«¯ 5001 ç«¯å£ |
| **åªè¯»æ–‡ä»¶ç³»ç»Ÿ** | âœ… å·²æ”¯æŒ | start.sh å·²æ£€æµ‹å¹¶é€‚é… |
| **ç¯å¢ƒå˜é‡** | âœ… å·²æ”¯æŒ | é€šè¿‡ .coze æ–‡ä»¶é…ç½® |
| **API ä»£ç†** | âœ… å·²æ”¯æŒ | next.config.ts å·²é…ç½® rewrites |

### 3.2 ä¼˜åŒ–é¡¹æ”¯æŒæƒ…å†µ

| ä¼˜åŒ–é¡¹ | æ‰£å­ç¯å¢ƒæ”¯æŒ | å®æ–½éš¾åº¦ | æ¨èä¼˜å…ˆçº§ |
|--------|-------------|---------|-----------|
| **React Query** | âœ… å®Œå…¨æ”¯æŒ | â­ ä½ | â­â­â­â­â­ |
| **æ•°æ®åº“ç´¢å¼•** | âœ… å®Œå…¨æ”¯æŒ | â­ ä½ | â­â­â­â­â­ |
| **Redis ç¼“å­˜** | âœ… å®Œå…¨æ”¯æŒ | â­â­ ä¸­ | â­â­â­â­â­ |
| **æ‰¹é‡ API** | âœ… å®Œå…¨æ”¯æŒ | â­ ä½ | â­â­â­â­ |
| **éª¨æ¶å±** | âœ… å®Œå…¨æ”¯æŒ | â­ ä½ | â­â­â­â­ |
| **SSE æ¨é€** | âœ… éœ€é€‚é… | â­â­ ä¸­ | â­â­â­ |
| **ç‰©åŒ–è§†å›¾** | âœ… éœ€é€‚é… | â­â­ ä¸­ | â­â­â­ |
| **è™šæ‹Ÿæ»šåŠ¨** | âœ… å®Œå…¨æ”¯æŒ | â­â­ ä¸­ | â­â­â­ |

### 3.3 æ¨èå¤–éƒ¨æœåŠ¡

#### ğŸŒŸ Upstash Redisï¼ˆå¼ºçƒˆæ¨èï¼‰

```bash
# æ³¨å†Œåœ°å€
https://upstash.com/

# å…è´¹å±‚é™åˆ¶
- 10,000 è¯·æ±‚/å¤©
- 256 MB å­˜å‚¨
- 10,000 å‘½ä»¤/å¤©
- 10,000 æ¶ˆæ¯/å¤©ï¼ˆPub/Subï¼‰

# é…ç½®ç¯å¢ƒå˜é‡
REDIS_URL=redis://default:password@host.upstash.io:6379
```

**å®‰è£…å®¢æˆ·ç«¯ï¼š**
```bash
pnpm add @upstash/redis
```

**ä½¿ç”¨ç¤ºä¾‹ï¼š**
```javascript
// server/lib/redis-upstash.js
const { Redis } = require('@upstash/redis');

const redis = new Redis({
  url: process.env.UPSTASH_REDIS_URL,
  token: process.env.UPSTASH_REDIS_TOKEN,
});

// ä½¿ç”¨æ–¹å¼ä¸ ioredis ç›¸åŒ
await redis.set('key', 'value');
const value = await redis.get('key');
```

**ä¼˜åŠ¿ï¼š**
- âœ… å…è´¹å±‚è¶³å¤Ÿç”¨
- âœ… å…¨çƒéƒ¨ç½²ï¼Œä½å»¶è¿Ÿ
- âœ… æ•°æ®æŒä¹…åŒ–
- âœ… é«˜å¯ç”¨ï¼ˆ99.9% SLAï¼‰
- âœ… æ— éœ€ç»´æŠ¤ Redis æœåŠ¡å™¨

---

## å››ã€å†…å­˜æ¨¡å¼æ•°æ®é£é™©

### 4.1 æ•°æ®åˆ†ç±»ï¼ˆä¼šä¸¢ vs ä¸ä¼šä¸¢ï¼‰

#### âŒ ä¼šä¸¢å¤±çš„æ•°æ®ï¼ˆä»… Redis/å†…å­˜å­˜å‚¨ï¼‰

| æ•°æ®ç±»å‹ | å­˜å‚¨ä½ç½® | å½±å“ | é£é™©ç­‰çº§ |
|---------|---------|------|---------|
| **ä¼šè¯çŠ¶æ€** | Redis å†…å­˜ | ç”¨æˆ·ä½“éªŒä¸­æ–­ | â­â­â­â­â­ é«˜å± |
| **å·¥ä½œäººå‘˜åœ¨çº¿çŠ¶æ€** | Redis å†…å­˜ | é‡æ–°ç™»å½• | â­â­â­ ä¸­å± |
| **å®æ—¶ç»Ÿè®¡æ•°æ®** | Redis å†…å­˜ | ç»Ÿè®¡ä¸å‡†ç¡® | â­â­â­ ä¸­å± |
| **å‘Šè­¦è®°å½•** | Redis å†…å­˜ | å‘Šè­¦ä¸¢å¤± | â­â­â­â­ é«˜å± |
| **ç›‘æ§æ—¥å¿—** | Redis å†…å­˜ | æ—¥å¿—ä¸¢å¤± | â­â­ ä½å± |
| **ç¼“å­˜æ•°æ®** | Redis å†…å­˜ | æ€§èƒ½ä¸‹é™ | â­ ä½å± |

#### âœ… ä¸ä¼šä¸¢å¤±çš„æ•°æ®ï¼ˆæ•°æ®åº“æŒä¹…åŒ–ï¼‰

| æ•°æ®ç±»å‹ | å­˜å‚¨ä½ç½® | è¯´æ˜ |
|---------|---------|------|
| **æ¶ˆæ¯è®°å½•** | PostgreSQL (`session_messages` è¡¨) | âœ… å®Œæ•´ä¿å­˜ |
| **æ‰§è¡Œè¿½è¸ª** | PostgreSQL + Redis | âœ… åŒå†™ï¼Œæœ‰å¤‡ä»½ |
| **ç”¨æˆ·ä¼šè¯** | PostgreSQL (`user_sessions` è¡¨) | âœ… å®Œæ•´ä¿å­˜ |
| **å†³ç­–æ—¥å¿—** | PostgreSQL (`collaboration_decision_logs` è¡¨) | âœ… å®Œæ•´ä¿å­˜ |
| **å·¥ä½œäººå‘˜æ¶ˆæ¯** | PostgreSQL (`staff_messages` è¡¨) | âœ… å®Œæ•´ä¿å­˜ |
| **å·¥ä½œäººå‘˜æ´»åŠ¨** | PostgreSQL (`staff_activities` è¡¨) | âœ… å®Œæ•´ä¿å­˜ |
| **æ“ä½œæ—¥å¿—** | PostgreSQL | âœ… å®Œæ•´ä¿å­˜ |
| **é…ç½®æ•°æ®** | PostgreSQL | âœ… å®Œæ•´ä¿å­˜ |

### 4.2 å…·ä½“å½±å“åœºæ™¯

#### åœºæ™¯ 1ï¼šæœåŠ¡é‡å¯æ—¶

```
âŒ ä¸¢å¤±ï¼š
- æ‰€æœ‰ä¼šè¯çš„ä¸Šä¸‹æ–‡
- å·¥ä½œäººå‘˜çš„åœ¨çº¿çŠ¶æ€
- AI å¯¹è¯çš„çŸ­æœŸè®°å¿†
- å®æ—¶ç»Ÿè®¡æ•°æ®
- æœªå¤„ç†çš„å‘Šè­¦

âœ… ä¿ç•™ï¼š
- æ‰€æœ‰å†å²æ¶ˆæ¯
- ç”¨æˆ·ä¼šè¯è®°å½•
- å†³ç­–æ—¥å¿—
- æ‰§è¡Œè¿½è¸ªè®°å½•
```

**å½±å“ï¼š**
- ç”¨æˆ·éœ€è¦é‡æ–°å¼€å§‹å¯¹è¯
- å·¥ä½œäººå‘˜éœ€è¦é‡æ–°ç™»å½•
- ç»Ÿè®¡æ•°æ®éœ€è¦é‡æ–°è®¡ç®—
- ç”¨æˆ·ä½“éªŒä¸­æ–­

#### åœºæ™¯ 2ï¼šå†…å­˜ä¸è¶³æ—¶

```
Node.js è¿›ç¨‹å´©æºƒæˆ–å†…å­˜æº¢å‡º
â¬‡ï¸
æ‰€æœ‰ Redis å†…å­˜æ•°æ®æ¸…ç©º
â¬‡ï¸
æ‰€æœ‰ä¼šè¯çŠ¶æ€ä¸¢å¤±
```

### 4.3 å†…å­˜æ¨¡å¼æœ€ä½³å®è·µ

#### æ–¹æ¡ˆ 1ï¼šå®šæœŸæŒä¹…åŒ–ä¼šè¯çŠ¶æ€ï¼ˆæ¨èï¼‰

```javascript
// åœ¨ session.service.js ä¸­æ·»åŠ æŒä¹…åŒ–
async saveSessionToDb(session) {
  try {
    const db = await getDb();

    // æ£€æŸ¥ä¼šè¯æ˜¯å¦å·²å­˜åœ¨
    const existing = await db.execute(sql`
      SELECT id FROM user_sessions
      WHERE user_id = ${session.userId}
      AND robot_id = ${session.robotId}
    `);

    if (existing.length > 0) {
      // æ›´æ–°
      await db.execute(sql`
        UPDATE user_sessions SET
          last_message_at = NOW(),
          total_message_count = ${session.messageCount},
          status = ${session.status},
          metadata = ${JSON.stringify(session)}
        WHERE id = ${existing[0].id}
      `);
    } else {
      // æ’å…¥
      await db.execute(sql`
        INSERT INTO user_sessions
        (user_id, robot_id, status, total_message_count, metadata)
        VALUES (${session.userId}, ${session.robotId}, ${session.status},
                ${session.messageCount}, ${JSON.stringify(session)})
      `);
    }
  } catch (error) {
    console.error('ä¼šè¯æŒä¹…åŒ–å¤±è´¥:', error);
  }
}

// æ¯æ¬¡æ›´æ–°ä¼šè¯æ—¶åŒæ—¶ä¿å­˜
async updateSession(sessionId, updates) {
  const redis = await this.getRedis();
  const key = `${this.sessionPrefix}${sessionId}`;

  // Redis æ›´æ–°
  await redis.setex(key, this.sessionTTL, JSON.stringify(updates));

  // æ•°æ®åº“æŒä¹…åŒ–ï¼ˆå¼‚æ­¥ï¼Œä¸å½±å“æ€§èƒ½ï¼‰
  this.saveSessionToDb(updates).catch(err => {
    console.error('ä¼šè¯æŒä¹…åŒ–å¤±è´¥:', err);
  });
}
```

#### æ–¹æ¡ˆ 2ï¼šå®šæ—¶å…¨é‡æŒä¹…åŒ–ï¼ˆå…œåº•æ–¹æ¡ˆï¼‰

```javascript
// server/scripts/persist-sessions.js
const redisClient = require('../lib/redis');
const { getDb } = require('coze-coding-dev-sdk');
const { sql } = require('drizzle-orm');

async function persistAllSessions() {
  const redis = await redisClient.getClient();
  const db = await getDb();

  // è·å–æ‰€æœ‰ä¼šè¯
  const keys = await redis.keys('session:*');

  for (const key of keys) {
    const sessionData = await redis.get(key);
    const session = JSON.parse(sessionData);

    try {
      // ä¿å­˜åˆ°æ•°æ®åº“
      await db.execute(sql`
        INSERT INTO user_sessions (user_id, robot_id, metadata)
        VALUES (${session.userId}, ${session.robotId}, ${sessionData})
        ON CONFLICT (user_id, robot_id)
        DO UPDATE SET metadata = ${sessionData}
      `);

      console.log(`âœ… ä¼šè¯å·²æŒä¹…åŒ–: ${session.sessionId}`);
    } catch (error) {
      console.error(`âŒ ä¼šè¯æŒä¹…åŒ–å¤±è´¥: ${session.sessionId}`, error);
    }
  }
}

// æ¯ 5 åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡
setInterval(() => {
  console.log('ğŸ”„ å¼€å§‹æŒä¹…åŒ–æ‰€æœ‰ä¼šè¯...');
  persistAllSessions()
    .then(() => console.log('âœ… ä¼šè¯æŒä¹…åŒ–å®Œæˆ'))
    .catch(err => console.error('âŒ ä¼šè¯æŒä¹…åŒ–å¤±è´¥:', err));
}, 5 * 60 * 1000);

// é¦–æ¬¡æ‰§è¡Œ
persistAllSessions();
```

#### æ–¹æ¡ˆ 3ï¼šæ··åˆæ¨¡å¼ï¼ˆæ™ºèƒ½é™çº§ï¼‰

```javascript
// æ™ºèƒ½åˆ¤æ–­ï¼šå…³é”®æ•°æ®åŒå†™ï¼Œä¸´æ—¶æ•°æ®ä»…å†…å­˜
class SessionService {
  async updateSession(sessionId, updates) {
    const redis = await this.getRedis();

    // å…³é”®æ•°æ®ï¼šåŒå†™åˆ°æ•°æ®åº“
    const criticalFields = ['status', 'staffStatus', 'collaborationMode'];
    const hasCriticalUpdates = Object.keys(updates).some(key =>
      criticalFields.includes(key)
    );

    if (hasCriticalUpdates) {
      await this.saveToDatabase(sessionId, updates);
    }

    // æ‰€æœ‰æ•°æ®ï¼šä¿å­˜åˆ° Redisï¼ˆç”¨äºå¿«é€Ÿè®¿é—®ï¼‰
    await redis.setex(`session:${sessionId}`, 3600, JSON.stringify(updates));
  }

  async getSession(sessionId) {
    const redis = await this.getRedis();

    // å…ˆä» Redis è¯»å–
    const cached = await redis.get(`session:${sessionId}`);
    if (cached) {
      return JSON.parse(cached);
    }

    // Redis æ²¡æœ‰åˆ™ä»æ•°æ®åº“æ¢å¤
    return await this.restoreFromDatabase(sessionId);
  }
}
```

### 4.4 å†…å­˜æ¨¡å¼ vs Redis æ¨¡å¼å¯¹æ¯”

| ç‰¹æ€§ | å†…å­˜æ¨¡å¼ | Redis æ¨¡å¼ | Upstash Redis |
|------|---------|-----------|--------------|
| **æ•°æ®æŒä¹…åŒ–** | âŒ å¦ | âœ… æ˜¯ | âœ… æ˜¯ |
| **æœåŠ¡é‡å¯** | âŒ æ•°æ®ä¸¢å¤± | âœ… æ•°æ®ä¿ç•™ | âœ… æ•°æ®ä¿ç•™ |
| **éƒ¨ç½²å¤æ‚åº¦** | âœ… ç®€å• | â­â­ ä¸­ç­‰ | â­ ç®€å• |
| **æˆæœ¬** | âœ… å…è´¹ | â­ éœ€è¦æœåŠ¡å™¨ | âœ… å…è´¹å±‚ |
| **æ€§èƒ½** | â­â­â­â­â­ æœ€å¿« | â­â­â­â­ å¿« | â­â­â­â­ å¿« |
| **å¯é æ€§** | â­ ä½ | â­â­â­â­ é«˜ | â­â­â­â­â­ å¾ˆé«˜ |
| **æ‰©å±•æ€§** | âŒ æ— æ³•æ‰©å±• | âœ… å¯æ‰©å±• | âœ… äº‘ç«¯æ‰©å±• |
| **æ¨èåœºæ™¯** | ä»…å¼€å‘ | ç”Ÿäº§ç¯å¢ƒ | æ‰£å­éƒ¨ç½² |

---

## äº”ã€æ¨èå®æ–½è·¯çº¿

### 5.1 ç¬¬ä¸€é˜¶æ®µï¼ˆç«‹å³å¯ç”¨ï¼Œ1-2å¤©ï¼‰

**ç›®æ ‡ï¼šå¿«é€Ÿæå‡æ€§èƒ½å’Œç”¨æˆ·ä½“éªŒ**

| ä»»åŠ¡ | ä¼˜å…ˆçº§ | é¢„æœŸæ—¶é—´ | æ”¶ç›Š |
|------|-------|---------|------|
| å®‰è£… React Query | â­â­â­â­â­ | 30åˆ†é’Ÿ | ç¼“å­˜æ”¯æŒ |
| æ·»åŠ æ•°æ®åº“ç´¢å¼• | â­â­â­â­â­ | 10åˆ†é’Ÿ | æŸ¥è¯¢æå‡ 5-10å€ |
| æ·»åŠ éª¨æ¶å± | â­â­â­â­ | 1å°æ—¶ | ç”¨æˆ·ä½“éªŒæ”¹å–„ |
| åˆå¹¶ API æ‰¹é‡æŸ¥è¯¢ | â­â­â­â­ | 2å°æ—¶ | å‡å°‘è¯·æ±‚ 80% |
| æ·»åŠ é”™è¯¯è¾¹ç•Œ | â­â­â­ | 1å°æ—¶ | é”™è¯¯å¤„ç†ä¼˜åŒ– |

**å®æ–½æ­¥éª¤ï¼š**

```bash
# 1. å®‰è£…ä¾èµ–
pnpm add @tanstack/react-query

# 2. åˆ›å»ºæ•°æ®åº“ç´¢å¼•
psql -U your_user -d your_database -f server/database/migrations/019_add_collab_indexes.sql

# 3. é…ç½® React Query
# åˆ›å»º src/lib/api/react-query.ts

# 4. æ·»åŠ éª¨æ¶å±
# ä¿®æ”¹ src/app/collab-analytics/page.tsx

# 5. åˆ›å»ºæ‰¹é‡ API
# ä¿®æ”¹ server/routes/collab.api.js
```

**é¢„æœŸæ•ˆæœï¼š**
- âœ… å‰ç«¯æ€§èƒ½æå‡ 5-10å€
- âœ… æ•°æ®åº“æŸ¥è¯¢æå‡ 5å€
- âœ… ç”¨æˆ·ä½“éªŒæ˜æ˜¾æ”¹å–„

### 5.2 ç¬¬äºŒé˜¶æ®µï¼ˆRedis ä¼˜åŒ–ï¼Œ3-5å¤©ï¼‰

**ç›®æ ‡ï¼šåç«¯æ€§èƒ½å¤§å¹…æå‡**

| ä»»åŠ¡ | ä¼˜å…ˆçº§ | é¢„æœŸæ—¶é—´ | æ”¶ç›Š |
|------|-------|---------|------|
| é…ç½® Redis æœåŠ¡ | â­â­â­â­â­ | 1å°æ—¶ | æ•°æ®æŒä¹…åŒ– |
| å®ç°ç¼“å­˜è£…é¥°å™¨ | â­â­â­â­â­ | 2å°æ—¶ | å‡å°‘æ•°æ®åº“è´Ÿè½½ 90% |
| æ·»åŠ ç¼“å­˜åˆ°ç»Ÿè®¡ API | â­â­â­â­â­ | 2å°æ—¶ | å“åº”é€Ÿåº¦æå‡ 10-100å€ |
| å®ç°æ‰¹é‡ API åç«¯ | â­â­â­â­ | 2å°æ—¶ | å‡å°‘ç½‘ç»œå¾€è¿” |
| æ•°æ®é¢„èšåˆ | â­â­â­ | 4å°æ—¶ | æŸ¥è¯¢é€Ÿåº¦æå‡ 100å€ |

**å®æ–½æ­¥éª¤ï¼š**

```bash
# 1. é…ç½® Redisï¼ˆæ¨è Upstashï¼‰
# æ³¨å†Œ Upstash è·å– Redis URL

# 2. å®‰è£…ä¾èµ–
pnpm add @upstash/redis

# 3. åˆ›å»ºç¼“å­˜ç®¡ç†å™¨
# åˆ›å»º server/lib/cache.js

# 4. æ·»åŠ ç¼“å­˜åˆ°ç»Ÿè®¡ API
# ä¿®æ”¹ server/services/collab.service.js

# 5. åˆ›å»ºæ‰¹é‡ API
# ä¿®æ”¹ server/routes/collab.api.js

# 6. åˆ›å»ºç‰©åŒ–è§†å›¾
# åˆ›å»º server/database/migrations/020_create_materialized_views.sql
```

**é¢„æœŸæ•ˆæœï¼š**
- âœ… åç«¯å“åº”é€Ÿåº¦æå‡ 10-100å€
- âœ… æ•°æ®åº“è´Ÿè½½é™ä½ 90%
- âœ… æ”¯æŒæ›´é«˜å¹¶å‘

### 5.3 ç¬¬ä¸‰é˜¶æ®µï¼ˆå®æ—¶æ€§ï¼Œ1-2å‘¨ï¼‰

**ç›®æ ‡ï¼šå®æ—¶æ•°æ®æ›´æ–°å’Œç›‘æ§**

| ä»»åŠ¡ | ä¼˜å…ˆçº§ | é¢„æœŸæ—¶é—´ | æ”¶ç›Š |
|------|-------|---------|------|
| å®ç° SSE æ¨é€ | â­â­â­ | 4å°æ—¶ | å®æ—¶æ›´æ–° |
| å‰ç«¯ SSE å®¢æˆ·ç«¯ | â­â­â­ | 2å°æ—¶ | å®æ—¶æ•°æ®å±•ç¤º |
| å®ç°è™šæ‹Ÿæ»šåŠ¨ | â­â­â­ | 4å°æ—¶ | å¤§æ•°æ®é‡ä¼˜åŒ– |
| æ€§èƒ½ç›‘æ§ | â­â­ | 3å°æ—¶ | å¯è§‚æµ‹æ€§ |
| ä¼˜åŒ–æ—¥å¿—è¾“å‡º | â­â­ | 2å°æ—¶ | é€‚é…åªè¯»æ–‡ä»¶ç³»ç»Ÿ |

**å®æ–½æ­¥éª¤ï¼š**

```bash
# 1. å®ç° SSE æ¨é€
# åˆ›å»º server/routes/collab.api.js çš„ SSE ç«¯ç‚¹

# 2. å®‰è£…è™šæ‹Ÿæ»šåŠ¨ä¾èµ–
pnpm add @tanstack/react-virtual

# 3. åˆ›å»º SSE å®¢æˆ·ç«¯ Hook
# åˆ›å»º src/hooks/useCollabUpdates.ts

# 4. å®ç°è™šæ‹Ÿæ»šåŠ¨è¡¨æ ¼
# ä¿®æ”¹ src/components/collab/staff-activity-table.tsx

# 5. æ·»åŠ æ€§èƒ½ç›‘æ§
# æ·»åŠ  Web Vitals ç›‘æ§
```

**é¢„æœŸæ•ˆæœï¼š**
- âœ… å®æ—¶æ•°æ®æ›´æ–°
- âœ… é™ä½è½®è¯¢å¼€é”€ 90%
- âœ… æ›´å¥½çš„ç³»ç»Ÿå¯è§‚æµ‹æ€§

---

## å…­ã€é…ç½®ç¤ºä¾‹

### 6.1 æ‰£å­éƒ¨ç½²ç¯å¢ƒé…ç½®

```toml
# .coze
[project]
requires = ["nodejs-24"]

[dev]
build = ["bash", "./scripts/prepare.sh"]
run = ["bash", "./scripts/dev.sh"]
deps = ["git"]

[deploy]
build = ["bash", "./scripts/build.sh"]
run = ["bash", "./scripts/start.sh"]
deps = ["git"]
environment = [
  "BACKEND_URL=http://localhost:5001",
  # ä½¿ç”¨ Upstash Redis
  "REDIS_URL=redis://default:password@host.upstash.io:6379",
  # æˆ–ä½¿ç”¨æ‰£å­å†…ç½® Redisï¼ˆå¦‚æœæœ‰ï¼‰
  # "REDIS_HOST=localhost",
  # "REDIS_PORT=6379"
]
```

### 6.2 æœ¬åœ°å¼€å‘ç¯å¢ƒé…ç½®

```env
# server/.env
USE_MEMORY_MODE=false  # ç”Ÿäº§ç¯å¢ƒå¿…é¡»è®¾ä¸º false
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_DB=0
REDIS_PASSWORD=

# æ•°æ®åº“é…ç½®
DATABASE_URL=postgresql://user:password@localhost:5432/worktool

# åç«¯æœåŠ¡
PORT=5001
HOST=0.0.0.0

# å‰ç«¯
NEXT_PUBLIC_BACKEND_URL=http://localhost:5001
```

---

## ä¸ƒã€ä¼˜åŒ–æ•ˆæœé¢„ä¼°

### 7.1 æ€§èƒ½æå‡

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡å¹…åº¦ |
|------|-------|-------|---------|
| **é¦–é¡µåŠ è½½æ—¶é—´** | 2-3ç§’ | 500-800ms | **3-5å€** |
| **æ ‡ç­¾åˆ‡æ¢æ—¶é—´** | 1-2ç§’ | 100-200ms | **10å€** |
| **API å“åº”æ—¶é—´** | 200-500ms | 10-50ms | **10-50å€** |
| **æ•°æ®åº“æŸ¥è¯¢æ—¶é—´** | 100-300ms | 10-20ms | **10-30å€** |
| **å¹¶å‘å¤„ç†èƒ½åŠ›** | 50 req/s | 500+ req/s | **10å€** |
| **å†…å­˜å ç”¨** | 200MB | 150MB | **é™ä½25%** |

### 7.2 ç”¨æˆ·ä½“éªŒæ”¹å–„

| æ–¹é¢ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å |
|------|-------|-------|
| **é¡µé¢åŠ è½½** | ç©ºç™½ 2-3ç§’ | éª¨æ¶å± 500ms |
| **æ•°æ®åˆ·æ–°** | å…¨å±é—ªçƒ | å¢é‡æ›´æ–° |
| **é”™è¯¯å¤„ç†** | ç™½å± | å‹å¥½æç¤º |
| **ç¦»çº¿æ”¯æŒ** | ä¸å¯ç”¨ | æ˜¾ç¤ºç¼“å­˜æ•°æ® |
| **å®æ—¶æ€§** | 5ç§’è½®è¯¢ | æ¯«ç§’çº§æ¨é€ |

---

## å…«ã€é£é™©ä¸æ³¨æ„äº‹é¡¹

### 8.1 æŠ€æœ¯é£é™©

| é£é™© | å½±å“ | ç¼“è§£æªæ–½ |
|------|------|---------|
| **Redis ä¸å¯ç”¨** | æ€§èƒ½ä¸‹é™ | è‡ªåŠ¨é™çº§åˆ°å†…å­˜æ¨¡å¼ |
| **ç¼“å­˜å¤±æ•ˆ** | æ•°æ®ä¸ä¸€è‡´ | è®¾ç½®åˆç†çš„ TTL |
| **æ•°æ®åº“ç´¢å¼•å¤±æ•ˆ** | æŸ¥è¯¢å˜æ…¢ | å®šæœŸç»´æŠ¤ç´¢å¼• |
| **SSE è¿æ¥æ–­å¼€** | å®æ—¶æ€§ä¸¢å¤± | è‡ªåŠ¨é‡è¿æœºåˆ¶ |
| **å†…å­˜æº¢å‡º** | æœåŠ¡å´©æºƒ | å†…å­˜ç›‘æ§å’Œé™åˆ¶ |

### 8.2 å®æ–½å»ºè®®

1. **é€æ­¥å®æ–½**ï¼šä¸è¦ä¸€æ¬¡æ€§åº”ç”¨æ‰€æœ‰ä¼˜åŒ–ï¼Œåˆ†é˜¶æ®µå®æ–½
2. **å……åˆ†æµ‹è¯•**ï¼šæ¯ä¸ªä¼˜åŒ–éƒ½è¦ç»è¿‡å……åˆ†æµ‹è¯•
3. **ç›‘æ§æŒ‡æ ‡**ï¼šæ·»åŠ æ€§èƒ½ç›‘æ§ï¼Œå®æ—¶è·Ÿè¸ªä¼˜åŒ–æ•ˆæœ
4. **ä¿ç•™å›æ»š**ï¼šæ¯ä¸ªé˜¶æ®µéƒ½æœ‰å›æ»šæ–¹æ¡ˆ
5. **æ–‡æ¡£æ›´æ–°**ï¼šåŠæ—¶æ›´æ–°æŠ€æœ¯æ–‡æ¡£

### 8.3 æ³¨æ„äº‹é¡¹

1. **Redis é…ç½®**ï¼šç”Ÿäº§ç¯å¢ƒå¿…é¡»ä½¿ç”¨ Redisï¼Œä¸è¦ä½¿ç”¨å†…å­˜æ¨¡å¼
2. **ç¼“å­˜ TTL**ï¼šåˆç†è®¾ç½®ç¼“å­˜è¿‡æœŸæ—¶é—´ï¼Œé¿å…æ•°æ®ä¸ä¸€è‡´
3. **æ•°æ®åº“ç´¢å¼•**ï¼šå®šæœŸç»´æŠ¤ç´¢å¼•ï¼Œé¿å…ç´¢å¼•ç¢ç‰‡åŒ–
4. **é”™è¯¯å¤„ç†**ï¼šæ·»åŠ å®Œå–„çš„é”™è¯¯å¤„ç†å’Œé™çº§æ–¹æ¡ˆ
5. **æ—¥å¿—è®°å½•**ï¼šè®°å½•å…³é”®æ“ä½œï¼Œä¾¿äºæ’æŸ¥é—®é¢˜

---

## ä¹ã€æ€»ç»“

### æ ¸å¿ƒä¼˜åŒ–ç‚¹

1. **å‰ç«¯ç¼“å­˜**ï¼šä½¿ç”¨ React Query å‡å°‘é‡å¤è¯·æ±‚
2. **æ‰¹é‡æŸ¥è¯¢**ï¼šåˆå¹¶å¤šä¸ª API ä¸ºä¸€ä¸ªæ‰¹é‡æ¥å£
3. **Redis ç¼“å­˜**ï¼šåç«¯æ·»åŠ ç¼“å­˜å±‚ï¼Œå‡å°‘æ•°æ®åº“è´Ÿè½½
4. **æ•°æ®åº“ä¼˜åŒ–**ï¼šæ·»åŠ å¤åˆç´¢å¼•ï¼Œæå‡æŸ¥è¯¢æ€§èƒ½
5. **å®æ—¶æ¨é€**ï¼šä½¿ç”¨ SSE æ›¿ä»£è½®è¯¢ï¼Œé™ä½å¼€é”€

### é¢„æœŸæ”¶ç›Š

- **æ€§èƒ½æå‡**ï¼š5-50å€
- **ç”¨æˆ·ä½“éªŒ**ï¼šæ˜æ˜¾æ”¹å–„
- **ç³»ç»Ÿç¨³å®šæ€§**ï¼šæ˜¾è‘—æé«˜
- **æˆæœ¬**ï¼šå‡ ä¹ä¸ºé›¶ï¼ˆUpstash å…è´¹å±‚ï¼‰

### æ¨èæ–¹æ¡ˆ

- **æ‰£å­éƒ¨ç½²**ï¼šä½¿ç”¨ Upstash Redisï¼ˆå…è´¹ï¼‰
- **è‡ªå»ºéƒ¨ç½²**ï¼šä½¿ç”¨æœ¬åœ° Redis
- **ä¸´æ—¶æµ‹è¯•**ï¼šå†…å­˜æ¨¡å¼ + å®šæœŸæŒä¹…åŒ–

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0
**åˆ›å»ºæ—¶é—´**ï¼š2025-01-16
**æœ€åæ›´æ–°**ï¼š2025-01-16
**ç»´æŠ¤äººå‘˜**ï¼šAI åŠ©æ‰‹
