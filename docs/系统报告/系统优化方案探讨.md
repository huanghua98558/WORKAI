# WorkTool AI ç³»ç»Ÿä¼˜åŒ–æ–¹æ¡ˆæ¢è®¨

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0
**åˆ›å»ºæ—¶é—´**ï¼š2025-01-16
**åŸºäº**ï¼šã€ŠWorkTool AI ç³»ç»Ÿå®Œæ•´åˆ†ææŠ¥å‘Šã€‹

---

## ğŸ“‹ ç›®å½•

1. [ä¼˜åŒ–ç­–ç•¥æ€»è§ˆ](#ä¼˜åŒ–ç­–ç•¥æ€»è§ˆ)
2. [å®‰å…¨ä¼˜åŒ–æ–¹æ¡ˆ](#ä¸€å®‰å…¨ä¼˜åŒ–æ–¹æ¡ˆ-ä¼˜å…ˆçº§p0)
3. [æ€§èƒ½ä¼˜åŒ–æ–¹æ¡ˆ](#äºŒæ€§èƒ½ä¼˜åŒ–æ–¹æ¡ˆ-ä¼˜å…ˆçº§p1)
4. [ä»£ç è´¨é‡ä¼˜åŒ–](#ä¸‰ä»£ç è´¨é‡ä¼˜åŒ–-ä¼˜å…ˆçº§p2)
5. [æ¶æ„ä¼˜åŒ–æ–¹æ¡ˆ](#å››æ¶æ„ä¼˜åŒ–æ–¹æ¡ˆ-ä¼˜å…ˆçº§p3)
6. [å®æ–½è·¯çº¿å›¾](#å®æ–½è·¯çº¿å›¾)
7. [é£é™©æƒè¡¡åˆ†æ](#é£é™©æƒè¡¡åˆ†æ)
8. [æˆæœ¬æ•ˆç›Šåˆ†æ](#æˆæœ¬æ•ˆç›Šåˆ†æ)

---

## ä¼˜åŒ–ç­–ç•¥æ€»è§ˆ

### ğŸ¯ ä¼˜åŒ–ç›®æ ‡

åŸºäºåˆ†ææŠ¥å‘Šï¼Œæˆ‘ä»¬çš„ä¼˜åŒ–ç›®æ ‡åˆ†ä¸ºä¸‰ä¸ªå±‚æ¬¡ï¼š

| å±‚æ¬¡ | ç›®æ ‡ | æ—¶é—´é¢„æœŸ | èµ„æºæŠ•å…¥ |
|------|------|---------|---------|
| **ç”Ÿå­˜å±‚** | ä¿®å¤ä¸¥é‡å®‰å…¨æ¼æ´ï¼Œä¿è¯ç³»ç»Ÿç¨³å®šè¿è¡Œ | 1 å‘¨ | 40 å·¥æ—¶ |
| **æ€§èƒ½å±‚** | æå‡ç³»ç»Ÿæ€§èƒ½ï¼Œæ”¹å–„ç”¨æˆ·ä½“éªŒ | 2-4 å‘¨ | 120 å·¥æ—¶ |
| **ä¼˜åŒ–å±‚** | æå‡ä»£ç è´¨é‡ï¼Œå¢å¼ºå¯ç»´æŠ¤æ€§ | 1-2 ä¸ªæœˆ | 200 å·¥æ—¶ |

### ğŸ“Š ä¼˜åŒ–ç­–ç•¥

æˆ‘ä»¬é‡‡ç”¨ **"å¿«èµ¢å…ˆè¡Œ + ç¨³æ­¥æ¨è¿›"** çš„ç­–ç•¥ï¼š

```
ç¬¬ä¸€é˜¶æ®µï¼ˆ1å‘¨ï¼‰ï¼šç«‹å³ä¿®å¤
â”œâ”€â”€ å®‰å…¨æ¼æ´ä¿®å¤ ğŸ”´ P0
â”œâ”€â”€ æ•°æ®ä¸¢å¤±ä¿®å¤ ğŸ”´ P0
â””â”€â”€ åŸºç¡€æ€§èƒ½ä¼˜åŒ– ğŸŸ  P1

ç¬¬äºŒé˜¶æ®µï¼ˆ2-4å‘¨ï¼‰ï¼šæ€§èƒ½æå‡
â”œâ”€â”€ Redis ç¼“å­˜å®ç° ğŸŸ  P1
â”œâ”€â”€ æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ– ğŸŸ  P1
â””â”€â”€ å‰ç«¯ç¼“å­˜ä¼˜åŒ– ğŸŸ¡ P2

ç¬¬ä¸‰é˜¶æ®µï¼ˆ1-2ä¸ªæœˆï¼‰ï¼šè´¨é‡æå‡
â”œâ”€â”€ ä»£ç é‡æ„ ğŸŸ¢ P3
â”œâ”€â”€ æµ‹è¯•è¦†ç›– ğŸŸ¢ P3
â””â”€â”€ æ–‡æ¡£å®Œå–„ ğŸŸ¢ P3
```

---

## ä¸€ã€å®‰å…¨ä¼˜åŒ–æ–¹æ¡ˆï¼ˆä¼˜å…ˆçº§ P0ï¼‰

### 1.1 CORS é…ç½®ä¼˜åŒ–

#### ğŸ”´ é—®é¢˜ç°çŠ¶

```javascript
// server/app.js
fastify.register(cors, {
  origin: true, // ğŸ”´ å…è®¸æ‰€æœ‰åŸŸå
  credentials: true
});
```

**é£é™©ï¼š** ä»»ä½•ç½‘ç«™éƒ½å¯ä»¥è°ƒç”¨ APIï¼Œå¯¼è‡´è·¨ç«™è¯·æ±‚ä¼ªé€ ï¼ˆCSRFï¼‰

#### âœ… ä¼˜åŒ–æ–¹æ¡ˆ

**æ–¹æ¡ˆ Aï¼šç™½åå•æ¨¡å¼ï¼ˆæ¨èï¼‰**

```javascript
// server/lib/cors.js
const allowedOrigins = {
  production: [
    'https://worktool.yourdomain.com',
    'https://app.worktool.yourdomain.com',
    'https://admin.worktool.yourdomain.com'
  ],
  development: [
    'http://localhost:3000',
    'http://localhost:5000',
    'http://127.0.0.1:3000',
    '*.dev.coze.site'
  ]
};

module.exports = {
  origin: (origin, callback) => {
    const env = process.env.NODE_ENV || 'development';
    const origins = allowedOrigins[env] || [];

    // å…è®¸åŒæºè¯·æ±‚ï¼ˆorigin ä¸ºç©ºï¼‰
    if (!origin) {
      return callback(null, true);
    }

    // æ£€æŸ¥ç™½åå•
    const isAllowed = origins.some(allowed => {
      if (allowed.includes('*')) {
        const pattern = allowed.replace('*', '.*');
        return new RegExp(pattern).test(origin);
      }
      return allowed === origin;
    });

    if (isAllowed) {
      callback(null, true);
    } else {
      console.warn(`[CORS] Blocked origin: ${origin}`);
      callback(new Error('Not allowed by CORS'), false);
    }
  },
  credentials: true,
  methods: ['GET', 'POST', 'PUT', 'DELETE', 'PATCH', 'OPTIONS'],
  allowedHeaders: ['Content-Type', 'Authorization', 'X-Requested-With'],
  maxAge: 86400 // 24 å°æ—¶é¢„æ£€ç¼“å­˜
};

// server/app.js
const corsConfig = require('./lib/cors');
fastify.register(cors, corsConfig);
```

**æ–¹æ¡ˆ Bï¼šç¯å¢ƒå˜é‡é…ç½®**

```javascript
// .env.local
ALLOWED_ORIGINS=https://worktool.com,https://app.worktool.com,*.dev.coze.site

// server/lib/cors.js
const getCorsConfig = () => {
  const allowedOrigins = process.env.ALLOWED_ORIGINS?.split(',') || [];

  return {
    origin: (origin, callback) => {
      if (!origin) {
        return callback(null, true);
      }

      const isAllowed = allowedOrigins.some(allowed => {
        if (allowed.includes('*')) {
          const pattern = allowed.replace(/\*/g, '.*');
          return new RegExp(pattern).test(origin);
        }
        return allowed === origin;
      });

      callback(null, isAllowed);
    },
    credentials: true,
    methods: ['GET', 'POST', 'PUT', 'DELETE'],
    allowedHeaders: ['Content-Type', 'Authorization']
  };
};
```

**ğŸ“Š æ–¹æ¡ˆå¯¹æ¯”**

| ç‰¹æ€§ | æ–¹æ¡ˆ Aï¼ˆç™½åå•ï¼‰ | æ–¹æ¡ˆ Bï¼ˆç¯å¢ƒå˜é‡ï¼‰ |
|------|-----------------|-------------------|
| **å®‰å…¨æ€§** | â­â­â­â­â­ | â­â­â­â­ |
| **çµæ´»æ€§** | â­â­â­ | â­â­â­â­â­ |
| **ç»´æŠ¤æ€§** | â­â­â­â­â­ | â­â­â­â­ |
| **æ¨èåœºæ™¯** | å›ºå®šåŸŸå | å¤šç¯å¢ƒéƒ¨ç½² |

**ğŸ¯ æ¨èæ–¹æ¡ˆï¼šAï¼ˆç™½åå•æ¨¡å¼ï¼‰**

**ç†ç”±ï¼š**
1. æ›´å®‰å…¨ï¼Œé…ç½®é›†ä¸­ç®¡ç†
2. é¿å…ç¯å¢ƒå˜é‡é…ç½®é”™è¯¯
3. ä¾¿äºå®¡è®¡å’Œç»´æŠ¤

### 1.2 Helmet CSP é…ç½®

#### ğŸ”´ é—®é¢˜ç°çŠ¶

```javascript
// server/app.js
fastify.register(helmet, {
  contentSecurityPolicy: false // ğŸ”´ å®Œå…¨å…³é—­ CSP
});
```

**é£é™©ï¼š** å®¹æ˜“å—åˆ° XSS æ”»å‡»

#### âœ… ä¼˜åŒ–æ–¹æ¡ˆ

```javascript
// server/lib/csp.js
const getCspConfig = () => {
  const backendUrl = process.env.BACKEND_URL || 'http://localhost:5001';
  const allowedDomains = process.env.ALLOWED_DOMAINS?.split(',') || ['self'];

  return {
    contentSecurityPolicy: {
      directives: {
        defaultSrc: ["'self'"],
        baseUri: ["'self'"],
        formAction: ["'self'"],
        frameAncestors: ["'none'"],
        imgSrc: [
          "'self'",
          "data:",
          "https:",
          "*.aliyuncs.com",
          "*.worktool.com"
        ],
        objectSrc: ["'none'"],
        scriptSrc: [
          "'self'",
          "'unsafe-inline'",
          "'unsafe-eval'"
        ],
        styleSrc: [
          "'self'",
          "'unsafe-inline'"
        ],
        connectSrc: [
          "'self'",
          backendUrl,
          "wss:",
          "*.worktool.com"
        ],
        fontSrc: ["'self'", "data:"],
        mediaSrc: ["'self'"],
        frameSrc: ["'none'"],
        workerSrc: ["'self'", "blob:"],
        manifestSrc: ["'self'"],
        upgradeInsecureRequests: []
      }
    },
    hsts: {
      maxAge: 31536000,
      includeSubDomains: true,
      preload: true
    },
    referrerPolicy: {
      policy: "strict-origin-when-cross-origin"
    }
  };
};

module.exports = getCspConfig;

// server/app.js
const getCspConfig = require('./lib/csp');
fastify.register(helmet, getCspConfig());
```

**ğŸ“ é…ç½®è¯´æ˜**

| æŒ‡ä»¤ | ä½œç”¨ | å…è®¸å€¼ |
|------|------|--------|
| `defaultSrc` | é»˜è®¤ç­–ç•¥ | `'self'` |
| `scriptSrc` | è„šæœ¬æ¥æº | `'self'`, `'unsafe-inline'` |
| `styleSrc` | æ ·å¼æ¥æº | `'self'`, `'unsafe-inline'` |
| `imgSrc` | å›¾ç‰‡æ¥æº | `'self'`, `data:`, `https:` |
| `connectSrc` | AJAX/WebSocket | `'self'`, backend URL |
| `frameSrc` | iframe æ¥æº | `'none'` |

**âš ï¸ æ³¨æ„äº‹é¡¹**

1. **CSP è¿è§„æŠ¥å‘Š**ï¼šæ·»åŠ  `report-uri` æ”¶é›†è¿è§„ä¿¡æ¯
2. **é€æ­¥æ”¶ç´§**ï¼šå…ˆä½¿ç”¨ `report-only` æ¨¡å¼ï¼Œè§‚å¯Ÿåå†å¯ç”¨
3. **å¼€å‘ç¯å¢ƒä¾‹å¤–**ï¼šå¼€å‘ç¯å¢ƒå¯ä»¥é€‚å½“æ”¾å®½

### 1.3 èº«ä»½è®¤è¯ä¸æˆæƒ

#### ğŸ”´ é—®é¢˜ç°çŠ¶

```javascript
// server/routes/admin.api.js
app.delete('/api/admin/robots/:id', async (req, res) => {
  // ğŸ”´ ç¼ºå°‘èº«ä»½éªŒè¯ï¼Œä»»ä½•äººéƒ½å¯ä»¥åˆ é™¤æœºå™¨äºº
  await robotService.deleteRobot(req.params.id);
  res.send({ success: true });
});
```

**é£é™©ï¼š** ç®¡ç†æ¥å£å¯è¢«æ¶æ„è°ƒç”¨

#### âœ… ä¼˜åŒ–æ–¹æ¡ˆ

**æ–¹æ¡ˆ Aï¼šJWT è®¤è¯ï¼ˆæ¨èï¼‰**

```javascript
// server/lib/auth.js
const jwt = require('jsonwebtoken');

const JWT_SECRET = process.env.JWT_SECRET || 'your-secret-key';

// ç”Ÿæˆ JWT
function generateToken(payload) {
  return jwt.sign(payload, JWT_SECRET, {
    expiresIn: '24h',
    issuer: 'worktool-ai'
  });
}

// éªŒè¯ JWT
function verifyToken(token) {
  try {
    return jwt.verify(token, JWT_SECRET);
  } catch (error) {
    return null;
  }
}

// è®¤è¯ä¸­é—´ä»¶
function authenticateToken(req, res, next) {
  const authHeader = req.headers['authorization'];
  const token = authHeader && authHeader.split(' ')[1];

  if (!token) {
    return res.status(401).json({ error: 'ç¼ºå°‘è®¤è¯ä»¤ç‰Œ' });
  }

  const decoded = verifyToken(token);
  if (!decoded) {
    return res.status(403).json({ error: 'æ— æ•ˆçš„è®¤è¯ä»¤ç‰Œ' });
  }

  req.user = decoded;
  next();
}

// ç®¡ç†å‘˜æƒé™æ£€æŸ¥
function authenticateAdmin(req, res, next) {
  const authHeader = req.headers['authorization'];
  const token = authHeader && authHeader.split(' ')[1];

  if (!token) {
    return res.status(401).json({ error: 'ç¼ºå°‘è®¤è¯ä»¤ç‰Œ' });
  }

  const decoded = verifyToken(token);
  if (!decoded) {
    return res.status(403).json({ error: 'æ— æ•ˆçš„è®¤è¯ä»¤ç‰Œ' });
  }

  if (decoded.role !== 'admin') {
    return res.status(403).json({ error: 'éœ€è¦ç®¡ç†å‘˜æƒé™' });
  }

  req.user = decoded;
  next();
}

module.exports = {
  generateToken,
  verifyToken,
  authenticateToken,
  authenticateAdmin
};

// server/routes/auth.api.js
const { generateToken } = require('../lib/auth');

// ç™»å½•æ¥å£
app.post('/api/auth/login', async (req, res) => {
  const { username, password } = req.body;

  // éªŒè¯ç”¨æˆ·åå¯†ç 
  const user = await authenticateUser(username, password);
  if (!user) {
    return res.status(401).json({ error: 'ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯' });
  }

  // ç”Ÿæˆ JWT
  const token = generateToken({
    id: user.id,
    username: user.username,
    role: user.role
  });

  res.json({
    success: true,
    token,
    user: {
      id: user.id,
      username: user.username,
      role: user.role
    }
  });
});

// server/routes/admin.api.js
const { authenticateAdmin } = require('../lib/auth');

// ä¿æŠ¤ç®¡ç†æ¥å£
app.delete('/api/admin/robots/:id', {
  preHandler: authenticateAdmin
}, async (req, res) => {
  await robotService.deleteRobot(req.params.id);
  res.send({ success: true });
});
```

**æ–¹æ¡ˆ Bï¼šAPI Key è®¤è¯**

```javascript
// server/lib/api-key.js
const crypto = require('crypto');

// ç”Ÿæˆ API Key
function generateApiKey() {
  return `wt_${crypto.randomBytes(32).toString('hex')}`;
}

// éªŒè¯ API Key
async function verifyApiKey(apiKey) {
  const db = await getDb();

  const result = await db.execute(sql`
    SELECT id, name, permissions
    FROM api_keys
    WHERE key = ${apiKey}
    AND is_active = true
  `);

  if (result.rows.length === 0) {
    return null;
  }

  return result.rows[0];
}

// API Key è®¤è¯ä¸­é—´ä»¶
function authenticateApiKey(req, res, next) {
  const apiKey = req.headers['x-api-key'];

  if (!apiKey) {
    return res.status(401).json({ error: 'ç¼ºå°‘ API Key' });
  }

  const keyInfo = verifyApiKey(apiKey);
  if (!keyInfo) {
    return res.status(403).json({ error: 'æ— æ•ˆçš„ API Key' });
  }

  req.apiKey = keyInfo;
  next();
}

module.exports = {
  generateApiKey,
  verifyApiKey,
  authenticateApiKey
};
```

**ğŸ“Š æ–¹æ¡ˆå¯¹æ¯”**

| ç‰¹æ€§ | æ–¹æ¡ˆ Aï¼ˆJWTï¼‰ | æ–¹æ¡ˆ Bï¼ˆAPI Keyï¼‰ |
|------|-------------|-----------------|
| **å®‰å…¨æ€§** | â­â­â­â­â­ | â­â­â­â­ |
| **æ— çŠ¶æ€æ€§** | â­â­â­â­â­ | â­â­â­ |
| **é€‚ç”¨åœºæ™¯** | ç”¨æˆ·ç™»å½• | API è°ƒç”¨ |
| **æ’¤é”€æ€§** | â­â­â­ | â­â­â­â­â­ |
| **å®ç°éš¾åº¦** | â­â­â­ | â­â­ |

**ğŸ¯ æ¨èæ–¹æ¡ˆï¼šA + B ç»„åˆ**

- ç”¨æˆ·ç™»å½•ï¼šä½¿ç”¨ JWT
- API è°ƒç”¨ï¼šä½¿ç”¨ API Key
- ç®¡ç†æ¥å£ï¼šä½¿ç”¨ JWT + è§’è‰²éªŒè¯

---

## äºŒã€æ€§èƒ½ä¼˜åŒ–æ–¹æ¡ˆï¼ˆä¼˜å…ˆçº§ P1ï¼‰

### 2.1 Redis ç¼“å­˜å®ç°

#### ğŸ“Š æ€§èƒ½é—®é¢˜

```javascript
// å½“å‰ï¼šæ¯æ¬¡éƒ½æŸ¥è¯¢æ•°æ®åº“
async getStats(timeRange) {
  const stats = await db.query(`
    SELECT COUNT(*) as total FROM sessions
    WHERE created_at >= NOW() - INTERVAL '${timeRange}'
  `);
  // ğŸ”´ æ¯æ¬¡è¯·æ±‚éƒ½æŸ¥è¯¢æ•°æ®åº“
  return stats;
}

// æ€§èƒ½æ•°æ®ï¼š
// - å“åº”æ—¶é—´ï¼š200-500ms
// - æ•°æ®åº“è´Ÿè½½ï¼šé«˜
// - å¹¶å‘èƒ½åŠ›ï¼š50 req/s
```

#### âœ… ä¼˜åŒ–æ–¹æ¡ˆ

**æ­¥éª¤ 1ï¼šåˆ›å»ºç¼“å­˜ç®¡ç†å™¨**

```javascript
// server/lib/cache.js
const redisClient = require('./redis');

class CacheManager {
  constructor(defaultTTL = 300) {
    this.defaultTTL = defaultTTL;
    this.redis = null;
  }

  async init() {
    this.redis = await redisClient.getClient();
  }

  /**
   * è·å–ç¼“å­˜
   */
  async get(key) {
    try {
      if (!this.redis) await this.init();

      const cached = await this.redis.get(key);
      if (cached) {
        console.log(`[ç¼“å­˜å‘½ä¸­] ${key}`);
        return JSON.parse(cached);
      }

      console.log(`[ç¼“å­˜æœªå‘½ä¸­] ${key}`);
      return null;
    } catch (error) {
      console.error(`[ç¼“å­˜è¯»å–å¤±è´¥] ${key}:`, error.message);
      return null;
    }
  }

  /**
   * è®¾ç½®ç¼“å­˜
   */
  async set(key, value, ttl = this.defaultTTL) {
    try {
      if (!this.redis) await this.init();

      await this.redis.setex(key, ttl, JSON.stringify(value));
      console.log(`[ç¼“å­˜å†™å…¥] ${key} (TTL: ${ttl}s)`);
      return true;
    } catch (error) {
      console.error(`[ç¼“å­˜å†™å…¥å¤±è´¥] ${key}:`, error.message);
      return false;
    }
  }

  /**
   * åˆ é™¤ç¼“å­˜
   */
  async del(key) {
    try {
      if (!this.redis) await this.init();

      await this.redis.del(key);
      console.log(`[ç¼“å­˜åˆ é™¤] ${key}`);
      return true;
    } catch (error) {
      console.error(`[ç¼“å­˜åˆ é™¤å¤±è´¥] ${key}:`, error.message);
      return false;
    }
  }

  /**
   * æ‰¹é‡åˆ é™¤
   */
  async delPattern(pattern) {
    try {
      if (!this.redis) await this.init();

      const keys = await this.redis.keys(pattern);
      if (keys.length > 0) {
        await this.redis.del(...keys);
        console.log(`[ç¼“å­˜æ‰¹é‡åˆ é™¤] ${pattern} (${keys.length} ä¸ª)`);
      }
      return true;
    } catch (error) {
      console.error(`[ç¼“å­˜æ‰¹é‡åˆ é™¤å¤±è´¥] ${pattern}:`, error.message);
      return false;
    }
  }

  /**
   * ç¼“å­˜è£…é¥°å™¨
   */
  decorate(keyPrefix, ttl = this.defaultTTL) {
    const self = this;

    return function(target, propertyKey, descriptor) {
      const originalMethod = descriptor.value;

      descriptor.value = async function(...args) {
        // ç”Ÿæˆç¼“å­˜é”®
        const cacheKey = `${keyPrefix}:${JSON.stringify(args)}`;

        // å°è¯•ä»ç¼“å­˜è¯»å–
        const cached = await self.get(cacheKey);
        if (cached !== null) {
          return cached;
        }

        // æ‰§è¡ŒåŸæ–¹æ³•
        const result = await originalMethod.apply(this, args);

        // å†™å…¥ç¼“å­˜
        await self.set(cacheKey, result, ttl);

        return result;
      };

      return descriptor;
    };
  }
}

// å•ä¾‹æ¨¡å¼
const cacheManager = new CacheManager(300); // é»˜è®¤ 5 åˆ†é’Ÿ

module.exports = cacheManager;
```

**æ­¥éª¤ 2ï¼šåœ¨æœåŠ¡å±‚ä½¿ç”¨ç¼“å­˜**

```javascript
// server/services/collab.service.js
const cacheManager = require('../lib/cache');

class CollabService {
  /**
   * è·å–ååŒç»Ÿè®¡ï¼ˆå¸¦ç¼“å­˜ï¼‰
   */
  @cacheManager.decorate('collab:stats', 60) // ç¼“å­˜ 60 ç§’
  async getStats(timeRange) {
    const stats = await db.query(`
      SELECT
        COUNT(*) as total_decisions,
        SUM(CASE WHEN should_ai_reply THEN 1 ELSE 0 END) as ai_replies,
        SUM(CASE WHEN staff_intervened THEN 1 ELSE 0 END) as staff_interventions,
        AVG(CASE WHEN staff_intervened THEN response_time ELSE NULL END) as avg_response_time
      FROM collaboration_decision_logs
      WHERE created_at >= NOW() - INTERVAL '${timeRange}'
    `);

    return stats;
  }

  /**
   * è·å–å·¥ä½œäººå‘˜æ´»åŠ¨ï¼ˆå¸¦ç¼“å­˜ï¼‰
   */
  @cacheManager.decorate('collab:staff-activity', 30) // ç¼“å­˜ 30 ç§’
  async getStaffActivity(timeRange, limit = 50) {
    const activities = await db.query(`
      SELECT
        staff_user_id,
        COUNT(*) as activity_count,
        MAX(created_at) as last_activity
      FROM staff_activities
      WHERE created_at >= NOW() - INTERVAL '${timeRange}'
      GROUP BY staff_user_id
      ORDER BY activity_count DESC
      LIMIT ${limit}
    `);

    return activities;
  }
}

module.exports = CollabService;
```

**æ­¥éª¤ 3ï¼šç¼“å­˜å¤±æ•ˆç­–ç•¥**

```javascript
// server/services/collab.service.js
class CollabService {
  /**
   * æ–°å¢å†³ç­–æ—¥å¿—æ—¶å¤±æ•ˆç¼“å­˜
   */
  async addDecisionLog(decision) {
    // å†™å…¥æ•°æ®åº“
    await db.insert(decisionLogs).values(decision);

    // å¤±æ•ˆç›¸å…³ç¼“å­˜
    const timeRanges = ['1h', '6h', '12h', '24h', '7d', '30d'];
    for (const timeRange of timeRanges) {
      await cacheManager.del(`collab:stats:${JSON.stringify([timeRange])}`);
      await cacheManager.del(`collab:staff-activity:${JSON.stringify([timeRange, 50])}`);
    }
  }

  /**
   * å®šæ—¶åˆ·æ–°ç¼“å­˜ï¼ˆå¯é€‰ï¼‰
   */
  async refreshCache() {
    console.log('[ç¼“å­˜åˆ·æ–°] å¼€å§‹åˆ·æ–°æ‰€æœ‰ç¼“å­˜');

    const timeRanges = ['1h', '6h', '12h', '24h', '7d', '30d'];

    for (const timeRange of timeRanges) {
      await this.getStats(timeRange);
      await this.getStaffActivity(timeRange);
    }

    console.log('[ç¼“å­˜åˆ·æ–°] ç¼“å­˜åˆ·æ–°å®Œæˆ');
  }
}

// å®šæ—¶ä»»åŠ¡ï¼ˆæ¯å°æ—¶åˆ·æ–°ä¸€æ¬¡ï¼‰
setInterval(() => {
  const collabService = new CollabService();
  collabService.refreshCache().catch(err => {
    console.error('[ç¼“å­˜åˆ·æ–°] å¤±è´¥:', err);
  });
}, 60 * 60 * 1000);
```

**ğŸ“Š æ€§èƒ½å¯¹æ¯”**

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|------|-------|-------|------|
| **å“åº”æ—¶é—´** | 200-500ms | 10-20ms | **10-50å€** |
| **æ•°æ®åº“è´Ÿè½½** | 100% | 5% | **é™ä½ 95%** |
| **å¹¶å‘èƒ½åŠ›** | 50 req/s | 500+ req/s | **10å€** |
| **Redis å†…å­˜** | 0 | ~100MB | +100MB |

**âš ï¸ æ³¨æ„äº‹é¡¹**

1. **ç¼“å­˜ä¸€è‡´æ€§**ï¼šæ•°æ®æ›´æ–°æ—¶åŠæ—¶å¤±æ•ˆç¼“å­˜
2. **ç¼“å­˜é›ªå´©**ï¼šç»™ TTL æ·»åŠ éšæœºå€¼
3. **ç¼“å­˜ç©¿é€**ï¼šå¯¹ç©ºå€¼ä¹Ÿè¿›è¡Œç¼“å­˜
4. **ç›‘æ§æŒ‡æ ‡**ï¼šç›‘æ§ç¼“å­˜å‘½ä¸­ç‡

### 2.2 æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–

#### ğŸ“Š æ€§èƒ½é—®é¢˜

```javascript
// é—®é¢˜ï¼šN+1 æŸ¥è¯¢
const sessions = await db.select().from(sessions);
for (const session of sessions) {
  session.messages = await db.select().from(messages)
    .where(eq(messages.sessionId, session.id)); // ğŸ”´ N+1 æŸ¥è¯¢
}

// æ€§èƒ½æ•°æ®ï¼š
// - æŸ¥è¯¢æ¬¡æ•°ï¼š1 + N
// - å“åº”æ—¶é—´ï¼šN Ã— 50ms
// - æ•°æ®åº“è´Ÿè½½ï¼šæé«˜
```

#### âœ… ä¼˜åŒ–æ–¹æ¡ˆ

**ä¼˜åŒ– 1ï¼šæ‰¹é‡æŸ¥è¯¢**

```javascript
// âœ… ä¼˜åŒ–ï¼šä¸€æ¬¡æŸ¥è¯¢
async getSessionsWithMessages(limit = 50) {
  // æŸ¥è¯¢ä¼šè¯
  const sessions = await db.select().from(sessions)
    .orderBy(desc(sessions.createdAt))
    .limit(limit);

  if (sessions.length === 0) {
    return [];
  }

  // æ‰¹é‡æŸ¥è¯¢æ¶ˆæ¯
  const sessionIds = sessions.map(s => s.id);
  const allMessages = await db.select().from(messages)
    .where(inArray(messages.sessionId, sessionIds))
    .orderBy(desc(messages.createdAt));

  // ç»„è£…æ•°æ®
  const messageMap = new Map();
  for (const message of allMessages) {
    if (!messageMap.has(message.sessionId)) {
      messageMap.set(message.sessionId, []);
    }
    messageMap.get(message.sessionId).push(message);
  }

  // å…³è”æ¶ˆæ¯
  return sessions.map(session => ({
    ...session,
    messages: messageMap.get(session.id) || []
  }));
}
```

**ä¼˜åŒ– 2ï¼šä½¿ç”¨ JOIN**

```javascript
// âœ… ä¼˜åŒ–ï¼šä½¿ç”¨ JOIN
async getSessionsWithMessagesJoin(limit = 50) {
  const result = await db.execute(sql`
    SELECT
      s.*,
      m.id as message_id,
      m.content as message_content,
      m.created_at as message_created_at
    FROM sessions s
    LEFT JOIN messages m ON m.session_id = s.id
    ORDER BY s.created_at DESC, m.created_at DESC
    LIMIT ${limit * 10}
  `);

  // ç»„è£…æ•°æ®
  const sessionMap = new Map();

  for (const row of result.rows) {
    if (!sessionMap.has(row.id)) {
      sessionMap.set(row.id, {
        id: row.id,
        userId: row.user_id,
        createdAt: row.created_at,
        messages: []
      });
    }

    if (row.message_id) {
      sessionMap.get(row.id).messages.push({
        id: row.message_id,
        content: row.message_content,
        createdAt: row.message_created_at
      });
    }
  }

  return Array.from(sessionMap.values());
}
```

**ä¼˜åŒ– 3ï¼šæ·»åŠ ç´¢å¼•**

```sql
-- server/database/migrations/020_add_performance_indexes.sql

-- ä¼˜åŒ–ä¼šè¯æŸ¥è¯¢
CREATE INDEX IF NOT EXISTS idx_sessions_created_at
ON sessions(created_at DESC);

CREATE INDEX IF NOT EXISTS idx_sessions_user_created
ON sessions(user_id, created_at DESC);

-- ä¼˜åŒ–æ¶ˆæ¯æŸ¥è¯¢
CREATE INDEX IF NOT EXISTS idx_messages_session_created
ON messages(session_id, created_at DESC);

CREATE INDEX IF NOT EXISTS idx_messages_user_session_created
ON messages(user_session_id, created_at DESC);

-- ä¼˜åŒ–ååŒåˆ†ææŸ¥è¯¢
CREATE INDEX IF NOT EXISTS idx_decision_logs_time_range
ON collaboration_decision_logs(created_at DESC);

CREATE INDEX IF NOT EXISTS idx_decision_logs_session_time
ON collaboration_decision_logs(session_id, created_at DESC);

-- ä¼˜åŒ–å·¥ä½œäººå‘˜æ´»åŠ¨æŸ¥è¯¢
CREATE INDEX IF NOT EXISTS idx_staff_activity_time_range
ON staff_activities(created_at DESC, staff_user_id);

CREATE INDEX IF NOT EXISTS idx_staff_activity_session_time
ON staff_activities(session_id, created_at DESC);
```

**ğŸ“Š æ€§èƒ½å¯¹æ¯”**

| åœºæ™¯ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|------|-------|-------|------|
| **N+1 æŸ¥è¯¢ï¼ˆ50 æ¡ï¼‰** | 2500ms | 50ms | **50å€** |
| **JOIN æŸ¥è¯¢ï¼ˆ50 æ¡ï¼‰** | - | 30ms | - |
| **å¸¦ç´¢å¼•æŸ¥è¯¢** | 300ms | 20ms | **15å€** |

### 2.3 å‰ç«¯ç¼“å­˜ä¼˜åŒ–

#### âœ… ä¼˜åŒ–æ–¹æ¡ˆï¼šReact Query

**æ­¥éª¤ 1ï¼šå®‰è£…ä¾èµ–**

```bash
pnpm add @tanstack/react-query
```

**æ­¥éª¤ 2ï¼šé…ç½® React Query**

```typescript
// src/app/providers.tsx
'use client';

import { QueryClient, QueryClientProvider } from '@tanstack/react-query';
import { ReactQueryDevtools } from '@tanstack/react-query-devtools';
import { useState } from 'react';

export function Providers({ children }: { children: React.ReactNode }) {
  const [queryClient] = useState(
    () =>
      new QueryClient({
        defaultOptions: {
          queries: {
            staleTime: 5 * 60 * 1000, // 5åˆ†é’Ÿå†…è®¤ä¸ºæ•°æ®æ˜¯æ–°é²œçš„
            cacheTime: 10 * 60 * 1000, // ç¼“å­˜10åˆ†é’Ÿ
            refetchOnWindowFocus: false, // çª—å£èšç„¦æ—¶ä¸è‡ªåŠ¨åˆ·æ–°
            retry: 2, // å¤±è´¥é‡è¯•2æ¬¡
            retryDelay: (attemptIndex) => Math.min(1000 * 2 ** attemptIndex, 30000),
          },
          mutations: {
            retry: 1,
          },
        },
      })
  );

  return (
    <QueryClientProvider client={queryClient}>
      {children}
      <ReactQueryDevtools initialIsOpen={false} />
    </QueryClientProvider>
  );
}

// src/app/layout.tsx
import { Providers } from './providers';

export default function RootLayout({ children }: { children: React.ReactNode }) {
  return (
    <html lang="zh-CN">
      <body>
        <Providers>{children}</Providers>
      </body>
    </html>
  );
}
```

**æ­¥éª¤ 3ï¼šå°è£… API å®¢æˆ·ç«¯**

```typescript
// src/lib/api/client.ts
const BACKEND_URL = process.env.NEXT_PUBLIC_BACKEND_URL || 'http://localhost:5001';

class ApiClient {
  private baseUrl: string;

  constructor(baseUrl: string) {
    this.baseUrl = baseUrl;
  }

  async get<T>(path: string, params?: Record<string, string>): Promise<T> {
    const url = new URL(`${this.baseUrl}${path}`);
    Object.entries(params || {}).forEach(([key, value]) => {
      url.searchParams.set(key, value);
    });

    const response = await fetch(url.toString(), {
      headers: {
        'Content-Type': 'application/json',
      },
    });

    if (!response.ok) {
      throw new Error(`API è¯·æ±‚å¤±è´¥: ${response.status} ${response.statusText}`);
    }

    return response.json();
  }

  async post<T>(path: string, data?: any): Promise<T> {
    const response = await fetch(`${this.baseUrl}${path}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(data),
    });

    if (!response.ok) {
      throw new Error(`API è¯·æ±‚å¤±è´¥: ${response.status} ${response.statusText}`);
    }

    return response.json();
  }

  async put<T>(path: string, data?: any): Promise<T> {
    const response = await fetch(`${this.baseUrl}${path}`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(data),
    });

    if (!response.ok) {
      throw new Error(`API è¯·æ±‚å¤±è´¥: ${response.status} ${response.statusText}`);
    }

    return response.json();
  }

  async delete<T>(path: string): Promise<T> {
    const response = await fetch(`${this.baseUrl}${path}`, {
      method: 'DELETE',
      headers: {
        'Content-Type': 'application/json',
      },
    });

    if (!response.ok) {
      throw new Error(`API è¯·æ±‚å¤±è´¥: ${response.status} ${response.statusText}`);
    }

    return response.json();
  }
}

export const apiClient = new ApiClient(BACKEND_URL);
```

**æ­¥éª¤ 4ï¼šä½¿ç”¨ React Query**

```typescript
// src/lib/api/collab.ts
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { apiClient } from './client';

// è·å–ååŒç»Ÿè®¡
export function useCollabStats(timeRange: string) {
  return useQuery({
    queryKey: ['collab-stats', timeRange],
    queryFn: () => apiClient.get<CollabStats>(`/api/collab/stats`, { timeRange }),
    staleTime: 5 * 60 * 1000, // 5åˆ†é’Ÿ
  });
}

// è·å–å·¥ä½œäººå‘˜æ´»åŠ¨
export function useStaffActivity(timeRange: string, limit = 50) {
  return useQuery({
    queryKey: ['staff-activity', timeRange, limit],
    queryFn: () => apiClient.get<StaffActivity[]>(`/api/collab/staff-activity`, {
      timeRange,
      limit: String(limit)
    }),
    staleTime: 3 * 60 * 1000, // 3åˆ†é’Ÿ
  });
}

// è·å–å†³ç­–æ—¥å¿—
export function useDecisionLogs(timeRange: string, limit = 20, page = 1) {
  return useQuery({
    queryKey: ['decision-logs', timeRange, limit, page],
    queryFn: () => apiClient.get<DecisionLogs>(`/api/collab/decision-logs`, {
      timeRange,
      limit: String(limit),
      page: String(page)
    }),
    staleTime: 1 * 60 * 1000, // 1åˆ†é’Ÿ
  });
}

// åˆ·æ–°æ‰€æœ‰ååŒæ•°æ®
export function useRefreshCollabData() {
  const queryClient = useQueryClient();

  return () => {
    queryClient.invalidateQueries({ queryKey: ['collab-stats'] });
    queryClient.invalidateQueries({ queryKey: ['staff-activity'] });
    queryClient.invalidateQueries({ queryKey: ['decision-logs'] });
  };
}
```

**æ­¥éª¤ 5ï¼šåœ¨ç»„ä»¶ä¸­ä½¿ç”¨**

```typescript
// src/app/collab-analytics/page.tsx
'use client';

import { useCollabStats, useStaffActivity, useRefreshCollabData } from '@/lib/api/collab';
import { Button } from '@/components/ui/button';
import { Skeleton } from '@/components/ui/skeleton';

export default function CollabAnalyticsPage() {
  const { data: stats, isLoading: statsLoading, error: statsError } = useCollabStats('24h');
  const { data: activities, isLoading: activitiesLoading } = useStaffActivity('24h');
  const refreshData = useRefreshCollabData();

  const handleRefresh = () => {
    refreshData();
  };

  if (statsError) {
    return <div>åŠ è½½å¤±è´¥: {statsError.message}</div>;
  }

  return (
    <div className="container mx-auto p-6">
      <div className="flex justify-between items-center mb-6">
        <h1 className="text-3xl font-bold">ååŒåˆ†æ</h1>
        <Button onClick={handleRefresh}>åˆ·æ–°æ•°æ®</Button>
      </div>

      {/* ç»Ÿè®¡å¡ç‰‡ */}
      <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
        <StatsCard
          title="æ€»å†³ç­–æ•°"
          value={stats?.totalDecisions || 0}
          loading={statsLoading}
        />
        <StatsCard
          title="AI å›å¤æ•°"
          value={stats?.aiReplies || 0}
          loading={statsLoading}
        />
        <StatsCard
          title="å·¥ä½œäººå‘˜ä»‹å…¥æ•°"
          value={stats?.staffInterventions || 0}
          loading={statsLoading}
        />
      </div>

      {/* å·¥ä½œäººå‘˜æ´»åŠ¨ */}
      <div className="bg-white rounded-lg shadow p-6">
        <h2 className="text-xl font-bold mb-4">å·¥ä½œäººå‘˜æ´»åŠ¨</h2>
        {activitiesLoading ? (
          <Skeleton className="h-64 w-full" />
        ) : (
          <StaffActivityList activities={activities || []} />
        )}
      </div>
    </div>
  );
}

function StatsCard({ title, value, loading }: { title: string; value: number; loading: boolean }) {
  return (
    <div className="bg-white rounded-lg shadow p-6">
      <h3 className="text-lg font-semibold mb-2">{title}</h3>
      {loading ? (
        <Skeleton className="h-8 w-24" />
      ) : (
        <div className="text-3xl font-bold">{value}</div>
      )}
    </div>
  );
}
```

**ğŸ“Š æ€§èƒ½å¯¹æ¯”**

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|------|-------|-------|------|
| **é¦–æ¬¡åŠ è½½** | 2000ms | 800ms | **2.5å€** |
| **æ ‡ç­¾åˆ‡æ¢** | 1500ms | 50ms | **30å€** |
| **é‡å¤è¯·æ±‚** | æ¯æ¬¡è¯·æ±‚ | ç¼“å­˜å‘½ä¸­ | **å‡å°‘ 80%** |
| **ç½‘ç»œè¯·æ±‚æ•°** | 5-6 æ¬¡ | 1 æ¬¡ | **å‡å°‘ 80%** |

---

## ä¸‰ã€ä»£ç è´¨é‡ä¼˜åŒ–ï¼ˆä¼˜å…ˆçº§ P2ï¼‰

### 3.1 ä»£ç é‡æ„

#### ğŸ“Š é‡æ„ç›®æ ‡

| æ–‡ä»¶ | å½“å‰å¤æ‚åº¦ | ç›®æ ‡å¤æ‚åº¦ | ç­–ç•¥ |
|------|-----------|-----------|------|
| `worktool.callback.js` | åœˆå¤æ‚åº¦ 25+ | åœˆå¤æ‚åº¦ < 10 | æ‹†åˆ†ä¸ºå¤šä¸ªæ¨¡å— |
| `session.service.js` | åœˆå¤æ‚åº¦ 18 | åœˆå¤æ‚åº¦ < 10 | æå–å­ç±» |
| `decision.service.js` | åœˆå¤æ‚åº¦ 15 | åœˆå¤æ‚åº¦ < 10 | æ‹†åˆ†ç­–ç•¥æ¨¡å¼ |

#### âœ… é‡æ„æ–¹æ¡ˆ

**é‡æ„ 1ï¼šworktool.callback.js æ‹†åˆ†**

```javascript
// é‡æ„å‰ï¼šå•ä¸ªæ–‡ä»¶ 1500+ è¡Œ

// âœ… é‡æ„åï¼šæ‹†åˆ†ä¸ºå¤šä¸ªæ¨¡å—

// server/routes/worktool/handlers/message.handler.js
class MessageHandler {
  async handle(context) {
    // å¤„ç†æ¶ˆæ¯é€»è¾‘
  }
}

// server/routes/worktool/handlers/execution.handler.js
class ExecutionHandler {
  async handle(context) {
    // å¤„ç†æ‰§è¡Œç»“æœé€»è¾‘
  }
}

// server/routes/worktool/handlers/qrcode.handler.js
class QrCodeHandler {
  async handle(context) {
    // å¤„ç†äºŒç»´ç é€»è¾‘
  }
}

// server/routes/worktool/handlers/robot.handler.js
class RobotHandler {
  async handle(context) {
    // å¤„ç†æœºå™¨äººçŠ¶æ€é€»è¾‘
  }
}

// server/routes/worktool/callback/index.js
const MessageHandler = require('./handlers/message.handler');
const ExecutionHandler = require('./handlers/execution.handler');
const QrCodeHandler = require('./handlers/qrcode.handler');
const RobotHandler = require('./handlers/robot.handler');

module.exports = async function(fastify, options) {
  const messageHandler = new MessageHandler();
  const executionHandler = new ExecutionHandler();
  const qrcodeHandler = new QrCodeHandler();
  const robotHandler = new RobotHandler();

  fastify.post('/message', async (req, res) => {
    const result = await messageHandler.handle(req.body);
    res.send(result);
  });

  fastify.post('/execution', async (req, res) => {
    const result = await executionHandler.handle(req.body);
    res.send(result);
  });

  fastify.post('/qrcode', async (req, res) => {
    const result = await qrcodeHandler.handle(req.body);
    res.send(result);
  });

  fastify.post('/robot', async (req, res) => {
    const result = await robotHandler.handle(req.body);
    res.send(result);
  });
};
```

### 3.2 æµ‹è¯•è¦†ç›–

#### âœ… æµ‹è¯•æ–¹æ¡ˆ

**å•å…ƒæµ‹è¯•ï¼ˆJestï¼‰**

```javascript
// server/services/collab.service.test.js
const { CollabService } = require('./collab.service');

describe('CollabService', () => {
  let collabService;
  let mockDb;
  let mockCache;

  beforeEach(() => {
    mockDb = {
      query: jest.fn()
    };
    mockCache = {
      get: jest.fn(),
      set: jest.fn(),
      del: jest.fn()
    };
    collabService = new CollabService(mockDb, mockCache);
  });

  describe('getStats', () => {
    it('should return stats from cache', async () => {
      const cachedStats = { totalDecisions: 100, aiReplies: 50 };
      mockCache.get.mockResolvedValue(cachedStats);

      const result = await collabService.getStats('24h');

      expect(result).toEqual(cachedStats);
      expect(mockCache.get).toHaveBeenCalledWith('collab:stats:["24h"]');
      expect(mockDb.query).not.toHaveBeenCalled();
    });

    it('should query database when cache miss', async () => {
      const dbStats = { rows: [{ total_decisions: 100, ai_replies: 50 }] };
      mockCache.get.mockResolvedValue(null);
      mockDb.query.mockResolvedValue(dbStats);

      const result = await collabService.getStats('24h');

      expect(result).toEqual({ totalDecisions: 100, aiReplies: 50 });
      expect(mockDb.query).toHaveBeenCalled();
      expect(mockCache.set).toHaveBeenCalled();
    });
  });
});
```

**é›†æˆæµ‹è¯•**

```javascript
// server/routes/collab.api.test.js
const request = require('supertest');
const app = require('../app');

describe('Collab API', () => {
  let server;

  beforeAll(async () => {
    server = await app.listen(5001);
  });

  afterAll(async () => {
    await server.close();
  });

  describe('GET /api/collab/stats', () => {
    it('should return stats for valid timeRange', async () => {
      const response = await request(server)
        .get('/api/collab/stats?timeRange=24h')
        .expect(200);

      expect(response.body).toHaveProperty('totalDecisions');
      expect(response.body).toHaveProperty('aiReplies');
    });

    it('should return 400 for invalid timeRange', async () => {
      const response = await request(server)
        .get('/api/collab/stats?timeRange=invalid')
        .expect(400);

      expect(response.body).toHaveProperty('error');
    });
  });
});
```

### 3.3 TypeScript è¿ç§»

#### âœ… è¿ç§»ç­–ç•¥

**é˜¶æ®µ 1ï¼šç±»å‹å®šä¹‰**

```typescript
// server/types/collab.types.ts
export interface CollabStats {
  totalDecisions: number;
  aiReplies: number;
  staffInterventions: number;
  avgResponseTime: number;
}

export interface StaffActivity {
  staffUserId: string;
  activityCount: number;
  lastActivity: Date;
}

export interface DecisionLog {
  id: string;
  sessionId: string;
  shouldAiReply: boolean;
  staffIntervened: boolean;
  responseTime?: number;
  createdAt: Date;
}
```

**é˜¶æ®µ 2ï¼šæœåŠ¡å±‚è¿ç§»**

```typescript
// server/services/collab.service.ts
import { CollabStats, StaffActivity } from '../types/collab.types';

export class CollabService {
  async getStats(timeRange: string): Promise<CollabStats> {
    const stats = await this.db.query<CollabStats>(`
      SELECT
        COUNT(*) as total_decisions,
        SUM(CASE WHEN should_ai_reply THEN 1 ELSE 0 END) as ai_replies,
        SUM(CASE WHEN staff_intervened THEN 1 ELSE 0 END) as staff_interventions,
        AVG(CASE WHEN staff_intervened THEN response_time ELSE NULL END) as avg_response_time
      FROM collaboration_decision_logs
      WHERE created_at >= NOW() - INTERVAL '${timeRange}'
    `);

    return stats[0];
  }
}
```

---

## å››ã€æ¶æ„ä¼˜åŒ–æ–¹æ¡ˆï¼ˆä¼˜å…ˆçº§ P3ï¼‰

### 4.1 å¾®æœåŠ¡æ¶æ„

#### âœ… æ¶æ„æ¼”è¿›

**å½“å‰æ¶æ„ï¼šå•ä½“åº”ç”¨**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   WorkTool AI (å•ä½“åº”ç”¨)     â”‚
â”‚  - Fastify (5001)           â”‚
â”‚  - Next.js (5000)           â”‚
â”‚  - PostgreSQL               â”‚
â”‚  - Redis                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ç›®æ ‡æ¶æ„ï¼šå¾®æœåŠ¡**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  API ç½‘å…³    â”‚  â”‚  AI æœåŠ¡     â”‚  â”‚  ååŒæœåŠ¡    â”‚
â”‚  (Fastify)   â”‚â—„â”€â”¤  (Fastify)   â”‚â—„â”€â”¤  (Fastify)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                 â”‚                 â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚   PostgreSQL (å…±äº«)   â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚      Redis (å…±äº«)     â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 å®æ—¶é€šä¿¡ä¼˜åŒ–

#### âœ… SSE vs WebSocket å¯¹æ¯”

| ç‰¹æ€§ | SSE | WebSocket |
|------|-----|-----------|
| **å•å‘é€šä¿¡** | âœ… | âŒ |
| **åŒå‘é€šä¿¡** | âŒ | âœ… |
| **HTTP/2** | âœ… | âŒ |
| **è‡ªåŠ¨é‡è¿** | âœ… | éœ€æ‰‹åŠ¨ |
| **å®ç°å¤æ‚åº¦** | ä½ | é«˜ |
| **é€‚ç”¨åœºæ™¯** | å®æ—¶æ•°æ®æ¨é€ | èŠå¤©ã€æ¸¸æˆ |

**æ¨èæ–¹æ¡ˆï¼šSSEï¼ˆå®æ—¶æ•°æ®æ¨é€ï¼‰**

```javascript
// server/routes/collab/api.js
app.get('/api/collab/sse-updates', async (req, res) => {
  res.setHeader('Content-Type', 'text/event-stream');
  res.setHeader('Cache-Control', 'no-cache');
  res.setHeader('Connection', 'keep-alive');
  res.setHeader('X-Accel-Buffering', 'no');

  const redis = await redisClient.getClient();
  const subscriber = redis.duplicate();

  await subscriber.subscribe('collab:updates');

  subscriber.on('message', (channel, message) => {
    try {
      res.write(`data: ${message}\n\n`);
    } catch (error) {
      subscriber.unsubscribe();
    }
  });

  req.on('close', () => {
    subscriber.unsubscribe();
    subscriber.quit();
  });

  // å¿ƒè·³
  const heartbeat = setInterval(() => {
    res.write(': heartbeat\n\n');
  }, 30000);

  req.on('close', () => {
    clearInterval(heartbeat);
  });
});
```

---

## äº”ã€å®æ–½è·¯çº¿å›¾

### 5.1 é˜¶æ®µä¸€ï¼šå®‰å…¨åŠ å›ºï¼ˆç¬¬ 1 å‘¨ï¼‰

| ä»»åŠ¡ | è´Ÿè´£äºº | é¢„è®¡æ—¶é—´ | ä¾èµ– |
|------|-------|---------|------|
| ä¿®å¤ CORS é…ç½® | åç«¯ | 2h | æ—  |
| å¯ç”¨ Helmet CSP | åç«¯ | 1h | æ—  |
| æ·»åŠ  JWT è®¤è¯ | åç«¯ | 8h | æ—  |
| æ·»åŠ  API Key è®¤è¯ | åç«¯ | 4h | æ—  |
| æ·»åŠ ç®¡ç†å‘˜æƒé™éªŒè¯ | åç«¯ | 4h | JWT è®¤è¯ |
| ä¿®å¤å†…å­˜æ¨¡å¼è¿‡æœŸ | åç«¯ | 3h | æ—  |
| æ·»åŠ è¾“å…¥éªŒè¯ | å‰åç«¯ | 4h | æ—  |

**é‡Œç¨‹ç¢‘ï¼š** æ‰€æœ‰ P0 å®‰å…¨æ¼æ´ä¿®å¤å®Œæˆ

### 5.2 é˜¶æ®µäºŒï¼šæ€§èƒ½æå‡ï¼ˆç¬¬ 2-4 å‘¨ï¼‰

| ä»»åŠ¡ | è´Ÿè´£äºº | é¢„è®¡æ—¶é—´ | ä¾èµ– |
|------|-------|---------|------|
| å®ç° Redis ç¼“å­˜ | åç«¯ | 16h | æ—  |
| æ·»åŠ æ•°æ®åº“ç´¢å¼• | åç«¯ | 2h | æ—  |
| ä¼˜åŒ– N+1 æŸ¥è¯¢ | åç«¯ | 8h | æ—  |
| å®ç° React Query | å‰ç«¯ | 8h | æ—  |
| å®ç°æ‰¹é‡ API | å‰åç«¯ | 8h | æ—  |
| æ·»åŠ è™šæ‹Ÿæ»šåŠ¨ | å‰ç«¯ | 12h | æ—  |
| æ€§èƒ½æµ‹è¯• | æµ‹è¯• | 8h | ä¸Šè¿°å…¨éƒ¨ |

**é‡Œç¨‹ç¢‘ï¼š** ç³»ç»Ÿæ€§èƒ½æå‡ 5-10 å€

### 5.3 é˜¶æ®µä¸‰ï¼šè´¨é‡æå‡ï¼ˆç¬¬ 5-8 å‘¨ï¼‰

| ä»»åŠ¡ | è´Ÿè´£äºº | é¢„è®¡æ—¶é—´ | ä¾èµ– |
|------|-------|---------|------|
| é‡æ„ worktool.callback.js | åç«¯ | 16h | æ—  |
| æ·»åŠ å•å…ƒæµ‹è¯• | å…¨å‘˜ | 24h | æ—  |
| æ·»åŠ é›†æˆæµ‹è¯• | å…¨å‘˜ | 16h | æ—  |
| TypeScript è¿ç§» | åç«¯ | 32h | æ—  |
| æ·»åŠ  API æ–‡æ¡£ | åç«¯ | 8h | æ—  |
| æ·»åŠ æŠ€æœ¯æ–‡æ¡£ | å…¨å‘˜ | 8h | æ—  |

**é‡Œç¨‹ç¢‘ï¼š** æµ‹è¯•è¦†ç›–ç‡è¾¾åˆ° 80%

---

## å…­ã€é£é™©æƒè¡¡åˆ†æ

### 6.1 ä¼˜åŒ–é£é™©

| é£é™©ç±»å‹ | æ¦‚ç‡ | å½±å“ | ç¼“è§£æªæ–½ |
|---------|------|------|---------|
| **æ€§èƒ½å›é€€** | ä½ | ä¸­ | ç°åº¦å‘å¸ƒï¼Œæ€§èƒ½ç›‘æ§ |
| **å…¼å®¹æ€§é—®é¢˜** | ä¸­ | ä¸­ | å……åˆ†æµ‹è¯•ï¼Œé¢„ç•™å›æ»š |
| **å¼•å…¥æ–° BUG** | ä¸­ | é«˜ | ä»£ç å®¡æŸ¥ï¼Œè‡ªåŠ¨åŒ–æµ‹è¯• |
| **æ•°æ®ä¸ä¸€è‡´** | ä½ | é«˜ | ç¼“å­˜å¤±æ•ˆç­–ç•¥ï¼Œæ•°æ®éªŒè¯ |
| **ç”¨æˆ·ä½“éªŒä¸‹é™** | ä½ | ä¸­ | A/B æµ‹è¯•ï¼Œç”¨æˆ·åé¦ˆ |

### 6.2 æŠ•å…¥äº§å‡ºåˆ†æ

| ä¼˜åŒ–é¡¹ | æŠ•å…¥ï¼ˆå·¥æ—¶ï¼‰ | æ”¶ç›Š | ROI |
|-------|------------|------|-----|
| **å®‰å…¨ä¿®å¤** | 40h | é«˜ | â­â­â­â­â­ |
| **Redis ç¼“å­˜** | 16h | æé«˜ | â­â­â­â­â­ |
| **æŸ¥è¯¢ä¼˜åŒ–** | 10h | é«˜ | â­â­â­â­ |
| **React Query** | 8h | é«˜ | â­â­â­â­ |
| **ä»£ç é‡æ„** | 48h | ä¸­ | â­â­â­ |
| **TypeScript è¿ç§»** | 32h | ä¸­é«˜ | â­â­â­â­ |

**ç»“è®ºï¼š**
- **ç«‹å³å®æ–½**ï¼šå®‰å…¨ä¿®å¤ã€Redis ç¼“å­˜ã€æŸ¥è¯¢ä¼˜åŒ–
- **çŸ­æœŸå®æ–½**ï¼šReact Queryã€è¾“å…¥éªŒè¯
- **ä¸­æœŸè€ƒè™‘**ï¼šä»£ç é‡æ„ã€TypeScript è¿ç§»

---

## ä¸ƒã€æˆæœ¬æ•ˆç›Šåˆ†æ

### 7.1 æŠ•å…¥æˆæœ¬

| é˜¶æ®µ | äººåŠ›æˆæœ¬ | æœåŠ¡å™¨æˆæœ¬ | æ€»æˆæœ¬ |
|------|---------|-----------|-------|
| **é˜¶æ®µä¸€ï¼ˆå®‰å…¨ï¼‰** | 40h Ã— 500 = 20,000 | 0 | 20,000 |
| **é˜¶æ®µäºŒï¼ˆæ€§èƒ½ï¼‰** | 72h Ã— 500 = 36,000 | 200/æœˆ | 36,200 |
| **é˜¶æ®µä¸‰ï¼ˆè´¨é‡ï¼‰** | 88h Ã— 500 = 44,000 | 0 | 44,000 |
| **æ€»è®¡** | **100,200** | **200** | **100,400** |

### 7.2 æ”¶ç›Šåˆ†æ

| æ”¶ç›Šç±»å‹ | å®šé‡æ”¶ç›Š | å®šæ€§æ”¶ç›Š |
|---------|---------|---------|
| **æ€§èƒ½æå‡** | å“åº”æ—¶é—´ 10-50 å€ | ç”¨æˆ·ä½“éªŒæ˜¾è‘—æ”¹å–„ |
| **å®‰å…¨æ€§** | é¿å…å®‰å…¨äº‹ä»¶æŸå¤± | é™ä½æ³•å¾‹é£é™© |
| **å¯ç»´æŠ¤æ€§** | å‡å°‘ç»´æŠ¤æˆæœ¬ 30% | å›¢é˜Ÿæ•ˆç‡æå‡ |
| **å¯æ‰©å±•æ€§** | å¹¶å‘èƒ½åŠ›æå‡ 10 å€ | æ”¯æŒä¸šåŠ¡å¢é•¿ |

**ç»“è®ºï¼š**
- **æŠ•å…¥**ï¼šçº¦ 10 ä¸‡
- **æ”¶ç›Š**ï¼šéš¾ä»¥é‡åŒ–ä½†è¿œå¤§äºæŠ•å…¥
- **ROI**ï¼šé¢„æœŸ > 300%

---

## å…«ã€æ€»ç»“

### 8.1 æ ¸å¿ƒå»ºè®®

1. **ä¼˜å…ˆä¿®å¤å®‰å…¨æ¼æ´**ï¼ˆP0ï¼Œ1 å‘¨å†…ï¼‰
2. **å®ç°æ€§èƒ½ä¼˜åŒ–**ï¼ˆP1ï¼Œ2-4 å‘¨ï¼‰
3. **æå‡ä»£ç è´¨é‡**ï¼ˆP2ï¼Œ1-2 ä¸ªæœˆï¼‰

### 8.2 å®æ–½ç­–ç•¥

- **å¿«èµ¢å…ˆè¡Œ**ï¼šå…ˆå®æ–½æŠ•å…¥å°‘ã€æ”¶ç›Šé«˜çš„ä¼˜åŒ–
- **ç¨³æ­¥æ¨è¿›**ï¼šåˆ†é˜¶æ®µå®æ–½ï¼Œæ¯ä¸ªé˜¶æ®µå……åˆ†æµ‹è¯•
- **æŒç»­ç›‘æ§**ï¼šå®æ—¶ç›‘æ§ä¼˜åŒ–æ•ˆæœ

### 8.3 æˆåŠŸæ ‡å‡†

- âœ… æ‰€æœ‰ P0 å®‰å…¨æ¼æ´ä¿®å¤
- âœ… ç³»ç»Ÿæ€§èƒ½æå‡ 5-10 å€
- âœ… æµ‹è¯•è¦†ç›–ç‡è¾¾åˆ° 80%
- âœ… æ–‡æ¡£å®Œå–„åº¦è¾¾åˆ° 90%

---

**æ–‡æ¡£ç»“æŸ**

**ä¸‹æ¬¡æ›´æ–°ï¼š** æ ¹æ®å®æ–½æƒ…å†µæŒç»­ä¼˜åŒ–
