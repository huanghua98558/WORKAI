# èŠ‚ç‚¹æµç¨‹ä¸ç›‘æ§é¢æ¿å®Œæ•´è®¾è®¡æ–‡æ¡£

## ğŸ“‹ æ–‡æ¡£ä¿¡æ¯

- **æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0
- **åˆ›å»ºæ—¥æœŸ**ï¼š2025-01-04
- **æœ€åæ›´æ–°**ï¼š2025-01-04
- **æ–‡æ¡£çŠ¶æ€**ï¼šæ­£å¼ç‰ˆ

---

## ğŸ“– ç›®å½•

1. [ç³»ç»Ÿæ¦‚è¿°](#1-ç³»ç»Ÿæ¦‚è¿°)
2. [æ¶æ„è®¾è®¡](#2-æ¶æ„è®¾è®¡)
3. [èŠ‚ç‚¹æµç¨‹è®¾è®¡](#3-èŠ‚ç‚¹æµç¨‹è®¾è®¡)
4. [æ•°æ®åº“è®¾è®¡](#4-æ•°æ®åº“è®¾è®¡)
5. [åŒç›‘æ§é¢æ¿è®¾è®¡](#5-åŒç›‘æ§é¢æ¿è®¾è®¡)
6. [WebSocketå®æ—¶æ¨é€è®¾è®¡](#6-websocketå®æ—¶æ¨é€è®¾è®¡)
7. [å®Œæ•´çš„æ•°æ®è®°å½•è®¾è®¡](#7-å®Œæ•´çš„æ•°æ®è®°å½•è®¾è®¡)
8. [å…³é”®æŠ€æœ¯ç‚¹](#8-å…³é”®æŠ€æœ¯ç‚¹)
9. [APIæ¥å£è®¾è®¡](#9-apiæ¥å£è®¾è®¡)
10. [éƒ¨ç½²å»ºè®®](#10-éƒ¨ç½²å»ºè®®)

---

## 1. ç³»ç»Ÿæ¦‚è¿°

### 1.1 ç³»ç»Ÿå®šä½

æœ¬ç³»ç»Ÿæ˜¯ä¸€ä¸ªåŸºäº WorkTool æœºå™¨äººçš„æ™ºèƒ½å®¢æœå¹³å°ï¼Œæ”¯æŒï¼š
- æ¥æ”¶ WorkTool æ¨é€çš„ç”¨æˆ·æ¶ˆæ¯
- AI æ„å›¾è¯†åˆ«
- AI å®¢æœè‡ªåŠ¨å›å¤
- å‘Šè­¦å¤„ç†ä¸é€šçŸ¥
- å®Œæ•´çš„æ¶ˆæ¯ç›‘æ§å’Œ AI äº¤äº’è¿½è¸ª

### 1.2 æ ¸å¿ƒåŠŸèƒ½

#### 1.2.1 æ¶ˆæ¯å¤„ç†é“¾è·¯
- WorkTool Webhook æ¥æ”¶æ¶ˆæ¯
- æ„å›¾ AI åˆ†ææ¶ˆæ¯æ„å›¾
- å†³ç­–èŠ‚ç‚¹åˆ¤æ–­æ‰§è¡Œè·¯å¾„
- AI å®¢æœç”Ÿæˆå›å¤
- å‘é€æœºå™¨äººæŒ‡ä»¤
- æ¥æ”¶æ‰§è¡Œç»“æœå›è°ƒ

#### 1.2.2 å‘Šè­¦å¤„ç†é“¾è·¯
- è¯†åˆ«é£é™©æ¶ˆæ¯
- å‘Šè­¦ä¿¡æ¯å…¥åº“
- å‘Šè­¦è§„åˆ™åˆ¤æ–­
- å¤šæ¸ é“é€šçŸ¥ï¼ˆå¼¹çª—ã€é‚®ä»¶ã€å£°éŸ³ã€æœºå™¨äººï¼‰
- å‰ç«¯ç›‘æ§é¢æ¿å±•ç¤º

#### 1.2.3 åŒç›‘æ§é¢æ¿
- **é¢æ¿1ï¼ˆä¸šåŠ¡æ¶ˆæ¯ï¼‰**ï¼šå±•ç¤ºç”¨æˆ·æ¶ˆæ¯ã€æœºå™¨äººå›å¤ã€æ‰§è¡ŒçŠ¶æ€
- **é¢æ¿2ï¼ˆAIäº¤äº’ï¼‰**ï¼šå±•ç¤ºå®Œæ•´çš„ AI äº¤äº’é“¾è·¯å’Œç³»ç»Ÿå†…éƒ¨æµç¨‹

### 1.3 æŠ€æœ¯æ ˆ

| ç»„ä»¶ | æŠ€æœ¯é€‰å‹ |
|------|----------|
| å‰ç«¯ | Next.js 16 + React 19 + shadcn/ui |
| åç«¯ | Node.js 24 + Fastify |
| æ•°æ®åº“ | PostgreSQL + Drizzle ORM |
| AI æœåŠ¡ | è±†åŒ…å¤§æ¨¡å‹ (doubao-pro-4k, doubao-pro-32k) |
| ç¼“å­˜ | Redis |
| å®æ—¶é€šä¿¡ | WebSocket |
| æœºå™¨äººAPI | WorkTool API |

---

## 2. æ¶æ„è®¾è®¡

### 2.1 ç³»ç»Ÿæ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         WorkTool å¹³å°                              â”‚
â”‚                   æœºå™¨äººæœåŠ¡ï¼ˆrobot_001, robot_002, ...ï¼‰           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   å›è°ƒä¸æŒ‡ä»¤é€šè®¯            â”‚
                    â”‚   (HTTP POST)              â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        åç«¯æœåŠ¡ (5001ç«¯å£)                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Webhookæ¥æ”¶å±‚                                             â”‚  â”‚
â”‚  â”‚  â”œâ”€ /api/worktool/callback/message    (æ¶ˆæ¯å›è°ƒ)          â”‚  â”‚
â”‚  â”‚  â”œâ”€ /api/worktool/callback/result    (æ‰§è¡Œç»“æœå›è°ƒ)       â”‚  â”‚
â”‚  â”‚  â”œâ”€ /api/worktool/callback/status    (ä¸Šä¸‹çº¿å›è°ƒ)         â”‚  â”‚
â”‚  â”‚  â””â”€ /api/worktool/callback/qrcode    (äºŒç»´ç å›è°ƒ)         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                          â†“                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  æµç¨‹å¼•æ“å±‚                                               â”‚  â”‚
â”‚  â”‚  â”œâ”€ èŠ‚ç‚¹1: æ¶ˆæ¯æ¥æ”¶ä¸æ•°æ®åº“ä¿å­˜                           â”‚  â”‚
â”‚  â”‚  â”œâ”€ èŠ‚ç‚¹2: æ„å›¾AIåˆ†æ                                     â”‚  â”‚
â”‚  â”‚  â”œâ”€ èŠ‚ç‚¹3: å†³ç­–èŠ‚ç‚¹                                       â”‚  â”‚
â”‚  â”‚  â”œâ”€ èŠ‚ç‚¹4: AIå®¢æœå›å¤                                     â”‚  â”‚
â”‚  â”‚  â”œâ”€ èŠ‚ç‚¹5: æ¶ˆæ¯åˆ†å‘åˆ¤æ–­                                   â”‚  â”‚
â”‚  â”‚  â”œâ”€ èŠ‚ç‚¹6: å‘é€æœºå™¨äººæŒ‡ä»¤                                 â”‚  â”‚
â”‚  â”‚  â”œâ”€ èŠ‚ç‚¹7: æŒ‡ä»¤çŠ¶æ€è®°å½•                                   â”‚  â”‚
â”‚  â”‚  â”œâ”€ èŠ‚ç‚¹8: ç»“æŸ                                           â”‚  â”‚
â”‚  â”‚  â”œâ”€ èŠ‚ç‚¹B1: å‘Šè­¦ä¿¡æ¯å…¥åº“                                  â”‚  â”‚
â”‚  â”‚  â”œâ”€ èŠ‚ç‚¹B2: å‘Šè­¦è§„åˆ™åˆ¤æ–­                                  â”‚  â”‚
â”‚  â”‚  â””â”€ èŠ‚ç‚¹B3: å‘Šè­¦é€šçŸ¥æ‰§è¡Œ                                  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                          â†“                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  æœåŠ¡å±‚                                                   â”‚  â”‚
â”‚  â”‚  â”œâ”€ worktool.service.js      (WorkTool APIè°ƒç”¨)           â”‚  â”‚
â”‚  â”‚  â”œâ”€ robot.service.js         (æœºå™¨äººç®¡ç†)                 â”‚  â”‚
â”‚  â”‚  â”œâ”€ robot-command.service.js (æŒ‡ä»¤é˜Ÿåˆ—ç®¡ç†)               â”‚  â”‚
â”‚  â”‚  â”œâ”€ ai.service.js            (AIæœåŠ¡è°ƒç”¨)                 â”‚  â”‚
â”‚  â”‚  â”œâ”€ alert.service.js         (å‘Šè­¦æœåŠ¡)                   â”‚  â”‚
â”‚  â”‚  â””â”€ websocket.service.js     (å®æ—¶æ¨é€)                   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                          â†“                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  æ•°æ®å±‚                                                   â”‚  â”‚
â”‚  â”‚  â”œâ”€ PostgreSQL (ä¸»æ•°æ®åº“)                                â”‚  â”‚
â”‚  â”‚  â””â”€ Redis (ç¼“å­˜ + æ¶ˆæ¯é˜Ÿåˆ—)                              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   WebSocketæ¨é€            â”‚
                    â”‚   (å®æ—¶æ›´æ–°ç›‘æ§é¢æ¿)        â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        å‰ç«¯æœåŠ¡ (5000ç«¯å£)                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  ç›‘æ§é¢æ¿1: ä¸šåŠ¡æ¶ˆæ¯ç›‘æ§                                   â”‚  â”‚
â”‚  â”‚  - ç”¨æˆ·æ¶ˆæ¯åˆ—è¡¨                                            â”‚  â”‚
â”‚  â”‚  - æœºå™¨äººå›å¤åˆ—è¡¨                                          â”‚  â”‚
â”‚  â”‚  - æ‰§è¡ŒçŠ¶æ€æ˜¾ç¤º                                            â”‚  â”‚
â”‚  â”‚  - ç­›é€‰å’Œæœç´¢                                              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  ç›‘æ§é¢æ¿2: AIäº¤äº’ç›‘æ§                                    â”‚  â”‚
â”‚  â”‚  - å®Œæ•´æ‰§è¡Œé“¾è·¯ï¼ˆæ—¶é—´çº¿ï¼‰                                 â”‚  â”‚
â”‚  â”‚  - AIè¾“å…¥è¾“å‡ºæŸ¥çœ‹                                         â”‚  â”‚
â”‚  â”‚  - æ€§èƒ½ç»Ÿè®¡                                               â”‚  â”‚
â”‚  â”‚  - è°ƒè¯•å·¥å…·                                               â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 æ¶ˆæ¯æµè½¬æ¶æ„

```
WorkTool æ¶ˆæ¯æ¨é€
    â†“
Webhook æ¥æ”¶ (æ¶ˆæ¯å›è°ƒ)
    â†“
ç”Ÿæˆ messageId (å”¯ä¸€è¿½è¸ªID)
    â†“
ä¿å­˜åˆ° session_messages (ç”¨æˆ·æ¶ˆæ¯)
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ„å›¾è¯†åˆ«èŠ‚ç‚¹                    â”‚
â”‚  â”œâ”€ è°ƒç”¨æ„å›¾AI                   â”‚
â”‚  â”œâ”€ ä¿å­˜ ai_io_logs (è¾“å…¥/è¾“å‡º)  â”‚
â”‚  â””â”€ æ›´æ–° session_messages        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å†³ç­–èŠ‚ç‚¹                        â”‚
â”‚  â”œâ”€ è·¯å¾„A: æ ‡å‡†å®¢æœ              â”‚
â”‚  â”œâ”€ è·¯å¾„B: éœ€è¦å‘Šè­¦              â”‚
â”‚  â””â”€ è·¯å¾„C: è·³è¿‡                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“ (è·¯å¾„A/B)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  AIå®¢æœå›å¤èŠ‚ç‚¹                  â”‚
â”‚  â”œâ”€ è·å–ä¼šè¯å†å²                 â”‚
â”‚  â”œâ”€ è°ƒç”¨å®¢æœAI                   â”‚
â”‚  â”œâ”€ ä¿å­˜ ai_io_logs (è¾“å…¥/è¾“å‡º)  â”‚
â”‚  â””â”€ ç”Ÿæˆå›å¤å†…å®¹                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ¶ˆæ¯åˆ†å‘åˆ¤æ–­èŠ‚ç‚¹                â”‚
â”‚  â”œâ”€ åˆ¤æ–­ç¾¤å‘/ç§å‘                â”‚
â”‚  â””â”€ ç¡®å®š targetName             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å‘é€æœºå™¨äººæŒ‡ä»¤èŠ‚ç‚¹              â”‚
â”‚  â”œâ”€ æ„é€ æŒ‡ä»¤æ•°æ®                 â”‚
â”‚  â”œâ”€ ä¿å­˜ robotCommands           â”‚
â”‚  â”œâ”€ è°ƒç”¨ WorkTool API            â”‚
â”‚  â”œâ”€ ä¿å­˜ api_call_logs           â”‚
â”‚  â””â”€ ä¿å­˜ session_messages (å›å¤) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
è¿”å›æˆåŠŸå“åº”ç»™ WorkTool
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç‹¬ç«‹å›è°ƒç›‘å¬æœåŠ¡                â”‚
â”‚  â”œâ”€ æ¥æ”¶æ‰§è¡Œç»“æœå›è°ƒ             â”‚
â”‚  â”œâ”€ ä¿å­˜ callback_history        â”‚
â”‚  â”œâ”€ æ›´æ–° robotCommands çŠ¶æ€      â”‚
â”‚  â”œâ”€ æ›´æ–° session_messages        â”‚
â”‚  â””â”€ WebSocket æ¨é€åˆ°å‰ç«¯         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. èŠ‚ç‚¹æµç¨‹è®¾è®¡

### 3.1 å®Œæ•´æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    WorkTool Webhookï¼ˆæ¶ˆæ¯å›è°ƒï¼‰                  â”‚
â”‚                  /api/worktool/callback/message?robotId={id}     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â†“
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  èŠ‚ç‚¹1: æ¶ˆæ¯æ¥æ”¶     â”‚
                    â”‚  + æ•°æ®åº“å®Œæ•´ä¿å­˜    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â†“
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  èŠ‚ç‚¹2: æ„å›¾AIåˆ†æ   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â†“
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   èŠ‚ç‚¹3: å†³ç­–èŠ‚ç‚¹    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â†“               â†“               â†“
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ è·¯å¾„Aï¼šæ ‡å‡†   â”‚ â”‚ è·¯å¾„Bï¼šéœ€è¦   â”‚ â”‚ è·¯å¾„Cï¼šè·³è¿‡   â”‚
   â”‚   å®¢æœå›å¤    â”‚ â”‚   å‘Šè­¦å¤„ç†    â”‚ â”‚    å¤„ç†      â”‚
   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
          â†“                â†“                â†“
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ èŠ‚ç‚¹4: AI    â”‚ â”‚ èŠ‚ç‚¹B1: å‘Šè­¦å…¥åº“     â”‚ â”‚ èŠ‚ç‚¹8: ç»“æŸ   â”‚
   â”‚  å®¢æœå›å¤    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  (è·³è¿‡å›å¤)   â”‚
   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜            â†“            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â†“             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚ èŠ‚ç‚¹B2: å‘Šè­¦  â”‚
   â”‚ èŠ‚ç‚¹5: æ¶ˆæ¯   â”‚     â”‚   è§„åˆ™åˆ¤æ–­    â”‚
   â”‚  åˆ†å‘åˆ¤æ–­    â”‚     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜            â†“
          â†“             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚ èŠ‚ç‚¹B3: å‘Šè­¦  â”‚
   â”‚ èŠ‚ç‚¹6: å‘é€   â”‚     â”‚   é€šçŸ¥æ‰§è¡Œ    â”‚
   â”‚  æœºå™¨äººæŒ‡ä»¤   â”‚     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜            â†“
          â†“             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚ åŒæ—¶ä¹Ÿå»     â”‚
   â”‚ èŠ‚ç‚¹7: æŒ‡ä»¤   â”‚     â”‚ èŠ‚ç‚¹4 (AI)   â”‚
   â”‚  çŠ¶æ€è®°å½•    â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜            â†“
          â†“             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚ èŠ‚ç‚¹5-7      â”‚
   â”‚ èŠ‚ç‚¹8: ç»“æŸ   â”‚     â”‚ (æ ‡å‡†æµç¨‹)   â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â†“
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ ç‹¬ç«‹çš„å›è°ƒç›‘å¬æœåŠ¡ï¼ˆå¼‚æ­¥ï¼‰            â”‚
   â”‚ WorkTool æ‰§è¡Œç»“æœå›è°ƒ â†’ æ›´æ–°æŒ‡ä»¤çŠ¶æ€ â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 èŠ‚ç‚¹è¯¦ç»†è®¾è®¡

#### 3.2.1 èŠ‚ç‚¹1ï¼šæ¶ˆæ¯æ¥æ”¶ä¸æ•°æ®åº“ä¿å­˜

**åŠŸèƒ½**ï¼šæ¥æ”¶ WorkTool æ¶ˆæ¯å›è°ƒï¼Œå®Œæ•´ä¿å­˜ï¼Œæå–ä¿¡æ¯

**è¾“å…¥æ•°æ®**ï¼ˆWorkTool å›è°ƒï¼‰ï¼š
```javascript
{
  spoken: "å¸®æˆ‘æŸ¥è®¢å•",        // é—®é¢˜æ–‡æœ¬
  rawSpoken: "å¸®æˆ‘æŸ¥è®¢å•",    // åŸå§‹é—®é¢˜
  receivedName: "å¼ ä¸‰",       // æé—®è€…åç§°
  groupName: "å®¢æœç¾¤",        // QAæ‰€åœ¨ç¾¤åï¼ˆå¯é€‰ï¼‰
  groupRemark: "è¿è¥ç¾¤",      // ç¾¤å¤‡æ³¨å
  roomType: 1,               // æˆ¿é—´ç±»å‹ï¼š1=å¤–éƒ¨ç¾¤ 2=å¤–éƒ¨è”ç³»äºº 3=å†…éƒ¨ç¾¤ 4=å†…éƒ¨è”ç³»äºº
  atMe: false,               // æ˜¯å¦@æœºå™¨äºº
  textType: 1,               // æ¶ˆæ¯ç±»å‹ï¼š0=æœªçŸ¥ 1=æ–‡æœ¬ 2=å›¾ç‰‡ 3=è¯­éŸ³
  fileBase64: "..."          // å›¾ç‰‡base64ï¼ˆå¯é€‰ï¼‰
}
```

**å¤„ç†é€»è¾‘**ï¼š
1. ä» URL å‚æ•°æå– `robotId`
2. æŸ¥è¯¢æ•°æ®åº“éªŒè¯æœºå™¨äººæ˜¯å¦å­˜åœ¨ä¸”å¯ç”¨
3. ç”Ÿæˆå”¯ä¸€çš„ `messageId`ï¼ˆUUIDï¼‰
4. è·å–æˆ–åˆ›å»ºä¼šè¯ID (`sessionId`)
5. å†™å…¥æ•°æ®åº“ `session_messages` è¡¨ï¼ˆç”¨æˆ·æ¶ˆæ¯ï¼‰
6. æ„é€ æ ‡å‡†æ¶ˆæ¯æ ¼å¼
7. WebSocket æ¨é€åˆ°é¢æ¿2ï¼ˆé˜¶æ®µ1ï¼‰
8. ä¼ é€’ç»™ä¸‹ä¸€ä¸ªèŠ‚ç‚¹

**è¾“å‡ºæ¶ˆæ¯æ ¼å¼**ï¼ˆç»Ÿä¸€æ ¼å¼ï¼‰ï¼š
```javascript
{
  // ===== æ¶ˆæ¯è¿½è¸ª =====
  messageId: "msg_xxx",
  sessionId: "session_xxx",
  robotId: "robot_123",
  
  // ===== ç”¨æˆ·ä¿¡æ¯ =====
  userName: "å¼ ä¸‰",
  groupName: "å®¢æœç¾¤",  // ç¾¤å‘æ—¶æœ‰å€¼ï¼Œç§å‘ä¸ºnull
  roomType: 1,
  
  // ===== æ¶ˆæ¯å†…å®¹ =====
  messageContent: "å¸®æˆ‘æŸ¥è®¢å•",
  messageRaw: "{...}",  // åŸå§‹å›è°ƒæ•°æ®
  
  // ===== æ—¶é—´ =====
  timestamp: 1234567890,
  
  // ===== æœºå™¨äººé…ç½® =====
  robotConfig: {
    apiBaseUrl: "https://xxx",
    robotName: "å®¢æœæœºå™¨äºº",
    isActive: true,
    status: "online"
  }
}
```

**æ•°æ®åº“å†™å…¥**ï¼š
```sql
INSERT INTO session_messages (
  messageId, sessionId, robotId, userName, groupName, 
  content, isFromUser, isFromBot, timestamp, extraData
) VALUES (
  'msg_xxx', 'session_xxx', 'robot_123', 'å¼ ä¸‰', 'å®¢æœç¾¤',
  'å¸®æˆ‘æŸ¥è®¢å•', true, false, NOW(), '{...}'
);
```

---

#### 3.2.2 èŠ‚ç‚¹2ï¼šæ„å›¾AIåˆ†æ

**åŠŸèƒ½**ï¼šåˆ†ææ¶ˆæ¯æ„å›¾

**å¤„ç†é€»è¾‘**ï¼š
1. ä»æ¶ˆæ¯ä¸­æå– `messageContent`
2. æ ¹æ®é…ç½®é€‰æ‹© AI æ¨¡å‹ï¼ˆè±†åŒ… doubao-pro-4kï¼‰
3. æ„é€ æç¤ºè¯ï¼ˆä» `intent_configs` è¡¨è¯»å–ï¼‰
4. è°ƒç”¨ AI æœåŠ¡
5. è§£æè¿”å›ç»“æœ
6. å†™å…¥æ•°æ®åº“ `ai_io_logs` è¡¨ï¼ˆæ„å›¾è¯†åˆ«ï¼‰
7. æ›´æ–° `session_messages` è¡¨ï¼ˆæ·»åŠ  intent å’Œ confidenceï¼‰
8. WebSocket æ¨é€åˆ°é¢æ¿2ï¼ˆé˜¶æ®µ2å®Œæˆï¼‰
9. ä¼ é€’ç»™ä¸‹ä¸€ä¸ªèŠ‚ç‚¹

**AI è¾“å…¥æ„é€ **ï¼š
```javascript
const aiInput = `
ä½ æ˜¯ä¸€ä¸ªæ„å›¾è¯†åˆ«åŠ©æ‰‹ã€‚è¯·åˆ†æä»¥ä¸‹æ¶ˆæ¯çš„æ„å›¾ç±»å‹ã€‚

ç”¨æˆ·æ¶ˆæ¯ï¼š${messageContext.messageContent}
å‘é€è€…ï¼š${messageContext.userName}
${messageContext.groupName ? `ç¾¤ç»„ï¼š${messageContext.groupName}` : ''}

å¯é€‰æ„å›¾ç±»å‹ï¼š
- service: æœåŠ¡å’¨è¯¢ï¼ˆå¦‚æŸ¥è®¢å•ã€æŸ¥ç‰©æµã€é€€æ¬¾ç­‰ï¼‰
- help: å¸®åŠ©è¯·æ±‚ï¼ˆå¦‚æ€ä¹ˆç”¨ã€æ€ä¹ˆæ“ä½œç­‰ï¼‰
- chat: èŠå¤©é—²èŠï¼ˆå¦‚ä½ å¥½ã€å¤©æ°”ç­‰ï¼‰
- risk: é£é™©æ¶ˆæ¯ï¼ˆå¦‚æŠ•è¯‰ã€ä¸¾æŠ¥ã€æ¶æ„è¨€è®ºç­‰ï¼‰
- spam: åƒåœ¾ä¿¡æ¯ï¼ˆå¦‚å¹¿å‘Šã€åˆ·å±ç­‰ï¼‰
- admin: ç®¡ç†ç›¸å…³ï¼ˆå¦‚ç³»ç»Ÿé…ç½®ã€æƒé™ç­‰ï¼‰

è¯·ä»¥JSONæ ¼å¼è¿”å›ï¼š
{
  "intent": "æ„å›¾ç±»å‹",
  "confidence": 0-100,
  "reason": "åˆ¤æ–­ç†ç”±"
}
`;
```

**è¾“å‡ºæ¶ˆæ¯æ ¼å¼**ï¼š
```javascript
{
  // ... ä¿ç•™æ‰€æœ‰ä¸Šæ¸¸ä¿¡æ¯
  intent: "service",
  confidence: 95,
  aiRawResponse: "{intent: service, confidence: 95, reason: ...}"
}
```

**æ•°æ®åº“å†™å…¥**ï¼š
```sql
-- å†™å…¥ ai_io_logs
INSERT INTO ai_io_logs (
  sessionId, messageId, robotId, robotName,
  operationType, aiInput, aiOutput, modelId, temperature,
  requestDuration, status, errorMessage
) VALUES (
  'session_xxx', 'msg_xxx', 'robot_123', 'å®¢æœæœºå™¨äºº',
  'intent_recognition', '${aiInput}', '${aiOutput}', 'doubao-pro-4k', '0.3',
  1250, 'success', NULL
);

-- æ›´æ–° session_messages
UPDATE session_messages 
SET intent = 'service', confidence = 95
WHERE messageId = 'msg_xxx';
```

---

#### 3.2.3 èŠ‚ç‚¹3ï¼šå†³ç­–èŠ‚ç‚¹

**åŠŸèƒ½**ï¼šæ ¹æ®æ„å›¾å†³å®šæ‰§è¡Œè·¯å¾„

**åˆ†æ”¯é…ç½®**ï¼š
```
è·¯å¾„Aï¼ˆæ ‡å‡†å®¢æœï¼‰ï¼š
  - è§¦å‘æ¡ä»¶ï¼šintent âˆˆ {service, help, chat}
  - æ‰§è¡Œï¼šèŠ‚ç‚¹4 â†’ èŠ‚ç‚¹5 â†’ èŠ‚ç‚¹6 â†’ èŠ‚ç‚¹7 â†’ èŠ‚ç‚¹8

è·¯å¾„Bï¼ˆéœ€è¦å‘Šè­¦ï¼‰ï¼š
  - è§¦å‘æ¡ä»¶ï¼šintent âˆˆ {risk, spam, admin}
  - æ‰§è¡Œï¼š
    * å¹¶è¡Œæ‰§è¡Œï¼šèŠ‚ç‚¹B1 â†’ èŠ‚ç‚¹B2 â†’ èŠ‚ç‚¹B3
    * åŒæ—¶ä¹Ÿæ‰§è¡Œï¼šèŠ‚ç‚¹4 â†’ èŠ‚ç‚¹5 â†’ èŠ‚ç‚¹6 â†’ èŠ‚ç‚¹7 â†’ èŠ‚ç‚¹8

è·¯å¾„Cï¼ˆè·³è¿‡ï¼‰ï¼š
  - è§¦å‘æ¡ä»¶ï¼šintent = "unknown" æˆ–å…¶ä»–
  - æ‰§è¡Œï¼šç›´æ¥åˆ°èŠ‚ç‚¹8ï¼ˆä¸å›å¤ï¼‰
```

**è¾“å‡ºæ¶ˆæ¯æ ¼å¼**ï¼š
```javascript
{
  // ... ä¿ç•™æ‰€æœ‰ä¸Šæ¸¸ä¿¡æ¯
  alertLevel: "warning",  // å¦‚æœéœ€è¦å‘Šè­¦
  executePath: "B"  // A/B/C
}
```

**WebSocket æ¨é€**ï¼š
```javascript
await websocketService.broadcast('monitor:ai', {
  type: 'stage_complete',
  messageId: messageContext.messageId,
  stage: 'stage3_decision',
  data: {
    timestamp: Date.now(),
    intent: messageContext.intent,
    confidence: messageContext.confidence,
    executePath: executePath,
    alertLevel: alertLevel || null
  }
});
```

---

#### 3.2.4 èŠ‚ç‚¹B1ï¼šå‘Šè­¦ä¿¡æ¯å…¥åº“

**åŠŸèƒ½**ï¼šä¿å­˜å‘Šè­¦ä¿¡æ¯åˆ°æ•°æ®åº“

**å¤„ç†é€»è¾‘**ï¼š
1. æ„é€ å‘Šè­¦æ•°æ®
2. å†™å…¥æ•°æ®åº“ `alert_history` è¡¨
3. æ¨é€åˆ°å‰ç«¯ç›‘æ§é¢æ¿ï¼ˆWebSocketï¼‰
4. ä¼ é€’ç»™ä¸‹ä¸€ä¸ªèŠ‚ç‚¹

**è¾“å‡ºæ¶ˆæ¯æ ¼å¼**ï¼š
```javascript
{
  // ... ä¿ç•™æ‰€æœ‰ä¸Šæ¸¸ä¿¡æ¯
  alertId: "alert_xxx",
  alertStatus: "pending"
}
```

**æ•°æ®åº“å†™å…¥**ï¼š
```sql
INSERT INTO alert_history (
  alertId, sessionId, robotId, intentType, alertLevel,
  userName, groupName, messageContent, alertMessage,
  status, confidence, createdAt
) VALUES (
  'alert_xxx', 'session_xxx', 'robot_123', 'risk', 'warning',
  'å¼ ä¸‰', 'å®¢æœç¾¤', 'å¸®æˆ‘æŸ¥è®¢å•', 'å‘Šè­¦ï¼šæ£€æµ‹åˆ°warningçº§åˆ«é£é™©æ¶ˆæ¯',
  'pending', 95, NOW()
);
```

---

#### 3.2.5 èŠ‚ç‚¹B2ï¼šå‘Šè­¦è§„åˆ™åˆ¤æ–­

**åŠŸèƒ½**ï¼šæ ¹æ®å‘Šè­¦ç­‰çº§åˆ¤æ–­é€šçŸ¥æ–¹å¼

**å¤„ç†é€»è¾‘**ï¼š
1. æ ¹æ® `alertLevel` æŸ¥è¯¢ `alert_rules` è¡¨
2. æŸ¥è¯¢ `notification_methods` è¡¨è·å–é€šçŸ¥æ–¹å¼
3. åˆ¤æ–­æ˜¯å¦éœ€è¦é€šçŸ¥ï¼š
   - Critical: å…¨éƒ¨é€šçŸ¥
   - Warning: å¼¹çª—+é‚®ä»¶+æœºå™¨äºº
   - Info: ä»…å¼¹çª—
4. ä¼ é€’ç»™ä¸‹ä¸€ä¸ªèŠ‚ç‚¹

**è¾“å‡ºæ¶ˆæ¯æ ¼å¼**ï¼š
```javascript
{
  // ... ä¿ç•™æ‰€æœ‰ä¸Šæ¸¸ä¿¡æ¯
  notifyRequired: true,
  notifyConfig: {
    methods: ["popup", "email", "robot"],
    recipients: {
      email: ["admin@example.com"],
      robot: [
        { type: "private", name: "å¼ ä¸‰" },
        { type: "group", groupName: "è¿è¥ç¾¤" }
      ]
    }
  }
}
```

---

#### 3.2.6 èŠ‚ç‚¹B3ï¼šå‘Šè­¦é€šçŸ¥æ‰§è¡Œ

**åŠŸèƒ½**ï¼šæ‰§è¡Œå„ç§é€šçŸ¥æ–¹å¼

**å¤„ç†é€»è¾‘**ï¼š
1. å¹¶è¡Œæ‰§è¡Œå„ç§é€šçŸ¥æ–¹å¼ï¼š
   - **å¼¹çª—é€šçŸ¥**ï¼šé€šè¿‡ WebSocket æ¨é€åˆ°å‰ç«¯
   - **é‚®ä»¶é€šçŸ¥**ï¼šæ„é€ é‚®ä»¶å†…å®¹ï¼Œå‘é€ SMTP è¯·æ±‚
   - **æœºå™¨äººé€šçŸ¥**ï¼šè°ƒç”¨æœºå™¨äºº API å‘é€æ¶ˆæ¯
2. æ›´æ–°æ•°æ®åº“ `alert_history` è¡¨ï¼ˆé€šçŸ¥ç»“æœï¼‰
3. å¦‚æœæœ‰æœºå™¨äººé€šçŸ¥ï¼Œè®°å½•æŒ‡ä»¤åˆ° `robotCommands` è¡¨
4. ä¼ é€’ç»™ä¸‹ä¸€ä¸ªèŠ‚ç‚¹

**è¾“å‡ºæ¶ˆæ¯æ ¼å¼**ï¼š
```javascript
{
  // ... ä¿ç•™æ‰€æœ‰ä¸Šæ¸¸ä¿¡æ¯
  notifyResult: {
    popup: { success: true },
    email: { success: true, messageId: "email_xxx" },
    robot: { 
      private: [{ name: "å¼ ä¸‰", success: true }],
      group: [{ groupName: "è¿è¥ç¾¤", success: true }]
    }
  }
}
```

**æ•°æ®åº“å†™å…¥**ï¼š
```sql
-- æ›´æ–° alert_history
UPDATE alert_history 
SET notificationStatus = 'sent',
    notificationResult = '${JSON.stringify(results)}'
WHERE alertId = 'alert_xxx';

-- è®°å½•æœºå™¨äººé€šçŸ¥æŒ‡ä»¤
INSERT INTO robotCommands (id, robotId, commandType, commandData, status)
VALUES ('cmd_alert_xxx', 'robot_123', 'alert_notification', '{...}', 'pending');
```

---

#### 3.2.7 èŠ‚ç‚¹4ï¼šAIå®¢æœå›å¤

**åŠŸèƒ½**ï¼šç”Ÿæˆ AI å›å¤

**å¤„ç†é€»è¾‘**ï¼š
1. æ ¹æ®é€‰æ‹©æç¤ºè¯æ¨¡æ¿
2. å¦‚æœå¯ç”¨ä¼šè¯è®°å¿†ï¼Œä»æ•°æ®åº“æŸ¥è¯¢æœ€è¿‘ N æ¡æ¶ˆæ¯
3. æ„é€  AI è¾“å…¥ï¼ˆå®Œæ•´ä¸Šä¸‹æ–‡ï¼‰
4. è°ƒç”¨ AI æœåŠ¡ï¼ˆdoubao-pro-32kï¼‰
5. è§£æ AI è¿”å›
6. å¦‚æœéœ€è¦ @ ç”¨æˆ·ï¼Œåœ¨å›å¤å‰æ·»åŠ  @{userName}
7. å†™å…¥æ•°æ®åº“ `ai_io_logs` è¡¨ï¼ˆå®¢æœå›å¤ï¼‰
8. WebSocket æ¨é€åˆ°é¢æ¿2ï¼ˆé˜¶æ®µ4å®Œæˆï¼‰
9. ä¼ é€’ç»™ä¸‹ä¸€ä¸ªèŠ‚ç‚¹

**AI è¾“å…¥æ„é€ **ï¼š
```javascript
const aiInput = `
ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„å®¢æœåŠ©æ‰‹ï¼Œè¯·æ ¹æ®ä»¥ä¸‹ä¿¡æ¯å›å¤ç”¨æˆ·ã€‚

ã€ç”¨æˆ·ä¿¡æ¯ã€‘
ç”¨æˆ·åï¼š${messageContext.userName}
${messageContext.groupName ? `ç¾¤ç»„ï¼š${messageContext.groupName}` : 'ç§èŠ'}

ã€æ¶ˆæ¯æ„å›¾ã€‘
æ„å›¾ç±»å‹ï¼š${messageContext.intent}
ç½®ä¿¡åº¦ï¼š${messageContext.confidence}%

ã€ä¼šè¯å†å²ã€‘ï¼ˆæœ€è¿‘10æ¡æ¶ˆæ¯ï¼‰
${historyMessages.map(msg => 
  `${msg.isFromUser ? 'ç”¨æˆ·' : 'å®¢æœ'}: ${msg.content}`
).join('\n')}

ã€å½“å‰æ¶ˆæ¯ã€‘
${messageContext.userName}: ${messageContext.messageContent}

è¯·ä»¥JSONæ ¼å¼è¿”å›å›å¤ï¼š
{
  "reply": "å›å¤å†…å®¹",
  "needHelp": true/false,
  "actions": []
}

è¦æ±‚ï¼š
1. å¦‚æœæ˜¯åœ¨ç¾¤é‡Œå›å¤ï¼Œå¼€å¤´éœ€è¦@ç”¨æˆ·å
2. è¯­æ°”å‹å¥½ä¸“ä¸š
3. å›å¤ç®€æ´æ˜äº†
`;
```

**è¾“å‡ºæ¶ˆæ¯æ ¼å¼**ï¼š
```javascript
{
  // ... ä¿ç•™æ‰€æœ‰ä¸Šæ¸¸ä¿¡æ¯
  aiReply: "@å¼ ä¸‰ æ‚¨çš„è®¢å•å·²å‘è´§ï¼Œé¢„è®¡æ˜å¤©é€è¾¾",
  aiRawResponse: "{reply: '@å¼ ä¸‰...', needHelp: false...}"
}
```

**æ•°æ®åº“å†™å…¥**ï¼š
```sql
INSERT INTO ai_io_logs (
  sessionId, messageId, robotId, robotName,
  operationType, aiInput, aiOutput, modelId, temperature,
  requestDuration, status, errorMessage
) VALUES (
  'session_xxx', 'msg_xxx', 'robot_123', 'å®¢æœæœºå™¨äºº',
  'service_reply', '${aiInput}', '${aiOutput}', 'doubao-pro-32k', '0.7',
  2100, 'success', NULL
);
```

---

#### 3.2.8 èŠ‚ç‚¹5ï¼šæ¶ˆæ¯åˆ†å‘åˆ¤æ–­

**åŠŸèƒ½**ï¼šåˆ¤æ–­æ˜¯ç¾¤å‘è¿˜æ˜¯ç§å‘

**å¤„ç†é€»è¾‘**ï¼š
1. æ£€æŸ¥ `groupName` å­—æ®µ
2. å¦‚æœ `groupName` æœ‰å€¼ï¼š
   - `sendType`: "group"
   - `targetName`: `groupName`
3. å¦‚æœ `groupName` ä¸º nullï¼š
   - `sendType`: "private"
   - `targetName`: `userName`
4. ä¼ é€’ç»™ä¸‹ä¸€ä¸ªèŠ‚ç‚¹

**è¾“å‡ºæ¶ˆæ¯æ ¼å¼**ï¼š
```javascript
{
  // ... ä¿ç•™æ‰€æœ‰ä¸Šæ¸¸ä¿¡æ¯
  sendType: "group",  // "group" æˆ– "private"
  targetName: "å®¢æœç¾¤"
}
```

---

#### 3.2.9 èŠ‚ç‚¹6ï¼šå‘é€æœºå™¨äººæŒ‡ä»¤

**åŠŸèƒ½**ï¼šå‘é€æ¶ˆæ¯åˆ°æœºå™¨äºº

**å¤„ç†é€»è¾‘**ï¼š
1. ç”Ÿæˆ `commandId`ï¼ˆUUIDï¼‰
2. æ„é€ æŒ‡ä»¤æ•°æ®
3. å†™å…¥æ•°æ®åº“ `robotCommands` è¡¨
4. è°ƒç”¨ WorkTool API
5. å†™å…¥æ•°æ®åº“ `api_call_logs` è¡¨
6. å†™å…¥æ•°æ®åº“ `session_messages` è¡¨ï¼ˆæœºå™¨äººå›å¤ï¼‰
7. WebSocket æ¨é€åˆ°é¢æ¿1ï¼ˆæ–°æ¶ˆæ¯ï¼‰
8. WebSocket æ¨é€åˆ°é¢æ¿2ï¼ˆé˜¶æ®µ5å®Œæˆï¼‰
9. ä¼ é€’ç»™ä¸‹ä¸€ä¸ªèŠ‚ç‚¹

**API è¯·æ±‚æ ¼å¼**ï¼š
```javascript
const commandData = {
  socketType: 2,
  list: [
    {
      type: 203,
      titleList: [messageContext.targetName],
      receivedContent: messageContext.aiReply,
      atList: []
    }
  ]
};
```

**API åœ°å€**ï¼š
```
POST {apiBaseUrl}/wework/sendRawMessage?robotId={robotId}
```

**è¾“å‡ºæ¶ˆæ¯æ ¼å¼**ï¼š
```javascript
{
  // ... ä¿ç•™æ‰€æœ‰ä¸Šæ¸¸ä¿¡æ¯
  replyMessageId: "msg_xxx_reply",
  commandResult: {
    success: true,
    commandId: "cmd_xxx",
    status: "pending",
    sentAt: 1234567890
  }
}
```

**æ•°æ®åº“å†™å…¥**ï¼š
```sql
-- å†™å…¥ robotCommands
INSERT INTO robotCommands (
  id, robotId, commandType, commandData, status, priority,
  retryCount, maxRetries, createdAt, updatedAt
) VALUES (
  'cmd_xxx', 'robot_123', 'send_message', '${JSON.stringify(commandData)}',
  'pending', 5, 0, 3, NOW(), NOW()
);

-- å†™å…¥ api_call_logs
INSERT INTO api_call_logs (
  robotId, apiType, apiUrl, httpMethod, requestParams,
  requestBody, responseStatus, responseData, responseTime, success
) VALUES (
  'robot_123', 'sendMessage', 'https://xxx/wework/sendRawMessage',
  'POST', '{robotId: robot_123}', '${JSON.stringify(commandData)}',
  200, '{code: 0, message: "æŒ‡ä»¤å·²åŠ å…¥ä»£å‘é˜Ÿåˆ—ä¸­ï¼"}', 500, true
);

-- å†™å…¥ session_messages (æœºå™¨äººå›å¤)
INSERT INTO session_messages (
  messageId, sessionId, robotId, userName, groupName,
  content, isFromUser, isFromBot, isHuman, timestamp, extraData
) VALUES (
  'msg_xxx_reply', 'session_xxx', 'robot_123', 'å®¢æœæœºå™¨äºº', 'å®¢æœç¾¤',
  '@å¼ ä¸‰ æ‚¨çš„è®¢å•å·²å‘è´§', false, true, false, NOW(),
  '{commandId: cmd_xxx, sendType: group, targetName: å®¢æœç¾¤}'
);
```

---

#### 3.2.10 èŠ‚ç‚¹7ï¼šæŒ‡ä»¤çŠ¶æ€è®°å½•

**åŠŸèƒ½**ï¼šè®°å½•æŒ‡ä»¤å‘é€çŠ¶æ€ï¼ˆä¸ç­‰å¾…å›è°ƒï¼‰

**å¤„ç†é€»è¾‘**ï¼š
1. ä¿å­˜æŒ‡ä»¤å‘é€æ—¥å¿—ï¼ˆå·²åœ¨èŠ‚ç‚¹6å®Œæˆï¼‰
2. æµç¨‹ç»§ç»­ï¼ˆä¸é˜»å¡ï¼‰
3. å›è°ƒä¼šå¼‚æ­¥æ›´æ–°çŠ¶æ€

---

#### 3.2.11 èŠ‚ç‚¹8ï¼šç»“æŸ

**åŠŸèƒ½**ï¼šæµç¨‹ç»“æŸï¼Œæ¸…ç†èµ„æº

**å¤„ç†é€»è¾‘**ï¼š
1. è®°å½•æµç¨‹æ‰§è¡Œæ—¥å¿—
2. æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
3. è¿”å›æˆåŠŸå“åº”ç»™ WorkTool

**å“åº”æ ¼å¼**ï¼š
```javascript
{
  code: 0,
  message: "success",
  data: {
    messageId: "msg_xxx",
    sessionId: "session_xxx",
    processed: true
  }
}
```

---

### 3.3 ç‹¬ç«‹å›è°ƒç›‘å¬æœåŠ¡

**åŠŸèƒ½**ï¼šå¼‚æ­¥æ¥æ”¶æœºå™¨äººæ‰§è¡Œç»“æœå›è°ƒ

**å›è°ƒåœ°å€**ï¼š
```
POST {callbackBaseUrl}/api/worktool/callback/result?robotId={robotId}
```

**å›è°ƒæ•°æ®æ ¼å¼**ï¼š
```javascript
{
  robotId: "robot_xxx",
  messageId: "cmd_xxx",  // æŒ‡ä»¤IDï¼ˆç”¨äºå…³è”åŸå§‹æ¶ˆæ¯ï¼‰
  callbackType: 1,  // 1=æ‰§è¡Œç»“æœ
  errorCode: 0,  // 0=æˆåŠŸ
  errorReason: "success",
  runTime: 1234567890,
  timeCost: 1000,
  commandType: 203,
  rawMsg: "...",
  extraData: {
    successList: [...],
    failList: [...]
  }
}
```

**å¤„ç†é€»è¾‘**ï¼š
1. æ¥æ”¶å›è°ƒæ•°æ®
2. å†™å…¥æ•°æ®åº“ `callback_history` è¡¨
3. æ ¹æ® `messageId` æŸ¥æ‰¾ `robotCommands` è¡¨
4. æ›´æ–° `robotCommands` è¡¨çŠ¶æ€
5. æ›´æ–° `session_messages` è¡¨ï¼ˆæŠ•é€’çŠ¶æ€ï¼‰
6. WebSocket æ¨é€åˆ°é¢æ¿1ï¼ˆæ›´æ–°æ‰§è¡ŒçŠ¶æ€ï¼‰
7. WebSocket æ¨é€åˆ°é¢æ¿2ï¼ˆé˜¶æ®µ6å®Œæˆï¼‰
8. è¿”å›æˆåŠŸå“åº”ç»™ WorkTool

**æ•°æ®åº“å†™å…¥**ï¼š
```sql
-- å†™å…¥ callback_history
INSERT INTO callback_history (
  robotId, messageId, callbackType, errorCode, errorReason,
  runTime, timeCost, commandType, rawMsg, extraData, createdAt
) VALUES (
  'robot_123', 'cmd_xxx', 1, 0, 'success',
  1234567890, 1000, 203, '${rawMsg}', '${JSON.stringify(extraData)}', NOW()
);

-- æ›´æ–° robotCommands
UPDATE robotCommands 
SET status = 'completed', completedAt = NOW()
WHERE id = 'cmd_xxx';

-- æ›´æ–° session_messages (æŠ•é€’çŠ¶æ€)
UPDATE session_messages 
SET extraData = jsonb_set(extraData, '{deliveryStatus}', '"delivered"'::jsonb)
WHERE extraData->>'commandId' = 'cmd_xxx';
```

**WebSocket æ¨é€**ï¼š
```javascript
// æ¨é€åˆ°é¢æ¿1
await websocketService.broadcast('monitor:business', {
  type: 'delivery_status_update',
  messageId: callbackData.messageId,
  deliveryStatus: {
    status: callbackData.errorCode === 0 ? 'success' : 'failed',
    completedAt: Date.now(),
    errorReason: callbackData.errorCode !== 0 ? callbackData.errorReason : null
  }
});

// æ¨é€åˆ°é¢æ¿2
await websocketService.broadcast('monitor:ai', {
  type: 'stage_complete',
  messageId: callbackData.messageId,
  stage: 'stage6_callback',
  data: {
    timestamp: Date.now(),
    callbackType: 1,
    errorCode: callbackData.errorCode,
    errorReason: callbackData.errorReason,
    timeCost: callbackData.timeCost,
    status: callbackData.errorCode === 0 ? 'success' : 'failed'
  }
});
```

---

## 4. æ•°æ®åº“è®¾è®¡

### 4.1 æ ¸å¿ƒæ•°æ®è¡¨

#### 4.1.1 session_messages - ä¼šè¯æ¶ˆæ¯è®°å½•è¡¨

**ç”¨é€”**ï¼šè®°å½•æ‰€æœ‰æ¶ˆæ¯ï¼ˆç”¨æˆ·æ¶ˆæ¯ã€æœºå™¨äººæ¶ˆæ¯ã€ç³»ç»Ÿæ¶ˆæ¯ï¼‰

| å­—æ®µå | ç±»å‹ | è¯´æ˜ | ç´¢å¼• |
|--------|------|------|------|
| id | varchar(36) | ä¸»é”® | PK |
| messageId | varchar(255) | æ¶ˆæ¯IDï¼ˆç”¨äºè¿½è¸ªï¼‰ | INDEX |
| sessionId | varchar(255) | ä¼šè¯ID | INDEX |
| userId | varchar(255) | ç”¨æˆ·ID | INDEX |
| groupId | varchar(255) | ç¾¤ç»„ID | INDEX |
| userName | varchar(255) | ç”¨æˆ·å | - |
| groupName | varchar(255) | ç¾¤ç»„å | - |
| robotId | varchar(64) | æœºå™¨äººID | INDEX |
| robotName | varchar(255) | æœºå™¨äººåç§° | - |
| content | text | æ¶ˆæ¯å†…å®¹ | - |
| isFromUser | boolean | æ˜¯å¦æ¥è‡ªç”¨æˆ· | - |
| isFromBot | boolean | æ˜¯å¦æ¥è‡ªæœºå™¨äºº | - |
| isHuman | boolean | æ˜¯å¦äººå·¥å›å¤ | - |
| intent | varchar(50) | æ„å›¾è¯†åˆ«ç»“æœ | INDEX |
| confidence | integer | æ„å›¾è¯†åˆ«ç½®ä¿¡åº¦ï¼ˆ0-100ï¼‰ | - |
| timestamp | timestamp | æ¶ˆæ¯æ—¶é—´æˆ³ | INDEX |
| extraData | jsonb | é¢å¤–æ•°æ®ï¼ˆJSONæ ¼å¼ï¼‰ | - |
| createdAt | timestamp | åˆ›å»ºæ—¶é—´ | - |

**extraData å­—æ®µç»“æ„**ï¼š
```javascript
{
  rawSpoken: "åŸå§‹é—®é¢˜",
  roomType: 1,
  atMe: false,
  textType: 1,
  commandId: "cmd_xxx",  // å…³è”æŒ‡ä»¤ID
  sendType: "group",      // å‘é€ç±»å‹
  targetName: "å®¢æœç¾¤",   // ç›®æ ‡åç§°
  deliveryStatus: "delivered"  // æŠ•é€’çŠ¶æ€: pending/delivered/failed
}
```

---

#### 4.1.2 ai_io_logs - AI IO æ—¥å¿—è¡¨

**ç”¨é€”**ï¼šè®°å½•æ‰€æœ‰ AI äº¤äº’ï¼ˆè¾“å…¥å’Œè¾“å‡ºï¼‰

| å­—æ®µå | ç±»å‹ | è¯´æ˜ | ç´¢å¼• |
|--------|------|------|------|
| id | varchar(36) | ä¸»é”® | PK |
| sessionId | varchar(255) | ä¼šè¯ID | INDEX |
| messageId | varchar(255) | å…³è”çš„æ¶ˆæ¯ID | INDEX |
| robotId | varchar(64) | æœºå™¨äººID | - |
| robotName | varchar(255) | æœºå™¨äººåç§° | - |
| operationType | varchar(50) | æ“ä½œç±»å‹ | - |
| aiInput | text | å‘é€ç»™ AI çš„è¾“å…¥ | - |
| aiOutput | text | AI è¿”å›çš„è¾“å‡º | - |
| modelId | varchar(255) | ä½¿ç”¨çš„ AI æ¨¡å‹ ID | - |
| temperature | varchar(10) | æ¸©åº¦å‚æ•° | - |
| requestDuration | integer | è¯·æ±‚è€—æ—¶ï¼ˆæ¯«ç§’ï¼‰ | - |
| status | varchar(20) | çŠ¶æ€ | - |
| errorMessage | text | é”™è¯¯ä¿¡æ¯ | - |
| createdAt | timestamp | åˆ›å»ºæ—¶é—´ | - |

**operationType æšä¸¾å€¼**ï¼š
- `intent_recognition`ï¼šæ„å›¾è¯†åˆ«
- `service_reply`ï¼šå®¢æœå›å¤
- `chat_reply`ï¼šèŠå¤©å›å¤
- `help_reply`ï¼šå¸®åŠ©å›å¤
- `report`ï¼šæŠ¥å‘Šç”Ÿæˆ

---

#### 4.1.3 robotCommands - æœºå™¨äººæŒ‡ä»¤è¡¨

**ç”¨é€”**ï¼šè®°å½•æ‰€æœ‰å‘é€ç»™æœºå™¨äººçš„æŒ‡ä»¤

| å­—æ®µå | ç±»å‹ | è¯´æ˜ | ç´¢å¼• |
|--------|------|------|------|
| id | varchar(36) | ä¸»é”® | PK |
| robotId | varchar(64) | æœºå™¨äººID | INDEX |
| commandType | varchar(50) | æŒ‡ä»¤ç±»å‹ | - |
| commandData | jsonb | æŒ‡ä»¤æ•°æ® | - |
| status | varchar(20) | çŠ¶æ€ | INDEX |
| priority | integer | ä¼˜å…ˆçº§ï¼ˆ1-10ï¼Œ1æœ€é«˜ï¼‰ | - |
| retryCount | integer | é‡è¯•æ¬¡æ•° | - |
| maxRetries | integer | æœ€å¤§é‡è¯•æ¬¡æ•° | - |
| executedAt | timestamp | æ‰§è¡Œæ—¶é—´ | - |
| completedAt | timestamp | å®Œæˆæ—¶é—´ | - |
| createdAt | timestamp | åˆ›å»ºæ—¶é—´ | INDEX |
| updatedAt | timestamp | æ›´æ–°æ—¶é—´ | - |

**status æšä¸¾å€¼**ï¼š
- `pending`ï¼šç­‰å¾…ä¸­
- `processing`ï¼šå¤„ç†ä¸­
- `completed`ï¼šå·²å®Œæˆ
- `failed`ï¼šå¤±è´¥
- `timeout`ï¼šè¶…æ—¶

**commandType æšä¸¾å€¼**ï¼š
- `send_message`ï¼šå‘é€æ¶ˆæ¯
- `alert_notification`ï¼šå‘Šè­¦é€šçŸ¥
- `update_robot`ï¼šæ›´æ–°æœºå™¨äººä¿¡æ¯

---

#### 4.1.4 callbackHistory - å›è°ƒå†å²è®°å½•è¡¨

**ç”¨é€”**ï¼šè®°å½•æ‰€æœ‰ WorkTool å›è°ƒ

| å­—æ®µå | ç±»å‹ | è¯´æ˜ | ç´¢å¼• |
|--------|------|------|------|
| id | varchar(36) | ä¸»é”® | PK |
| robotId | varchar(64) | æœºå™¨äººID | INDEX |
| messageId | varchar(128) | æ¶ˆæ¯ID | INDEX |
| callbackType | integer | å›è°ƒç±»å‹ | INDEX |
| errorCode | integer | é”™è¯¯ç  | INDEX |
| errorReason | text | é”™è¯¯åŸå›  | - |
| runTime | integer | æ‰§è¡Œæ—¶é—´æˆ³ï¼ˆæ¯«ç§’ï¼‰ | - |
| timeCost | integer | æŒ‡ä»¤æ‰§è¡Œè€—æ—¶ï¼ˆæ¯«ç§’ï¼‰ | - |
| commandType | integer | æŒ‡ä»¤ç±»å‹ | - |
| rawMsg | text | åŸå§‹æŒ‡ä»¤ | - |
| extraData | jsonb | é¢å¤–æ•°æ® | - |
| createdAt | timestamp | åˆ›å»ºæ—¶é—´ | INDEX |

**callbackType æšä¸¾å€¼**ï¼š
- 0ï¼šç¾¤äºŒç»´ç 
- 1ï¼šæŒ‡ä»¤ç»“æœ
- 5ï¼šä¸Šçº¿
- 6ï¼šä¸‹çº¿
- 11ï¼šæ¶ˆæ¯

---

#### 4.1.5 alertHistory - å‘Šè­¦å†å²è¡¨

**ç”¨é€”**ï¼šè®°å½•æ‰€æœ‰å‘Šè­¦ä¿¡æ¯

| å­—æ®µå | ç±»å‹ | è¯´æ˜ | ç´¢å¼• |
|--------|------|------|------|
| id | varchar(36) | ä¸»é”® | PK |
| sessionId | varchar(255) | ä¼šè¯ID | INDEX |
| alertRuleId | varchar(36) | å…³è”çš„å‘Šè­¦è§„åˆ™ID | INDEX |
| intentType | varchar(50) | è§¦å‘å‘Šè­¦çš„æ„å›¾ç±»å‹ | INDEX |
| alertLevel | varchar(20) | å‘Šè­¦çº§åˆ« | INDEX |
| groupId | varchar(255) | ç¾¤ç»„ID | - |
| groupName | varchar(255) | ç¾¤ç»„å | - |
| userId | varchar(255) | è§¦å‘å‘Šè­¦çš„ç”¨æˆ·ID | - |
| userName | varchar(255) | è§¦å‘å‘Šè­¦çš„ç”¨æˆ·å | - |
| messageContent | text | è§¦å‘å‘Šè­¦çš„æ¶ˆæ¯å†…å®¹ | - |
| alertMessage | text | å‘Šè­¦æ¶ˆæ¯ | - |
| notificationStatus | varchar(20) | é€šçŸ¥çŠ¶æ€ | INDEX |
| notificationResult | jsonb | é€šçŸ¥ç»“æœ | - |
| status | varchar(20) | çŠ¶æ€ | - |
| isHandled | boolean | æ˜¯å¦å·²å¤„ç† | - |
| handledBy | varchar(36) | å¤„ç†äººID | - |
| handledAt | timestamp | å¤„ç†æ—¶é—´ | - |
| confidence | integer | æ„å›¾è¯†åˆ«ç½®ä¿¡åº¦ | - |
| robotId | varchar(64) | å…³è”çš„æœºå™¨äººID | - |
| createdAt | timestamp | åˆ›å»ºæ—¶é—´ | INDEX |

---

#### 4.1.6 apiCallLogs - æ¥å£è°ƒç”¨æ—¥å¿—è¡¨

**ç”¨é€”**ï¼šè®°å½•æ‰€æœ‰ API è°ƒç”¨

| å­—æ®µå | ç±»å‹ | è¯´æ˜ | ç´¢å¼• |
|--------|------|------|------|
| id | varchar(36) | ä¸»é”® | PK |
| robotId | varchar(64) | æœºå™¨äººID | INDEX |
| apiType | varchar(50) | æ¥å£ç±»å‹ | INDEX |
| apiUrl | text | å®Œæ•´çš„APIåœ°å€ | - |
| httpMethod | varchar(10) | HTTPæ–¹æ³• | - |
| requestParams | jsonb | è¯·æ±‚å‚æ•° | - |
| requestBody | jsonb | è¯·æ±‚ä½“ | - |
| responseStatus | integer | å“åº”çŠ¶æ€ç  | - |
| responseData | jsonb | å“åº”æ•°æ® | - |
| responseTime | integer | å“åº”æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰ | - |
| success | boolean | æ˜¯å¦æˆåŠŸ | INDEX |
| errorMessage | text | é”™è¯¯ä¿¡æ¯ | - |
| createdAt | timestamp | åˆ›å»ºæ—¶é—´ | INDEX |

---

### 4.2 æ•°æ®å…³ç³»å›¾

```
session_messages (æ¶ˆæ¯è¡¨)
    â†“
    â”œâ”€â†’ ai_io_logs (AIäº¤äº’) [é€šè¿‡messageIdå…³è”]
    â”œâ”€â†’ robotCommands (æŒ‡ä»¤) [é€šè¿‡extraData.commandIdå…³è”]
    â””â”€â†’ alertHistory (å‘Šè­¦) [é€šè¿‡sessionIdå…³è”]

robotCommands (æŒ‡ä»¤è¡¨)
    â†“
    â”œâ”€â†’ callbackHistory (å›è°ƒ) [é€šè¿‡id=messageIdå…³è”]
    â””â”€â†’ apiCallLogs (APIæ—¥å¿—) [é€šè¿‡id=messageIdå…³è”]

ai_io_logs (AIäº¤äº’è¡¨)
    â†“
    â””â”€â†’ session_messages [é€šè¿‡messageIdå…³è”]

alertHistory (å‘Šè­¦è¡¨)
    â†“
    â””â”€â†’ session_messages [é€šè¿‡sessionIdå…³è”]
```

---

## 5. åŒç›‘æ§é¢æ¿è®¾è®¡

### 5.1 é¢æ¿1ï¼šä¸šåŠ¡æ¶ˆæ¯ç›‘æ§

#### 5.1.1 åŠŸèƒ½å®šä½

- å±•ç¤ºç”¨æˆ·çš„åŸå§‹æ¶ˆæ¯
- å±•ç¤ºæœºå™¨äººçš„å›å¤æ¶ˆæ¯
- å±•ç¤ºæ¶ˆæ¯çš„æ‰§è¡ŒçŠ¶æ€ï¼ˆpending/success/failedï¼‰
- æ”¯æŒæŒ‰æœºå™¨äººã€ç”¨æˆ·ã€ç¾¤ç»„ç­›é€‰
- æ”¯æŒå®æ—¶æ›´æ–°

#### 5.1.2 æ•°æ®æ¥æº

- è¡¨ï¼š`session_messages`
- è¡¨ï¼š`robotCommands`ï¼ˆæ‰§è¡ŒçŠ¶æ€ï¼‰
- è¡¨ï¼š`callbackHistory`ï¼ˆå›è°ƒç»“æœï¼‰

#### 5.1.3 æ•°æ®ç»“æ„

```javascript
{
  messageId: "msg_xxx",
  sessionId: "session_xxx",
  timestamp: 1234567890,
  
  // ç”¨æˆ·æ¶ˆæ¯
  userMessage: {
    messageId: "msg_xxx",
    userName: "å¼ ä¸‰",
    groupName: "å®¢æœç¾¤",
    content: "å¸®æˆ‘æŸ¥è®¢å•",
    roomType: 1,
    atMe: false,
    intent: "service",
    confidence: 95
  },
  
  // æœºå™¨äººå›å¤
  botReply: {
    messageId: "msg_xxx_reply",
    content: "@å¼ ä¸‰ æ‚¨çš„è®¢å•å·²å‘è´§",
    robotName: "å®¢æœæœºå™¨äºº",
    sendType: "group",
    targetName: "å®¢æœç¾¤"
  },
  
  // æ‰§è¡ŒçŠ¶æ€
  deliveryStatus: {
    status: "success",
    commandId: "cmd_xxx",
    sentAt: 1234567890,
    completedAt: 1234567900,
    timeCost: 1000,
    errorReason: null
  },
  
  // æœºå™¨äººä¿¡æ¯
  robot: {
    robotId: "robot_123",
    name: "å®¢æœæœºå™¨äºº",
    status: "online"
  }
}
```

#### 5.1.4 æ•°æ®åº“æŸ¥è¯¢

```sql
WITH user_messages AS (
  -- ç”¨æˆ·æ¶ˆæ¯
  SELECT 
    sm.messageId,
    sm.sessionId,
    sm.timestamp,
    sm.userName,
    sm.groupName,
    sm.content as userContent,
    sm.roomType,
    sm.atMe,
    sm.intent,
    sm.confidence,
    sm.robotId,
    sm.extraData->>'commandId' as commandId
  FROM session_messages sm
  WHERE sm.isFromUser = true
),

bot_replies AS (
  -- æœºå™¨äººå›å¤
  SELECT 
    sm.messageId as replyMessageId,
    sm.extraData->>'commandId' as commandId,
    sm.content as replyContent,
    sm.extraData->>'sendType' as sendType,
    sm.extraData->>'targetName' as targetName,
    sm.timestamp as replyTimestamp
  FROM session_messages sm
  WHERE sm.isFromBot = true
),

command_status AS (
  -- æŒ‡ä»¤æ‰§è¡ŒçŠ¶æ€
  SELECT 
    rc.id as commandId,
    rc.status,
    rc.createdAt as sentAt,
    rc.completedAt,
    cb.errorCode,
    cb.errorReason,
    cb.timeCost
  FROM robotCommands rc
  LEFT JOIN callback_history cb ON rc.id = cb.messageId AND cb.callbackType = 1
)

SELECT 
  um.messageId,
  um.sessionId,
  um.timestamp,
  um.userName,
  um.groupName,
  um.userContent,
  um.roomType,
  um.atMe,
  um.intent,
  um.confidence,
  um.robotId,
  r.name as robotName,
  r.status as robotStatus,
  br.replyMessageId,
  br.replyContent,
  br.sendType,
  br.targetName,
  br.replyTimestamp,
  cs.status as deliveryStatus,
  cs.sentAt,
  cs.completedAt,
  cs.errorCode,
  cs.errorReason,
  cs.timeCost
FROM user_messages um
LEFT JOIN robots r ON um.robotId = r.robotId
LEFT JOIN bot_replies br ON um.commandId = br.commandId
LEFT JOIN command_status cs ON um.commandId = cs.commandId
WHERE um.timestamp >= NOW() - INTERVAL '24 hours'
ORDER BY um.timestamp DESC
LIMIT 100;
```

#### 5.1.5 å‰ç«¯ç•Œé¢è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ä¸šåŠ¡æ¶ˆæ¯ç›‘æ§é¢æ¿                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  ç­›é€‰åŒºåŸŸï¼š                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ æœºå™¨äºº: [ä¸‹æ‹‰é€‰æ‹©]  ç”¨æˆ·: [è¾“å…¥]  ç¾¤ç»„: [è¾“å…¥]             â”‚     â”‚
â”‚  â”‚ æ—¶é—´: [24å°æ—¶] [7å¤©] [30å¤©]  çŠ¶æ€: [å…¨éƒ¨] [æˆåŠŸ] [å¤±è´¥]   â”‚     â”‚
â”‚  â”‚ [åˆ·æ–°] [å¯¼å‡º]                                             â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                      â”‚
â”‚  æ¶ˆæ¯åˆ—è¡¨ï¼š                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  10:30 | å¼ ä¸‰ | å®¢æœç¾¤ | robot_001                          â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚  â”‚ ç”¨æˆ·ï¼šå¸®æˆ‘æŸ¥è®¢å•                                        â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ æ„å›¾ï¼šservice (95%)                                    â”‚ â”‚ â”‚
â”‚  â”‚  â”‚                                                        â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ æœºå™¨äººï¼š@å¼ ä¸‰ æ‚¨çš„è®¢å•å·²å‘è´§                            â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ çŠ¶æ€ï¼šâœ… æˆåŠŸ (è€—æ—¶ 1000ms)                             â”‚ â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚  10:25 | æå›› | å®¢æœç¾¤ | robot_001                          â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚  â”‚ ç”¨æˆ·ï¼šæ€ä¹ˆé€€æ¬¾ï¼Ÿ                                        â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ æ„å›¾ï¼šservice (88%)                                    â”‚ â”‚ â”‚
â”‚  â”‚  â”‚                                                        â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ æœºå™¨äººï¼š@æå›› è¯·æä¾›è®¢å•å·...                           â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ çŠ¶æ€ï¼šâ³ ç­‰å¾…æ‰§è¡Œç»“æœ...                                â”‚ â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                      â”‚
â”‚  ç»Ÿè®¡ä¿¡æ¯ï¼š                                                          â”‚
â”‚  ä»Šæ—¥æ¶ˆæ¯: 156 | æˆåŠŸ: 148 | å¤±è´¥: 8 | æˆåŠŸç‡: 94.9%                â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 5.2 é¢æ¿2ï¼šAIäº¤äº’ç›‘æ§

#### 5.2.1 åŠŸèƒ½å®šä½

- å±•ç¤ºå®Œæ•´çš„ AI äº¤äº’é“¾è·¯
- å±•ç¤ºæ„å›¾è¯†åˆ«è¿‡ç¨‹
- å±•ç¤ºå®¢æœå›å¤è¿‡ç¨‹
- å±•ç¤ºæ‰€æœ‰ AI è¾“å…¥è¾“å‡º
- æ”¯æŒè°ƒè¯•å’Œæ€§èƒ½åˆ†æ

#### 5.2.2 æ•°æ®æ¥æº

- è¡¨ï¼š`session_messages`ï¼ˆæ¶ˆæ¯åŸºç¡€ä¿¡æ¯ï¼‰
- è¡¨ï¼š`ai_io_logs`ï¼ˆAI äº¤äº’è®°å½•ï¼‰
- è¡¨ï¼š`robotCommands`ï¼ˆæŒ‡ä»¤æ‰§è¡Œï¼‰
- è¡¨ï¼š`api_call_logs`ï¼ˆAPI è°ƒç”¨ï¼‰

#### 5.2.3 æ•°æ®ç»“æ„

```javascript
{
  messageId: "msg_xxx",
  sessionId: "session_xxx",
  timestamp: 1234567890,
  
  // é˜¶æ®µ1ï¼šæ¥æ”¶æ¶ˆæ¯
  stage1_receive: {
    timestamp: 1234567890,
    data: {
      robotId: "robot_123",
      userName: "å¼ ä¸‰",
      groupName: "å®¢æœç¾¤",
      content: "å¸®æˆ‘æŸ¥è®¢å•",
      roomType: 1,
      atMe: false
    },
    duration: 0
  },
  
  // é˜¶æ®µ2ï¼šæ„å›¾è¯†åˆ«
  stage2_intent: {
    timestamp: 1234567891,
    operationType: "intent_recognition",
    modelId: "doubao-pro-4k",
    temperature: "0.3",
    aiInput: "ä½ æ˜¯ä¸€ä¸ªæ„å›¾è¯†åˆ«åŠ©æ‰‹...",
    aiOutput: "{intent: service, confidence: 95...}",
    duration: 1250,
    status: "success"
  },
  
  // é˜¶æ®µ3ï¼šå†³ç­–
  stage3_decision: {
    timestamp: 1234567892,
    intent: "service",
    alertLevel: null,
    executePath: "A"
  },
  
  // é˜¶æ®µ4ï¼šAIå®¢æœå›å¤
  stage4_service: {
    timestamp: 1234567892,
    operationType: "service_reply",
    modelId: "doubao-pro-32k",
    temperature: "0.7",
    aiInput: "ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„å®¢æœåŠ©æ‰‹...",
    aiOutput: "{reply: '@å¼ ä¸‰ æ‚¨çš„è®¢å•å·²å‘è´§'...}",
    duration: 2100,
    status: "success"
  },
  
  // é˜¶æ®µ5ï¼šå‘é€æŒ‡ä»¤
  stage5_command: {
    timestamp: 1234567894,
    commandId: "cmd_xxx",
    commandType: "send_message",
    apiEndpoint: "https://xxx/wework/sendRawMessage",
    requestData: { socketType: 2, list: [...] },
    apiResponse: { code: 0, message: "æŒ‡ä»¤å·²åŠ å…¥ä»£å‘é˜Ÿåˆ—ä¸­ï¼" },
    duration: 500,
    status: "success"
  },
  
  // é˜¶æ®µ6ï¼šæ‰§è¡Œç»“æœ
  stage6_callback: {
    timestamp: 1234567895,
    callbackType: 1,
    errorCode: 0,
    errorReason: "success",
    timeCost: 1000,
    status: "success"
  },
  
  // æ€§èƒ½ç»Ÿè®¡
  performance: {
    totalTime: 5000,
    stages: {
      receive: 0,
      intent: 1250,
      decision: 0,
      service: 2100,
      command: 500,
      callback: 1150
    }
  }
}
```

#### 5.2.4 å‰ç«¯ç•Œé¢è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    AIäº¤äº’ç›‘æ§é¢æ¿                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  ç­›é€‰åŒºåŸŸï¼š                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ æ¶ˆæ¯ID: [è¾“å…¥]  æœºå™¨äºº: [ä¸‹æ‹‰]  AIæ¨¡å‹: [ä¸‹æ‹‰]            â”‚     â”‚
â”‚  â”‚ çŠ¶æ€: [å…¨éƒ¨] [æˆåŠŸ] [å¤±è´¥]  æ—¶é—´: [24å°æ—¶] [7å¤©]          â”‚     â”‚
â”‚  â”‚ [åˆ·æ–°] [æŸ¥çœ‹è¯¦æƒ…] [å¯¼å‡º]                                  â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                      â”‚
â”‚  æ‰§è¡Œé“¾è·¯åˆ—è¡¨ï¼ˆæ—¶é—´çº¿ï¼‰ï¼š                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  msg_xxx - å¼ ä¸‰ - å®¢æœç¾¤ - æ€»è€—æ—¶: 5000ms                     â”‚ â”‚
â”‚  â”‚                                                                â”‚ â”‚
â”‚  â”‚  â”Œâ”€ 10:30:00.000 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚ â”‚
â”‚  â”‚  â”‚ âœ… é˜¶æ®µ1: æ¥æ”¶æ¶ˆæ¯ (0ms)                             â”‚     â”‚ â”‚
â”‚  â”‚  â”‚    robotId: robot_123                                 â”‚     â”‚ â”‚
â”‚  â”‚  â”‚    content: å¸®æˆ‘æŸ¥è®¢å•                                 â”‚     â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚ â”‚
â”‚  â”‚      â†“                                                         â”‚ â”‚
â”‚  â”‚  â”Œâ”€ 10:30:01.000 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚ â”‚
â”‚  â”‚  â”‚ âœ… é˜¶æ®µ2: æ„å›¾è¯†åˆ« (1250ms)                           â”‚     â”‚ â”‚
â”‚  â”‚  â”‚    æ¨¡å‹: doubao-pro-4k                                â”‚     â”‚ â”‚
â”‚  â”‚  â”‚    è¾“å…¥: ä½ æ˜¯ä¸€ä¸ªæ„å›¾è¯†åˆ«åŠ©æ‰‹...                       â”‚     â”‚ â”‚
â”‚  â”‚  â”‚    è¾“å‡º: {intent: service, confidence: 95}            â”‚     â”‚ â”‚
â”‚  â”‚  â”‚    [æŸ¥çœ‹å®Œæ•´è¾“å…¥] [æŸ¥çœ‹å®Œæ•´è¾“å‡º]                       â”‚     â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚ â”‚
â”‚  â”‚      â†“                                                         â”‚ â”‚
â”‚  â”‚  â”Œâ”€ 10:30:02.000 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚ â”‚
â”‚  â”‚  â”‚ ğŸ“‹ é˜¶æ®µ3: å†³ç­– (0ms)                                  â”‚     â”‚ â”‚
â”‚  â”‚  â”‚    æ„å›¾: service                                      â”‚     â”‚ â”‚
â”‚  â”‚  â”‚    è·¯å¾„: A (æ ‡å‡†å®¢æœ)                                 â”‚     â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚ â”‚
â”‚  â”‚      â†“                                                         â”‚ â”‚
â”‚  â”‚  â”Œâ”€ 10:30:02.000 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚ â”‚
â”‚  â”‚  â”‚ âœ… é˜¶æ®µ4: AIå®¢æœå›å¤ (2100ms)                         â”‚     â”‚ â”‚
â”‚  â”‚  â”‚    æ¨¡å‹: doubao-pro-32k                               â”‚     â”‚ â”‚
â”‚  â”‚  â”‚    è¾“å…¥: ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„å®¢æœåŠ©æ‰‹...                     â”‚ â”‚ â”‚
â”‚  â”‚  â”‚    è¾“å‡º: {reply: "@å¼ ä¸‰ æ‚¨çš„è®¢å•å·²å‘è´§"}               â”‚ â”‚ â”‚
â”‚  â”‚  â”‚    [æŸ¥çœ‹å®Œæ•´è¾“å…¥] [æŸ¥çœ‹å®Œæ•´è¾“å‡º]                       â”‚     â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚ â”‚
â”‚  â”‚      â†“                                                         â”‚ â”‚
â”‚  â”‚  â”Œâ”€ 10:30:04.000 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚ â”‚
â”‚  â”‚  â”‚ âœ… é˜¶æ®µ5: å‘é€æŒ‡ä»¤ (500ms)                            â”‚     â”‚ â”‚
â”‚  â”‚  â”‚    API: https://xxx/wework/sendRawMessage            â”‚     â”‚ â”‚
â”‚  â”‚  â”‚    è¯·æ±‚: {socketType: 2, list: [...]}                â”‚     â”‚ â”‚
â”‚  â”‚  â”‚    å“åº”: {code: 0, message: "æŒ‡ä»¤å·²åŠ å…¥ä»£å‘é˜Ÿåˆ—ä¸­ï¼"} â”‚     â”‚ â”‚
â”‚  â”‚  â”‚    [æŸ¥çœ‹å®Œæ•´è¯·æ±‚] [æŸ¥çœ‹å®Œæ•´å“åº”]                       â”‚     â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚ â”‚
â”‚  â”‚      â†“                                                         â”‚ â”‚
â”‚  â”‚  â”Œâ”€ 10:30:05.000 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚ â”‚
â”‚  â”‚  â”‚ âœ… é˜¶æ®µ6: æ‰§è¡Œç»“æœå›è°ƒ (1000ms)                       â”‚     â”‚ â”‚
â”‚  â”‚  â”‚    å›è°ƒç±»å‹: 1                                        â”‚     â”‚ â”‚
â”‚  â”‚  â”‚    é”™è¯¯ç : 0                                          â”‚     â”‚ â”‚
â”‚  â”‚  â”‚    é”™è¯¯åŸå› : success                                   â”‚     â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚ â”‚
â”‚  â”‚                                                                â”‚ â”‚
â”‚  â”‚  [æŸ¥çœ‹å®Œæ•´JSON] [é‡æ–°æ‰§è¡Œ] [å¯¼å‡ºæ—¥å¿—]                         â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                      â”‚
â”‚  ç»Ÿè®¡ä¿¡æ¯ï¼š                                                          â”‚
â”‚  ä»Šæ—¥å¤„ç†: 156 | æˆåŠŸ: 148 | å¤±è´¥: 8 | å¹³å‡è€—æ—¶: 4500ms              â”‚
â”‚  AIè°ƒç”¨: 312æ¬¡ | æ„å›¾è¯†åˆ«: 156æ¬¡ | å®¢æœå›å¤: 156æ¬¡                    â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 5.3 åŒé¢æ¿å¯¹æ¯”

| ç»´åº¦ | é¢æ¿1ï¼ˆä¸šåŠ¡æ¶ˆæ¯ï¼‰ | é¢æ¿2ï¼ˆAIäº¤äº’ï¼‰ |
|------|------------------|----------------|
| **ç›®æ ‡ç”¨æˆ·** | å®¢æœã€è¿è¥ã€ç®¡ç†å±‚ | å¼€å‘ã€è¿ç»´ã€æŠ€æœ¯å›¢é˜Ÿ |
| **å±•ç¤ºå†…å®¹** | ç”¨æˆ·æ¶ˆæ¯ + æœºå™¨äººå›å¤ + æ‰§è¡ŒçŠ¶æ€ | å®Œæ•´ AI äº¤äº’é“¾è·¯ + ç³»ç»Ÿå†…éƒ¨æµç¨‹ |
| **æ•°æ®æ¥æº** | session_messages + robotCommands + callback_history | session_messages + ai_io_logs + robotCommands + api_call_logs + callback_history |
| **å®æ—¶æ€§** | WebSocket æ¨é€æ¶ˆæ¯æ›´æ–° | WebSocket æ¨é€é˜¶æ®µæ›´æ–° |
| **æ›´æ–°é¢‘ç‡** | æ¯æ¡æ¶ˆæ¯2æ¬¡ï¼ˆå‘é€æ—¶ + å›è°ƒæ—¶ï¼‰ | æ¯ä¸ªé˜¶æ®µ1æ¬¡ï¼ˆæ¥æ”¶ã€æ„å›¾ã€å†³ç­–ã€AIã€æŒ‡ä»¤ã€å›è°ƒï¼‰ |
| **æŸ¥è¯¢ç»´åº¦** | æœºå™¨äººã€ç”¨æˆ·ã€ç¾¤ç»„ã€æ—¶é—´ã€çŠ¶æ€ | æ¶ˆæ¯IDã€AIæ¨¡å‹ã€æ“ä½œç±»å‹ã€çŠ¶æ€ã€æ—¶é—´ |
| **å¯¼å‡ºåŠŸèƒ½** | å¯¼å‡ºæ¶ˆæ¯è®°å½• | å¯¼å‡ºå®Œæ•´æ‰§è¡Œæ—¥å¿— |
| **è°ƒè¯•åŠŸèƒ½** | åŸºæœ¬æŸ¥çœ‹ | å®Œæ•´çš„è¾“å…¥è¾“å‡ºæŸ¥çœ‹ã€æ€§èƒ½åˆ†æ |

---

## 6. WebSocketå®æ—¶æ¨é€è®¾è®¡

### 6.1 æ¨é€äº‹ä»¶åˆ—è¡¨

#### 6.1.1 é¢æ¿1äº‹ä»¶ï¼ˆmonitor:businessï¼‰

| äº‹ä»¶ç±»å‹ | è¯´æ˜ | æ•°æ®ç»“æ„ |
|----------|------|----------|
| `new_message` | æ–°æ¶ˆæ¯ | ç”¨æˆ·æ¶ˆæ¯ + æœºå™¨äººå›å¤ + æ‰§è¡ŒçŠ¶æ€ |
| `delivery_status_update` | æ‰§è¡ŒçŠ¶æ€æ›´æ–° | messageId + deliveryStatus |

**new_message ç¤ºä¾‹**ï¼š
```javascript
{
  type: 'new_message',
  data: {
    messageId: "msg_xxx",
    sessionId: "session_xxx",
    timestamp: Date.now(),
    userMessage: {
      messageId: "msg_xxx",
      userName: "å¼ ä¸‰",
      groupName: "å®¢æœç¾¤",
      content: "å¸®æˆ‘æŸ¥è®¢å•",
      intent: "service",
      confidence: 95
    },
    botReply: {
      messageId: "msg_xxx_reply",
      content: "@å¼ ä¸‰ æ‚¨çš„è®¢å•å·²å‘è´§",
      robotName: "å®¢æœæœºå™¨äºº",
      sendType: "group",
      targetName: "å®¢æœç¾¤"
    },
    deliveryStatus: {
      status: 'pending',
      commandId: "cmd_xxx",
      sentAt: Date.now()
    },
    robot: {
      robotId: "robot_123",
      name: "å®¢æœæœºå™¨äºº",
      status: "online"
    }
  }
}
```

**delivery_status_update ç¤ºä¾‹**ï¼š
```javascript
{
  type: 'delivery_status_update',
  messageId: "cmd_xxx",
  deliveryStatus: {
    status: 'success',
    completedAt: Date.now(),
    errorReason: null
  }
}
```

---

#### 6.1.2 é¢æ¿2äº‹ä»¶ï¼ˆmonitor:aiï¼‰

| äº‹ä»¶ç±»å‹ | è¯´æ˜ | æ•°æ®ç»“æ„ |
|----------|------|----------|
| `stage_start` | é˜¶æ®µå¼€å§‹ | messageId + stage + åŸºç¡€æ•°æ® |
| `stage_complete` | é˜¶æ®µå®Œæˆ | messageId + stage + å®Œæ•´æ•°æ® |

**stage_start ç¤ºä¾‹**ï¼š
```javascript
{
  type: 'stage_start',
  messageId: "msg_xxx",
  stage: 'stage2_intent',
  data: {
    timestamp: Date.now(),
    modelId: "doubao-pro-4k"
  }
}
```

**stage_complete ç¤ºä¾‹ï¼ˆæ„å›¾è¯†åˆ«ï¼‰**ï¼š
```javascript
{
  type: 'stage_complete',
  messageId: "msg_xxx",
  stage: 'stage2_intent',
  data: {
    timestamp: Date.now(),
    operationType: "intent_recognition",
    modelId: "doubao-pro-4k",
    temperature: "0.3",
    aiInput: "ä½ æ˜¯ä¸€ä¸ªæ„å›¾è¯†åˆ«åŠ©æ‰‹...",
    aiOutput: "{intent: service, confidence: 95...}",
    duration: 1250,
    status: "success"
  }
}
```

**stage_complete ç¤ºä¾‹ï¼ˆAIå®¢æœå›å¤ï¼‰**ï¼š
```javascript
{
  type: 'stage_complete',
  messageId: "msg_xxx",
  stage: 'stage4_service',
  data: {
    timestamp: Date.now(),
    operationType: "service_reply",
    modelId: "doubao-pro-32k",
    temperature: "0.7",
    aiInput: "ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„å®¢æœåŠ©æ‰‹...",
    aiOutput: "{reply: '@å¼ ä¸‰ æ‚¨çš„è®¢å•å·²å‘è´§'...}",
    duration: 2100,
    status: "success"
  }
}
```

---

### 6.2 æ¨é€æ—¶æœºæ€»ç»“

| é˜¶æ®µ | é¢æ¿1æ¨é€ | é¢æ¿2æ¨é€ | æ•°æ®å†™å…¥ |
|------|----------|----------|----------|
| èŠ‚ç‚¹1: æ¶ˆæ¯æ¥æ”¶ | - | `stage_start` (stage1) | session_messages |
| èŠ‚ç‚¹2: æ„å›¾è¯†åˆ« | - | `stage_complete` (stage2) | ai_io_logs, session_messages |
| èŠ‚ç‚¹3: å†³ç­– | - | `stage_complete` (stage3) | - |
| èŠ‚ç‚¹4: AIå®¢æœå›å¤ | - | `stage_complete` (stage4) | ai_io_logs |
| èŠ‚ç‚¹6: å‘é€æŒ‡ä»¤ | `new_message` | `stage_complete` (stage5) | robotCommands, api_call_logs, session_messages |
| å›è°ƒ: æ‰§è¡Œç»“æœ | `delivery_status_update` | `stage_complete` (stage6) | callback_history, robotCommands, session_messages |

---

## 7. å®Œæ•´çš„æ•°æ®è®°å½•è®¾è®¡

### 7.1 æ•°æ®è®°å½•ç‚¹æ€»ç»“

| èŠ‚ç‚¹ | è¡¨å | è®°å½•å†…å®¹ | å­—æ®µ |
|------|------|----------|------|
| **èŠ‚ç‚¹1** | `session_messages` | ç”¨æˆ·æ¶ˆæ¯ | isFromUser=true |
| **èŠ‚ç‚¹2** | `ai_io_logs` | æ„å›¾è¯†åˆ«è¾“å…¥/è¾“å‡º | aiInput, aiOutput |
| **èŠ‚ç‚¹2** | `session_messages` | æ›´æ–°æ„å›¾ç»“æœ | intent, confidence |
| **èŠ‚ç‚¹B1** | `alert_history` | å‘Šè­¦ä¿¡æ¯ | å®Œæ•´å‘Šè­¦æ•°æ® |
| **èŠ‚ç‚¹B3** | `alert_history` | é€šçŸ¥ç»“æœ | notificationStatus, notificationResult |
| **èŠ‚ç‚¹B3** | `robotCommands` | å‘Šè­¦é€šçŸ¥æŒ‡ä»¤ | æŒ‡ä»¤è®°å½• |
| **èŠ‚ç‚¹4** | `ai_io_logs` | å®¢æœå›å¤è¾“å…¥/è¾“å‡º | aiInput, aiOutput |
| **èŠ‚ç‚¹6** | `robotCommands` | å‘é€æ¶ˆæ¯æŒ‡ä»¤ | æŒ‡ä»¤è®°å½• |
| **èŠ‚ç‚¹6** | `api_call_logs` | APIè°ƒç”¨æ—¥å¿— | è¯·æ±‚/å“åº” |
| **èŠ‚ç‚¹6** | `session_messages` | æœºå™¨äººå›å¤ | isFromBot=true |
| **å›è°ƒ** | `callback_history` | å›è°ƒå†å² | å®Œæ•´å›è°ƒæ•°æ® |
| **å›è°ƒ** | `robotCommands` | æ›´æ–°æŒ‡ä»¤çŠ¶æ€ | status |
| **å›è°ƒ** | `session_messages` | æ›´æ–°æŠ•é€’çŠ¶æ€ | deliveryStatus |

---

### 7.2 æ•°æ®æŸ¥è¯¢ç¤ºä¾‹

#### æŸ¥è¯¢å®Œæ•´çš„æ¶ˆæ¯å¯¹è¯é“¾

```sql
SELECT 
  sm.messageId,
  sm.content,
  sm.isFromUser,
  sm.isFromBot,
  sm.intent,
  sm.confidence,
  sm.timestamp,
  ail.aiInput as ai_input,
  ail.aiOutput as ai_output,
  ail.operationType as ai_operation,
  ail.requestDuration as ai_duration
FROM session_messages sm
LEFT JOIN ai_io_logs ail ON sm.messageId = ail.messageId
WHERE sm.sessionId = 'session_xxx'
ORDER BY sm.timestamp;
```

#### æŸ¥è¯¢AIä½¿ç”¨ç»Ÿè®¡

```sql
SELECT 
  operationType,
  modelId,
  COUNT(*) as total_calls,
  AVG(requestDuration) as avg_duration,
  COUNT(*) FILTER (WHERE status = 'success') as success_count,
  COUNT(*) FILTER (WHERE status = 'error') as error_count
FROM ai_io_logs
WHERE createdAt >= NOW() - INTERVAL '7 days'
GROUP BY operationType, modelId;
```

#### æŸ¥è¯¢æŒ‡ä»¤æ‰§è¡Œæƒ…å†µ

```sql
SELECT 
  rc.commandId,
  rc.commandType,
  rc.status,
  rc.createdAt,
  rc.completedAt,
  cb.errorCode,
  cb.errorReason,
  ch.timeCost
FROM robotCommands rc
LEFT JOIN callback_history cb ON rc.id = cb.messageId
LEFT JOIN api_call_logs ch ON rc.id = ch.messageId
WHERE rc.robotId = 'robot_123'
ORDER BY rc.createdAt DESC;
```

---

## 8. å…³é”®æŠ€æœ¯ç‚¹

### 8.1 æ¶ˆæ¯IDè¿½è¸ªæœºåˆ¶

**è®¾è®¡åŸåˆ™**ï¼š
- æ¯æ¡æ¶ˆæ¯åœ¨èŠ‚ç‚¹1ç”Ÿæˆå”¯ä¸€çš„ `messageId`ï¼ˆUUIDï¼‰
- æ‰€æœ‰èŠ‚ç‚¹éƒ½æºå¸¦è¿™ä¸ª `messageId`
- æ‰€æœ‰æ•°æ®åº“è¡¨éƒ½è®°å½• `messageId`
- æŒ‡ä»¤é€šè¿‡ `commandId` å…³è”åˆ° `messageId`

**å…³è”å…³ç³»**ï¼š
```
messageId (ç”¨æˆ·æ¶ˆæ¯)
  â†“
  â”œâ”€â†’ ai_io_logs (AIäº¤äº’)
  â”œâ”€â†’ robotCommands (æŒ‡ä»¤è®°å½•)
  â”‚    â†“
  â”‚    â”œâ”€â†’ callbackHistory (å›è°ƒ)
  â”‚    â””â”€â†’ api_call_logs (APIæ—¥å¿—)
  â””â”€â†’ session_messages (æœºå™¨äººå›å¤)
       â””â”€â†’ extraData.commandId â†’ robotCommands.id
```

---

### 8.2 AIè¾“å…¥è¾“å‡ºçš„å®Œæ•´æ€§

**å…³é”®è¦æ±‚**ï¼š
- âœ… è®°å½•å®Œæ•´çš„ promptï¼ˆåŒ…å«ä¸Šä¸‹æ–‡ã€ä¼šè¯å†å²ï¼‰
- âœ… è®°å½•å®Œæ•´çš„ AI è¿”å›ï¼ˆåŒ…æ‹¬ JSON è§£æå¤±è´¥çš„æƒ…å†µï¼‰
- âœ… è®°å½• AI æ¨¡å‹å‚æ•°ï¼ˆmodelId, temperatureï¼‰
- âœ… è®°å½•è¯·æ±‚è€—æ—¶å’ŒçŠ¶æ€

**ç¤ºä¾‹**ï¼š
```javascript
// âœ… æ­£ç¡®ï¼šè®°å½•å®Œæ•´çš„ promptï¼ˆåŒ…å«ä¸Šä¸‹æ–‡ï¼‰
aiInput: `
ç”¨æˆ·æ¶ˆæ¯ï¼šå¸®æˆ‘æŸ¥è®¢å•
å‘é€è€…ï¼šå¼ ä¸‰
ç¾¤ç»„ï¼šå®¢æœç¾¤

ã€ä¼šè¯å†å²ã€‘
ç”¨æˆ·: ä½ å¥½
å®¢æœ: æ‚¨å¥½ï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®æ‚¨ï¼Ÿ
ç”¨æˆ·: å¸®æˆ‘æŸ¥è®¢å•

ã€å½“å‰æ¶ˆæ¯ã€‘
å¼ ä¸‰: å¸®æˆ‘æŸ¥è®¢å•
`

// âœ… æ­£ç¡®ï¼šè®°å½•å®Œæ•´çš„ AI è¿”å›
aiOutput: JSON.stringify({
  intent: "service",
  confidence: 95,
  reason: "ç”¨æˆ·è¯¢é—®è®¢å•ï¼Œå±äºæœåŠ¡å’¨è¯¢"
})
```

---

### 8.3 æ¶ˆæ¯æ¥æºæ ‡è®°

```javascript
// âœ… ç”¨æˆ·æ¶ˆæ¯
isFromUser: true, isFromBot: false

// âœ… æœºå™¨äººæ¶ˆæ¯
isFromUser: false, isFromBot: true

// âœ… äººå·¥æ¶ˆæ¯
isFromUser: false, isFromBot: false, isHuman: true
```

---

### 8.4 æŒ‡ä»¤å…³è”

```javascript
// âœ… æœºå™¨äººæ¶ˆæ¯å…³è”åˆ°æŒ‡ä»¤
extraData: {
  commandId: "cmd_xxx",
  sendType: "group",
  targetName: "å®¢æœç¾¤",
  deliveryStatus: "delivered"  // pending/delivered/failed
}
```

---

### 8.5 æœºå™¨äººAPIè°ƒç”¨æœºåˆ¶

**å‘é€æ¶ˆæ¯æ¥å£**ï¼š
```
POST {apiBaseUrl}/wework/sendRawMessage?robotId={robotId}
```

**è¯·æ±‚æ ¼å¼**ï¼š
```javascript
{
  socketType: 2,
  list: [
    {
      type: 203,
      titleList: [toName],  // ç¾¤åæˆ–ç”¨æˆ·æ˜µç§°
      receivedContent: content,  // æ¶ˆæ¯å†…å®¹
      atList: [...]  // @çš„äººï¼ˆå¯é€‰ï¼‰
    }
  ]
}
```

**å“åº”æ ¼å¼**ï¼š
```javascript
{
  code: 0,  // 0=æˆåŠŸ, -1=å¤±è´¥
  message: "æŒ‡ä»¤å·²åŠ å…¥ä»£å‘é˜Ÿåˆ—ä¸­ï¼",
  data: {...}
}
```

**å›è°ƒæœºåˆ¶**ï¼š
- æœºå™¨äººä¼šè‡ªåŠ¨å›è°ƒåˆ° `resultCallbackUrl`
- å›è°ƒæ•°æ®ä¸­åŒ…å« `messageId`ï¼ˆå³ commandIdï¼‰
- å›è°ƒæ•°æ®åŒ…å« `errorCode`ï¼ˆ0=æˆåŠŸï¼‰å’Œ `errorReason`

---

### 8.6 å¹¶å‘å¤„ç†ç­–ç•¥

#### æ¶ˆæ¯é˜Ÿåˆ—
```
Webhookæ¥æ”¶æ¶ˆæ¯ â†’ æ”¾å…¥æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆRedis/RabbitMQï¼‰
                              â†“
                         æµç¨‹å¼•æ“ä»é˜Ÿåˆ—å–æ¶ˆæ¯
                              â†“
                         å¼‚æ­¥æ‰§è¡Œæµç¨‹
                              â†“
                         ä¸é˜»å¡Webhookå“åº”
```

#### AIèµ„æºæ± 
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            AIèµ„æºæ±                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  AIå®ä¾‹1: å¤„ç† robot_001, robot_002    â”‚
â”‚  AIå®ä¾‹2: å¤„ç† robot_003, robot_004    â”‚
â”‚  AIå®ä¾‹3: å¤„ç† robot_005, robot_006    â”‚
â”‚  ...                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  åˆ†é…ç­–ç•¥ï¼š                              â”‚
â”‚  - è½®è¯¢åˆ†é…                             â”‚
â”‚  - æœ€å°‘è¿æ¥æ•°ä¼˜å…ˆ                       â”‚
â”‚  - æŒ‰æœºå™¨äººå›ºå®šåˆ†é…ï¼ˆå¯é…ç½®ï¼‰           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 9. APIæ¥å£è®¾è®¡

### 9.1 Webhookæ¥å£

#### 9.1.1 æ¶ˆæ¯å›è°ƒ

**æ¥å£åœ°å€**ï¼š`POST /api/worktool/callback/message`

**è¯·æ±‚å‚æ•°**ï¼š
- Query: `robotId` (æœºå™¨äººID)

**è¯·æ±‚ä½“**ï¼š
```javascript
{
  spoken: "å¸®æˆ‘æŸ¥è®¢å•",
  rawSpoken: "å¸®æˆ‘æŸ¥è®¢å•",
  receivedName: "å¼ ä¸‰",
  groupName: "å®¢æœç¾¤",
  roomType: 1,
  atMe: false,
  textType: 1
}
```

**å“åº”**ï¼š
```javascript
{
  code: 0,
  message: "success",
  data: {
    messageId: "msg_xxx",
    sessionId: "session_xxx"
  }
}
```

---

#### 9.1.2 æ‰§è¡Œç»“æœå›è°ƒ

**æ¥å£åœ°å€**ï¼š`POST /api/worktool/callback/result`

**è¯·æ±‚å‚æ•°**ï¼š
- Query: `robotId` (æœºå™¨äººID)

**è¯·æ±‚ä½“**ï¼š
```javascript
{
  robotId: "robot_xxx",
  messageId: "cmd_xxx",
  callbackType: 1,
  errorCode: 0,
  errorReason: "success",
  runTime: 1234567890,
  timeCost: 1000,
  commandType: 203,
  rawMsg: "...",
  extraData: {...}
}
```

**å“åº”**ï¼š
```javascript
{
  code: 0,
  message: "success"
}
```

---

### 9.2 æŸ¥è¯¢æ¥å£

#### 9.2.1 æŸ¥è¯¢ä¸šåŠ¡æ¶ˆæ¯åˆ—è¡¨

**æ¥å£åœ°å€**ï¼š`GET /api/monitor/business/messages`

**è¯·æ±‚å‚æ•°**ï¼š
```javascript
{
  robotId: "robot_123",  // å¯é€‰
  userName: "å¼ ä¸‰",       // å¯é€‰
  groupName: "å®¢æœç¾¤",    // å¯é€‰
  timeRange: "24h",       // å¯é€‰: 24h, 7d, 30d
  status: "success",      // å¯é€‰: all, success, failed, pending
  limit: 100,
  offset: 0
}
```

**å“åº”**ï¼š
```javascript
{
  code: 0,
  message: "success",
  data: {
    total: 156,
    list: [
      {
        messageId: "msg_xxx",
        sessionId: "session_xxx",
        timestamp: 1234567890,
        userMessage: {...},
        botReply: {...},
        deliveryStatus: {...},
        robot: {...}
      }
    ]
  }
}
```

---

#### 9.2.2 æŸ¥è¯¢AIäº¤äº’è¯¦æƒ…

**æ¥å£åœ°å€**ï¼š`GET /api/monitor/ai/details/:messageId`

**å“åº”**ï¼š
```javascript
{
  code: 0,
  message: "success",
  data: {
    messageId: "msg_xxx",
    sessionId: "session_xxx",
    stage1_receive: {...},
    stage2_intent: {...},
    stage3_decision: {...},
    stage4_service: {...},
    stage5_command: {...},
    stage6_callback: {...},
    performance: {...}
  }
}
```

---

## 10. éƒ¨ç½²å»ºè®®

### 10.1 ç¯å¢ƒè¦æ±‚

| ç»„ä»¶ | ç‰ˆæœ¬è¦æ±‚ |
|------|----------|
| Node.js | >= 24.0.0 |
| PostgreSQL | >= 14.0 |
| Redis | >= 6.0 |

### 10.2 é…ç½®æ–‡ä»¶

**ç¯å¢ƒå˜é‡**ï¼š
```bash
# æ•°æ®åº“é…ç½®
DATABASE_URL=postgresql://user:pass@localhost:5432/dbname

# Redisé…ç½®
REDIS_URL=redis://localhost:6379

# WorkToolå›è°ƒåœ°å€
CALLBACK_BASE_URL=https://your-domain.com

# AIæœåŠ¡é…ç½®
AI_API_KEY=your_api_key
AI_MODEL_INTENT=doubao-pro-4k
AI_MODEL_SERVICE=doubao-pro-32k

# WebSocketé…ç½®
WS_PORT=5000
API_PORT=5001
```

### 10.3 å¯åŠ¨å‘½ä»¤

```bash
# å‰ç«¯æœåŠ¡ï¼ˆ5000ç«¯å£ï¼‰
pnpm dev

# åç«¯æœåŠ¡ï¼ˆ5001ç«¯å£ï¼‰
pnpm --filter server run dev
```

### 10.4 ç›‘æ§å‘Šè­¦

å»ºè®®ç›‘æ§ä»¥ä¸‹æŒ‡æ ‡ï¼š
- æ¶ˆæ¯å¤„ç†å»¶è¿Ÿï¼ˆP50, P95, P99ï¼‰
- AIè°ƒç”¨æˆåŠŸç‡
- APIè°ƒç”¨æˆåŠŸç‡
- WebSocketè¿æ¥æ•°
- æ•°æ®åº“è¿æ¥æ± ä½¿ç”¨ç‡
- Rediså†…å­˜ä½¿ç”¨ç‡

---

## ğŸ“š é™„å½•

### A. æœ¯è¯­è¡¨

| æœ¯è¯­ | è¯´æ˜ |
|------|------|
| `messageId` | æ¶ˆæ¯å”¯ä¸€IDï¼Œç”¨äºè¿½è¸ªæ•´ä¸ªæµç¨‹ |
| `sessionId` | ä¼šè¯IDï¼ŒåŒä¸€ç”¨æˆ·çš„å¤šæ¡æ¶ˆæ¯å…±äº«åŒä¸€ä¸ªsessionId |
| `commandId` | æŒ‡ä»¤IDï¼Œå‘é€ç»™æœºå™¨äººçš„æŒ‡ä»¤çš„å”¯ä¸€æ ‡è¯† |
| `robotId` | WorkToolæœºå™¨äººçš„å”¯ä¸€æ ‡è¯† |
| `intent` | æ„å›¾è¯†åˆ«ç»“æœï¼šservice/help/chat/risk/spam/admin |
| `deliveryStatus` | æ¶ˆæ¯æŠ•é€’çŠ¶æ€ï¼špending/delivered/failed |

### B. çŠ¶æ€ç è¡¨

| çŠ¶æ€ç  | è¯´æ˜ |
|--------|------|
| 0 | æˆåŠŸ |
| -1 | å¤±è´¥ |
| 400 | è¯·æ±‚å‚æ•°é”™è¯¯ |
| 403 | æƒé™ä¸è¶³ |
| 404 | èµ„æºä¸å­˜åœ¨ |
| 500 | æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ |
| 503 | æœåŠ¡ä¸å¯ç”¨ï¼ˆç†”æ–­ä¸­ï¼‰ |

### C. å‚è€ƒæ–‡æ¡£

- WorkTool API æ–‡æ¡£
- è±†åŒ…å¤§æ¨¡å‹ API æ–‡æ¡£
- PostgreSQL å®˜æ–¹æ–‡æ¡£
- Drizzle ORM æ–‡æ¡£
- Fastify å®˜æ–¹æ–‡æ¡£

---

**æ–‡æ¡£ç»“æŸ**
