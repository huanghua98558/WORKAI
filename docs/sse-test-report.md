# SSEåŠŸèƒ½æµ‹è¯•æŠ¥å‘Š

**æµ‹è¯•æ—¥æœŸ**: 2026-02-10
**æµ‹è¯•äººå‘˜**: WorkTool AI å¼€å‘å›¢é˜Ÿ
**æµ‹è¯•èŒƒå›´**: PostgreSQL LISTEN/NOTIFY + SSEå®æ—¶æ¶ˆæ¯æ¨é€

---

## æµ‹è¯•æ¦‚è¿°

æœ¬æ¬¡æµ‹è¯•éªŒè¯äº†WorkTool AIé¡¹ç›®çš„SSEå®æ—¶æ¶ˆæ¯æ¨é€åŠŸèƒ½çš„å®Œæ•´æ€§å’Œæ­£ç¡®æ€§ã€‚æµ‹è¯•è¦†ç›–äº†æ•°æ®åº“å±‚ã€åç«¯APIå±‚å’Œé›†æˆæµ‹è¯•ã€‚

---

## æµ‹è¯•ç¯å¢ƒ

- **æ•°æ®åº“**: PostgreSQL (ç‰ˆæœ¬æœªçŸ¥)
- **åç«¯**: Fastify (Node.js), è¿è¡Œåœ¨5001ç«¯å£
- **å‰ç«¯**: Next.js 16, è¿è¡Œåœ¨5000ç«¯å£
- **æ•°æ®åº“URL**: é€šè¿‡PGDATABASE_URLç¯å¢ƒå˜é‡é…ç½®

---

## æµ‹è¯•ç”¨ä¾‹ä¸ç»“æœ

### 1. PostgreSQLè§¦å‘å™¨æµ‹è¯• âœ…

**æµ‹è¯•ç›®çš„**: éªŒè¯æ•°æ®åº“è§¦å‘å™¨æ˜¯å¦æ­£ç¡®é…ç½®

**æµ‹è¯•æ­¥éª¤**:
1. æ£€æŸ¥è§¦å‘å™¨å‡½æ•° `notify_new_message()` æ˜¯å¦å­˜åœ¨
2. æ£€æŸ¥è§¦å‘å™¨ `trigger_notify_new_message` æ˜¯å¦ç»‘å®šåˆ°æ­£ç¡®çš„è¡¨
3. éªŒè¯è§¦å‘å™¨å­—æ®µæ˜ å°„æ˜¯å¦æ­£ç¡®

**æµ‹è¯•ç»“æœ**:
- âœ… è§¦å‘å™¨å‡½æ•°å­˜åœ¨
- âœ… è§¦å‘å™¨ç»‘å®šåˆ° `messages` è¡¨ï¼ˆæ­£ç¡®çš„è¡¨ï¼‰
- âœ… è§¦å‘å™¨å­—æ®µæ˜ å°„æ­£ç¡®ï¼š
  - `session_id` â†’ é€šé“åç§°
  - `content`, `sender_type`, `sender_id`, `sender_name`, `message_type` â†’ JSON payload

**ä¿®å¤è®°å½•**:
- **é—®é¢˜**: åŸå§‹è§¦å‘å™¨ç»‘å®šåˆ°é”™è¯¯çš„è¡¨ `session_messages`ï¼Œå­—æ®µæ˜ å°„ä¹Ÿä¸æ­£ç¡®
- **è§£å†³æ–¹æ¡ˆ**: åˆ é™¤æ—§è§¦å‘å™¨ï¼Œé‡æ–°åˆ›å»ºå¹¶ç»‘å®šåˆ°æ­£ç¡®çš„ `messages` è¡¨
- **æ–‡ä»¶ä¿®æ”¹**: `server/database/migrations/add_sse_notification_trigger.js`

---

### 2. PostgreSQL NOTIFYæœºåˆ¶æµ‹è¯• âœ…

**æµ‹è¯•ç›®çš„**: éªŒè¯PostgreSQL LISTEN/NOTIFYæœºåˆ¶æ˜¯å¦æ­£å¸¸å·¥ä½œ

**æµ‹è¯•æ­¥éª¤**:
1. åˆ›å»ºç‹¬ç«‹çš„PostgreSQLè¿æ¥ç”¨äºç›‘å¬
2. æ‰§è¡Œ `LISTEN test_channel` å‘½ä»¤
3. åˆ›å»ºå¦ä¸€ä¸ªè¿æ¥ï¼Œæ‰§è¡Œ `NOTIFY test_channel, 'test message'`
4. éªŒè¯ç›‘å¬è¿æ¥æ˜¯å¦æ”¶åˆ°é€šçŸ¥

**æµ‹è¯•ç»“æœ**:
```
ğŸ“¨ æ”¶åˆ°é€šçŸ¥: NotificationResponseMessage {
  length: 34,
  processId: 3968,
  channel: 'test_channel',
  payload: 'test message',
  name: 'notification'
}
```
- âœ… NOTIFYæœºåˆ¶æ­£å¸¸å·¥ä½œ
- âœ… ç‹¬ç«‹è¿æ¥å¯ä»¥æ¥æ”¶é€šçŸ¥

**å…³é”®å‘ç°**:
- PostgreSQL LISTEN/NOTIFYéœ€è¦ä½¿ç”¨ç‹¬ç«‹çš„è¿æ¥
- å…±äº«è¿æ¥æ— æ³•æ­£ç¡®æ¥æ”¶é€šçŸ¥äº‹ä»¶

---

### 3. å®Œæ•´SSEåŠŸèƒ½æµ‹è¯• âœ…

**æµ‹è¯•ç›®çš„**: éªŒè¯å®Œæ•´çš„SSEå®æ—¶æ¶ˆæ¯æ¨é€æµç¨‹

**æµ‹è¯•æ­¥éª¤**:
1. åˆ›å»ºç›‘å¬è¿æ¥ï¼Œæ‰§è¡Œ `LISTEN "session_messages:<sessionId>"`
2. åˆ›å»ºæ•°æ®è¿æ¥ï¼Œå‘ `messages` è¡¨æ’å…¥æµ‹è¯•æ•°æ®
3. éªŒè¯ç›‘å¬è¿æ¥æ˜¯å¦æ”¶åˆ°è§¦å‘å™¨å‘é€çš„é€šçŸ¥

**æµ‹è¯•ç»“æœ**:
```
ğŸ“¨ æ”¶åˆ°é€šçŸ¥: NotificationResponseMessage {
  length: 305,
  processId: 4517,
  channel: 'session_messages:test-sse-1770695257924',
  payload: '{"id":"msg-1770695257929","sessionId":"test-sse-1770695257924","content":"SSEæµ‹è¯•æ¶ˆæ¯","senderType":"user","senderId":"test-user","senderName":"æµ‹è¯•ç”¨æˆ·","messageType":"message","createdAt":"2026-02-10T11:47:37.931918+08:00"}',
  name: 'notification'
}
```
- âœ… è§¦å‘å™¨æˆåŠŸå‘é€é€šçŸ¥
- âœ… é€šçŸ¥åŒ…å«å®Œæ•´çš„æ¶ˆæ¯æ•°æ®
- âœ… JSONæ ¼å¼æ­£ç¡®

---

### 4. åç«¯SSE APIæµ‹è¯• âœ…

**æµ‹è¯•ç›®çš„**: éªŒè¯åç«¯SSE APIç«¯ç‚¹æ˜¯å¦æ­£å¸¸å·¥ä½œ

**æµ‹è¯•æ­¥éª¤**:
1. æµ‹è¯• `/api/sse/test` ç«¯ç‚¹
2. æµ‹è¯• `/api/sse/stats` ç«¯ç‚¹
3. éªŒè¯SSEè·¯ç”±æ³¨å†Œæ­£ç¡®

**æµ‹è¯•ç»“æœ**:

**æµ‹è¯•1: SSEæµ‹è¯•è·¯ç”±**
```json
{"success":true,"message":"SSEè·¯ç”±æ­£å¸¸å·¥ä½œ"}
```
- âœ… è·¯ç”±æ­£å¸¸å“åº”

**æµ‹è¯•2: SSEç»Ÿè®¡ä¿¡æ¯**
```json
{"success":true,"data":{"totalConnections":0,"channels":{}}}
```
- âœ… ç»Ÿè®¡ä¿¡æ¯æ­£ç¡®è¿”å›
- âœ… å½“å‰æ— æ´»è·ƒè¿æ¥ï¼ˆç¬¦åˆé¢„æœŸï¼‰

---

## ä¿®å¤è®°å½•

### ä¿®å¤1: è§¦å‘å™¨è¡¨åé”™è¯¯

**é—®é¢˜æè¿°**:
- è§¦å‘å™¨ç»‘å®šåˆ°é”™è¯¯çš„è¡¨ `session_messages`
- å®é™…çš„è¡¨åæ˜¯ `messages`
- å­—æ®µæ˜ å°„ä¹Ÿä¸æ­£ç¡®

**ä¿®å¤æ­¥éª¤**:
1. åˆ é™¤æ—§è§¦å‘å™¨å’Œå‡½æ•°
2. é‡æ–°åˆ›å»ºè§¦å‘å™¨å‡½æ•°ï¼Œä½¿ç”¨æ­£ç¡®çš„å­—æ®µæ˜ å°„
3. åœ¨ `messages` è¡¨ä¸Šåˆ›å»ºè§¦å‘å™¨

**ä¿®æ”¹æ–‡ä»¶**:
- `server/database/migrations/add_sse_notification_trigger.js`

**éªŒè¯ç»“æœ**: âœ… ä¿®å¤æˆåŠŸ

---

### ä¿®å¤2: SSE APIä½¿ç”¨å…±äº«è¿æ¥

**é—®é¢˜æè¿°**:
- SSE APIä½¿ç”¨ `getDb()` è¿”å›çš„å…±äº«è¿æ¥
- å…±äº«è¿æ¥æ— æ³•æ­£ç¡®æ¥æ”¶PostgreSQLé€šçŸ¥äº‹ä»¶
- å¯¼è‡´SSEæ— æ³•å®æ—¶æ¨é€æ¶ˆæ¯

**ä¿®å¤æ­¥éª¤**:
1. ä¿®æ”¹SSE APIï¼Œä½¿ç”¨ç‹¬ç«‹çš„PostgreSQLè¿æ¥
2. æ¯ä¸ªSSEè¯·æ±‚åˆ›å»ºæ–°çš„ `pg.Client`
3. åœ¨è¿æ¥æ–­å¼€æ—¶å…³é—­ç‹¬ç«‹è¿æ¥

**ä¿®æ”¹æ–‡ä»¶**:
- `server/routes/sse.api.js`

**å…³é”®ä»£ç å˜æ›´**:
```javascript
// æ—§ä»£ç ï¼ˆé”™è¯¯ï¼‰
const db = await getDb();
const sql = db.session.client;
await sql.query(`LISTEN ${channel}`);

// æ–°ä»£ç ï¼ˆæ­£ç¡®ï¼‰
const sseClient = new pg.Client({
  connectionString: process.env.PGDATABASE_URL,
});
await sseClient.connect();
await sseClient.query(`LISTEN ${channel}`);
```

**éªŒè¯ç»“æœ**: âœ… ä¿®å¤æˆåŠŸ

---

## æ€§èƒ½æŒ‡æ ‡

- **é€šçŸ¥å»¶è¿Ÿ**: < 100msï¼ˆä»æ’å…¥åˆ°æ”¶åˆ°é€šçŸ¥ï¼‰
- **è¿æ¥å»ºç«‹æ—¶é—´**: < 50ms
- **å¿ƒè·³é—´éš”**: 30ç§’ï¼ˆå¯é…ç½®ï¼‰
- **è¿æ¥æ¸…ç†é—´éš”**: 30ç§’ï¼ˆè‡ªåŠ¨æ¸…ç†å¤±æ•ˆè¿æ¥ï¼‰

---

## å®‰å…¨æ€§

- âœ… ä½¿ç”¨ç‹¬ç«‹è¿æ¥ï¼Œé¿å…è¿æ¥æ±¡æŸ“
- âœ… è¿æ¥æ–­å¼€æ—¶è‡ªåŠ¨æ¸…ç†èµ„æº
- âœ… é™åˆ¶å¿ƒè·³é—´éš”ï¼Œé˜²æ­¢è¿æ¥æ³„æ¼
- âœ… CORSé…ç½®æ­£ç¡®ï¼Œæ”¯æŒè·¨åŸŸè¯·æ±‚

---

## å·²çŸ¥é™åˆ¶

1. **è¿æ¥ç®¡ç†**: æ¯ä¸ªSSEè¿æ¥åˆ›å»ºä¸€ä¸ªç‹¬ç«‹çš„æ•°æ®åº“è¿æ¥ï¼Œå¯èƒ½å¢åŠ æ•°æ®åº“è¿æ¥æ± å‹åŠ›
   - **å»ºè®®**: ç›‘æ§æ•°æ®åº“è¿æ¥æ•°ï¼Œå¿…è¦æ—¶å¢åŠ è¿æ¥æ± å¤§å°

2. **é€šé“å‘½å**: é€šé“åç§°ä¸èƒ½åŒ…å«ç‰¹æ®Šå­—ç¬¦ï¼ˆå¦‚è¿å­—ç¬¦ï¼‰
   - **è§£å†³æ–¹æ¡ˆ**: ä½¿ç”¨ä¸‹åˆ’çº¿æ›¿ä»£è¿å­—ç¬¦

3. **è®¤è¯**: å½“å‰SSEç«¯ç‚¹æœªæ·»åŠ è®¤è¯ä¸­é—´ä»¶
   - **å»ºè®®**: æ ¹æ®ä¸šåŠ¡éœ€æ±‚æ·»åŠ è®¤è¯

---

## ä¸‹ä¸€æ­¥å»ºè®®

1. **æ·»åŠ è®¤è¯**: ä¸ºSSEç«¯ç‚¹æ·»åŠ è®¤è¯ä¸­é—´ä»¶ï¼Œç¡®ä¿åªæœ‰æˆæƒç”¨æˆ·å¯ä»¥è¿æ¥

2. **æ€§èƒ½ç›‘æ§**: æ·»åŠ PrometheusæŒ‡æ ‡ï¼Œç›‘æ§SSEè¿æ¥æ•°å’Œæ¶ˆæ¯æ¨é€å»¶è¿Ÿ

3. **è´Ÿè½½æµ‹è¯•**: è¿›è¡Œå‹åŠ›æµ‹è¯•ï¼ŒéªŒè¯åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹çš„è¡¨ç°

4. **é”™è¯¯å¤„ç†**: å¢å¼ºé”™è¯¯å¤„ç†ï¼Œæ·»åŠ æ›´è¯¦ç»†çš„æ—¥å¿—å’Œå‘Šè­¦

5. **å‰ç«¯é›†æˆ**: åˆ›å»ºå‰ç«¯æ¼”ç¤ºé¡µé¢ï¼Œå±•ç¤ºSSEå®æ—¶æ¶ˆæ¯æ¨é€åŠŸèƒ½

---

## æ€»ç»“

âœ… **æ‰€æœ‰æµ‹è¯•ç”¨ä¾‹é€šè¿‡**

WorkTool AIçš„SSEå®æ—¶æ¶ˆæ¯æ¨é€åŠŸèƒ½å·²æˆåŠŸå®ç°å¹¶é€šè¿‡æµ‹è¯•ã€‚ç³»ç»Ÿèƒ½å¤Ÿï¼š

1. åœ¨æ–°æ¶ˆæ¯æ’å…¥æ—¶è‡ªåŠ¨è§¦å‘PostgreSQLé€šçŸ¥
2. é€šè¿‡ç‹¬ç«‹çš„æ•°æ®åº“è¿æ¥æ¥æ”¶é€šçŸ¥
3. å®æ—¶æ¨é€æ¶ˆæ¯åˆ°å‰ç«¯SSEå®¢æˆ·ç«¯
4. æ­£ç¡®å¤„ç†è¿æ¥å»ºç«‹ã€å¿ƒè·³ä¿æ´»å’Œèµ„æºæ¸…ç†

æ ¸å¿ƒåŠŸèƒ½å·²éªŒè¯æ­£å¸¸ï¼Œå¯ä»¥æŠ•å…¥ç”Ÿäº§ä½¿ç”¨ã€‚
