# æµç¨‹å¼•æ“ä¼˜åŒ–å®æ–½è®¡åˆ’

## ğŸ“‹ å®æ–½ä¿¡æ¯

- **å®æ–½å‘¨æœŸ**ï¼š6å‘¨
- **å®æ–½æ–¹å¼**ï¼šæ¸è¿›å¼ä¼˜åŒ–ï¼Œä¿æŒç³»ç»Ÿç¨³å®š
- **é£é™©æ§åˆ¶**ï¼šæ¯é˜¶æ®µå®Œæˆåè¿›è¡Œå……åˆ†æµ‹è¯•
- **å›æ»šæ–¹æ¡ˆ**ï¼šæ¯ä¸ªé˜¶æ®µéƒ½æœ‰é™çº§å¤„ç†æœºåˆ¶

---

## ğŸ¯ é˜¶æ®µ1ï¼šç»Ÿä¸€AIæœåŠ¡è°ƒç”¨ï¼ˆWeek 1ï¼‰

### ä»»åŠ¡1.1ï¼šç§»é™¤aiCoreServiceä¾èµ–

**æ–‡ä»¶**ï¼š`server/services/flow-engine.service.js`

**æ“ä½œ**ï¼š
```javascript
// åˆ é™¤
// const { aiCoreService } = require('./ai-core.service');

// æ·»åŠ 
const AIServiceFactory = require('./ai/AIServiceFactory');
```

**éªŒè¯**ï¼šç¡®ä¿ä»£ç ç¼–è¯‘é€šè¿‡

---

### ä»»åŠ¡1.2ï¼šä¿®æ”¹AIå¯¹è¯èŠ‚ç‚¹

**æ–‡ä»¶**ï¼š`server/services/flow-engine.service.js`

**ä¿®æ”¹æ–¹æ³•**ï¼š`handleAIChatNode`

**ä¸»è¦æ”¹åŠ¨**ï¼š
1. ä½¿ç”¨ `AIServiceFactory.createServiceByModelId()` åˆ›å»ºAIæœåŠ¡å®ä¾‹
2. è°ƒç”¨ `aiService.generateReply()` ç”Ÿæˆå›å¤
3. æ·»åŠ AI IOæ—¥å¿—è®°å½•

**æ–°å¢æ–¹æ³•**ï¼š
- `getRoleById(roleId)` - è·å–è§’è‰²ä¿¡æ¯
- `saveAILog(sessionId, messageId, logData)` - ä¿å­˜AI IOæ—¥å¿—

**æµ‹è¯•ç”¨ä¾‹**ï¼š
```javascript
// æµ‹è¯•1ï¼šAIå¯¹è¯èŠ‚ç‚¹æ­£å¸¸å·¥ä½œ
{
  node: {
    type: 'ai_chat',
    data: {
      modelId: '45d2b7c7-40ef-4f1e-bed8-c133168f8255'
    }
  },
  context: {
    message: { spoken: 'ä½ å¥½' },
    sessionId: 'test-session',
    messageId: 'test-msg'
  }
}

// é¢„æœŸç»“æœï¼š
{
  success: true,
  aiResponse: 'ä½ å¥½å‘€ï¼å¾ˆé«˜å…´å’Œä½ æ‰“æ‹›å‘¼ğŸ˜Š',
  context: { aiResponse: 'ä½ å¥½å‘€ï¼...' }
}
```

---

### ä»»åŠ¡1.3ï¼šä¿®æ”¹æ„å›¾è¯†åˆ«èŠ‚ç‚¹

**æ–‡ä»¶**ï¼š`server/services/flow-engine.service.js`

**ä¿®æ”¹æ–¹æ³•**ï¼š`handleIntentNode`

**ä¸»è¦æ”¹åŠ¨**ï¼š
1. ä½¿ç”¨ `AIServiceFactory.createServiceByModelId()` åˆ›å»ºAIæœåŠ¡å®ä¾‹
2. è°ƒç”¨ `aiService.recognizeIntent()` è¯†åˆ«æ„å›¾
3. æ·»åŠ AI IOæ—¥å¿—è®°å½•

**æµ‹è¯•ç”¨ä¾‹**ï¼š
```javascript
// æµ‹è¯•1ï¼šæ„å›¾è¯†åˆ«èŠ‚ç‚¹æ­£å¸¸å·¥ä½œ
{
  node: {
    type: 'intent',
    data: {
      modelId: '45d2b7c7-40ef-4f1e-bed8-c133168f8255'
    }
  },
  context: {
    message: { spoken: 'æˆ‘éœ€è¦å¸®åŠ©' },
    sessionId: 'test-session',
    messageId: 'test-msg'
  }
}

// é¢„æœŸç»“æœï¼š
{
  success: true,
  intent: 'help',
  confidence: 90,
  needReply: true,
  needHuman: false,
  context: { intent: 'help', needReply: true }
}
```

---

### ä»»åŠ¡1.4ï¼šæµ‹è¯•AIèŠ‚ç‚¹åŠŸèƒ½

**æµ‹è¯•åœºæ™¯**ï¼š
1. âœ… AIå¯¹è¯èŠ‚ç‚¹èƒ½æ­£å¸¸è°ƒç”¨è±†åŒ…æ¨¡å‹
2. âœ… æ„å›¾è¯†åˆ«èŠ‚ç‚¹èƒ½æ­£å¸¸è°ƒç”¨è±†åŒ…æ¨¡å‹
3. âœ… AI IOæ—¥å¿—æ­£ç¡®è®°å½•åˆ°æ•°æ®åº“
4. âœ… é”™è¯¯æƒ…å†µæœ‰é™çº§å¤„ç†

**éªŒè¯æ–¹æ³•**ï¼š
```bash
# åˆ›å»ºæµ‹è¯•æµç¨‹
curl -X POST http://localhost:5000/api/flow-engine/definitions \
  -H "Content-Type: application/json" \
  -d '{
    "name": "AIèŠ‚ç‚¹æµ‹è¯•æµç¨‹",
    "nodes": [
      { "id": "start", "type": "start", "data": {} },
      { "id": "intent", "type": "intent", "data": { "modelId": "45d2b7c7-40ef-4f1e-bed8-c133168f8255" } },
      { "id": "ai-chat", "type": "ai_chat", "data": { "modelId": "45d2b7c7-40ef-4f1e-bed8-c133168f8255" } },
      { "id": "end", "type": "end", "data": {} }
    ],
    "edges": [
      { "id": "e1", "source": "start", "target": "intent" },
      { "id": "e2", "source": "intent", "target": "ai-chat" },
      { "id": "e3", "source": "ai-chat", "target": "end" }
    ]
  }'

# åˆ›å»ºå¹¶æ‰§è¡Œæµç¨‹å®ä¾‹
curl -X POST http://localhost:5000/api/flow-engine/instances \
  -H "Content-Type: application/json" \
  -d '{
    "flowDefinitionId": "{æµç¨‹ID}",
    "context": {
      "message": { "spoken": "ä½ å¥½" },
      "sessionId": "test-session",
      "messageId": "test-msg"
    }
  }'

# æŸ¥çœ‹æ‰§è¡Œæ—¥å¿—
curl http://localhost:5000/api/flow-engine/instances/{instanceId}
```

---

## ğŸ¯ é˜¶æ®µ2ï¼šæ•´åˆè§’è‰²ç³»ç»Ÿï¼ˆWeek 2ï¼‰

### ä»»åŠ¡2.1ï¼šåœ¨AIå¯¹è¯èŠ‚ç‚¹æ”¯æŒroleId

**æ–‡ä»¶**ï¼š`server/services/flow-engine.service.js`

**ä¿®æ”¹æ–¹æ³•**ï¼š`handleAIChatNode`

**æ–°å¢é€»è¾‘**ï¼š
1. æ£€æŸ¥èŠ‚ç‚¹é…ç½®ä¸­æ˜¯å¦æœ‰ `useRolePrompt` å’Œ `roleId`
2. å¦‚æœæœ‰ï¼Œè°ƒç”¨ `getRoleById()` è·å–è§’è‰²ä¿¡æ¯
3. ä½¿ç”¨è§’è‰²çš„ `systemPrompt` ä½œä¸ºAIçš„æç¤ºè¯

**æµ‹è¯•ç”¨ä¾‹**ï¼š
```javascript
// æµ‹è¯•1ï¼šä½¿ç”¨å”®åå¤„ç†è§’è‰²
{
  node: {
    type: 'ai_chat',
    data: {
      modelId: 'f038886b-d042-4aca-9a6f-d1b3049290cc',
      roleId: '1790fcb4-2d5a-4984-8018-09ab1ee77c31',
      useRolePrompt: true
    }
  },
  context: {
    message: { spoken: 'æ€ä¹ˆé€€æ¬¾ï¼Ÿ' }
  }
}

// é¢„æœŸç»“æœï¼šä½¿ç”¨å”®åå¤„ç†è§’è‰²çš„æç¤ºè¯ï¼Œç”Ÿæˆä¸“ä¸šçš„å®¢æœå›å¤
{
  success: true,
  aiResponse: 'æ‚¨å¥½ï¼å…³äºé€€æ¬¾æµç¨‹ï¼Œæˆ‘ä¸ºæ‚¨æä¾›ä»¥ä¸‹æ“ä½œæŒ‡å¼•...',
  context: { aiResponse: 'æ‚¨å¥½ï¼å…³äºé€€æ¬¾æµç¨‹...' }
}
```

---

### ä»»åŠ¡2.2ï¼šåŠ è½½è§’è‰²çš„systemPrompt

**å®ç°æ–¹æ³•**ï¼šå·²åœ¨ä»»åŠ¡2.1ä¸­å®ç°

**éªŒè¯æ–¹æ³•**ï¼š
```bash
# æŸ¥è¯¢è§’è‰²ä¿¡æ¯
psql -U worktool -d worktool_ai -c "SELECT id, name, system_prompt FROM ai_roles WHERE id = '1790fcb4-2d5a-4984-8018-09ab1ee77c31';"

# åˆ›å»ºæµ‹è¯•æµç¨‹ï¼ˆä½¿ç”¨è§’è‰²ï¼‰
curl -X POST http://localhost:5000/api/flow-engine/definitions \
  -H "Content-Type: application/json" \
  -d '{
    "name": "è§’è‰²æµ‹è¯•æµç¨‹",
    "nodes": [
      { "id": "start", "type": "start", "data": {} },
      { "id": "ai-chat", "type": "ai_chat", "data": {
        "modelId": "f038886b-d042-4aca-9a6f-d1b3049290cc",
        "roleId": "1790fcb4-2d5a-4984-8018-09ab1ee77c31",
        "useRolePrompt": true
      }},
      { "id": "end", "type": "end", "data": {} }
    ],
    "edges": [
      { "id": "e1", "source": "start", "target": "ai-chat" },
      { "id": "e2", "source": "ai-chat", "target": "end" }
    ]
  }'
```

---

### ä»»åŠ¡2.3ï¼šæ”¯æŒæ ¹æ®æ„å›¾è‡ªåŠ¨é€‰æ‹©è§’è‰²

**å®ç°æ–¹å¼**ï¼š
1. æ„å›¾è¯†åˆ«èŠ‚ç‚¹è¿”å›intent
2. æ¡ä»¶èŠ‚ç‚¹æ ¹æ®intentåˆ¤æ–­
3. è·¯ç”±åˆ°ä¸åŒçš„AIå¯¹è¯èŠ‚ç‚¹ï¼Œæ¯ä¸ªèŠ‚ç‚¹ä½¿ç”¨ä¸åŒçš„è§’è‰²

**æµ‹è¯•ç”¨ä¾‹**ï¼š
```javascript
// æµ‹è¯•æµç¨‹ï¼šæ ¹æ®æ„å›¾é€‰æ‹©è§’è‰²
{
  "name": "æ„å›¾è·¯ç”±æµç¨‹",
  "nodes": [
    { "id": "start", "type": "start", "data": {} },
    { "id": "intent", "type": "intent", "data": { "modelId": "45d2b7c7-40ef-4f1e-bed8-c133168f8255" } },
    { "id": "condition", "type": "condition", "data": {
      "condition": "context.intent === 'service'"
    }},
    { "id": "service-reply", "type": "ai_chat", "data": {
      "modelId": "f038886b-d042-4aca-9a6f-d1b3049290cc",
      "roleId": "1790fcb4-2d5a-4984-8018-09ab1ee77c31",
      "useRolePrompt": true
    }},
    { "id": "default-reply", "type": "ai_chat", "data": {
      "modelId": "f038886b-d042-4aca-9a6f-d1b3049290cc",
      "roleId": "default-role-id",
      "useRolePrompt": true
    }},
    { "id": "end", "type": "end", "data": {} }
  ],
  "edges": [
    { "id": "e1", "source": "start", "target": "intent" },
    { "id": "e2", "source": "intent", "target": "condition" },
    { "id": "e3", "source": "condition", "target": "service-reply", "label": "true" },
    { "id": "e4", "source": "condition", "target": "default-reply", "label": "false" },
    { "id": "e5", "source": "service-reply", "target": "end" },
    { "id": "e6", "source": "default-reply", "target": "end" }
  ]
}
```

---

### ä»»åŠ¡2.4ï¼šæµ‹è¯•è§’è‰²å·®å¼‚åŒ–å›å¤

**æµ‹è¯•åœºæ™¯**ï¼š
1. âœ… å”®åå¤„ç†è§’è‰²ç”Ÿæˆä¸“ä¸šå®¢æœå›å¤
2. âœ… è½¬åŒ–å®¢æœè§’è‰²ç”Ÿæˆè½¬åŒ–å¼•å¯¼å›å¤
3. âœ… æŠ€æœ¯æ”¯æŒè§’è‰²ç”ŸæˆæŠ€æœ¯æŒ‡å¯¼å›å¤
4. âœ… ä¸åŒè§’è‰²å›å¤é£æ ¼ä¸åŒ

**éªŒè¯æ–¹æ³•**ï¼š
```bash
# ä½¿ç”¨å”®åå¤„ç†è§’è‰²
curl -X POST http://localhost:5000/api/flow-engine/instances \
  -H "Content-Type: application/json" \
  -d '{
    "flowDefinitionId": "{å”®åæµç¨‹ID}",
    "context": {
      "message": { "spoken": "æ€ä¹ˆé€€æ¬¾ï¼Ÿ" }
    }
  }'

# ä½¿ç”¨è½¬åŒ–å®¢æœè§’è‰²
curl -X POST http://localhost:5000/api/flow-engine/instances \
  -H "Content-Type: application/json" \
  -d '{
    "flowDefinitionId": "{è½¬åŒ–æµç¨‹ID}",
    "context": {
      "message": { "spoken": "è¿™ä¸ªäº§å“å¤šå°‘é’±ï¼Ÿ" }
    }
  }'
```

---

## ğŸ¯ é˜¶æ®µ3ï¼šå¯¹æ¥è¯æœ¯æ¨¡æ¿ï¼ˆWeek 3ï¼‰

### ä»»åŠ¡3.1ï¼šåœ¨AIå¯¹è¯èŠ‚ç‚¹æ”¯æŒtemplateId

**æ–‡ä»¶**ï¼š`server/services/flow-engine.service.js`

**ä¿®æ”¹æ–¹æ³•**ï¼š`handleAIChatNode`

**æ–°å¢é€»è¾‘**ï¼š
1. æ£€æŸ¥èŠ‚ç‚¹é…ç½®ä¸­æ˜¯å¦æœ‰ `useTemplate` å’Œ `templateId`
2. å¦‚æœæœ‰ï¼Œè°ƒç”¨ `getTemplateById()` è·å–æ¨¡æ¿ä¿¡æ¯
3. ä½¿ç”¨æ¨¡æ¿çš„ `template` å­—æ®µä½œä¸ºAIçš„æç¤ºè¯
4. æ›¿æ¢æ¨¡æ¿ä¸­çš„å˜é‡

**æµ‹è¯•ç”¨ä¾‹**ï¼š
```javascript
// æµ‹è¯•1ï¼šä½¿ç”¨è¯æœ¯æ¨¡æ¿
{
  node: {
    type: 'ai_chat',
    data: {
      modelId: 'f038886b-d042-4aca-9a6f-d1b3049290cc',
      templateId: 'template-123',
      useTemplate: true,
      variables: {
        userName: '{{userName}}',
        groupName: '{{groupName}}'
      }
    }
  },
  context: {
    message: { spoken: 'ä½ å¥½' },
    userName: 'å¼ ä¸‰',
    groupName: 'äº§å“äº¤æµç¾¤'
  }
}
```

---

### ä»»åŠ¡3.2ï¼šä»æ•°æ®åº“åŠ è½½è¯æœ¯æ¨¡æ¿

**æ–°å¢æ–¹æ³•**ï¼š`getTemplateById(templateId)`

**å®ç°ä»£ç **ï¼š
```javascript
async getTemplateById(templateId) {
  const db = await this.getDb();
  const { promptTemplates } = require('../database/schema');

  const templates = await db.select()
    .from(promptTemplates)
    .where(eq(promptTemplates.id, templateId))
    .limit(1);

  return templates[0] || null;
}
```

---

### ä»»åŠ¡3.3ï¼šå®ç°æ¨¡æ¿å˜é‡æ›¿æ¢

**æ–°å¢æ–¹æ³•**ï¼š`replaceTemplateVariables(template, variables)`

**å®ç°ä»£ç **ï¼š
```javascript
replaceTemplateVariables(template, variables) {
  let result = template;
  for (const [key, value] of Object.entries(variables)) {
    const regex = new RegExp(`{{${key}}}`, 'g');
    result = result.replace(regex, value);
  }
  return result;
}
```

---

### ä»»åŠ¡3.4ï¼šæ·»åŠ æ¨¡æ¿ç¼“å­˜

**ä¿®æ”¹ç±»**ï¼š`FlowEngine`

**æ–°å¢å±æ€§**ï¼š
```javascript
constructor() {
  // ... å…¶ä»–ä»£ç 

  // æ¨¡æ¿ç¼“å­˜
  this.templateCache = new Map();
  this.templateCacheExpire = 5 * 60 * 1000; // 5åˆ†é’Ÿè¿‡æœŸ
}
```

**æ–°å¢æ–¹æ³•**ï¼š
```javascript
// æ¸…é™¤æ¨¡æ¿ç¼“å­˜
clearTemplateCache(templateId) {
  if (templateId) {
    this.templateCache.delete(templateId);
  } else {
    this.templateCache.clear();
  }
}
```

---

### ä»»åŠ¡3.5ï¼šæµ‹è¯•è¯æœ¯æ¨¡æ¿åŠŸèƒ½

**æµ‹è¯•åœºæ™¯**ï¼š
1. âœ… è¯æœ¯æ¨¡æ¿æ­£å¸¸åŠ è½½
2. âœ… æ¨¡æ¿å˜é‡æ­£ç¡®æ›¿æ¢
3. âœ… æ¨¡æ¿ç¼“å­˜ç”Ÿæ•ˆ
4. âœ… æ¨¡æ¿æ›´æ–°åç¼“å­˜åˆ·æ–°

**éªŒè¯æ–¹æ³•**ï¼š
```bash
# æŸ¥è¯¢è¯æœ¯æ¨¡æ¿
psql -U worktool -d worktool_ai -c "SELECT id, type, system_prompt FROM prompt_templates LIMIT 5;"

# åˆ›å»ºæµ‹è¯•æµç¨‹ï¼ˆä½¿ç”¨æ¨¡æ¿ï¼‰
curl -X POST http://localhost:5000/api/flow-engine/definitions \
  -H "Content-Type: application/json" \
  -d '{
    "name": "æ¨¡æ¿æµ‹è¯•æµç¨‹",
    "nodes": [
      { "id": "start", "type": "start", "data": {} },
      { "id": "ai-chat", "type": "ai_chat", "data": {
        "modelId": "f038886b-d042-4aca-9a6f-d1b3049290cc",
        "templateId": "{æ¨¡æ¿ID}",
        "useTemplate": true
      }},
      { "id": "end", "type": "end", "data": {} }
    ],
    "edges": [
      { "id": "e1", "source": "start", "target": "ai-chat" },
      { "id": "e2", "source": "ai-chat", "target": "end" }
    ]
  }'
```

---

## ğŸ¯ é˜¶æ®µ4ï¼šå®ç°çœŸå®èŠ‚ç‚¹åŠŸèƒ½ï¼ˆWeek 4ï¼‰

### ä»»åŠ¡4.1ï¼šå®ç°æœåŠ¡èŠ‚ç‚¹

**æ–‡ä»¶**ï¼š`server/services/flow-engine.service.js`

**ä¿®æ”¹æ–¹æ³•**ï¼š`handleServiceNode`

**ä¸»è¦æ”¹åŠ¨**ï¼š
1. æ ¹æ® `serviceName` è°ƒç”¨ä¸åŒçš„AIæœåŠ¡
2. æ”¯æŒ `intent_recognition`ã€`service_reply`ã€`conversion_reply`
3. çœŸå®è°ƒç”¨AIæœåŠ¡ï¼Œè¿”å›çœŸå®ç»“æœ

**æµ‹è¯•ç”¨ä¾‹**ï¼š
```javascript
// æµ‹è¯•1ï¼šæœåŠ¡èŠ‚ç‚¹è°ƒç”¨æ„å›¾è¯†åˆ«
{
  node: {
    type: 'service',
    data: {
      serviceName: 'intent_recognition',
      parameters: {
        modelId: '45d2b7c7-40ef-4f1e-bed8-c133168f8255',
        message: 'æˆ‘éœ€è¦å¸®åŠ©',
        context: {}
      }
    }
  },
  context: {}
}

// é¢„æœŸç»“æœï¼š
{
  success: true,
  serviceResult: {
    intent: 'help',
    confidence: 90,
    needReply: true
  }
}
```

---

### ä»»åŠ¡4.2ï¼šå®ç°äººå·¥è½¬æ¥èŠ‚ç‚¹

**æ–‡ä»¶**ï¼š`server/services/flow-engine.service.js`

**ä¿®æ”¹æ–¹æ³•**ï¼š`handleHumanHandoverNode`

**ä¸»è¦æ”¹åŠ¨**ï¼š
1. æ›´æ–°ä¼šè¯çŠ¶æ€ä¸ºäººå·¥å¤„ç†
2. è®°å½•è½¬æ¥åŸå› å’Œæ—¶é—´
3. çœŸå®æ›´æ–°æ•°æ®åº“

**æµ‹è¯•ç”¨ä¾‹**ï¼š
```javascript
// æµ‹è¯•1ï¼šäººå·¥è½¬æ¥èŠ‚ç‚¹
{
  node: {
    type: 'human_handover',
    data: {
      targetUser: 'admin',
      message: 'è½¬æ¥åˆ°äººå·¥å®¢æœ',
      sessionId: 'test-session'
    }
  },
  context: {
    sessionId: 'test-session'
  }
}

// é¢„æœŸç»“æœï¼šä¼šè¯çŠ¶æ€æ›´æ–°ä¸ºhuman
```

---

### ä»»åŠ¡4.3ï¼šå®ç°é€šçŸ¥èŠ‚ç‚¹

**æ–‡ä»¶**ï¼š`server/services/flow-engine.service.js`

**ä¿®æ”¹æ–¹æ³•**ï¼š`handleNotificationNode`

**ä¸»è¦æ”¹åŠ¨**ï¼š
1. æ”¯æŒ `alert` ç±»å‹é€šçŸ¥ï¼Œè°ƒç”¨ `alert-trigger.service`
2. æ”¯æŒ `robot` ç±»å‹é€šçŸ¥ï¼Œè°ƒç”¨ `worktool.service`
3. çœŸå®å‘é€é€šçŸ¥

**æµ‹è¯•ç”¨ä¾‹**ï¼š
```javascript
// æµ‹è¯•1ï¼šå‘Šè­¦é€šçŸ¥
{
  node: {
    type: 'notification',
    data: {
      notificationType: 'alert',
      alertLevel: 'warning'
    }
  },
  context: {
    sessionId: 'test-session',
    intent: 'risk',
    message: { spoken: 'æŠ•è¯‰å†…å®¹' },
    robotId: 'robot-123',
    robotName: 'å®¢æœæœºå™¨äºº',
    userId: 'user-456',
    userName: 'å¼ ä¸‰',
    groupId: 'group-789',
    groupName: 'å®¢æœç¾¤'
  }
}

// é¢„æœŸç»“æœï¼šè§¦å‘å‘Šè­¦ï¼Œç”Ÿæˆå‘Šè­¦å†å²
```

---

### ä»»åŠ¡4.4ï¼šæµ‹è¯•æ‰€æœ‰èŠ‚ç‚¹åŠŸèƒ½

**æµ‹è¯•åœºæ™¯**ï¼š
1. âœ… æœåŠ¡èŠ‚ç‚¹èƒ½è°ƒç”¨AIæœåŠ¡
2. âœ… äººå·¥è½¬æ¥èŠ‚ç‚¹èƒ½æ›´æ–°ä¼šè¯çŠ¶æ€
3. âœ… é€šçŸ¥èŠ‚ç‚¹èƒ½è§¦å‘å‘Šè­¦
4. âœ… æ‰€æœ‰èŠ‚ç‚¹é”™è¯¯å¤„ç†æ­£å¸¸

**éªŒè¯æ–¹æ³•**ï¼š
```bash
# æµ‹è¯•æœåŠ¡èŠ‚ç‚¹
curl -X POST http://localhost:5000/api/flow-engine/instances \
  -H "Content-Type: application/json" \
  -d '{
    "flowDefinitionId": "{æœåŠ¡èŠ‚ç‚¹æµ‹è¯•æµç¨‹ID}",
    "context": {}
  }'

# æµ‹è¯•äººå·¥è½¬æ¥èŠ‚ç‚¹
curl -X POST http://localhost:5000/api/flow-engine/instances \
  -H "Content-Type: application/json" \
  -d '{
    "flowDefinitionId": "{äººå·¥è½¬æ¥æµ‹è¯•æµç¨‹ID}",
    "context": { "sessionId": "test-session" }
  }'

# æµ‹è¯•é€šçŸ¥èŠ‚ç‚¹
curl -X POST http://localhost:5000/api/flow-engine/instances \
  -H "Content-Type: application/json" \
  -d '{
    "flowDefinitionId": "{é€šçŸ¥èŠ‚ç‚¹æµ‹è¯•æµç¨‹ID}",
    "context": { "sessionId": "test-session", "intent": "risk" }
  }'
```

---

## ğŸ¯ é˜¶æ®µ5ï¼šæ¶ˆæ¯å¤„ç†æœåŠ¡è°ƒç”¨æµç¨‹å¼•æ“ï¼ˆWeek 5ï¼‰

### ä»»åŠ¡5.1ï¼šä¿®æ”¹æ¶ˆæ¯å¤„ç†æœåŠ¡

**æ–‡ä»¶**ï¼š`server/services/message-processing.service.js`

**ä¿®æ”¹æ–¹æ³•**ï¼š`processMessage`

**ä¸»è¦æ”¹åŠ¨**ï¼š
1. æŸ¥è¯¢æœºå™¨äººå…³è”çš„æµç¨‹å®šä¹‰
2. åˆ›å»ºæµç¨‹å®ä¾‹
3. å¼‚æ­¥æ‰§è¡Œæµç¨‹
4. æ·»åŠ é™çº§å¤„ç†

**æµ‹è¯•ç”¨ä¾‹**ï¼š
```bash
# å‘é€æµ‹è¯•æ¶ˆæ¯åˆ°WorkTool Webhook
curl -X POST http://localhost:5001/api/worktool/callback/message \
  -H "Content-Type: application/json" \
  -d '{
    "robotId": "robot-123",
    "fromName": "å¼ ä¸‰",
    "groupName": "å®¢æœç¾¤",
    "spoken": "ä½ å¥½",
    "atMe": true
  }'

# é¢„æœŸç»“æœï¼šåˆ›å»ºæµç¨‹å®ä¾‹å¹¶æ‰§è¡Œ
```

---

### ä»»åŠ¡5.2ï¼šæ·»åŠ æœºå™¨äººä¸æµç¨‹å®šä¹‰çš„å…³è”

**æ•°æ®åº“è¿ç§»**ï¼š
```sql
-- æ·»åŠ flowDefinitionIdå­—æ®µåˆ°robotsè¡¨
ALTER TABLE robots ADD COLUMN flow_definition_id VARCHAR(36);

-- æ·»åŠ å¤–é”®çº¦æŸ
ALTER TABLE robots ADD CONSTRAINT fk_flow_definition
  FOREIGN KEY (flow_definition_id) REFERENCES flow_definitions(id);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_robots_flow_definition_id ON robots(flow_definition_id);
```

**æ–°å¢æ–¹æ³•**ï¼š`getFlowDefinitionByRobotId(robotId)`

```javascript
async getFlowDefinitionByRobotId(robotId) {
  const db = await this.getDb();
  const { robots, flowDefinitions } = require('../database/schema');

  const robotsWithFlow = await db.select({
    flowDefinitionId: robots.flow_definition_id
  })
    .from(robots)
    .where(eq(robots.robotId, robotId))
    .limit(1);

  if (robotsWithFlow.length === 0 || !robotsWithFlow[0].flowDefinitionId) {
    return null;
  }

  return await this.getFlowDefinition(robotsWithFlow[0].flowDefinitionId);
}
```

---

### ä»»åŠ¡5.3ï¼šå®ç°é™çº§å¤„ç†æœºåˆ¶

**æ–°å¢æ–¹æ³•**ï¼š`processWithDefaultAI(messageContext, session, robot)`

**å®ç°é€»è¾‘**ï¼š
1. ä½¿ç”¨åŸæœ‰çš„message-processingé€»è¾‘
2. ç›´æ¥è°ƒç”¨ai.serviceè¿›è¡Œæ„å›¾è¯†åˆ«
3. ç”Ÿæˆå›å¤å¹¶å‘é€
4. ä¿å­˜æ¶ˆæ¯è®°å½•

---

### ä»»åŠ¡5.4ï¼šæµ‹è¯•æ¶ˆæ¯å¤„ç†å®Œæ•´æµç¨‹

**æµ‹è¯•åœºæ™¯**ï¼š
1. âœ… æœºå™¨äººå…³è”æµç¨‹å®šä¹‰æ—¶ï¼Œè§¦å‘æµç¨‹å¼•æ“
2. âœ… æœºå™¨äººæœªå…³è”æµç¨‹å®šä¹‰æ—¶ï¼Œé™çº§åˆ°é»˜è®¤AIå¤„ç†
3. âœ… æµç¨‹å¼•æ“æ‰§è¡Œå¤±è´¥æ—¶ï¼Œé™çº§åˆ°é»˜è®¤AIå¤„ç†
4. âœ… å®Œæ•´çš„æ¶ˆæ¯å¤„ç†æµç¨‹æ­£å¸¸å·¥ä½œ

**éªŒè¯æ–¹æ³•**ï¼š
```bash
# å…³è”æµç¨‹å®šä¹‰
psql -U worktool -d worktool_ai -c "UPDATE robots SET flow_definition_id = '{æµç¨‹ID}' WHERE robot_id = 'robot-123';"

# å‘é€æµ‹è¯•æ¶ˆæ¯
curl -X POST http://localhost:5001/api/worktool/callback/message \
  -H "Content-Type: application/json" \
  -d '{
    "robotId": "robot-123",
    "fromName": "å¼ ä¸‰",
    "groupName": "å®¢æœç¾¤",
    "spoken": "ä½ å¥½",
    "atMe": true
  }'

# æŸ¥çœ‹æµç¨‹å®ä¾‹
curl http://localhost:5000/api/flow-engine/instances

# å–æ¶ˆå…³è”æµç¨‹å®šä¹‰
psql -U worktool -d worktool_ai -c "UPDATE robots SET flow_definition_id = NULL WHERE robot_id = 'robot-123';"

# å‘é€æµ‹è¯•æ¶ˆæ¯ï¼ˆé™çº§å¤„ç†ï¼‰
curl -X POST http://localhost:5001/api/worktool/callback/message \
  -H "Content-Type: application/json" \
  -d '{
    "robotId": "robot-123",
    "fromName": "å¼ ä¸‰",
    "groupName": "å®¢æœç¾¤",
    "spoken": "ä½ å¥½",
    "atMe": true
  }'
```

---

## ğŸ¯ é˜¶æ®µ6ï¼šå…¨é¢æµ‹è¯•ä¸ä¼˜åŒ–ï¼ˆWeek 6ï¼‰

### ä»»åŠ¡6.1ï¼šç«¯åˆ°ç«¯æµ‹è¯•

**æµ‹è¯•åœºæ™¯**ï¼š
1. âœ… å®Œæ•´çš„æ¶ˆæ¯å¤„ç†æµç¨‹
2. âœ… æµç¨‹å¼•æ“æ‰§è¡Œæµç¨‹
3. âœ… AIæœåŠ¡è°ƒç”¨æµç¨‹
4. âœ… æ•°æ®åº“è®°å½•æµç¨‹

**æµ‹è¯•æ­¥éª¤**ï¼š
1. é…ç½®æœºå™¨äººå…³è”æµç¨‹å®šä¹‰
2. é€šè¿‡WorkToolå‘é€æµ‹è¯•æ¶ˆæ¯
3. éªŒè¯æµç¨‹å®ä¾‹åˆ›å»ºå’Œæ‰§è¡Œ
4. éªŒè¯AIå›å¤ç”Ÿæˆ
5. éªŒè¯æ¶ˆæ¯å‘é€
6. éªŒè¯æ•°æ®åº“è®°å½•

---

### ä»»åŠ¡6.2ï¼šæ€§èƒ½æµ‹è¯•

**æµ‹è¯•æŒ‡æ ‡**ï¼š
- æ¶ˆæ¯å¤„ç†å»¶è¿Ÿï¼ˆ< 3ç§’ï¼‰
- æµç¨‹å¼•æ“æ‰§è¡Œæ—¶é—´ï¼ˆ< 5ç§’ï¼‰
- AIæœåŠ¡è°ƒç”¨æ—¶é—´ï¼ˆ< 2ç§’ï¼‰
- å¹¶å‘å¤„ç†èƒ½åŠ›ï¼ˆ100 QPSï¼‰

**æµ‹è¯•æ–¹æ³•**ï¼š
```bash
# ä½¿ç”¨Apache Benchè¿›è¡Œå‹åŠ›æµ‹è¯•
ab -n 1000 -c 10 -p test-message.json -T application/json \
   http://localhost:5001/api/worktool/callback/message
```

---

### ä»»åŠ¡6.3ï¼šé”™è¯¯å¤„ç†æµ‹è¯•

**æµ‹è¯•åœºæ™¯**ï¼š
1. âœ… AIæœåŠ¡ä¸å¯ç”¨æ—¶çš„é™çº§å¤„ç†
2. âœ… æµç¨‹å®šä¹‰ä¸å­˜åœ¨æ—¶çš„é™çº§å¤„ç†
3. âœ… æ•°æ®åº“è¿æ¥å¤±è´¥æ—¶çš„é”™è¯¯å¤„ç†
4. âœ… ç½‘ç»œè¶…æ—¶æ—¶çš„é”™è¯¯å¤„ç†

---

### ä»»åŠ¡6.4ï¼šæ–‡æ¡£æ›´æ–°

**éœ€è¦æ›´æ–°çš„æ–‡æ¡£**ï¼š
1. ç³»ç»Ÿæ„é€ è¯´æ˜ä¹¦
2. APIæ–‡æ¡£
3. è¿ç»´æ‰‹å†Œ
4. ç”¨æˆ·æ‰‹å†Œ

---

### ä»»åŠ¡6.5ï¼šä¸Šçº¿éƒ¨ç½²

**éƒ¨ç½²æ­¥éª¤**ï¼š
1. å¤‡ä»½æ•°æ®åº“
2. éƒ¨ç½²æ–°ä»£ç 
3. æ‰§è¡Œæ•°æ®åº“è¿ç§»
4. é‡å¯æœåŠ¡
5. éªŒè¯åŠŸèƒ½
6. ç›‘æ§æ—¥å¿—

---

## ğŸ“Š é‡Œç¨‹ç¢‘æ£€æŸ¥ç‚¹

| é˜¶æ®µ | å®Œæˆæ—¶é—´ | æ£€æŸ¥ç‚¹ | éªŒæ”¶æ ‡å‡† |
|------|---------|-------|---------|
| é˜¶æ®µ1 | Week 1 | ç»Ÿä¸€AIæœåŠ¡è°ƒç”¨ | AIèŠ‚ç‚¹èƒ½æ­£å¸¸è°ƒç”¨AIæœåŠ¡ |
| é˜¶æ®µ2 | Week 2 | æ•´åˆè§’è‰²ç³»ç»Ÿ | è§’è‰²å·®å¼‚åŒ–å›å¤æ­£å¸¸å·¥ä½œ |
| é˜¶æ®µ3 | Week 3 | å¯¹æ¥è¯æœ¯æ¨¡æ¿ | è¯æœ¯æ¨¡æ¿åŠ¨æ€åŠ è½½æ­£å¸¸ |
| é˜¶æ®µ4 | Week 4 | å®ç°çœŸå®èŠ‚ç‚¹åŠŸèƒ½ | æ‰€æœ‰èŠ‚ç‚¹åŠŸèƒ½çœŸå®å¯ç”¨ |
| é˜¶æ®µ5 | Week 5 | æ¶ˆæ¯å¤„ç†æœåŠ¡è°ƒç”¨æµç¨‹å¼•æ“ | æ¶ˆæ¯å¤„ç†è§¦å‘æµç¨‹å¼•æ“ |
| é˜¶æ®µ6 | Week 6 | å…¨é¢æµ‹è¯•ä¸ä¼˜åŒ– | æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼Œå¯ä¸Šçº¿ |

---

## ğŸš¨ é£é™©æ§åˆ¶

### é£é™©1ï¼šAIæœåŠ¡è°ƒç”¨å˜æ›´é£é™©

**é£é™©æè¿°**ï¼šä¿®æ”¹AIæœåŠ¡è°ƒç”¨å¯èƒ½å¯¼è‡´åŠŸèƒ½å¼‚å¸¸

**åº”å¯¹æªæ–½**ï¼š
1. ä¿ç•™é™çº§å¤„ç†æœºåˆ¶
2. æ¯ä¸ªé˜¶æ®µå®Œæˆåå……åˆ†æµ‹è¯•
3. ç°åº¦å‘å¸ƒï¼Œé€æ­¥æ›¿æ¢

### é£é™©2ï¼šè§’è‰²ç³»ç»Ÿå…¼å®¹æ€§é£é™©

**é£é™©æè¿°**ï¼šè§’è‰²ç³»ç»Ÿå¯èƒ½ä¸ç°æœ‰åŠŸèƒ½ä¸å…¼å®¹

**åº”å¯¹æªæ–½**ï¼š
1. é€æ­¥è¿ç§»ï¼Œå…ˆåœ¨æ–°æµç¨‹ä¸­ä½¿ç”¨
2. æ—§æµç¨‹ä¿æŒä¸å˜
3. æä¾›å›æ»šæ–¹æ¡ˆ

### é£é™©3ï¼šæ¶ˆæ¯å¤„ç†æµç¨‹å˜æ›´é£é™©

**é£é™©æè¿°**ï¼šä¿®æ”¹æ¶ˆæ¯å¤„ç†æµç¨‹å¯èƒ½å½±å“ç°æœ‰åŠŸèƒ½

**åº”å¯¹æªæ–½**ï¼š
1. ä¿ç•™é™çº§å¤„ç†æœºåˆ¶
2. å……åˆ†æµ‹è¯•å„ç§åœºæ™¯
3. ç›‘æ§ç³»ç»Ÿè¿è¡ŒçŠ¶æ€

---

## ğŸ“ æ€»ç»“

### å®æ–½åŸåˆ™

1. **æ¸è¿›å¼ä¼˜åŒ–**ï¼šé€æ­¥æ¨è¿›ï¼Œæ¯é˜¶æ®µç‹¬ç«‹éªŒè¯
2. **ä¿æŒç¨³å®š**ï¼šæ¯ä¸ªé˜¶æ®µéƒ½æœ‰é™çº§å¤„ç†æœºåˆ¶
3. **å……åˆ†æµ‹è¯•**ï¼šæ¯ä¸ªé˜¶æ®µå®Œæˆåå……åˆ†æµ‹è¯•
4. **é£é™©æ§åˆ¶**ï¼šæå‰è¯†åˆ«é£é™©ï¼Œåˆ¶å®šåº”å¯¹æªæ–½

### é¢„æœŸæ•ˆæœ

1. **åŠŸèƒ½å®Œæ•´æ€§**ï¼šæ‰€æœ‰èŠ‚ç‚¹åŠŸèƒ½çœŸå®å¯ç”¨
2. **æ¶æ„ä¸€è‡´æ€§**ï¼šç»Ÿä¸€ä½¿ç”¨AIæœåŠ¡ã€è§’è‰²ç³»ç»Ÿã€è¯æœ¯æ¨¡æ¿
3. **å¯ç»´æŠ¤æ€§**ï¼šä»£ç é‡å¤æ¶ˆé™¤ï¼Œæ˜“äºç»´æŠ¤
4. **å¯æ‰©å±•æ€§**ï¼šé«˜åº¦å¯æ‰©å±•ï¼Œæ”¯æŒè‡ªå®šä¹‰èŠ‚ç‚¹
5. **æ€§èƒ½ä¼˜åŒ–**ï¼šé€šè¿‡ç¼“å­˜å’Œå¼‚æ­¥å¤„ç†æå‡æ€§èƒ½

### åç»­ä¼˜åŒ–æ–¹å‘

1. **æ€§èƒ½ä¼˜åŒ–**ï¼šå¼•å…¥Redisç¼“å­˜ï¼Œæå‡æŸ¥è¯¢é€Ÿåº¦
2. **ç›‘æ§å®Œå–„**ï¼šå¢åŠ æµç¨‹å¼•æ“ç›‘æ§æŒ‡æ ‡
3. **æµ‹è¯•è¦†ç›–**ï¼šå¢åŠ å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•
4. **æ–‡æ¡£å®Œå–„**ï¼šå®Œå–„APIæ–‡æ¡£å’Œç”¨æˆ·æ‰‹å†Œ
