# è½¬åŒ–å®¢æœä¸šåŠ¡è®¾è®¡ä¸æŠ€æœ¯æ–¹æ¡ˆ

## ğŸ“Š ä¸šåŠ¡èƒŒæ™¯

### ç›®æ ‡ç”¨æˆ·
- æ¯å¤©å¤§é‡ç”¨æˆ·åŠ å¥½å‹
- ç”¨æˆ·èº«ä»½ï¼šæƒ³åšè§†é¢‘å·è¿è¥çš„å…¼èŒäººå‘˜
- ç”¨æˆ·éœ€æ±‚ï¼šè·å–è§†é¢‘å·è¿è¥å…¼èŒæœºä¼š

### è½¬åŒ–ç›®æ ‡
1. **æ‰“æ¶ˆç–‘è™‘** - ä¸»åŠ¨å¼•å¯¼ç”¨æˆ·ï¼Œæ¶ˆé™¤ç”¨æˆ·é¡¾è™‘
2. **æ­å»ºè§†é¢‘å·** - å¼•å¯¼ç”¨æˆ·å®Œæˆè§†é¢‘å·æ­å»º
3. **æ‰«ç ç™»å½•** - å‘é€è§†é¢‘å·äºŒç»´ç ï¼Œç”¨æˆ·æ‰«ç ç™»å½•
4. **éªŒè¯åˆè§„æ€§** - æ£€æµ‹è§†é¢‘å·å°åº—å’ŒåŠ©æ‰‹é¡µé¢æ˜¯å¦å¯è®¿é—®
5. **æå–CK** - æå–å¹¶ä¿å­˜ç½‘é¡µCookie
6. **äººå·¥å®¡æ ¸** - å®¢æœäººå·¥æ£€æµ‹è§†é¢‘å·æ˜¯å¦ç¬¦åˆè§„åˆ™

---

## ğŸ”„ å®Œæ•´ä¸šåŠ¡æµç¨‹

```
ç”¨æˆ·åŠ å¥½å‹
  â†“
ã€é˜¶æ®µ1ï¼šæ‰“æ¶ˆç–‘è™‘ã€‘
  ä¸»åŠ¨è”ç³»ç”¨æˆ· â†’ è§£ç­”ç–‘é—® â†’ å»ºç«‹ä¿¡ä»»
  â†“
ã€é˜¶æ®µ2ï¼šå¼•å¯¼æ­å»ºã€‘
  å‘é€æ­å»ºæ•™ç¨‹ â†’ ç”¨æˆ·å®Œæˆè§†é¢‘å·æ­å»º
  â†“
ã€é˜¶æ®µ3ï¼šæ‰«ç ç™»å½•ã€‘
  ç³»ç»Ÿè·å–æœ€æ–°äºŒç»´ç  â†’ å‘é€ç»™ç”¨æˆ· â†’ ç”¨æˆ·æ‰«ç ç™»å½•
  â†“
ã€é˜¶æ®µ4ï¼šæ£€æµ‹ç™»å½•ã€‘
  ç³»ç»Ÿè‡ªåŠ¨æ£€æµ‹æ˜¯å¦ç™»å½•æˆåŠŸ
  â”œâ”€ æˆåŠŸ â†’ ç»§ç»­ä¸‹ä¸€æ­¥
  â””â”€ å¤±è´¥ â†’ æé†’ç”¨æˆ·é‡æ–°æ‰«ç 
  â†“
ã€é˜¶æ®µ5ï¼šæ£€æµ‹é¡µé¢ã€‘
  æ£€æµ‹è§†é¢‘å·å°åº—é¡µé¢èƒ½å¦è¿›å…¥
  æ£€æµ‹è§†é¢‘å·åŠ©æ‰‹é¡µé¢èƒ½å¦è¿›å…¥
  â”œâ”€ éƒ½èƒ½è¿›å…¥ â†’ ç»§ç»­ä¸‹ä¸€æ­¥
  â””â”€ æ— æ³•è¿›å…¥ â†’ æç¤ºç”¨æˆ·æ£€æŸ¥
  â†“
ã€é˜¶æ®µ6ï¼šæå–CKã€‘
  ç³»ç»Ÿè‡ªåŠ¨æå–ç½‘é¡µCookie
  ä¿å­˜åˆ°æ•°æ®åº“
  ç”ŸæˆCKåˆ†äº«é“¾æ¥
  â†“
ã€é˜¶æ®µ7ï¼šäººå·¥å®¡æ ¸ã€‘
  å®¢æœäººå·¥æ£€æµ‹è§†é¢‘å·æ˜¯å¦ç¬¦åˆè§„åˆ™
  â”œâ”€ ç¬¦åˆ â†’ å®¡æ ¸é€šè¿‡
  â””â”€ ä¸ç¬¦åˆ â†’ æ‹’ç»å¹¶è¯´æ˜åŸå› 
  â†“
ã€é˜¶æ®µ8ï¼šå®Œæˆè½¬åŒ–ã€‘
  ç”¨æˆ·æ­£å¼æˆä¸ºå…¼èŒäººå‘˜
  å¼€å§‹è§†é¢‘å·è¿è¥å·¥ä½œ
```

---

## ğŸ¯ è½¬åŒ–å®¢æœæµç¨‹è®¾è®¡

### æµç¨‹èŠ‚ç‚¹è®¾è®¡

```json
{
  "name": "è§†é¢‘å·å…¼èŒäººå‘˜è½¬åŒ–æµç¨‹",
  "description": "å¼•å¯¼å…¼èŒäººå‘˜å®Œæˆè§†é¢‘å·æ­å»ºã€ç™»å½•ã€CKæå–ã€äººå·¥å®¡æ ¸çš„å®Œæ•´è½¬åŒ–æµç¨‹",
  "status": "active",
  "triggerType": "webhook",
  "triggerConfig": {
    "webhookUrl": "/webhook/conversion/video",
    "method": "POST"
  },
  "nodes": [
    // ============ é˜¶æ®µ1ï¼šæ¥æ”¶ç”¨æˆ· ============
    {
      "id": "node_1",
      "type": "MESSAGE_RECEIVE",
      "name": "æ¥æ”¶æ–°å¥½å‹",
      "description": "æ¥æ”¶æ–°æ·»åŠ çš„å¥½å‹ä¿¡æ¯",
      "data": {
        "config": {
          "saveToDatabase": true,
          "extractFields": {
            "userId": true,
            "userName": true,
            "userType": "potential_parttime"
          }
        }
      },
      "nextNodeId": "node_2"
    },

    // ============ é˜¶æ®µ2ï¼šä¸»åŠ¨è”ç³» ============
    {
      "id": "node_2",
      "type": "AI_REPLY",
      "name": "ä¸»åŠ¨å¼•å¯¼",
      "description": "ä¸»åŠ¨è”ç³»ç”¨æˆ·ï¼Œæ‰“æ¶ˆç–‘è™‘",
      "data": {
        "config": {
          "modelId": "doubao-pro-4k",
          "temperature": 0.8,
          "replyStrategy": "proactive",
          "proactiveMode": "adjustable", // å¯è°ƒæ•´ä¸»åŠ¨æ€§
          "template": "æ‚¨å¥½ï¼æˆ‘æ˜¯è§†é¢‘å·è¿è¥å®¢æœã€‚çœ‹åˆ°æ‚¨æ·»åŠ å¥½å‹äº†ï¼Œæƒ³äº†è§£ä¸€ä¸‹æ‚¨å¯¹è§†é¢‘å·è¿è¥å…¼èŒæ„Ÿå…´è¶£å—ï¼Ÿæˆ‘å¯ä»¥ä¸ºæ‚¨è¯¦ç»†ä»‹ç»ã€‚"
        }
      },
      "nextNodeId": "node_3"
    },

    {
      "id": "node_3",
      "type": "INTENT",
      "name": "ç”¨æˆ·æ„å›¾è¯†åˆ«",
      "description": "è¯†åˆ«ç”¨æˆ·æ˜¯å¦æ„¿æ„ç»§ç»­",
      "data": {
        "config": {
          "modelId": "doubao-pro-4k",
          "supportedIntents": [
            "interested",      // æ„Ÿå…´è¶£
            "hesitant",        // çŠ¹è±«
            "reject",          // æ‹’ç»
            "question"         // æœ‰ç–‘é—®
          ]
        }
      },
      "nextNodeId": "node_4"
    },

    {
      "id": "node_4",
      "type": "DECISION",
      "name": "æ„å‘åˆ†æµ",
      "description": "æ ¹æ®ç”¨æˆ·æ„å‘åˆ†æµ",
      "data": {
        "config": {
          "decisionMode": "priority",
          "conditions": [
            {
              "label": "æ„Ÿå…´è¶£",
              "expression": "context.intent === 'interested'",
              "targetNodeId": "node_5"
            },
            {
              "label": "æœ‰ç–‘é—®",
              "expression": "context.intent === 'question'",
              "targetNodeId": "node_6"
            },
            {
              "label": "çŠ¹è±«",
              "expression": "context.intent === 'hesitant'",
              "targetNodeId": "node_7"
            },
            {
              "label": "æ‹’ç»",
              "expression": "context.intent === 'reject'",
              "targetNodeId": "node_end"
            }
          ]
        }
      }
    },

    // ============ é˜¶æ®µ3ï¼šè§£ç­”ç–‘é—® ============
    {
      "id": "node_6",
      "type": "AI_REPLY",
      "name": "è§£ç­”ç–‘é—®",
      "description": "è§£ç­”ç”¨æˆ·ç–‘é—®ï¼Œæ‰“æ¶ˆç–‘è™‘",
      "data": {
        "config": {
          "modelId": "doubao-pro-4k",
          "temperature": 0.7,
          "replyStrategy": "answer"
        }
      },
      "nextNodeId": "node_5"
    },

    {
      "id": "node_7",
      "type": "AI_REPLY",
      "name": "æ‰“æ¶ˆçŠ¹è±«",
      "description": "æ‰“æ¶ˆç”¨æˆ·çŠ¹è±«ï¼Œå¢å¼ºä¿¡å¿ƒ",
      "data": {
        "config": {
          "modelId": "doubao-pro-4k",
          "temperature": 0.8,
          "replyStrategy": "persuade"
        }
      },
      "nextNodeId": "node_5"
    },

    // ============ é˜¶æ®µ4ï¼šå¼•å¯¼æ­å»º ============
    {
      "id": "node_5",
      "type": "AI_REPLY",
      "name": "å‘é€æ­å»ºæ•™ç¨‹",
      "description": "å‘é€è§†é¢‘å·æ­å»ºæ•™ç¨‹",
      "data": {
        "config": {
          "modelId": "doubao-pro-4k",
          "replyStrategy": "guide",
          "includeTutorial": true
        }
      },
      "nextNodeId": "node_8"
    },

    {
      "id": "node_8",
      "type": "DECISION",
      "name": "ç¡®è®¤æ­å»ºå®Œæˆ",
      "description": "ç¡®è®¤ç”¨æˆ·æ˜¯å¦å®Œæˆè§†é¢‘å·æ­å»º",
      "data": {
        "config": {
          "decisionMode": "manual",
          "conditions": [
            {
              "label": "å·²æ­å»ºå®Œæˆ",
              "expression": "context.setupCompleted === true",
              "targetNodeId": "node_9"
            },
            {
              "label": "æ­å»ºä¸­",
              "expression": "true",
              "targetNodeId": "node_8"
            }
          ]
        }
      }
    },

    // ============ é˜¶æ®µ5ï¼šå‘é€äºŒç»´ç  ============
    {
      "id": "node_9",
      "type": "HTTP_REQUEST",
      "name": "è·å–æœ€æ–°äºŒç»´ç ",
      "description": "ä»è§†é¢‘å·å°åº—æ¥å£è·å–æœ€æ–°çš„ç™»å½•äºŒç»´ç ",
      "data": {
        "config": {
          "method": "GET",
          "url": "https://channels.weixin.qq.com/api/get_login_qrcode",
          "headers": {
            "Authorization": "Bearer {{context.accessToken}}"
          },
          "timeout": 10000
        }
      },
      "nextNodeId": "node_10"
    },

    {
      "id": "node_10",
      "type": "SEND_COMMAND",
      "name": "å‘é€äºŒç»´ç ",
      "description": "å‘é€äºŒç»´ç ç»™ç”¨æˆ·æ‰«ç ç™»å½•",
      "data": {
        "config": {
          "commandType": "message",
          "messageType": "image",
          "imageUrl": "{{context.qrCodeUrl}}",
          "messageContent": "è¯·æ‰«æä¸Šæ–¹äºŒç»´ç ç™»å½•è§†é¢‘å·å°åº—"
        }
      },
      "nextNodeId": "node_11"
    },

    // ============ é˜¶æ®µ6ï¼šæ£€æµ‹ç™»å½• ============
    {
      "id": "node_11",
      "type": "HTTP_REQUEST",
      "name": "æ£€æµ‹ç™»å½•çŠ¶æ€",
      "description": "è½®è¯¢æ£€æµ‹ç”¨æˆ·æ˜¯å¦æ‰«ç ç™»å½•æˆåŠŸ",
      "data": {
        "config": {
          "method": "POST",
          "url": "https://channels.weixin.qq.com/api/check_login_status",
          "headers": {
            "Authorization": "Bearer {{context.accessToken}}"
          },
          "body": {
            "qrCodeId": "{{context.qrCodeId}}"
          },
          "polling": {
            "enabled": true,
            "interval": 3000,
            "maxAttempts": 20,
            "successCondition": "status === 'success'"
          }
        }
      },
      "nextNodeId": "node_12"
    },

    {
      "id": "node_12",
      "type": "DECISION",
      "name": "ç™»å½•ç»“æœåˆ¤æ–­",
      "description": "åˆ¤æ–­ç™»å½•æ˜¯å¦æˆåŠŸ",
      "data": {
        "config": {
          "decisionMode": "priority",
          "conditions": [
            {
              "label": "ç™»å½•æˆåŠŸ",
              "expression": "context.loginStatus === 'success'",
              "targetNodeId": "node_13"
            },
            {
              "label": "ç™»å½•å¤±è´¥",
              "expression": "context.loginStatus === 'failed'",
              "targetNodeId": "node_10"
            },
            {
              "label": "è¶…æ—¶",
              "expression": "context.loginStatus === 'timeout'",
              "targetNodeId": "node_10"
            }
          ]
        }
      }
    },

    // ============ é˜¶æ®µ7ï¼šæ£€æµ‹é¡µé¢ ============
    {
      "id": "node_13",
      "type": "HTTP_REQUEST",
      "name": "æ£€æµ‹è§†é¢‘å·å°åº—",
      "description": "æ£€æµ‹è§†é¢‘å·å°åº—é¡µé¢èƒ½å¦è¿›å…¥",
      "data": {
        "config": {
          "method": "GET",
          "url": "https://channels.weixin.qq.com/shop",
          "headers": {
            "Cookie": "{{context.cookies}}"
          },
          "timeout": 10000
        }
      },
      "nextNodeId": "node_14"
    },

    {
      "id": "node_14",
      "type": "HTTP_REQUEST",
      "name": "æ£€æµ‹è§†é¢‘å·åŠ©æ‰‹",
      "description": "æ£€æµ‹è§†é¢‘å·åŠ©æ‰‹é¡µé¢èƒ½å¦è¿›å…¥",
      "data": {
        "config": {
          "method": "GET",
          "url": "https://channels.weixin.qq.com/assistant",
          "headers": {
            "Cookie": "{{context.cookies}}"
          },
          "timeout": 10000
        }
      },
      "nextNodeId": "node_15"
    },

    {
      "id": "node_15",
      "type": "DECISION",
      "name": "é¡µé¢æ£€æµ‹ç»“æœ",
      "description": "åˆ¤æ–­é¡µé¢æ˜¯å¦å¯è®¿é—®",
      "data": {
        "config": {
          "decisionMode": "priority",
          "conditions": [
            {
              "label": "éƒ½èƒ½è®¿é—®",
              "expression": "context.shopAccessible && context.assistantAccessible",
              "targetNodeId": "node_16"
            },
            {
              "label": "æ— æ³•è®¿é—®",
              "expression": "true",
              "targetNodeId": "node_17"
            }
          ]
        }
      }
    },

    {
      "id": "node_17",
      "type": "AI_REPLY",
      "name": "æç¤ºæ£€æŸ¥",
      "description": "æç¤ºç”¨æˆ·æ£€æŸ¥è§†é¢‘å·çŠ¶æ€",
      "data": {
        "config": {
          "modelId": "doubao-pro-4k",
          "replyStrategy": "remind"
        }
      },
      "nextNodeId": "node_13"
    },

    // ============ é˜¶æ®µ8ï¼šæå–å¹¶ä¿å­˜CK ============
    {
      "id": "node_16",
      "type": "VARIABLE_SET",
      "name": "æå–CK",
      "description": "æå–ç½‘é¡µCookie",
      "data": {
        "config": {
          "cookieExtraction": {
            "source": "response_headers",
            "pattern": "Set-Cookie",
            "fields": ["session_id", "access_token", "user_id"]
          }
        }
      },
      "nextNodeId": "node_18"
    },

    {
      "id": "node_18",
      "type": "DATA_QUERY",
      "name": "ä¿å­˜CK",
      "description": "ä¿å­˜CKåˆ°æ•°æ®åº“",
      "data": {
        "config": {
          "action": "insert",
          "table": "video_account_cookies",
          "data": {
            "userId": "{{context.userId}}",
            "userName": "{{context.userName}}",
            "cookies": "{{context.cookies}}",
            "extractedAt": "{{context.timestamp}}",
            "expiresAt": "{{context.expiresAt}}",
            "status": "active"
          }
        }
      },
      "nextNodeId": "node_19"
    },

    {
      "id": "node_19",
      "type": "VARIABLE_SET",
      "name": "ç”Ÿæˆåˆ†äº«é“¾æ¥",
      "description": "ç”ŸæˆCKçš„ä¸‹è½½å’Œåˆ†äº«é“¾æ¥",
      "data": {
        "config": {
          "generateShareLink": true,
          "linkExpiry": 86400, // 24å°æ—¶
          "requireAuth": true
        }
      },
      "nextNodeId": "node_20"
    },

    {
      "id": "node_20",
      "type": "AI_REPLY",
      "name": "é€šçŸ¥CKæå–æˆåŠŸ",
      "description": "é€šçŸ¥ç”¨æˆ·CKæå–æˆåŠŸï¼Œå‘é€åˆ†äº«é“¾æ¥",
      "data": {
        "config": {
          "modelId": "doubao-pro-4k",
          "replyStrategy": "notify",
          "includeShareLink": true
        }
      },
      "nextNodeId": "node_21"
    },

    // ============ é˜¶æ®µ9ï¼šäººå·¥å®¡æ ¸ ============
    {
      "id": "node_21",
      "type": "TASK_ASSIGN",
      "name": "åˆ›å»ºå®¡æ ¸ä»»åŠ¡",
      "description": "åˆ›å»ºäººå·¥å®¡æ ¸ä»»åŠ¡",
      "data": {
        "config": {
          "taskName": "è§†é¢‘å·åˆè§„æ€§å®¡æ ¸",
          "taskType": "manual_review",
          "priority": "normal",
          "assignTo": "customer_service",
          "dueTime": 86400, // 24å°æ—¶å†…å®¡æ ¸
          "taskData": {
            "userId": "{{context.userId}}",
            "videoAccountId": "{{context.videoAccountId}}",
            "ckId": "{{context.ckId}}"
          }
        }
      },
      "nextNodeId": "node_end"
    },

    // ============ ç»“æŸèŠ‚ç‚¹ ============
    {
      "id": "node_end",
      "type": "END",
      "name": "æµç¨‹ç»“æŸ",
      "description": "è½¬åŒ–æµç¨‹ç»“æŸï¼Œç­‰å¾…äººå·¥å®¡æ ¸",
      "data": {
        "config": {
          "saveStatistics": true
        }
      }
    }
  ]
}
```

---

## ğŸ”§ æŠ€æœ¯å®ç°æ–¹æ¡ˆ

### 1. è·å–è§†é¢‘å·å°åº—äºŒç»´ç 

**æ¥å£**ï¼š
```
GET https://channels.weixin.qq.com/api/get_login_qrcode
```

**å®ç°**ï¼š
```javascript
async function getLatestQrcode() {
  const response = await fetch('https://channels.weixin.qq.com/api/get_login_qrcode', {
    method: 'GET',
    headers: {
      'Authorization': `Bearer ${accessToken}`,
      'Content-Type': 'application/json'
    }
  });

  const data = await response.json();

  return {
    qrCodeId: data.qr_code_id,
    qrCodeUrl: data.qr_code_url,
    expiresAt: data.expires_at
  };
}
```

### 2. æ£€æµ‹ç™»å½•çŠ¶æ€

**æ¥å£**ï¼š
```
POST https://channels.weixin.qq.com/api/check_login_status
```

**å®ç°**ï¼š
```javascript
async function checkLoginStatus(qrCodeId) {
  const maxAttempts = 20;
  const interval = 3000; // 3ç§’

  for (let i = 0; i < maxAttempts; i++) {
    await new Promise(resolve => setTimeout(resolve, interval));

    const response = await fetch('https://channels.weixin.qq.com/api/check_login_status', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${accessToken}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ qr_code_id: qrCodeId })
    });

    const data = await response.json();

    if (data.status === 'success') {
      return {
        success: true,
        cookies: data.cookies,
        userId: data.user_id
      };
    }

    if (data.status === 'failed') {
      return {
        success: false,
        error: 'Login failed'
      };
    }
  }

  return {
    success: false,
    error: 'Timeout'
  };
}
```

### 3. æ£€æµ‹é¡µé¢å¯è®¿é—®æ€§

**è§†é¢‘å·å°åº—é¡µé¢**ï¼š
```javascript
async function checkShopPage(cookies) {
  const response = await fetch('https://channels.weixin.qq.com/shop', {
    method: 'GET',
    headers: {
      'Cookie': cookies
    }
  });

  return {
    accessible: response.ok,
    statusCode: response.status
  };
}
```

**è§†é¢‘å·åŠ©æ‰‹é¡µé¢**ï¼š
```javascript
async function checkAssistantPage(cookies) {
  const response = await fetch('https://channels.weixin.qq.com/assistant', {
    method: 'GET',
    headers: {
      'Cookie': cookies
    }
  });

  return {
    accessible: response.ok,
    statusCode: response.status
  };
}
```

### 4. æå–å’Œä¿å­˜CK

**æå–CK**ï¼š
```javascript
function extractCookies(responseHeaders) {
  const cookies = {};

  // ä»Set-Cookieå¤´æå–
  const setCookie = responseHeaders.get('set-cookie');
  if (setCookie) {
    const cookiePairs = setCookie.split(';');
    cookiePairs.forEach(pair => {
      const [name, value] = pair.split('=');
      if (name && value) {
        cookies[name.trim()] = value.trim();
      }
    });
  }

  return cookies;
}
```

**ä¿å­˜åˆ°æ•°æ®åº“**ï¼š
```javascript
async function saveCookies(userId, cookies) {
  await db.insert(videoAccountCookies).values({
    id: uuidv4(),
    userId,
    cookies: JSON.stringify(cookies),
    extractedAt: new Date(),
    expiresAt: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000), // 30å¤©åè¿‡æœŸ
    status: 'active'
  });
}
```

### 5. ç”Ÿæˆåˆ†äº«é“¾æ¥

```javascript
async function generateShareLink(ckId) {
  const shareToken = generateToken();
  const shareCode = generateShareCode();

  await db.insert(ckShareLinks).values({
    id: uuidv4(),
    ckId,
    shareToken,
    shareCode,
    createdAt: new Date(),
    expiresAt: new Date(Date.now() + 24 * 60 * 60 * 1000), // 24å°æ—¶åè¿‡æœŸ
    status: 'active'
  });

  return {
    downloadLink: `${baseUrl}/api/cookies/${shareToken}/download`,
    shareCode
  };
}
```

### 6. äººå·¥æ£€æµ‹æ¥å£

**å®¢æœäººå·¥æ£€æµ‹æŒ‰é’®**ï¼š
```javascript
// APIç«¯ç‚¹ï¼šPOST /api/video-accounts/:id/check
async function checkVideoAccountCompliance(videoAccountId) {
  // æ£€æµ‹è§†é¢‘å·å°åº—
  const shopCheck = await checkShopPage(cookies);

  // æ£€æµ‹è§†é¢‘å·åŠ©æ‰‹
  const assistantCheck = await checkAssistantPage(cookies);

  // æ£€æµ‹æ˜¯å¦ç¬¦åˆè§„åˆ™
  const complianceResult = await checkComplianceRules(videoAccountId, {
    shopAccessible: shopCheck.accessible,
    assistantAccessible: assistantCheck.accessible
  });

  return {
    videoAccountId,
    shopCheck,
    assistantCheck,
    compliance: complianceResult,
    checkedAt: new Date()
  };
}
```

**è§„åˆ™æ£€æµ‹**ï¼š
```javascript
async function checkComplianceRules(videoAccountId, checks) {
  const rules = [
    {
      name: 'è§†é¢‘å·å°åº—å¯è®¿é—®',
      check: checks.shopAccessible,
      required: true
    },
    {
      name: 'è§†é¢‘å·åŠ©æ‰‹å¯è®¿é—®',
      check: checks.assistantAccessible,
      required: true
    },
    {
      name: 'è§†é¢‘å·åç§°åˆè§„',
      check: await checkAccountName(videoAccountId),
      required: true
    },
    {
      name: 'è§†é¢‘å·å¤´åƒåˆè§„',
      check: await checkAccountAvatar(videoAccountId),
      required: true
    },
    {
      name: 'è§†é¢‘å·ç®€ä»‹åˆè§„',
      check: await checkAccountBio(videoAccountId),
      required: true
    }
  ];

  const passed = rules.filter(r => r.check).length;
  const total = rules.length;

  return {
    passed,
    total,
    passedRate: (passed / total) * 100,
    rules,
    compliant: passed === total
  };
}
```

---

## ğŸ—„ï¸ æ•°æ®åº“è®¾è®¡

### video_account_cookies è¡¨

```sql
CREATE TABLE video_account_cookies (
  id VARCHAR(36) PRIMARY KEY,
  user_id VARCHAR(255) NOT NULL,
  user_name VARCHAR(255),
  video_account_id VARCHAR(255),
  cookies TEXT NOT NULL, -- JSONæ ¼å¼
  extracted_at TIMESTAMP NOT NULL,
  expires_at TIMESTAMP,
  status VARCHAR(50) DEFAULT 'active',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### ck_share_links è¡¨

```sql
CREATE TABLE ck_share_links (
  id VARCHAR(36) PRIMARY KEY,
  ck_id VARCHAR(36) NOT NULL,
  share_token VARCHAR(255) UNIQUE NOT NULL,
  share_code VARCHAR(50) UNIQUE NOT NULL,
  created_at TIMESTAMP NOT NULL,
  expires_at TIMESTAMP,
  status VARCHAR(50) DEFAULT 'active',
  created_by VARCHAR(255),
  download_count INT DEFAULT 0,
  FOREIGN KEY (ck_id) REFERENCES video_account_cookies(id)
);
```

### video_account_compliance_checks è¡¨

```sql
CREATE TABLE video_account_compliance_checks (
  id VARCHAR(36) PRIMARY KEY,
  video_account_id VARCHAR(255) NOT NULL,
  user_id VARCHAR(255),
  checked_by VARCHAR(255), -- å®¢æœäººå‘˜ID
  shop_accessible BOOLEAN,
  assistant_accessible BOOLEAN,
  account_name_compliant BOOLEAN,
  account_avatar_compliant BOOLEAN,
  account_bio_compliant BOOLEAN,
  passed INT,
  total INT,
  passed_rate DECIMAL(5,2),
  compliant BOOLEAN,
  checked_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

---

## ğŸ“Š äººå·¥å®¡æ ¸ç•Œé¢

### å®¢æœå·¥ä½œå°

```javascript
// å®¡æ ¸åˆ—è¡¨
const auditTasks = await db.query(`
  SELECT
    vac.*,
    u.user_name,
    u.user_avatar
  FROM video_account_cookies vac
  JOIN users u ON vac.user_id = u.id
  WHERE vac.status = 'pending_audit'
  ORDER BY vac.extracted_at DESC
`);

// å®¡æ ¸æ“ä½œ
async function approveAudit(ckId) {
  await db.update(video_account_cookies)
    .set({ status: 'approved', reviewedAt: new Date() })
    .where(eq(video_account_cookies.id, ckId));
}

async function rejectAudit(ckId, reason) {
  await db.update(video_account_cookies)
    .set({
      status: 'rejected',
      reviewReason: reason,
      reviewedAt: new Date()
    })
    .where(eq(video_account_cookies.id, ckId));
}

// æ£€æµ‹æŒ‰é’®
async function manualCheck(ckId) {
  const checkResult = await checkVideoAccountCompliance(ckId);
  return checkResult;
}
```

---

## ğŸ¯ æ€»ç»“

### ç³»ç»Ÿèƒ½å®ç°çš„åŠŸèƒ½

âœ… **1. è·å–æœ€æ–°çš„è§†é¢‘å·å°åº—äºŒç»´ç **
- é€šè¿‡APIè°ƒç”¨è·å–
- è‡ªåŠ¨å‘é€ç»™ç”¨æˆ·

âœ… **2. æ£€æµ‹ç™»å½•æˆåŠŸ**
- è½®è¯¢æ£€æµ‹ç™»å½•çŠ¶æ€
- è‡ªåŠ¨é‡è¯•æœºåˆ¶

âœ… **3. æ£€æµ‹é¡µé¢å¯è®¿é—®æ€§**
- æ£€æµ‹è§†é¢‘å·å°åº—é¡µé¢
- æ£€æµ‹è§†é¢‘å·åŠ©æ‰‹é¡µé¢

âœ… **4. æå–å¹¶ä¿å­˜CK**
- è‡ªåŠ¨æå–Cookie
- ä¿å­˜åˆ°æ•°æ®åº“

âœ… **5. ä¸‹è½½å’Œåˆ†äº«CK**
- ç”Ÿæˆä¸‹è½½é“¾æ¥
- ç”Ÿæˆåˆ†äº«ç 
- è®¾ç½®è¿‡æœŸæ—¶é—´

âœ… **6. äººå·¥æ£€æµ‹**
- å®¢æœç‚¹å‡»æŒ‰é’®æ£€æµ‹
- æ£€æµ‹è§†é¢‘å·åˆè§„æ€§
- è§„åˆ™é…ç½®çµæ´»

### æŠ€æœ¯å…³é”®ç‚¹

1. **äºŒç»´ç è·å–**ï¼šè°ƒç”¨å¾®ä¿¡è§†é¢‘å·API
2. **ç™»å½•æ£€æµ‹**ï¼šè½®è¯¢æœºåˆ¶ï¼Œæœ€å¤š20æ¬¡
3. **é¡µé¢æ£€æµ‹**ï¼šHTTPè¯·æ±‚æ£€æµ‹å¯è®¿é—®æ€§
4. **CKæå–**ï¼šä»å“åº”å¤´æå–Cookie
5. **CKç®¡ç†**ï¼šæ•°æ®åº“å­˜å‚¨ï¼Œåˆ†äº«é“¾æ¥ç”Ÿæˆ
6. **äººå·¥å®¡æ ¸**ï¼šä»»åŠ¡ç³»ç»Ÿï¼Œå®¡æ ¸æ“ä½œï¼Œåˆè§„æ€§æ£€æµ‹

è¿™ä¸ªæ–¹æ¡ˆå®Œæ•´è¦†ç›–äº†ä½ ä»¬çš„ä¸šåŠ¡éœ€æ±‚ï¼
