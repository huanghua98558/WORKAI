# æµç¨‹å¼•æ“ä¼˜åŒ–è®¾è®¡æ–¹æ¡ˆ v3.0ï¼ˆåŸºäºç³»ç»Ÿæ¶æ„è”åŠ¨ï¼‰

## ğŸ“‹ æ–‡æ¡£ä¿¡æ¯

- **æ–‡æ¡£ç‰ˆæœ¬**ï¼šv3.0
- **åˆ›å»ºæ—¥æœŸ**ï¼š2025-01-04
- **åŸºäºæ–‡æ¡£**ï¼š
  - æµç¨‹å¼•æ“ä¼˜åŒ–è®¾è®¡æ–¹æ¡ˆ_v2.md
  - æµç¨‹å¼•æ“é›†æˆä¼˜åŒ–æ–¹æ¡ˆ_æœ€ç»ˆç‰ˆ.md
  - æµç¨‹å¼•æ“ç®¡ç†é¡µé¢æµ‹è¯•æŠ¥å‘Š.md
  - èŠ‚ç‚¹æµç¨‹ä¸ç›‘æ§é¢æ¿å®Œæ•´è®¾è®¡æ–‡æ¡£.md
  - AIæ¨¡å—ä¸æµç¨‹å¼•æ“æ¶æ„å…³ç³»åˆ†æ.md
  - è¯æœ¯æ¨¡æ¿åŠŸèƒ½è¯´æ˜æ–‡æ¡£
- **è®¾è®¡åŸåˆ™**ï¼šåŸºäºç³»ç»Ÿæ¶æ„è”åŠ¨ï¼Œå®ç”¨ä¸ºä¸»ï¼Œä¸åšèŠ±æ¶å­

---

## ğŸ¯ ç°æœ‰ç³»ç»Ÿæ¶æ„åˆ†æ

### 1. AIæ¨¡å—ï¼ˆå·²å®ç°ï¼Œå®Œæ•´åº¦99%ï¼‰

#### AIæœåŠ¡æ¶æ„
```
ai.service.js
    â†“
æ„å›¾è¯†åˆ«ï¼ˆrecognizeIntentï¼‰        æœåŠ¡å›å¤ï¼ˆgenerateServiceReplyï¼‰
    â†“                                    â†“
  è±†åŒ…æ¨¡å‹                            è±†åŒ…æ¨¡å‹
(doubao-seed-1-8-251228)          (doubao-seed-1-6-251015)
    â†“                                    â†“
è¿”å›ï¼š{intent, needReply,          è¿”å›ï¼šå›å¤å†…å®¹
      needHuman, confidence}
```

#### AIè§’è‰²ä¸æ¨¡å‹æ˜ å°„
| è§’è‰²ID | è§’è‰²åç§° | æ¨¡å‹ID | æ¨¡å‹åç§° | ç”¨é€” |
|-------|---------|-------|---------|------|
| å”®åå¤„ç† | doubao-pro-32k-service | è±†åŒ…æœåŠ¡å›å¤ | å”®åå®¢æœ |
| è½¬åŒ–å®¢æœ | deepseek-v3-conversion | DeepSeek v3 | è½¬åŒ–å¼•å¯¼ |
| æŠ€æœ¯æ”¯æŒ | deepseek-r1-tech | DeepSeek R1 | æŠ€æœ¯æ”¯æŒ |
| äº§å“å’¨è¯¢ | doubao-pro-32k-service | è±†åŒ…æœåŠ¡å›å¤ | äº§å“å’¨è¯¢ |
| æ„å›¾è¯†åˆ« | doubao-pro-4k-intent | è±†åŒ…æ„å›¾è¯†åˆ« | æ„å›¾è¯†åˆ« |

#### AIæç¤ºè¯é…ç½®
```javascript
// server/config/default-prompts.js
{
  intentRecognition: "æ„å›¾è¯†åˆ«æç¤ºè¯ï¼ˆå®šä¹‰7ç§æ„å›¾ï¼‰",
  serviceReply: "æœåŠ¡å›å¤æç¤ºè¯ï¼ˆä¸“ä¸šå®¢æœå›å¤ï¼‰",
  conversion: "è½¬åŒ–å®¢æœæç¤ºè¯ï¼ˆå¼•å¯¼è´­ä¹°/è½¬åŒ–ï¼‰",
  report: "æŠ¥å‘Šç”Ÿæˆæç¤ºè¯ï¼ˆæ•°æ®åˆ†æï¼‰"
}
```

---

### 2. WorkToolé›†æˆï¼ˆå·²å®ç°ï¼‰

#### æ¶ˆæ¯æ¥æ”¶æµç¨‹
```
WorkRobot æ¶ˆæ¯æ¨é€
    â†“
POST /api/worktool/callback/message
    â†“
ç«‹å³è¿”å› 200ï¼ˆä¸é˜»å¡ï¼‰
    â†“
å¼‚æ­¥å¤„ç†æ¶ˆæ¯ï¼ˆsetImmediateï¼‰
    â†“
message-processing.service.js
    â†“
[å½“å‰] ç›´æ¥è°ƒç”¨AIæœåŠ¡
    â†“
[ä¼˜åŒ–å] è§¦å‘æµç¨‹å¼•æ“
```

#### æœºå™¨äººæŒ‡ä»¤å‘é€
```javascript
// server/services/worktool.service.js
async sendTextMessage(robotId, toName, content, atList = [])
async sendBatchMessages(robotId, messages)
async getRobotInfo(robotId)
```

---

### 3. å‘Šè­¦ç³»ç»Ÿï¼ˆå·²å®ç°ï¼‰

#### å‘Šè­¦è§¦å‘æµç¨‹
```
æ„å›¾è¯†åˆ«ç»“æœ
    â†“
alert-trigger.service.js
    â†“
æ£€æŸ¥å‘Šè­¦è§„åˆ™ï¼ˆalert_rulesè¡¨ï¼‰
    â†“
ç”Ÿæˆå‘Šè­¦å†å²ï¼ˆalert_historyè¡¨ï¼‰
    â†“
æ‰§è¡Œé€šçŸ¥ï¼ˆnotification_methodsè¡¨ï¼‰
```

#### å‘Šè­¦è§„åˆ™é…ç½®
- æ„å›¾ç±»å‹ï¼šriskï¼ˆé£é™©ï¼‰ã€spamï¼ˆåƒåœ¾ä¿¡æ¯ï¼‰
- å‘Šè­¦çº§åˆ«ï¼šcritical, warning, info
- é€šçŸ¥æ–¹å¼ï¼šrobotï¼ˆæœºå™¨äººï¼‰ã€emailã€smsã€wechatã€dingtalkã€feishu

---

### 4. æµç¨‹å¼•æ“ï¼ˆå·²å®ç°99%ï¼‰

#### å½“å‰èŠ‚ç‚¹ç±»å‹
```javascript
const NodeType = {
  START: 'start',              // å¼€å§‹èŠ‚ç‚¹
  END: 'end',                  // ç»“æŸèŠ‚ç‚¹
  CONDITION: 'condition',      // æ¡ä»¶èŠ‚ç‚¹
  AI_CHAT: 'ai_chat',          // AIå¯¹è¯èŠ‚ç‚¹ï¼ˆä½¿ç”¨ai-core.serviceï¼‰
  INTENT: 'intent',            // æ„å›¾è¯†åˆ«èŠ‚ç‚¹ï¼ˆä½¿ç”¨ai-core.serviceï¼‰
  SERVICE: 'service',          // æœåŠ¡èŠ‚ç‚¹ï¼ˆMockï¼‰
  HUMAN_HANDOVER: 'human_handover', // äººå·¥è½¬æ¥èŠ‚ç‚¹ï¼ˆMockï¼‰
  NOTIFICATION: 'notification'  // é€šçŸ¥èŠ‚ç‚¹ï¼ˆMockï¼‰
};
```

#### å½“å‰AIèŠ‚ç‚¹å®ç°

##### AIå¯¹è¯èŠ‚ç‚¹ï¼ˆhandleAIChatNodeï¼‰
```javascript
async handleAIChatNode(node, context) {
  // 1. ä»èŠ‚ç‚¹é…ç½®è·å–å‚æ•°
  const { modelId, roleId, temperature, maxTokens } = node.data;

  // 2. è°ƒç”¨aiCoreService.chat
  const result = await aiCoreService.chat({
    messages: [
      { role: 'system', content: systemPrompt },
      { role: 'user', content: userMessage }
    ],
    modelId,
    roleId,
    sessionId: context.sessionId,
    operationType: 'ai_chat'
  });

  // 3. è¿”å›AIå›å¤
  return {
    success: true,
    aiResponse: result.content,
    context: { ...context, aiResponse: result.content }
  };
}
```

##### æ„å›¾è¯†åˆ«èŠ‚ç‚¹ï¼ˆhandleIntentNodeï¼‰
```javascript
async handleIntentNode(node, context) {
  // 1. è·å–æ”¯æŒçš„æ„å›¾åˆ—è¡¨
  const { supportedIntents } = node.data;

  // 2. æ„å»ºæ„å›¾è¯†åˆ«æç¤ºè¯
  const systemPrompt = `ä½ æ˜¯ä¸€ä¸ªæ„å›¾è¯†åˆ«ä¸“å®¶ã€‚è¯·åˆ†æç”¨æˆ·çš„è¾“å…¥ï¼Œè¯†åˆ«å…¶æ„å›¾ã€‚
å¯ç”¨çš„æ„å›¾åŒ…æ‹¬ï¼š${intentList}
è¯·åªè¿”å›JSONæ ¼å¼...`;

  // 3. è°ƒç”¨aiCoreService.chat
  const result = await aiCoreService.chat({
    messages: [
      { role: 'system', content: systemPrompt },
      { role: 'user', content: userMessage }
    ],
    modelId,
    operationType: 'intent_recognition'
  });

  // 4. è§£ææ„å›¾è¯†åˆ«ç»“æœ
  return {
    success: true,
    intent: detectedIntent,
    confidence,
    context: { ...context, intent: detectedIntent }
  };
}
```

#### å½“å‰å­˜åœ¨çš„é—®é¢˜

**é—®é¢˜1ï¼šAIæœåŠ¡è°ƒç”¨ä¸ç»Ÿä¸€**
- âŒ æµç¨‹å¼•æ“ä½¿ç”¨ `aiCoreService.chat`
- âŒ æ¶ˆæ¯å¤„ç†æœåŠ¡ä½¿ç”¨ `ai.service.js`
- âŒ ä¸¤ä¸ªAIæœåŠ¡æ¥å£ä¸ä¸€è‡´
- âš ï¸  `ai-core.service.js` æœªæ‰¾åˆ°å®šä¹‰

**é—®é¢˜2ï¼šè§’è‰²æœªçœŸæ­£ä½¿ç”¨**
- âŒ AIå¯¹è¯èŠ‚ç‚¹æ”¯æŒroleIdå‚æ•°ï¼Œä½†æœªçœŸæ­£ä½¿ç”¨
- âŒ æ„å›¾è¯†åˆ«èŠ‚ç‚¹æœªä½¿ç”¨è§’è‰²
- âŒ æ— æ³•å®ç°ä¸åŒè§’è‰²ä½¿ç”¨ä¸åŒè¯æœ¯

**é—®é¢˜3ï¼šè¯æœ¯æ¨¡æ¿æœªä½¿ç”¨**
- âŒ æ•°æ®åº“ä¸­æœ‰ `prompt_templates` å’Œ `prompt_category_templates` è¡¨
- âŒ AIæœåŠ¡ä½¿ç”¨ç¡¬ç¼–ç çš„ `default-prompts.js`
- âŒ æ— æ³•å®ç°è¯æœ¯æ¨¡æ¿çš„åŠ¨æ€åŠ è½½

**é—®é¢˜4ï¼šæœåŠ¡èŠ‚ç‚¹ã€äººå·¥è½¬æ¥èŠ‚ç‚¹ã€é€šçŸ¥èŠ‚ç‚¹éƒ½æ˜¯Mock**
- âŒ handleServiceNode - Mockå®ç°
- âŒ handleHumanHandoverNode - Mockå®ç°
- âŒ handleNotificationNode - Mockå®ç°
- âš ï¸ è¿™äº›åŠŸèƒ½å®é™…ä¸Šå·²ç»åœ¨æ¶ˆæ¯å¤„ç†æœåŠ¡ä¸­å®ç°ï¼Œä½†æµç¨‹å¼•æ“æœªå¯¹æ¥

**é—®é¢˜5ï¼šæµç¨‹å¼•æ“ä¸æ¶ˆæ¯å¤„ç†æœåŠ¡åˆ†ç¦»**
- âŒ æ¶ˆæ¯å¤„ç†æœåŠ¡ç›´æ¥è°ƒç”¨AIæœåŠ¡
- âŒ æµç¨‹å¼•æ“ç‹¬ç«‹è¿è¡Œï¼Œä¸æ¶ˆæ¯å¤„ç†æœåŠ¡æ— è”åŠ¨
- âš ï¸ ä¸¤ä¸ªç³»ç»Ÿå¹¶è¡Œå­˜åœ¨ï¼ŒåŠŸèƒ½é‡å¤

---

### 5. åŒç›‘æ§é¢æ¿ï¼ˆå·²å®ç°ï¼‰

#### ç›‘æ§é¢æ¿1ï¼šä¸šåŠ¡æ¶ˆæ¯ç›‘æ§
- ç”¨æˆ·æ¶ˆæ¯åˆ—è¡¨
- æœºå™¨äººå›å¤åˆ—è¡¨
- æ‰§è¡ŒçŠ¶æ€æ˜¾ç¤º
- ç­›é€‰å’Œæœç´¢

#### ç›‘æ§é¢æ¿2ï¼šAIäº¤äº’ç›‘æ§
- å®Œæ•´æ‰§è¡Œé“¾è·¯ï¼ˆæ—¶é—´çº¿ï¼‰
- AIè¾“å…¥è¾“å‡ºæŸ¥çœ‹
- æ€§èƒ½ç»Ÿè®¡
- è°ƒè¯•å·¥å…·

#### WebSocketå®æ—¶æ¨é€
- å®æ—¶æ¨é€æ¶ˆæ¯å¤„ç†çŠ¶æ€
- å®æ—¶æ¨é€AIäº¤äº’æ•°æ®
- å®æ—¶æ›´æ–°ç›‘æ§é¢æ¿

---

## ğŸ¯ æ ¸å¿ƒé—®é¢˜æ€»ç»“

### é—®é¢˜1ï¼šAIæœåŠ¡è°ƒç”¨ä¸ç»Ÿä¸€

**ç°çŠ¶**ï¼š
- æµç¨‹å¼•æ“ï¼š`aiCoreService.chat`ï¼ˆæœªå®šä¹‰ï¼‰
- æ¶ˆæ¯å¤„ç†æœåŠ¡ï¼š`ai.service.js`ï¼ˆå·²å®ç°ï¼‰
- ä¸¤ä¸ªæ¥å£ä¸ä¸€è‡´

**å½±å“**ï¼š
- æµç¨‹å¼•æ“æ— æ³•çœŸæ­£è°ƒç”¨AIæœåŠ¡
- AIèŠ‚ç‚¹åŠŸèƒ½å—é™

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. ç»Ÿä¸€ä½¿ç”¨ `AIServiceFactory.createServiceByModelId()`
2. æµç¨‹å¼•æ“AIèŠ‚ç‚¹è°ƒç”¨çœŸå®çš„AIæœåŠ¡

---

### é—®é¢˜2ï¼šè§’è‰²ç³»ç»Ÿæœªæ•´åˆ

**ç°çŠ¶**ï¼š
- æ•°æ®åº“æœ‰7ä¸ªé¢„è®¾è§’è‰²
- AIèŠ‚ç‚¹æ”¯æŒroleIdå‚æ•°ä½†æœªä½¿ç”¨
- æ— æ³•å®ç°è§’è‰²çº§åˆ«çš„è¯æœ¯å·®å¼‚åŒ–

**å½±å“**ï¼š
- æ‰€æœ‰è§’è‰²ä½¿ç”¨ç›¸åŒè¯æœ¯
- æ— æ³•å‘æŒ¥è§’è‰²ç³»ç»Ÿçš„ä»·å€¼

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. AIå¯¹è¯èŠ‚ç‚¹æ ¹æ®roleIdåŠ è½½è§’è‰²çš„systemPrompt
2. æ„å›¾è¯†åˆ«èŠ‚ç‚¹æ”¯æŒä½¿ç”¨ä¸åŒè§’è‰²
3. å®ç°è§’è‰²çº§åˆ«çš„ä¸ªæ€§åŒ–å›å¤

---

### é—®é¢˜3ï¼šè¯æœ¯æ¨¡æ¿æœªä½¿ç”¨

**ç°çŠ¶**ï¼š
- æ•°æ®åº“æœ‰è¯æœ¯æ¨¡æ¿è¡¨ä½†æœªä½¿ç”¨
- AIæœåŠ¡ä½¿ç”¨ç¡¬ç¼–ç æç¤ºè¯
- æ— æ³•åŠ¨æ€è°ƒæ•´è¯æœ¯

**å½±å“**ï¼š
- ä¿®æ”¹è¯æœ¯éœ€è¦é‡å¯æœåŠ¡
- æ— æ³•å¿«é€Ÿè¿­ä»£è¯æœ¯
- æ— æ³•A/Bæµ‹è¯•ä¸åŒè¯æœ¯

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. AIå¯¹è¯èŠ‚ç‚¹ä»æ•°æ®åº“åŠ è½½è¯æœ¯æ¨¡æ¿
2. æ”¯æŒæ¨¡æ¿å˜é‡æ›¿æ¢
3. å®ç°è¯æœ¯æ¨¡æ¿çš„ç¼“å­˜æœºåˆ¶

---

### é—®é¢˜4ï¼šæµç¨‹å¼•æ“ä¸æ¶ˆæ¯å¤„ç†æœåŠ¡åˆ†ç¦»

**ç°çŠ¶**ï¼š
- æ¶ˆæ¯å¤„ç†æœåŠ¡ç‹¬ç«‹è¿è¡Œ
- æµç¨‹å¼•æ“ç‹¬ç«‹è¿è¡Œ
- ä¸¤ä¸ªç³»ç»ŸåŠŸèƒ½é‡å¤

**å½±å“**ï¼š
- ä»£ç é‡å¤
- ç»´æŠ¤æˆæœ¬é«˜
- åŠŸèƒ½ä¸ä¸€è‡´

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æ¶ˆæ¯å¤„ç†æœåŠ¡è°ƒç”¨æµç¨‹å¼•æ“
2. æµç¨‹å¼•æ“ç¼–æ’æ•´ä¸ªæ¶ˆæ¯å¤„ç†æµç¨‹
3. ç»Ÿä¸€çš„æ•°æ®è®°å½•å’Œç›‘æ§

---

## ğŸš€ ä¼˜åŒ–è®¾è®¡æ–¹æ¡ˆ

### æ–¹æ¡ˆæ€»è§ˆ

```
WorkRobot æ¶ˆæ¯
    â†“
POST /api/worktool/callback/message
    â†“
ç«‹å³è¿”å› 200ï¼ˆä¸é˜»å¡ï¼‰
    â†“
æ¶ˆæ¯å¤„ç†æœåŠ¡ï¼ˆmessage-processing.service.jsï¼‰
    â†“
åˆ›å»ºæµç¨‹å®ä¾‹ï¼ˆæµç¨‹å¼•æ“ï¼‰
    â†“
æ‰§è¡Œæµç¨‹å®šä¹‰
    â†“
[èŠ‚ç‚¹1] æ¶ˆæ¯æ¥æ”¶ä¸æ•°æ®åº“ä¿å­˜
    â†“
[èŠ‚ç‚¹2] æ„å›¾è¯†åˆ«ï¼ˆè°ƒç”¨ai.service.jsï¼‰
    â†“
[èŠ‚ç‚¹3] å†³ç­–èŠ‚ç‚¹ï¼ˆæ ¹æ®æ„å›¾åˆ†å‘ï¼‰
    â†“
    â”œâ”€ [è·¯å¾„A] æ ‡å‡†å›å¤
    â”‚   â†“
    â”‚   [èŠ‚ç‚¹4A] AIå®¢æœå›å¤ï¼ˆä½¿ç”¨è§’è‰²è¯æœ¯ï¼‰
    â”‚   â†“
    â”‚   [èŠ‚ç‚¹5A] æ¶ˆæ¯åˆ†å‘åˆ¤æ–­
    â”‚   â†“
    â”‚   [èŠ‚ç‚¹6A] å‘é€æœºå™¨äººæŒ‡ä»¤
    â”‚   â†“
    â”‚   [èŠ‚ç‚¹7A] æŒ‡ä»¤çŠ¶æ€è®°å½•
    â”‚   â†“
    â”‚   [èŠ‚ç‚¹8A] ç»“æŸ
    â”‚
    â”œâ”€ [è·¯å¾„B] å‘Šè­¦å¤„ç†
    â”‚   â†“
    â”‚   [èŠ‚ç‚¹4B] å‘Šè­¦å…¥åº“
    â”‚   â†“
    â”‚   [èŠ‚ç‚¹5B] å‘Šè­¦è§„åˆ™åˆ¤æ–­
    â”‚   â†“
    â”‚   [èŠ‚ç‚¹6B] æ‰§è¡Œé€šçŸ¥
    â”‚   â†“
    â”‚   [èŠ‚ç‚¹8A] ç»“æŸ
    â”‚
    â””â”€ [è·¯å¾„C] è·³è¿‡
        â†“
        [èŠ‚ç‚¹8A] ç»“æŸ
```

---

### ä¼˜åŒ–1ï¼šç»Ÿä¸€AIæœåŠ¡è°ƒç”¨

#### ç›®æ ‡
æµç¨‹å¼•æ“çš„AIèŠ‚ç‚¹ä½¿ç”¨ç»Ÿä¸€çš„AIæœåŠ¡æ¥å£

#### å®ç°æ–¹æ¡ˆ

**æ­¥éª¤1ï¼šç§»é™¤aiCoreServiceä¾èµ–**

```javascript
// âŒ åˆ é™¤
const { aiCoreService } = require('./ai-core.service');

// âœ… ä½¿ç”¨AIServiceFactory
const AIServiceFactory = require('./ai/AIServiceFactory');
```

**æ­¥éª¤2ï¼šä¿®æ”¹AIå¯¹è¯èŠ‚ç‚¹**

```javascript
async handleAIChatNode(node, context) {
  logger.info('æ‰§è¡ŒAIå¯¹è¯èŠ‚ç‚¹', { node, context });

  const { data } = node;
  const { modelId, roleId, temperature, maxTokens, useRolePrompt } = data || {};

  try {
    // 1. è·å–AIæœåŠ¡å®ä¾‹
    const aiService = await AIServiceFactory.createServiceByModelId(modelId);

    // 2. æ„å»ºæ¶ˆæ¯
    const messages = [];
    let systemPrompt = '';

    // 3. å¦‚æœä½¿ç”¨è§’è‰²æç¤ºè¯ï¼Œä»æ•°æ®åº“åŠ è½½
    if (useRolePrompt && roleId) {
      const role = await this.getRoleById(roleId);
      if (role) {
        systemPrompt = role.systemPrompt;
        logger.info('ä½¿ç”¨è§’è‰²æç¤ºè¯', { roleId, roleName: role.name });
      }
    }

    // å¦‚æœæ²¡æœ‰è§’è‰²æç¤ºè¯ï¼Œä½¿ç”¨é»˜è®¤æç¤ºè¯
    if (!systemPrompt) {
      systemPrompt = 'ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„å®¢æœåŠ©æ‰‹ï¼Œè¯·æ ¹æ®ç”¨æˆ·çš„é—®é¢˜ç”Ÿæˆå‹å¥½çš„å›å¤ã€‚';
      messages.push({ role: 'system', content: systemPrompt });
    }

    // 4. æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
    if (context.message && context.message.spoken) {
      messages.push({ role: 'user', content: context.message.spoken });
    } else if (context.userMessage) {
      messages.push({ role: 'user', content: context.userMessage });
    }

    // 5. è°ƒç”¨AIæœåŠ¡ç”Ÿæˆå›å¤
    const result = await aiService.generateReply(messages, {
      sessionId: context.sessionId,
      operationType: 'ai_chat',
      temperature: temperature || 0.7,
      maxTokens: maxTokens || 2000
    });

    logger.info('AIå¯¹è¯èŠ‚ç‚¹æ‰§è¡ŒæˆåŠŸ', {
      model: modelId,
      responseLength: result.content.length,
      usage: result.usage
    });

    // 6. è®°å½•AI IOæ—¥å¿—
    await this.saveAILog(context.sessionId, context.messageId, {
      operationType: 'ai_chat',
      aiInput: JSON.stringify(messages),
      aiOutput: result.content,
      modelId,
      requestDuration: result.usage?.duration || 0,
      status: 'success'
    });

    return {
      success: true,
      aiResponse: result.content,
      model: modelId,
      usage: result.usage,
      context: {
        ...context,
        aiResponse: result.content,
        lastNodeType: 'ai_chat'
      }
    };
  } catch (error) {
    logger.error('AIå¯¹è¯èŠ‚ç‚¹æ‰§è¡Œå¤±è´¥', {
      error: error.message,
      node: node.id
    });

    return {
      success: false,
      aiResponse: 'æŠ±æ­‰ï¼ŒAIæœåŠ¡æš‚æ—¶ä¸å¯ç”¨ã€‚',
      error: error.message,
      context: {
        ...context,
        aiResponse: 'æŠ±æ­‰ï¼ŒAIæœåŠ¡æš‚æ—¶ä¸å¯ç”¨ã€‚',
        lastNodeType: 'ai_chat'
      }
    };
  }
}

// è¾…åŠ©æ–¹æ³•ï¼šè·å–è§’è‰²
async getRoleById(roleId) {
  const db = await this.getDb();
  const { aiRoles } = require('../database/schema');

  const roles = await db.select().from(aiRoles).where(eq(aiRoles.id, roleId)).limit(1);
  return roles[0] || null;
}

// è¾…åŠ©æ–¹æ³•ï¼šä¿å­˜AI IOæ—¥å¿—
async saveAILog(sessionId, messageId, logData) {
  const db = await this.getDb();
  const { aiIoLogs } = require('../database/schema');

  await db.insert(aiIoLogs).values({
    sessionId,
    messageId,
    robotId: logData.robotId || context.robotId,
    robotName: logData.robotName || context.robotName,
    operationType: logData.operationType,
    aiInput: logData.aiInput,
    aiOutput: logData.aiOutput,
    modelId: logData.modelId,
    requestDuration: logData.requestDuration,
    status: logData.status,
    errorMessage: logData.errorMessage,
    createdAt: new Date()
  });
}
```

**æ­¥éª¤3ï¼šä¿®æ”¹æ„å›¾è¯†åˆ«èŠ‚ç‚¹**

```javascript
async handleIntentNode(node, context) {
  logger.info('æ‰§è¡Œæ„å›¾è¯†åˆ«èŠ‚ç‚¹', { node, context });

  const { data } = node;
  const { supportedIntents, modelId, useBuiltinModel } = data || {};

  // å¦‚æœcontextä¸­å·²ç»æœ‰intentï¼Œç›´æ¥è¿”å›
  if (context.intent) {
    logger.info('æ„å›¾å·²å­˜åœ¨äºcontextä¸­', { intent: context.intent });
    return {
      success: true,
      intent: context.intent,
      confidence: 100,
      context: {
        ...context,
        lastNodeType: 'intent'
      }
    };
  }

  try {
    // 1. è·å–ç”¨æˆ·æ¶ˆæ¯
    const userMessage = context.message?.spoken || context.userMessage;

    if (!userMessage) {
      logger.warn('æ„å›¾è¯†åˆ«èŠ‚ç‚¹æ²¡æœ‰å¯ç”¨çš„æ¶ˆæ¯', { context });
      return {
        success: true,
        intent: 'chat',
        confidence: 50,
        context: {
          ...context,
          intent: 'chat',
          lastNodeType: 'intent'
        }
      };
    }

    // 2. è·å–AIæœåŠ¡å®ä¾‹
    const aiService = await AIServiceFactory.createServiceByModelId(modelId);

    // 3. è°ƒç”¨æ„å›¾è¯†åˆ«
    const result = await aiService.recognizeIntent(userMessage, {
      userId: context.userId,
      userName: context.userName,
      groupId: context.groupId,
      groupName: context.groupName,
      sessionId: context.sessionId,
      messageId: context.messageId,
      robotId: context.robotId,
      robotName: context.robotName,
      history: context.history || []
    });

    logger.info('æ„å›¾è¯†åˆ«èŠ‚ç‚¹æ‰§è¡ŒæˆåŠŸ', {
      intent: result.intent,
      confidence: result.confidence,
      needReply: result.needReply,
      needHuman: result.needHuman,
      userMessage: userMessage.substring(0, 50)
    });

    // 4. æ›´æ–°ä¸Šä¸‹æ–‡
    return {
      success: true,
      intent: result.intent,
      confidence: result.confidence,
      needReply: result.needReply,
      needHuman: result.needHuman,
      reason: result.reason,
      context: {
        ...context,
        intent: result.intent,
        needReply: result.needReply,
        needHuman: result.needHuman,
        lastNodeType: 'intent'
      }
    };
  } catch (error) {
    logger.error('æ„å›¾è¯†åˆ«èŠ‚ç‚¹æ‰§è¡Œå¤±è´¥', {
      error: error.message,
      node: node.id
    });

    // è¿”å›é»˜è®¤æ„å›¾ï¼Œé¿å…ä¸­æ–­æµç¨‹
    return {
      success: false,
      intent: 'chat',
      confidence: 50,
      error: error.message,
      context: {
        ...context,
        intent: 'chat',
        lastNodeType: 'intent'
      }
    };
  }
}
```

---

### ä¼˜åŒ–2ï¼šæ•´åˆè§’è‰²ç³»ç»Ÿ

#### ç›®æ ‡
æµç¨‹å¼•æ“çš„AIèŠ‚ç‚¹æ”¯æŒä½¿ç”¨ä¸åŒçš„è§’è‰²ï¼Œå®ç°è§’è‰²çº§åˆ«çš„è¯æœ¯å·®å¼‚åŒ–

#### å®ç°æ–¹æ¡ˆ

**æ­¥éª¤1ï¼šåœ¨AIå¯¹è¯èŠ‚ç‚¹æ”¯æŒroleId**

```javascript
// èŠ‚ç‚¹é…ç½®ç¤ºä¾‹
{
  id: 'node-ai-chat',
  type: 'ai_chat',
  data: {
    modelId: 'f038886b-d042-4aca-9a6f-d1b3049290cc', // è±†åŒ…æœåŠ¡å›å¤æ¨¡å‹
    roleId: '1790fcb4-2d5a-4984-8018-09ab1ee77c31', // å”®åå¤„ç†è§’è‰²
    useRolePrompt: true,  // ä½¿ç”¨è§’è‰²çš„systemPrompt
    temperature: 0.7,
    maxTokens: 2000
  }
}
```

**æ­¥éª¤2ï¼šåŠ è½½è§’è‰²çš„systemPrompt**

```javascript
async handleAIChatNode(node, context) {
  // ... å‰é¢ä»£ç 

  // å¦‚æœä½¿ç”¨è§’è‰²æç¤ºè¯ï¼Œä»æ•°æ®åº“åŠ è½½
  if (useRolePrompt && roleId) {
    const role = await this.getRoleById(roleId);
    if (role) {
      systemPrompt = role.systemPrompt;
      logger.info('ä½¿ç”¨è§’è‰²æç¤ºè¯', { roleId, roleName: role.name });
    } else {
      logger.warn('è§’è‰²ä¸å­˜åœ¨ï¼Œä½¿ç”¨é»˜è®¤æç¤ºè¯', { roleId });
    }
  }

  // ... åé¢ä»£ç 
}
```

**æ­¥éª¤3ï¼šæ”¯æŒæ ¹æ®æ„å›¾è‡ªåŠ¨é€‰æ‹©è§’è‰²**

```javascript
// æ¡ä»¶èŠ‚ç‚¹é…ç½®
{
  id: 'node-intent',
  type: 'intent',
  data: {
    modelId: '45d2b7c7-40ef-4f1e-bed8-c133168f8255'
  }
}

// æ„å›¾è¯†åˆ«èŠ‚ç‚¹ä¹‹åçš„æ¡ä»¶èŠ‚ç‚¹
{
  id: 'node-condition',
  type: 'condition',
  data: {
    condition: 'context.intent === "service"',
    trueNodeId: 'node-service-reply',  // æœåŠ¡å›å¤èŠ‚ç‚¹
    falseNodeId: 'node-default-reply' // é»˜è®¤å›å¤èŠ‚ç‚¹
  }
}

// æœåŠ¡å›å¤èŠ‚ç‚¹ï¼ˆä½¿ç”¨å”®åå¤„ç†è§’è‰²ï¼‰
{
  id: 'node-service-reply',
  type: 'ai_chat',
  data: {
    modelId: 'f038886b-d042-4aca-9a6f-d1b3049290cc',
    roleId: '1790fcb4-2d5a-4984-8018-09ab1ee77c31', // å”®åå¤„ç†è§’è‰²
    useRolePrompt: true
  }
}

// é»˜è®¤å›å¤èŠ‚ç‚¹ï¼ˆä½¿ç”¨é€šç”¨è§’è‰²ï¼‰
{
  id: 'node-default-reply',
  type: 'ai_chat',
  data: {
    modelId: 'f038886b-d042-4aca-9a6f-d1b3049290cc',
    roleId: 'default-role-id',  // é»˜è®¤è§’è‰²
    useRolePrompt: true
  }
}
```

---

### ä¼˜åŒ–3ï¼šå¯¹æ¥è¯æœ¯æ¨¡æ¿

#### ç›®æ ‡
æµç¨‹å¼•æ“çš„AIèŠ‚ç‚¹æ”¯æŒä»æ•°æ®åº“åŠ è½½è¯æœ¯æ¨¡æ¿ï¼Œå®ç°è¯æœ¯åŠ¨æ€ç®¡ç†

#### å®ç°æ–¹æ¡ˆ

**æ­¥éª¤1ï¼šåœ¨AIå¯¹è¯èŠ‚ç‚¹æ”¯æŒæ¨¡æ¿ID**

```javascript
// èŠ‚ç‚¹é…ç½®ç¤ºä¾‹
{
  id: 'node-ai-chat',
  type: 'ai_chat',
  data: {
    modelId: 'f038886b-d042-4aca-9a6f-d1b3049290cc',
    templateId: 'template-123',  // è¯æœ¯æ¨¡æ¿ID
    variables: {  // æ¨¡æ¿å˜é‡
      userName: '{{userName}}',
      groupName: '{{groupName}}'
    },
    useTemplate: true
  }
}
```

**æ­¥éª¤2ï¼šä»æ•°æ®åº“åŠ è½½è¯æœ¯æ¨¡æ¿**

```javascript
async handleAIChatNode(node, context) {
  // ... å‰é¢ä»£ç 

  // å¦‚æœä½¿ç”¨æ¨¡æ¿ï¼Œä»æ•°æ®åº“åŠ è½½
  if (useTemplate && templateId) {
    const template = await this.getTemplateById(templateId);
    if (template) {
      systemPrompt = template.template;

      // æ›¿æ¢æ¨¡æ¿å˜é‡
      systemPrompt = this.replaceTemplateVariables(systemPrompt, {
        userName: context.userName || 'ç”¨æˆ·',
        groupName: context.groupName || 'ç¾¤ç»„',
        robotName: context.robotName || 'æœºå™¨äºº',
        ...variables
      });

      logger.info('ä½¿ç”¨è¯æœ¯æ¨¡æ¿', { templateId, templateName: template.name });
    } else {
      logger.warn('è¯æœ¯æ¨¡æ¿ä¸å­˜åœ¨ï¼Œä½¿ç”¨è§’è‰²æç¤ºè¯', { templateId });
    }
  }

  // å¦‚æœä½¿ç”¨è§’è‰²æç¤ºè¯
  else if (useRolePrompt && roleId) {
    const role = await this.getRoleById(roleId);
    if (role) {
      systemPrompt = role.systemPrompt;
      logger.info('ä½¿ç”¨è§’è‰²æç¤ºè¯', { roleId, roleName: role.name });
    }
  }

  // ... åé¢ä»£ç 
}

// è¾…åŠ©æ–¹æ³•ï¼šè·å–æ¨¡æ¿
async getTemplateById(templateId) {
  const db = await this.getDb();
  const { promptTemplates } = require('../database/schema');

  const templates = await db.select()
    .from(promptTemplates)
    .where(eq(promptTemplates.id, templateId))
    .limit(1);

  return templates[0] || null;
}

// è¾…åŠ©æ–¹æ³•ï¼šæ›¿æ¢æ¨¡æ¿å˜é‡
replaceTemplateVariables(template, variables) {
  let result = template;
  for (const [key, value] of Object.entries(variables)) {
    const regex = new RegExp(`{{${key}}}`, 'g');
    result = result.replace(regex, value);
  }
  return result;
}
```

**æ­¥éª¤3ï¼šæ·»åŠ æ¨¡æ¿ç¼“å­˜**

```javascript
class FlowEngine {
  constructor() {
    // ... å…¶ä»–ä»£ç 

    // æ¨¡æ¿ç¼“å­˜
    this.templateCache = new Map();
    this.templateCacheExpire = 5 * 60 * 1000; // 5åˆ†é’Ÿè¿‡æœŸ
  }

  // è·å–æ¨¡æ¿ï¼ˆå¸¦ç¼“å­˜ï¼‰
  async getTemplateById(templateId) {
    const now = Date.now();

    // æ£€æŸ¥ç¼“å­˜
    const cached = this.templateCache.get(templateId);
    if (cached && now - cached.timestamp < this.templateCacheExpire) {
      return cached.data;
    }

    // ä»æ•°æ®åº“åŠ è½½
    const db = await this.getDb();
    const { promptTemplates } = require('../database/schema');

    const templates = await db.select()
      .from(promptTemplates)
      .where(eq(promptTemplates.id, templateId))
      .limit(1);

    const template = templates[0] || null;

    // ç¼“å­˜
    if (template) {
      this.templateCache.set(templateId, {
        data: template,
        timestamp: now
      });
    }

    return template;
  }

  // æ¸…é™¤æ¨¡æ¿ç¼“å­˜
  clearTemplateCache(templateId) {
    if (templateId) {
      this.templateCache.delete(templateId);
    } else {
      this.templateCache.clear();
    }
  }
}
```

---

### ä¼˜åŒ–4ï¼šå®ç°çœŸå®çš„èŠ‚ç‚¹åŠŸèƒ½

#### ç›®æ ‡
å°†æµç¨‹å¼•æ“çš„MockèŠ‚ç‚¹æ›¿æ¢ä¸ºçœŸå®çš„å®ç°ï¼Œå¯¹æ¥å·²æœ‰æœåŠ¡

#### 4.1 æœåŠ¡èŠ‚ç‚¹ï¼ˆå¯¹æ¥AIæœåŠ¡ï¼‰

```javascript
async handleServiceNode(node, context) {
  logger.info('æ‰§è¡ŒæœåŠ¡èŠ‚ç‚¹', { node, context });

  const { data } = node;
  const { serviceName, parameters } = data || {};

  try {
    let result;

    // æ ¹æ®serviceNameè°ƒç”¨ä¸åŒçš„æœåŠ¡
    switch (serviceName) {
      case 'intent_recognition':
        // æ„å›¾è¯†åˆ«
        const aiService = await AIServiceFactory.createServiceByModelId(parameters.modelId);
        result = await aiService.recognizeIntent(parameters.message, parameters.context);
        break;

      case 'service_reply':
        // æœåŠ¡å›å¤
        const replyService = await AIServiceFactory.createServiceByModelId(parameters.modelId);
        result = await replyService.generateReply(parameters.messages, parameters.options);
        break;

      case 'conversion_reply':
        // è½¬åŒ–å®¢æœå›å¤
        const conversionService = await AIServiceFactory.createServiceByModelId(parameters.modelId);
        result = await conversionService.generateReply(parameters.messages, parameters.options);
        break;

      default:
        throw new Error(`æœªçŸ¥çš„æœåŠ¡: ${serviceName}`);
    }

    logger.info('æœåŠ¡èŠ‚ç‚¹æ‰§è¡ŒæˆåŠŸ', { serviceName, result });

    return {
      success: true,
      serviceResult: result,
      context: {
        ...context,
        lastNodeType: 'service',
        serviceResult: result
      }
    };
  } catch (error) {
    logger.error('æœåŠ¡èŠ‚ç‚¹æ‰§è¡Œå¤±è´¥', {
      serviceName,
      error: error.message
    });

    return {
      success: false,
      serviceResult: null,
      error: error.message,
      context: {
        ...context,
        lastNodeType: 'service',
        serviceError: error.message
      }
    };
  }
}
```

---

#### 4.2 äººå·¥è½¬æ¥èŠ‚ç‚¹ï¼ˆå¯¹æ¥ä¼šè¯ç®¡ç†ï¼‰

```javascript
async handleHumanHandoverNode(node, context) {
  logger.info('æ‰§è¡Œäººå·¥è½¬æ¥èŠ‚ç‚¹', { node, context });

  const { data } = node;
  const { targetUser, message, sessionId } = data || {};

  try {
    const db = await this.getDb();
    const { sessions } = require('../database/schema');

    // æ›´æ–°ä¼šè¯çŠ¶æ€ä¸ºäººå·¥å¤„ç†
    await db.update(sessions)
      .set({
        status: 'human',
        humanReason: message || 'æµç¨‹å¼•æ“è½¬äººå·¥',
        humanTime: new Date().toISOString(),
        updatedAt: new Date()
      })
      .where(eq(sessions.sessionId, sessionId || context.sessionId));

    logger.info('äººå·¥è½¬æ¥æˆåŠŸ', { sessionId, targetUser });

    return {
      success: true,
      handoverResult: {
        targetUser: targetUser || 'admin',
        status: 'transferred',
        message: message || 'å·²è½¬æ¥åˆ°äººå·¥å®¢æœ',
        timestamp: new Date().toISOString()
      },
      context: {
        ...context,
        lastNodeType: 'human_handover',
        isHuman: true,
        handoverResult: {
          targetUser: targetUser || 'admin',
          status: 'transferred'
        }
      }
    };
  } catch (error) {
    logger.error('äººå·¥è½¬æ¥èŠ‚ç‚¹æ‰§è¡Œå¤±è´¥', {
      error: error.message
    });

    return {
      success: false,
      handoverResult: null,
      error: error.message,
      context: {
        ...context,
        lastNodeType: 'human_handover',
        handoverError: error.message
      }
    };
  }
}
```

---

#### 4.3 é€šçŸ¥èŠ‚ç‚¹ï¼ˆå¯¹æ¥å‘Šè­¦ç³»ç»Ÿï¼‰

```javascript
async handleNotificationNode(node, context) {
  logger.info('æ‰§è¡Œé€šçŸ¥èŠ‚ç‚¹', { node, context });

  const { data } = node;
  const { notificationType, recipients, message, alertLevel } = data || {};

  try {
    // å¦‚æœæ˜¯å‘Šè­¦é€šçŸ¥ï¼Œä½¿ç”¨alert-triggeræœåŠ¡
    if (notificationType === 'alert') {
      const alertTriggerService = require('./alert-trigger.service');

      const alertResult = await alertTriggerService.triggerAlert({
        sessionId: context.sessionId,
        intentType: context.intent,
        intent: context.intent,
        userId: context.userId,
        userName: context.userName,
        groupId: context.groupId,
        groupName: context.groupName,
        messageContent: context.message?.spoken || context.userMessage,
        robotId: context.robotId,
        robotName: context.robotName
      });

      logger.info('å‘Šè­¦é€šçŸ¥æ‰§è¡ŒæˆåŠŸ', { alertId: alertResult.id });

      return {
        success: true,
        notificationResult: alertResult,
        context: {
          ...context,
          lastNodeType: 'notification',
          alertResult
        }
      };
    }

    // å¦‚æœæ˜¯æœºå™¨äººé€šçŸ¥ï¼Œä½¿ç”¨worktoolæœåŠ¡
    else if (notificationType === 'robot') {
      const worktoolService = require('./worktool.service');

      for (const recipient of recipients) {
        await worktoolService.sendTextMessage(context.robotId, recipient, message);
      }

      logger.info('æœºå™¨äººé€šçŸ¥æ‰§è¡ŒæˆåŠŸ', { recipientCount: recipients.length });

      return {
        success: true,
        notificationResult: {
          type: 'robot',
          recipients,
          message,
          status: 'sent',
          timestamp: new Date().toISOString()
        },
        context: {
          ...context,
          lastNodeType: 'notification',
          notificationResult: {
            type: 'robot',
            status: 'sent'
          }
        }
      };
    }

    // å…¶ä»–é€šçŸ¥ç±»å‹
    else {
      logger.warn('æš‚ä¸æ”¯æŒçš„é€šçŸ¥ç±»å‹', { notificationType });

      return {
        success: false,
        notificationResult: null,
        error: `æš‚ä¸æ”¯æŒçš„é€šçŸ¥ç±»å‹: ${notificationType}`,
        context: {
          ...context,
          lastNodeType: 'notification',
          notificationError: `æš‚ä¸æ”¯æŒçš„é€šçŸ¥ç±»å‹: ${notificationType}`
        }
      };
    }
  } catch (error) {
    logger.error('é€šçŸ¥èŠ‚ç‚¹æ‰§è¡Œå¤±è´¥', {
      error: error.message
    });

    return {
      success: false,
      notificationResult: null,
      error: error.message,
      context: {
        ...context,
        lastNodeType: 'notification',
        notificationError: error.message
      }
    };
  }
}
```

---

### ä¼˜åŒ–5ï¼šæ¶ˆæ¯å¤„ç†æœåŠ¡è°ƒç”¨æµç¨‹å¼•æ“

#### ç›®æ ‡
æ¶ˆæ¯å¤„ç†æœåŠ¡ä¸å†ç›´æ¥è°ƒç”¨AIæœåŠ¡ï¼Œè€Œæ˜¯è§¦å‘æµç¨‹å¼•æ“æ‰§è¡Œ

#### å®ç°æ–¹æ¡ˆ

**æ­¥éª¤1ï¼šä¿®æ”¹æ¶ˆæ¯å¤„ç†æœåŠ¡**

```javascript
// server/services/message-processing.service.js

async processMessage(messageData, robot) {
  const startTime = Date.now();
  const messageContent = messageData.spoken || messageData.content || '';

  logger.info('MessageProcessing', '===== å¼€å§‹å¤„ç†æ¶ˆæ¯ =====', {
    robotId: robot.robotId,
    userId: messageData.fromName,
    groupId: messageData.groupName,
    content: messageContent.substring(0, 100)
  });

  try {
    // æ­¥éª¤1: è§£ææ¶ˆæ¯å†…å®¹
    const messageContext = this.parseMessage(messageData);

    // æ­¥éª¤2: è·å–æˆ–åˆ›å»ºä¼šè¯
    const session = await sessionService.getOrCreateSession(
      messageContext.fromName,
      messageContext.groupName,
      {
        userName: messageContext.fromName,
        groupName: messageContext.groupName,
      }
    );

    // æ­¥éª¤3: ä¿å­˜ç”¨æˆ·æ¶ˆæ¯
    await sessionMessageService.saveUserMessage(
      session.sessionId,
      {
        userId: messageContext.fromName,
        groupId: messageContext.groupName,
        userName: messageContext.fromName,
        content: messageContext.content,
        timestamp: messageData.timestamp || new Date()
      },
      messageData.messageId,
      robot
    );

    // æ­¥éª¤4: è§¦å‘æµç¨‹å¼•æ“
    const flowEngine = require('./flow-engine.service').flowEngine;

    // æŸ¥æ‰¾å½“å‰æœºå™¨äººå…³è”çš„æµç¨‹å®šä¹‰
    const flowDefinition = await flowEngine.getFlowDefinitionByRobotId(robot.robotId);

    if (!flowDefinition) {
      logger.warn('æœºå™¨äººæœªå…³è”æµç¨‹å®šä¹‰ï¼Œä½¿ç”¨é»˜è®¤æµç¨‹', { robotId: robot.robotId });
      // ä½¿ç”¨é»˜è®¤æµç¨‹æˆ–ç›´æ¥è°ƒç”¨AIæœåŠ¡ï¼ˆé™çº§å¤„ç†ï¼‰
      return await this.processWithDefaultAI(messageContext, session, robot);
    }

    // åˆ›å»ºæµç¨‹å®ä¾‹
    const instance = await flowEngine.createFlowInstance({
      flowDefinitionId: flowDefinition.id,
      triggerType: 'webhook',
      triggerData: {
        robotId: robot.robotId,
        robotName: robot.name,
        message: messageContext,
        session
      },
      context: {
        robotId: robot.robotId,
        robotName: robot.name,
        sessionId: session.sessionId,
        messageId: messageData.messageId,
        userId: messageContext.fromName,
        userName: messageContext.fromName,
        groupId: messageContext.groupName,
        groupName: messageContext.groupName,
        originalMessage: messageContext.content,
        atMe: messageContext.atMe
      }
    });

    logger.info('æµç¨‹å®ä¾‹åˆ›å»ºæˆåŠŸ', { instanceId: instance.id });

    // å¼‚æ­¥æ‰§è¡Œæµç¨‹ï¼ˆä¸é˜»å¡ï¼‰
    setImmediate(async () => {
      try {
        await flowEngine.executeFlow(instance.id);
      } catch (error) {
        logger.error('æµç¨‹æ‰§è¡Œå¤±è´¥', { instanceId: instance.id, error: error.message });
      }
    });

    return {
      action: 'flow_triggered',
      reason: 'æ¶ˆæ¯å·²è§¦å‘æµç¨‹å¼•æ“å¤„ç†',
      instanceId: instance.id,
      flowName: flowDefinition.name,
      processingTime: Date.now() - startTime
    };

  } catch (error) {
    logger.error('MessageProcessing', '===== æ¶ˆæ¯å¤„ç†å¤±è´¥ =====', {
      error: error.message,
      stack: error.stack
    });

    // é™çº§å¤„ç†ï¼šç›´æ¥è°ƒç”¨AIæœåŠ¡
    return await this.processWithDefaultAI(messageContext, session, robot);
  }
}
```

**æ­¥éª¤2ï¼šæ·»åŠ æœºå™¨äººä¸æµç¨‹å®šä¹‰çš„å…³è”**

```javascript
// åœ¨robotsè¡¨ä¸­æ·»åŠ flowDefinitionIdå­—æ®µ
// ALTER TABLE robots ADD COLUMN flow_definition_id VARCHAR(36);

// åœ¨flow-engine.service.jsä¸­æ·»åŠ æŸ¥è¯¢æ–¹æ³•
async getFlowDefinitionByRobotId(robotId) {
  const db = await this.getDb();
  const { robots, flowDefinitions } = require('../database/schema');

  // æŸ¥è¯¢æœºå™¨äººå…³è”çš„æµç¨‹å®šä¹‰
  const robotsWithFlow = await db.select({
    flowDefinitionId: robots.flowDefinitionId
  })
    .from(robots)
    .where(eq(robots.robotId, robotId))
    .limit(1);

  if (robotsWithFlow.length === 0 || !robotsWithFlow[0].flowDefinitionId) {
    return null;
  }

  // æŸ¥è¯¢æµç¨‹å®šä¹‰
  return await this.getFlowDefinition(robotsWithFlow[0].flowDefinitionId);
}
```

**æ­¥éª¤3ï¼šé™çº§å¤„ç†æ–¹æ³•**

```javascript
// é™çº§å¤„ç†ï¼šç›´æ¥è°ƒç”¨AIæœåŠ¡ï¼ˆå½“æµç¨‹å¼•æ“ä¸å¯ç”¨æ—¶ï¼‰
async processWithDefaultAI(messageContext, session, robot) {
  try {
    // ä½¿ç”¨message-processingåŸæœ‰çš„å¤„ç†é€»è¾‘
    const intentResult = await aiService.recognizeIntent(
      messageContext.content,
      {
        userId: messageContext.fromName,
        groupId: messageContext.groupName,
        userName: messageContext.fromName,
        groupName: messageContext.groupName,
        history: session.context.slice(-5),
        sessionId: session.sessionId,
        messageId: messageContext.messageId,
        robotId: robot.robotId,
        robotName: robot.name
      }
    );

    // åˆ¤æ–­æ˜¯å¦éœ€è¦å›å¤
    if (!intentResult.needReply) {
      return {
        action: 'none',
        reason: `æ„å›¾ä¸º${intentResult.intent}ï¼Œä¸éœ€è¦å›å¤`
      };
    }

    // ç”Ÿæˆå›å¤
    const reply = await aiService.generateServiceReply(
      messageContext.content,
      intentResult.intent,
      '',
      {
        sessionId: session.sessionId,
        messageId: messageContext.messageId,
        robotId: robot.robotId,
        robotName: robot.name
      }
    );

    // å‘é€å›å¤
    const toType = messageContext.roomType === '2' || messageContext.roomType === '4'
      ? 'single'
      : 'group';
    const recipient = toType === 'single'
      ? messageContext.fromName
      : messageContext.groupName;

    await worktoolService.sendTextMessage(robot.robotId, recipient, reply);

    // ä¿å­˜æœºå™¨äººå›å¤
    await sessionMessageService.saveBotMessage(
      session.sessionId,
      reply,
      {
        userId: messageContext.fromName,
        groupId: messageContext.groupName,
        userName: messageContext.fromName,
        groupName: messageContext.groupName,
      },
      intentResult.intent,
      robot
    );

    return {
      action: 'auto_reply',
      reply,
      reason: 'é™çº§å¤„ç†ï¼šç›´æ¥è°ƒç”¨AIæœåŠ¡'
    };

  } catch (error) {
    logger.error('é™çº§å¤„ç†å¤±è´¥', { error: error.message });
    return {
      action: 'none',
      reason: 'é™çº§å¤„ç†ä¹Ÿå¤±è´¥',
      error: error.message
    };
  }
}
```

---

## ğŸ“Š ä¼˜åŒ–æ•ˆæœå¯¹æ¯”

### ä¼˜åŒ–å‰ vs ä¼˜åŒ–å

| åŠŸèƒ½ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å |
|------|-------|-------|
| AIæœåŠ¡è°ƒç”¨ | ä½¿ç”¨æœªå®šä¹‰çš„aiCoreService | ä½¿ç”¨ç»Ÿä¸€çš„AIServiceFactory |
| è§’è‰²ç³»ç»Ÿ | æ”¯æŒroleIdå‚æ•°ä½†æœªä½¿ç”¨ | å®Œæ•´æ”¯æŒè§’è‰²è¯æœ¯å·®å¼‚åŒ– |
| è¯æœ¯æ¨¡æ¿ | ç¡¬ç¼–ç æç¤ºè¯ | æ”¯æŒä»æ•°æ®åº“åŠ¨æ€åŠ è½½ |
| æœåŠ¡èŠ‚ç‚¹ | Mockå®ç° | å¯¹æ¥AIæœåŠ¡çš„çœŸå®å®ç° |
| äººå·¥è½¬æ¥èŠ‚ç‚¹ | Mockå®ç° | å¯¹æ¥ä¼šè¯ç®¡ç†æœåŠ¡ |
| é€šçŸ¥èŠ‚ç‚¹ | Mockå®ç° | å¯¹æ¥å‘Šè­¦ç³»ç»Ÿ |
| æ¶ˆæ¯å¤„ç†æœåŠ¡ | ç›´æ¥è°ƒç”¨AIæœåŠ¡ | è§¦å‘æµç¨‹å¼•æ“ç¼–æ’ |
| ä»£ç é‡å¤ | æ¶ˆæ¯å¤„ç†å’Œæµç¨‹å¼•æ“é‡å¤ | ç»Ÿä¸€åˆ°æµç¨‹å¼•æ“ |
| å¯ç»´æŠ¤æ€§ | ä¸¤å¥—ç³»ç»Ÿï¼Œç»´æŠ¤å›°éš¾ | ç»Ÿä¸€æ¶æ„ï¼Œæ˜“äºç»´æŠ¤ |
| æ‰©å±•æ€§ | å—é™ | é«˜åº¦å¯æ‰©å±• |

---

## ğŸš€ å®æ–½æ­¥éª¤

### é˜¶æ®µ1ï¼šç»Ÿä¸€AIæœåŠ¡è°ƒç”¨ï¼ˆ1å‘¨ï¼‰

**ä»»åŠ¡æ¸…å•**ï¼š
1. âœ… ç§»é™¤aiCoreServiceä¾èµ–
2. âœ… ä¿®æ”¹AIå¯¹è¯èŠ‚ç‚¹ï¼Œä½¿ç”¨AIServiceFactory
3. âœ… ä¿®æ”¹æ„å›¾è¯†åˆ«èŠ‚ç‚¹ï¼Œä½¿ç”¨AIServiceFactory
4. âœ… æ·»åŠ AI IOæ—¥å¿—è®°å½•
5. âœ… æµ‹è¯•AIèŠ‚ç‚¹åŠŸèƒ½

### é˜¶æ®µ2ï¼šæ•´åˆè§’è‰²ç³»ç»Ÿï¼ˆ1å‘¨ï¼‰

**ä»»åŠ¡æ¸…å•**ï¼š
1. âœ… åœ¨AIå¯¹è¯èŠ‚ç‚¹æ”¯æŒroleId
2. âœ… åŠ è½½è§’è‰²çš„systemPrompt
3. âœ… æ”¯æŒæ ¹æ®æ„å›¾è‡ªåŠ¨é€‰æ‹©è§’è‰²
4. âœ… æµ‹è¯•è§’è‰²å·®å¼‚åŒ–å›å¤

### é˜¶æ®µ3ï¼šå¯¹æ¥è¯æœ¯æ¨¡æ¿ï¼ˆ1å‘¨ï¼‰

**ä»»åŠ¡æ¸…å•**ï¼š
1. âœ… åœ¨AIå¯¹è¯èŠ‚ç‚¹æ”¯æŒtemplateId
2. âœ… ä»æ•°æ®åº“åŠ è½½è¯æœ¯æ¨¡æ¿
3. âœ… å®ç°æ¨¡æ¿å˜é‡æ›¿æ¢
4. âœ… æ·»åŠ æ¨¡æ¿ç¼“å­˜æœºåˆ¶
5. âœ… æµ‹è¯•è¯æœ¯æ¨¡æ¿åŠŸèƒ½

### é˜¶æ®µ4ï¼šå®ç°çœŸå®èŠ‚ç‚¹åŠŸèƒ½ï¼ˆ1å‘¨ï¼‰

**ä»»åŠ¡æ¸…å•**ï¼š
1. âœ… å®ç°æœåŠ¡èŠ‚ç‚¹ï¼ˆå¯¹æ¥AIæœåŠ¡ï¼‰
2. âœ… å®ç°äººå·¥è½¬æ¥èŠ‚ç‚¹ï¼ˆå¯¹æ¥ä¼šè¯ç®¡ç†ï¼‰
3. âœ… å®ç°é€šçŸ¥èŠ‚ç‚¹ï¼ˆå¯¹æ¥å‘Šè­¦ç³»ç»Ÿï¼‰
4. âœ… æµ‹è¯•æ‰€æœ‰èŠ‚ç‚¹åŠŸèƒ½

### é˜¶æ®µ5ï¼šæ¶ˆæ¯å¤„ç†æœåŠ¡è°ƒç”¨æµç¨‹å¼•æ“ï¼ˆ1å‘¨ï¼‰

**ä»»åŠ¡æ¸…å•**ï¼š
1. âœ… ä¿®æ”¹æ¶ˆæ¯å¤„ç†æœåŠ¡ï¼Œè§¦å‘æµç¨‹å¼•æ“
2. âœ… æ·»åŠ æœºå™¨äººä¸æµç¨‹å®šä¹‰çš„å…³è”
3. âœ… å®ç°é™çº§å¤„ç†æœºåˆ¶
4. âœ… æµ‹è¯•æ¶ˆæ¯å¤„ç†å®Œæ•´æµç¨‹

### é˜¶æ®µ6ï¼šå…¨é¢æµ‹è¯•ä¸ä¼˜åŒ–ï¼ˆ1å‘¨ï¼‰

**ä»»åŠ¡æ¸…å•**ï¼š
1. âœ… ç«¯åˆ°ç«¯æµ‹è¯•
2. âœ… æ€§èƒ½æµ‹è¯•
3. âœ… é”™è¯¯å¤„ç†æµ‹è¯•
4. âœ… æ–‡æ¡£æ›´æ–°
5. âœ… ä¸Šçº¿éƒ¨ç½²

---

## ğŸ“ æ€»ç»“

### æ ¸å¿ƒä¼˜åŒ–ç‚¹

1. **ç»Ÿä¸€AIæœåŠ¡è°ƒç”¨**
   - ä½¿ç”¨AIServiceFactoryç»Ÿä¸€ç®¡ç†AIæœåŠ¡
   - ç¡®ä¿æµç¨‹å¼•æ“å’Œæ¶ˆæ¯å¤„ç†æœåŠ¡ä½¿ç”¨ç›¸åŒçš„AIæœåŠ¡

2. **æ•´åˆè§’è‰²ç³»ç»Ÿ**
   - æ”¯æŒè§’è‰²çš„systemPromptåŠ è½½
   - å®ç°è§’è‰²çº§åˆ«çš„è¯æœ¯å·®å¼‚åŒ–

3. **å¯¹æ¥è¯æœ¯æ¨¡æ¿**
   - æ”¯æŒä»æ•°æ®åº“åŠ¨æ€åŠ è½½è¯æœ¯æ¨¡æ¿
   - å®ç°æ¨¡æ¿å˜é‡æ›¿æ¢å’Œç¼“å­˜

4. **å®ç°çœŸå®èŠ‚ç‚¹åŠŸèƒ½**
   - æœåŠ¡èŠ‚ç‚¹å¯¹æ¥AIæœåŠ¡
   - äººå·¥è½¬æ¥èŠ‚ç‚¹å¯¹æ¥ä¼šè¯ç®¡ç†
   - é€šçŸ¥èŠ‚ç‚¹å¯¹æ¥å‘Šè­¦ç³»ç»Ÿ

5. **æ¶ˆæ¯å¤„ç†æœåŠ¡è°ƒç”¨æµç¨‹å¼•æ“**
   - ç»Ÿä¸€æ¶ˆæ¯å¤„ç†æµç¨‹
   - æ¶ˆé™¤ä»£ç é‡å¤
   - æé«˜å¯ç»´æŠ¤æ€§

### é¢„æœŸæ•ˆæœ

1. **åŠŸèƒ½å®Œæ•´æ€§**ï¼šæ‰€æœ‰èŠ‚ç‚¹åŠŸèƒ½çœŸå®å¯ç”¨ï¼Œä¸å†æ˜¯Mock
2. **æ¶æ„ä¸€è‡´æ€§**ï¼šç»Ÿä¸€ä½¿ç”¨AIæœåŠ¡ã€è§’è‰²ç³»ç»Ÿã€è¯æœ¯æ¨¡æ¿
3. **å¯ç»´æŠ¤æ€§**ï¼šä»£ç é‡å¤æ¶ˆé™¤ï¼Œæ˜“äºç»´æŠ¤
4. **å¯æ‰©å±•æ€§**ï¼šé«˜åº¦å¯æ‰©å±•ï¼Œæ”¯æŒè‡ªå®šä¹‰èŠ‚ç‚¹
5. **æ€§èƒ½ä¼˜åŒ–**ï¼šé€šè¿‡ç¼“å­˜å’Œå¼‚æ­¥å¤„ç†æå‡æ€§èƒ½

### é£é™©ä¸åº”å¯¹

1. **AIæœåŠ¡è°ƒç”¨å˜æ›´é£é™©**
   - é£é™©ï¼šä¿®æ”¹AIæœåŠ¡è°ƒç”¨å¯èƒ½å¯¼è‡´åŠŸèƒ½å¼‚å¸¸
   - åº”å¯¹ï¼šä¿ç•™é™çº§å¤„ç†æœºåˆ¶ï¼Œç¡®ä¿æµç¨‹å¼•æ“ä¸å¯ç”¨æ—¶ä»èƒ½æ­£å¸¸å·¥ä½œ

2. **è§’è‰²ç³»ç»Ÿå…¼å®¹æ€§é£é™©**
   - é£é™©ï¼šè§’è‰²ç³»ç»Ÿå¯èƒ½ä¸ç°æœ‰åŠŸèƒ½ä¸å…¼å®¹
   - åº”å¯¹ï¼šé€æ­¥è¿ç§»ï¼Œå…ˆåœ¨æ–°æµç¨‹ä¸­ä½¿ç”¨ï¼Œæ—§æµç¨‹ä¿æŒä¸å˜

3. **è¯æœ¯æ¨¡æ¿ç¼“å­˜é£é™©**
   - é£é™©ï¼šç¼“å­˜å¯èƒ½å¯¼è‡´è¯æœ¯æ›´æ–°ä¸åŠæ—¶
   - åº”å¯¹ï¼šæä¾›æ¸…é™¤ç¼“å­˜æ¥å£ï¼Œæ”¯æŒå¼ºåˆ¶åˆ·æ–°

4. **æ¶ˆæ¯å¤„ç†æµç¨‹å˜æ›´é£é™©**
   - é£é™©ï¼šä¿®æ”¹æ¶ˆæ¯å¤„ç†æµç¨‹å¯èƒ½å½±å“ç°æœ‰åŠŸèƒ½
   - åº”å¯¹ï¼šä¿ç•™é™çº§å¤„ç†æœºåˆ¶ï¼Œç¡®ä¿æµç¨‹å¼•æ“ä¸å¯ç”¨æ—¶ä»èƒ½æ­£å¸¸å·¥ä½œ
