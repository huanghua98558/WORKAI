# 机器人角色设计文档

## 概述

WorkTool AI 中枢系统支持多种机器人角色，根据机器人的配置（分组、类型、模式）自动选择不同的处理流程。

## 机器人配置字段

### 1. conversionMode（转化客服模式）
- 类型：BOOLEAN
- 默认值：false
- 说明：显式启用转化客服模式

### 2. robotGroup（机器人分组）
- 类型：VARCHAR(50)
- 默认值：NULL
- 说明：机器人分组（如：营销、服务、技术支持等）

### 3. robotType（机器人类型）
- 类型：VARCHAR(50)
- 默认值：NULL
- 说明：机器人类型（如：角色、助手、客服等）

## 转化客服模式

### 触发条件
满足以下**任一条件**时，机器人将使用转化客服 AI：

1. `conversionMode === true`（显式开启转化客服模式）
2. `robotGroup === '营销'`（机器人分组为营销）
3. `robotType === '角色'`（机器人类型为角色）

### 处理流程

```
用户消息
  ↓
消息处理服务接收消息
  ↓
获取机器人配置
  ↓
检查转化客服条件：
  ├─ conversionMode === true ?
  ├─ robotGroup === '营销' ?
  └─ robotType === '角色' ?
  ↓
满足条件 → 跳过意图识别
  ↓
使用转化客服 AI 生成回复
  ↓
发送回复到用户
  ↓
更新会话信息
```

### 特点

- **跳过意图识别**：直接使用转化客服 AI，不进行意图分类
- **专用提示词**：使用 `promptType='conversion'` 的专门提示词
- **独立配置**：在系统设置中可以单独配置转化客服 AI 模型
- **营销优化**：专注于用户转化和营销场景

## 常规流程

### 适用场景
不满足转化客服触发条件的机器人，走常规流程：

- `conversionMode !== true`
- `robotGroup !== '营销'`
- `robotType !== '角色'`

### 处理流程

```
用户消息
  ↓
消息处理服务接收消息
  ↓
解析消息内容
  ↓
获取或创建会话
  ↓
添加消息到上下文
  ↓
保存用户消息到数据库
  ↓
AI 意图识别
  ├─ service（服务请求）
  ├─ help（帮助请求）
  ├─ chat（闲聊）
  ├─ welcome（欢迎）
  ├─ risk（风险内容）
  ├─ spam（垃圾信息）
  ├─ admin（管理指令）
  └─ report（报告）
  ↓
触发告警检查（如需要）
  ↓
决策逻辑：
  ├─ 风险内容 → 风险回复 + 转人工
  ├─ 垃圾信息 → 社群规矩回复
  ├─ 管理指令 → 不回复
  ├─ 不需要回复 → 已人工介入
  └─ 需要回复 → 根据意图生成回复
       ├─ service/help/welcome → 服务回复 AI
       ├─ chat → 根据配置（AI/固定/不回复）
       └─ 其他 → 通用回复 AI
  ↓
发送回复到用户
  ↓
更新会话信息
```

### 意图类型详解

#### 1. service（服务请求）
- **触发场景**：用户咨询产品功能、使用方法等
- **处理方式**：使用服务回复 AI 模型
- **提示词类型**：`service`

#### 2. help（帮助请求）
- **触发场景**：用户请求帮助、提问等
- **处理方式**：使用服务回复 AI 模型
- **提示词类型**：`service`

#### 3. chat（闲聊）
- **触发场景**：用户进行非业务对话
- **处理方式**：根据配置决定
  - `chatMode='ai'`：AI 自然陪聊（使用服务回复模型）
  - `chatMode='fixed'`：固定话术回复
  - `chatMode='none'`：不回复
- **提示词类型**：`chat`

#### 4. welcome（欢迎）
- **触发场景**：用户首次进入
- **处理方式**：使用服务回复 AI 模型
- **提示词类型**：`service`

#### 5. risk（风险内容）
- **触发场景**：检测到敏感词、违规内容等
- **处理方式**：生成风险回复 + 转人工处理
- **提示词类型**：`risk`
- **特殊处理**：会话状态自动切换为人工接管

#### 6. spam（垃圾信息）
- **触发场景**：检测到广告、刷屏等垃圾信息
- **处理方式**：生成社群规矩回复
- **提示词类型**：`spam`

#### 7. admin（管理指令）
- **触发场景**：识别到管理类指令
- **处理方式**：不回复（社群不支持管理功能）
- **提示词类型**：无

#### 8. report（报告）
- **触发场景**：需要生成报告
- **处理方式**：使用报告 AI 模型
- **提示词类型**：`report`

## 机器人角色分类建议

### 营销机器人
```javascript
{
  robotGroup: '营销',
  robotType: null,
  conversionMode: false
}
// 或
{
  robotGroup: null,
  robotType: '角色',
  conversionMode: false
}
```
- **使用场景**：营销推广、用户转化
- **处理流程**：转化客服模式
- **AI 模型**：专用转化客服 AI
- **特点**：专注于用户引导和转化

### 客服机器人
```javascript
{
  robotGroup: '服务',
  robotType: '客服',
  conversionMode: false
}
```
- **使用场景**：客户服务、问题解答
- **处理流程**：常规流程
- **AI 模型**：服务回复 AI
- **特点**：支持多种意图识别，智能分诊

### 技术支持机器人
```javascript
{
  robotGroup: '技术支持',
  robotType: '助手',
  conversionMode: false
}
```
- **使用场景**：技术支持、问题排查
- **处理流程**：常规流程
- **AI 模型**：服务回复 AI
- **特点**：专业知识库支持

### 通用机器人
```javascript
{
  robotGroup: null,
  robotType: null,
  conversionMode: false
}
```
- **使用场景**：通用场景、综合服务
- **处理流程**：常规流程
- **AI 模型**：根据意图选择
- **特点**：支持所有意图类型

### 自定义转化机器人
```javascript
{
  robotGroup: '自定义分组',
  robotType: '自定义类型',
  conversionMode: true
}
```
- **使用场景**：强制使用转化客服模式
- **处理流程**：转化客服模式
- **AI 模型**：专用转化客服 AI
- **特点**：显式配置，优先级最高

## 配置管理

### 数据库配置
```sql
-- 设置营销分组
UPDATE robots SET robot_group = '营销' WHERE id = 'xxx';

-- 设置角色类型
UPDATE robots SET robot_type = '角色' WHERE id = 'xxx';

-- 开启转化客服模式
UPDATE robots SET conversion_mode = true WHERE id = 'xxx';
```

### 系统设置配置
在 **系统设置 > AI 模型配置** 中配置不同类型的 AI 模型：

- **意图识别**：用于识别用户意图
- **服务回复**：用于服务类问题回复
- **闲聊**：用于闲聊回复
- **转化客服**：用于转化客服模式回复
- **报告**：用于生成报告

### Prompt 训练
在 **Prompt 训练** 平台中配置不同类型的提示词：

- `service`：服务回复提示词
- `chat`：闲聊提示词
- `conversion`：转化客服提示词
- `risk`：风险回复提示词
- `spam`：垃圾信息提示词
- `report`：报告生成提示词

## 日志追踪

系统会在以下关键节点记录日志：

### 转化客服模式
```
[消息处理] 检测到机器人分组为营销，使用转化AI回复
机器人 {robotId} 机器人分组为营销，使用转化AI回复
```

### 常规流程
```
[消息处理] 意图识别结果: { intent: 'service', confidence: 95, needReply: true }
[消息处理] generateReply步骤: 使用服务回复模型
```

## 注意事项

1. **优先级**：转化客服条件的判断优先级高于所有常规流程
2. **不可逆性**：一旦进入转化客服模式，不会执行常规流程
3. **会话隔离**：转化客服模式和常规流程的会话是独立的
4. **配置灵活性**：可以通过三种方式触发转化客服模式，满足不同场景需求
5. **日志审计**：所有决策都会记录详细日志，便于问题排查

## 版本历史

- **v1.1**（2026-02-04）：新增 robotGroup 和 robotType 字段，支持基于分组和类型的自动转化客服
- **v1.0**（2026-02-03）：支持 conversionMode 显式配置转化客服模式
