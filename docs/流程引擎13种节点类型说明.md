# WorkTool AI 流程引擎 - 13种节点类型说明

## 节点分类概览

| 分类 | 节点数量 | 节点列表 |
|------|---------|---------|
| 基础节点 | 2 | 消息接收、结束节点 |
| AI节点 | 2 | 意图识别、AI客服回复 |
| 逻辑节点 | 2 | 决策节点、消息分发 |
| 操作节点 | 2 | 发送指令、机器人分发 |
| 数据库节点 | 1 | 指令状态记录 |
| 告警节点 | 2 | 告警入库、告警规则判断 |
| 风险节点 | 2 | 风险处理、监控节点 |

---

## 详细节点说明

### 1. 消息接收节点 (message_receive)

**图标**: 📥
**颜色**: 绿色
**分类**: 基础节点

**作用**: 接收WorkTool消息并保存到数据库，提取消息元数据（用户、群组、时间等）

**主要配置选项**:
- `saveToDatabase`: 是否保存到数据库
- `saveToContext`: 是否保存到流程上下文
- `extractFields`: 提取的字段列表（messageId、sessionId、userName、groupName、roomType、atMe）
- `enableWebSocketPush`: 是否启用WebSocket实时推送
- `pushTarget`: 推送目标（panel1、panel2、both）

**使用场景**:
- 流程起点，接收用户消息
- 监听群组消息
- 接收@机器人的消息

---

### 2. 意图识别节点 (intent)

**图标**: 🧠
**颜色**: 紫色
**分类**: AI节点

**作用**: 使用AI识别用户消息意图（如：咨询、投诉、售后、互动等）

**主要配置选项**:
- `modelId`: AI模型ID（豆包Pro 4K/32K/128K、DeepSeek、Kimi）
- `confidenceThreshold`: 置信度阈值（0-1，默认0.7）
- `fallbackIntent`: 默认意图（未识别时使用）
- `supportedIntents`: 支持的意图列表（service、help、chat、welcome、risk、spam等）
- `saveToContext`: 是否保存识别结果到上下文
- `contextKey`: 上下文变量名（默认"intent"）
- `systemPrompt`: 自定义提示词

**使用场景**:
- 识别用户咨询意图
- 过滤垃圾消息
- 判断是否需要人工介入

---

### 3. 决策节点 (decision)

**图标**: 🔀
**颜色**: 橙色
**分类**: 逻辑节点

**作用**: 根据条件表达式判断后续流程分支（支持多条件规则）

**主要配置选项**:
- `conditionType`: 条件类型（expression、rule）
- `decisionMode`: 决策模式（priority优先匹配、all全部匹配、any任意匹配）
- `conditions`: 条件列表
  - `expression`: 条件表达式（如：context.intent === '投诉'）
  - `label`: 条件标签
  - `targetNodeId`: 目标节点ID
- `defaultTarget`: 默认分支节点ID
- `enableLogging`: 是否启用决策日志
- `strictMode`: 是否启用严格模式

**使用场景**:
- 根据意图分流（投诉→人工，咨询→AI）
- 根据风险等级分流
- 根据用户属性分流

---

### 4. AI客服回复节点 (ai_reply)

**图标**: ⚡
**颜色**: 黄色
**分类**: AI节点

**作用**: 使用大语言模型生成智能客服回复内容（支持人设、上下文历史）

**主要配置选项**:
- `modelId`: AI模型ID（豆包Pro 4K/32K/128K、DeepSeek、Kimi）
- `personaId`: 人设ID（客服助手、技术支持、销售顾问等）
- `temperature`: 温度参数（0-2，默认0.7）
- `maxTokens`: 最大Token数（默认1000，最大32000）
- `useContextHistory`: 是否使用上下文历史
- `contextWindowSize`: 上下文窗口大小（默认10）
- `enableThinking`: 是否启用思考模式（Chain of Thought）
- `systemPrompt`: 自定义系统提示词

**使用场景**:
- 自动回复用户咨询
- 生成服务引导语
- 生成技术解答

---

### 5. 消息分发节点 (message_dispatch)

**图标**: 🔀
**颜色**: 蓝色
**分类**: 逻辑节点

**作用**: 判断群发或私发模式，确定消息发送目标（群组或个人）

**主要配置选项**:
- `dispatchMode`: 分发模式（single、broadcast、conditional）
- `groupDispatch`: 群发配置
  - `enabled`: 是否启用
  - `targetNameSource`: 目标名称来源（context、custom）
- `privateDispatch`: 私发配置
  - `enabled`: 是否启用
  - `targetNameSource`: 目标名称来源
- `atMe`: @机器人配置
  - `requireAtMe`: 必须@机器人才回复
  - `onNotAtMe`: 未@时的处理方式（ignore、continue）

**使用场景**:
- 判断是群聊还是私聊
- 批量群发通知
- 私发消息给特定用户

---

### 6. 发送指令节点 (send_command)

**图标**: 💬
**颜色**: 青色
**分类**: 操作节点

**作用**: 调用WorkTool API发送消息或指令（支持@人、重试、优先级）

**主要配置选项**:
- `commandType`: 指令类型（message、notification、command）
- `robotId`: 机器人ID
- `recipients`: 接收者列表
- `recipientsFromContext`: 是否从上下文获取接收者
- `messageSource`: 消息来源（ai_response、fixed、template、custom）
- `messageContent`: 消息内容（固定内容）
- `priority`: 优先级（low、normal、high）
- `saveLog`: 是否保存发送日志
- `enableRetry`: 是否启用失败重试
- `retryCount`: 重试次数（默认3）
- `retryDelay`: 重试延迟（毫秒，默认2000）
- `enableAtList`: 是否启用@人功能
- `dynamicAtListExpression`: @人动态表达式

**使用场景**:
- 发送消息给用户或群组
- @特定用户通知
- 批量发送通知消息

---

### 7. 指令状态记录节点 (command_status)

**图标**: 📝
**颜色**: 靛蓝色
**分类**: 数据库节点

**作用**: 保存指令执行状态到数据库（成功/失败/处理中）

**主要配置选项**:
- `saveToRobotCommands`: 是否保存到robotCommands表
- `updateSessionMessages`: 是否更新session_messages表
- `enableWebSocketPush`: 是否启用WebSocket实时推送
- `pushTarget`: 推送目标（panel1、panel2、both）

**使用场景**:
- 记录消息发送状态
- 更新会话消息状态
- 同步消息状态到监控面板

---

### 8. 结束节点 (end)

**图标**: ⏹️
**颜色**: 灰色
**分类**: 基础节点

**作用**: 流程结束点，可配置返回消息、会话保存和上下文清理

**主要配置选项**:
- `endType`: 结束类型（success、failure、manual）
- `returnMessage`: 返回消息
- `saveSession`: 是否保存会话
- `cleanupContext`: 是否清理上下文

**使用场景**:
- 流程正常结束
- 流程异常结束
- 会话终止

---

### 9. 告警入库节点 (alert_save)

**图标**: 🔔
**颜色**: 红色
**分类**: 告警节点

**作用**: 保存告警信息到数据库（类型、级别、内容、负责人等）

**主要配置选项**:
- `alertType`: 告警类型（intent、keyword、frequency、custom）
- `alertLevel`: 告警级别（low、medium、high、critical）
- `alertTitle`: 告警标题
- `alertContent`: 告警内容
- `source`: 告警来源
- `tags`: 标签列表
- `assignee`: 负责人
- `dueDate`: 截止日期

**使用场景**:
- 保存意图告警
- 保存关键词告警
- 保存频率告警
- 分配告警给负责人

---

### 10. 告警规则判断节点 (alert_rule)

**图标**: ⚖️
**颜色**: 琥珀色
**分类**: 告警节点

**作用**: 判断告警规则并执行升级操作（阈值、模式、频率）

**主要配置选项**:
- `ruleType`: 规则类型（threshold、pattern、frequency）
- `threshold`: 阈值
- `pattern`: 匹配模式
- `frequency`: 频率（次/分钟）
- `escalationLevel`: 升级级别
- `escalateTo`: 升级目标列表
- `notifyChannels`: 通知渠道列表

**使用场景**:
- 判断告警是否需要升级
- 根据频率判断告警级别
- 自动升级告警到上级

---

### 11. 风险处理节点 (risk_handler)

**图标**: ⚠️
**颜色**: 红色
**分类**: 风险节点

**作用**: AI安抚用户并通知人工介入（风险等级、安抚策略、升级）

**主要配置选项**:
- `riskLevel`: 风险级别（low、medium、high、critical）
- `aiSoothing`: 是否启用AI安抚
- `soothingModelId`: 安抚AI模型ID
- `notifyHumans`: 是否通知人工
- `notifyTargets`: 通知目标列表
- `escalationStrategy`: 升级策略（immediate、timeout、manual）
- `escalateAfterMinutes`: 升级时间（分钟）

**使用场景**:
- 检测高风险消息后安抚用户
- 自动通知客服介入
- 分级处理风险事件

---

### 12. 监控节点 (monitor)

**图标**: 👁️
**颜色**: 青色
**分类**: 风险节点

**作用**: 实时监听群内消息（支持关键词匹配、风险检测、自动告警）

**主要配置选项**:
- `monitorType`: 监控类型（message、user、keyword、risk）
- `targets`: 监控目标列表
- `keywords`: 关键词列表
- `riskThreshold`: 风险阈值
- `alertOnMatch`: 匹配时是否告警
- `realtime`: 是否实时监控
- `intervalSeconds`: 间隔（秒）

**使用场景**:
- 监控特定用户消息
- 监控关键词出现
- 实时风险检测
- 定期扫描消息

---

### 13. 机器人分发节点 (robot_dispatch) ⭐ 新增

**图标**: 🤖
**颜色**: 蓝色
**分类**: 操作节点

**作用**: 将消息分发给指定的机器人处理（支持负载均衡、重试、故障转移）

**主要配置选项**:
- `robotId`: 机器人ID
- `dispatchMode`: 分发模式
  - `single`: 单机器人
  - `round_robin`: 轮询
  - `load_balancing`: 负载均衡
  - `random`: 随机
- `priority`: 优先级（low、normal、high）
- `maxConcurrentTasks`: 最大并发任务数
- `timeoutSeconds`: 超时时间（秒）
- `retryOnFailure`: 失败时是否重试
- `maxRetries`: 最大重试次数
- `retryDelaySeconds`: 重试延迟（秒）
- `fallbackRobotId`: 失败时的备用机器人ID
- `dispatchRules`: 分发规则列表
  - `id`: 规则ID
  - `name`: 规则名称
  - `condition`: 规则条件表达式
  - `robotId`: 指定机器人ID
  - `priority`: 优先级
- `logDispatch`: 是否记录分发日志
- `notifyOnFailure`: 失败时是否通知
- `notifyChannels`: 通知渠道列表

**使用场景**:
- 多机器人协作
- 负载均衡分发消息
- 机器人故障自动切换
- 按规则分发到不同机器人

---

## 节点配置完整度检查

| 节点类型 | 配置完整性 | 状态 |
|---------|-----------|------|
| message_receive | ✅ 100% | 已完善 |
| intent | ✅ 100% | 已完善 |
| decision | ✅ 100% | 已完善 |
| ai_reply | ✅ 100% | 已完善 |
| message_dispatch | ✅ 100% | 已完善 |
| send_command | ✅ 100% | 已完善 |
| command_status | ✅ 100% | 已完善 |
| end | ⚠️ 80% | 需完善 |
| alert_save | ✅ 100% | 已完善 |
| alert_rule | ✅ 100% | 已完善 |
| risk_handler | ✅ 100% | 已完善 |
| monitor | ✅ 100% | 已完善 |
| robot_dispatch | ❌ 0% | 待实现 |

**总体完成度**: 92.3% (12/13 节点已完善)

---

## 下一步工作

1. ⏳ 完善 END 节点配置面板
2. ⏳ 实现 ROBOT_DISPATCH 节点配置面板
3. ⏳ 添加配置验证功能
4. ⏳ 测试所有节点配置功能

---

**文档版本**: v2.0
**最后更新**: 2026-02-06
**节点总数**: 13种
