# 第一阶段任务清单：安全加固

**阶段名称**：安全加固
**阶段周期**：第1-2周（2025-02-08 ~ 2025-02-21）
**阶段目标**：修复所有P0安全漏洞，实施认证授权机制，通过安全渗透测试
**负责人**：技术负责人
**参与人员**：后端开发、测试人员

---

## 📋 阶段概览

### 阶段任务

| 任务ID | 任务名称 | 优先级 | 预计工期 | 负责人 | 状态 |
|--------|---------|-------|---------|-------|------|
| SEC-001 | CORS配置优化 | P0 | 2天 | 后端开发 | 🟡 待开始 |
| SEC-002 | Helmet CSP配置 | P0 | 2天 | 后端开发 | 🟡 待开始 |
| SEC-003 | 安全测试（CORS/CSP） | P0 | 1天 | 测试人员 | 🟡 待开始 |
| SEC-004 | 发现问题修复 | P0 | 1天 | 后端开发 | 🟡 待开始 |
| SEC-005 | JWT认证模块开发 | P0 | 2天 | 后端开发 | 🟡 待开始 |
| SEC-006 | JWT认证集成到路由 | P0 | 1天 | 后端开发 | 🟡 待开始 |
| SEC-007 | API Key认证开发 | P0 | 2天 | 后端开发 | 🟡 待开始 |
| SEC-008 | API Key认证集成 | P0 | 1天 | 后端开发 | 🟡 待开始 |
| SEC-009 | 认证功能测试 | P0 | 1天 | 测试人员 | 🟡 待开始 |
| SEC-010 | 渗透测试 | P0 | 1天 | 测试人员 | 🟡 待开始 |

### 时间安排

```
Week 1: 基础安全
Day 1-2 (周六-周日): CORS配置优化
Day 3-4 (周一-周二): Helmet CSP配置
Day 5 (周三):      安全测试
Day 6-7 (周四-周五): 发现问题修复

Week 2: 认证授权
Day 8-9 (周六-周日): JWT认证模块开发
Day 10 (周一):      JWT认证集成到路由
Day 11-12 (周二-周三): API Key认证开发
Day 13 (周四):      API Key认证集成
Day 14 (周五):      认证功能测试 + 渗透测试
```

---

## 🔴 Week 1：基础安全（2025-02-08 ~ 2025-02-14）

### SEC-001：CORS配置优化

**任务详情**：
- **优先级**：🔴 P0
- **预计工期**：2天
- **负责人**：后端开发
- **开始日期**：2025-02-08
- **完成日期**：2025-02-09

**实施步骤**：

#### Day 1：开发
1. 创建CORS配置文件
   ```bash
   # 文件位置
   server/lib/cors.js
   ```

2. 实现白名单模式
   - 创建环境变量配置
   - 实现白名单验证逻辑
   - 支持通配符匹配

3. 集成到Fastify应用
   ```javascript
   // server/app.js
   const corsConfig = require('./lib/cors');
   fastify.register(cors, corsConfig);
   ```

#### Day 2：测试
1. 功能测试
   - 测试白名单域名允许访问
   - 测试非白名单域名拒绝访问
   - 测试本地开发环境
   - 测试生产环境

2. 集成测试
   - 测试所有API路由
   - 测试跨域请求
   - 测试CORS预检请求

**验收标准**：
- ✅ 生产环境只允许白名单域名
- ✅ 非白名单域名请求被拒绝（HTTP 403）
- ✅ 开发环境允许本地域名
- ✅ 所有API路由正常工作
- ✅ 通过CORS安全测试

**交付物**：
- [ ] `server/lib/cors.js` 文件
- [ ] CORS配置文档
- [ ] 测试报告

---

### SEC-002：Helmet CSP配置

**任务详情**：
- **优先级**：🔴 P0
- **预计工期**：2天
- **负责人**：后端开发
- **开始日期**：2025-02-10
- **完成日期**：2025-02-11

**实施步骤**：

#### Day 1：开发
1. 创建CSP配置文件
   ```bash
   # 文件位置
   server/lib/csp.js
   ```

2. 实施CSP策略
   - 启用CSP（关闭 `contentSecurityPolicy: false`）
   - 配置defaultSrc
   - 配置scriptSrc（允许unsafe-inline用于开发）
   - 配置styleSrc（允许unsafe-inline用于Tailwind）
   - 配置imgSrc（允许data:和https:）
   - 配置connectSrc（允许backend URL和wss:）
   - 配置frameSrc（设为'none'）
   - 配置objectSrc（设为'none'）

3. 启用HSTS
   - 设置maxAge为31536000
   - 启用includeSubDomains
   - 启用preload

4. 集成到Fastify应用
   ```javascript
   // server/app.js
   const getCspConfig = require('./lib/csp');
   fastify.register(helmet, getCspConfig());
   ```

#### Day 2：测试
1. 功能测试
   - 测试所有页面正常加载
   - 测试脚本正常执行
   - 测试样式正常加载
   - 测试图片正常显示
   - 测试API正常调用
   - 测试WebSocket正常连接

2. 安全测试
   - 测试XSS防护
   - 测试脚本注入防护
   - 测试点击劫持防护

**验收标准**：
- ✅ CSP策略启用
- ✅ 所有页面正常加载
- ✅ 所有功能正常工作
- ✅ XSS漏洞被防护
- ✅ 通过CSP安全测试

**交付物**：
- [ ] `server/lib/csp.js` 文件
- [ ] CSP配置文档
- [ ] 测试报告

---

### SEC-003：安全测试（CORS/CSP）

**任务详情**：
- **优先级**：🔴 P0
- **预计工期**：1天
- **负责人**：测试人员
- **开始日期**：2025-02-12
- **完成日期**：2025-02-12

**实施步骤**：

1. CORS安全测试
   - 测试白名单验证
   - 测试跨域请求控制
   - 测试CORS预检请求
   - 使用工具：curl、浏览器开发者工具

2. CSP安全测试
   - 测试XSS防护
   - 测试脚本注入
   - 测试样式注入
   - 使用工具：浏览器开发者工具、OWASP ZAP

3. 测试报告
   - 记录测试结果
   - 标注发现的问题
   - 提供修复建议

**验收标准**：
- ✅ 完成安全测试
- ✅ 生成测试报告
- ✅ 发现所有安全问题

**交付物**：
- [ ] 安全测试报告

---

### SEC-004：发现问题修复

**任务详情**：
- **优先级**：🔴 P0
- **预计工期**：1天
- **负责人**：后端开发
- **开始日期**：2025-02-13
- **完成日期**：2025-02-13

**实施步骤**：

1. 评估测试报告
   - 分析发现的问题
   - 评估问题严重程度
   - 确定修复优先级

2. 修复问题
   - 修复CORS配置问题
   - 修复CSP配置问题
   - 修复其他安全问题

3. 验证修复
   - 重新测试
   - 确认问题已修复

**验收标准**：
- ✅ 所有P0安全问题已修复
- ✅ 所有测试通过

**交付物**：
- [ ] 问题修复报告

---

## 🔴 Week 2：认证授权（2025-02-15 ~ 2025-02-21）

### SEC-005：JWT认证模块开发

**任务详情**：
- **优先级**：🔴 P0
- **预计工期**：2天
- **负责人**：后端开发
- **开始日期**：2025-02-15
- **完成日期**：2025-02-16

**实施步骤**：

#### Day 1：开发认证模块
1. 安装依赖
   ```bash
   pnpm add jsonwebtoken bcryptjs
   pnpm add -D @types/jsonwebtoken @types/bcryptjs
   ```

2. 创建认证模块
   ```bash
   # 文件位置
   server/lib/auth.js
   ```

3. 实现核心功能
   - `generateToken(payload)` - 生成JWT token
   - `verifyToken(token)` - 验证JWT token
   - `authenticateToken(req, res, next)` - 认证中间件
   - `authenticateAdmin(req, res, next)` - 管理员认证中间件

4. 配置JWT密钥
   ```bash
   # 环境变量
   JWT_SECRET=your-secret-key-here
   JWT_EXPIRES_IN=24h
   ```

#### Day 2：测试
1. 单元测试
   - 测试token生成
   - 测试token验证
   - 测试token过期

2. 集成测试
   - 测试认证中间件
   - 测试管理员认证
   - 测试错误处理

**验收标准**：
- ✅ JWT认证模块正常工作
- ✅ Token生成和验证正常
- ✅ 认证中间件正常工作
- ✅ 管理员认证正常工作
- ✅ 所有测试通过

**交付物**：
- [ ] `server/lib/auth.js` 文件
- [ ] JWT认证文档
- [ ] 测试报告

---

### SEC-006：JWT认证集成到路由

**任务详情**：
- **优先级**：🔴 P0
- **预计工期**：1天
- **负责人**：后端开发
- **开始日期**：2025-02-17
- **完成日期**：2025-02-17

**实施步骤**：

1. 保护管理路由
   - 所有 `/api/admin/*` 路由
   - 所有删除操作路由
   - 所有敏感操作路由

2. 添加认证中间件
   ```javascript
   // server/routes/admin.api.js
   const { authenticateAdmin } = require('../lib/auth');

   // 保护管理接口
   app.delete('/api/admin/robots/:id', {
     preHandler: authenticateAdmin
   }, async (req, res) => {
     await robotService.deleteRobot(req.params.id);
     res.send({ success: true });
   });
   ```

3. 测试认证
   - 测试未授权请求被拒绝
   - 测试有效token通过
   - 测试无效token被拒绝
   - 测试过期token被拒绝

**验收标准**：
- ✅ 所有管理路由受保护
- ✅ 未授权请求被拒绝（HTTP 401/403）
- ✅ 有效token正常通过
- ✅ 无效token被拒绝
- ✅ 过期token被拒绝

**交付物**：
- [ ] 受保护的路由列表
- [ ] 测试报告

---

### SEC-007：API Key认证开发

**任务详情**：
- **优先级**：🔴 P0
- **预计工期**：2天
- **负责人**：后端开发
- **开始日期**：2025-02-18
- **完成日期**：2025-02-19

**实施步骤**：

#### Day 1：开发API Key管理
1. 创建API Key表
   ```sql
   CREATE TABLE api_keys (
     id SERIAL PRIMARY KEY,
     key VARCHAR(100) UNIQUE NOT NULL,
     name VARCHAR(100) NOT NULL,
     permissions JSONB,
     is_active BOOLEAN DEFAULT true,
     created_at TIMESTAMP DEFAULT NOW(),
     updated_at TIMESTAMP DEFAULT NOW()
   );
   ```

2. 创建API Key管理模块
   ```bash
   # 文件位置
   server/lib/api-key.js
   ```

3. 实现核心功能
   - `generateApiKey()` - 生成API Key
   - `verifyApiKey(apiKey)` - 验证API Key
   - `authenticateApiKey(req, res, next)` - API Key认证中间件

#### Day 2：开发管理功能
1. 创建管理API
   - POST `/api/admin/api-keys` - 创建API Key
   - GET `/api/admin/api-keys` - 查询API Key列表
   - DELETE `/api/admin/api-keys/:id` - 删除API Key
   - PUT `/api/admin/api-keys/:id/status` - 启用/禁用API Key

2. 测试
   - 测试API Key生成
   - 测试API Key验证
   - 测试API Key认证
   - 测试管理功能

**验收标准**：
- ✅ API Key生成正常
- ✅ API Key验证正常
- ✅ API Key认证中间件正常工作
- ✅ 管理功能正常工作
- ✅ 所有测试通过

**交付物**：
- [ ] `server/lib/api-key.js` 文件
- [ ] API Key管理API
- [ ] API Key文档
- [ ] 测试报告

---

### SEC-008：API Key认证集成

**任务详情**：
- **优先级**：🔴 P0
- **预计工期**：1天
- **负责人**：后端开发
- **开始日期**：2025-02-20
- **完成日期**：2025-02-20

**实施步骤**：

1. 保护API路由
   - 所有外部API调用路由
   - 所有监控API路由
   - 所有告警API路由

2. 添加API Key认证中间件
   ```javascript
   // server/routes/monitoring.api.js
   const { authenticateApiKey } = require('../lib/api-key');

   // 保护监控API
   fastify.get('/api/monitoring/health', {
     preHandler: authenticateApiKey
   }, async (request, reply) => {
     // ...
   });
   ```

3. 测试API Key认证
   - 测试有效API Key通过
   - 测试无效API Key被拒绝
   - 测试禁用的API Key被拒绝

**验收标准**：
- ✅ 所有API路由受保护
- ✅ 有效API Key正常通过
- ✅ 无效API Key被拒绝
- ✅ 禁用的API Key被拒绝
- ✅ 所有测试通过

**交付物**：
- [ ] 受保护的路由列表
- [ ] 测试报告

---

### SEC-009：认证功能测试

**任务详情**：
- **优先级**：🔴 P0
- **预计工期**：1天
- **负责人**：测试人员
- **开始日期**：2025-02-21
- **完成日期**：2025-02-21

**实施步骤**：

1. JWT认证测试
   - 测试token生成
   - 测试token验证
   - 测试token过期
   - 测试认证中间件
   - 测试管理员认证

2. API Key认证测试
   - 测试API Key生成
   - 测试API Key验证
   - 测试API Key认证
   - 测试API Key管理

3. 集成测试
   - 测试完整认证流程
   - 测试认证与业务功能集成
   - 测试错误处理

4. 测试报告
   - 记录测试结果
   - 标注发现的问题
   - 提供修复建议

**验收标准**：
- ✅ 完成所有认证功能测试
- ✅ 生成测试报告
- ✅ 所有测试通过

**交付物**：
- [ ] 认证功能测试报告

---

### SEC-010：渗透测试

**任务详情**：
- **优先级**：🔴 P0
- **预计工期**：1天
- **负责人**：测试人员
- **开始日期**：2025-02-21
- **完成日期**：2025-02-21

**实施步骤**：

1. 安全扫描
   - 使用OWASP ZAP扫描
   - 使用Burp Suite扫描
   - 扫描所有安全漏洞

2. 手动渗透测试
   - SQL注入测试
   - XSS攻击测试
   - CSRF攻击测试
   - 认证绕过测试
   - 权限提升测试

3. 测试报告
   - 记录发现的漏洞
   - 评估漏洞严重程度
   - 提供修复建议

**验收标准**：
- ✅ 完成渗透测试
- ✅ 生成渗透测试报告
- ✅ 所有P0安全漏洞修复
- ✅ 通过安全审计

**交付物**：
- [ ] 渗透测试报告
- [ ] 安全审计报告

---

## 🎯 阶段验收标准

### 必须达成（P0）

- [ ] 所有P0安全漏洞修复
- [ ] JWT认证正常工作
- [ ] API Key认证正常工作
- [ ] 通过安全渗透测试
- [ ] 通过安全审计

### 应该达成（P1）

- [ ] 所有管理路由受保护
- [ ] 所有API路由受保护
- [ ] 认证文档完善
- [ ] 测试覆盖率>60%

### 可以达成（P2）

- [ ] 认证管理UI完善
- [ ] API Key管理UI完善
- [ ] 认证日志记录

---

## 📊 阶段里程碑

### 里程碑1：基础安全完成（Week 1结束）

**日期**：2025-02-14
**验收内容**：
- [ ] CORS配置优化完成
- [ ] Helmet CSP配置完成
- [ ] 安全测试通过
- [ ] 发现的问题全部修复

### 里程碑2：认证授权完成（Week 2结束）

**日期**：2025-02-21
**验收内容**：
- [ ] JWT认证实施完成
- [ ] API Key认证实施完成
- [ ] 认证功能测试通过
- [ ] 渗透测试通过

---

## 📞 团队分工

| 角色 | 姓名 | Week 1任务 | Week 2任务 |
|------|------|-----------|-----------|
| 技术负责人 | [待填写] | 技术方案审核 | 技术方案审核 |
| 后端开发 | [待填写] | SEC-001, SEC-002, SEC-004 | SEC-005, SEC-006, SEC-007, SEC-008 |
| 测试人员 | [待填写] | SEC-003 | SEC-009, SEC-010 |

---

## 📚 相关文档

- 改造方案：`docs/系统报告/WorkTool-AI-系统全面改造方案.md`
- 实施指南：`docs/系统报告/改造实施指南.md`
- 项目看板：`docs/项目看板.md`

---

**文档版本**：v1.0
**创建日期**：2025-02-08
**创建人**：AI Assistant
**最后更新**：2025-02-08
