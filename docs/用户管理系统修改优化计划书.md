# WorkTool AI - ç”¨æˆ·ç®¡ç†ç³»ç»Ÿä¿®æ”¹ä¼˜åŒ–è®¡åˆ’ä¹¦

## 1. ç°çŠ¶åˆ†æ

### 1.1 å½“å‰ç³»ç»Ÿæ¦‚è¿°

WorkTool AI ä¸­æ¢ç³»ç»Ÿç›®å‰å·²å®ç°åŸºç¡€çš„ç”¨æˆ·ç®¡ç†åŠŸèƒ½ï¼ŒåŒ…æ‹¬ç”¨æˆ·çš„å¢åˆ æ”¹æŸ¥ã€è§’è‰²ç®¡ç†ç­‰ã€‚ä½†åœ¨å®‰å…¨æ€§ã€è®¤è¯æˆæƒã€å®¡è®¡ç­‰æ–¹é¢ä¸ã€Šç³»ç»Ÿæ•´æ”¹è®¡åˆ’ä¹¦ã€‹çš„è¦æ±‚å­˜åœ¨è¾ƒå¤§å·®è·ã€‚

### 1.2 å½“å‰æ¶æ„

#### 1.2.1 æ•°æ®åº“è®¾è®¡
```javascript
// server/database/schema.js - users è¡¨
exports.users = pgTable("users", {
  id: varchar("id", { length: 36 }).primaryKey().default(sql`gen_random_uuid()`),
  username: varchar("username", { length: 64 }).notNull().unique(),
  email: varchar("email", { length: 255 }).unique(),
  password: text("password").notNull(),  // âš ï¸ æ˜æ–‡å­˜å‚¨
  role: varchar("role", { length: 20 }).notNull().default("admin"), // admin, operator
  isActive: boolean("is_active").default(true).notNull(),
  lastLoginAt: timestamp("last_login_at", { withTimezone: true }),
  createdAt: timestamp("created_at", { withTimezone: true }).defaultNow().notNull(),
  updatedAt: timestamp("updated_at", { withTimezone: true }),
});
```

#### 1.2.2 åç«¯å®ç°

**æ ¸å¿ƒæ–‡ä»¶ï¼š**
- `server/database/userManager.js` - ç”¨æˆ·æ•°æ®è®¿é—®å±‚
- `server/routes/admin.api.js` - ç”¨æˆ·ç®¡ç† API è·¯ç”±ï¼ˆGET/POST/PUT/DELETE /usersï¼‰
- `src/lib/auth/middleware.ts` - è®¤è¯æˆæƒä¸­é—´ä»¶ï¼ˆNext.jsï¼‰

**å…³é”®åŠŸèƒ½ï¼š**
- âœ… ç”¨æˆ· CRUD æ“ä½œ
- âœ… ç”¨æˆ·å/é‚®ç®±å”¯ä¸€æ€§éªŒè¯
- âœ… è§’è‰²ç®¡ç†ï¼ˆadmin/operatorï¼‰
- âŒ å¯†ç æ˜æ–‡å­˜å‚¨
- âŒ æ—  JWT è®¤è¯
- âŒ æ— ç»†ç²’åº¦æƒé™æ§åˆ¶
- âŒ æ— å®¡è®¡æ—¥å¿—

#### 1.2.3 å‰ç«¯å®ç°

**æ ¸å¿ƒæ–‡ä»¶ï¼š**
- `src/components/user-management.tsx` - ç”¨æˆ·ç®¡ç†ç•Œé¢
- `src/lib/auth/middleware.ts` - è®¤è¯ä¸­é—´ä»¶

**åŠŸèƒ½ï¼š**
- âœ… ç”¨æˆ·åˆ—è¡¨å±•ç¤º
- âœ… æ·»åŠ /ç¼–è¾‘/åˆ é™¤ç”¨æˆ·
- âœ… è§’è‰²æ˜¾ç¤ºå’Œä¿®æ”¹
- âš ï¸ æ— ç™»å½•ç•Œé¢
- âš ï¸ æ— æƒé™æ§åˆ¶ç•Œé¢

---

## 2. é—®é¢˜è¯†åˆ«

### 2.1 å®‰å…¨é—®é¢˜ï¼ˆP0 - ä¸¥é‡ï¼‰

| é—®é¢˜ | ä¸¥é‡æ€§ | å½±å“ | å½“å‰çŠ¶æ€ | æ•´æ”¹è¦æ±‚ |
|------|--------|------|----------|----------|
| **å¯†ç æ˜æ–‡å­˜å‚¨** | ğŸ”´ ä¸¥é‡ | æ•°æ®åº“æ³„éœ²æ—¶å¯†ç å®Œå…¨æš´éœ² | âŒ æ˜æ–‡å­˜å‚¨ | âœ… bcrypt åŠ å¯† |
| **å¯†ç æ˜æ–‡æ¯”è¾ƒ** | ğŸ”´ ä¸¥é‡ | éªŒè¯é€»è¾‘ä¸å®‰å…¨ | âŒ ç®€å•å­—ç¬¦ä¸²æ¯”è¾ƒ | âœ… bcrypt.compare |
| **æ—  JWT è®¤è¯** | ğŸ”´ ä¸¥é‡ | æ— æ³•å®ç°æ— çŠ¶æ€è®¤è¯ | âŒ æœªå®ç° | âœ… å®Œæ•´ JWT æœºåˆ¶ |
| **æ—  Token è¿‡æœŸæœºåˆ¶** | ğŸŸ  é«˜ | Token æ°¸ä¹…æœ‰æ•ˆé£é™©é«˜ | âŒ æœªå®ç° | âœ… Refresh Token |
| **æ— å®¡è®¡æ—¥å¿—** | ğŸŸ  é«˜ | ç”¨æˆ·è¡Œä¸ºæ— æ³•è¿½æº¯ | âŒ æœªå®ç° | âœ… å®¡è®¡æ—¥å¿—è¡¨ |

### 2.2 æƒé™é—®é¢˜ï¼ˆP1 - é‡è¦ï¼‰

| é—®é¢˜ | ä¸¥é‡æ€§ | å½±å“ | å½“å‰çŠ¶æ€ | æ•´æ”¹è¦æ±‚ |
|------|--------|------|----------|----------|
| **æƒé™æ¨¡å‹è¿‡äºç®€å•** | ğŸŸ  é«˜ | æ— æ³•ç»†ç²’åº¦æ§åˆ¶ | âš ï¸ ä»… 2 ä¸ªè§’è‰² | âœ… RBAC æƒé™æ¨¡å‹ |
| **æ— æƒé™è¡¨** | ğŸŸ  é«˜ | æƒé™ç®¡ç†ä¸çµæ´» | âŒ æ— æƒé™è¡¨ | âœ… roles + permissions è¡¨ |
| **å‰ç«¯æ— æƒé™æ§åˆ¶** | ğŸŸ  é«˜ | å‰ç«¯å¯èƒ½è¶Šæƒ | âš ï¸ æœ‰ä¸­é—´ä»¶ä½†æœªåº”ç”¨ | âœ… å‰åç«¯åŒé‡æ§åˆ¶ |
| **æ— ç”¨æˆ·ç»„åŠŸèƒ½** | ğŸŸ¡ ä¸­ | éš¾ä»¥æ‰¹é‡ç®¡ç† | âŒ æœªå®ç° | âœ… ç”¨æˆ·ç»„ç®¡ç† |

### 2.3 ä»£ç è´¨é‡é—®é¢˜ï¼ˆP2 - å»ºè®®ï¼‰

| é—®é¢˜ | ä¸¥é‡æ€§ | å½±å“ | å½“å‰çŠ¶æ€ | æ•´æ”¹è¦æ±‚ |
|------|--------|------|----------|----------|
| **ç±»å‹å®šä¹‰ä¸å®Œæ•´** | ğŸŸ¡ ä¸­ | TypeScript ç±»å‹ä¸å®‰å…¨ | âš ï¸ æœ‰éƒ¨åˆ†å®šä¹‰ | âœ… å®Œæ•´ç±»å‹å®šä¹‰ |
| **æ— å•å…ƒæµ‹è¯•** | ğŸŸ¡ ä¸­ | é‡æ„é£é™©å¤§ | âŒ æ— æµ‹è¯• | âœ… å•å…ƒæµ‹è¯•è¦†ç›– |
| **é”™è¯¯å¤„ç†ä¸ç»Ÿä¸€** | ğŸŸ¡ ä¸­ | ç”¨æˆ·ä½“éªŒå·® | âš ï¸ éƒ¨åˆ†æœ‰å¤„ç† | âœ… ç»Ÿä¸€é”™è¯¯å¤„ç† |
| **æ— ç™»å½•ç•Œé¢** | ğŸŸ¡ ä¸­ | ç”¨æˆ·ä½“éªŒå·® | âŒ æœªå®ç° | âœ… ç™»å½•/ç™»å‡ºé¡µé¢ |

---

## 3. æ•´æ”¹è®¡åˆ’

### 3.1 ç¬¬ä¸€é˜¶æ®µï¼šå®‰å…¨åŠ å›ºï¼ˆ1-2 å‘¨ï¼‰

#### ä»»åŠ¡ 1.1ï¼šå¯†ç åŠ å¯†æ”¹é€ ï¼ˆP0ï¼‰

**ä¼˜å…ˆçº§**ï¼šP0  
**å·¥ä½œé‡**ï¼š2 å¤©

**å®æ–½æ­¥éª¤**ï¼š

1. å®‰è£… bcrypt
   ```bash
   pnpm add bcrypt
   pnpm add -D @types/bcrypt
   ```

2. ä¿®æ”¹ UserManager æ·»åŠ å¯†ç åŠ å¯†
   ```javascript
   // server/database/userManager.js
   const bcrypt = require('bcrypt');
   const SALT_ROUNDS = 10;

   class UserManager {
     // ... å…¶ä»–æ–¹æ³•

     /**
      * åŠ å¯†å¯†ç 
      */
     async hashPassword(password) {
       return await bcrypt.hash(password, SALT_ROUNDS);
     }

     /**
      * åˆ›å»ºç”¨æˆ·ï¼ˆåŠ å¯†å¯†ç ï¼‰
      */
     async createUser(data) {
       const db = await getDb();
       const validated = insertUserSchema.parse(data);
       
       // åŠ å¯†å¯†ç 
       const hashedPassword = await this.hashPassword(validated.password);
       
       const [user] = await db.insert(users).values({
         ...validated,
         password: hashedPassword
       }).returning();
       
       this.logger.info('åˆ›å»ºç”¨æˆ·æˆåŠŸ', { userId: user.id, username: user.username });
       return user;
     }

     /**
      * æ›´æ–°ç”¨æˆ·ï¼ˆå¯é€‰åŠ å¯†å¯†ç ï¼‰
      */
     async updateUser(id, data) {
       const db = await getDb();
       const updateData = { ...data };
       
       // å¦‚æœéœ€è¦æ›´æ–°å¯†ç ï¼Œè¿›è¡ŒåŠ å¯†
       if (updateData.password && updateData.password.trim()) {
         updateData.password = await this.hashPassword(updateData.password);
       } else {
         delete updateData.password;
       }
       
       const validated = updateUserSchema.parse(updateData);
       const [user] = await db
         .update(users)
         .set({ ...validated, updatedAt: new Date() })
         .where(eq(users.id, id))
         .returning();
       return user || null;
     }

     /**
      * éªŒè¯ç”¨æˆ·å¯†ç ï¼ˆä½¿ç”¨ bcryptï¼‰
      */
     async validatePassword(username, password) {
       const db = await getDb();
       const [user] = await db
         .select()
         .from(users)
         .where(and(eq(users.username, username), eq(users.isActive, true)));
       
       if (!user) {
         return null;
       }

       // ä½¿ç”¨ bcrypt éªŒè¯å¯†ç 
       const isValid = await bcrypt.compare(password, user.password);
       if (isValid) {
         return user;
       }
       
       return null;
     }
   }
   ```

3. æ•°æ®åº“è¿ç§»è„šæœ¬
   ```bash
   # scripts/migrate-passwords.js
   const { getDb } = require('coze-coding-dev-sdk');
   const { users } = require('../server/database/schema');
   const bcrypt = require('bcrypt');

   async function migratePasswords() {
     const db = await getDb();
     const allUsers = await db.select().from(users);
     
     console.log(`å¼€å§‹è¿ç§» ${allUsers.length} ä¸ªç”¨æˆ·çš„å¯†ç ...`);
     
     for (const user of allUsers) {
       const hashedPassword = await bcrypt.hash(user.password, 10);
       await db.update(users)
         .set({ password: hashedPassword })
         .where(eq(users.id, user.id));
       console.log(`âœ… ç”¨æˆ· ${user.username} å¯†ç å·²åŠ å¯†`);
     }
     
     console.log('å¯†ç è¿ç§»å®Œæˆï¼');
   }

   migratePasswords().catch(console.error);
   ```

4. æ‰§è¡Œè¿ç§»
   ```bash
   node scripts/migrate-passwords.js
   ```

**éªŒæ”¶æ ‡å‡†**ï¼š
- âœ… æ–°åˆ›å»ºçš„ç”¨æˆ·å¯†ç åŠ å¯†å­˜å‚¨
- âœ… ä¿®æ”¹ç”¨æˆ·å¯†ç æ—¶åŠ å¯†
- âœ… ç™»å½•éªŒè¯ä½¿ç”¨ bcrypt.compare
- âœ… å†å²æ•°æ®å…¨éƒ¨è¿ç§»

**æµ‹è¯•ç”¨ä¾‹**ï¼š
```javascript
// æµ‹è¯•å¯†ç åŠ å¯†
describe('UserManager - å¯†ç åŠ å¯†', () => {
  it('åº”è¯¥æ­£ç¡®åŠ å¯†å¯†ç ', async () => {
    const plainPassword = 'TestPassword123!';
    const hashed = await userManager.hashPassword(plainPassword);
    
    expect(hashed).not.toBe(plainPassword);
    expect(hashed.length).toBe(60); // bcrypt å“ˆå¸Œé•¿åº¦
  });

  it('åº”è¯¥æ­£ç¡®éªŒè¯å¯†ç ', async () => {
    const plainPassword = 'TestPassword123!';
    const hashed = await userManager.hashPassword(plainPassword);
    const isValid = await bcrypt.compare(plainPassword, hashed);
    
    expect(isValid).toBe(true);
  });

  it('åº”è¯¥æ‹’ç»é”™è¯¯å¯†ç ', async () => {
    const plainPassword = 'TestPassword123!';
    const hashed = await userManager.hashPassword(plainPassword);
    const isValid = await bcrypt.compare('WrongPassword', hashed);
    
    expect(isValid).toBe(false);
  });
});
```

---

#### ä»»åŠ¡ 1.2ï¼šå®ç° JWT è®¤è¯ï¼ˆP0ï¼‰

**ä¼˜å…ˆçº§**ï¼šP0  
**å·¥ä½œé‡**ï¼š3 å¤©

**å®æ–½æ­¥éª¤**ï¼š

1. å®‰è£…ä¾èµ–
   ```bash
   pnpm add jsonwebtoken
   pnpm add -D @types/jsonwebtoken
   ```

2. åˆ›å»ºè®¤è¯æœåŠ¡
   ```javascript
   // server/services/auth.service.js
   const jwt = require('jsonwebtoken');
   const { userManager } = require('../database');
   const { getLogger } = require('../lib/logger');

   const JWT_SECRET = process.env.JWT_SECRET || 'your-secret-key-change-in-production';
   const JWT_EXPIRES_IN = process.env.JWT_EXPIRES_IN || '24h';
   const REFRESH_TOKEN_EXPIRES_IN = '7d';

   class AuthService {
     constructor() {
       this.logger = getLogger('AUTH_SERVICE');
     }

     /**
      * ç”¨æˆ·ç™»å½•
      */
     async login(username, password) {
       // éªŒè¯ç”¨æˆ·
       const user = await userManager.validatePassword(username, password);
       if (!user) {
         throw new Error('ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯');
       }

       // ç”Ÿæˆ Token
       const token = this.generateToken(user);
       const refreshToken = this.generateRefreshToken(user);

       // æ›´æ–°æœ€åç™»å½•æ—¶é—´
       await userManager.updateLastLogin(user.id);

       this.logger.info('ç”¨æˆ·ç™»å½•æˆåŠŸ', { userId: user.id, username: user.username });

       return {
         token,
         refreshToken,
         user: {
           id: user.id,
           username: user.username,
           email: user.email,
           role: user.role
         }
       };
     }

     /**
      * ç”Ÿæˆè®¿é—® Token
      */
     generateToken(user) {
       const payload = {
         userId: user.id,
         username: user.username,
         role: user.role
       };
       return jwt.sign(payload, JWT_SECRET, { expiresIn: JWT_EXPIRES_IN });
     }

     /**
      * ç”Ÿæˆåˆ·æ–° Token
      */
     generateRefreshToken(user) {
       const payload = {
         userId: user.id,
         type: 'refresh'
       };
       return jwt.sign(payload, JWT_SECRET, { expiresIn: REFRESH_TOKEN_EXPIRES_IN });
     }

     /**
      * éªŒè¯ Token
      */
     verifyToken(token) {
       try {
         return jwt.verify(token, JWT_SECRET);
       } catch (error) {
         if (error.name === 'TokenExpiredError') {
           throw new Error('Token å·²è¿‡æœŸ');
         }
         throw new Error('Token æ— æ•ˆ');
       }
     }

     /**
      * åˆ·æ–° Token
      */
     async refresh(refreshToken) {
       const decoded = this.verifyToken(refreshToken);
       
       if (decoded.type !== 'refresh') {
         throw new Error('æ— æ•ˆçš„åˆ·æ–° Token');
       }

       // è·å–ç”¨æˆ·ä¿¡æ¯
       const user = await userManager.getUserById(decoded.userId);
       if (!user) {
         throw new Error('ç”¨æˆ·ä¸å­˜åœ¨');
       }

       // ç”Ÿæˆæ–° Token
       return {
         token: this.generateToken(user),
         refreshToken: this.generateRefreshToken(user)
       };
     }

     /**
      * ç™»å‡ºï¼ˆå‰ç«¯åˆ é™¤ Token å³å¯ï¼Œæ— çŠ¶æ€ï¼‰
      */
     logout() {
       return { message: 'ç™»å‡ºæˆåŠŸ' };
     }
   }

   module.exports = new AuthService();
   ```

3. åˆ›å»ºè®¤è¯ä¸­é—´ä»¶ï¼ˆåç«¯ï¼‰
   ```javascript
   // server/middleware/auth.js
   const authService = require('../services/auth.service');

   /**
    * è®¤è¯ä¸­é—´ä»¶
    */
   function authMiddleware(request, reply, done) {
     const authHeader = request.headers.authorization;
     
     if (!authHeader || !authHeader.startsWith('Bearer ')) {
       return reply.code(401).send({
         success: false,
         error: 'æœªæä¾›è®¤è¯ä¿¡æ¯',
         code: 'NO_TOKEN'
       });
     }

     const token = authHeader.substring(7);

     try {
       const decoded = authService.verifyToken(token);
       request.user = decoded;
       done();
     } catch (error) {
       reply.code(401).send({
         success: false,
         error: error.message,
         code: 'INVALID_TOKEN'
       });
     }
   }

   /**
    * æƒé™æ£€æŸ¥ä¸­é—´ä»¶
    */
   function requireRole(...allowedRoles) {
     return function(request, reply, done) {
       if (!request.user) {
         return reply.code(401).send({
           success: false,
           error: 'æœªè®¤è¯',
           code: 'UNAUTHORIZED'
         });
       }

       if (!allowedRoles.includes(request.user.role)) {
         return reply.code(403).send({
           success: false,
           error: 'æƒé™ä¸è¶³',
           code: 'FORBIDDEN'
         });
       }

       done();
     };
   }

   module.exports = {
     authMiddleware,
     requireRole
   };
   ```

4. æ·»åŠ ç™»å½•/åˆ·æ–° Token API
   ```javascript
   // server/routes/auth.api.js
   const authService = require('../services/auth.service');

   async function authApiRoutes(fastify, options) {
     /**
      * ç”¨æˆ·ç™»å½•
      */
     fastify.post('/login', async (request, reply) => {
       const { username, password } = request.body;

       if (!username || !password) {
         return reply.code(400).send({
           success: false,
           error: 'ç”¨æˆ·åå’Œå¯†ç ä¸èƒ½ä¸ºç©º'
         });
       }

       try {
         const result = await authService.login(username, password);
         return { success: true, data: result };
       } catch (error) {
         return reply.code(401).send({
           success: false,
           error: error.message
         });
       }
     });

     /**
      * åˆ·æ–° Token
      */
     fastify.post('/refresh', async (request, reply) => {
       const { refreshToken } = request.body;

       if (!refreshToken) {
         return reply.code(400).send({
           success: false,
           error: 'åˆ·æ–° Token ä¸èƒ½ä¸ºç©º'
         });
       }

       try {
         const result = await authService.refresh(refreshToken);
         return { success: true, data: result };
       } catch (error) {
         return reply.code(401).send({
           success: false,
           error: error.message
         });
       }
     });

     /**
      * ç™»å‡º
      */
     fastify.post('/logout', async (request, reply) => {
       return { success: true, data: authService.logout() };
     });
   }

   module.exports = authApiRoutes;
   ```

5. åº”ç”¨è®¤è¯ä¸­é—´ä»¶
   ```javascript
   // server/routes/admin.api.js
   const { authMiddleware, requireRole } = require('../middleware/auth');

   // éœ€è¦è®¤è¯çš„ç”¨æˆ·ç®¡ç† API
   fastify.get('/users', { preHandler: authMiddleware }, async (request, reply) => {
     // ...
   });

   fastify.post('/users', { preHandler: [authMiddleware, requireRole('admin')] }, async (request, reply) => {
     // ...
   });

   fastify.put('/users/:id', { preHandler: [authMiddleware, requireRole('admin')] }, async (request, reply) => {
     // ...
   });

   fastify.delete('/users/:id', { preHandler: [authMiddleware, requireRole('admin')] }, async (request, reply) => {
     // ...
   });
   ```

**éªŒæ”¶æ ‡å‡†**ï¼š
- âœ… ç™»å½•æˆåŠŸè¿”å› JWT Token
- âœ… Token åŒ…å«ç”¨æˆ·åŸºæœ¬ä¿¡æ¯
- âœ… Token è¿‡æœŸèƒ½æ­£ç¡®éªŒè¯
- âœ… Refresh Token èƒ½æ­£å¸¸å·¥ä½œ
- âœ… æœªè®¤è¯è¯·æ±‚è¿”å› 401
- âœ… æƒé™ä¸è¶³è¿”å› 403

**æµ‹è¯•ç”¨ä¾‹**ï¼š
```javascript
describe('AuthService', () => {
  describe('login', () => {
    it('åº”è¯¥æˆåŠŸç™»å½•å¹¶è¿”å› token', async () => {
      const result = await authService.login('admin', 'admin123');
      
      expect(result).toHaveProperty('token');
      expect(result).toHaveProperty('refreshToken');
      expect(result).toHaveProperty('user');
      expect(result.user.username).toBe('admin');
    });

    it('åº”è¯¥æ‹’ç»é”™è¯¯å¯†ç ', async () => {
      await expect(
        authService.login('admin', 'wrongpassword')
      ).rejects.toThrow('ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯');
    });
  });

  describe('verifyToken', () => {
    it('åº”è¯¥éªŒè¯æœ‰æ•ˆ token', () => {
      const token = authService.generateToken({
        id: '123',
        username: 'test',
        role: 'admin'
      });
      
      const decoded = authService.verifyToken(token);
      expect(decoded.userId).toBe('123');
    });

    it('åº”è¯¥æ‹’ç»è¿‡æœŸ token', () => {
      const expiredToken = 'expired.token.here';
      expect(() => authService.verifyToken(expiredToken)).toThrow();
    });
  });
});
```

---

#### ä»»åŠ¡ 1.3ï¼šå®ç°å®¡è®¡æ—¥å¿—ï¼ˆP0ï¼‰

**ä¼˜å…ˆçº§**ï¼šP0  
**å·¥ä½œé‡**ï¼š2 å¤©

**å®æ–½æ­¥éª¤**ï¼š

1. åˆ›å»ºå®¡è®¡æ—¥å¿—è¡¨
   ```javascript
   // server/database/schema.js
   exports.auditLogs = pgTable(
     "audit_logs",
     {
       id: varchar("id", { length: 36 })
         .primaryKey()
         .default(sql`gen_random_uuid()`),
       userId: varchar("user_id", { length: 36 }), // æ“ä½œç”¨æˆ· ID
       username: varchar("username", { length: 64 }), // æ“ä½œç”¨æˆ·å
       action: varchar("action", { length: 50 }).notNull(), // æ“ä½œç±»å‹
       resource: varchar("resource", { length: 100 }), // èµ„æºç±»å‹
       resourceId: varchar("resource_id", { length: 36 }), // èµ„æº ID
       details: jsonb("details").default("{}"), // æ“ä½œè¯¦æƒ…
       ipAddress: varchar("ip_address", { length: 50 }), // IP åœ°å€
       userAgent: text("user_agent"), // User Agent
       status: varchar("status", { length: 20 }).notNull().default("success"), // success, failure
       errorMessage: text("error_message"), // é”™è¯¯ä¿¡æ¯
       createdAt: timestamp("created_at", { withTimezone: true })
         .defaultNow()
         .notNull(),
     },
     (table) => ({
       userIdIdx: index("audit_logs_user_id_idx").on(table.userId),
       actionIdx: index("audit_logs_action_idx").on(table.action),
       resourceIdx: index("audit_logs_resource_idx").on(table.resource),
       createdAtIdx: index("audit_logs_created_at_idx").on(table.createdAt),
     })
   );

   // Schema å®šä¹‰
   const insertAuditLogSchema = z.object({
     userId: z.string().uuid(),
     username: z.string(),
     action: z.string(),
     resource: z.string().optional(),
     resourceId: z.string().uuid().optional(),
     details: z.any().optional(),
     ipAddress: z.string().optional(),
     userAgent: z.string().optional(),
     status: z.enum(['success', 'failure']).default('success'),
     errorMessage: z.string().optional()
   });

   exports.insertAuditLogSchema = insertAuditLogSchema;
   ```

2. åˆ›å»ºå®¡è®¡æ—¥å¿—ç®¡ç†å™¨
   ```javascript
   // server/database/auditLogManager.js
   const { eq, and, desc, like } = require('drizzle-orm');
   const { getDb } = require('coze-coding-dev-sdk');
   const { auditLogs, insertAuditLogSchema } = require('./schema');
   const { getLogger } = require('../lib/logger');

   class AuditLogManager {
     constructor() {
       this.logger = getLogger('AUDIT_LOG');
     }

     /**
      * åˆ›å»ºå®¡è®¡æ—¥å¿—
      */
     async createLog(data) {
       const db = await getDb();
       const validated = insertAuditLogSchema.parse(data);
       const [log] = await db.insert(auditLogs).values(validated).returning();
       return log;
     }

     /**
      * è·å–æ—¥å¿—åˆ—è¡¨
      */
     async getLogs(options = {}) {
       const { skip = 0, limit = 100, filters = {} } = options;
       const db = await getDb();

       const conditions = [];
       if (filters.userId) {
         conditions.push(eq(auditLogs.userId, filters.userId));
       }
       if (filters.action) {
         conditions.push(eq(auditLogs.action, filters.action));
       }
       if (filters.resource) {
         conditions.push(like(auditLogs.resource, `%${filters.resource}%`));
       }
       if (filters.startDate) {
         conditions.push(sql`${auditLogs.createdAt} >= ${new Date(filters.startDate)}`);
       }
       if (filters.endDate) {
         conditions.push(sql`${auditLogs.createdAt} <= ${new Date(filters.endDate)}`);
       }

       const query = db.select().from(auditLogs);
       if (conditions.length > 0) {
         query.where(and(...conditions));
       }
       query.orderBy(desc(auditLogs.createdAt)).limit(limit).offset(skip);

       return await query;
     }

     /**
      * è®°å½•ç”¨æˆ·ç™»å½•
      */
     async recordLogin(userId, username, request) {
       return this.createLog({
         userId,
         username,
         action: 'login',
         resource: 'auth',
         ipAddress: request.ip,
         userAgent: request.headers['user-agent'],
         status: 'success'
       });
     }

     /**
      * è®°å½•ç”¨æˆ·æ“ä½œ
      */
     async recordUserAction(userId, username, action, resource, resourceId, details, request) {
       return this.createLog({
         userId,
         username,
         action,
         resource,
         resourceId,
         details,
         ipAddress: request.ip,
         userAgent: request.headers['user-agent'],
         status: 'success'
       });
     }
   }

   module.exports = new AuditLogManager();
   ```

3. é›†æˆåˆ°å…³é”®æ“ä½œ
   ```javascript
   // server/services/auth.service.js
   const auditLogManager = require('../database/auditLogManager');

   class AuthService {
     async login(username, password, request) {
       // ... ç™»å½•é€»è¾‘

       // è®°å½•å®¡è®¡æ—¥å¿—
       await auditLogManager.recordLogin(user.id, user.username, request);

       return { ... };
     }
   }

   // server/routes/admin.api.js
   fastify.post('/users', { preHandler: [authMiddleware, requireRole('admin')] }, async (request, reply) => {
     // åˆ›å»ºç”¨æˆ·
     const newUser = await userManager.createUser(request.body);
     
     // è®°å½•å®¡è®¡æ—¥å¿—
     await auditLogManager.recordUserAction(
       request.user.userId,
       request.user.username,
       'create',
       'user',
       newUser.id,
       { username: newUser.username, role: newUser.role },
       request
     );
     
     return { success: true, data: newUser };
   });
   ```

**éªŒæ”¶æ ‡å‡†**ï¼š
- âœ… æ‰€æœ‰å…³é”®æ“ä½œéƒ½è¢«è®°å½•
- âœ… æ—¥å¿—åŒ…å«å®Œæ•´ä¿¡æ¯
- âœ… å¯ä»¥æŒ‰æ¡ä»¶æŸ¥è¯¢æ—¥å¿—
- âœ… æ—¥å¿—ä¿ç•™è‡³å°‘ 90 å¤©

---

### 3.2 ç¬¬äºŒé˜¶æ®µï¼šRBAC æƒé™ç®¡ç†ï¼ˆ2 å‘¨ï¼‰

#### ä»»åŠ¡ 2.1ï¼šè®¾è®¡å¹¶å®ç° RBAC æ¨¡å‹ï¼ˆP1ï¼‰

**ä¼˜å…ˆçº§**ï¼šP1  
**å·¥ä½œé‡**ï¼š4 å¤©

**å®æ–½æ­¥éª¤**ï¼š

1. åˆ›å»ºè§’è‰²å’Œæƒé™è¡¨
   ```javascript
   // server/database/schema.js
   // è§’è‰²è¡¨
   exports.roles = pgTable(
     "roles",
     {
       id: varchar("id", { length: 36 })
         .primaryKey()
         .default(sql`gen_random_uuid()`),
       name: varchar("name", { length: 50 }).notNull().unique(), // admin, operator, viewer
       displayName: varchar("display_name", { length: 100 }).notNull(),
       description: text("description"),
       isSystem: boolean("is_system").default(false).notNull(), // æ˜¯å¦ç³»ç»Ÿè§’è‰²ï¼ˆä¸å¯åˆ é™¤ï¼‰
       createdAt: timestamp("created_at", { withTimezone: true }).defaultNow().notNull(),
       updatedAt: timestamp("updated_at", { withTimezone: true }).defaultNow().notNull(),
     },
     (table) => ({
       nameIdx: index("roles_name_idx").on(table.name),
     })
   );

   // æƒé™è¡¨
   exports.permissions = pgTable(
     "permissions",
     {
       id: varchar("id", { length: 36 })
         .primaryKey()
         .default(sql`gen_random_uuid()`),
       name: varchar("name", { length: 100 }).notNull().unique(), // user:read, user:write, user:delete
       displayName: varchar("display_name", { length: 100 }).notNull(),
       description: text("description"),
       module: varchar("module", { length: 50 }).notNull(), // user, robot, alert, monitor
       category: varchar("category", { length: 50 }), // read, write, delete, manage
       createdAt: timestamp("created_at", { withTimezone: true }).defaultNow().notNull(),
     },
     (table) => ({
       moduleIdx: index("permissions_module_idx").on(table.module),
     })
   );

   // è§’è‰²æƒé™å…³è”è¡¨
   exports.rolePermissions = pgTable(
     "role_permissions",
     {
       roleId: varchar("role_id", { length: 36 })
         .notNull()
         .references(() => roles.id, { onDelete: "cascade" }),
       permissionId: varchar("permission_id", { length: 36 })
         .notNull()
         .references(() => permissions.id, { onDelete: "cascade" }),
       createdAt: timestamp("created_at", { withTimezone: true }).defaultNow().notNull(),
     },
     (table) => ({
       pk: primaryKey({ columns: [table.roleId, table.permissionId] }),
       roleIdIdx: index("role_permissions_role_id_idx").on(table.roleId),
       permissionIdIdx: index("role_permissions_permission_id_idx").on(table.permissionId),
     })
   );
   ```

2. åˆå§‹åŒ–é»˜è®¤è§’è‰²å’Œæƒé™
   ```javascript
   // scripts/init-rbac.js
   const { getDb } = require('coze-coding-dev-sdk');
   const { roles, permissions, rolePermissions } = require('../server/database/schema');

   // å®šä¹‰é»˜è®¤æƒé™
   const defaultPermissions = [
     // ç”¨æˆ·ç®¡ç†
     { name: 'user:read', displayName: 'æŸ¥çœ‹ç”¨æˆ·', module: 'user', category: 'read' },
     { name: 'user:write', displayName: 'åˆ›å»º/ç¼–è¾‘ç”¨æˆ·', module: 'user', category: 'write' },
     { name: 'user:delete', displayName: 'åˆ é™¤ç”¨æˆ·', module: 'user', category: 'delete' },
     
     // æœºå™¨äººç®¡ç†
     { name: 'robot:read', displayName: 'æŸ¥çœ‹æœºå™¨äºº', module: 'robot', category: 'read' },
     { name: 'robot:write', displayName: 'åˆ›å»º/ç¼–è¾‘æœºå™¨äºº', module: 'robot', category: 'write' },
     { name: 'robot:delete', displayName: 'åˆ é™¤æœºå™¨äºº', module: 'robot', category: 'delete' },
     { name: 'command:send', displayName: 'å‘é€æŒ‡ä»¤', module: 'robot', category: 'write' },
     
     // å‘Šè­¦ç®¡ç†
     { name: 'alert:read', displayName: 'æŸ¥çœ‹å‘Šè­¦', module: 'alert', category: 'read' },
     { name: 'alert:write', displayName: 'åˆ›å»º/ç¼–è¾‘å‘Šè­¦è§„åˆ™', module: 'alert', category: 'write' },
     { name: 'alert:delete', displayName: 'åˆ é™¤å‘Šè­¦è§„åˆ™', module: 'alert', category: 'delete' },
     { name: 'alert:handle', displayName: 'å¤„ç†å‘Šè­¦', module: 'alert', category: 'write' },
     
     // ç›‘æ§ç®¡ç†
     { name: 'monitor:read', displayName: 'æŸ¥çœ‹ç›‘æ§', module: 'monitor', category: 'read' },
     
     // ç³»ç»Ÿè®¾ç½®
     { name: 'config:read', displayName: 'æŸ¥çœ‹é…ç½®', module: 'config', category: 'read' },
     { name: 'config:write', displayName: 'ä¿®æ”¹é…ç½®', module: 'config', category: 'write' },
   ];

   // å®šä¹‰é»˜è®¤è§’è‰²
   const defaultRoles = [
     {
       name: 'admin',
       displayName: 'ç®¡ç†å‘˜',
       description: 'ç³»ç»Ÿç®¡ç†å‘˜ï¼Œæ‹¥æœ‰æ‰€æœ‰æƒé™',
       isSystem: true,
       permissions: defaultPermissions.map(p => p.name) // æ‰€æœ‰æƒé™
     },
     {
       name: 'operator',
       displayName: 'æ“ä½œå‘˜',
       description: 'ç³»ç»Ÿæ“ä½œå‘˜ï¼Œå¯ä»¥ç®¡ç†æœºå™¨äººå’Œå‘Šè­¦',
       isSystem: true,
       permissions: [
         'user:read',
         'robot:read',
         'robot:write',
         'command:send',
         'alert:read',
         'alert:write',
         'alert:handle',
         'monitor:read',
         'config:read'
       ]
     },
     {
       name: 'viewer',
       displayName: 'æŸ¥çœ‹è€…',
       description: 'åªèƒ½æŸ¥çœ‹ç³»ç»Ÿä¿¡æ¯',
       isSystem: true,
       permissions: [
         'user:read',
         'robot:read',
         'alert:read',
         'monitor:read',
         'config:read'
       ]
     }
   ];

   async function initRBAC() {
     const db = await getDb();
     console.log('å¼€å§‹åˆå§‹åŒ– RBAC...');

     // åˆ›å»ºæƒé™
     const permissionMap = new Map();
     for (const perm of defaultPermissions) {
       const [existing] = await db.select().from(permissions)
         .where(eq(permissions.name, perm.name));
       
       let permission;
       if (existing) {
         permission = existing;
         console.log(`âœ… æƒé™ ${perm.name} å·²å­˜åœ¨`);
       } else {
         [permission] = await db.insert(permissions).values(perm).returning();
         console.log(`âœ… åˆ›å»ºæƒé™: ${perm.name}`);
       }
       permissionMap.set(perm.name, permission.id);
     }

     // åˆ›å»ºè§’è‰²å¹¶å…³è”æƒé™
     for (const roleDef of defaultRoles) {
       const [existing] = await db.select().from(roles)
         .where(eq(roles.name, roleDef.name));
       
       let role;
       if (existing) {
         role = existing;
         console.log(`âœ… è§’è‰² ${roleDef.name} å·²å­˜åœ¨`);
         
         // åˆ é™¤æ—§çš„æƒé™å…³è”
         await db.delete(rolePermissions).where(eq(rolePermissions.roleId, role.id));
       } else {
         [role] = await db.insert(roles).values({
           name: roleDef.name,
           displayName: roleDef.displayName,
           description: roleDef.description,
           isSystem: roleDef.isSystem
         }).returning();
         console.log(`âœ… åˆ›å»ºè§’è‰²: ${roleDef.name}`);
       }

       // å…³è”æƒé™
       for (const permName of roleDef.permissions) {
         const permId = permissionMap.get(permName);
         if (permId) {
           await db.insert(rolePermissions).values({
             roleId: role.id,
             permissionId: permId
           });
         }
       }
       console.log(`  â†³ å…³è” ${roleDef.permissions.length} ä¸ªæƒé™`);
     }

     console.log('RBAC åˆå§‹åŒ–å®Œæˆï¼');
   }

   initRBAC().catch(console.error);
   ```

3. åˆ›å»º RBAC ç®¡ç†æœåŠ¡
   ```javascript
   // server/services/rbac.service.js
   const { eq, and } = require('drizzle-orm');
   const { getDb } = require('coze-coding-dev-sdk');
   const { roles, permissions, rolePermissions } = require('../database/schema');

   class RBACService {
     constructor() {
       this.roleCache = new Map(); // è§’è‰²æƒé™ç¼“å­˜
       this.cacheExpiry = 5 * 60 * 1000; // 5 åˆ†é’Ÿ
     }

     /**
      * è·å–è§’è‰²çš„æ‰€æœ‰æƒé™
      */
     async getRolePermissions(roleName) {
       // æ£€æŸ¥ç¼“å­˜
       const cached = this.roleCache.get(roleName);
       if (cached && cached.expiry > Date.now()) {
         return cached.permissions;
       }

       const db = await getDb();
       const result = await db
         .select({
           permission: permissions.name
         })
         .from(rolePermissions)
         .innerJoin(roles, eq(rolePermissions.roleId, roles.id))
         .innerJoin(permissions, eq(rolePermissions.permissionId, permissions.id))
         .where(eq(roles.name, roleName));

       const permissionNames = result.map(r => r.permission);

       // æ›´æ–°ç¼“å­˜
       this.roleCache.set(roleName, {
         permissions: permissionNames,
         expiry: Date.now() + this.cacheExpiry
       });

       return permissionNames;
     }

     /**
      * æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰æŒ‡å®šæƒé™
      */
     async hasPermission(userRole, permissionName) {
       if (!userRole || !permissionName) {
         return false;
       }

       const permissions = await this.getRolePermissions(userRole);
       return permissions.includes(permissionName);
     }

     /**
      * æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰ä»»ä¸€æƒé™
      */
     async hasAnyPermission(userRole, permissionNames) {
       for (const perm of permissionNames) {
         if (await this.hasPermission(userRole, perm)) {
           return true;
         }
       }
       return false;
     }

     /**
      * æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰æ‰€æœ‰æƒé™
      */
     async hasAllPermissions(userRole, permissionNames) {
       for (const perm of permissionNames) {
         if (!(await this.hasPermission(userRole, perm))) {
           return false;
         }
       }
       return true;
     }

     /**
      * æ¸…é™¤ç¼“å­˜
      */
     clearCache(roleName) {
       if (roleName) {
         this.roleCache.delete(roleName);
       } else {
         this.roleCache.clear();
       }
     }
   }

   module.exports = new RBACService();
   ```

4. åˆ›å»ºæƒé™æ£€æŸ¥ä¸­é—´ä»¶
   ```javascript
   // server/middleware/permission.js
   const rbacService = require('../services/rbac.service');

   /**
    * æƒé™æ£€æŸ¥ä¸­é—´ä»¶
    */
   function requirePermission(...permissions) {
     return async function(request, reply, done) {
       if (!request.user) {
         return reply.code(401).send({
           success: false,
           error: 'æœªè®¤è¯',
           code: 'UNAUTHORIZED'
         });
       }

       const hasPermission = await rbacService.hasAnyPermission(
         request.user.role,
         permissions
       );

       if (!hasPermission) {
         return reply.code(403).send({
           success: false,
           error: 'æƒé™ä¸è¶³',
           code: 'FORBIDDEN',
           required: permissions
         });
       }

       done();
     };
   }

   module.exports = {
     requirePermission
   };
   ```

5. åº”ç”¨åˆ° API
   ```javascript
   // server/routes/admin.api.js
   const { requirePermission } = require('../middleware/permission');

   // ç”¨æˆ·ç®¡ç† API
   fastify.get('/users', { 
     preHandler: [authMiddleware, requirePermission('user:read')] 
   }, async (request, reply) => {
     // ...
   });

   fastify.post('/users', { 
     preHandler: [authMiddleware, requirePermission('user:write')] 
   }, async (request, reply) => {
     // ...
   });

   fastify.delete('/users/:id', { 
     preHandler: [authMiddleware, requirePermission('user:delete')] 
   }, async (request, reply) => {
     // ...
   });
   ```

**éªŒæ”¶æ ‡å‡†**ï¼š
- âœ… è§’è‰²å’Œæƒé™è¡¨åˆ›å»ºæˆåŠŸ
- âœ… é»˜è®¤è§’è‰²å’Œæƒé™åˆå§‹åŒ–å®Œæˆ
- âœ… æƒé™æ£€æŸ¥æ­£ç¡®å·¥ä½œ
- âœ… ç¼“å­˜æœºåˆ¶æœ‰æ•ˆ
- âœ… è§’è‰²æƒé™ä¿®æ”¹åæ¸…é™¤ç¼“å­˜

---

#### ä»»åŠ¡ 2.2ï¼šä¿®æ”¹ç”¨æˆ·è¡¨æ”¯æŒå¤šè§’è‰²ï¼ˆP2ï¼‰

**ä¼˜å…ˆçº§**ï¼šP2  
**å·¥ä½œé‡**ï¼š2 å¤©

**å®æ–½æ­¥éª¤**ï¼š

1. åˆ›å»ºç”¨æˆ·è§’è‰²å…³è”è¡¨
   ```javascript
   // server/database/schema.js
   exports.userRoles = pgTable(
     "user_roles",
     {
       userId: varchar("user_id", { length: 36 })
         .notNull()
         .references(() => users.id, { onDelete: "cascade" }),
       roleId: varchar("role_id", { length: 36 })
         .notNull()
         .references(() => roles.id, { onDelete: "cascade" }),
       isPrimary: boolean("is_primary").default(false).notNull(), // æ˜¯å¦ä¸»è§’è‰²
       assignedAt: timestamp("assigned_at", { withTimezone: true }).defaultNow().notNull(),
       assignedBy: varchar("assigned_by", { length: 36 }), // åˆ†é…äºº
     },
     (table) => ({
       pk: primaryKey({ columns: [table.userId, table.roleId] }),
       userIdIdx: index("user_roles_user_id_idx").on(table.userId),
       roleIdIdx: index("user_roles_role_id_idx").on(table.roleId),
       isPrimaryIdx: index("user_roles_is_primary_idx").on(table.isPrimary),
     })
   );
   ```

2. ä¿®æ”¹ UserManager æ”¯æŒå¤šè§’è‰²
   ```javascript
   // server/database/userManager.js
   async getUserRoles(userId) {
     const db = await getDb();
     const result = await db
       .select({
         roleId: roles.id,
         roleName: roles.name,
         roleDisplayName: roles.displayName,
         isPrimary: userRoles.isPrimary
       })
       .from(userRoles)
       .innerJoin(roles, eq(userRoles.roleId, roles.id))
       .where(eq(userRoles.userId, userId));
     
     return result;
   }

   async assignRole(userId, roleId, isPrimary = false, assignedBy) {
     const db = await getDb();
     const [userRole] = await db.insert(userRoles).values({
       userId,
       roleId,
       isPrimary,
       assignedBy
     }).returning();
     
     return userRole;
   }
   ```

---

### 3.3 ç¬¬ä¸‰é˜¶æ®µï¼šå‰ç«¯å®ç°ï¼ˆ1-2 å‘¨ï¼‰

#### ä»»åŠ¡ 3.1ï¼šå®ç°ç™»å½•é¡µé¢ï¼ˆP1ï¼‰

**ä¼˜å…ˆçº§**ï¼šP1  
**å·¥ä½œé‡**ï¼š2 å¤©

**å®æ–½æ­¥éª¤**ï¼š

1. åˆ›å»ºç™»å½•é¡µé¢
   ```typescript
   // app/login/page.tsx
   'use client';

   import { useState } from 'react';
   { Button } from '@/components/ui/button';
   { Input } from '@/components/ui/input';
   { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';

   export default function LoginPage() {
     const [username, setUsername] = useState('');
     const [password, setPassword] = useState('');
     const [isLoading, setIsLoading] = useState(false);
     const [error, setError] = useState('');

     const handleLogin = async (e: React.FormEvent) => {
       e.preventDefault();
       setIsLoading(true);
       setError('');

       try {
         const res = await fetch('/api/auth/login', {
           method: 'POST',
           headers: { 'Content-Type': 'application/json' },
           body: JSON.stringify({ username, password })
         });

         const data = await res.json();

         if (data.success) {
           // ä¿å­˜ token
           localStorage.setItem('token', data.data.token);
           localStorage.setItem('refreshToken', data.data.refreshToken);
           localStorage.setItem('user', JSON.stringify(data.data.user));
           
           // è·³è½¬åˆ°é¦–é¡µ
           window.location.href = '/';
         } else {
           setError(data.error || 'ç™»å½•å¤±è´¥');
         }
       } catch (err) {
         setError('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•');
       } finally {
         setIsLoading(false);
       }
     };

     return (
       <div className="min-h-screen flex items-center justify-center bg-gray-100">
         <Card className="w-full max-w-md">
           <CardHeader>
             <CardTitle className="text-2xl text-center">WorkTool AI</CardTitle>
           </CardHeader>
           <CardContent>
             <form onSubmit={handleLogin} className="space-y-4">
               <div>
                 <label className="block text-sm font-medium mb-1">ç”¨æˆ·å</label>
                 <Input
                   type="text"
                   value={username}
                   onChange={(e) => setUsername(e.target.value)}
                   placeholder="è¯·è¾“å…¥ç”¨æˆ·å"
                   required
                 />
               </div>
               <div>
                 <label className="block text-sm font-medium mb-1">å¯†ç </label>
                 <Input
                   type="password"
                   value={password}
                   onChange={(e) => setPassword(e.target.value)}
                   placeholder="è¯·è¾“å…¥å¯†ç "
                   required
                 />
               </div>
               {error && (
                 <div className="text-red-500 text-sm">{error}</div>
               )}
               <Button type="submit" className="w-full" disabled={isLoading}>
                 {isLoading ? 'ç™»å½•ä¸­...' : 'ç™»å½•'}
               </Button>
             </form>
           </CardContent>
         </Card>
       </div>
     );
   }
   ```

2. åˆ›å»º Auth Context
   ```typescript
   // contexts/AuthContext.tsx
   'use client';

   import React, { createContext, useContext, useState, useEffect } from 'react';

   interface User {
     id: string;
     username: string;
     email: string | null;
     role: string;
   }

   interface AuthContextType {
     user: User | null;
     token: string | null;
     login: (username: string, password: string) => Promise<void>;
     logout: () => void;
     isAuthenticated: boolean;
   }

   const AuthContext = createContext<AuthContextType | undefined>(undefined);

   export function AuthProvider({ children }: { children: React.ReactNode }) {
     const [user, setUser] = useState<User | null>(null);
     const [token, setToken] = useState<string | null>(null);
     const [isLoading, setIsLoading] = useState(true);

     useEffect(() => {
       // ä» localStorage æ¢å¤ç™»å½•çŠ¶æ€
       const savedToken = localStorage.getItem('token');
       const savedUser = localStorage.getItem('user');
       
       if (savedToken && savedUser) {
         setToken(savedToken);
         setUser(JSON.parse(savedUser));
       }
       setIsLoading(false);
     }, []);

     const login = async (username: string, password: string) => {
       const res = await fetch('/api/auth/login', {
         method: 'POST',
         headers: { 'Content-Type': 'application/json' },
         body: JSON.stringify({ username, password })
       });

       const data = await res.json();

       if (data.success) {
         setToken(data.data.token);
         setUser(data.data.user);
         localStorage.setItem('token', data.data.token);
         localStorage.setItem('refreshToken', data.data.refreshToken);
         localStorage.setItem('user', JSON.stringify(data.data.user));
       } else {
         throw new Error(data.error || 'ç™»å½•å¤±è´¥');
       }
     };

     const logout = () => {
       setToken(null);
       setUser(null);
       localStorage.removeItem('token');
       localStorage.removeItem('refreshToken');
       localStorage.removeItem('user');
       window.location.href = '/login';
     };

     return (
       <AuthContext.Provider
         value={{
           user,
           token,
           login,
           logout,
           isAuthenticated: !!token && !!user
         }}
       >
         {!isLoading && children}
       </AuthContext.Provider>
     );
   }

   export function useAuth() {
     const context = useContext(AuthContext);
     if (context === undefined) {
       throw new Error('useAuth must be used within an AuthProvider');
     }
     return context;
   }
   ```

3. æ·»åŠ è®¤è¯å®ˆå«
   ```typescript
   // components/AuthGuard.tsx
   'use client';

   import { useEffect } from 'react';
   { useAuth } from '@/contexts/AuthContext';
   { useRouter } from 'next/navigation';

   export function AuthGuard({ children }: { children: React.ReactNode }) {
     const { isAuthenticated } = useAuth();
     const router = useRouter();

     useEffect(() => {
       if (!isAuthenticated) {
         router.push('/login');
       }
     }, [isAuthenticated, router]);

     if (!isAuthenticated) {
       return <div>æ­£åœ¨è·³è½¬...</div>;
     }

     return <>{children}</>;
   }
   ```

**éªŒæ”¶æ ‡å‡†**ï¼š
- âœ… ç™»å½•é¡µé¢æ˜¾ç¤ºæ­£å¸¸
- âœ… ç™»å½•æˆåŠŸåè·³è½¬é¦–é¡µ
- âœ… Token æ­£ç¡®ä¿å­˜
- âœ… æœªç™»å½•è‡ªåŠ¨è·³è½¬ç™»å½•é¡µ

---

#### ä»»åŠ¡ 3.2ï¼šä¿®æ”¹ç”¨æˆ·ç®¡ç†é¡µé¢ï¼ˆP1ï¼‰

**ä¼˜å…ˆçº§**ï¼šP1  
**å·¥ä½œé‡**ï¼š2 å¤©

**å®æ–½æ­¥éª¤**ï¼š

1. æ·»åŠ æƒé™æ§åˆ¶
   ```typescript
   // components/user-management.tsx
   'use client';

   import { useAuth } from '@/contexts/AuthContext';

   export default function UserManagement() {
     const { user } = useAuth();
     const [users, setUsers] = useState<any[]>([]);

     // æ£€æŸ¥æƒé™
     const canCreateUser = user?.role === 'admin';
     const canEditUser = user?.role === 'admin';
     const canDeleteUser = user?.role === 'admin';
     const canViewUsers = ['admin', 'operator', 'viewer'].includes(user?.role || '');

     useEffect(() => {
       if (!canViewUsers) return;
       loadUsers();
     }, [canViewUsers]);

     const loadUsers = async () => {
       const res = await fetch('/api/admin/users', {
         headers: {
           'Authorization': `Bearer ${localStorage.getItem('token')}`
         }
       });
       // ...
     };

     return (
       <div>
         {/* æ“ä½œæŒ‰é’®æ ¹æ®æƒé™æ˜¾ç¤º */}
         {canCreateUser && (
           <Button onClick={() => setShowAddDialog(true)}>
             <UserPlus className="h-4 w-4 mr-2" />
             æ·»åŠ ç”¨æˆ·
           </Button>
         )}

         {/* ç”¨æˆ·åˆ—è¡¨ */}
         {users.map((user) => (
           <div key={user.id}>
             {/* ç¼–è¾‘å’Œåˆ é™¤æŒ‰é’®æ ¹æ®æƒé™æ˜¾ç¤º */}
             {canEditUser && (
               <Button onClick={() => handleEditUser(user)}>
                 <Edit2 className="h-4 w-4" />
               </Button>
             )}
             {canDeleteUser && (
               <Button onClick={() => handleDeleteUser(user.id)}>
                 <Trash2 className="h-4 w-4" />
               </Button>
             )}
           </div>
         ))}
       </div>
     );
   }
   ```

2. æ·»åŠ å¯†ç å¼ºåº¦æ£€æŸ¥
   ```typescript
   function checkPasswordStrength(password: string) {
     let score = 0;
     if (password.length >= 8) score++;
     if (password.length >= 12) score++;
     if (/[a-z]/.test(password)) score++;
     if (/[A-Z]/.test(password)) score++;
     if (/[0-9]/.test(password)) score++;
     if (/[^a-zA-Z0-9]/.test(password)) score++;

     if (score <= 2) return { level: 'weak', text: 'å¼±', color: 'red' };
     if (score <= 4) return { level: 'medium', text: 'ä¸­', color: 'yellow' };
     return { level: 'strong', text: 'å¼º', color: 'green' };
   }
   ```

**éªŒæ”¶æ ‡å‡†**ï¼š
- âœ… å‰ç«¯æƒé™æ§åˆ¶ç”Ÿæ•ˆ
- âœ… æ ¹æ®æƒé™æ˜¾ç¤º/éšè—åŠŸèƒ½
- âœ… å¯†ç å¼ºåº¦æ£€æŸ¥æ­£å¸¸
- âœ… é”™è¯¯æç¤ºå‹å¥½

---

#### ä»»åŠ¡ 3.3ï¼šå®ç° Token è‡ªåŠ¨åˆ·æ–°ï¼ˆP1ï¼‰

**ä¼˜å…ˆçº§**ï¼šP1  
**å·¥ä½œé‡**ï¼š1 å¤©

**å®æ–½æ­¥éª¤**ï¼š

1. åˆ›å»º HTTP å®¢æˆ·ç«¯å°è£…
   ```typescript
   // lib/api-client.ts
   import axios, { AxiosInstance, InternalAxiosRequestConfig } from 'axios';

   class ApiClient {
     private client: AxiosInstance;
     private refreshPromise: Promise<string> | null = null;

     constructor() {
       this.client = axios.create({
         baseURL: process.env.NEXT_PUBLIC_API_URL || 'http://localhost:5001',
         timeout: 30000
       });

       // è¯·æ±‚æ‹¦æˆªå™¨
       this.client.interceptors.request.use((config) => {
         const token = localStorage.getItem('token');
         if (token) {
           config.headers.Authorization = `Bearer ${token}`;
         }
         return config;
       });

       // å“åº”æ‹¦æˆªå™¨
       this.client.interceptors.response.use(
         (response) => response,
         async (error) => {
           const originalRequest = error.config;

           // Token è¿‡æœŸï¼Œå°è¯•åˆ·æ–°
           if (error.response?.status === 401 && !originalRequest._retry) {
             originalRequest._retry = true;

             try {
               const newToken = await this.refreshToken();
               originalRequest.headers.Authorization = `Bearer ${newToken}`;
               return this.client(originalRequest);
             } catch (refreshError) {
               // åˆ·æ–°å¤±è´¥ï¼Œè·³è½¬åˆ°ç™»å½•é¡µ
               localStorage.clear();
               window.location.href = '/login';
               return Promise.reject(refreshError);
             }
           }

           return Promise.reject(error);
         }
       );
     }

     private async refreshToken(): Promise<string> {
       // é¿å…å¹¶å‘åˆ·æ–°
       if (this.refreshPromise) {
         return this.refreshPromise;
       }

       this.refreshPromise = (async () => {
         const refreshToken = localStorage.getItem('refreshToken');
         if (!refreshToken) {
           throw new Error('No refresh token');
         }

         const res = await fetch('/api/auth/refresh', {
           method: 'POST',
           headers: { 'Content-Type': 'application/json' },
           body: JSON.stringify({ refreshToken })
         });

         const data = await res.json();

         if (data.success) {
           localStorage.setItem('token', data.data.token);
           localStorage.setItem('refreshToken', data.data.refreshToken);
           return data.data.token;
         }

         throw new Error('Token refresh failed');
       })();

       const token = await this.refreshPromise;
       this.refreshPromise = null;
       return token;
     }

     async get<T>(url: string, params?: any) {
       const res = await this.client.get<T>(url, { params });
       return res.data;
     }

     async post<T>(url: string, data: any) {
       const res = await this.client.post<T>(url, data);
       return res.data;
     }

     async put<T>(url: string, data: any) {
       const res = await this.client.put<T>(url, data);
       return res.data;
     }

     async delete<T>(url: string) {
       const res = await this.client.delete<T>(url);
       return res.data;
     }
   }

   export const apiClient = new ApiClient();
   ```

**éªŒæ”¶æ ‡å‡†**ï¼š
- âœ… Token è¿‡æœŸè‡ªåŠ¨åˆ·æ–°
- âœ… åˆ·æ–°å¤±è´¥è·³è½¬ç™»å½•
- âœ… é¿å…å¹¶å‘åˆ·æ–°è¯·æ±‚

---

### 3.4 ç¬¬å››é˜¶æ®µï¼šæµ‹è¯•å’Œä¼˜åŒ–ï¼ˆ1 å‘¨ï¼‰

#### ä»»åŠ¡ 4.1ï¼šç¼–å†™å•å…ƒæµ‹è¯•ï¼ˆP2ï¼‰

**ä¼˜å…ˆçº§**ï¼šP2  
**å·¥ä½œé‡**ï¼š3 å¤©

**æµ‹è¯•è¦†ç›–èŒƒå›´**ï¼š
- UserManager æµ‹è¯•
- AuthService æµ‹è¯•
- RBACService æµ‹è¯•
- AuditLogManager æµ‹è¯•

#### ä»»åŠ¡ 4.2ï¼šç¼–å†™é›†æˆæµ‹è¯•ï¼ˆP2ï¼‰

**ä¼˜å…ˆçº§**ï¼šP2  
**å·¥ä½œé‡**ï¼š2 å¤©

**æµ‹è¯•åœºæ™¯**ï¼š
- å®Œæ•´çš„ç™»å½•æµç¨‹
- ç”¨æˆ· CRUD æµç¨‹
- æƒé™æ£€æŸ¥æµç¨‹
- å®¡è®¡æ—¥å¿—è®°å½•æµç¨‹

#### ä»»åŠ¡ 4.3ï¼šæ€§èƒ½ä¼˜åŒ–ï¼ˆP2ï¼‰

**ä¼˜å…ˆçº§**ï¼šP2  
**å·¥ä½œé‡**ï¼š2 å¤©

**ä¼˜åŒ–é¡¹**ï¼š
- æƒé™ç¼“å­˜ä¼˜åŒ–
- å®¡è®¡æ—¥å¿—æŸ¥è¯¢ä¼˜åŒ–ï¼ˆæ·»åŠ ç´¢å¼•ï¼‰
- Token éªŒè¯æ€§èƒ½ä¼˜åŒ–

---

## 4. æ•´æ”¹æ—¶é—´è¡¨

| é˜¶æ®µ | ä»»åŠ¡ | ä¼˜å…ˆçº§ | é¢„è®¡æ—¶é—´ | ä¾èµ– |
|------|------|--------|----------|------|
| **ç¬¬ä¸€é˜¶æ®µï¼šå®‰å…¨åŠ å›º** | | | **1-2 å‘¨** | |
| 1.1 | å¯†ç åŠ å¯†æ”¹é€  | P0 | 2 å¤© | - |
| 1.2 | JWT è®¤è¯å®ç° | P0 | 3 å¤© | 1.1 |
| 1.3 | å®¡è®¡æ—¥å¿—å®ç° | P0 | 2 å¤© | 1.1 |
| **ç¬¬äºŒé˜¶æ®µï¼šRBAC æƒé™ç®¡ç†** | | | **2 å‘¨** | ç¬¬ä¸€é˜¶æ®µ |
| 2.1 | RBAC æ¨¡å‹è®¾è®¡å’Œå®ç° | P1 | 4 å¤© | - |
| 2.2 | ç”¨æˆ·è¡¨æ”¯æŒå¤šè§’è‰² | P2 | 2 å¤© | 2.1 |
| **ç¬¬ä¸‰é˜¶æ®µï¼šå‰ç«¯å®ç°** | | | **1-2 å‘¨** | ç¬¬äºŒé˜¶æ®µ |
| 3.1 | ç™»å½•é¡µé¢å®ç° | P1 | 2 å¤© | - |
| 3.2 | ç”¨æˆ·ç®¡ç†é¡µé¢ä¿®æ”¹ | P1 | 2 å¤© | 3.1 |
| 3.3 | Token è‡ªåŠ¨åˆ·æ–° | P1 | 1 å¤© | 3.1 |
| **ç¬¬å››é˜¶æ®µï¼šæµ‹è¯•å’Œä¼˜åŒ–** | | | **1 å‘¨** | ç¬¬ä¸‰é˜¶æ®µ |
| 4.1 | å•å…ƒæµ‹è¯•ç¼–å†™ | P2 | 3 å¤© | - |
| 4.2 | é›†æˆæµ‹è¯•ç¼–å†™ | P2 | 2 å¤© | 4.1 |
| 4.3 | æ€§èƒ½ä¼˜åŒ– | P2 | 2 å¤© | - |
| **æ€»è®¡** | | | **5-7 å‘¨** | |

---

## 5. é£é™©è¯„ä¼°

| é£é™© | æ¦‚ç‡ | å½±å“ | åº”å¯¹æªæ–½ |
|------|------|------|----------|
| **å¯†ç è¿ç§»å¤±è´¥** | ä¸­ | é«˜ | æå‰å¤‡ä»½æ•°æ®åº“ï¼Œå‡†å¤‡å›æ»šè„šæœ¬ |
| **JWT å…¼å®¹æ€§é—®é¢˜** | ä½ | ä¸­ | å……åˆ†æµ‹è¯•ï¼Œæ”¯æŒå¹³æ»‘è¿ç§» |
| **æƒé™é…ç½®é”™è¯¯** | ä¸­ | é«˜ | è¯¦ç»†æ–‡æ¡£ï¼Œåˆå§‹åŒ–è„šæœ¬éªŒè¯ |
| **å‰ç«¯çŠ¶æ€ç®¡ç†æ··ä¹±** | ä¸­ | ä¸­ | ä½¿ç”¨ Context APIï¼Œå……åˆ†æµ‹è¯• |
| **Token åˆ·æ–°é€»è¾‘å¤æ‚** | ä½ | ä¸­ | ç®€åŒ–é€»è¾‘ï¼Œæ·»åŠ è¯¦ç»†æ—¥å¿— |

---

## 6. éªŒæ”¶æ ‡å‡†

### 6.1 åŠŸèƒ½éªŒæ”¶
- âœ… ç”¨æˆ·å¯ä»¥ç™»å½•å¹¶è·å– JWT Token
- âœ… Token å¯ä»¥è‡ªåŠ¨åˆ·æ–°
- âœ… å¯†ç åŠ å¯†å­˜å‚¨ï¼ˆbcryptï¼‰
- âœ… RBAC æƒé™æ¨¡å‹æ­£å¸¸å·¥ä½œ
- âœ… å®¡è®¡æ—¥å¿—æ­£ç¡®è®°å½•
- âœ… å‰ç«¯æƒé™æ§åˆ¶ç”Ÿæ•ˆ

### 6.2 å®‰å…¨éªŒæ”¶
- âœ… å¯†ç ä¸ä»¥æ˜æ–‡å½¢å¼å­˜å‚¨
- âœ… Token è¿‡æœŸèƒ½æ­£ç¡®éªŒè¯
- âœ… æœªè®¤è¯è¯·æ±‚è¿”å› 401
- âœ… æƒé™ä¸è¶³è¿”å› 403
- âœ… æ‰€æœ‰å…³é”®æ“ä½œéƒ½æœ‰å®¡è®¡æ—¥å¿—

### 6.3 æ€§èƒ½éªŒæ”¶
- âœ… ç™»å½•å“åº”æ—¶é—´ < 500ms
- âœ… æƒé™æ£€æŸ¥å“åº”æ—¶é—´ < 50msï¼ˆå¸¦ç¼“å­˜ï¼‰
- âœ… å®¡è®¡æ—¥å¿—æŸ¥è¯¢å“åº”æ—¶é—´ < 200ms

---

## 7. åç»­å»ºè®®

### 7.1 çŸ­æœŸï¼ˆ1-2 ä¸ªæœˆï¼‰
1. å®ç°ç”¨æˆ·ç»„åŠŸèƒ½ï¼Œä¾¿äºæ‰¹é‡ç®¡ç†
2. å®ç°å¯†ç ç­–ç•¥ï¼ˆå¤æ‚åº¦è¦æ±‚ã€è¿‡æœŸæ—¶é—´ï¼‰
3. å®ç°ç™»å½•å¤±è´¥é”å®šæœºåˆ¶
4. å®ç°åŒå› ç´ è®¤è¯ï¼ˆ2FAï¼‰

### 7.2 ä¸­æœŸï¼ˆ3-6 ä¸ªæœˆï¼‰
1. å®ç°å•ç‚¹ç™»å½•ï¼ˆSSOï¼‰
2. å®ç°ç”¨æˆ·æ´»åŠ¨ç›‘æ§
3. å®ç°å¯†ç é‡ç½®åŠŸèƒ½ï¼ˆé‚®ä»¶éªŒè¯ï¼‰
4. å®ç°ç”¨æˆ·è‡ªåŠ©ä¿®æ”¹å¯†ç 

### 7.3 é•¿æœŸï¼ˆ6 ä¸ªæœˆä»¥ä¸Šï¼‰
1. é›†æˆä¼ä¸šå¾®ä¿¡/é’‰é’‰ç™»å½•
2. å®ç° OAuth2.0 æ”¯æŒ
3. å®ç°ç”¨æˆ·è¡Œä¸ºåˆ†æ
4. å®ç°ç”¨æˆ·ç”»åƒ

---

## 8. é™„å½•

### 8.1 æ•°æ®åº“è¿ç§»è„šæœ¬æ¸…å•

| è„šæœ¬ | ç”¨é€” | ä¼˜å…ˆçº§ |
|------|------|--------|
| `scripts/migrate-passwords.js` | å¯†ç åŠ å¯†è¿ç§» | P0 |
| `scripts/init-rbac.js` | åˆå§‹åŒ–è§’è‰²æƒé™ | P0 |
| `scripts/create-rbac-tables.sql` | åˆ›å»º RBAC è¡¨ | P0 |

### 8.2 API ç«¯ç‚¹æ¸…å•

| ç«¯ç‚¹ | æ–¹æ³• | è®¤è¯ | æƒé™ | æè¿° |
|------|------|------|------|------|
| `/api/auth/login` | POST | å¦ | - | ç”¨æˆ·ç™»å½• |
| `/api/auth/refresh` | POST | å¦ | - | åˆ·æ–° Token |
| `/api/auth/logout` | POST | æ˜¯ | - | ç”¨æˆ·ç™»å‡º |
| `/api/admin/users` | GET | æ˜¯ | user:read | è·å–ç”¨æˆ·åˆ—è¡¨ |
| `/api/admin/users` | POST | æ˜¯ | user:write | åˆ›å»ºç”¨æˆ· |
| `/api/admin/users/:id` | PUT | æ˜¯ | user:write | æ›´æ–°ç”¨æˆ· |
| `/api/admin/users/:id` | DELETE | æ˜¯ | user:delete | åˆ é™¤ç”¨æˆ· |
| `/api/admin/audit-logs` | GET | æ˜¯ | audit:read | è·å–å®¡è®¡æ—¥å¿— |

### 8.3 ç¯å¢ƒå˜é‡

```bash
# JWT é…ç½®
JWT_SECRET=your-secret-key-at-least-32-characters-long
JWT_EXPIRES_IN=24h

# å¯†ç åŠ å¯†
BCRYPT_ROUNDS=10
```

---

## ç»“è¯­

æœ¬è®¡åˆ’ä¹¦è¯¦ç»†è§„åˆ’äº†ç”¨æˆ·ç®¡ç†ç³»ç»Ÿçš„æ”¹é€ æ–¹æ¡ˆï¼Œæ¶µç›–äº†å®‰å…¨æ€§ã€è®¤è¯æˆæƒã€æƒé™ç®¡ç†ã€å®¡è®¡æ—¥å¿—ç­‰å¤šä¸ªæ–¹é¢ã€‚æ•´æ”¹å®Œæˆåï¼Œç”¨æˆ·ç®¡ç†ç³»ç»Ÿå°†æ»¡è¶³ã€Šç³»ç»Ÿæ•´æ”¹è®¡åˆ’ä¹¦ã€‹ä¸­çš„å®‰å…¨è¦æ±‚ï¼Œä¸ºæ•´ä¸ªç³»ç»Ÿæä¾›å¯é çš„èº«ä»½è®¤è¯å’Œæƒé™æ§åˆ¶åŸºç¡€ã€‚

**ä¸‹ä¸€æ­¥è¡ŒåŠ¨**ï¼š
1. å®¡æ ¸æœ¬è®¡åˆ’ä¹¦
2. ç¡®è®¤èµ„æºåˆ†é…
3. å¼€å§‹ç¬¬ä¸€é˜¶æ®µï¼šå¯†ç åŠ å¯†æ”¹é€ 

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0  
**æœ€åæ›´æ–°**ï¼š2026-02-04  
**ç»´æŠ¤è€…**ï¼šå¼€å‘å›¢é˜Ÿ  
**çŠ¶æ€**ï¼šå¾…è¯„å®¡
