# 流程路由与选择机制

## 📋 概述

WorkTool AI 2.1 引入了智能流程路由与选择机制，解决了原有系统中多个流程并行执行、缺少优先级控制、缺乏默认流程管理等问题。

## 🔍 核心问题

### 原有问题

在旧版本中，当消息进入系统时，流程选择逻辑如下：

```javascript
// 1. 查询所有活跃的Webhook流程
const webhookFlows = await flowEngine.listFlowDefinitions({
  isActive: true,
  triggerType: TriggerType.WEBHOOK
});

// 2. 遍历所有流程，检查robotId匹配
for (const flowDef of webhookFlows) {
  if (triggerConfig.robotId && triggerConfig.robotId !== robot.robotId) {
    continue;
  }
  // 为每个匹配的流程创建实例并执行
  await flowEngine.createFlowInstance(flowDef.id, ...);
}

// 3. 所有匹配的流程并行执行
```

**存在的问题：**

1. ❌ **多个流程并行执行**：如果3个流程都匹配，会同时执行3个流程
2. ❌ **没有优先级**：无法指定哪个流程应该优先执行
3. ❌ **忽略 `isDefault` 标记**：虽然我们标记了"标准客服流程"为默认流程，但在选择逻辑中并未使用
4. ❌ **没有流程路由策略**：缺乏基于业务规则的智能选择

## ✅ 解决方案

### 核心组件

#### 1. FlowSelector（流程选择器）

**文件位置：** `server/services/flow-selector.service.js`

**核心功能：**
- 智能流程选择：根据业务规则、优先级、触发条件选择合适的流程
- 默认流程优先：优先执行 `isDefault=true` 的流程
- 流程优先级：根据 `priority` 字段排序，选择优先级最高的流程
- 触发条件匹配：根据 `triggerConfig` 中的规则精确匹配
- 机器人绑定：支持流程绑定到特定机器人

**选择策略：**

| 策略名称 | 值 | 描述 |
|---------|---|------|
| 默认流程优先 | `default_first` | 优先执行标记为默认的流程，如果没有默认流程则执行第一个匹配的流程 |
| 最高优先级 | `highest_priority` | 选择优先级（priority字段）最高的流程执行 |
| 全部匹配流程 | `all_matched` | 执行所有匹配的流程（可能并行执行多个流程） |
| 单一流程 | `single` | 只执行一个优先级最高的流程，防止并发 |

**默认策略：** `default_first`

#### 2. FlowEngine（流程引擎）

**文件位置：** `server/services/flow-engine.service.js`

**新增方法：**

1. **`routeFlows(context)`**
   - 功能：根据上下文自动选择合适的流程
   - 参数：
     - `robotId`: 机器人ID
     - `triggerType`: 触发类型
     - `message`: 消息对象（可选）
     - `strategy`: 选择策略（可选）
   - 返回：选择的流程定义列表

2. **`executeRoutedFlows(flows, triggerData, metadata)`**
   - 功能：批量创建并执行流程实例
   - 参数：
     - `flows`: 流程定义列表
     - `triggerData`: 触发数据
     - `metadata`: 元数据
   - 返回：创建的流程实例列表

## 🚀 工作流程

### 消息处理流程

```
1. 消息进入系统
   ↓
2. 调用 flowEngine.routeFlows(context)
   - context = { robotId, triggerType: 'webhook', message, strategy: 'default_first' }
   ↓
3. FlowSelector.selectFlows(context)
   - 查询所有活跃的流程定义
   - 根据 strategy 进行排序（默认优先）
   - 过滤匹配的流程（检查 robotId）
   - 根据策略返回结果（只返回默认流程）
   ↓
4. flowEngine.executeRoutedFlows(selectedFlows, triggerData, metadata)
   - 为每个选中的流程创建实例
   - 异步执行流程
   ↓
5. 返回结果给消息回调
```

## 📊 流程优先级

### 优先级分配

| 流程名称 | 优先级 | 说明 |
|---------|--------|------|
| 标准客服流程 | 100 | 最高优先级，作为默认流程 |
| 风险处理流程 | 90 | 第二优先级 |
| 人工接管流程 | 80 | 第三优先级 |
| 告警升级流程 | 70 | 第四优先级 |
| 智能监控流程 | 60 | 第五优先级 |
| 完整流程 | 50 | 最低优先级 |

### 流程配置示例

```json
{
  "id": "flow_v4_standard_customer_service",
  "name": "标准客服流程（默认）",
  "version": "4.0.0",
  "isDefault": true,
  "priority": 100,
  "triggerType": "webhook",
  ...
}
```

## 🔧 使用示例

### 示例1：默认流程优先策略

```javascript
const selectedFlows = await flowEngine.routeFlows({
  robotId: 'robot_123',
  triggerType: 'webhook',
  message: { spoken: '你好' },
  strategy: 'default_first'
});

// 结果：只返回一个流程（isDefault=true 的流程）
console.log(selectedFlows);
// [{ id: 'flow_xxx', name: '标准客服流程', isDefault: true }]
```

### 示例2：最高优先级策略

```javascript
const selectedFlows = await flowEngine.routeFlows({
  robotId: 'robot_123',
  triggerType: 'webhook',
  message: { spoken: '你好' },
  strategy: 'highest_priority'
});

// 结果：返回优先级最高的流程
console.log(selectedFlows);
// [{ id: 'flow_xxx', name: '标准客服流程', priority: 100 }]
```

## 📝 数据库Schema

### 新增字段

| 字段名 | 类型 | 默认值 | 说明 |
|-------|------|--------|------|
| `is_default` | BOOLEAN | `false` | 是否为默认流程 |
| `priority` | INTEGER | `0` | 优先级（数字越大优先级越高） |

### 新增索引

- `flow_definitions_is_default_idx`: 加速默认流程查询
- `flow_definitions_priority_idx`: 加速优先级排序

## 🎯 最佳实践

### 1. 默认流程设置

- 每个机器人应该有一个默认流程
- 默认流程应该是处理常规消息的标准流程
- 使用 `flowSelector.setDefaultFlow(flowId, robotId)` 设置

### 2. 优先级配置

- 优先级范围建议：1-100
- 100：最高优先级（默认流程）
- 90-99：高优先级（如风险处理）
- 70-89：中优先级（如人工接管）
- 50-69：低优先级（如监控流程）
- 1-49：最低优先级（如演示流程）

### 3. 选择策略选择

- **生产环境**：建议使用 `default_first` 或 `single`
- **测试环境**：可以使用 `all_matched` 测试多个流程
- **特殊场景**：根据业务需求选择合适的策略

## 📚 相关文档

- [流程路由与选择机制详细说明](/docs/流程路由与选择机制.md)
- [流程路由机制实现总结](/docs/流程路由机制实现总结.md)
- [数据库迁移脚本](../database/migrations/add_flow_routing_fields.js)
- [测试脚本](../tests/test-flow-selector.js)
