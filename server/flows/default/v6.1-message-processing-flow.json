{
  "id": "flow_message_processing_v6_1",
  "name": "å®Œæ•´çš„æ–‡æœ¬æ¶ˆæ¯å¤„ç†æµç¨‹",
  "description": "ä»æœºå™¨äººæ£€æµ‹æ–°æ¶ˆæ¯åˆ°AIå›å¤çš„å®Œæ•´å¤„ç†æµç¨‹ï¼ŒåŒ…å«è§’è‰²è¯†åˆ«ã€ä¸Šä¸‹æ–‡åˆ†æã€ååŒåˆ†æã€æ„å›¾åˆ¤æ–­ã€AIå›å¤ç­‰",
  "version": "6.1.0",
  "isDefault": true,
  "priority": 99,
  "category": "æ ¸å¿ƒæµç¨‹",
  "tags": ["æ¶ˆæ¯å¤„ç†", "AIå›å¤", "ååŒåˆ†æ"],
  "triggerType": "webhook",
  "triggerConfig": {
    "webhookUrl": "/api/messages/receive",
    "eventType": "message",
    "method": "POST"
  },
  "nodes": [
    {
      "id": "node_start",
      "type": "start",
      "name": "å¼€å§‹",
      "position": { "x": 50, "y": 100 },
      "data": {
        "name": "å¼€å§‹",
        "description": "æµç¨‹å¼€å§‹",
        "icon": "â–¶ï¸",
        "color": "bg-green-500"
      }
    },
    {
      "id": "node_message_receive",
      "type": "multi_task_message",
      "name": "æ¶ˆæ¯æ¥æ”¶ä¸ä¿å­˜",
      "position": { "x": 250, "y": 100 },
      "data": {
        "name": "æ¶ˆæ¯æ¥æ”¶ä¸ä¿å­˜",
        "description": "æœºå™¨äººæ£€æµ‹åˆ°æ–°æ¶ˆæ¯å¹¶ä¸ŠæŠ¥åˆ°ç³»ç»Ÿï¼Œç³»ç»Ÿä¿å­˜æ¶ˆæ¯åˆ°æ•°æ®åº“",
        "icon": "ğŸ“¨",
        "color": "bg-green-500",
        "config": {
          "executeMode": "sequential",
          "failFast": true,
          "tasks": [
            {
              "id": "task_receive_message",
              "operation": "receive",
              "config": {
                "apiEndpoint": "/api/messages/receive",
                "fields": ["robot_id", "robot_type", "group_id", "group_name", "sender", "message"],
                "outputField": "receivedMessage"
              }
            },
            {
              "id": "task_deduplicate",
              "operation": "query",
              "config": {
                "queryType": "deduplicate",
                "deduplicateBy": "message_id",
                "outputField": "isDuplicate"
              }
            },
            {
              "id": "task_save_message",
              "operation": "dispatch",
              "config": {
                "condition": "isDuplicate === false",
                "action": "save",
                "table": "session_messages",
                "dataField": "receivedMessage",
                "outputField": "savedMessageId"
              }
            }
          ]
        }
      }
    },
    {
      "id": "node_role_identify",
      "type": "multi_task_data",
      "name": "è§’è‰²è¯†åˆ«",
      "position": { "x": 450, "y": 100 },
      "data": {
        "name": "è§’è‰²è¯†åˆ«",
        "description": "è¯†åˆ«å‘é€è€…è§’è‰²ï¼ˆç›‘æ§æœºå™¨äººã€é€šçŸ¥æœºå™¨äººã€ç™½ç­å›å¤æœºå™¨äººã€æ™šç­å›å¤æœºå™¨äººã€å”®åã€ç”¨æˆ·ã€è¿è¥ï¼‰",
        "icon": "ğŸ—„ï¸",
        "color": "bg-blue-500",
        "config": {
          "executeMode": "sequential",
          "failFast": true,
          "tasks": [
            {
              "id": "task_identify_robot",
              "operation": "query",
              "config": {
                "queryType": "role_identify",
                "roleType": "robot",
                "identifyBy": "robot_id",
                "outputField": "robotRole"
              }
            },
            {
              "id": "task_identify_staff",
              "operation": "query",
              "config": {
                "queryType": "role_identify",
                "roleType": "staff",
                "identifyBy": "enterprise_name",
                "outputField": "staffRole"
              }
            },
            {
              "id": "task_identify_operator",
              "operation": "query",
              "config": {
                "queryType": "role_identify",
                "roleType": "operator",
                "identifyBy": "whitelist",
                "outputField": "operatorRole"
              }
            },
            {
              "id": "task_determine_sender_type",
              "operation": "transform",
              "config": {
                "transformType": "sender_type",
                "robotRoleField": "robotRole",
                "staffRoleField": "staffRole",
                "operatorRoleField": "operatorRole",
                "outputField": "senderType"
              }
            }
          ]
        }
      }
    },
    {
      "id": "node_push_monitor",
      "type": "multi_task_message",
      "name": "æ¨é€ç›‘æ§é¢æ¿",
      "position": { "x": 650, "y": 100 },
      "data": {
        "name": "æ¨é€ç›‘æ§é¢æ¿",
        "description": "æ¨é€æ¶ˆæ¯åˆ°ä¼šè¯ç®¡ç†ä¸šåŠ¡æ¶ˆæ¯ç›‘æ§åˆ—è¡¨ã€AIäº¤äº’ç›‘æ§ã€å·¥ä½œäººå‘˜ç›‘æ§å¤§å±",
        "icon": "ğŸ“¨",
        "color": "bg-green-500",
        "config": {
          "executeMode": "parallel",
          "failFast": false,
          "tasks": [
            {
              "id": "task_push_business_monitor",
              "operation": "dispatch",
              "config": {
                "target": "business_message_monitor",
                "dataField": "receivedMessage"
              }
            },
            {
              "id": "task_push_ai_monitor",
              "operation": "dispatch",
              "config": {
                "target": "ai_interaction_monitor",
                "dataField": "receivedMessage"
              }
            },
            {
              "id": "task_push_staff_monitor",
              "operation": "dispatch",
              "config": {
                "target": "staff_monitor_dashboard",
                "dataField": "receivedMessage"
              }
            }
          ]
        }
      }
    },
    {
      "id": "node_context_analysis",
      "type": "context",
      "name": "ä¸Šä¸‹æ–‡æ£€ç´¢ä¸å¢å¼º",
      "position": { "x": 850, "y": 100 },
      "data": {
        "name": "ä¸Šä¸‹æ–‡æ£€ç´¢ä¸å¢å¼º",
        "description": "æ£€ç´¢å†å²æ¶ˆæ¯ä¸Šä¸‹æ–‡ã€ç”¨æˆ·ç”»åƒã€å·¥ä½œäººå‘˜çŠ¶æ€ã€å”®åä»»åŠ¡çŠ¶æ€ã€ç¾¤èŠä¿¡æ¯",
        "icon": "ğŸ”®",
        "color": "bg-indigo-600",
        "config": {
          "windowSize": 20,
          "includeUserProfile": true,
          "includeStaffStatus": true,
          "includeAfterSalesTasks": true,
          "includeGroupInfo": true
        }
      }
    },
    {
      "id": "node_decision_sender_type",
      "type": "decision",
      "name": "å‘é€è€…ç±»å‹åˆ¤æ–­",
      "position": { "x": 1050, "y": 100 },
      "data": {
        "name": "å‘é€è€…ç±»å‹åˆ¤æ–­",
        "description": "æ ¹æ®å‘é€è€…ç±»å‹åˆ†æµå¤„ç†",
        "icon": "ğŸ”€",
        "color": "bg-orange-500",
        "config": {
          "conditions": [
            {
              "label": "å·¥ä½œäººå‘˜",
              "expression": "context.senderType === 'staff'",
              "targetNodeId": "node_staff_handler"
            },
            {
              "label": "ç”¨æˆ·/è¿è¥",
              "expression": "context.senderType === 'user' || context.senderType === 'operator'",
              "targetNodeId": "node_user_operator_handler"
            },
            {
              "label": "å…¶ä»–",
              "expression": "true",
              "targetNodeId": "node_log_only"
            }
          ]
        }
      }
    },
    {
      "id": "node_staff_handler",
      "type": "multi_task_staff",
      "name": "å·¥ä½œäººå‘˜æ¶ˆæ¯å¤„ç†",
      "position": { "x": 1250, "y": 50 },
      "data": {
        "name": "å·¥ä½œäººå‘˜æ¶ˆæ¯å¤„ç†",
        "description": "æ ‡è®°å·¥ä½œäººå‘˜çŠ¶æ€ã€è®°å½•æ´»è·ƒåº¦ã€åˆ†ææ»¡æ„åº¦ã€è®°å½•@ä»»åŠ¡",
        "icon": "ğŸ‘¥",
        "color": "bg-pink-500",
        "config": {
          "executeMode": "sequential",
          "failFast": false,
          "tasks": [
            {
              "id": "task_mark_staff_status",
              "operation": "notify",
              "config": {
                "action": "update_status",
                "statusType": "online",
                "outputField": "statusUpdated"
              }
            },
            {
              "id": "task_record_activity",
              "operation": "dispatch",
              "config": {
                "action": "record_activity",
                "activityType": "message",
                "outputField": "activityRecorded"
              }
            },
            {
              "id": "task_analyze_response",
              "operation": "dispatch",
              "config": {
                "action": "analyze_response",
                "messageField": "receivedMessage",
                "outputField": "responseAnalyzed"
              }
            },
            {
              "id": "task_check_mention",
              "operation": "query",
              "config": {
                "queryType": "check_mention",
                "targetUser": "owner",
                "outputField": "isMentionOwner"
              }
            }
          ]
        }
      }
    },
    {
      "id": "node_user_operator_handler",
      "type": "multi_task_ai",
      "name": "ç”¨æˆ·/è¿è¥æ¶ˆæ¯å¤„ç†",
      "position": { "x": 1250, "y": 200 },
      "data": {
        "name": "ç”¨æˆ·/è¿è¥æ¶ˆæ¯å¤„ç†",
        "description": "åŸºäºä¸Šä¸‹æ–‡åˆ¤æ–­æ˜¯å¦ä»‹å…¥ï¼Œåˆ¤æ–­ä¾æ®ï¼šæƒ…ç»ªåˆ†æã€æ»¡æ„åº¦åˆ†æã€å·¥ä½œäººå‘˜æ´»è·ƒåº¦åˆ†æ",
        "icon": "ğŸ§ ",
        "color": "bg-purple-500",
        "config": {
          "executeMode": "sequential",
          "failFast": true,
          "tasks": [
            {
              "id": "task_analyze_sentiment",
              "operation": "emotion_analyze",
              "config": {
                "modelId": "default",
                "outputField": "sentiment"
              }
            },
            {
              "id": "task_analyze_satisfaction",
              "operation": "satisfaction_infer",
              "config": {
                "modelId": "default",
                "outputField": "satisfaction"
              }
            },
            {
              "id": "task_check_staff_activity",
              "operation": "query",
              "config": {
                "queryType": "staff_activity",
                "timeWindow": 300,
                "outputField": "staffActivity"
              }
            },
            {
              "id": "task_determine_intervention",
              "operation": "risk_detect",
              "config": {
                "ruleType": "intervention",
                "sentimentField": "sentiment",
                "satisfactionField": "satisfaction",
                "staffActivityField": "staffActivity",
                "outputField": "needIntervention"
              }
            }
          ]
        }
      }
    },
    {
      "id": "node_collaboration_analysis",
      "type": "multi_task_analysis",
      "name": "ååŒåˆ†æ",
      "position": { "x": 1450, "y": 150 },
      "data": {
        "name": "ååŒåˆ†æ",
        "description": "äººå·¥æ´»è·ƒåº¦ç›‘æµ‹ã€ç”¨æˆ·æ»¡æ„åº¦åˆ†æã€å·¥ä½œäººå‘˜æ»¡æ„åº¦åˆ†æã€å”®åä»»åŠ¡è¿½è¸ªã€è¿è¥è¯­æ°”ç›‘æµ‹",
        "icon": "ğŸ“Š",
        "color": "bg-teal-500",
        "config": {
          "executeMode": "parallel",
          "failFast": false,
          "tasks": [
            {
              "id": "task_staff_activity_monitor",
              "operation": "collaboration_analyze",
              "config": {
                "analysisType": "staff_activity",
                "outputField": "staffActivityReport"
              }
            },
            {
              "id": "task_user_satisfaction",
              "operation": "satisfaction_infer",
              "config": {
                "analysisType": "user_satisfaction",
                "outputField": "userSatisfactionReport"
              }
            },
            {
              "id": "task_staff_satisfaction",
              "operation": "satisfaction_infer",
              "config": {
                "analysisType": "staff_satisfaction",
                "outputField": "staffSatisfactionReport"
              }
            },
            {
              "id": "task_after_sales_tracking",
              "operation": "query",
              "config": {
                "queryType": "after_sales_tracking",
                "outputField": "afterSalesStatus"
              }
            },
            {
              "id": "task_operator_tone_monitor",
              "operation": "emotion_analyze",
              "config": {
                "analysisType": "operator_tone",
                "outputField": "operatorTone"
              }
            }
          ]
        }
      }
    },
    {
      "id": "node_ai_analysis",
      "type": "multi_task_ai",
      "name": "AIåˆ†æ",
      "position": { "x": 1650, "y": 150 },
      "data": {
        "name": "AIåˆ†æ",
        "description": "åŸºäºä¸Šä¸‹æ–‡è¿›è¡Œæ„å›¾åˆ¤æ–­ã€å›å¤å»ºè®®ã€å‘Šè­¦åˆ¤æ–­ã€ä»‹å…¥åˆ¤æ–­",
        "icon": "ğŸ§ ",
        "color": "bg-purple-500",
        "config": {
          "executeMode": "sequential",
          "failFast": true,
          "tasks": [
            {
              "id": "task_intent_recognize",
              "operation": "intent_analyze",
              "config": {
                "modelId": "default",
                "intentTypes": ["å”®åç±»", "ç–‘è™‘è§£ç­”ç±»", "æƒ…ç»ªä¸æ»¡ç±»", "çŠ¶æ€æ²Ÿé€šç±»", "é—²èŠç±»"],
                "outputField": "intent"
              }
            },
            {
              "id": "task_generate_reply_suggestion",
              "operation": "reply",
              "config": {
                "modelId": "default",
                "generateType": "suggestion",
                "outputField": "replySuggestion"
              }
            },
            {
              "id": "task_check_alert_needed",
              "operation": "risk_detect",
              "config": {
                "ruleType": "alert_needed",
                "sentimentField": "sentiment",
                "intentField": "intent",
                "outputField": "needAlert"
              }
            },
            {
              "id": "task_check_intervention_needed",
              "operation": "risk_detect",
              "config": {
                "ruleType": "intervention_needed",
                "sentimentField": "sentiment",
                "satisfactionField": "satisfaction",
                "staffActivityField": "staffActivity",
                "outputField": "needIntervention"
              }
            }
          ]
        }
      }
    },
    {
      "id": "node_decision_action",
      "type": "decision",
      "name": "è¡ŒåŠ¨å†³ç­–",
      "position": { "x": 1850, "y": 150 },
      "data": {
        "name": "è¡ŒåŠ¨å†³ç­–",
        "description": "æ ¹æ®AIåˆ†æç»“æœå†³å®šåç»­è¡ŒåŠ¨",
        "icon": "ğŸ”€",
        "color": "bg-orange-500",
        "config": {
          "conditions": [
            {
              "label": "éœ€è¦å‘Šè­¦",
              "expression": "context.needAlert === true",
              "targetNodeId": "node_alert_handler"
            },
            {
              "label": "éœ€è¦AIå›å¤",
              "expression": "context.senderType === 'user' || context.senderType === 'operator'",
              "targetNodeId": "node_ai_reply"
            },
            {
              "label": "ä»…è®°å½•",
              "expression": "true",
              "targetNodeId": "node_log_only"
            }
          ]
        }
      }
    },
    {
      "id": "node_alert_handler",
      "type": "multi_task_alert",
      "name": "å‘Šè­¦å¤„ç†",
      "position": { "x": 2050, "y": 50 },
      "data": {
        "name": "å‘Šè­¦å¤„ç†",
        "description": "è®°å½•å‘Šè­¦ä¿¡æ¯ã€æ¨é€åˆ°å‘Šè­¦é¢æ¿ã€æ‰§è¡Œå‘Šè­¦é€šçŸ¥",
        "icon": "ğŸ””",
        "color": "bg-red-500",
        "config": {
          "executeMode": "sequential",
          "failFast": false,
          "tasks": [
            {
              "id": "task_save_alert",
              "operation": "dispatch",
              "config": {
                "action": "save",
                "table": "alerts",
                "data": {
                  "type": "message_alert",
                  "level": "warning",
                  "content": "{{receivedMessage}}"
                },
                "outputField": "alertId"
              }
            },
            {
              "id": "task_push_alert_panel",
              "operation": "notify",
              "config": {
                "target": "alert_panel",
                "alertIdField": "alertId",
                "outputField": "alertPushed"
              }
            },
            {
              "id": "task_send_alert_notification",
              "operation": "notify",
              "config": {
                "action": "send_notification",
                "channels": ["webhook", "email"],
                "alertIdField": "alertId",
                "outputField": "alertNotificationSent"
              }
            }
          ]
        }
      }
    },
    {
      "id": "node_ai_reply",
      "type": "multi_task_ai",
      "name": "AIç”Ÿæˆå›å¤",
      "position": { "x": 2050, "y": 200 },
      "data": {
        "name": "AIç”Ÿæˆå›å¤",
        "description": "åŸºäºAIå›å¤å»ºè®®ç”Ÿæˆå›å¤ï¼Œè€ƒè™‘æ—¶æ®µï¼ˆç™½å¤©äººå·¥ä¼˜å…ˆã€æ™šä¸Šæœºå™¨äººå…¨è‡ªåŠ¨ï¼‰",
        "icon": "ğŸ§ ",
        "color": "bg-purple-500",
        "config": {
          "executeMode": "sequential",
          "failFast": true,
          "tasks": [
            {
              "id": "task_determine_reply_strategy",
              "operation": "query",
              "config": {
                "queryType": "reply_strategy",
                "considerShift": true,
                "outputField": "replyStrategy"
              }
            },
            {
              "id": "task_generate_reply",
              "operation": "reply",
              "config": {
                "modelId": "default",
                "strategyField": "replyStrategy",
                "suggestionField": "replySuggestion",
                "contextField": "context",
                "outputField": "replyContent"
              }
            },
            {
              "id": "task_extract_reply_params",
              "operation": "transform",
              "config": {
                "transformType": "reply_params",
                "replyContentField": "replyContent",
                "outputField": "replyParams"
              }
            }
          ]
        }
      }
    },
    {
      "id": "node_log_only",
      "type": "log",
      "name": "ä»…è®°å½•",
      "position": { "x": 1850, "y": 300 },
      "data": {
        "name": "ä»…è®°å½•",
        "description": "è®°å½•æ¶ˆæ¯å¤„ç†ç»“æœï¼Œä¸æ‰§è¡Œå…¶ä»–æ“ä½œ",
        "icon": "ğŸ“",
        "color": "bg-slate-500",
        "config": {
          "logLevel": "info",
          "message": "Message processed and logged only",
          "dataFields": ["messageId", "senderType", "timestamp"]
        }
      }
    },
    {
      "id": "node_robot_execute",
      "type": "multi_task_robot",
      "name": "æœºå™¨äººæ‰§è¡Œå‘é€",
      "position": { "x": 2250, "y": 150 },
      "data": {
        "name": "æœºå™¨äººæ‰§è¡Œå‘é€",
        "description": "å‘é€è¡ŒåŠ¨æŒ‡ä»¤å’Œå›å¤æ¶ˆæ¯ç»™æœºå™¨äººï¼Œæœºå™¨äººæ‰§è¡Œå‘é€",
        "icon": "ğŸ¤–",
        "color": "bg-blue-600",
        "config": {
          "executeMode": "sequential",
          "failFast": true,
          "tasks": [
            {
              "id": "task_send_action_command",
              "operation": "dispatch",
              "config": {
                "apiEndpoint": "/api/robots/execute",
                "action": "send_message",
                "paramsField": "replyParams",
                "outputField": "commandSent"
              }
            },
            {
              "id": "task_track_execution",
              "operation": "dispatch",
              "config": {
                "action": "track_execution",
                "requestIdField": "commandSent.requestId",
                "timeout": 60000,
                "outputField": "executionResult"
              }
            }
          ]
        }
      }
    },
    {
      "id": "node_end",
      "type": "end",
      "name": "ç»“æŸ",
      "position": { "x": 2450, "y": 150 },
      "data": {
        "name": "ç»“æŸ",
        "description": "æµç¨‹ç»“æŸï¼Œä¿å­˜ä¼šè¯çŠ¶æ€ã€æ›´æ–°æ»¡æ„åº¦ã€æ¨é€ååŒåˆ†ææ¨¡å—",
        "icon": "â¹ï¸",
        "color": "bg-gray-500"
      }
    }
  ],
  "edges": [
    {
      "id": "edge_start_message_receive",
      "source": "node_start",
      "target": "node_message_receive",
      "type": "bezier"
    },
    {
      "id": "edge_message_receive_role_identify",
      "source": "node_message_receive",
      "target": "node_role_identify",
      "type": "bezier"
    },
    {
      "id": "edge_role_identify_push_monitor",
      "source": "node_role_identify",
      "target": "node_push_monitor",
      "type": "bezier"
    },
    {
      "id": "edge_push_monitor_context_analysis",
      "source": "node_push_monitor",
      "target": "node_context_analysis",
      "type": "bezier"
    },
    {
      "id": "edge_context_analysis_decision_sender_type",
      "source": "node_context_analysis",
      "target": "node_decision_sender_type",
      "type": "bezier"
    },
    {
      "id": "edge_decision_sender_type_staff",
      "source": "node_decision_sender_type",
      "target": "node_staff_handler",
      "label": "å·¥ä½œäººå‘˜"
    },
    {
      "id": "edge_decision_sender_type_user",
      "source": "node_decision_sender_type",
      "target": "node_user_operator_handler",
      "label": "ç”¨æˆ·/è¿è¥"
    },
    {
      "id": "edge_decision_sender_type_log",
      "source": "node_decision_sender_type",
      "target": "node_log_only",
      "label": "å…¶ä»–"
    },
    {
      "id": "edge_staff_handler_collaboration",
      "source": "node_staff_handler",
      "target": "node_collaboration_analysis",
      "type": "bezier"
    },
    {
      "id": "edge_user_operator_handler_collaboration",
      "source": "node_user_operator_handler",
      "target": "node_collaboration_analysis",
      "type": "bezier"
    },
    {
      "id": "edge_collaboration_ai_analysis",
      "source": "node_collaboration_analysis",
      "target": "node_ai_analysis",
      "type": "bezier"
    },
    {
      "id": "edge_ai_analysis_decision_action",
      "source": "node_ai_analysis",
      "target": "node_decision_action",
      "type": "bezier"
    },
    {
      "id": "edge_decision_action_alert",
      "source": "node_decision_action",
      "target": "node_alert_handler",
      "label": "éœ€è¦å‘Šè­¦"
    },
    {
      "id": "edge_decision_action_reply",
      "source": "node_decision_action",
      "target": "node_ai_reply",
      "label": "éœ€è¦AIå›å¤"
    },
    {
      "id": "edge_decision_action_log",
      "source": "node_decision_action",
      "target": "node_log_only",
      "label": "ä»…è®°å½•"
    },
    {
      "id": "edge_alert_handler_robot_execute",
      "source": "node_alert_handler",
      "target": "node_robot_execute",
      "type": "bezier"
    },
    {
      "id": "edge_ai_reply_robot_execute",
      "source": "node_ai_reply",
      "target": "node_robot_execute",
      "type": "bezier"
    },
    {
      "id": "edge_log_only_end",
      "source": "node_log_only",
      "target": "node_end",
      "type": "bezier"
    },
    {
      "id": "edge_robot_execute_end",
      "source": "node_robot_execute",
      "target": "node_end",
      "type": "bezier"
    }
  ],
  "variables": {
    "receivedMessage": {},
    "savedMessageId": "",
    "isDuplicate": false,
    "senderType": "",
    "robotRole": null,
    "staffRole": null,
    "operatorRole": null,
    "sentiment": {},
    "satisfaction": 0,
    "staffActivity": {},
    "needIntervention": false,
    "intent": "",
    "replySuggestion": "",
    "needAlert": false,
    "replyStrategy": "auto",
    "replyContent": "",
    "replyParams": {},
    "commandSent": {},
    "executionResult": {}
  },
  "timeout": 120000,
  "retryConfig": {
    "maxRetries": 3,
    "retryInterval": 3000
  }
}
