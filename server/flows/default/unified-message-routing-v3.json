{
  "id": "unified-message-routing-v3",
  "name": "ç»Ÿä¸€æ¶ˆæ¯å¤„ç†æµç¨‹ï¼ˆv3.0ï¼‰",
  "description": "æ ¹æ®å‘é€è€…è§’è‰²è·¯ç”±åˆ°ä¸åŒå¤„ç†åˆ†æ”¯ï¼Œæ”¯æŒè¿è¥ã€å·¥ä½œäººå‘˜ã€å”®åã€ç”¨æˆ·æ¶ˆæ¯çš„å®Œæ•´å¤„ç†æµç¨‹",
  "version": "3.0",
  "is_active": true,
  "trigger_type": "webhook",
  "nodes": [
    {
      "id": "node-1",
      "type": "start",
      "name": "Webhookè§¦å‘å™¨",
      "description": "æ¥æ”¶ä¼ä¸šå¾®ä¿¡ç¾¤æ¶ˆæ¯Webhookï¼ŒéªŒè¯ç­¾åï¼Œå¹‚ç­‰æ€§æ£€æŸ¥",
      "position": { "x": 100, "y": 200 },
      "data": {
        "config": {
          "webhookUrl": "/api/robots/callback",
          "verifySignature": true,
          "idempotencyCheck": true
        }
      }
    },
    {
      "id": "node-2",
      "type": "multi_task_message",
      "name": "æ¶ˆæ¯æ¥æ”¶ä¸ä¿å­˜",
      "description": "æ¥æ”¶æ¶ˆæ¯å¹¶ä¿å­˜åˆ°messagesè¡¨å’Œsession_messagesè¡¨",
      "position": { "x": 350, "y": 200 },
      "data": {
        "config": {
          "tasks": [
            {
              "type": "receive",
              "messageData": {
                "saveToMessagesTable": true,
                "saveToSessionMessages": true,
                "pushToMonitorQueue": true
              }
            }
          ]
        }
      }
    },
    {
      "id": "node-3",
      "type": "multi_task_data",
      "name": "å‘é€è€…èº«ä»½è¯†åˆ«",
      "description": "è¯†åˆ«å‘é€è€…è§’è‰²ï¼šè¿è¥ã€å·¥ä½œäººå‘˜ã€ç”¨æˆ·ã€æœºå™¨äºº",
      "position": { "x": 600, "y": 200 },
      "data": {
        "config": {
          "tasks": [
            {
              "type": "query",
              "queryData": {
                "queryType": "identify_sender",
                "senderId": "{{sender_id}}",
                "operationUserIdList": [],
                "groupAssistantUserIdList": [],
                "afterSalesUserIdList": [],
                "robotIdList": []
              }
            }
          ]
        }
      }
    },
    {
      "id": "node-3.5",
      "type": "multi_task_task",
      "name": "å”®åä»»åŠ¡å…³è”æ£€æŸ¥",
      "description": "æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰å¾…å¤„ç†çš„å”®åä»»åŠ¡",
      "position": { "x": 850, "y": 200 },
      "data": {
        "config": {
          "tasks": [
            {
              "type": "query",
              "taskData": {
                "queryType": "check_after_sales_task",
                "targetUserId": "{{sender_id}}",
                "responseKeywords": ["åœ¨çš„", "æ¥äº†", "å¥½çš„", "æ”¶åˆ°", "é©¬ä¸Š", "å¯ä»¥", "è¡Œ", "æ˜¯çš„"],
                "completionKeywords": ["å®Œæˆäº†", "æå®š", "å¯ä»¥äº†", "å®Œæˆ"],
                "pendingTaskStatus": ["pending", "waiting_user_response"]
              }
            }
          ]
        }
      }
    },
    {
      "id": "node-4",
      "type": "condition",
      "name": "è§’è‰²è·¯ç”±",
      "description": "æ ¹æ®å‘é€è€…è§’è‰²è·¯ç”±åˆ°ä¸åŒåˆ†æ”¯",
      "position": { "x": 1100, "y": 200 },
      "data": {
        "config": {
          "conditions": [
            {
              "expression": "{{sender_role}} === 'operation'",
              "value": "operation",
              "priority": 0
            },
            {
              "expression": "{{sender_role}} === 'group_assistant' || {{sender_role}} === 'after_sales'",
              "value": "staff",
              "priority": 1
            },
            {
              "expression": "{{route_to_after_sales}} === true",
              "value": "after_sales",
              "priority": 2
            },
            {
              "expression": "{{sender_role}} === 'user'",
              "value": "user",
              "priority": 3
            }
          ]
        }
      }
    },
    {
      "id": "node-a1",
      "type": "multi_task_task",
      "name": "è¿è¥æ¶ˆæ¯è¯†åˆ«ä¸è·Ÿè¸ª",
      "description": "åˆ›å»ºè¿è¥è·Ÿè¸ªä»»åŠ¡ï¼Œæå–è¿è¥è¦æ±‚",
      "position": { "x": 1350, "y": 50 },
      "data": {
        "config": {
          "tasks": [
            {
              "type": "create",
              "taskData": {
                "task_type": "operation",
                "group_id": "{{group_id}}",
                "operation_id": "{{sender_id}}",
                "operation_name": "{{sender_name}}",
                "task_requirement": "{{content}}",
                "priority": "critical",
                "response_timeout": 600,
                "auto_cancel_when_responded": true
              }
            }
          ]
        }
      }
    },
    {
      "id": "node-a2",
      "type": "condition",
      "name": "å·ä¸»å“åº”æ£€æµ‹",
      "description": "æ£€æµ‹å·ä¸»æ˜¯å¦å›åº”",
      "position": { "x": 1600, "y": 50 },
      "data": {
        "config": {
          "conditions": [
            {
              "expression": "{{has_response}} === true",
              "value": "responded"
            },
            {
              "expression": "{{has_response}} === false",
              "value": "no_response"
            }
          ]
        }
      }
    },
    {
      "id": "node-a3",
      "type": "notification",
      "name": "æ— äººå›åº”é€šçŸ¥",
      "description": "å‘é€é€šçŸ¥ç»™å·¥ä½œäººå‘˜",
      "position": { "x": 1850, "y": 50 },
      "data": {
        "config": {
          "recipients": ["staff_group"],
          "message": "æé†’ï¼šè¿è¥åœ¨{{group_name}}ç¾¤è¦æ±‚{{target_user_name}}é…åˆï¼Œä½†ç”¨æˆ·å°šæœªå›åº”",
          "type": "urgent",
          "priority": "high"
        }
      }
    },
    {
      "id": "node-a4",
      "type": "multi_task_alert",
      "name": "å†²çªæ£€æµ‹ä¸è°ƒå’Œ",
      "description": "æ£€æµ‹è¿è¥å’Œç”¨æˆ·æ˜¯å¦å‘ç”Ÿå†²çª",
      "position": { "x": 2100, "y": 50 },
      "data": {
        "config": {
          "tasks": [
            {
              "type": "rule_evaluate",
              "alertData": {
                "rule": "conflict_detection",
                "condition": "{{emotion_score}} < 0.3"
              }
            },
            {
              "type": "notify",
              "alertData": {
                "message": "æˆ‘ä»¬é©¬ä¸Šé…åˆä»–ï¼Œå»å¸®åŠ©ä»–å®Œæˆå®åæˆ–è€…æ‰«ç ç™»å½•ç­‰ç›¸å…³å·¥ä½œ",
                "recipients": ["staff_work_group", "monitor_panel"]
              }
            }
          ]
        }
      }
    },
    {
      "id": "node-b1",
      "type": "multi_task_staff",
      "name": "å·¥ä½œäººå‘˜æ´»è·ƒåº¦è®°å½•",
      "description": "è®°å½•å·¥ä½œäººå‘˜æ´»è·ƒåº¦",
      "position": { "x": 1350, "y": 150 },
      "data": {
        "config": {
          "tasks": [
            {
              "type": "notify",
              "staffData": {
                "action": "record_activity",
                "staffId": "{{sender_id}}",
                "staffName": "{{sender_name}}",
                "role": "{{sender_role}}"
              }
            }
          ]
        }
      }
    },
    {
      "id": "node-b2",
      "type": "condition",
      "name": "å·¥ä½œäººå‘˜ä»‹å…¥åˆ¤æ–­",
      "description": "åˆ¤æ–­æ˜¯å¦éœ€è¦ä»‹å…¥",
      "position": { "x": 1600, "y": 150 },
      "data": {
        "config": {
          "conditions": [
            {
              "expression": "{{need_intervention}} === true",
              "value": "intervene"
            },
            {
              "expression": "{{need_intervention}} === false",
              "value": "no_intervention"
            }
          ]
        }
      }
    },
    {
      "id": "node-b3",
      "type": "notification",
      "name": "ä»‹å…¥é€šçŸ¥æ‰§è¡Œ",
      "description": "å‘é€ä»‹å…¥é€šçŸ¥",
      "position": { "x": 1850, "y": 150 },
      "data": {
        "config": {
          "recipients": ["staff_work_group"],
          "message": "å·¥ä½œäººå‘˜{{staff_name}}éœ€è¦ä»‹å…¥{{group_name}}ç¾¤çš„å¯¹è¯",
          "type": "info"
        }
      }
    },
    {
      "id": "node-c1",
      "type": "multi_task_task",
      "name": "å”®åæ¶ˆæ¯è¯†åˆ«",
      "description": "åˆ›å»ºå”®åè·Ÿè¸ªä»»åŠ¡",
      "position": { "x": 1350, "y": 250 },
      "data": {
        "config": {
          "tasks": [
            {
              "type": "create",
              "taskData": {
                "task_type": "after_sales",
                "group_id": "{{group_id}}",
                "staff_id": "{{staff_id}}",
                "staff_name": "{{staff_name}}",
                "target_user_id": "{{sender_id}}",
                "target_user_name": "{{sender_name}}",
                "task_requirement": "{{content}}",
                "priority": "high"
              }
            }
          ]
        }
      }
    },
    {
      "id": "node-c2",
      "type": "condition",
      "name": "ç”¨æˆ·å“åº”æ£€æµ‹",
      "description": "æ£€æµ‹ç”¨æˆ·æ˜¯å¦å›åº”ï¼Œæ‰§è¡Œæœºå™¨äººå®‰æŠš",
      "position": { "x": 1600, "y": 250 },
      "data": {
        "config": {
          "conditions": [
            {
              "expression": "{{has_response}} === true",
              "value": "responded"
            },
            {
              "expression": "{{has_response}} === false",
              "value": "no_response"
            }
          ]
        }
      }
    },
    {
      "id": "node-c3",
      "type": "multi_task_robot",
      "name": "æœºå™¨äººå®‰æŠš",
      "description": "æœºå™¨äººå®‰æŠšç”¨æˆ·å¹¶é€šçŸ¥å”®åäººå‘˜",
      "position": { "x": 1850, "y": 250 },
      "data": {
        "config": {
          "tasks": [
            {
              "type": "command",
              "robotData": {
                "robotId": "{{reply_robot_id}}",
                "robotType": "reply",
                "command": {
                  "type": "send_message",
                  "params": {
                    "group_id": "{{group_id}}",
                    "content": "@{{sender_name}} å¥½çš„ï¼Œè¯·ç¨ç­‰ï¼Œå”®åäººå‘˜é©¬ä¸Šå°±æ¥å¤„ç† ğŸ‘",
                    "atUser": true
                  }
                }
              }
            },
            {
              "type": "command",
              "robotData": {
                "robotId": "{{notification_robot_id}}",
                "robotType": "notification",
                "command": {
                  "type": "send_message",
                  "params": {
                    "recipients": ["staff_work_group"],
                    "content": "ã€ç´§æ€¥ã€‘ç”¨æˆ·{{sender_name}}å·²å“åº”ï¼š{{content}}"
                  }
                }
              }
            }
          ]
        }
      }
    },
    {
      "id": "node-c4",
      "type": "notification",
      "name": "å”®åæ— äººå›åº”é€šçŸ¥",
      "description": "ç”¨æˆ·å“åº”ä½†å”®åæœªè·Ÿè¿›æ—¶é€šçŸ¥",
      "position": { "x": 2100, "y": 250 },
      "data": {
        "config": {
          "recipients": ["staff_work_group"],
          "message": "æé†’ï¼šç”¨æˆ·{{sender_name}}å·²å“åº”å”®å@æ¶ˆæ¯ï¼Œè¯·åŠæ—¶å®‰æ’ä»»åŠ¡",
          "type": "urgent",
          "priority": "high"
        }
      }
    },
    {
      "id": "node-c5",
      "type": "multi_task_task",
      "name": "ä»»åŠ¡å®Œæˆè·Ÿè¸ª",
      "description": "è·Ÿè¸ªå”®åä»»åŠ¡å®Œæˆæƒ…å†µ",
      "position": { "x": 2350, "y": 250 },
      "data": {
        "config": {
          "tasks": [
            {
              "type": "update",
              "taskData": {
                "task_id": "{{task_id}}",
                "task_status": "completed",
                "completed_at": "NOW()"
              }
            }
          ]
        }
      }
    },
    {
      "id": "node-c6",
      "type": "multi_task_analysis",
      "name": "ååŒåˆ†æä¸æŠ¥å‘Š",
      "description": "ç”Ÿæˆå”®åå¤„ç†æ•ˆæœæŠ¥å‘Š",
      "position": { "x": 2600, "y": 250 },
      "data": {
        "config": {
          "tasks": [
            {
              "type": "report",
              "analysisData": {
                "report_type": "after_sales_summary",
                "task_id": "{{task_id}}",
                "group_id": "{{group_id}}",
                "target_user_id": "{{sender_id}}"
              }
            }
          ]
        }
      }
    },
    {
      "id": "node-d1",
      "type": "multi_task_ai",
      "name": "ç”¨æˆ·æ¶ˆæ¯æ„å›¾è¯†åˆ«",
      "description": "AIè¯†åˆ«ç”¨æˆ·æ¶ˆæ¯æ„å›¾å’Œæƒ…ç»ª",
      "position": { "x": 1350, "y": 350 },
      "data": {
        "config": {
          "tasks": [
            {
              "type": "identify",
              "model": "doubao",
              "prompt": "è¯†åˆ«ç”¨æˆ·æ¶ˆæ¯çš„æ„å›¾å’Œæƒ…ç»ªï¼Œè¿”å›æ„å›¾ç±»å‹ã€æƒ…ç»ªã€ç½®ä¿¡åº¦ç­‰ä¿¡æ¯",
              "input": "{{content}}",
              "useContext": true,
              "contextLength": 10,
              "enableEmotionAnalysis": true
            }
          ]
        }
      }
    },
    {
      "id": "node-d2",
      "type": "multi_task_alert",
      "name": "å‘Šè­¦åˆ¤æ–­ä¸åˆ†ç±»",
      "description": "åˆ¤æ–­æ˜¯å¦è§¦å‘å‘Šè­¦",
      "position": { "x": 1600, "y": 350 },
      "data": {
        "config": {
          "tasks": [
            {
              "type": "rule_evaluate",
              "alertData": {
                "rule": "alert_detection",
                "intent": "{{intent}}",
                "emotion": "{{emotion}}",
                "emotionScore": "{{emotion_score}}"
              }
            },
            {
              "type": "save",
              "alertData": {
                "alert_level": "{{alert_level}}",
                "alert_type": "{{alert_type}}",
                "group_id": "{{group_id}}",
                "user_id": "{{sender_id}}",
                "intent": "{{intent}}",
                "emotion": "{{emotion}}"
              }
            }
          ]
        }
      }
    },
    {
      "id": "node-d3",
      "type": "condition",
      "name": "AIå›å¤å†³ç­–",
      "description": "åˆ¤æ–­æ˜¯å¦éœ€è¦AIå›å¤",
      "position": { "x": 1850, "y": 350 },
      "data": {
        "config": {
          "conditions": [
            {
              "expression": "{{need_reply}} === true",
              "value": "reply"
            },
            {
              "expression": "{{need_reply}} === false",
              "value": "no_reply"
            }
          ]
        }
      }
    },
    {
      "id": "node-d4",
      "type": "multi_task_ai",
      "name": "AIå›å¤ç”Ÿæˆ",
      "description": "AIç”Ÿæˆå›å¤å†…å®¹",
      "position": { "x": 2100, "y": 350 },
      "data": {
        "config": {
          "tasks": [
            {
              "type": "generate",
              "model": "doubao",
              "prompt": "ç”Ÿæˆä¸€ä¸ªå‹å¥½ã€ä¸“ä¸šçš„å›å¤",
              "input": "{{content}}",
              "intent": "{{intent}}",
              "emotion": "{{emotion}}",
              "context": "{{context}}"
            }
          ]
        }
      }
    },
    {
      "id": "node-d5",
      "type": "condition",
      "name": "å›å¤è´¨é‡æ£€æŸ¥",
      "description": "æ£€æŸ¥å›å¤è´¨é‡",
      "position": { "x": 2350, "y": 350 },
      "data": {
        "config": {
          "conditions": [
            {
              "expression": "{{quality}} >= 0.8",
              "value": "approved"
            },
            {
              "expression": "{{quality}} < 0.8",
              "value": "rejected"
            }
          ]
        }
      }
    },
    {
      "id": "node-d6",
      "type": "delay",
      "name": "å»¶è¿Ÿæ§åˆ¶",
      "description": "æ ¹æ®æ—¶é—´æ®µå»¶è¿Ÿå‘é€",
      "position": { "x": 2600, "y": 350 },
      "data": {
        "config": {
          "delaySeconds": "{{delay_seconds}}",
          "delayReason": "{{delay_reason}}",
          "dayShift": {
            "startHour": 9,
            "endHour": 21,
            "minDelay": 0,
            "maxDelay": 0
          },
          "nightShift": {
            "startHour": 21,
            "endHour": 24,
            "minDelay": 60,
            "maxDelay": 300
          },
          "lateNight": {
            "startHour": 0,
            "endHour": 6,
            "highPriority": {
              "minDelay": 300,
              "maxDelay": 600
            },
            "mediumPriority": {
              "minDelay": 600,
              "maxDelay": 1800
            },
            "lowPriority": {
              "noReply": true
            }
          }
        }
      }
    },
    {
      "id": "node-d7",
      "type": "multi_task_robot",
      "name": "æœºå™¨äººé€šè®¯æ‰§è¡Œ",
      "description": "å‘é€æœºå™¨äººæŒ‡ä»¤",
      "position": { "x": 2850, "y": 350 },
      "data": {
        "config": {
          "tasks": [
            {
              "type": "command",
              "robotData": {
                "robotId": "{{reply_robot_id}}",
                "robotType": "reply",
                "command": {
                  "type": "send_message",
                  "params": {
                    "group_id": "{{group_id}}",
                    "content": "{{reply_content}}",
                    "replyType": "{{reply_type}}"
                  }
                }
              }
            }
          ]
        }
      }
    },
    {
      "id": "node-d8",
      "type": "multi_task_robot",
      "name": "å¼‚æ­¥ç»“æœç¡®è®¤",
      "description": "1åˆ†é’ŸåæŸ¥è¯¢æ‰§è¡Œç»“æœ",
      "position": { "x": 3100, "y": 350 },
      "data": {
        "config": {
          "tasks": [
            {
              "type": "command",
              "robotData": {
                "robotId": "{{reply_robot_id}}",
                "robotType": "reply",
                "command": {
                  "type": "check_status",
                  "params": {
                    "command_id": "{{command_id}}"
                  }
                }
              }
            }
          ]
        },
        "config": {
          "checkDelaySeconds": 60,
          "maxCheckAttempts": 3,
          "checkIntervalSeconds": 30,
          "actionOnFailure": "manual_intervention"
        }
      }
    },
    {
      "id": "node-5",
      "type": "session",
      "name": "ä¼šè¯ç®¡ç†ä¸åˆ†æ",
      "description": "æ›´æ–°ä¼šè¯çŠ¶æ€ã€ä¸Šä¸‹æ–‡ã€æ»¡æ„åº¦",
      "position": { "x": 3350, "y": 200 },
      "data": {
        "config": {
          "action": "update",
          "sessionData": {
            "session_id": "{{session_id}}",
            "last_message_at": "NOW()",
            "message_count": "+1",
            "context": "{{context}}",
            "last_intent": "{{intent}}",
            "last_emotion": "{{emotion}}"
          }
        }
      }
    },
    {
      "id": "node-6",
      "type": "end",
      "name": "æµç¨‹ç»“æŸ",
      "description": "æµç¨‹æ‰§è¡Œå®Œæˆ",
      "position": { "x": 3600, "y": 200 },
      "data": {
        "config": {
          "resultVariable": "context"
        }
      }
    }
  ],
  "edges": [
    { "id": "edge-1", "source": "node-1", "target": "node-2" },
    { "id": "edge-2", "source": "node-2", "target": "node-3" },
    { "id": "edge-3", "source": "node-3", "target": "node-3.5" },
    { "id": "edge-4", "source": "node-3.5", "target": "node-4" },
    { "id": "edge-5", "source": "node-4", "target": "node-a1", "condition": "operation" },
    { "id": "edge-6", "source": "node-4", "target": "node-b1", "condition": "staff" },
    { "id": "edge-7", "source": "node-4", "target": "node-c1", "condition": "after_sales" },
    { "id": "edge-8", "source": "node-4", "target": "node-d1", "condition": "user" },
    { "id": "edge-a1-2", "source": "node-a1", "target": "node-a2" },
    { "id": "edge-a2-3", "source": "node-a2", "target": "node-a3", "condition": "no_response" },
    { "id": "edge-a3-4", "source": "node-a3", "target": "node-a4" },
    { "id": "edge-a4-end", "source": "node-a4", "target": "node-5" },
    { "id": "edge-a2-end", "source": "node-a2", "target": "node-5", "condition": "responded" },
    { "id": "edge-b1-2", "source": "node-b1", "target": "node-b2" },
    { "id": "edge-b2-3", "source": "node-b2", "target": "node-b3", "condition": "intervene" },
    { "id": "edge-b3-end", "source": "node-b3", "target": "node-5" },
    { "id": "edge-b2-end", "source": "node-b2", "target": "node-5", "condition": "no_intervention" },
    { "id": "edge-c1-2", "source": "node-c1", "target": "node-c2" },
    { "id": "edge-c2-3", "source": "node-c2", "target": "node-c3", "condition": "responded" },
    { "id": "edge-c3-4", "source": "node-c3", "target": "node-c4" },
    { "id": "edge-c4-5", "source": "node-c4", "target": "node-c5" },
    { "id": "edge-c5-6", "source": "node-c5", "target": "node-c6" },
    { "id": "edge-c6-end", "source": "node-c6", "target": "node-5" },
    { "id": "edge-c2-end", "source": "node-c2", "target": "node-5", "condition": "no_response" },
    { "id": "edge-d1-2", "source": "node-d1", "target": "node-d2" },
    { "id": "edge-d2-3", "source": "node-d2", "target": "node-d3" },
    { "id": "edge-d3-4", "source": "node-d3", "target": "node-d4", "condition": "reply" },
    { "id": "edge-d4-5", "source": "node-d4", "target": "node-d5" },
    { "id": "edge-d5-6", "source": "node-d5", "target": "node-d6", "condition": "approved" },
    { "id": "edge-d5-retry", "source": "node-d5", "target": "node-d4", "condition": "rejected" },
    { "id": "edge-d6-7", "source": "node-d6", "target": "node-d7" },
    { "id": "edge-d7-8", "source": "node-d7", "target": "node-d8" },
    { "id": "edge-d8-end", "source": "node-d8", "target": "node-5" },
    { "id": "edge-d3-end", "source": "node-d3", "target": "node-5", "condition": "no_reply" },
    { "id": "edge-5-6", "source": "node-5", "target": "node-6" }
  ],
  "variables": {
    "reply_robot_id": "{{default_reply_robot}}",
    "notification_robot_id": "{{default_notification_robot}}",
    "default_delay_seconds": 0
  }
}
