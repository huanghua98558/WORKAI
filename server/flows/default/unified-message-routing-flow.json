{
  "id": "unified-message-routing-v2",
  "name": "ç»Ÿä¸€æ¶ˆæ¯å¤„ç†æµç¨‹ï¼ˆv2.0ï¼‰",
  "description": "æ ¹æ®å‘é€è€…è§’è‰²è·¯ç”±åˆ°ä¸åŒå¤„ç†åˆ†æ”¯ï¼Œæ”¯æŒè¿è¥ã€å·¥ä½œäººå‘˜ã€å”®åã€ç”¨æˆ·æ¶ˆæ¯çš„å®Œæ•´å¤„ç†æµç¨‹",
  "version": "2.0",
  "is_active": true,
  "trigger_type": "webhook",
  "nodes": [
    {
      "id": "node-1",
      "type": "start",
      "name": "æ¶ˆæ¯æ¥æ”¶ä¸ä¿å­˜",
      "description": "æ¥æ”¶ä¼ä¸šå¾®ä¿¡ç¾¤æ¶ˆæ¯ï¼ŒéªŒè¯ç­¾åï¼Œä¿å­˜åˆ° messages è¡¨",
      "position": { "x": 100, "y": 100 },
      "data": {
        "config": {
          "initialVariables": {
            "message": "{{message}}",
            "sender": "{{sender}}",
            "group_id": "{{group_id}}",
            "content": "{{content}}"
          }
        }
      }
    },
    {
      "id": "node-2",
      "type": "multi_task_message",
      "name": "å‘é€è€…èº«ä»½è¯†åˆ«",
      "description": "è¯†åˆ«å‘é€è€…è§’è‰²ï¼šè¿è¥ã€å·¥ä½œäººå‘˜ã€ç”¨æˆ·ã€æœºå™¨äºº",
      "position": { "x": 300, "y": 100 },
      "data": {
        "config": {
          "tasks": [
            {
              "type": "receive",
              "messageData": {
                "sender_role": "{{sender.role}}",
                "priority": "{{sender.priority}}",
                "group_id": "{{group_id}}",
                "content": "{{content}}"
              }
            }
          ]
        }
      }
    },
    {
      "id": "node-2.5",
      "type": "multi_task_task",
      "name": "å”®åä»»åŠ¡å…³è”æ£€æŸ¥",
      "description": "æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰å¾…å¤„ç†çš„å”®åä»»åŠ¡",
      "position": { "x": 500, "y": 100 },
      "data": {
        "config": {
          "tasks": [
            {
              "type": "query",
              "taskData": {
                "target_user_id": "{{sender.id}}",
                "task_status": "pending"
              }
            }
          ]
        }
      }
    },
    {
      "id": "node-3",
      "type": "condition",
      "name": "è§’è‰²è·¯ç”±",
      "description": "æ ¹æ®å‘é€è€…è§’è‰²è·¯ç”±åˆ°ä¸åŒåˆ†æ”¯",
      "position": { "x": 700, "y": 100 },
      "data": {
        "config": {
          "conditions": [
            {
              "expression": "{{sender.role}} === 'operation'",
              "value": "operation"
            },
            {
              "expression": "{{sender.role}} === 'group_assistant' || {{sender.role}} === 'after_sales'",
              "value": "staff"
            },
            {
              "expression": "{{isAfterSalesTask}} === true",
              "value": "after_sales"
            },
            {
              "expression": "{{sender.role}} === 'user'",
              "value": "user"
            }
          ]
        }
      }
    },
    {
      "id": "node-a1",
      "type": "multi_task_task",
      "name": "è¿è¥æ¶ˆæ¯è¯†åˆ«ä¸è·Ÿè¸ª",
      "description": "åˆ›å»ºè¿è¥è·Ÿè¸ªä»»åŠ¡ï¼Œæå–è¿è¥è¦æ±‚",
      "position": { "x": 950, "y": 50 },
      "data": {
        "config": {
          "tasks": [
            {
              "type": "create",
              "taskData": {
                "task_type": "operation",
                "group_id": "{{group_id}}",
                "operation_id": "{{sender.id}}",
                "operation_name": "{{sender.name}}",
                "task_requirement": "{{content}}",
                "priority": "critical"
              }
            }
          ]
        }
      }
    },
    {
      "id": "node-a2",
      "type": "condition",
      "name": "å·ä¸»å“åº”æ£€æµ‹",
      "description": "æ£€æµ‹å·ä¸»æ˜¯å¦å›åº”",
      "position": { "x": 1150, "y": 50 },
      "data": {
        "config": {
          "conditions": [
            {
              "expression": "{{hasResponse}} === true",
              "value": "responded"
            },
            {
              "expression": "{{hasResponse}} === false",
              "value": "no_response"
            }
          ]
        }
      }
    },
    {
      "id": "node-a3",
      "type": "notification",
      "name": "æ— äººå›åº”é€šçŸ¥",
      "description": "å‘é€é€šçŸ¥ç»™å·¥ä½œäººå‘˜",
      "position": { "x": 1350, "y": 50 },
      "data": {
        "config": {
          "recipients": ["staff_group"],
          "message": "æé†’ï¼šè¿è¥åœ¨ç¾¤è¦æ±‚ç”¨æˆ·é…åˆï¼Œä½†ç”¨æˆ·å°šæœªå›åº”",
          "type": "urgent"
        }
      }
    },
    {
      "id": "node-a4",
      "type": "multi_task_alert",
      "name": "å†²çªæ£€æµ‹ä¸è°ƒå’Œ",
      "description": "æ£€æµ‹è¿è¥å’Œç”¨æˆ·æ˜¯å¦å‘ç”Ÿå†²çª",
      "position": { "x": 1550, "y": 50 },
      "data": {
        "config": {
          "tasks": [
            {
              "type": "rule_evaluate",
              "alertData": {
                "rule": "conflict_detection",
                "condition": "{{emotion_score}} < 0.3"
              }
            },
            {
              "type": "notify",
              "alertData": {
                "message": "æˆ‘ä»¬é©¬ä¸Šé…åˆä»–ï¼Œå»å¸®åŠ©ä»–å®Œæˆç›¸å…³å·¥ä½œ"
              }
            }
          ]
        }
      }
    },
    {
      "id": "node-b1",
      "type": "multi_task_staff",
      "name": "å·¥ä½œäººå‘˜æ´»è·ƒåº¦è®°å½•",
      "description": "è®°å½•å·¥ä½œäººå‘˜æ´»è·ƒåº¦",
      "position": { "x": 950, "y": 150 },
      "data": {
        "config": {
          "tasks": [
            {
              "type": "notify",
              "staffData": {
                "action": "record_activity"
              }
            }
          ]
        }
      }
    },
    {
      "id": "node-b2",
      "type": "condition",
      "name": "å·¥ä½œäººå‘˜ä»‹å…¥åˆ¤æ–­",
      "description": "åˆ¤æ–­æ˜¯å¦éœ€è¦ä»‹å…¥",
      "position": { "x": 1150, "y": 150 },
      "data": {
        "config": {
          "conditions": [
            {
              "expression": "{{needIntervention}} === true",
              "value": "intervene"
            },
            {
              "expression": "{{needIntervention}} === false",
              "value": "no_intervention"
            }
          ]
        }
      }
    },
    {
      "id": "node-b3",
      "type": "notification",
      "name": "ä»‹å…¥é€šçŸ¥æ‰§è¡Œ",
      "description": "å‘é€ä»‹å…¥é€šçŸ¥",
      "position": { "x": 1350, "y": 150 },
      "data": {
        "config": {
          "recipients": ["staff_work_group"],
          "message": "å·¥ä½œäººå‘˜éœ€è¦ä»‹å…¥",
          "type": "info"
        }
      }
    },
    {
      "id": "node-c1",
      "type": "multi_task_task",
      "name": "å”®åæ¶ˆæ¯è¯†åˆ«",
      "description": "åˆ›å»ºå”®åè·Ÿè¸ªä»»åŠ¡",
      "position": { "x": 950, "y": 250 },
      "data": {
        "config": {
          "tasks": [
            {
              "type": "create",
              "taskData": {
                "task_type": "after_sales",
                "group_id": "{{group_id}}",
                "staff_id": "{{staff.id}}",
                "staff_name": "{{staff.name}}",
                "target_user_id": "{{sender.id}}",
                "target_user_name": "{{sender.name}}",
                "task_requirement": "{{content}}",
                "priority": "high"
              }
            }
          ]
        }
      }
    },
    {
      "id": "node-c2",
      "type": "condition",
      "name": "ç”¨æˆ·å“åº”æ£€æµ‹",
      "description": "æ£€æµ‹ç”¨æˆ·æ˜¯å¦å›åº”ï¼Œæ‰§è¡Œæœºå™¨äººå®‰æŠš",
      "position": { "x": 1150, "y": 250 },
      "data": {
        "config": {
          "conditions": [
            {
              "expression": "{{hasResponse}} === true",
              "value": "responded"
            },
            {
              "expression": "{{hasResponse}} === false",
              "value": "no_response"
            }
          ]
        }
      }
    },
    {
      "id": "node-c3",
      "type": "multi_task_robot",
      "name": "æœºå™¨äººå®‰æŠš",
      "description": "æœºå™¨äººå®‰æŠšç”¨æˆ·å¹¶é€šçŸ¥å”®åäººå‘˜",
      "position": { "x": 1350, "y": 250 },
      "data": {
        "config": {
          "tasks": [
            {
              "type": "command",
              "robotData": {
                "robotId": "{{reply_robot_id}}",
                "robotType": "reply",
                "command": {
                  "type": "send_message",
                  "params": {
                    "group_id": "{{group_id}}",
                    "content": "@{{sender.name}} å¥½çš„ï¼Œè¯·ç¨ç­‰ï¼Œå”®åäººå‘˜é©¬ä¸Šå°±æ¥å¤„ç† ğŸ‘"
                  }
                }
              }
            },
            {
              "type": "command",
              "robotData": {
                "robotId": "{{notification_robot_id}}",
                "robotType": "notification",
                "command": {
                  "type": "send_message",
                  "params": {
                    "recipients": ["staff_work_group"],
                    "content": "ã€ç´§æ€¥ã€‘ç”¨æˆ·å·²å“åº”ï¼š{{content}}"
                  }
                }
              }
            }
          ]
        }
      }
    },
    {
      "id": "node-c4",
      "type": "notification",
      "name": "å”®åæ— äººå›åº”é€šçŸ¥",
      "description": "ç”¨æˆ·å“åº”ä½†å”®åæœªè·Ÿè¿›æ—¶é€šçŸ¥",
      "position": { "x": 1550, "y": 250 },
      "data": {
        "config": {
          "recipients": ["staff_work_group"],
          "message": "æé†’ï¼šç”¨æˆ·å·²å“åº”ï¼Œè¯·åŠæ—¶å®‰æ’ä»»åŠ¡",
          "type": "urgent"
        }
      }
    },
    {
      "id": "node-c5",
      "type": "multi_task_task",
      "name": "ä»»åŠ¡å®Œæˆè·Ÿè¸ª",
      "description": "è·Ÿè¸ªå”®åä»»åŠ¡å®Œæˆæƒ…å†µ",
      "position": { "x": 1750, "y": 250 },
      "data": {
        "config": {
          "tasks": [
            {
              "type": "update",
              "taskData": {
                "task_status": "completed",
                "completed_at": "NOW()"
              }
            }
          ]
        }
      }
    },
    {
      "id": "node-c6",
      "type": "multi_task_analysis",
      "name": "ååŒåˆ†æä¸æŠ¥å‘Š",
      "description": "ç”Ÿæˆå”®åå¤„ç†æ•ˆæœæŠ¥å‘Š",
      "position": { "x": 1950, "y": 250 },
      "data": {
        "config": {
          "tasks": [
            {
              "type": "report",
              "analysisData": {
                "report_type": "after_sales_summary"
              }
            }
          ]
        }
      }
    },
    {
      "id": "node-d1",
      "type": "multi_task_ai",
      "name": "ç”¨æˆ·æ¶ˆæ¯æ„å›¾è¯†åˆ«",
      "description": "AI è¯†åˆ«ç”¨æˆ·æ¶ˆæ¯æ„å›¾",
      "position": { "x": 950, "y": 350 },
      "data": {
        "config": {
          "tasks": [
            {
              "type": "identify",
              "model": "doubao",
              "prompt": "è¯†åˆ«ç”¨æˆ·æ¶ˆæ¯æ„å›¾",
              "input": "{{content}}"
            }
          ]
        }
      }
    },
    {
      "id": "node-d2",
      "type": "multi_task_alert",
      "name": "å‘Šè­¦åˆ¤æ–­ä¸åˆ†ç±»",
      "description": "åˆ¤æ–­æ˜¯å¦è§¦å‘å‘Šè­¦",
      "position": { "x": 1150, "y": 350 },
      "data": {
        "config": {
          "tasks": [
            {
              "type": "rule_evaluate",
              "alertData": {
                "rule": "alert_detection"
              }
            },
            {
              "type": "save",
              "alertData": {
                "alert_level": "{{alert_level}}",
                "alert_type": "{{alert_type}}"
              }
            }
          ]
        }
      }
    },
    {
      "id": "node-d3",
      "type": "condition",
      "name": "AI å›å¤å†³ç­–",
      "description": "åˆ¤æ–­æ˜¯å¦éœ€è¦ AI å›å¤",
      "position": { "x": 1350, "y": 350 },
      "data": {
        "config": {
          "conditions": [
            {
              "expression": "{{needReply}} === true",
              "value": "reply"
            },
            {
              "expression": "{{needReply}} === false",
              "value": "no_reply"
            }
          ]
        }
      }
    },
    {
      "id": "node-d4",
      "type": "multi_task_ai",
      "name": "AI å›å¤ç”Ÿæˆ",
      "description": "AI ç”Ÿæˆå›å¤å†…å®¹",
      "position": { "x": 1550, "y": 350 },
      "data": {
        "config": {
          "tasks": [
            {
              "type": "generate",
              "model": "doubao",
              "prompt": "ç”Ÿæˆå›å¤å†…å®¹",
              "input": "{{content}}"
            }
          ]
        }
      }
    },
    {
      "id": "node-d5",
      "type": "condition",
      "name": "å›å¤è´¨é‡æ£€æŸ¥",
      "description": "æ£€æŸ¥å›å¤è´¨é‡",
      "position": { "x": 1750, "y": 350 },
      "data": {
        "config": {
          "conditions": [
            {
              "expression": "{{quality}} >= 0.8",
              "value": "approved"
            },
            {
              "expression": "{{quality}} < 0.8",
              "value": "rejected"
            }
          ]
        }
      }
    },
    {
      "id": "node-d6",
      "type": "delay",
      "name": "å»¶è¿Ÿæ§åˆ¶",
      "description": "æ ¹æ®æ—¶é—´æ®µå»¶è¿Ÿå‘é€",
      "position": { "x": 1950, "y": 350 },
      "data": {
        "config": {
          "delaySeconds": "{{delay_seconds}}"
        }
      }
    },
    {
      "id": "node-d7",
      "type": "multi_task_robot",
      "name": "æœºå™¨äººé€šè®¯æ‰§è¡Œ",
      "description": "å‘é€æœºå™¨äººæŒ‡ä»¤",
      "position": { "x": 2150, "y": 350 },
      "data": {
        "config": {
          "tasks": [
            {
              "type": "command",
              "robotData": {
                "robotId": "{{reply_robot_id}}",
                "robotType": "reply",
                "command": {
                  "type": "send_message",
                  "params": {
                    "group_id": "{{group_id}}",
                    "content": "{{reply_content}}"
                  }
                }
              }
            }
          ]
        }
      }
    },
    {
      "id": "node-d8",
      "type": "multi_task_robot",
      "name": "å¼‚æ­¥ç»“æœç¡®è®¤",
      "description": "1åˆ†é’ŸåæŸ¥è¯¢æ‰§è¡Œç»“æœ",
      "position": { "x": 2350, "y": 350 },
      "data": {
        "config": {
          "tasks": [
            {
              "type": "command",
              "robotData": {
                "robotId": "{{reply_robot_id}}",
                "robotType": "reply",
                "command": {
                  "type": "check_status",
                  "params": {
                    "command_id": "{{command_id}}"
                  }
                }
              }
            }
          ]
        }
      }
    },
    {
      "id": "node-4",
      "type": "session",
      "name": "ä¼šè¯ç®¡ç†ä¸åˆ†æ",
      "description": "æ›´æ–°ä¼šè¯çŠ¶æ€ã€ä¸Šä¸‹æ–‡ã€æ»¡æ„åº¦",
      "position": { "x": 2500, "y": 100 },
      "data": {
        "config": {
          "action": "update",
          "sessionData": {
            "last_message_at": "NOW()",
            "message_count": "+1",
            "context": "{{context}}"
          }
        }
      }
    },
    {
      "id": "node-5",
      "type": "end",
      "name": "æµç¨‹ç»“æŸ",
      "description": "æµç¨‹æ‰§è¡Œå®Œæˆ",
      "position": { "x": 2700, "y": 100 },
      "data": {
        "config": {
          "resultVariable": "context"
        }
      }
    }
  ],
  "edges": [
    { "id": "edge-1", "source": "node-1", "target": "node-2" },
    { "id": "edge-2", "source": "node-2", "target": "node-2.5" },
    { "id": "edge-3", "source": "node-2.5", "target": "node-3" },
    { "id": "edge-4", "source": "node-3", "target": "node-a1", "condition": "operation" },
    { "id": "edge-5", "source": "node-3", "target": "node-b1", "condition": "staff" },
    { "id": "edge-6", "source": "node-3", "target": "node-c1", "condition": "after_sales" },
    { "id": "edge-7", "source": "node-3", "target": "node-d1", "condition": "user" },
    { "id": "edge-a1-2", "source": "node-a1", "target": "node-a2" },
    { "id": "edge-a2-3", "source": "node-a2", "target": "node-a3", "condition": "no_response" },
    { "id": "edge-a3-4", "source": "node-a3", "target": "node-a4" },
    { "id": "edge-a4-end", "source": "node-a4", "target": "node-4" },
    { "id": "edge-b1-2", "source": "node-b1", "target": "node-b2" },
    { "id": "edge-b2-3", "source": "node-b2", "target": "node-b3", "condition": "intervene" },
    { "id": "edge-b3-end", "source": "node-b3", "target": "node-4" },
    { "id": "edge-b2-end", "source": "node-b2", "target": "node-4", "condition": "no_intervention" },
    { "id": "edge-c1-2", "source": "node-c1", "target": "node-c2" },
    { "id": "edge-c2-3", "source": "node-c2", "target": "node-c3", "condition": "responded" },
    { "id": "edge-c3-4", "source": "node-c3", "target": "node-c4" },
    { "id": "edge-c4-5", "source": "node-c4", "target": "node-c5" },
    { "id": "edge-c5-6", "source": "node-c5", "target": "node-c6" },
    { "id": "edge-c6-end", "source": "node-c6", "target": "node-4" },
    { "id": "edge-c2-end", "source": "node-c2", "target": "node-4", "condition": "no_response" },
    { "id": "edge-d1-2", "source": "node-d1", "target": "node-d2" },
    { "id": "edge-d2-3", "source": "node-d2", "target": "node-d3" },
    { "id": "edge-d3-4", "source": "node-d3", "target": "node-d4", "condition": "reply" },
    { "id": "edge-d4-5", "source": "node-d4", "target": "node-d5" },
    { "id": "edge-d5-6", "source": "node-d5", "target": "node-d6", "condition": "approved" },
    { "id": "edge-d6-7", "source": "node-d6", "target": "node-d7" },
    { "id": "edge-d7-8", "source": "node-d7", "target": "node-d8" },
    { "id": "edge-d8-end", "source": "node-d8", "target": "node-4" },
    { "id": "edge-d3-end", "source": "node-d3", "target": "node-4", "condition": "no_reply" },
    { "id": "edge-4-5", "source": "node-4", "target": "node-5" }
  ],
  "variables": {
    "reply_robot_id": "{{default_reply_robot}}",
    "notification_robot_id": "{{default_notification_robot}}"
  }
}
