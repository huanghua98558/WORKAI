# 完整系统升级方案

> **文档版本**: v1.0
> **创建日期**: 2024-01-01
> **维护者**: WorkTool AI 团队
> **更新日期**: 2024-01-01

---

## 📋 目录

- [一、系统现状分析](#一系统现状分析)
- [二、升级目标](#二升级目标)
- [三、核心升级内容](#三核心升级内容)
- [四、实施计划](#四实施计划)
- [五、技术架构](#五技术架构)
- [六、预期效果](#六预期效果)

---

## 一、系统现状分析

### 1.1 现有系统架构

当前系统已经实现了以下功能模块：
- ✅ 仪表盘（Dashboard）
- ✅ 会话管理（Sessions）
- ✅ 机器人管理（Robots）
- ✅ 监控告警（Monitor）
- ✅ AI模块（AI Module）
- ✅ 流程引擎（Flow Engine）
- ✅ 协同分析（Collab Analytics）
- ✅ 售后管理（After Sales）
- ✅ 系统设置（Settings）

### 1.2 流程引擎现状

**现有流程**：
- ✅ 自动调度流程
- ✅ 消息处理流程
- ✅ 社群分析流程
- ✅ 售后处理流程
- ✅ 运营维护流程
- ✅ 协同分析流程

**现有节点类型**：16种节点类型（v6.1多任务节点架构）

### 1.3 存在的问题

#### 问题1：角色识别不完整
- ❌ 无法区分运营（财神爷）、工作人员（群助理/售后）、用户（号主）
- ❌ 现有系统只能识别用户/机器人

#### 问题2：流程缺少分支
- ❌ 现有流程是线性的，缺少根据发送者身份进行分支处理的逻辑
- ❌ 运营消息没有最高优先级处理

#### 问题3：延迟控制缺失
- ❌ 没有晚班/深夜的延迟发送机制
- ❌ 没有延迟队列

#### 问题4：异步结果确认不完善
- ❌ 虽然有机器人指令执行，但缺少1分钟后的结果确认机制

#### 问题5：上下文系统不完善
- ❌ 缺少用户画像表
- ❌ 缺少工作人员状态管理
- ❌ 没有明确的上下文长度限制

#### 问题6：售后响应识别缺失
- ❌ 用户回复"在的"、"好的"时，系统无法识别为售后响应
- ❌ 用户响应后没有及时安抚

---

## 二、升级目标

### 2.1 核心目标

1. **完善角色识别系统**
   - 支持运营（财神爷）、工作人员、用户、机器人的完整识别
   - 运营消息最高优先级处理

2. **优化流程引擎架构**
   - 采用统一消息路由架构（一个主流程 + 4个分支）
   - 完整的节点属性配置

3. **实现延迟控制**
   - 白班/晚班/深夜的延迟策略
   - 指令队列系统

4. **完善异步结果确认**
   - 1分钟后查询执行结果
   - 失败后自动重试（最多3次）

5. **优化售后响应处理**
   - 智能识别用户售后响应
   - 机器人安抚用户功能

6. **完善上下文系统**
   - 用户画像
   - 工作人员状态管理
   - 明确的上下文长度限制

### 2.2 机器人角色配置

```
┌──────────────┬────────┬──────────────┬──────────────┬────────────────┐
│  机器人类型  │ 数量/群 │    时段     │     职责     │     特点       │
├──────────────┼────────┼──────────────┼──────────────┼────────────────┤
│  监控机器人  │  1 个  │   24 小时   │  监控所有消息 │  独立运行，     │
│              │        │              │  不上报回复   │  确保监控信息   │
│              │        │              │              │  不断           │
├──────────────┼────────┼──────────────┼──────────────┼────────────────┤
│  通知机器人  │  1 个  │   24 小时   │  发送通知、   │  独立，专门     │
│              │        │              │  提醒、告警   │  发送通知       │
├──────────────┼────────┼──────────────┼──────────────┼────────────────┤
│  白班回复机  │  1 个  │  9:00-21:00  │  社群运营、   │  系统的大脑     │
│  器人        │        │              │  疑虑解答     │  + 手脚         │
├──────────────┼────────┼──────────────┼──────────────┼────────────────┤
│  晚班回复机  │  1 个  │ 21:00-9:00   │  同上 + 延迟  │  深夜按重要性   │
│  器人        │        │              │  控制         │  回复           │
└──────────────┴────────┴──────────────┴──────────────┴────────────────┘

核心概念：
【系统 = 机器人大脑】
【机器人 = 系统的手脚】

机器人职责：
1. 上报消息（接收企业微信群消息）
2. 执行回复动作（发送消息到企业微信群）

系统职责：
1. 接收消息（从机器人上报的消息）
2. 分析决策（AI 意图识别、告警判断）
3. 生成回复（AI 生成回复内容）
4. 发送指令（给机器人发送执行指令）
```

---

## 三、核心升级内容

### 3.1 流程引擎升级

#### 统一消息路由架构

```
统一消息处理主流程（Message Routing Flow）

【触发器】企业微信群消息回调
        ↓
【节点 1】消息接收与保存
        ↓
【节点 2】发送者身份识别
        ↓
【节点 2.5】售后任务关联检查（新增）
        ↓
        ├─ 【检测到售后响应】→ 【分支 C】的【节点 C3】
        └─ 【未检测到售后响应】→ 【节点 3】角色路由
        ↓
【节点 3】角色路由
        ├─ 【分支 A】运营消息处理（最高优先级）
        │   → 节点 A1：运营消息识别与跟踪
        │   → 节点 A2：号主响应检测
        │   → 节点 A3：无人回应通知处理
        │   → 节点 A4：冲突检测与调和
        │
        ├─ 【分支 B】工作人员消息处理
        │   → 节点 B1：工作人员活跃度记录
        │   → 节点 B2：工作人员介入判断
        │   → 节点 B3：介入通知执行
        │
        ├─ 【分支 C】售后 @ 消息处理
        │   → 节点 C1：售后消息识别
        │   → 节点 C2：创建售后跟踪任务
        │   → 节点 C3：用户响应检测（含机器人安抚）
        │   → 节点 C4：售后无人回应通知
        │   → 节点 C5：任务完成跟踪
        │   → 节点 C6：协同分析与报告
        │
        └─ 【分支 D】用户消息处理（核心流程）
            → 节点 D1：用户消息意图识别
            → 节点 D2：告警判断与分类
            → 节点 D3：AI 回复决策
            → 节点 D4：AI 回复生成
            → 节点 D5：回复质量检查
            → 节点 D6：延迟控制
            → 节点 D7：机器人通讯执行
            → 节点 D8：异步结果确认
        ↓
【节点 4】会话管理与分析（统一结束节点）
```

#### 16种节点类型

**触发器节点（1种）**：
1. TRIGGER_WEBHOOK：Webhook触发器

**处理节点（3种）**：
2. MESSAGE_RECEIVE：消息接收与保存
3. SENDER_IDENTIFY：发送者身份识别
4. CONDITION_BRANCH：条件分支

**运营节点（4种）**：
5. OPERATION_TRACK：运营消息识别与跟踪
6. USER_RESPONSE_DETECT：号主响应检测
7. NO_RESPONSE_NOTIFY：无人回应通知处理
8. CONFLICT_DETECT：冲突检测与调和

**工作人员节点（3种）**：
9. STAFF_ACTIVITY_RECORD：工作人员活跃度记录
10. STAFF_INTERVENTION_DETECT：工作人员介入判断
11. INTERVENTION_NOTIFY：介入通知执行

**售后节点（5种）**：
12. AFTER_SALES_IDENTIFY：售后消息识别
13. AFTER_SALES_TASK_CREATE：创建售后跟踪任务
14. AFTER_SALES_RESPONSE_DETECT：用户响应检测
15. AFTER_SALES_NO_RESPONSE_NOTIFY：售后无人回应通知
16. AFTER_SALES_TASK_TRACK：任务完成跟踪

**用户节点（8种）**：
17. INTENT_RECOGNIZE：用户消息意图识别
18. ALERT_JUDGE：告警判断与分类
19. AI_REPLY_DECISION：AI回复决策
20. AI_REPLY_GENERATE：AI回复生成
21. REPLY_QUALITY_CHECK：回复质量检查
22. DELAY_CONTROL：延迟控制
23. ROBOT_COMMAND_SEND：机器人通讯执行
24. ASYNC_RESULT_CHECK：异步结果确认

**会话节点（3种）**：
25. SESSION_UPDATE：会话状态更新
26. CONTEXT_UPDATE：上下文更新
27. ANALYSIS_TRIGGER：协同分析触发

### 3.2 延迟控制策略

```
┌────────────┬────────────┬─────────────┬─────────────┬─────────────────┐
│   时段     │  时间范围  │  最小延迟   │  最大延迟   │     适用规则     │
├────────────┼────────────┼─────────────┼─────────────┼─────────────────┤
│  白班      │ 9:00-21:00 │     0 秒    │     0 秒    │   立即回复      │
├────────────┼────────────┼─────────────┼─────────────┼─────────────────┤
│  晚班      │ 21:00-24:00 │   60 秒     │   300 秒    │  随机延迟1-5分钟 │
├────────────┼────────────┼─────────────┼─────────────┼─────────────────┤
│  深夜      │            │             │             │                 │
│  - 高优先级│ 0:00-6:00  │   300 秒    │   600 秒    │  延迟5-10分钟   │
│  - 中优先级│ 0:00-6:00  │   600 秒    │  1800 秒    │  延迟10-30分钟  │
│  - 低优先级│ 0:00-6:00  │    -        │    -        │  不回复，次日处理│
└────────────┴────────────┴─────────────┴─────────────┴─────────────────┘

优先级判断规则：

【高优先级】
- 用户投诉/不满意
- 涉及运营（财神爷）
- 实名认证/扫码认证（售后任务）
- 紧急服务咨询

【中优先级】
- 普通服务咨询
- 绑定手机（售后任务）
- 帮助请求
- 重要问题询问

【低优先级】
- 闲聊
- 垃圾信息
- 欢迎语
- 次要问题询问
```

### 3.3 告警级别与处理策略

```
┌────────────┬─────────────────┬──────────────────┬──────────────────────┐
│  告警级别  │    触发条件     │    通知方式      │      处理策略        │
├────────────┼─────────────────┼──────────────────┼──────────────────────┤
│  critical  │ 用户投诉/不满意 │ 立即通知 + 推送到 │ 立即介入，通知管理层  │
│   (最高)   │ 涉及运营（财神）│ 监控屏 + 发送给  │                      │
│            │ 用户情绪恶化     │ 管理层           │                      │
├────────────┼─────────────────┼──────────────────┼──────────────────────┤
│   error    │ 用户情绪持续恶化 │ 推送到监控屏 +   │ 关注处理，通知工作群  │
│   (高)     │ 用户流失风险高   │ 发送给工作群     │                      │
│            │ 长时间未回复     │                  │                      │
├────────────┼─────────────────┼──────────────────┼──────────────────────┤
│  warning   │ 长时间未回复     │ 推送到监控屏     │ 记录跟踪，等待处理    │
│   (中)     │ 用户询问重要问题 │                  │                      │
├────────────┼─────────────────┼──────────────────┼──────────────────────┤
│   info     │ 普通记录         │ 只记录，不通知   │ 仅记录，不主动处理    │
│   (低)     │                  │                  │                      │
└────────────┴─────────────────┴──────────────────┴──────────────────────┘

告警取消条件：
【自动取消】
- 用户情绪好转（positive）
- 连续 3 条正面消息
- 投诉撤销/问题解决

【取消后处理】
- 更新告警状态为 "已解决"
- 保留历史记录（数据留痕）
- 推送到监控面板，显示"告警已取消"

告警提升策略：
【提升条件】
- 同一问题未解决 + 超过 2 小时 → 提升一级
- 用户情绪持续恶化 → 提升一级
- 最高提升到 critical

【降级条件】
- 单日告警次数 >= 3 次 → 降级为 info（只记录）
```

### 3.4 售后响应处理优化

#### 售后任务关联检查

```
【节点 2.5】售后任务关联检查（新增）

功能：检查用户是否响应了售后的 @ 消息

检查逻辑：
├─ 检查该用户是否有待处理的售后任务
│   ├─ 查询条件：
│   │   ├─ target_user_id = 当前用户ID
│   │   ├─ group_id = 当前群ID
│   │   └─ status IN ('pending', 'waiting_user_response')
│   └─ 如果有，返回任务信息
│
├─ 检查消息内容是否包含响应关键词
│   ├─ 响应关键词："在的"、"来了"、"好的"、"收到"、"马上"、"可以"、"行"、"是的"
│   └─ 如果包含，判断为响应消息
│
└─ 判断是否需要路由到售后分支
    ├─ 【条件 1】有待处理的售后任务 + 消息内容包含响应关键词
    │   └─ 标记 context.isAfterSalesResponse = true
    │   └─ 记录 context.afterSalesTaskId = 任务ID
    │   └─ 路由到【分支 C】的【节点 C3】用户响应检测
    │
    ├─ 【条件 2】没有待处理的售后任务
    │   └─ 标记 context.isAfterSalesResponse = false
    │   └─ 继续走【节点 3】角色路由
    │
    └─ 【条件 3】有待处理的售后任务但消息内容不包含响应关键词
        └─ 标记 context.isAfterSalesResponse = false
        └─ 继续走【节点 3】角色路由（用户可能有其他问题）

输出：
├─ isAfterSalesResponse: boolean
├─ afterSalesTaskId: string | null
└─ routeToAfterSales: boolean
```

#### 机器人安抚用户

```
【节点 C3】用户响应检测（优化版）

步骤 2：机器人安抚用户（新增）
├─ 判断是否需要机器人安抚：
│   ├─ 【条件 1】售后人员在线 → 安抚消息："好的，请稍等，售后人员马上就来处理 👍"
│   ├─ 【条件 2】售后人员忙碌 → 安抚消息："好的，请稍等，售后人员正在处理其他任务，马上就来 ⏳"
│   └─ 【条件 3】售后人员离线 → 安抚消息："好的，请稍等，已通知售后人员，马上会来处理 🔔"
│
├─ 生成安抚消息：
│   ├─ 标准模板："[用户昵称]，好的，请稍等，售后人员马上就来处理"
│   ├─ 可配置：管理员可以在后台自定义安抚消息模板
│   └─ 添加表情符号：让消息更友好
│
├─ 选择回复机器人：
│   ├─ 使用白班回复机器人（9:00-21:00）
│   └─ 使用晚班回复机器人（21:00-9:00）
│
├─ 发送安抚消息：
│   ├─ 调用机器人 API
│   ├─ 发送到群聊
│   └─ @ 用户（增强提醒效果）
│
└─ 记录安抚消息：
    ├─ 保存到 session_messages 表
    └─ 推送到监控面板
```

### 3.5 冲突调和机制

```
【节点 A4】冲突检测与调和

冲突检测：
├─ 检测运营和用户是否发生冲突
├─ 检测指标：
│   ├─ 运营语气不好（情绪分析，情绪分数 < 0.3）
│   ├─ 用户抱怨/投诉（关键词检测）
│   └─ 消息内容包含冲突信号

调和处理：
├─ 启动调和流程
├─ 生成调和消息：
│   "我们马上配合他，去帮助他完成实名或者扫码登录等相关工作"
├─ 调用机器人发送到群内
├─ 同时发送通知给工作人员工作群
├─ 推送到监控面板，标记为 "冲突调和中"
├─ 更新 track_tasks 表，标记冲突
└─ 记录到协同分析，进行后续跟进
```

### 3.6 异步结果确认机制

```
【节点 D8】异步结果确认

1 分钟后查询执行结果：
├─ 调用机器人 API 查询结果
└─ 获取执行状态：success/failed/timeout

更新 robot_commands 表：
├─ success → status = "completed", result = "成功"
├─ failed → status = "failed", result = "失败"
└─ timeout → status = "timeout", result = "超时"

处理失败/超时情况：
├─ 记录错误日志
├─ 推送到监控面板，高亮显示
├─ 检查重试次数
├─ 如果重试次数 < 3 → 自动重试
└─ 如果重试次数 >= 3 → 转为人工处理

保存到 execution_tracking 表
```

---

## 四、实施计划

### 4.1 任务清单

#### P0任务（12个）

**任务1：创建数据库表结构**
- 创建 flow_definitions 表
- 创建 flow_instances 表
- 创建 flow_execution_logs 表
- 创建 track_tasks 表
- 创建 robot_command_queue 表

**任务2：修改现有表结构**
- 修改 messages 表（添加字段）
- 修改 session_messages 表（添加字段）

**任务3：创建统一消息处理流程定义**
- 定义24个节点
- 配置节点属性
- 建立节点连接关系
- 保存到flow_definitions表

**任务4：实现流程管理API**
- 创建流程
- 更新流程
- 删除流程
- 激活流程
- 停用流程

**任务5：实现流程实例API**
- 获取流程实例列表
- 获取流程实例详情
- 获取流程实例执行日志
- 取消流程实例

**任务6：实现跟踪任务API**
- 创建跟踪任务
- 更新跟踪任务
- 删除跟踪任务
- 完成跟踪任务

**任务7：实现指令队列API**
- 添加指令到队列
- 获取队列中的指令
- 更新指令状态
- 检查指令结果
- 重试指令

**任务8：实现流程引擎核心逻辑**
- 流程实例创建
- 节点执行
- 条件分支路由
- 上下文管理

**任务9：实现16种节点类型**
- 触发器节点（1种）
- 处理节点（3种）
- 运营节点（4种）
- 工作人员节点（3种）
- 售后节点（5种）
- 用户节点（8种）
- 会话节点（3种）

**任务10：实现前端流程引擎管理页面**
- 流程列表
- 查看详情
- 激活/停用

**任务11：实现前端流程可视化编辑器**
- 拖拽式编辑
- 节点属性配置
- 连接关系配置

**任务12：集成Webhook触发流程执行**
- 接收企业微信群消息
- 触发统一消息处理流程
- 保存消息到数据库

#### P1任务（3个）

**任务13：实现流程执行监控**
- 实时显示流程执行状态
- 节点执行时间
- 错误日志

**任务14：实现流程版本管理**
- 版本历史
- 回滚
- 版本对比

**任务15：实现流程测试功能**
- 模拟触发
- 查看执行结果
- 调试节点

### 4.2 实施顺序

**第一阶段：数据库层面**
1. 任务1：创建数据库表结构
2. 任务2：修改现有表结构

**第二阶段：后端核心功能**
3. 任务4：实现流程管理API
4. 任务5：实现流程实例API
6. 任务8：实现流程引擎核心逻辑
7. 任务9：实现16种节点类型

**第三阶段：业务功能**
8. 任务3：创建统一消息处理流程定义
9. 任务6：实现跟踪任务API
10. 任务7：实现指令队列API
11. 任务12：集成Webhook触发流程执行

**第四阶段：前端界面**
12. 任务10：实现前端流程引擎管理页面
13. 任务11：实现前端流程可视化编辑器

**第五阶段：优化功能**
14. 任务13：实现流程执行监控
15. 任务14：实现流程版本管理
16. 任务15：实现流程测试功能

---

## 五、技术架构

### 5.1 系统架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                        企业微信群                                │
└────────────────────────────┬────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────┐
│                    机器人层（4个机器人）                          │
│  ┌────────────┐  ┌────────────┐  ┌────────────┐  ┌────────────┐ │
│  │ 监控机器人  │  │ 通知机器人  │  │白班回复机器人│  │晚班回复机器人│ │
│  └────────────┘  └────────────┘  └────────────┘  └────────────┘ │
└────────────────────────────┬────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────┐
│                      Webhook 回调                                │
└────────────────────────────┬────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────┐
│                   流程引擎（Flow Engine）                         │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │            统一消息处理流程                                │  │
│  │  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐    │  │
│  │  │ 节点1   │→ │ 节点2   │→ │ 节点2.5 │→ │ 节点3   │    │  │
│  │  │消息接收 │  │身份识别 │  │售后检查 │  │角色路由 │    │  │
│  │  └─────────┘  └─────────┘  └─────────┘  └─────────┘    │  │
│  │       │             │             │         │          │  │
│  │       │             │             │         ├─ 分支A  │  │
│  │       │             │             │         ├─ 分支B  │  │
│  │       │             │             │         ├─ 分支C  │  │
│  │       │             │             │         └─ 分支D  │  │
│  │       │             │             │                   │  │
│  │       │             │             └─────────────────→ 节点4 │  │
│  └───────────────────────────────────────────────────────────┘  │
└────────────────────────────┬────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────┐
│                      AI 服务层                                  │
│  ┌────────────┐  ┌────────────┐  ┌────────────┐                │
│  │ 意图识别AI  │  │ 回复生成AI  │  │ 情绪分析AI  │                │
│  └────────────┘  └────────────┘  └────────────┘                │
└────────────────────────────┬────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────┐
│                      指令队列层                                  │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │              robot_command_queue                           │  │
│  │  - 待发送指令                                               │  │
│  │  - 已发送指令                                               │  │
│  │  - 延迟发送指令                                             │  │
│  │  - 失败重试指令                                             │  │
│  └───────────────────────────────────────────────────────────┘  │
└────────────────────────────┬────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────┐
│                      数据层（PostgreSQL + Redis）                 │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │  业务表：                                                  │  │
│  │  - messages                                                │  │
│  │  - session_messages                                        │  │
│  │  - staff_messages                                          │  │
│  │  - track_tasks                                             │  │
│  │  - robot_command_queue                                     │  │
│  │  - flow_definitions                                       │  │
│  │  - flow_instances                                          │  │
│  │  - flow_execution_logs                                     │  │
│  └───────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

### 5.2 技术栈

**后端**：
- Node.js
- Next.js (App Router)
- TypeScript
- PostgreSQL
- Redis

**前端**：
- Next.js
- React 19
- shadcn/ui
- Tailwind CSS

**AI**：
- 豆包（Seed, Doubao）
- DeepSeek
- Kimi

**机器人**：
- WorkTool Robot API

---

## 六、预期效果

### 6.1 系统能力提升

| 功能模块 | 优化前 | 优化后 | 提升效果 |
|---------|--------|--------|---------|
| 角色识别 | 只识别用户/机器人 | 识别5种角色 | ✅ 完整识别 |
| 运营消息处理 | 无专门流程 | 最高优先级处理 | ✅ 100%响应 |
| 售后响应识别 | 无法识别 | 智能识别 | ✅ 准确识别 |
| 延迟控制 | 无延迟 | 分时段延迟 | ✅ 灵活控制 |
| 异步结果确认 | 无确认 | 1分钟自动确认 | ✅ 100%追踪 |
| 用户安抚 | 无安抚 | 机器人立即安抚 | ✅ 即时反馈 |

### 6.2 用户体验提升

| 场景 | 优化前 | 优化后 |
|------|--------|--------|
| 用户回复"在的" | 等待，无反馈 | 机器人立即安抚 |
| 运营发消息 | 无优先级 | 最高优先级处理 |
| 深夜消息 | 立即回复 | 根据重要性延迟 |
| 售后任务 | 无法识别 | 智能识别和安抚 |
| 冲突处理 | 无处理 | 自动调和 |

### 6.3 运营效率提升

| 指标 | 优化前 | 优化后 | 提升 |
|------|--------|--------|------|
| 响应速度 | 依赖人工 | 机器人立即安抚 | ⚡ 90% |
| 用户满意度 | 未知 | 可量化追踪 | 📈 可视化 |
| 告警处理 | 手动 | 自动分级 | 🎯 精准 |
| 售后跟进 | 被动 | 主动提醒 | 🔔 即时 |

---

## 七、附录

### 7.1 文档列表

1. 完整系统升级方案.md（本文档）
2. 流程引擎详细设计.md
3. 数据库设计.md
4. API接口设计.md
5. 前端页面设计.md
6. 流程图-文字版.md

### 7.2 关键特性总结

✅ **完整的节点属性配置**
- 每个节点都有详细的 data.config 配置项
- 运营节点：响应超时、自动取消、调和消息
- 工作人员节点：介入规则、通知方式
- 售后节点：任务类型映射、截止时间
- 用户节点：告警规则、延迟配置、质量检查

✅ **延迟控制策略**
- 白班（9:00-21:00）：无延迟
- 晚班（21:00-9:00）：延迟 1-5 分钟
- 深夜（0:00-6:00）：根据重要性延迟 5-30 分钟或不回复

✅ **告警取消规则**
- 用户情绪好转 + 连续 3 条正面消息 → 自动取消告警
- 取消后保留历史记录（数据留痕）

✅ **冲突调和机制**
- 运营和用户冲突时自动调和
- 生成调和消息："我们马上配合他，去帮助他完成实名或者扫码登录等相关工作"

✅ **异步结果确认**
- 机器人指令发送后 1 分钟自动查询结果
- 失败后自动重试（最多 3 次）
- 超过最大重试次数转为人工处理

✅ **售后响应智能识别**
- 用户回复"在的"、"好的"等关键词时，自动识别为售后响应
- 机器人立即安抚用户
- 同时通知售后人员

✅ **机器人安抚用户**
- 根据售后人员状态（在线/忙碌/离线）选择不同的安抚消息
- @ 用户，增强提醒效果
- 使用表情符号，让消息更友好

---

## 八、总结

本次系统升级主要聚焦于流程引擎的全面优化，通过以下核心改进，显著提升系统的智能化水平和用户体验：

1. **统一消息路由架构**：采用一个主流程加四个分支的设计，提高流程复用性和可维护性

2. **完整的角色识别**：支持运营、工作人员、用户、机器人的完整识别，实现精准的路由分发

3. **延迟控制策略**：根据时间段（白班/晚班/深夜）和消息重要性，灵活控制回复延迟

4. **售后响应优化**：智能识别用户售后响应，机器人立即安抚用户，提升用户体验

5. **异步结果确认**：确保机器人指令执行结果的准确追踪，失败自动重试

6. **冲突调和机制**：自动检测并调和运营与用户的冲突，维护良好的沟通氛围

7. **告警分级处理**：根据严重程度自动分级处理告警，提高运营效率

通过这些优化，系统将变得更加智能、高效、友好，为用户提供更好的服务体验。

---

**文档结束**
