# æµç¨‹å¼•æ“è¯¦ç»†è®¾è®¡

> **æ–‡æ¡£ç‰ˆæœ¬**: v1.0
> **åˆ›å»ºæ—¥æœŸ**: 2024-01-01
> **ç»´æŠ¤è€…**: WorkTool AI å›¢é˜Ÿ

---

## ğŸ“‹ ç›®å½•

- [ä¸€ã€æµç¨‹å¼•æ“æ¶æ„](#ä¸€æµç¨‹å¼•æ“æ¶æ„)
- [äºŒã€ç»Ÿä¸€æ¶ˆæ¯å¤„ç†æµç¨‹](#äºŒç»Ÿä¸€æ¶ˆæ¯å¤„ç†æµç¨‹)
- [ä¸‰ã€èŠ‚ç‚¹ç±»å‹è¯¦è§£](#ä¸‰èŠ‚ç‚¹ç±»å‹è¯¦è§£)
- [å››ã€æµç¨‹æ‰§è¡Œæœºåˆ¶](#å››æµç¨‹æ‰§è¡Œæœºåˆ¶)
- [äº”ã€ä¸Šä¸‹æ–‡ç®¡ç†](#äº”ä¸Šä¸‹æ–‡ç®¡ç†)
- [å…­ã€æµç¨‹ç‰ˆæœ¬ç®¡ç†](#å…­æµç¨‹ç‰ˆæœ¬ç®¡ç†)

---

## ä¸€ã€æµç¨‹å¼•æ“æ¶æ„

### 1.1 æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æµç¨‹å¼•æ“æ¶æ„                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ æµç¨‹å®šä¹‰å±‚   â”‚â”€â”€â”€â”€â–¶â”‚ æµç¨‹å®ä¾‹å±‚   â”‚â”€â”€â”€â”€â–¶â”‚ æµç¨‹æ‰§è¡Œå±‚   â”‚    â”‚
â”‚  â”‚              â”‚     â”‚              â”‚     â”‚              â”‚    â”‚
â”‚  â”‚ â€¢ æµç¨‹å®šä¹‰   â”‚     â”‚ â€¢ æµç¨‹å®ä¾‹   â”‚     â”‚ â€¢ èŠ‚ç‚¹æ‰§è¡Œ   â”‚    â”‚
â”‚  â”‚ â€¢ èŠ‚ç‚¹å®šä¹‰   â”‚     â”‚ â€¢ æ‰§è¡ŒçŠ¶æ€   â”‚     â”‚ â€¢ æ¡ä»¶åˆ†æ”¯   â”‚    â”‚
â”‚  â”‚ â€¢ è¿æ¥å…³ç³»   â”‚     â”‚ â€¢ æ‰§è¡Œæ—¥å¿—   â”‚     â”‚ â€¢ å¼‚æ­¥å¤„ç†   â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ ä¸Šä¸‹æ–‡ç®¡ç†å±‚ â”‚     â”‚ æ•°æ®æŒä¹…å±‚   â”‚     â”‚ ç›‘æ§ä¸æ—¥å¿—   â”‚    â”‚
â”‚  â”‚              â”‚     â”‚              â”‚     â”‚              â”‚    â”‚
â”‚  â”‚ â€¢ ä¸Šä¸‹æ–‡     â”‚     â”‚ â€¢ PostgreSQL â”‚     â”‚ â€¢ æ‰§è¡Œç›‘æ§   â”‚    â”‚
â”‚  â”‚ â€¢ å†å²æ¶ˆæ¯   â”‚     â”‚ â€¢ Redis      â”‚     â”‚ â€¢ æ€§èƒ½æŒ‡æ ‡   â”‚    â”‚
â”‚  â”‚ â€¢ ç”¨æˆ·ç”»åƒ   â”‚     â”‚ â€¢ ç¼“å­˜ç®¡ç†   â”‚     â”‚ â€¢ é”™è¯¯æ—¥å¿—   â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 æ ¸å¿ƒç»„ä»¶

| ç»„ä»¶ | èŒè´£ | å…³é”®åŠŸèƒ½ |
|------|------|----------|
| **æµç¨‹å®šä¹‰ç®¡ç†å™¨** | ç®¡ç†æµç¨‹å®šä¹‰ | åˆ›å»º/æ›´æ–°/åˆ é™¤/æ¿€æ´»/åœç”¨æµç¨‹ |
| **æµç¨‹å®ä¾‹ç®¡ç†å™¨** | ç®¡ç†æµç¨‹å®ä¾‹ | åˆ›å»º/æ‰§è¡Œ/å–æ¶ˆ/æŸ¥è¯¢æµç¨‹å®ä¾‹ |
| **èŠ‚ç‚¹æ‰§è¡Œå™¨** | æ‰§è¡Œå•ä¸ªèŠ‚ç‚¹ | èŠ‚ç‚¹é€»è¾‘æ‰§è¡Œã€è¾“å…¥è¾“å‡ºå¤„ç† |
| **ä¸Šä¸‹æ–‡ç®¡ç†å™¨** | ç®¡ç†æ‰§è¡Œä¸Šä¸‹æ–‡ | ä¸Šä¸‹æ–‡åˆ›å»º/æ›´æ–°/æŸ¥è¯¢/æ¸…ç† |
| **æ¡ä»¶è·¯ç”±å™¨** | å¤„ç†æ¡ä»¶åˆ†æ”¯ | æ¡ä»¶åˆ¤æ–­ã€è·¯ç”±å†³ç­– |
| **å¼‚æ­¥å¤„ç†å™¨** | å¤„ç†å¼‚æ­¥ä»»åŠ¡ | å»¶è¿Ÿé˜Ÿåˆ—ã€å®šæ—¶ä»»åŠ¡ã€ç»“æœç¡®è®¤ |
| **æ‰§è¡Œæ—¥å¿—è®°å½•å™¨** | è®°å½•æ‰§è¡Œæ—¥å¿— | èŠ‚ç‚¹æ‰§è¡Œè®°å½•ã€é”™è¯¯æ—¥å¿—ã€æ€§èƒ½æŒ‡æ ‡ |
| **ç‰ˆæœ¬ç®¡ç†å™¨** | ç®¡ç†æµç¨‹ç‰ˆæœ¬ | ç‰ˆæœ¬å†å²ã€å›æ»šã€ç‰ˆæœ¬å¯¹æ¯” |

---

## äºŒã€ç»Ÿä¸€æ¶ˆæ¯å¤„ç†æµç¨‹

### 2.1 æµç¨‹å®šä¹‰

```json
{
  "id": "flow_message_routing",
  "name": "ç»Ÿä¸€æ¶ˆæ¯å¤„ç†æµç¨‹",
  "description": "æ ¹æ®å‘é€è€…è§’è‰²è·¯ç”±åˆ°ä¸åŒå¤„ç†åˆ†æ”¯",
  "version": "2.0",
  "status": "active",
  "triggerType": "webhook",
  "nodes": [
    {
      "id": "node_webhook_trigger",
      "nodeType": "trigger_webhook",
      "name": "Webhookè§¦å‘å™¨",
      "position": { "x": 100, "y": 50 },
      "data": {
        "config": {
          "webhookUrl": "/api/robots/callback",
          "verifySignature": true,
          "idempotencyCheck": true
        }
      }
    },
    {
      "id": "node_message_receive",
      "nodeType": "message_receive",
      "name": "æ¶ˆæ¯æ¥æ”¶ä¸ä¿å­˜",
      "position": { "x": 100, "y": 150 },
      "data": {
        "config": {
          "saveToMessagesTable": true,
          "saveToSessionMessages": true,
          "pushToMonitorQueue": true
        }
      }
    },
    {
      "id": "node_sender_identify",
      "nodeType": "sender_identify",
      "name": "å‘é€è€…èº«ä»½è¯†åˆ«",
      "position": { "x": 100, "y": 250 },
      "data": {
        "config": {
          "operationUserIdList": [],
          "groupAssistantUserIdList": [],
          "afterSalesUserIdList": [],
          "robotIdList": []
        }
      }
    },
    {
      "id": "node_after_sales_task_check",
      "nodeType": "after_sales_task_check",
      "name": "å”®åä»»åŠ¡å…³è”æ£€æŸ¥",
      "position": { "x": 100, "y": 350 },
      "data": {
        "config": {
          "responseKeywords": ["åœ¨çš„", "æ¥äº†", "å¥½çš„", "æ”¶åˆ°", "é©¬ä¸Š", "å¯ä»¥", "è¡Œ", "æ˜¯çš„"],
          "completionKeywords": ["å®Œæˆäº†", "æå®š", "å¯ä»¥äº†", "å®Œæˆ"],
          "autoRouteToAfterSales": true,
          "pendingTaskStatus": ["pending", "waiting_user_response"]
        }
      }
    },
    {
      "id": "node_condition_branch",
      "nodeType": "condition_branch",
      "name": "è§’è‰²è·¯ç”±",
      "position": { "x": 100, "y": 450 },
      "data": {
        "config": {
          "conditionField": "context.senderRole",
          "branches": [
            {
              "condition": "context.senderRole === 'operation'",
              "targetNodeId": "node_operation_track",
              "priority": 0
            },
            {
              "condition": "context.senderRole === 'group_assistant' || context.senderRole === 'after_sales'",
              "targetNodeId": "node_staff_activity_record",
              "priority": 1
            },
            {
              "condition": "context.routeToAfterSales === true",
              "targetNodeId": "node_after_sales_response_detect",
              "priority": 2
            },
            {
              "condition": "context.senderRole === 'user'",
              "targetNodeId": "node_intent_recognize",
              "priority": 3
            }
          ]
        }
      }
    }
  ],
  "connections": [
    { "source": "node_webhook_trigger", "target": "node_message_receive" },
    { "source": "node_message_receive", "target": "node_sender_identify" },
    { "source": "node_sender_identify", "target": "node_after_sales_task_check" },
    { "source": "node_after_sales_task_check", "target": "node_condition_branch" }
  ]
}
```

### 2.2 æµç¨‹æ‰§è¡Œæµç¨‹

```
1. Webhook è§¦å‘
   â†“
2. åˆ›å»ºæµç¨‹å®ä¾‹
   â”œâ”€ ç”Ÿæˆå®ä¾‹ID
   â”œâ”€ åˆå§‹åŒ–ä¸Šä¸‹æ–‡ï¼ˆcontextï¼‰
   â”œâ”€ åŠ è½½æµç¨‹å®šä¹‰
   â””â”€ ä¿å­˜åˆ° flow_instances è¡¨
   â†“
3. æ‰§è¡ŒèŠ‚ç‚¹åºåˆ—
   â”œâ”€ ä»ç¬¬ä¸€ä¸ªèŠ‚ç‚¹å¼€å§‹
   â”œâ”€ è°ƒç”¨èŠ‚ç‚¹æ‰§è¡Œå™¨
   â”œâ”€ è®°å½•æ‰§è¡Œæ—¥å¿—
   â””â”€ å¤„ç†è¾“å‡ºæ•°æ®
   â†“
4. æ¡ä»¶åˆ†æ”¯å¤„ç†
   â”œâ”€ è¯„ä¼°æ¡ä»¶è¡¨è¾¾å¼
   â”œâ”€ é€‰æ‹©ç›®æ ‡èŠ‚ç‚¹
   â””â”€ è·¯ç”±åˆ°å¯¹åº”åˆ†æ”¯
   â†“
5. åˆ†æ”¯æ‰§è¡Œ
   â”œâ”€ è¿è¥æ¶ˆæ¯å¤„ç†åˆ†æ”¯
   â”œâ”€ å·¥ä½œäººå‘˜æ¶ˆæ¯å¤„ç†åˆ†æ”¯
   â”œâ”€ å”®åååŠ©åˆ†æ”¯
   â””â”€ ç”¨æˆ·æ¶ˆæ¯å¤„ç†åˆ†æ”¯
   â†“
6. ä¼šè¯ç®¡ç†ä¸åˆ†æ
   â”œâ”€ æ›´æ–°ä¼šè¯çŠ¶æ€
   â”œâ”€ æ›´æ–°ä¸Šä¸‹æ–‡
   â”œâ”€ è§¦å‘ååŒåˆ†æ
   â””â”€ æ¨é€åˆ°ç›‘æ§é¢æ¿
   â†“
7. æµç¨‹ç»“æŸ
   â”œâ”€ æ›´æ–°å®ä¾‹çŠ¶æ€ä¸º "completed"
   â”œâ”€ è®°å½•å®Œæˆæ—¶é—´
   â””â”€ ä¿å­˜æœ€ç»ˆä¸Šä¸‹æ–‡
```

---

## ä¸‰ã€èŠ‚ç‚¹ç±»å‹è¯¦è§£

### 3.1 è§¦å‘å™¨èŠ‚ç‚¹

#### TRIGGER_WEBHOOKï¼šWebhookè§¦å‘å™¨

```typescript
{
  nodeType: 'trigger_webhook',
  name: 'ä¼ä¸šå¾®ä¿¡ç¾¤æ¶ˆæ¯å›è°ƒ',
  description: 'æ¥æ”¶ä¼ä¸šå¾®ä¿¡ç¾¤æ¶ˆæ¯Webhook',
  data: {
    config: {
      webhookUrl: '/api/robots/callback',
      verifySignature: true,
      idempotencyCheck: true
    }
  },
  output: {
    message: {
      messageId: string,
      content: string,
      senderId: string,
      senderName: string,
      groupId: string,
      groupName: string,
      timestamp: Date
    }
  }
}
```

### 3.2 å¤„ç†èŠ‚ç‚¹

#### MESSAGE_RECEIVEï¼šæ¶ˆæ¯æ¥æ”¶ä¸ä¿å­˜

```typescript
{
  nodeType: 'message_receive',
  name: 'æ¶ˆæ¯æ¥æ”¶ä¸ä¿å­˜',
  description: 'æ¥æ”¶æ¶ˆæ¯å¹¶ä¿å­˜åˆ°æ•°æ®åº“',
  data: {
    config: {
      saveToMessagesTable: true,
      saveToSessionMessages: true,
      pushToMonitorQueue: true
    }
  },
  output: {
    messageSaved: boolean,
    sessionId: string,
    messageRecordId: string
  }
}
```

#### SENDER_IDENTIFYï¼šå‘é€è€…èº«ä»½è¯†åˆ«

```typescript
{
  nodeType: 'sender_identify',
  name: 'å‘é€è€…èº«ä»½è¯†åˆ«',
  description: 'è¯†åˆ«å‘é€è€…è§’è‰²ï¼ˆè¿è¥/å·¥ä½œäººå‘˜/ç”¨æˆ·/æœºå™¨äººï¼‰',
  data: {
    config: {
      operationUserIdList: string[],
      groupAssistantUserIdList: string[],
      afterSalesUserIdList: string[],
      robotIdList: string[]
    }
  },
  output: {
    senderRole: 'operation' | 'group_assistant' | 'after_sales' | 'user' | 'robot',
    senderUserId: string,
    senderUserName: string,
    confidence: number
  }
}
```

#### AFTER_SALES_TASK_CHECKï¼šå”®åä»»åŠ¡å…³è”æ£€æŸ¥

```typescript
{
  nodeType: 'after_sales_task_check',
  name: 'å”®åä»»åŠ¡å…³è”æ£€æŸ¥',
  description: 'æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å“åº”äº†å”®åçš„ @ æ¶ˆæ¯',
  data: {
    config: {
      responseKeywords: ['åœ¨çš„', 'æ¥äº†', 'å¥½çš„', 'æ”¶åˆ°', 'é©¬ä¸Š', 'å¯ä»¥', 'è¡Œ', 'æ˜¯çš„'],
      completionKeywords: ['å®Œæˆäº†', 'æå®š', 'å¯ä»¥äº†', 'å®Œæˆ'],
      autoRouteToAfterSales: true,
      pendingTaskStatus: ['pending', 'waiting_user_response']
    }
  },
  output: {
    isAfterSalesResponse: boolean,
    afterSalesTaskId: string | null,
    routeToAfterSales: boolean
  }
}
```

### 3.3 è¿è¥èŠ‚ç‚¹

#### OPERATION_TRACKï¼šè¿è¥æ¶ˆæ¯è¯†åˆ«ä¸è·Ÿè¸ª

```typescript
{
  nodeType: 'operation_track',
  name: 'è¿è¥æ¶ˆæ¯è¯†åˆ«ä¸è·Ÿè¸ª',
  description: 'è¯†åˆ«è¿è¥æ¶ˆæ¯å¹¶åˆ›å»ºè·Ÿè¸ªä»»åŠ¡',
  data: {
    config: {
      priority: 'critical',
      detectKeywords: ['è¦æ±‚', 'é…åˆ', 'å®Œæˆ', 'ä»»åŠ¡'],
      responseTimeout: 600,
      autoCancelWhenResponded: true
    }
  },
  output: {
    trackTaskId: string,
    targetUserId: string,
    requirement: string,
    deadline: Date
  }
}
```

### 3.4 å”®åèŠ‚ç‚¹

#### AFTER_SALES_RESPONSE_DETECTï¼šç”¨æˆ·å“åº”æ£€æµ‹

```typescript
{
  nodeType: 'after_sales_response_detect',
  name: 'ç”¨æˆ·å“åº”æ£€æµ‹',
  description: 'æ£€æµ‹å·ä¸»æ˜¯å¦å›åº”äº†å”®å @ æ¶ˆæ¯',
  data: {
    config: {
      responseKeywords: ['åœ¨çš„', 'æ¥äº†', 'å¥½çš„', 'æ”¶åˆ°', 'é©¬ä¸Š', 'å¯ä»¥', 'è¡Œ', 'æ˜¯çš„'],
      timeoutMinutes: 10,
      notifyStaffOnResponse: true,
      
      // æœºå™¨äººå®‰æŠšé…ç½®
      enableBotComfort: true,
      comfortMessageTemplates: {
        online: "{userName}ï¼Œå¥½çš„ï¼Œè¯·ç¨ç­‰ï¼Œå”®åäººå‘˜é©¬ä¸Šå°±æ¥å¤„ç† ğŸ‘",
        busy: "{userName}ï¼Œå¥½çš„ï¼Œè¯·ç¨ç­‰ï¼Œå”®åäººå‘˜æ­£åœ¨å¤„ç†å…¶ä»–ä»»åŠ¡ï¼Œé©¬ä¸Šå°±æ¥ â³",
        offline: "{userName}ï¼Œå¥½çš„ï¼Œè¯·ç¨ç­‰ï¼Œå·²é€šçŸ¥å”®åäººå‘˜ï¼Œé©¬ä¸Šä¼šæ¥å¤„ç† ğŸ””"
      },
      useEmojis: true,
      atUser: true
    }
  },
  output: {
    hasResponded: boolean,
    responseTime: Date,
    responseContent: string,
    botComfortSent: boolean,
    staffNotified: boolean
  }
}
```

### 3.5 ç”¨æˆ·èŠ‚ç‚¹

#### INTENT_RECOGNIZEï¼šç”¨æˆ·æ¶ˆæ¯æ„å›¾è¯†åˆ«

```typescript
{
  nodeType: 'intent_recognize',
  name: 'ç”¨æˆ·æ¶ˆæ¯æ„å›¾è¯†åˆ«',
  description: 'è°ƒç”¨AIè¯†åˆ«ç”¨æˆ·æ¶ˆæ¯æ„å›¾å’Œæƒ…ç»ª',
  data: {
    config: {
      aiModel: 'doubao',
      useContext: true,
      contextLength: 10,
      enableEmotionAnalysis: true
    }
  },
  output: {
    intent: 'chat' | 'service' | 'help' | 'risk' | 'spam' | 'welcome' | 'complaint',
    confidence: number,
    emotion: 'positive' | 'negative' | 'neutral',
    emotionScore: number,
    needReply: boolean,
    replySuggestion: {
      content: string,
      replyType: 'group_chat' | 'group_at_user' | 'private_chat',
      atUser: boolean
    }
  }
}
```

#### DELAY_CONTROLï¼šå»¶è¿Ÿæ§åˆ¶

```typescript
{
  nodeType: 'delay_control',
  name: 'å»¶è¿Ÿæ§åˆ¶',
  description: 'æ ¹æ®æ—¶é—´æ®µå’Œæ¶ˆæ¯é‡è¦æ€§æ§åˆ¶å›å¤å»¶è¿Ÿ',
  data: {
    config: {
      dayShift: {
        startHour: 9,
        endHour: 21,
        minDelay: 0,
        maxDelay: 0
      },
      nightShift: {
        startHour: 21,
        endHour: 24,
        minDelay: 60,
        maxDelay: 300
      },
      lateNight: {
        startHour: 0,
        endHour: 6,
        highPriority: {
          minDelay: 300,
          maxDelay: 600
        },
        mediumPriority: {
          minDelay: 600,
          maxDelay: 1800
        },
        lowPriority: {
          noReply: true
        }
      }
    }
  },
  output: {
    delaySeconds: number,
    delayReason: string,
    scheduledTime: Date
  }
}
```

#### ASYNC_RESULT_CHECKï¼šå¼‚æ­¥ç»“æœç¡®è®¤

```typescript
{
  nodeType: 'async_result_check',
  name: 'å¼‚æ­¥ç»“æœç¡®è®¤',
  description: '1åˆ†é’ŸåæŸ¥è¯¢æœºå™¨äººæ‰§è¡Œç»“æœ',
  data: {
    config: {
      checkDelaySeconds: 60,
      maxCheckAttempts: 3,
      checkIntervalSeconds: 30,
      actionOnFailure: 'manual_intervention'
    }
  },
  output: {
    resultStatus: 'success' | 'failed' | 'timeout',
    resultData: object,
    checkTime: Date,
    isRetried: boolean
  }
}
```

---

## å››ã€æµç¨‹æ‰§è¡Œæœºåˆ¶

### 4.1 æ‰§è¡Œæµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æµç¨‹æ‰§è¡Œæµç¨‹                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. è§¦å‘æµç¨‹
   â”œâ”€ Webhook æ¥æ”¶æ¶ˆæ¯
   â”œâ”€ éªŒè¯ç­¾å
   â”œâ”€ å¹‚ç­‰æ€§æ£€æŸ¥
   â””â”€ åˆ›å»ºæµç¨‹å®ä¾‹

2. åˆå§‹åŒ–ä¸Šä¸‹æ–‡
   â”œâ”€ åˆ›å»º context å¯¹è±¡
   â”œâ”€ åŠ è½½ç”¨æˆ·ç”»åƒ
   â”œâ”€ åŠ è½½å†å²æ¶ˆæ¯ï¼ˆæœ€è¿‘10æ¡ï¼‰
   â”œâ”€ åŠ è½½ç¾¤ä¿¡æ¯
   â””â”€ åŠ è½½å·¥ä½œäººå‘˜çŠ¶æ€

3. æ‰§è¡ŒèŠ‚ç‚¹
   â”œâ”€ ä»èµ·å§‹èŠ‚ç‚¹å¼€å§‹
   â”œâ”€ è°ƒç”¨èŠ‚ç‚¹æ‰§è¡Œå™¨
   â”œâ”€ ä¼ å…¥ input_data
   â”œâ”€ è·å– output_data
   â”œâ”€ æ›´æ–° context
   â””â”€ è®°å½•æ‰§è¡Œæ—¥å¿—

4. æ¡ä»¶åˆ†æ”¯
   â”œâ”€ è¯„ä¼°æ¡ä»¶è¡¨è¾¾å¼
   â”œâ”€ é€‰æ‹©ç›®æ ‡èŠ‚ç‚¹
   â””â”€ è·¯ç”±åˆ°å¯¹åº”åˆ†æ”¯

5. åˆ†æ”¯æ‰§è¡Œ
   â”œâ”€ è¿è¥æ¶ˆæ¯å¤„ç†åˆ†æ”¯
   â”œâ”€ å·¥ä½œäººå‘˜æ¶ˆæ¯å¤„ç†åˆ†æ”¯
   â”œâ”€ å”®åååŠ©åˆ†æ”¯
   â””â”€ ç”¨æˆ·æ¶ˆæ¯å¤„ç†åˆ†æ”¯

6. ç»“æŸæµç¨‹
   â”œâ”€ æ›´æ–°å®ä¾‹çŠ¶æ€ä¸º "completed"
   â”œâ”€ è®°å½•å®Œæˆæ—¶é—´
   â””â”€ ä¿å­˜æœ€ç»ˆä¸Šä¸‹æ–‡
```

### 4.2 é”™è¯¯å¤„ç†

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    é”™è¯¯å¤„ç†æœºåˆ¶                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

é”™è¯¯çº§åˆ«ï¼š
â”œâ”€ FATALï¼šè‡´å‘½é”™è¯¯ï¼Œç«‹å³åœæ­¢æµç¨‹
â”œâ”€ ERRORï¼šé”™è¯¯ï¼Œè®°å½•æ—¥å¿—ä½†ç»§ç»­æ‰§è¡Œ
â”œâ”€ WARNINGï¼šè­¦å‘Šï¼Œè®°å½•æ—¥å¿—
â””â”€ INFOï¼šä¿¡æ¯ï¼Œè®°å½•æ—¥å¿—

é”™è¯¯å¤„ç†ç­–ç•¥ï¼š
â”œâ”€ èŠ‚ç‚¹æ‰§è¡Œå¤±è´¥
â”‚   â”œâ”€ è®°å½•é”™è¯¯æ—¥å¿—
â”‚   â”œâ”€ é‡è¯•ï¼ˆæœ€å¤š3æ¬¡ï¼‰
â”‚   â””â”€ è¶…è¿‡é‡è¯•æ¬¡æ•° â†’ æ ‡è®°ä¸º failed
â”œâ”€ æ¡ä»¶åˆ†æ”¯å¤±è´¥
â”‚   â”œâ”€ è®°å½•é”™è¯¯æ—¥å¿—
â”‚   â”œâ”€ ä½¿ç”¨é»˜è®¤åˆ†æ”¯
â”‚   â””â”€ æ— é»˜è®¤åˆ†æ”¯ â†’ æ ‡è®°ä¸º failed
â””â”€ æµç¨‹æ‰§è¡Œå¤±è´¥
    â”œâ”€ è®°å½•é”™è¯¯æ—¥å¿—
    â”œâ”€ æ›´æ–°å®ä¾‹çŠ¶æ€ä¸º "failed"
    â””â”€ å‘é€å‘Šè­¦é€šçŸ¥
```

### 4.3 æ€§èƒ½ä¼˜åŒ–

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æ€§èƒ½ä¼˜åŒ–ç­–ç•¥                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç¼“å­˜ç­–ç•¥ï¼š
â”œâ”€ æµç¨‹å®šä¹‰ç¼“å­˜ï¼ˆTTL: 300ç§’ï¼‰
â”œâ”€ èŠ‚ç‚¹é…ç½®ç¼“å­˜ï¼ˆTTL: 300ç§’ï¼‰
â”œâ”€ ç”¨æˆ·ç”»åƒç¼“å­˜ï¼ˆTTL: 60ç§’ï¼‰
â”œâ”€ å†å²æ¶ˆæ¯ç¼“å­˜ï¼ˆTTL: 60ç§’ï¼‰
â””â”€ å·¥ä½œäººå‘˜çŠ¶æ€ç¼“å­˜ï¼ˆTTL: 30ç§’ï¼‰

å¼‚æ­¥å¤„ç†ï¼š
â”œâ”€ æ¶ˆæ¯ä¿å­˜ï¼ˆå¼‚æ­¥ï¼‰
â”œâ”€ é€šçŸ¥å‘é€ï¼ˆå¼‚æ­¥ï¼‰
â”œâ”€ åˆ†æè§¦å‘ï¼ˆå¼‚æ­¥ï¼‰
â””â”€ æ—¥å¿—è®°å½•ï¼ˆå¼‚æ­¥ï¼‰

æ‰¹é‡å¤„ç†ï¼š
â”œâ”€ æ‰¹é‡æ’å…¥æ¶ˆæ¯ï¼ˆæ¯100æ¡ï¼‰
â”œâ”€ æ‰¹é‡æ›´æ–°ä¸Šä¸‹æ–‡ï¼ˆæ¯10æ¡ï¼‰
â””â”€ æ‰¹é‡å‘é€é€šçŸ¥ï¼ˆæ¯10æ¡ï¼‰

ç´¢å¼•ä¼˜åŒ–ï¼š
â”œâ”€ flow_definitions: id, status, version
â”œâ”€ flow_instances: id, flow_definition_id, status, started_at
â”œâ”€ track_tasks: id, target_user_id, group_id, status
â””â”€ robot_command_queue: id, status, scheduled_at
```

---

## äº”ã€ä¸Šä¸‹æ–‡ç®¡ç†

### 5.1 ä¸Šä¸‹æ–‡ç»“æ„

```typescript
interface FlowContext {
  // æµç¨‹åŸºæœ¬ä¿¡æ¯
  instanceId: string;
  flowDefinitionId: string;
  startedAt: Date;
  
  // æ¶ˆæ¯ä¿¡æ¯
  message: {
    messageId: string;
    content: string;
    senderId: string;
    senderName: string;
    groupId: string;
    groupName: string;
    timestamp: Date;
  };
  
  // å‘é€è€…ä¿¡æ¯
  senderRole: 'operation' | 'group_assistant' | 'after_sales' | 'user' | 'robot';
  senderUserId: string;
  senderUserName: string;
  
  // ä¼šè¯ä¿¡æ¯
  sessionId: string;
  sessionType: 'user' | 'group';
  
  // ç”¨æˆ·ç”»åƒ
  userProfile: {
    userId: string;
    userName: string;
    companyName: string;
    satisfactionScore: number;
    emotion: 'positive' | 'negative' | 'neutral';
    cooperationLevel: number;
    complaintCount: number;
  };
  
  // å†å²æ¶ˆæ¯
  history: Array<{
    role: 'user' | 'assistant';
    content: string;
    timestamp: Date;
  }>;
  
  // å”®åä»»åŠ¡
  pendingAfterSalesTask?: {
    taskId: string;
    taskType: string;
    status: string;
  };
  
  // å‘Šè­¦ä¿¡æ¯
  alertInfo?: {
    hasAlert: boolean;
    alertLevel: string;
    alertType: string;
  };
  
  // æ‰©å±•æ•°æ®
  metadata: Record<string, any>;
}
```

### 5.2 ä¸Šä¸‹æ–‡ç®¡ç†ç­–ç•¥

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ä¸Šä¸‹æ–‡ç®¡ç†ç­–ç•¥                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

åˆ›å»ºä¸Šä¸‹æ–‡ï¼š
â”œâ”€ ä»æ•°æ®åº“åŠ è½½ç”¨æˆ·ç”»åƒ
â”œâ”€ ä»æ•°æ®åº“åŠ è½½å†å²æ¶ˆæ¯ï¼ˆæœ€è¿‘10æ¡ï¼‰
â”œâ”€ ä»æ•°æ®åº“åŠ è½½ç¾¤ä¿¡æ¯
â”œâ”€ ä»æ•°æ®åº“åŠ è½½å·¥ä½œäººå‘˜çŠ¶æ€
â””â”€ åˆå§‹åŒ–æ‰©å±•æ•°æ®

æ›´æ–°ä¸Šä¸‹æ–‡ï¼š
â”œâ”€ æ·»åŠ æœ€æ–°æ¶ˆæ¯åˆ° history
â”œâ”€ é™åˆ¶ history é•¿åº¦ï¼ˆæœ€å¤š50æ¡ï¼‰
â”œâ”€ æ›´æ–°ç”¨æˆ·ç”»åƒ
â”œâ”€ æ›´æ–°å·¥ä½œäººå‘˜çŠ¶æ€
â””â”€ æ›´æ–°æ‰©å±•æ•°æ®

æŸ¥è¯¢ä¸Šä¸‹æ–‡ï¼š
â”œâ”€ é€šè¿‡ instanceId æŸ¥è¯¢
â”œâ”€ ä» Redis ç¼“å­˜è¯»å–ï¼ˆä¼˜å…ˆï¼‰
â”œâ”€ ç¼“å­˜æœªå‘½ä¸­ â†’ ä»æ•°æ®åº“è¯»å–
â””â”€ å†™å…¥ Redis ç¼“å­˜ï¼ˆTTL: 60ç§’ï¼‰

æ¸…ç†ä¸Šä¸‹æ–‡ï¼š
â”œâ”€ æµç¨‹å®Œæˆåæ¸…ç†
â”œâ”€ ä¿ç•™é‡è¦æ•°æ®åˆ°æ•°æ®åº“
â”œâ”€ åˆ é™¤ Redis ç¼“å­˜
â””â”€ è®°å½•æ¸…ç†æ—¥å¿—
```

---

## å…­ã€æµç¨‹ç‰ˆæœ¬ç®¡ç†

### 6.1 ç‰ˆæœ¬ç®¡ç†ç­–ç•¥

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ç‰ˆæœ¬ç®¡ç†ç­–ç•¥                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç‰ˆæœ¬å·è§„åˆ™ï¼š
â”œâ”€ æ ¼å¼ï¼šv{major}.{minor}.{patch}
â”œâ”€ majorï¼šé‡å¤§å˜æ›´ï¼ˆä¸å…¼å®¹ï¼‰
â”œâ”€ minorï¼šåŠŸèƒ½æ–°å¢ï¼ˆå‘åå…¼å®¹ï¼‰
â””â”€ patchï¼šbug ä¿®å¤ï¼ˆå‘åå…¼å®¹ï¼‰

ç‰ˆæœ¬å†å²ï¼š
â”œâ”€ æ¯æ¬¡ä¿®æ”¹æµç¨‹è‡ªåŠ¨åˆ›å»ºæ–°ç‰ˆæœ¬
â”œâ”€ ä¿ç•™æ‰€æœ‰å†å²ç‰ˆæœ¬
â”œâ”€ æ”¯æŒç‰ˆæœ¬å¯¹æ¯”
â””â”€ æ”¯æŒç‰ˆæœ¬å›æ»š

æ¿€æ´»æµç¨‹ï¼š
â”œâ”€ åŒä¸€æ—¶é—´åªèƒ½æœ‰ä¸€ä¸ªæ¿€æ´»ç‰ˆæœ¬
â”œâ”€ æ¿€æ´»æ–°ç‰ˆæœ¬å‰è‡ªåŠ¨åœç”¨æ—§ç‰ˆæœ¬
â”œâ”€ æ­£åœ¨æ‰§è¡Œçš„æµç¨‹å®ä¾‹ä¸å—å½±å“
â””â”€ æ–°å®ä¾‹ä½¿ç”¨æ–°ç‰ˆæœ¬

å›æ»šæµç¨‹ï¼š
â”œâ”€ å¯ä»¥å›æ»šåˆ°ä»»æ„å†å²ç‰ˆæœ¬
â”œâ”€ å›æ»šåç«‹å³ç”Ÿæ•ˆ
â””â”€ ä¿ç•™å›æ»šæ—¥å¿—
```

### 6.2 ç‰ˆæœ¬å¯¹æ¯”

```typescript
interface FlowVersionDiff {
  versionA: string;
  versionB: string;
  
  changes: {
    added: Node[];      // æ–°å¢çš„èŠ‚ç‚¹
    removed: Node[];    // åˆ é™¤çš„èŠ‚ç‚¹
    modified: NodeDiff[]; // ä¿®æ”¹çš„èŠ‚ç‚¹
  };
  
  connections: {
    added: Connection[];
    removed: Connection[];
    modified: ConnectionDiff[];
  };
}
```

---

## ä¸ƒã€æ€»ç»“

æµç¨‹å¼•æ“æ˜¯ç³»ç»Ÿçš„æ ¸å¿ƒç»„ä»¶ï¼Œè´Ÿè´£å¤„ç†æ‰€æœ‰ä¼ä¸šå¾®ä¿¡ç¾¤æ¶ˆæ¯ã€‚é€šè¿‡ç»Ÿä¸€æ¶ˆæ¯è·¯ç”±æ¶æ„ï¼Œç³»ç»Ÿèƒ½å¤Ÿæ™ºèƒ½åœ°æ ¹æ®å‘é€è€…è§’è‰²å°†æ¶ˆæ¯è·¯ç”±åˆ°ä¸åŒçš„å¤„ç†åˆ†æ”¯ï¼Œå®ç°ç²¾å‡†çš„æ¶ˆæ¯å¤„ç†ã€‚

æ ¸å¿ƒç‰¹æ€§ï¼š
- âœ… ç»Ÿä¸€æ¶ˆæ¯è·¯ç”±æ¶æ„ï¼ˆä¸€ä¸ªä¸»æµç¨‹ + 4ä¸ªåˆ†æ”¯ï¼‰
- âœ… 25ç§èŠ‚ç‚¹ç±»å‹ï¼ˆå®Œæ•´çš„èŠ‚ç‚¹å±æ€§é…ç½®ï¼‰
- âœ… æ™ºèƒ½ä¸Šä¸‹æ–‡ç®¡ç†
- âœ… å®Œå–„çš„é”™è¯¯å¤„ç†æœºåˆ¶
- âœ… çµæ´»çš„æ€§èƒ½ä¼˜åŒ–ç­–ç•¥
- âœ… å®Œæ•´çš„ç‰ˆæœ¬ç®¡ç†æ”¯æŒ

é€šè¿‡æµç¨‹å¼•æ“çš„å‡çº§ï¼Œç³»ç»Ÿå°†å˜å¾—æ›´åŠ æ™ºèƒ½ã€é«˜æ•ˆã€å¯é ã€‚

---

**æ–‡æ¡£ç»“æŸ**
