# 完整流程图（文字版）

> **文档版本**: v1.0
> **创建日期**: 2024-01-01
> **维护者**: WorkTool AI 团队

---

## 📋 目录

- [一、整体架构流程图](#一整体架构流程图)
- [二、运营消息处理流程图](#二运营消息处理流程图)
- [三、工作人员消息处理流程图](#三工作人员消息处理流程图)
- [四、售后协助流程图](#四售后协助流程图)
- [五、用户消息处理流程图](#五用户消息处理流程图)
- [六、会话管理与分析流程图](#六会话管理与分析流程图)
- [七、延迟控制策略表](#七延迟控制策略表)
- [八、告警级别与处理策略表](#八告警级别与处理策略表)
- [九、机器人角色配置表](#九机器人角色配置表)

---

## 一、整体架构流程图

```
════════════════════════════════════════════════════════════════════════════════
                        统一消息处理主流程（Message Routing Flow）
════════════════════════════════════════════════════════════════════════════════

【触发器】企业微信群消息回调
        ↓
【节点 1】消息接收与保存
├─ 验证签名
├─ 幂等性检查
├─ 消息去重
├─ 保存到 messages 表
└─ 推送到监控队列
        ↓
【节点 2】发送者身份识别（条件分支）
├─ 检查是否是运营（财神爷）→ 优先级：最高
├─ 检查是否是工作人员（群助理/售后）
├─ 检查是否是用户（号主）
├─ 检查是否是机器人
└─ 标记角色信息到 context.senderRole
        ↓
【节点 2.5】售后任务关联检查（新增）
├─ 检查用户是否有待处理的售后任务
├─ 检查消息内容是否包含响应关键词
└─ 判断是否需要路由到售后分支
        ↓
        ├─ 【检测到售后响应】→ 【分支 C】的【节点 C3】
        └─ 【未检测到售后响应】→ 【节点 3】角色路由
        ↓
【节点 3】角色路由（条件分支）

根据 context.senderRole 路由到不同分支：

┌──────────────────────────────────────────────────────────────────────┐
│ 【分支 A】运营消息处理（最高优先级）                                   │
│     → 节点 A1：运营消息识别与跟踪                                    │
│     → 节点 A2：号主响应检测                                          │
│     → 节点 A3：无人回应通知处理                                      │
│     → 节点 A4：冲突检测与调和                                        │
└──────────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────────────┐
│ 【分支 B】工作人员消息处理                                             │
│     → 节点 B1：工作人员活跃度记录                                    │
│     → 节点 B2：工作人员介入判断                                      │
│     → 节点 B3：介入通知执行（如需要）                                │
└──────────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────────────┐
│ 【分支 C】售后 @ 消息处理                                             │
│     → 节点 C1：售后消息识别                                          │
│     → 节点 C2：创建售后跟踪任务                                      │
│     → 节点 C3：用户响应检测（含机器人安抚）                          │
│     → 节点 C4：售后无人回应通知                                      │
│     → 节点 C5：任务完成跟踪                                          │
│     → 节点 C6：协同分析与报告                                        │
└──────────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────────────┐
│ 【分支 D】用户消息处理（核心流程）                                     │
│     → 节点 D1：用户消息意图识别                                      │
│     → 节点 D2：告警判断与分类                                        │
│     → 节点 D3：AI 回复决策                                           │
│     → 节点 D4：AI 回复生成                                           │
│     → 节点 D5：回复质量检查                                          │
│     → 节点 D6：延迟控制                                              │
│     → 节点 D7：机器人通讯执行                                        │
│     → 节点 D8：异步结果确认                                          │
└──────────────────────────────────────────────────────────────────────┘

        ↓
【节点 4】会话管理与分析（统一结束节点）
├─ 更新会话状态（sessions 表）
├─ 更新上下文（最近 20 条消息）
├─ 更新用户满意度、情绪、配合度
├─ 推送到监控面板
└─ 流程结束
```

---

## 二、运营消息处理流程图

```
════════════════════════════════════════════════════════════════════════════════
【分支 A】运营消息处理流程（最高优先级）
════════════════════════════════════════════════════════════════════════════════

触发条件：context.senderRole === "operation"

【节点 A1】运营消息识别与跟踪
├─ 标记消息优先级：P0（最高）
├─ 创建跟踪任务（track_tasks 表）
├─ 提取运营要求：
│   ├─ 需要谁配合？
│   ├─ 做什么？
│   └─ 什么时候完成？
├─ 推送到运营监控大屏
└─ 输出：trackTaskId, targetUserId, requirement, deadline
        ↓
【节点 A2】号主响应检测
├─ 监控群内消息，检测号主是否回应
├─ 检测响应关键词：在、好的、收到、马上、立即
│
├─ 【场景 1】号主已回应
│   ├─ 标记任务状态为 "responded"
│   ├─ 更新 track_tasks 表
│   ├─ 推送到监控面板，显示 "号主已响应"
│   ├─ 发送通知给运营："XXX 群 XXX 号主已响应"
│   └─ 结束跟踪
│
└─ 【场景 2】号主未回应
    ├─ 继续监控
    ├─ 等待超时（默认 10 分钟，可配置）
    └─ 超时后触发 → 【节点 A3】
        ↓
【节点 A3】无人回应通知处理
├─ 识别运营要求的具体任务
├─ 查找相关工作人员（群助理/售后）
├─ 生成通知消息：
│   "提醒：运营在 XXX 群要求 XXX 用户配合 XXX，但用户尚未回应"
├─ 选择通知机器人
├─ 发送通知：
│   ├─ 发送给相关工作人员本人
│   ├─ 发送给售后工作群
│   └─ 推送到运营监控大屏，高亮显示
└─ 更新 track_tasks 表，持续跟踪
        ↓
【节点 A4】冲突检测与调和
├─ 检测运营和用户是否发生冲突
├─ 检测指标：
│   ├─ 运营语气不好（情绪分析，情绪分数 < 0.3）
│   ├─ 用户抱怨/投诉（关键词检测）
│   └─ 消息内容包含冲突信号
│
├─ 【场景 1】检测到冲突
│   ├─ 启动调和流程
│   ├─ 生成调和消息：
│   │   "我们马上配合他，去帮助他完成实名或者扫码登录等相关工作"
│   ├─ 调用机器人发送到群内
│   ├─ 同时发送通知给工作人员工作群
│   ├─ 推送到监控面板，标记为 "冲突调和中"
│   ├─ 更新 track_tasks 表，标记冲突
│   └─ 记录到协同分析，进行后续跟进
│
└─ 【场景 2】未检测到冲突
    └─ 直接跳转到【节点 4】会话管理
        ↓
跳转到【节点 4】会话管理与分析
```

---

## 三、工作人员消息处理流程图

```
════════════════════════════════════════════════════════════════════════════════
【分支 B】工作人员消息处理流程
════════════════════════════════════════════════════════════════════════════════

触发条件：
context.senderRole === "group_assistant" || context.senderRole === "after_sales"

【节点 B1】工作人员活跃度记录
├─ 记录工作人员信息：
│   ├─ 工作人员 ID
│   ├─ 工作人员姓名
│   ├─ 角色类型（群助理/售后）
│   └─ 在线状态（online/busy/offline）
├─ 更新 staff 表：
│   ├─ last_active_time：最后活跃时间
│   ├─ status：在线状态
│   ├─ reply_count：回复数 +1
│   └─ online_duration：在线时长
├─ 记录到 operation_logs 表
└─ 更新用户会话状态
        ↓
【节点 B2】工作人员介入判断
├─ 分析上下文：
│   ├─ 工作人员发给谁？
│   ├─ 什么内容？
│   └─ 之前是否有 AI 回复？
│
├─ 判断介入条件（可配置）：
│   ├─ 【条件 1】用户投诉/不满意 → 需要介入（优先级：critical）
│   ├─ 【条件 2】长时间未回复用户（>30 分钟）→ 需要提醒（优先级：warning）
│   ├─ 【条件 3】用户询问重要问题 → 需要关注（优先级：warning）
│   └─ 【条件 4】其他 → 不需要介入（优先级：info）
│
└─ 输出介入判断结果：
    ├─ needIntervention：true/false
    ├─ interventionType：immediate/normal/none
    └─ interventionReason：介入原因
        ↓
        ├─ 【需要介入】→ 【节点 B3】介入通知执行
        └─ 【不需要介入】→ 直接跳转到【节点 4】会话管理

【节点 B3】介入通知执行
├─ 选择通知方式：
│   ├─ 发送给工作人员本人提醒
│   ├─ 发送给售后工作群提醒
│   └─ 推送到售后监控大屏
├─ 生成提醒消息内容：
│   ├─ 用户信息
│   ├─ 问题描述
│   ├─ 介入原因
│   └─ 建议行动
├─ 选择通知机器人
├─ 发送通知
└─ 记录到介入历史
        ↓
跳转到【节点 4】会话管理与分析
```

---

## 四、售后协助流程图

```
════════════════════════════════════════════════════════════════════════════════
【分支 C】售后协助流程
════════════════════════════════════════════════════════════════════════════════

触发条件：context.message.isAtStaff === true（检测到 @ 售后人员）

【节点 C1】售后消息识别
├─ 检测 @ 消息：@ 号主
├─ 提取售后任务信息：
│   ├─ 售后人员 ID
│   ├─ 售后人员姓名
│   ├─ 目标用户 ID（号主）
│   ├─ 目标用户姓名
│   ├─ 任务内容：实名/扫码/认证等
│   └─ 时间要求
├─ 识别任务类型（可配置）：
│   ├─ 实名认证 → priority = high
│   ├─ 扫码认证 → priority = high
│   ├─ 绑定手机 → priority = medium
│   └─ 其他任务 → priority = low
└─ 输出任务信息
        ↓
【节点 C2】创建售后跟踪任务
├─ 创建 track_tasks 表记录：
│   ├─ task_type: "after_sale"
│   ├─ staff_id: 售后人员 ID
│   ├─ user_id: 号主 ID
│   ├─ group_id: 群 ID
│   ├─ task_content: 任务内容
│   ├─ priority: 优先级（high/medium/low）
│   ├─ status: "pending"
│   ├─ created_at: 创建时间
│   └─ deadline: 截止时间（默认 1 小时，可配置）
├─ 推送到售后监控大屏
├─ 发送通知给售后人员（通知机器人）
└─ 输出：taskId, status, deadline
        ↓
【节点 C3】用户响应检测（优化版）
├─ 持续监控群内消息
├─ 检测号主是否回应：
│   └─ 响应关键词：在、好的、收到、马上
│
├─ 【场景 1】号主已回应
│   ├─ 标记任务状态为 "responded"
│   ├─ 更新 track_tasks 表
│   ├─ 【步骤 2】机器人安抚用户（新增）
│   │   ├─ 检测售后人员状态：在线/忙碌/离线
│   │   ├─ 生成安抚消息：
│   │   │   ├─ 在线："@用户1 好的，请稍等，售后人员马上就来处理 👍"
│   │   │   ├─ 忙碌："@用户1 好的，请稍等，售后人员正在处理其他任务，马上就来 ⏳"
│   │   │   └─ 离线："@用户1 好的，请稍等，已通知售后人员，马上会来处理 🔔"
│   │   ├- 发送到群聊
│   │   └- 记录安抚消息
│   ├- 【步骤 3】通知售后人员
│   │   ├- 生成通知消息："【紧急】XXX 群 XXX 用户已响应：[用户消息内容]"
│   │   ├- 发送给售后人员本人
│   │   ├- 发送给售后工作群
│   │   └- 推送到售后监控大屏
│   └- 等待售后人员跟进
│
└─ 【场景 2】号主未回应
    ├─ 继续监控
    ├─ 等待超时（默认 10 分钟，可配置）
    └─ 超时后 → 【节点 C4】
        ↓
【节点 C4】售后无人回应通知
├─ 检测场景：号主出来了，但售后人员没有及时跟进
├─ 识别号主发出的消息："在"、"好的"、"收到"、"马上"
├─ 生成通知消息：
│   "提醒：XXX 群 XXX 号主已响应'在'，请及时安排任务"
├─ 发送通知：
│   ├─ 发送给售后人员本人（通知机器人）
│   ├─ 发送给售后工作群（通知机器人）
│   └─ 推送到售后监控大屏，高亮显示
└─ 更新 track_tasks 表，记录提醒时间
        ↓
【节点 C5】任务完成跟踪
├─ 持续监控群内消息
├─ 检测任务完成信号：
│   ├─ 售后人员发送："已完成"、"搞定"、"完成了"
│   ├─ 号主发送："完成了"、"可以了"、"好的"
│   └─ 检测到任务完成的关键词
│
├─ 【场景 1】任务已完成
│   ├─ 标记任务状态为 "completed"
│   ├─ 更新 track_tasks 表
│   ├─ 推送到监控面板，显示 "任务已完成"
│   ├─ 同步到腾讯文档（如果启用）
│   └─ 生成售后完成记录
│
├─ 【场景 2】任务超时未完成
│   ├─ 标记任务状态为 "timeout"
│   ├─ 更新 track_tasks 表
│   ├─ 发送紧急通知给售后人员
│   ├─ 推送到监控面板，高亮显示
│   └─ 记录到 after_sale_tasks 表
│
└─ 【场景 3】任务进行中
    └─ 继续监控，等待完成
        ↓
【节点 C6】协同分析与报告
├─ 分析售后处理效果：
│   ├─ 响应速度：平均响应时间
│   ├─ 完成率：任务完成率
│   ├─ 超时率：任务超时率
│   ├─ 用户配合度：号主配合度
│   └─ 售后人员表现统计
├─ 生成售后日报：
│   ├─ 今日售后任务数
│   ├─ 完成数、超时数
│   ├─ 售后人员表现排名
│   └─ 用户满意度统计
├─ 推送到协同分析模块
├─ 生成改进建议
└─ 更新用户画像
        ↓
跳转到【节点 4】会话管理与分析
```

---

## 五、用户消息处理流程图

```
════════════════════════════════════════════════════════════════════════════════
【分支 D】用户消息处理流程（核心流程）
════════════════════════════════════════════════════════════════════════════════

触发条件：context.senderRole === "user"

【节点 D1】用户消息意图识别
├─ 调用 AI 识别用户消息意图
├─ 识别意图类型（7 种）：
│   ├─ chat（闲聊）
│   ├─ service（服务咨询）
│   ├─ help（帮助请求）
│   ├─ risk（风险内容）
│   ├─ spam（垃圾信息）
│   ├─ welcome（欢迎语）
│   └─ complaint（投诉/不满意）
├─ 识别情绪：
│   ├─ positive（正面）
│   ├─ negative（负面）
│   └─ neutral（中性）
├─ 加载上下文（最近 10 条消息）
├─ 识别置信度（0-1）
├─ 判断是否需要回复
└─ 输出分析结果
        ↓
【节点 D2】告警判断与分类
├─ 检查是否触发告警（可配置）：
│
│   【告警条件 A】用户投诉/不满意
│   └─ 告警等级：critical
│
│   【告警条件 B】长时间未回复（>30 分钟）
│   └─ 告警等级：warning
│
│   【告警条件 C】用户情绪持续恶化
│   └─ 告警等级：error
│
│   【告警条件 D】涉及运营（财神爷）
│   └─ 告警等级：critical
│
│   【告警条件 E】用户流失风险高
│   └─ 告警等级：error
│
├─ 告警去重检查：
│   ├─ 同一问题只告警 1 次
│   ├─ 单日最多告警 3 次
│   └─ 超过后降级为只记录不通知
│
├─ 告警提升策略：
│   ├─ 同一问题未解决 + 超过 2 小时 → 提升一级
│   ├─ 用户情绪持续恶化 → 提升一级
│   └─ 最高提升到 critical
│
├─ 告警取消规则：
│   └─ 用户情绪好转 + 连续 3 条正面消息 → 自动取消告警
│
└─ 输出告警结果：hasAlert, alertLevel, alertType, alertMessage
        ↓
        ├─ 【有告警】→ 【节点 D2.1】告警处理流程
        └─ 【无告警】→ 【节点 D3】AI 回复决策

【节点 D2.1】告警处理流程
├─ 创建告警记录（alert_history 表）
├─ 记录告警信息
├─ 根据告警等级选择通知方式
├─ 选择通知机器人
├─ 生成告警通知消息
├─ 调用通知机器人发送
├─ 推送到告警面板
└─ 创建告警跟踪任务，持续监控
        ↓
        ├─ 【告警已解决】→ 继续执行【节点 D3】
        └─ 【告警未解决】→ 持续监控，等待解决

【节点 D3】AI 回复决策
├─ 检查是否需要 AI 回复（可配置）：
│
│   【判断 1】是否已有工作人员回复？
│   ├─ 是 → 不需要 AI 回复 → 跳到【节点 D4.3】延迟控制
│   └─ 否 → 继续
│
│   【判断 2】是否是工作时间？（白班/晚班）
│   ├─ 是 → 需要 AI 回复
│   └─ 否 → 检查【判断 3】
│
│   【判断 3】是否是监控机器人的消息？
│   ├─ 是 → 不需要 AI 回复（监控机器人不回复）
│   └─ 否 → 继续
│
│   【判断 4】消息重要性如何？（深夜时段）
│   ├─ 高优先级 → 需要 AI 回复
│   ├─ 中优先级 → 需要 AI 回复
│   └─ 低优先级 → 不需要 AI 回复 → 跳到【节点 D4.3】延迟控制
│
├─ 检查机器人角色：
│   ├─ 白班时间（9:00-21:00）→ 使用白班回复机器人
│   └─ 晚班时间（21:00-9:00）→ 使用晚班回复机器人
│
└─ 输出决策结果：needReply, replyReason, robotType
        ↓
        ├─ 【需要回复】→ 【节点 D4】AI 回复生成
        └─ 【不需要回复】→ 【节点 D4.3】延迟控制

【节点 D4】AI 回复生成
├─ 加载上下文（最近 10-20 条消息）
├─ 加载用户信息（用户画像、历史记录）
├─ 加载群信息（群类型、群规则）
├─ 选择回复 AI 模型（根据消息类型选择）
├─ 构造 Prompt
├─ 调用 AI 生成回复
├─ 回复质量检查
├─ 保存到 ai_usage_logs 表
└─ 输出：replyContent, replyType, confidence, tokensUsed
        ↓
【节点 D5】回复内容处理
├─ 提取回复信息
├─ 生成机器人执行代码
├─ 保存到 robot_commands 表
└─ 输出：commandId, command
        ↓
【节点 D6】延迟控制
├─ 检查当前时间段：
│
│   【白班】9:00-21:00
│   └─ 无延迟（0 秒）
│
│   【晚班】21:00-24:00
│   └─ 延迟 1-5 分钟随机
│
│   【深夜】0:00-6:00
│   ├─ 高优先级 → 延迟 5-10 分钟
│   ├─ 中优先级 → 延迟 10-30 分钟
│   └─ 低优先级 → 不回复，次日再处理
│
├─ 计算延迟时间
├─ 添加到延迟队列（robot_command_queue 表）
└─ 输出：delaySeconds, delayReason, scheduledTime
        ↓
【节点 D7】机器人通讯执行
├─ 从延迟队列取出任务
├─ 调用机器人 API
├─ 等待"收到成功"确认
├─ 创建异步确认任务
├─ 推送到监控面板
└─ 输出：commandId, sendStatus, sendTime
        ↓
【节点 D8】异步结果确认
├─ 1 分钟后查询执行结果
├─ 更新 robot_commands 表
├─ 处理失败/超时情况
├─ 检查重试次数
├─ 如果重试次数 < 3 → 自动重试
└─ 如果重试次数 >= 3 → 转为人工处理
        ↓
跳转到【节点 4】会话管理与分析
```

---

## 六、会话管理与分析流程图

```
════════════════════════════════════════════════════════════════════════════════
【节点 4】会话管理与分析（统一结束节点）
════════════════════════════════════════════════════════════════════════════════

【子节点 4.1】会话状态更新
├─ 更新 sessions 表：
│   ├─ last_message_at：最后消息时间
│   ├─ message_count：消息数 + 1
│   ├─ status：更新状态
│   └─ updated_at：更新时间
├─ 更新 user_sessions 表：
│   ├─ 检测用户满意度（情绪分析）
│   ├─ 记录用户情绪变化
│   └─ 更新配合度评分
└─ 更新 group_sessions 表：
    ├─ 更新群活跃度
    └─ 更新群健康度
        ↓
【子节点 4.2】上下文更新
├─ 更新上下文（context）：
│   ├─ 添加最新消息到上下文
│   ├─ 限制上下文长度（最近 20-50 条消息）
│   └─ 更新对话轮数
├─ 保存到 messages 表的 context 字段
└─ 清理缓存（如果启用）
        ↓
【子节点 4.3】协同分析触发
├─ 推送到协同分析队列
├─ 协同分析模块执行：
│   ├─ 用户行为分析
│   ├─ 工作人员活跃度分析
│   ├─ 群健康度分析
│   ├─ 满意度分析
│   └─ 趋势预测
├─ 生成分析报告
└─ 推送到监控面板
        ↓
【子节点 4.4】监控面板推送
├─ 推送到监控面板的模块：
│   ├─ 业务消息监控列表
│   ├─ AI 交互监控
│   ├─ 售后监控大屏
│   ├─ 告警面板
│   └─ 会话管理列表
├─ 实时更新监控数据
└─ 高亮显示重要事件
        ↓
【子节点 4.5】流程结束
├─ 记录处理完成时间
├─ 更新处理日志（flow_execution_logs 表）
├─ 推送到日志中心
└─ 流程实例状态更新为 "completed"

════════════════════════════════════════════════════════════════════════════════
                            ✅ 流程结束 ✅
════════════════════════════════════════════════════════════════════════════════
```

---

## 七、延迟控制策略表

```
┌────────────┬────────────┬─────────────┬─────────────┬─────────────────┐
│   时段     │  时间范围  │  最小延迟   │  最大延迟   │     适用规则     │
├────────────┼────────────┼─────────────┼─────────────┼─────────────────┤
│  白班      │ 9:00-21:00 │     0 秒    │     0 秒    │   立即回复      │
├────────────┼────────────┼─────────────┼─────────────┼─────────────────┤
│  晚班      │ 21:00-24:00 │   60 秒     │   300 秒    │  随机延迟1-5分钟 │
├────────────┼────────────┼─────────────┼─────────────┼─────────────────┤
│  深夜      │            │             │             │                 │
│  - 高优先级│ 0:00-6:00  │   300 秒    │   600 秒    │  延迟5-10分钟   │
│  - 中优先级│ 0:00-6:00  │   600 秒    │  1800 秒    │  延迟10-30分钟  │
│  - 低优先级│ 0:00-6:00  │    -        │    -        │  不回复，次日处理│
└────────────┴────────────┴─────────────┴─────────────┴─────────────────┘

优先级判断规则：
┌─────────────────────────────────────────────────────────────────────┐
│ 【高优先级】                                                         │
│ - 用户投诉/不满意                                                   │
│ - 涉及运营（财神爷）                                                 │
│ - 实名认证/扫码认证（售后任务）                                      │
│ - 紧急服务咨询                                                      │
└─────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────┐
│ 【中优先级】                                                         │
│ - 普通服务咨询                                                      │
│ - 绑定手机（售后任务）                                              │
│ - 帮助请求                                                          │
│ - 重要问题询问                                                      │
└─────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────┐
│ 【低优先级】                                                         │
│ - 闲聊                                                              │
│ - 垃圾信息                                                          │
│ - 欢迎语                                                            │
│ - 次要问题询问                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 八、告警级别与处理策略表

```
┌────────────┬─────────────────┬──────────────────┬──────────────────────┐
│  告警级别  │    触发条件     │    通知方式      │      处理策略        │
├────────────┼─────────────────┼──────────────────┼──────────────────────┤
│  critical  │ 用户投诉/不满意 │ 立即通知 + 推送到 │ 立即介入，通知管理层  │
│   (最高)   │ 涉及运营（财神）│ 监控屏 + 发送给  │                      │
│            │ 用户情绪恶化     │ 管理层           │                      │
├────────────┼─────────────────┼──────────────────┼──────────────────────┤
│   error    │ 用户情绪持续恶化 │ 推送到监控屏 +   │ 关注处理，通知工作群  │
│   (高)     │ 用户流失风险高   │ 发送给工作群     │                      │
│            │ 长时间未回复     │                  │                      │
├────────────┼─────────────────┼──────────────────┼──────────────────────┤
│  warning   │ 长时间未回复     │ 推送到监控屏     │ 记录跟踪，等待处理    │
│   (中)     │ 用户询问重要问题 │                  │                      │
├────────────┼─────────────────┼──────────────────┼──────────────────────┤
│   info     │ 普通记录         │ 只记录，不通知   │ 仅记录，不主动处理    │
│   (低)     │                  │                  │                      │
└────────────┴─────────────────┴──────────────────┴──────────────────────┘

告警取消条件：
┌─────────────────────────────────────────────────────────────────────┐
│ 【自动取消】                                                         │
│ - 用户情绪好转（positive）                                          │
│ - 连续 3 条正面消息                                                 │
│ - 投诉撤销/问题解决                                                 │
│                                                                     │
│ 【取消后处理】                                                       │
│ - 更新告警状态为 "已解决"                                           │
│ - 保留历史记录（数据留痕）                                           │
│ - 推送到监控面板，显示"告警已取消"                                   │
└─────────────────────────────────────────────────────────────────────┘

告警提升策略：
┌─────────────────────────────────────────────────────────────────────┐
│ 【提升条件】                                                         │
│ - 同一问题未解决 + 超过 2 小时 → 提升一级                           │
│ - 用户情绪持续恶化 → 提升一级                                       │
│ - 最高提升到 critical                                               │
│                                                                     │
│ 【降级条件】                                                         │
│ - 单日告警次数 >= 3 次 → 降级为 info（只记录）                       │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 九、机器人角色配置表

```
┌──────────────┬────────┬──────────────┬──────────────┬────────────────┐
│  机器人类型  │ 数量/群 │    时段     │     职责     │     特点       │
├──────────────┼────────┼──────────────┼──────────────┼────────────────┤
│  监控机器人  │  1 个  │   24 小时   │  监控所有消息 │  独立运行，     │
│              │        │              │  不上报回复   │  确保监控信息   │
│              │        │              │              │  不断           │
├──────────────┼────────┼──────────────┼──────────────┼────────────────┤
│  通知机器人  │  1 个  │   24 小时   │  发送通知、   │  独立，专门     │
│              │        │              │  提醒、告警   │  发送通知       │
├──────────────┼────────┼──────────────┼──────────────┼────────────────┤
│  白班回复机  │  1 个  │  9:00-21:00  │  社群运营、   │  系统的大脑     │
│  器人        │        │              │  疑虑解答     │  + 手脚         │
├──────────────┼────────┼──────────────┼──────────────┼────────────────┤
│  晚班回复机  │  1 个  │ 21:00-9:00   │  同上 + 延迟  │  深夜按重要性   │
│  器人        │        │              │  控制         │  回复           │
└──────────────┴────────┴──────────────┴──────────────┴────────────────┘

核心概念：
┌─────────────────────────────────────────────────────────────────────┐
│ 【系统 = 机器人大脑】                                                │
│ 【机器人 = 系统的手脚】                                              │
│                                                                     │
│ 机器人职责：                                                         │
│  1. 上报消息（接收企业微信群消息）                                   │
│  2. 执行回复动作（发送消息到企业微信群）                             │
│                                                                     │
│ 系统职责：                                                           │
│  1. 接收消息（从机器人上报的消息）                                   │
│  2. 分析决策（AI 意图识别、告警判断）                                │
│  3. 生成回复（AI 生成回复内容）                                     │
│  4. 发送指令（给机器人发送执行指令）                                 │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 总结

以上是完整的流程引擎流程图（文字版），包括：

✅ **整体架构流程图**：统一消息处理主流程（4 个分支）
✅ **运营消息处理流程图**：运营跟踪、响应检测、冲突调和
✅ **工作人员消息处理流程图**：活跃度记录、介入判断
✅ **售后协助流程图**：任务创建、响应检测、完成跟踪
✅ **用户消息处理流程图**：意图识别、告警判断、AI 回复、延迟控制
✅ **会话管理与分析流程图**：统一结束节点
✅ **延迟控制策略表**：白班/晚班/深夜的详细规则
✅ **告警级别与处理策略表**：4 个告警级别的处理方式
✅ **机器人角色配置表**：4 种机器人的职责分工

---

**文档结束**
