# æ•°æ®åº“è®¾è®¡

> **æ–‡æ¡£ç‰ˆæœ¬**: v1.0
> **åˆ›å»ºæ—¥æœŸ**: 2024-01-01
> **ç»´æŠ¤è€…**: WorkTool AI å›¢é˜Ÿ

---

## ðŸ“‹ ç›®å½•

- [ä¸€ã€æ•°æ®åº“æ¦‚è¿°](#ä¸€æ•°æ®åº“æ¦‚è¿°)
- [äºŒã€æ–°å¢žè¡¨è®¾è®¡](#äºŒæ–°å¢žè¡¨è®¾è®¡)
- [ä¸‰ã€ä¿®æ”¹è¡¨è®¾è®¡](#ä¸‰ä¿®æ”¹è¡¨è®¾è®¡)
- [å››ã€ç´¢å¼•è®¾è®¡](#å››ç´¢å¼•è®¾è®¡)
- [äº”ã€æ•°æ®åº“çº¦æŸ](#äº”æ•°æ®åº“çº¦æŸ)

---

## ä¸€ã€æ•°æ®åº“æ¦‚è¿°

### 1.1 æ•°æ®åº“é€‰æ‹©

- **ä¸»æ•°æ®åº“**: PostgreSQL 14+
- **ç¼“å­˜æ•°æ®åº“**: Redis 6+

### 1.2 å‘½åè§„èŒƒ

- è¡¨åï¼šå°å†™ï¼Œä¸‹åˆ’çº¿åˆ†éš”ï¼ˆå¦‚ï¼šflow_definitionsï¼‰
- å­—æ®µåï¼šå°å†™ï¼Œä¸‹åˆ’çº¿åˆ†éš”ï¼ˆå¦‚ï¼šcreated_atï¼‰
- ä¸»é”®ï¼šidï¼ˆVARCHAR(36)ï¼Œä½¿ç”¨UUIDï¼‰
- æ—¶é—´å­—æ®µï¼šxxx_atï¼ˆå¦‚ï¼šcreated_atï¼‰
- å¸ƒå°”å­—æ®µï¼šis_xxxï¼ˆå¦‚ï¼šis_activeï¼‰

---

## äºŒã€æ–°å¢žè¡¨è®¾è®¡

### 2.1 flow_definitionsï¼ˆæµç¨‹å®šä¹‰è¡¨ï¼‰

**ç”¨é€”**: å­˜å‚¨æµç¨‹å¼•æ“Žçš„æµç¨‹å®šä¹‰

```sql
CREATE TABLE flow_definitions (
  id VARCHAR(36) PRIMARY KEY,
  name VARCHAR(255) NOT NULL,
  description TEXT,
  flow_type VARCHAR(50) NOT NULL DEFAULT 'message_routing',
  version VARCHAR(20) NOT NULL,
  status VARCHAR(20) NOT NULL DEFAULT 'draft',
  
  -- æµç¨‹å®šä¹‰
  nodes JSONB NOT NULL,
  connections JSONB NOT NULL,
  
  -- å…ƒæ•°æ®
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),
  created_by VARCHAR(255),
  updated_by VARCHAR(255)
);

COMMENT ON TABLE flow_definitions IS 'æµç¨‹å®šä¹‰è¡¨';
COMMENT ON COLUMN flow_definitions.id IS 'æµç¨‹IDï¼ˆUUIDï¼‰';
COMMENT ON COLUMN flow_definitions.name IS 'æµç¨‹åç§°';
COMMENT ON COLUMN flow_definitions.description IS 'æµç¨‹æè¿°';
COMMENT ON COLUMN flow_definitions.flow_type IS 'æµç¨‹ç±»åž‹';
COMMENT ON COLUMN flow_definitions.version IS 'æµç¨‹ç‰ˆæœ¬å·';
COMMENT ON COLUMN flow_definitions.status IS 'æµç¨‹çŠ¶æ€ï¼šdraft/active/inactive';
COMMENT ON COLUMN flow_definitions.nodes IS 'èŠ‚ç‚¹å®šä¹‰ï¼ˆJSONï¼‰';
COMMENT ON COLUMN flow_definitions.connections IS 'è¿žæŽ¥å…³ç³»ï¼ˆJSONï¼‰';
COMMENT ON COLUMN flow_definitions.created_at IS 'åˆ›å»ºæ—¶é—´';
COMMENT ON COLUMN flow_definitions.updated_at IS 'æ›´æ–°æ—¶é—´';
COMMENT ON COLUMN flow_definitions.created_by IS 'åˆ›å»ºäºº';
COMMENT ON COLUMN flow_definitions.updated_by IS 'æ›´æ–°äºº';
```

**ç´¢å¼•**:
```sql
CREATE INDEX idx_flow_definitions_status ON flow_definitions(status);
CREATE INDEX idx_flow_definitions_type ON flow_definitions(flow_type);
CREATE INDEX idx_flow_definitions_version ON flow_definitions(version);
```

### 2.2 flow_instancesï¼ˆæµç¨‹å®žä¾‹è¡¨ï¼‰

**ç”¨é€”**: å­˜å‚¨æµç¨‹å¼•æ“Žçš„æ‰§è¡Œå®žä¾‹

```sql
CREATE TABLE flow_instances (
  id VARCHAR(36) PRIMARY KEY,
  flow_definition_id VARCHAR(36) NOT NULL,
  status VARCHAR(20) NOT NULL DEFAULT 'running',
  
  -- è§¦å‘æ•°æ®
  trigger_data JSONB,
  
  -- æ‰§è¡Œä¸Šä¸‹æ–‡
  context JSONB,
  
  -- å½“å‰æ‰§è¡ŒèŠ‚ç‚¹
  current_node_id VARCHAR(36),
  
  -- æ—¶é—´ä¿¡æ¯
  started_at TIMESTAMP DEFAULT NOW(),
  completed_at TIMESTAMP,
  
  -- é”™è¯¯ä¿¡æ¯
  error_message TEXT,
  
  -- æ‰§è¡Œç»Ÿè®¡
  total_execution_time INTEGER DEFAULT 0,
  node_execution_count INTEGER DEFAULT 0,
  success_node_count INTEGER DEFAULT 0,
  failed_node_count INTEGER DEFAULT 0
);

COMMENT ON TABLE flow_instances IS 'æµç¨‹å®žä¾‹è¡¨';
COMMENT ON COLUMN flow_instances.id IS 'å®žä¾‹IDï¼ˆUUIDï¼‰';
COMMENT ON COLUMN flow_instances.flow_definition_id IS 'æµç¨‹å®šä¹‰ID';
COMMENT ON COLUMN flow_instances.status IS 'å®žä¾‹çŠ¶æ€ï¼šrunning/completed/failed/cancelled';
COMMENT ON COLUMN flow_instances.trigger_data IS 'è§¦å‘æ•°æ®ï¼ˆJSONï¼‰';
COMMENT ON COLUMN flow_instances.context IS 'æ‰§è¡Œä¸Šä¸‹æ–‡ï¼ˆJSONï¼‰';
COMMENT ON COLUMN flow_instances.current_node_id IS 'å½“å‰æ‰§è¡ŒèŠ‚ç‚¹ID';
COMMENT ON COLUMN flow_instances.started_at IS 'å¼€å§‹æ—¶é—´';
COMMENT ON COLUMN flow_instances.completed_at IS 'å®Œæˆæ—¶é—´';
COMMENT ON COLUMN flow_instances.error_message IS 'é”™è¯¯ä¿¡æ¯';
COMMENT ON COLUMN flow_instances.total_execution_time IS 'æ€»æ‰§è¡Œæ—¶é—´ï¼ˆæ¯«ç§’ï¼‰';
COMMENT ON COLUMN flow_instances.node_execution_count IS 'èŠ‚ç‚¹æ‰§è¡Œæ€»æ•°';
COMMENT ON COLUMN flow_instances.success_node_count IS 'æˆåŠŸèŠ‚ç‚¹æ•°';
COMMENT ON COLUMN flow_instances.failed_node_count IS 'å¤±è´¥èŠ‚ç‚¹æ•°';
```

**ç´¢å¼•**:
```sql
CREATE INDEX idx_flow_instances_flow_id ON flow_instances(flow_definition_id);
CREATE INDEX idx_flow_instances_status ON flow_instances(status);
CREATE INDEX idx_flow_instances_started_at ON flow_instances(started_at);
CREATE INDEX idx_flow_instances_current_node ON flow_instances(current_node_id);
```

### 2.3 flow_execution_logsï¼ˆæµç¨‹æ‰§è¡Œæ—¥å¿—è¡¨ï¼‰

**ç”¨é€”**: è®°å½•æµç¨‹å¼•æ“Žçš„æ‰§è¡Œæ—¥å¿—

```sql
CREATE TABLE flow_execution_logs (
  id VARCHAR(36) PRIMARY KEY,
  flow_instance_id VARCHAR(36) NOT NULL,
  
  -- èŠ‚ç‚¹ä¿¡æ¯
  node_id VARCHAR(36),
  node_type VARCHAR(100),
  node_name VARCHAR(255),
  
  -- æ‰§è¡ŒçŠ¶æ€
  status VARCHAR(20) NOT NULL,
  
  -- è¾“å…¥è¾“å‡º
  input_data JSONB,
  output_data JSONB,
  
  -- æ‰§è¡Œæ—¶é—´
  execution_time INTEGER,
  started_at TIMESTAMP DEFAULT NOW(),
  completed_at TIMESTAMP,
  
  -- é”™è¯¯ä¿¡æ¯
  error_message TEXT,
  error_stack TEXT
);

COMMENT ON TABLE flow_execution_logs IS 'æµç¨‹æ‰§è¡Œæ—¥å¿—è¡¨';
COMMENT ON COLUMN flow_execution_logs.id IS 'æ—¥å¿—IDï¼ˆUUIDï¼‰';
COMMENT ON COLUMN flow_execution_logs.flow_instance_id IS 'æµç¨‹å®žä¾‹ID';
COMMENT ON COLUMN flow_execution_logs.node_id IS 'èŠ‚ç‚¹ID';
COMMENT ON COLUMN flow_execution_logs.node_type IS 'èŠ‚ç‚¹ç±»åž‹';
COMMENT ON COLUMN flow_execution_logs.node_name IS 'èŠ‚ç‚¹åç§°';
COMMENT ON COLUMN flow_execution_logs.status IS 'æ‰§è¡ŒçŠ¶æ€ï¼šrunning/completed/failed';
COMMENT ON COLUMN flow_execution_logs.input_data IS 'è¾“å…¥æ•°æ®ï¼ˆJSONï¼‰';
COMMENT ON COLUMN flow_execution_logs.output_data IS 'è¾“å‡ºæ•°æ®ï¼ˆJSONï¼‰';
COMMENT ON COLUMN flow_execution_logs.execution_time IS 'æ‰§è¡Œæ—¶é—´ï¼ˆæ¯«ç§’ï¼‰';
COMMENT ON COLUMN flow_execution_logs.started_at IS 'å¼€å§‹æ—¶é—´';
COMMENT ON COLUMN flow_execution_logs.completed_at IS 'å®Œæˆæ—¶é—´';
COMMENT ON COLUMN flow_execution_logs.error_message IS 'é”™è¯¯ä¿¡æ¯';
COMMENT ON COLUMN flow_execution_logs.error_stack IS 'é”™è¯¯å †æ ˆ';
```

**ç´¢å¼•**:
```sql
CREATE INDEX idx_flow_execution_logs_instance_id ON flow_execution_logs(flow_instance_id);
CREATE INDEX idx_flow_execution_logs_node_id ON flow_execution_logs(node_id);
CREATE INDEX idx_flow_execution_logs_status ON flow_execution_logs(status);
CREATE INDEX idx_flow_execution_logs_started_at ON flow_execution_logs(started_at);
```

### 2.4 track_tasksï¼ˆè·Ÿè¸ªä»»åŠ¡è¡¨ï¼‰

**ç”¨é€”**: å­˜å‚¨è¿è¥æ¶ˆæ¯è·Ÿè¸ªã€å”®åŽä»»åŠ¡è·Ÿè¸ªç­‰ä»»åŠ¡

```sql
CREATE TABLE track_tasks (
  id VARCHAR(36) PRIMARY KEY,
  
  -- ä»»åŠ¡ç±»åž‹
  task_type VARCHAR(50) NOT NULL,
  
  -- ç¾¤ä¿¡æ¯
  group_id VARCHAR(255),
  group_name VARCHAR(255),
  
  -- è¿è¥ä¿¡æ¯
  operation_id VARCHAR(255),
  operation_name VARCHAR(255),
  
  -- å·¥ä½œäººå‘˜ä¿¡æ¯
  staff_id VARCHAR(255),
  staff_name VARCHAR(255),
  
  -- ç›®æ ‡ç”¨æˆ·
  target_user_id VARCHAR(255),
  target_user_name VARCHAR(255),
  
  -- ä»»åŠ¡å†…å®¹
  requirement TEXT,
  
  -- ä¼˜å…ˆçº§å’ŒçŠ¶æ€
  priority VARCHAR(20) NOT NULL DEFAULT 'medium',
  status VARCHAR(20) NOT NULL DEFAULT 'pending',
  
  -- æ—¶é—´ä¿¡æ¯
  deadline TIMESTAMP,
  response_detected_at TIMESTAMP,
  completed_at TIMESTAMP,
  
  -- å†²çªå¤„ç†
  conflict_detected BOOLEAN DEFAULT false,
  conflict_resolved BOOLEAN DEFAULT false,
  
  -- åˆ›å»ºå’Œæ›´æ–°æ—¶é—´
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),
  
  -- æ‰©å±•æ•°æ®
  metadata JSONB DEFAULT '{}'
);

COMMENT ON TABLE track_tasks IS 'è·Ÿè¸ªä»»åŠ¡è¡¨';
COMMENT ON COLUMN track_tasks.id IS 'ä»»åŠ¡IDï¼ˆUUIDï¼‰';
COMMENT ON COLUMN track_tasks.task_type IS 'ä»»åŠ¡ç±»åž‹ï¼šoperation/after_sales/alert';
COMMENT ON COLUMN track_tasks.group_id IS 'ç¾¤ID';
COMMENT ON COLUMN track_tasks.group_name IS 'ç¾¤å';
COMMENT ON COLUMN track_tasks.operation_id IS 'è¿è¥ID';
COMMENT ON COLUMN track_tasks.operation_name IS 'è¿è¥åç§°';
COMMENT ON COLUMN track_tasks.staff_id IS 'å·¥ä½œäººå‘˜ID';
COMMENT ON COLUMN track_tasks.staff_name IS 'å·¥ä½œäººå‘˜åç§°';
COMMENT ON COLUMN track_tasks.target_user_id IS 'ç›®æ ‡ç”¨æˆ·ID';
COMMENT ON COLUMN track_tasks.target_user_name IS 'ç›®æ ‡ç”¨æˆ·åç§°';
COMMENT ON COLUMN track_tasks.requirement IS 'ä»»åŠ¡è¦æ±‚';
COMMENT ON COLUMN track_tasks.priority IS 'ä¼˜å…ˆçº§ï¼šcritical/high/medium/low';
COMMENT ON COLUMN track_tasks.status IS 'çŠ¶æ€ï¼špending/responded/in_progress/completed/timeout';
COMMENT ON COLUMN track_tasks.deadline IS 'æˆªæ­¢æ—¶é—´';
COMMENT ON COLUMN track_tasks.response_detected_at IS 'å“åº”æ£€æµ‹æ—¶é—´';
COMMENT ON COLUMN track_tasks.completed_at IS 'å®Œæˆæ—¶é—´';
COMMENT ON COLUMN track_tasks.conflict_detected IS 'æ˜¯å¦æ£€æµ‹åˆ°å†²çª';
COMMENT ON COLUMN track_tasks.conflict_resolved IS 'å†²çªæ˜¯å¦å·²è§£å†³';
COMMENT ON COLUMN track_tasks.created_at IS 'åˆ›å»ºæ—¶é—´';
COMMENT ON COLUMN track_tasks.updated_at IS 'æ›´æ–°æ—¶é—´';
COMMENT ON COLUMN track_tasks.metadata IS 'æ‰©å±•æ•°æ®ï¼ˆJSONï¼‰';
```

**ç´¢å¼•**:
```sql
CREATE INDEX idx_track_tasks_type ON track_tasks(task_type);
CREATE INDEX idx_track_tasks_status ON track_tasks(status);
CREATE INDEX idx_track_tasks_priority ON track_tasks(priority);
CREATE INDEX idx_track_tasks_target_user ON track_tasks(target_user_id);
CREATE INDEX idx_track_tasks_group_id ON track_tasks(group_id);
CREATE INDEX idx_track_tasks_staff_id ON track_tasks(staff_id);
CREATE INDEX idx_track_tasks_created_at ON track_tasks(created_at);
CREATE INDEX idx_track_tasks_deadline ON track_tasks(deadline);
```

### 2.5 robot_command_queueï¼ˆæŒ‡ä»¤é˜Ÿåˆ—è¡¨ï¼‰

**ç”¨é€”**: å­˜å‚¨æœºå™¨äººæŒ‡ä»¤é˜Ÿåˆ—ï¼Œæ”¯æŒå»¶è¿Ÿå‘é€å’Œé‡è¯•

```sql
CREATE TABLE robot_command_queue (
  id VARCHAR(36) PRIMARY KEY,
  
  -- æœºå™¨äººä¿¡æ¯
  robot_id VARCHAR(100) NOT NULL,
  robot_type VARCHAR(50) NOT NULL,
  
  -- æŒ‡ä»¤å†…å®¹
  command JSONB NOT NULL,
  
  -- æŒ‡ä»¤çŠ¶æ€
  status VARCHAR(20) NOT NULL DEFAULT 'pending',
  
  -- ä¼˜å…ˆçº§
  priority INTEGER NOT NULL DEFAULT 5,
  
  -- å»¶è¿ŸæŽ§åˆ¶
  delay_seconds INTEGER DEFAULT 0,
  scheduled_at TIMESTAMP,
  
  -- å‘é€ä¿¡æ¯
  sent_at TIMESTAMP,
  
  -- ç»“æžœç¡®è®¤
  result_checked_at TIMESTAMP,
  result JSONB,
  
  -- é‡è¯•ä¿¡æ¯
  retry_count INTEGER DEFAULT 0,
  max_retries INTEGER DEFAULT 3,
  
  -- æ—¶é—´ä¿¡æ¯
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),
  
  -- æ‰©å±•æ•°æ®
  metadata JSONB DEFAULT '{}'
);

COMMENT ON TABLE robot_command_queue IS 'æœºå™¨äººæŒ‡ä»¤é˜Ÿåˆ—è¡¨';
COMMENT ON COLUMN robot_command_queue.id IS 'æŒ‡ä»¤IDï¼ˆUUIDï¼‰';
COMMENT ON COLUMN robot_command_queue.robot_id IS 'æœºå™¨äººID';
COMMENT ON COLUMN robot_command_queue.robot_type IS 'æœºå™¨äººç±»åž‹ï¼šmonitor/notification/reply';
COMMENT ON COLUMN robot_command_queue.command IS 'æŒ‡ä»¤å†…å®¹ï¼ˆJSONï¼‰';
COMMENT ON COLUMN robot_command_queue.status IS 'çŠ¶æ€ï¼špending/sent/success/failed/timeout';
COMMENT ON COLUMN robot_command_queue.priority IS 'ä¼˜å…ˆçº§ï¼ˆ1-10ï¼‰';
COMMENT ON COLUMN robot_command_queue.delay_seconds IS 'å»¶è¿Ÿç§’æ•°';
COMMENT ON COLUMN robot_command_queue.scheduled_at IS 'è®¡åˆ’æ‰§è¡Œæ—¶é—´';
COMMENT ON COLUMN robot_command_queue.sent_at IS 'å‘é€æ—¶é—´';
COMMENT ON COLUMN robot_command_queue.result_checked_at IS 'ç»“æžœæ£€æŸ¥æ—¶é—´';
COMMENT ON COLUMN robot_command_queue.result IS 'æ‰§è¡Œç»“æžœï¼ˆJSONï¼‰';
COMMENT ON COLUMN robot_command_queue.retry_count IS 'é‡è¯•æ¬¡æ•°';
COMMENT ON COLUMN robot_command_queue.max_retries IS 'æœ€å¤§é‡è¯•æ¬¡æ•°';
COMMENT ON COLUMN robot_command_queue.created_at IS 'åˆ›å»ºæ—¶é—´';
COMMENT ON COLUMN robot_command_queue.updated_at IS 'æ›´æ–°æ—¶é—´';
COMMENT ON COLUMN robot_command_queue.metadata IS 'æ‰©å±•æ•°æ®ï¼ˆJSONï¼‰';
```

**ç´¢å¼•**:
```sql
CREATE INDEX idx_robot_command_queue_robot_id ON robot_command_queue(robot_id);
CREATE INDEX idx_robot_command_queue_status ON robot_command_queue(status);
CREATE INDEX idx_robot_command_queue_priority ON robot_command_queue(priority);
CREATE INDEX idx_robot_command_queue_scheduled_at ON robot_command_queue(scheduled_at);
CREATE INDEX idx_robot_command_queue_created_at ON robot_command_queue(created_at);
CREATE INDEX idx_robot_command_queue_robot_type ON robot_command_queue(robot_type);
```

---

## ä¸‰ã€ä¿®æ”¹è¡¨è®¾è®¡

### 3.1 messagesè¡¨ä¿®æ”¹

**ç”¨é€”**: å­˜å‚¨æ‰€æœ‰æ¶ˆæ¯çš„åŽŸå§‹æ•°æ®

**æ·»åŠ å­—æ®µ**:

```sql
-- å‘é€è€…è§’è‰²
ALTER TABLE messages ADD COLUMN IF NOT EXISTS sender_role VARCHAR(50);
COMMENT ON COLUMN messages.sender_role IS 'å‘é€è€…è§’è‰²ï¼šoperation/group_assistant/after_sales/user/robot';

-- ä¼˜å…ˆçº§
ALTER TABLE messages ADD COLUMN IF NOT EXISTS priority VARCHAR(20);
COMMENT ON COLUMN messages.priority IS 'ä¼˜å…ˆçº§ï¼šcritical/high/medium/low';

-- å‘Šè­¦çº§åˆ«
ALTER TABLE messages ADD COLUMN IF NOT EXISTS alert_level VARCHAR(20);
COMMENT ON COLUMN messages.alert_level IS 'å‘Šè­¦çº§åˆ«ï¼šcritical/error/warning/info';

-- å‘Šè­¦ID
ALTER TABLE messages ADD COLUMN IF NOT EXISTS alert_id VARCHAR(36);
COMMENT ON COLUMN messages.alert_id IS 'å…³è”å‘Šè­¦ID';

-- è·Ÿè¸ªä»»åŠ¡ID
ALTER TABLE messages ADD COLUMN IF NOT EXISTS track_task_id VARCHAR(36);
COMMENT ON COLUMN messages.track_task_id IS 'å…³è”è·Ÿè¸ªä»»åŠ¡ID';

-- æœºå™¨äººå®‰æŠšæ ‡è®°
ALTER TABLE messages ADD COLUMN IF NOT EXISTS is_bot_comfort BOOLEAN DEFAULT false;
COMMENT ON COLUMN messages.is_bot_comfort IS 'æ˜¯å¦ä¸ºæœºå™¨äººå®‰æŠšæ¶ˆæ¯';

-- å†²çªæ ‡è®°
ALTER TABLE messages ADD COLUMN IF NOT EXISTS is_conflict_message BOOLEAN DEFAULT false;
COMMENT ON COLUMN messages.is_conflict_message IS 'æ˜¯å¦ä¸ºå†²çªæ¶ˆæ¯';
```

**ç´¢å¼•**:
```sql
CREATE INDEX IF NOT EXISTS idx_messages_sender_role ON messages(sender_role);
CREATE INDEX IF NOT EXISTS idx_messages_priority ON messages(priority);
CREATE INDEX IF NOT EXISTS idx_messages_alert_level ON messages(alert_level);
CREATE INDEX IF NOT EXISTS idx_messages_alert_id ON messages(alert_id);
CREATE INDEX IF NOT EXISTS idx_messages_track_task_id ON messages(track_task_id);
```

### 3.2 session_messagesè¡¨ä¿®æ”¹

**ç”¨é€”**: å­˜å‚¨ä¼šè¯æ¶ˆæ¯

**æ·»åŠ å­—æ®µ**:

```sql
-- æƒ…ç»ª
ALTER TABLE session_messages ADD COLUMN IF NOT EXISTS emotion VARCHAR(50);
COMMENT ON COLUMN session_messages.emotion IS 'æƒ…ç»ªï¼špositive/negative/neutral';

-- æƒ…ç»ªåˆ†æ•°
ALTER TABLE session_messages ADD COLUMN IF NOT EXISTS emotion_score NUMERIC;
COMMENT ON COLUMN session_messages.emotion_score IS 'æƒ…ç»ªåˆ†æ•°ï¼ˆ0-1ï¼‰';

-- é…åˆåº¦
ALTER TABLE session_messages ADD COLUMN IF NOT EXISTS cooperation_level INTEGER;
COMMENT ON COLUMN session_messages.cooperation_level IS 'é…åˆåº¦ï¼ˆ1-10ï¼‰';

-- æ»¡æ„åº¦
ALTER TABLE session_messages ADD COLUMN IF NOT EXISTS satisfaction_score INTEGER;
COMMENT ON COLUMN session_messages.satisfaction_score IS 'æ»¡æ„åº¦ï¼ˆ1-5ï¼‰';

-- å‘Šè­¦æ ‡è®°
ALTER TABLE session_messages ADD COLUMN IF NOT EXISTS has_alert BOOLEAN DEFAULT false;
COMMENT ON COLUMN session_messages.has_alert IS 'æ˜¯å¦è§¦å‘å‘Šè­¦';

-- æœºå™¨äººå®‰æŠšæ ‡è®°
ALTER TABLE session_messages ADD COLUMN IF NOT EXISTS is_bot_comfort BOOLEAN DEFAULT false;
COMMENT ON COLUMN session_messages.is_bot_comfort IS 'æ˜¯å¦ä¸ºæœºå™¨äººå®‰æŠšæ¶ˆæ¯';
```

**ç´¢å¼•**:
```sql
CREATE INDEX IF NOT EXISTS idx_session_messages_emotion ON session_messages(emotion);
CREATE INDEX IF NOT EXISTS idx_session_messages_has_alert ON session_messages(has_alert);
CREATE INDEX IF NOT EXISTS idx_session_messages_is_bot_comfort ON session_messages(is_bot_comfort);
```

---

## å››ã€ç´¢å¼•è®¾è®¡

### 4.1 ç´¢å¼•ç­–ç•¥

**åŸºæœ¬åŽŸåˆ™**:
- æ‰€æœ‰ä¸»é”®è‡ªåŠ¨åˆ›å»ºç´¢å¼•
- æ‰€æœ‰å¤–é”®åˆ›å»ºç´¢å¼•
- æ‰€æœ‰æŸ¥è¯¢æ¡ä»¶å­—æ®µåˆ›å»ºç´¢å¼•
- æ‰€æœ‰æŽ’åºå­—æ®µåˆ›å»ºç´¢å¼•
- é¿å…è¿‡å¤šç´¢å¼•å½±å“å†™å…¥æ€§èƒ½

### 4.2 å¤åˆç´¢å¼•

```sql
-- flow_instancesï¼šæŸ¥è¯¢æ´»è·ƒå®žä¾‹
CREATE INDEX idx_flow_instances_active ON flow_instances(status, started_at DESC)
WHERE status IN ('running', 'pending');

-- track_tasksï¼šæŸ¥è¯¢å¾…å¤„ç†ä»»åŠ¡
CREATE INDEX idx_track_tasks_pending ON track_tasks(status, priority, created_at DESC)
WHERE status IN ('pending', 'responded');

-- robot_command_queueï¼šæŸ¥è¯¢å¾…å‘é€æŒ‡ä»¤
CREATE INDEX idx_robot_command_queue_ready ON robot_command_queue(status, priority, scheduled_at)
WHERE status IN ('pending', 'sent');

-- messagesï¼šæŸ¥è¯¢å‘Šè­¦æ¶ˆæ¯
CREATE INDEX idx_messages_alerts ON messages(alert_level, created_at DESC)
WHERE alert_level IS NOT NULL;
```

### 4.3 éƒ¨åˆ†ç´¢å¼•ï¼ˆPartial Indexï¼‰

```sql
-- åªç´¢å¼•å¾…å¤„ç†çš„ä»»åŠ¡
CREATE INDEX idx_track_tasks_pending_only ON track_tasks(target_user_id, group_id)
WHERE status IN ('pending', 'responded');

-- åªç´¢å¼•æœªå®Œæˆçš„æŒ‡ä»¤
CREATE INDEX idx_robot_command_queue_pending_only ON robot_command_queue(robot_id, scheduled_at)
WHERE status = 'pending';
```

---

## äº”ã€æ•°æ®åº“çº¦æŸ

### 5.1 å¤–é”®çº¦æŸ

```sql
-- flow_instances â†’ flow_definitions
ALTER TABLE flow_instances 
ADD CONSTRAINT fk_instances_definition 
FOREIGN KEY (flow_definition_id) 
REFERENCES flow_definitions(id) 
ON DELETE CASCADE;

-- flow_execution_logs â†’ flow_instances
ALTER TABLE flow_execution_logs 
ADD CONSTRAINT fk_logs_instance 
FOREIGN KEY (flow_instance_id) 
REFERENCES flow_instances(id) 
ON DELETE CASCADE;
```

### 5.2 æ£€æŸ¥çº¦æŸ

```sql
-- flow_definitions.status æ£€æŸ¥çº¦æŸ
ALTER TABLE flow_definitions 
ADD CONSTRAINT chk_definitions_status 
CHECK (status IN ('draft', 'active', 'inactive'));

-- flow_instances.status æ£€æŸ¥çº¦æŸ
ALTER TABLE flow_instances 
ADD CONSTRAINT chk_instances_status 
CHECK (status IN ('running', 'completed', 'failed', 'cancelled'));

-- track_tasks.priority æ£€æŸ¥çº¦æŸ
ALTER TABLE track_tasks 
ADD CONSTRAINT chk_tasks_priority 
CHECK (priority IN ('critical', 'high', 'medium', 'low'));

-- track_tasks.status æ£€æŸ¥çº¦æŸ
ALTER TABLE track_tasks 
ADD CONSTRAINT chk_tasks_status 
CHECK (status IN ('pending', 'responded', 'in_progress', 'completed', 'timeout'));

-- robot_command_queue.status æ£€æŸ¥çº¦æŸ
ALTER TABLE robot_command_queue 
ADD CONSTRAINT chk_queue_status 
CHECK (status IN ('pending', 'sent', 'success', 'failed', 'timeout'));

-- robot_command_queue.priority èŒƒå›´çº¦æŸ
ALTER TABLE robot_command_queue 
ADD CONSTRAINT chk_queue_priority 
CHECK (priority >= 1 AND priority <= 10);

-- robot_command_queue.retry_count èŒƒå›´çº¦æŸ
ALTER TABLE robot_command_queue 
ADD CONSTRAINT chk_queue_retry_count 
CHECK (retry_count >= 0 AND retry_count <= max_retries);
```

### 5.3 é»˜è®¤å€¼çº¦æŸ

```sql
-- flow_definitions é»˜è®¤å€¼
ALTER TABLE flow_definitions 
ALTER COLUMN flow_type SET DEFAULT 'message_routing';

ALTER TABLE flow_definitions 
ALTER COLUMN version SET DEFAULT '1.0';

ALTER TABLE flow_definitions 
ALTER COLUMN status SET DEFAULT 'draft';

-- track_tasks é»˜è®¤å€¼
ALTER TABLE track_tasks 
ALTER COLUMN priority SET DEFAULT 'medium';

ALTER TABLE track_tasks 
ALTER COLUMN status SET DEFAULT 'pending';

ALTER TABLE track_tasks 
ALTER COLUMN conflict_detected SET DEFAULT false;

ALTER TABLE track_tasks 
ALTER COLUMN conflict_resolved SET DEFAULT false;

-- robot_command_queue é»˜è®¤å€¼
ALTER TABLE robot_command_queue 
ALTER COLUMN status SET DEFAULT 'pending';

ALTER TABLE robot_command_queue 
ALTER COLUMN priority SET DEFAULT 5;

ALTER TABLE robot_command_queue 
ALTER COLUMN delay_seconds SET DEFAULT 0;

ALTER TABLE robot_command_queue 
ALTER COLUMN retry_count SET DEFAULT 0;

ALTER TABLE robot_command_queue 
ALTER COLUMN max_retries SET DEFAULT 3;
```

---

## å…­ã€æ•°æ®è¿ç§»è„šæœ¬

### 6.1 åˆ›å»ºè¡¨

```sql
-- åˆ›å»ºæµç¨‹å¼•æ“Žç›¸å…³è¡¨
CREATE TABLE flow_definitions (...);
CREATE TABLE flow_instances (...);
CREATE TABLE flow_execution_logs (...);
CREATE TABLE track_tasks (...);
CREATE TABLE robot_command_queue (...);

-- ä¿®æ”¹çŽ°æœ‰è¡¨
ALTER TABLE messages ADD COLUMN sender_role VARCHAR(50);
ALTER TABLE messages ADD COLUMN priority VARCHAR(20);
ALTER TABLE messages ADD COLUMN alert_level VARCHAR(20);
ALTER TABLE messages ADD COLUMN alert_id VARCHAR(36);
ALTER TABLE messages ADD COLUMN track_task_id VARCHAR(36);
ALTER TABLE messages ADD COLUMN is_bot_comfort BOOLEAN DEFAULT false;
ALTER TABLE messages ADD COLUMN is_conflict_message BOOLEAN DEFAULT false;

ALTER TABLE session_messages ADD COLUMN emotion VARCHAR(50);
ALTER TABLE session_messages ADD COLUMN emotion_score NUMERIC;
ALTER TABLE session_messages ADD COLUMN cooperation_level INTEGER;
ALTER TABLE session_messages ADD COLUMN satisfaction_score INTEGER;
ALTER TABLE session_messages ADD COLUMN has_alert BOOLEAN DEFAULT false;
ALTER TABLE session_messages ADD COLUMN is_bot_comfort BOOLEAN DEFAULT false;
```

### 6.2 åˆå§‹åŒ–æ•°æ®

```sql
-- åˆ›å»ºé»˜è®¤æµç¨‹å®šä¹‰
INSERT INTO flow_definitions (
  id, name, description, flow_type, version, status,
  nodes, connections, created_by, updated_by
) VALUES (
  'default_message_routing',
  'ç»Ÿä¸€æ¶ˆæ¯å¤„ç†æµç¨‹',
  'æ ¹æ®å‘é€è€…è§’è‰²è·¯ç”±åˆ°ä¸åŒå¤„ç†åˆ†æ”¯',
  'message_routing',
  '2.0',
  'active',
  '{}',
  '{}',
  'system',
  'system'
);
```

---

## ä¸ƒã€æ€»ç»“

æ•°æ®åº“è®¾è®¡æ˜¯ç³»ç»Ÿå‡çº§çš„åŸºç¡€ï¼Œé€šè¿‡æ–°å¢ž5ä¸ªè¡¨å’Œä¿®æ”¹2ä¸ªè¡¨ï¼Œå®žçŽ°äº†æµç¨‹å¼•æ“Žã€ä»»åŠ¡è·Ÿè¸ªã€æŒ‡ä»¤é˜Ÿåˆ—ç­‰æ ¸å¿ƒåŠŸèƒ½ã€‚

æ ¸å¿ƒç‰¹æ€§ï¼š
- âœ… 5ä¸ªæ–°å¢žè¡¨ï¼ˆæµç¨‹å®šä¹‰ã€æµç¨‹å®žä¾‹ã€æ‰§è¡Œæ—¥å¿—ã€è·Ÿè¸ªä»»åŠ¡ã€æŒ‡ä»¤é˜Ÿåˆ—ï¼‰
- âœ… 2ä¸ªä¿®æ”¹è¡¨ï¼ˆmessagesã€session_messagesï¼‰
- âœ… å®Œæ•´çš„ç´¢å¼•è®¾è®¡
- âœ… ä¸¥æ ¼çš„çº¦æŸæ¡ä»¶
- âœ… æ¸…æ™°çš„å­—æ®µæ³¨é‡Š
- âœ… æ”¯æŒJSONBå­˜å‚¨å¤æ‚æ•°æ®

é€šè¿‡è¿™äº›æ•°æ®åº“è®¾è®¡ï¼Œç³»ç»Ÿèƒ½å¤Ÿé«˜æ•ˆåœ°å­˜å‚¨å’ŒæŸ¥è¯¢æ‰€æœ‰ä¸šåŠ¡æ•°æ®ã€‚

---

**æ–‡æ¡£ç»“æŸ**
