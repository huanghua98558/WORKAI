# æ¶ˆæ¯ä¸­å¿ƒä¸ä¸Šä¸‹æ–‡ç®¡ç†å®Œæ•´æŒ‡å—

> **æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
> **æ›´æ–°æ—¶é—´**: 2026-02-10  
> **ç»´æŠ¤è€…**: WorkTool AI å›¢é˜Ÿ

---

## ğŸ“‹ ç›®å½•

- [ä¸€ã€æ¶æ„æ¦‚è¿°](#ä¸€æ¶æ„æ¦‚è¿°)
- [äºŒã€æ ¸å¿ƒæœåŠ¡](#äºŒæ ¸å¿ƒæœåŠ¡)
- [ä¸‰ã€æ•°æ®æ¨¡å‹](#ä¸‰æ•°æ®æ¨¡å‹)
- [å››ã€æ¶ˆæ¯æµç¨‹](#å››æ¶ˆæ¯æµç¨‹)
- [äº”ã€ä¸Šä¸‹æ–‡ç®¡ç†](#äº”ä¸Šä¸‹æ–‡ç®¡ç†)
- [å…­ã€API æ¥å£](#å…­api-æ¥å£)
- [ä¸ƒã€ä½¿ç”¨ç¤ºä¾‹](#ä¸ƒä½¿ç”¨ç¤ºä¾‹)
- [å…«ã€æœ€ä½³å®è·µ](#å…«æœ€ä½³å®è·µ)
- [ä¹ã€æ•…éšœæ’æŸ¥](#ä¹æ•…éšœæ’æŸ¥)

---

## ä¸€ã€æ¶æ„æ¦‚è¿°

### 1.1 ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        æ¶ˆæ¯ä¸­å¿ƒç³»ç»Ÿæ¶æ„                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ æ¶ˆæ¯æ¥æ”¶å±‚   â”‚â”€â”€â”€â”€â–¶â”‚ æ¶ˆæ¯å¤„ç†å±‚   â”‚â”€â”€â”€â”€â–¶â”‚ æ¶ˆæ¯åˆ†å‘å±‚   â”‚    â”‚
â”‚  â”‚              â”‚     â”‚              â”‚     â”‚              â”‚    â”‚
â”‚  â”‚ â€¢ Webhook    â”‚     â”‚ â€¢ å»é‡       â”‚     â”‚ â€¢ ä¿å­˜åˆ°     â”‚    â”‚
â”‚  â”‚ â€¢ éªŒè¯       â”‚     â”‚ â€¢ è§£æ       â”‚     â”‚   messages   â”‚    â”‚
â”‚  â”‚ â€¢ æ ¼å¼åŒ–     â”‚     â”‚ â€¢ è·¯ç”±       â”‚     â”‚ â€¢ ä¿å­˜åˆ°     â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚session_messagesâ”‚   â”‚
â”‚                                              â”‚ â€¢ ä¿å­˜åˆ°     â”‚    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚staff_messages â”‚   â”‚
â”‚  â”‚ ä¼šè¯ç®¡ç†å±‚   â”‚     â”‚ ä¸Šä¸‹æ–‡ç®¡ç†å±‚ â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚  â”‚              â”‚     â”‚              â”‚                          â”‚
â”‚  â”‚ â€¢ ä¼šè¯åˆ›å»º   â”‚     â”‚ â€¢ å†å²åŠ è½½   â”‚                          â”‚
â”‚  â”‚ â€¢ ä¼šè¯æ›´æ–°   â”‚     â”‚ â€¢ ä¸Šä¸‹æ–‡     â”‚                          â”‚
â”‚  â”‚ â€¢ ä¼šè¯æŸ¥è¯¢   â”‚     â”‚   ç¼“å­˜       â”‚                          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 æ ¸å¿ƒèŒè´£

| å±‚çº§ | èŒè´£ | æ ¸å¿ƒæœåŠ¡ |
|------|------|----------|
| æ¶ˆæ¯æ¥æ”¶å±‚ | æ¥æ”¶ã€éªŒè¯ã€å»é‡æ¶ˆæ¯ | WorkTool Callback |
| æ¶ˆæ¯å¤„ç†å±‚ | è¯†åˆ«å‘é€è€…ã€ååŒå†³ç­– | MessageProcessingService |
| æ¶ˆæ¯åˆ†å‘å±‚ | ä¿å­˜åˆ°ä¸åŒçš„æ¶ˆæ¯è¡¨ | SessionMessageService |
| ä¼šè¯ç®¡ç†å±‚ | ç®¡ç†ä¼šè¯ç”Ÿå‘½å‘¨æœŸ | SessionService |
| ä¸Šä¸‹æ–‡ç®¡ç†å±‚ | åŠ è½½å’Œç®¡ç†å†å²æ¶ˆæ¯ | SessionMessageService + MessageCacheService |

### 1.3 æœåŠ¡ä¾èµ–å…³ç³»

```
MessageProcessingService (æ¶ˆæ¯å¤„ç†)
    â†“
    â”œâ”€ SessionMessageService (æ¶ˆæ¯ä¿å­˜)
    â”‚   â†“
    â”‚   â”œâ”€ MessageCacheService (ç¼“å­˜ç®¡ç†)
    â”‚   â””â”€ PostgreSQL (æ•°æ®æŒä¹…åŒ–)
    â”‚
    â”œâ”€ StaffIdentifierService (å·¥ä½œäººå‘˜è¯†åˆ«)
    â”‚   â””â”€ StaffTrackerService (å·¥ä½œäººå‘˜è¿½è¸ª)
    â”‚
    â””â”€ CollabDecisionService (ååŒå†³ç­–)
        â””â”€ CollaborationService

FlowEngine (æµç¨‹å¼•æ“)
    â†“
    â”œâ”€ SessionMessageService (æ¶ˆæ¯ä¿å­˜ã€å†å²åŠ è½½)
    â”œâ”€ MessageCacheService (ç¼“å­˜æŸ¥è¯¢)
    â””â”€ ContextHelper (ä¸Šä¸‹æ–‡å·¥å…·)
```

---

## äºŒã€æ ¸å¿ƒæœåŠ¡

### 2.1 SessionMessageServiceï¼ˆä¼šè¯æ¶ˆæ¯æœåŠ¡ï¼‰

**æ–‡ä»¶è·¯å¾„**: `server/services/session-message.service.js`

**æ ¸å¿ƒèŒè´£**:
- ç»Ÿä¸€ç®¡ç†ç”¨æˆ·ã€æœºå™¨äººã€äººå·¥æ¶ˆæ¯çš„ä¿å­˜
- æä¾›ä¼šè¯æ¶ˆæ¯æŸ¥è¯¢æ¥å£
- ç®¡ç†æ¶ˆæ¯ç¼“å­˜
- æä¾›ä¼šè¯ç»Ÿè®¡åŠŸèƒ½

#### 2.1.1 ä¿å­˜ç”¨æˆ·æ¶ˆæ¯

```javascript
/**
 * ä¿å­˜ç”¨æˆ·æ¶ˆæ¯
 * @param {string} sessionId - ä¼šè¯ID
 * @param {Object} messageContext - æ¶ˆæ¯ä¸Šä¸‹æ–‡
 * @param {string} messageId - æ¶ˆæ¯ID
 * @param {Object} robot - æœºå™¨äººé…ç½®
 */
await sessionMessageService.saveUserMessage(
  sessionId,
  messageContext,
  messageId,
  robot
);
```

**å‚æ•°è¯´æ˜**:
- `sessionId`: ä¼šè¯IDï¼Œæ ¼å¼ï¼š`session_{groupName}` æˆ– `session_{userName}`
- `messageContext`: æ¶ˆæ¯ä¸Šä¸‹æ–‡å¯¹è±¡
  - `userId`: ç”¨æˆ·ID
  - `userName`: ç”¨æˆ·åç§°
  - `groupId`: ç¾¤ç»„ID
  - `groupName`: ç¾¤ç»„åç§°
  - `content`: æ¶ˆæ¯å†…å®¹
  - `timestamp`: æ—¶é—´æˆ³
  - `metadata`: å…ƒæ•°æ®å¯¹è±¡
- `messageId`: æ¶ˆæ¯å”¯ä¸€æ ‡è¯†
- `robot`: æœºå™¨äººé…ç½®å¯¹è±¡
  - `robotId`: æœºå™¨äººID
  - `name` æˆ– `nickname`: æœºå™¨äººåç§°

**è¿”å›å€¼**: Promise<void>

**ç¤ºä¾‹**:
```javascript
await sessionMessageService.saveUserMessage(
  'session_test_group',
  {
    userId: 'user123',
    userName: 'å¼ ä¸‰',
    groupId: 'test_group',
    groupName: 'æµ‹è¯•ç¾¤',
    content: 'ä½ å¥½ï¼Œè¯·é—®æœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©æ‚¨çš„ï¼Ÿ',
    timestamp: new Date(),
    metadata: {
      senderInfo: { type: 'user', trustLevel: 'normal' }
    }
  },
  'msg_123456',
  {
    robotId: 'wt22phhjpt2xboerspxsote472xdnyq2',
    nickname: 'æ½˜è¯­æ¬£'
  }
);
```

#### 2.1.2 ä¿å­˜æœºå™¨äººæ¶ˆæ¯

```javascript
/**
 * ä¿å­˜æœºå™¨äººå›å¤æ¶ˆæ¯
 * @param {string} sessionId - ä¼šè¯ID
 * @param {string} content - æ¶ˆæ¯å†…å®¹
 * @param {Object} messageContext - æ¶ˆæ¯ä¸Šä¸‹æ–‡
 * @param {string} intent - æ„å›¾
 * @param {Object} robot - æœºå™¨äººé…ç½®
 */
await sessionMessageService.saveBotMessage(
  sessionId,
  content,
  messageContext,
  intent,
  robot
);
```

**å‚æ•°è¯´æ˜**:
- `sessionId`: ä¼šè¯ID
- `content`: æœºå™¨äººå›å¤å†…å®¹
- `messageContext`: æ¶ˆæ¯ä¸Šä¸‹æ–‡å¯¹è±¡
- `intent`: æ„å›¾ï¼ˆå¯é€‰ï¼Œé»˜è®¤ä¸º nullï¼‰
- `robot`: æœºå™¨äººé…ç½®å¯¹è±¡

**è¿”å›å€¼**: Promise<void>

**ç¤ºä¾‹**:
```javascript
await sessionMessageService.saveBotMessage(
  'session_test_group',
  'æ‚¨å¥½ï¼æˆ‘æ˜¯æ™ºèƒ½åŠ©æ‰‹ï¼Œå¾ˆé«˜å…´ä¸ºæ‚¨æœåŠ¡ã€‚',
  {
    userId: 'user123',
    userName: 'å¼ ä¸‰',
    groupId: 'test_group',
    groupName: 'æµ‹è¯•ç¾¤',
  },
  'greeting',
  {
    robotId: 'wt22phhjpt2xboerspxsote472xdnyq2',
    nickname: 'æ½˜è¯­æ¬£'
  }
);
```

#### 2.1.3 ä¿å­˜äººå·¥æ¶ˆæ¯

```javascript
/**
 * ä¿å­˜äººå·¥å›å¤æ¶ˆæ¯
 * @param {string} sessionId - ä¼šè¯ID
 * @param {string} content - æ¶ˆæ¯å†…å®¹
 * @param {Object} messageContext - æ¶ˆæ¯ä¸Šä¸‹æ–‡
 * @param {string} operator - æ“ä½œå‘˜åç§°
 * @param {Object} robot - æœºå™¨äººé…ç½®
 */
await sessionMessageService.saveHumanMessage(
  sessionId,
  content,
  messageContext,
  operator,
  robot
);
```

**ç¤ºä¾‹**:
```javascript
await sessionMessageService.saveHumanMessage(
  'session_test_group',
  'æ‚¨å¥½ï¼Œæˆ‘æ˜¯äººå·¥å®¢æœï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©æ‚¨çš„ï¼Ÿ',
  {
    userId: 'user123',
    userName: 'å¼ ä¸‰',
    groupId: 'test_group',
    groupName: 'æµ‹è¯•ç¾¤',
  },
  'æå››',
  {
    robotId: 'wt22phhjpt2xboerspxsote472xdnyq2',
    nickname: 'æ½˜è¯­æ¬£'
  }
);
```

#### 2.1.4 è·å–ä¼šè¯æ¶ˆæ¯

```javascript
/**
 * è·å–ä¼šè¯çš„æ¶ˆæ¯è®°å½•ï¼ˆå¸¦ç¼“å­˜ï¼‰
 * @param {string} sessionId - ä¼šè¯ID
 * @param {number} limit - é™åˆ¶æ•°é‡ï¼Œé»˜è®¤ 100
 * @returns {Promise<Array>} æ¶ˆæ¯åˆ—è¡¨
 */
const messages = await sessionMessageService.getSessionMessages(
  sessionId,
  limit
);
```

**è¿”å›å€¼**:
```javascript
[
  {
    id: 'uuid',
    content: 'æ¶ˆæ¯å†…å®¹',
    isFromUser: true,
    isFromBot: false,
    isHuman: false,
    timestamp: '2026-02-10T10:00:00Z',
    intent: 'greeting',
    userName: 'å¼ ä¸‰',
    groupName: 'æµ‹è¯•ç¾¤',
    robotName: 'æ½˜è¯­æ¬£',
    extraData: {}
  },
  // ... æ›´å¤šæ¶ˆæ¯
]
```

#### 2.1.5 è·å–æ´»è·ƒä¼šè¯åˆ—è¡¨

```javascript
/**
 * è·å–æ´»è·ƒä¼šè¯åˆ—è¡¨ï¼ˆç”¨äºå‰ç«¯æ˜¾ç¤ºï¼‰
 * @param {Object} options - æŸ¥è¯¢é€‰é¡¹
 * @param {number} options.limit - é™åˆ¶æ•°é‡ï¼Œé»˜è®¤ 50
 * @param {number} options.hours - æ—¶é—´èŒƒå›´ï¼ˆå°æ—¶ï¼‰ï¼Œé»˜è®¤ 24
 * @returns {Promise<Array>} ä¼šè¯åˆ—è¡¨
 */
const sessions = await sessionMessageService.getActiveSessions({
  limit: 50,
  hours: 24
});
```

**è¿”å›å€¼**:
```javascript
[
  {
    sessionId: 'session_test_group',
    userId: 'user123',
    userName: 'å¼ ä¸‰',
    groupId: 'test_group',
    groupName: 'æµ‹è¯•ç¾¤',
    robotId: 'wt22phhjpt2xboerspxsote472xdnyq2',
    robotName: 'æ½˜è¯­æ¬£',
    robotNickname: 'æ½˜è¯­æ¬£',
    messageCount: 5,
    lastActivityTime: '2026-02-10T10:00:00Z',
    lastUserMessage: 'ä½ å¥½',
    lastBotReply: 'æ‚¨å¥½ï¼æœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©æ‚¨çš„ï¼Ÿ',
    lastBotReplyTime: '2026-02-10T10:00:05Z',
    lastUserMessageTime: '2026-02-10T10:00:00Z'
  },
  // ... æ›´å¤šä¼šè¯
]
```

#### 2.1.6 æœç´¢æ¶ˆæ¯

```javascript
/**
 * æœç´¢ä¼šè¯æ¶ˆæ¯ï¼ˆå¸¦ç¼“å­˜ï¼‰
 * @param {string} keyword - æœç´¢å…³é”®è¯
 * @param {number} limit - é™åˆ¶æ•°é‡ï¼Œé»˜è®¤ 50
 * @returns {Promise<Array>} æ¶ˆæ¯åˆ—è¡¨
 */
const messages = await sessionMessageService.searchMessages(
  keyword,
  limit
);
```

#### 2.1.7 è·å–ç”¨æˆ·æ¶ˆæ¯å†å²

```javascript
/**
 * è·å–ç”¨æˆ·çš„æ¶ˆæ¯å†å²ï¼ˆå¸¦ç¼“å­˜ï¼‰
 * @param {string} userId - ç”¨æˆ·ID
 * @param {number} limit - é™åˆ¶æ•°é‡ï¼Œé»˜è®¤ 50
 * @returns {Promise<Array>} æ¶ˆæ¯åˆ—è¡¨
 */
const messages = await sessionMessageService.getUserMessages(
  userId,
  limit
);
```

#### 2.1.8 è·å–ä¼šè¯ç»Ÿè®¡

```javascript
/**
 * è·å–ä¼šè¯ç»Ÿè®¡ï¼ˆå¸¦ç¼“å­˜ï¼‰
 * @param {string} sessionId - ä¼šè¯ID
 * @returns {Promise<Object>} ç»Ÿè®¡æ•°æ®
 */
const stats = await sessionMessageService.getSessionStats(sessionId);
```

**è¿”å›å€¼**:
```javascript
{
  total: 10,          // æ€»æ¶ˆæ¯æ•°
  userMessages: 5,    // ç”¨æˆ·æ¶ˆæ¯æ•°
  botMessages: 4,     // æœºå™¨äººæ¶ˆæ¯æ•°
  humanMessages: 1    // äººå·¥æ¶ˆæ¯æ•°
}
```

#### 2.1.9 æ¸…ç†è¿‡æœŸæ¶ˆæ¯

```javascript
/**
 * æ¸…ç†è¿‡æœŸçš„æ¶ˆæ¯è®°å½•ï¼ˆä¿ç•™æœ€è¿‘90å¤©ï¼‰
 * @param {number} days - ä¿ç•™å¤©æ•°ï¼Œé»˜è®¤ 90
 * @returns {Promise<number>} åˆ é™¤çš„æ¶ˆæ¯æ•°é‡
 */
const deletedCount = await sessionMessageService.cleanup(days);
```

---

### 2.2 MessageCacheServiceï¼ˆæ¶ˆæ¯ç¼“å­˜æœåŠ¡ï¼‰

**æ–‡ä»¶è·¯å¾„**: `server/services/message-cache.service.js`

**æ ¸å¿ƒèŒè´£**:
- ç®¡ç†ä¼šè¯æ¶ˆæ¯ç¼“å­˜
- ç®¡ç†ç”¨æˆ·æ¶ˆæ¯ç¼“å­˜
- ç®¡ç†æœç´¢ç»“æœç¼“å­˜
- ç®¡ç†ç»Ÿè®¡æ•°æ®ç¼“å­˜

#### 2.2.1 ç¼“å­˜é”®ç”Ÿæˆè§„åˆ™

| ç±»å‹ | ç¼“å­˜é”®æ ¼å¼ | TTL |
|------|-----------|-----|
| ä¼šè¯æ¶ˆæ¯ | `message:session:{sessionId}` | 60ç§’ |
| ç”¨æˆ·æ¶ˆæ¯ | `message:user:{userId}` | 60ç§’ |
| æœç´¢ç»“æœ | `message:search:{hash}:{limit}` | 60ç§’ |
| ä¼šè¯ç»Ÿè®¡ | `message:stats:{sessionId}` | 180ç§’ |

#### 2.2.2 å¸¸ç”¨æ–¹æ³•

```javascript
// è·å–ä¼šè¯æ¶ˆæ¯ç¼“å­˜
const cached = await messageCacheService.getSessionMessages(sessionId, limit);

// è®¾ç½®ä¼šè¯æ¶ˆæ¯ç¼“å­˜
const success = await messageCacheService.setSessionMessages(sessionId, messages, limit);

// åˆ é™¤ä¼šè¯æ¶ˆæ¯ç¼“å­˜
await messageCacheService.deleteSessionMessages(sessionId);

// è·å–ç”¨æˆ·æ¶ˆæ¯ç¼“å­˜
const cached = await messageCacheService.getUserMessages(userId, limit);

// è·å–æœç´¢ç»“æœç¼“å­˜
const cached = await messageCacheService.getSearchMessages(keyword, limit);

// è®¾ç½®æœç´¢ç»“æœç¼“å­˜
const success = await messageCacheService.setSearchMessages(keyword, messages, limit);

// è·å–ä¼šè¯ç»Ÿè®¡ç¼“å­˜
const cached = await messageCacheService.getSessionStats(sessionId);

// è®¾ç½®ä¼šè¯ç»Ÿè®¡ç¼“å­˜
const success = await messageCacheService.setSessionStats(sessionId, stats);
```

---

### 2.3 MessageProcessingServiceï¼ˆæ¶ˆæ¯å¤„ç†æœåŠ¡ï¼‰

**æ–‡ä»¶è·¯å¾„**: `server/services/message-processing.service.js`

**æ ¸å¿ƒèŒè´£**:
- è¯†åˆ«å·¥ä½œäººå‘˜
- å¤„ç†å·¥ä½œäººå‘˜æ¶ˆæ¯
- è¿›è¡ŒååŒå†³ç­–
- å†³å®šæ˜¯å¦è§¦å‘ AI å›å¤

#### 2.3.1 å¤„ç†æ¶ˆæ¯

```javascript
/**
 * å¤„ç†æ¶ˆæ¯ï¼ˆä¸»å…¥å£ï¼‰
 * @param {Object} context - ä¸Šä¸‹æ–‡å¯¹è±¡
 * @param {Object} message - æ¶ˆæ¯å¯¹è±¡
 * @param {Object} robot - æœºå™¨äººé…ç½®
 * @returns {Promise<Object>} å¤„ç†ç»“æœ
 */
const result = await messageProcessingService.processMessage(
  context,
  message,
  robot
);
```

**è¿”å›å€¼**:
```javascript
{
  success: true,
  type: 'user_message' | 'staff_message' | 'staff_command',
  shouldTriggerAI: true | false,
  decision: {
    shouldAIReply: true,
    reason: 'å†³ç­–åŸå› ',
    priority: 'high'
  },
  staffInfo: {
    isStaff: false,
    confidence: 0.5,
    matchMethod: 'keyword',
    staffUserId: null,
    staffName: null
  }
}
```

---

## ä¸‰ã€æ•°æ®æ¨¡å‹

### 3.1 session_messages è¡¨ï¼ˆä¼šè¯æ¶ˆæ¯è¡¨ï¼‰

**æ–‡ä»¶è·¯å¾„**: `server/database/schema.js`

**è¡¨ç»“æ„**:
```sql
CREATE TABLE session_messages (
  id VARCHAR(36) PRIMARY KEY,
  session_id VARCHAR(255) NOT NULL,      -- ä¼šè¯ID
  message_id VARCHAR(255),                -- æ¶ˆæ¯ID
  user_id VARCHAR(255),                   -- ç”¨æˆ·ID
  group_id VARCHAR(255),                  -- ç¾¤ç»„ID
  user_name VARCHAR(255),                 -- ç”¨æˆ·åç§°
  group_name VARCHAR(255),                -- ç¾¤ç»„åç§°
  robot_id VARCHAR(64),                   -- æœºå™¨äººID
  robot_name VARCHAR(255),                -- æœºå™¨äººåç§°
  robot_nickname VARCHAR(255),            -- æœºå™¨äººæ˜µç§°
  content TEXT NOT NULL,                  -- æ¶ˆæ¯å†…å®¹
  is_from_user BOOLEAN DEFAULT false,     -- æ˜¯å¦æ¥è‡ªç”¨æˆ·
  is_from_bot BOOLEAN DEFAULT false,      -- æ˜¯å¦æ¥è‡ªæœºå™¨äºº
  is_human BOOLEAN DEFAULT false,         -- æ˜¯å¦æ¥è‡ªäººå·¥
  intent VARCHAR(255),                    -- æ„å›¾
  confidence INTEGER,                     -- ç½®ä¿¡åº¦
  timestamp TIMESTAMP NOT NULL,           -- æ—¶é—´æˆ³
  extra_data JSONB DEFAULT '{}',          -- æ‰©å±•æ•°æ®
  created_at TIMESTAMP DEFAULT NOW(),     -- åˆ›å»ºæ—¶é—´
);
```

**å­—æ®µè¯´æ˜**:

| å­—æ®µ | ç±»å‹ | è¯´æ˜ | ç¤ºä¾‹å€¼ |
|------|------|------|--------|
| `id` | VARCHAR(36) | ä¸»é”®ID | `uuid-v4` |
| `session_id` | VARCHAR(255) | ä¼šè¯ID | `session_test_group` |
| `message_id` | VARCHAR(255) | æ¶ˆæ¯ID | `msg_123456` |
| `user_id` | VARCHAR(255) | ç”¨æˆ·ID | `user123` |
| `group_id` | VARCHAR(255) | ç¾¤ç»„ID | `test_group` |
| `user_name` | VARCHAR(255) | ç”¨æˆ·åç§° | `å¼ ä¸‰` |
| `group_name` | VARCHAR(255) | ç¾¤ç»„åç§° | `æµ‹è¯•ç¾¤` |
| `robot_id` | VARCHAR(64) | æœºå™¨äººID | `wt22phhjpt2xboerspxsote472xdnyq2` |
| `robot_name` | VARCHAR(255) | æœºå™¨äººåç§° | `æ½˜è¯­æ¬£` |
| `robot_nickname` | VARCHAR(255) | æœºå™¨äººæ˜µç§° | `å°æ½˜` |
| `content` | TEXT | æ¶ˆæ¯å†…å®¹ | `ä½ å¥½ï¼Œè¯·é—®æœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©æ‚¨çš„ï¼Ÿ` |
| `is_from_user` | BOOLEAN | æ˜¯å¦æ¥è‡ªç”¨æˆ· | `true` |
| `is_from_bot` | BOOLEAN | æ˜¯å¦æ¥è‡ªæœºå™¨äºº | `false` |
| `is_human` | BOOLEAN | æ˜¯å¦æ¥è‡ªäººå·¥ | `false` |
| `intent` | VARCHAR(255) | æ„å›¾ | `greeting` |
| `confidence` | INTEGER | ç½®ä¿¡åº¦ | `90` |
| `timestamp` | TIMESTAMP | æ—¶é—´æˆ³ | `2026-02-10T10:00:00Z` |
| `extra_data` | JSONB | æ‰©å±•æ•°æ® | `{"key": "value"}` |
| `created_at` | TIMESTAMP | åˆ›å»ºæ—¶é—´ | `2026-02-10T10:00:00Z` |

**çº¦æŸæ¡ä»¶**:
- `is_from_user`, `is_from_bot`, `is_human` ä¸‰è€…äº’æ–¥ï¼ŒåŒä¸€æ—¶é—´åªèƒ½æœ‰ä¸€ä¸ªä¸º `true`
- `timestamp` å¿…é¡»æ˜¯æœ‰æ•ˆçš„ Date å¯¹è±¡æˆ– ISO 8601 å­—ç¬¦ä¸²
- `robot_id` é•¿åº¦ä¸èƒ½è¶…è¿‡ 64 å­—ç¬¦
- `robot_name`, `robot_nickname` é•¿åº¦ä¸èƒ½è¶…è¿‡ 255 å­—ç¬¦
- `session_id` é•¿åº¦ä¸èƒ½è¶…è¿‡ 255 å­—ç¬¦

**ç´¢å¼•**:
- `session_messages_session_id_idx`: æŸ¥è¯¢ä¼šè¯æ¶ˆæ¯
- `session_messages_timestamp_idx`: æŒ‰æ—¶é—´æ’åº
- `session_messages_user_id_idx`: æŸ¥è¯¢ç”¨æˆ·æ¶ˆæ¯
- `session_messages_is_from_user_idx`: åŒºåˆ†æ¶ˆæ¯æ¥æº
- `session_messages_is_from_bot_idx`: åŒºåˆ†æœºå™¨äººæ¶ˆæ¯
- `session_messages_is_human_idx`: åŒºåˆ†äººå·¥æ¶ˆæ¯

---

### 3.2 messages è¡¨ï¼ˆåŸå§‹æ¶ˆæ¯è¡¨ï¼‰

**è¡¨ç»“æ„**:
```sql
CREATE TABLE messages (
  id VARCHAR(36) PRIMARY KEY,
  session_id VARCHAR(255),
  user_session_id VARCHAR(255),
  robot_id VARCHAR(255),
  content TEXT,
  content_type VARCHAR(255),
  sender_id VARCHAR(255),
  sender_type VARCHAR(255),
  sender_name VARCHAR(255),
  message_type VARCHAR(255),
  ai_model VARCHAR(255),
  ai_provider VARCHAR(255),
  ai_response_time INTEGER,
  ai_tokens_used INTEGER,
  ai_cost NUMERIC,
  ai_confidence NUMERIC,
  intent_id VARCHAR(255),
  intent_confidence NUMERIC,
  emotion VARCHAR(255),
  emotion_score NUMERIC,
  metadata JSONB DEFAULT '{}',
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),
);
```

**è¯´æ˜**: æ­¤è¡¨ç”¨äºå­˜å‚¨åŸå§‹æ¶ˆæ¯æ•°æ®ï¼ŒåŒ…å« AI ç›¸å…³çš„å…ƒæ•°æ®ï¼ˆtokensã€costã€confidence ç­‰ï¼‰ã€‚

---

### 3.3 staff_messages è¡¨ï¼ˆå·¥ä½œäººå‘˜æ¶ˆæ¯è¡¨ï¼‰

**è¡¨ç»“æ„**:
```sql
CREATE TABLE staff_messages (
  id VARCHAR(36) PRIMARY KEY,
  session_id VARCHAR(255),
  message_id VARCHAR(255),
  staff_user_id VARCHAR(255),
  staff_name VARCHAR(255),
  content TEXT,
  message_type VARCHAR(255),
  is_handling_command BOOLEAN DEFAULT false,
  linked_risk_id VARCHAR(255),
  created_at TIMESTAMP DEFAULT NOW(),
  timestamp TIMESTAMP DEFAULT NOW(),
);
```

**è¯´æ˜**: æ­¤è¡¨ä¸“é—¨ç”¨äºå­˜å‚¨å·¥ä½œäººå‘˜æ¶ˆæ¯ï¼Œä¸ `session_messages` è¡¨é…åˆä½¿ç”¨ã€‚

---

### 3.4 risk_messages è¡¨ï¼ˆé£é™©æ¶ˆæ¯è¡¨ï¼‰

**è¡¨ç»“æ„**:
```sql
CREATE TABLE risk_messages (
  id VARCHAR(36) PRIMARY KEY,
  message_id VARCHAR(255),
  session_id VARCHAR(255),
  user_id VARCHAR(255),
  user_name VARCHAR(255),
  group_name VARCHAR(255),
  content TEXT,
  ai_reply TEXT,
  status VARCHAR(255),
  resolved_by VARCHAR(255),
  resolved_at TIMESTAMP,
  handled_by_staff JSONB DEFAULT '{}',
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),
);
```

**è¯´æ˜**: æ­¤è¡¨ç”¨äºå­˜å‚¨æ£€æµ‹åˆ°çš„é£é™©æ¶ˆæ¯å’Œ AI çš„å¤„ç†ç»“æœã€‚

---

## å››ã€æ¶ˆæ¯æµç¨‹

### 4.1 ç”¨æˆ·æ¶ˆæ¯å¤„ç†æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ç”¨æˆ·æ¶ˆæ¯å¤„ç†æµç¨‹                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. æ¶ˆæ¯æ¥æ”¶
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ WorkTool Webhook æ¥æ”¶æ¶ˆæ¯                                   â”‚
   â”‚ - éªŒè¯ç­¾å                                                    â”‚
   â”‚ - å¹‚ç­‰æ€§æ£€æŸ¥                                                  â”‚
   â”‚ - è®°å½•å®¡è®¡æ—¥å¿—                                                â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â†“
2. æ¶ˆæ¯ä¿å­˜
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ SessionMessageService.saveUserMessage()                     â”‚
   â”‚ - ä¿å­˜åˆ° session_messages è¡¨ (is_from_user: true)          â”‚
   â”‚ - æ¸…ç†ç¼“å­˜                                                    â”‚
   â”‚ - è®°å½•æ—¥å¿—                                                    â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â†“
3. æµç¨‹å¼•æ“å¤„ç†
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ FlowEngine.executeRoutedFlows()                             â”‚
   â”‚ - åˆ›å»ºæµç¨‹å®ä¾‹                                                â”‚
   â”‚ - åŠ è½½å†å²æ¶ˆæ¯ (context.history)                            â”‚
   â”‚ - æ‰§è¡ŒèŠ‚ç‚¹åºåˆ—                                                â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â†“
4. AI ç”Ÿæˆå›å¤
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ AI_REPLY èŠ‚ç‚¹                                                â”‚
   â”‚ - ä½¿ç”¨ context.history ç”Ÿæˆå›å¤                              â”‚
   â”‚ - ä¿å­˜ AI å›å¤ (saveBotMessage)                             â”‚
   â”‚ - è®°å½• AI IO æ—¥å¿—                                            â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â†“
5. æ¶ˆæ¯å‘é€
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ SEND_COMMAND èŠ‚ç‚¹                                            â”‚
   â”‚ - è°ƒç”¨ WorkTool API å‘é€æ¶ˆæ¯                                 â”‚
   â”‚ - ä¿å­˜ AI å›å¤ (saveBotMessage, åŒé‡ä¿éšœ)                   â”‚
   â”‚ - è®°å½•å‘é€æ—¥å¿—                                                â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â†“
6. å®Œæˆ
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ - æµç¨‹å®ä¾‹çŠ¶æ€æ›´æ–°ä¸º completed                               â”‚
   â”‚ - è®°å½•æ‰§è¡Œæ—¥å¿—                                                â”‚
   â”‚ - è¿”å›ç»“æœ                                                    â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 å·¥ä½œäººå‘˜æ¶ˆæ¯å¤„ç†æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 å·¥ä½œäººå‘˜æ¶ˆæ¯å¤„ç†æµç¨‹                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. æ¶ˆæ¯æ¥æ”¶
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ WorkTool Webhook æ¥æ”¶æ¶ˆæ¯                                   â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â†“
2. å·¥ä½œäººå‘˜è¯†åˆ«
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ MessageProcessingService.processMessage()                   â”‚
   â”‚ - StaffIdentifierService.identifyStaff()                     â”‚
   â”‚ - è¯†åˆ«æ˜¯å¦ä¸ºå·¥ä½œäººå‘˜                                           â”‚
   â”‚ - ç¡®å®šç½®ä¿¡åº¦å’ŒåŒ¹é…æ–¹æ³•                                         â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â†“
3. å·¥ä½œäººå‘˜æ¶ˆæ¯å¤„ç†
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ MessageProcessingService.handleStaffMessage()               â”‚
   â”‚ - è®°å½•å·¥ä½œäººå‘˜æ¶ˆæ¯ (recordStaffMessage)                     â”‚
   â”‚ - æ£€æŸ¥å·¥ä½œäººå‘˜æŒ‡ä»¤ (staffCommandService.detectCommand)     â”‚
   â”‚ - è®°å½•å·¥ä½œäººå‘˜æ´»åŠ¨ (staffTrackerService.updateActivity)     â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â†“
4. æ¶ˆæ¯ä¿å­˜
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ - ä¿å­˜åˆ° staff_messages è¡¨                                   â”‚
   â”‚ - ä¿å­˜åˆ° session_messages è¡¨ (is_human: true)               â”‚
   â”‚ - æ¸…ç†ç¼“å­˜                                                    â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â†“
5. å®Œæˆ
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ - è¿”å›å¤„ç†ç»“æœ                                                â”‚
   â”‚ - ä¸è§¦å‘ AI å›å¤ (shouldTriggerAI: false)                    â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## äº”ã€ä¸Šä¸‹æ–‡ç®¡ç†

### 5.1 ä¸Šä¸‹æ–‡åŠ è½½æœºåˆ¶

**è§¦å‘æ—¶æœº**:
- æµç¨‹å¼•æ“åˆ›å»ºæµç¨‹å®ä¾‹æ—¶ï¼ˆ`createFlowInstance`ï¼‰
- AI_REPLY èŠ‚ç‚¹æ‰§è¡Œå‰

**åŠ è½½é€»è¾‘**:
```javascript
// åœ¨ createFlowInstance ä¸­è‡ªåŠ¨åŠ è½½
const sessionId = triggerData.message?.groupName 
  ? `session_${triggerData.message.groupName}` 
  : triggerData.message?.fromName 
    ? `session_${triggerData.message.fromName}` 
    : null;

if (sessionId) {
  // ä»æ•°æ®åº“åŠ è½½æœ€è¿‘ 10 æ¡æ¶ˆæ¯
  const messages = await sessionMessageService.getSessionMessages(sessionId, 10);
  
  // è½¬æ¢ä¸º AI æœŸæœ›çš„æ ¼å¼
  history = messages.map(msg => ({
    role: msg.isFromUser ? 'user' : 'assistant',
    content: msg.content
  }));
  
  // æ·»åŠ åˆ° context.history
  context.history = history;
}
```

### 5.2 ä¸Šä¸‹æ–‡æ ¼å¼

**AI æœŸæœ›çš„æ ¼å¼**:
```javascript
[
  {
    role: 'user',
    content: 'ä½ å¥½'
  },
  {
    role: 'assistant',
    content: 'æ‚¨å¥½ï¼æœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©æ‚¨çš„ï¼Ÿ'
  },
  {
    role: 'user',
    content: 'æˆ‘æƒ³æŸ¥è¯¢ä¸€ä¸‹è®¢å•'
  },
  {
    role: 'assistant',
    content: 'å¥½çš„ï¼Œè¯·æä¾›æ‚¨çš„è®¢å•å·'
  }
]
```

**role å­—æ®µè¯´æ˜**:
- `user`: ç”¨æˆ·æ¶ˆæ¯ï¼ˆå¯¹åº” `is_from_user: true`ï¼‰
- `assistant`: AI æˆ–äººå·¥å›å¤ï¼ˆå¯¹åº” `is_from_bot: true` æˆ– `is_human: true`ï¼‰

### 5.3 ä¸Šä¸‹æ–‡ä½¿ç”¨

**åœ¨ AI_REPLY èŠ‚ç‚¹ä¸­ä½¿ç”¨**:
```javascript
// AI_REPLY èŠ‚ç‚¹è‡ªåŠ¨ä½¿ç”¨ context.history
if (useHistory && context.history && Array.isArray(context.history)) {
  const historyToUse = context.history.slice(-historyLength);
  messages.push(...historyToUse);
}
```

**é…ç½®å‚æ•°**:
- `useHistory`: æ˜¯å¦ä½¿ç”¨å†å²æ¶ˆæ¯ï¼Œé»˜è®¤ `true`
- `historyLength`: ä½¿ç”¨å†å²æ¶ˆæ¯çš„æ•°é‡ï¼Œé»˜è®¤ `10`

### 5.4 ä¸Šä¸‹æ–‡ç¼“å­˜

**ç¼“å­˜ç­–ç•¥**:
- ä½¿ç”¨ Redis ç¼“å­˜å†å²æ¶ˆæ¯
- TTL: 60 ç§’
- è‡ªåŠ¨å¤±æ•ˆï¼šæ–°æ¶ˆæ¯æ’å…¥åè‡ªåŠ¨æ¸…ç†ç¼“å­˜

**ç¼“å­˜é”®**:
```
message:session:{sessionId}
```

**ç¼“å­˜å†…å®¹**:
```javascript
[
  {
    id: 'uuid',
    content: 'æ¶ˆæ¯å†…å®¹',
    isFromUser: true,
    isFromBot: false,
    isHuman: false,
    timestamp: '2026-02-10T10:00:00Z',
    // ... å…¶ä»–å­—æ®µ
  },
  // ... æ›´å¤šæ¶ˆæ¯
]
```

---

## å…­ã€API æ¥å£

### 6.1 è·å–æ´»è·ƒä¼šè¯åˆ—è¡¨

**æ¥å£**: `GET /api/admin/sessions/active`

**å‚æ•°**:
- `limit`: è¿”å›æ•°é‡ï¼Œé»˜è®¤ `50`
- `hours`: æ—¶é—´èŒƒå›´ï¼ˆå°æ—¶ï¼‰ï¼Œé»˜è®¤ `24`

**ç¤ºä¾‹è¯·æ±‚**:
```bash
curl http://localhost:5000/api/admin/sessions/active?limit=20&hours=24
```

**ç¤ºä¾‹å“åº”**:
```json
{
  "success": true,
  "data": [
    {
      "sessionId": "session_test_group",
      "userId": "user123",
      "userName": "å¼ ä¸‰",
      "groupId": "test_group",
      "groupName": "æµ‹è¯•ç¾¤",
      "robotId": "wt22phhjpt2xboerspxsote472xdnyq2",
      "robotName": "æ½˜è¯­æ¬£",
      "robotNickname": "å°æ½˜",
      "messageCount": 5,
      "lastActivityTime": "2026-02-10T10:00:00Z",
      "lastUserMessage": "ä½ å¥½",
      "lastBotReply": "æ‚¨å¥½ï¼æœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©æ‚¨çš„ï¼Ÿ",
      "lastBotReplyTime": "2026-02-10T10:00:05Z",
      "lastUserMessageTime": "2026-02-10T10:00:00Z"
    }
  ]
}
```

### 6.2 è·å–ä¼šè¯æ¶ˆæ¯è¯¦æƒ…

**æ¥å£**: `GET /api/admin/sessions/{sessionId}/messages`

**å‚æ•°**:
- `limit`: è¿”å›æ•°é‡ï¼Œé»˜è®¤ `100`

**ç¤ºä¾‹è¯·æ±‚**:
```bash
curl http://localhost:5000/api/admin/sessions/session_test_group/messages?limit=50
```

**ç¤ºä¾‹å“åº”**:
```json
{
  "success": true,
  "data": {
    "sessionId": "session_test_group",
    "messages": [
      {
        "id": "uuid",
        "content": "ä½ å¥½",
        "isFromUser": true,
        "isFromBot": false,
        "isHuman": false,
        "timestamp": "2026-02-10T10:00:00Z",
        "intent": "greeting",
        "userName": "å¼ ä¸‰",
        "groupName": "æµ‹è¯•ç¾¤",
        "robotName": "æ½˜è¯­æ¬£"
      },
      {
        "id": "uuid",
        "content": "æ‚¨å¥½ï¼æœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©æ‚¨çš„ï¼Ÿ",
        "isFromUser": false,
        "isFromBot": true,
        "isHuman": false,
        "timestamp": "2026-02-10T10:00:05Z",
        "userName": "å¼ ä¸‰",
        "groupName": "æµ‹è¯•ç¾¤",
        "robotName": "æ½˜è¯­æ¬£"
      }
    ],
    "stats": {
      "total": 2,
      "userMessages": 1,
      "botMessages": 1,
      "humanMessages": 0
    }
  }
}
```

### 6.3 æœç´¢æ¶ˆæ¯

**æ¥å£**: `GET /api/admin/sessions/search`

**å‚æ•°**:
- `q`: æœç´¢å…³é”®è¯
- `limit`: è¿”å›æ•°é‡ï¼Œé»˜è®¤ `50`

**ç¤ºä¾‹è¯·æ±‚**:
```bash
curl "http://localhost:5000/api/admin/sessions/search?q=è®¢å•&limit=20"
```

### 6.4 è·å–ä¼šè¯ç»Ÿè®¡

**æ¥å£**: `GET /api/admin/sessions/{sessionId}/stats`

**ç¤ºä¾‹è¯·æ±‚**:
```bash
curl http://localhost:5000/api/admin/sessions/session_test_group/stats
```

**ç¤ºä¾‹å“åº”**:
```json
{
  "success": true,
  "data": {
    "sessionId": "session_test_group",
    "stats": {
      "total": 10,
      "userMessages": 5,
      "botMessages": 4,
      "humanMessages": 1
    }
  }
}
```

---

## ä¸ƒã€ä½¿ç”¨ç¤ºä¾‹

### 7.1 ä¿å­˜ç”¨æˆ·æ¶ˆæ¯

```javascript
const sessionMessageService = require('../services/session-message.service');

// ä¿å­˜ç”¨æˆ·æ¶ˆæ¯
await sessionMessageService.saveUserMessage(
  'session_test_group',
  {
    userId: 'user123',
    userName: 'å¼ ä¸‰',
    groupId: 'test_group',
    groupName: 'æµ‹è¯•ç¾¤',
    content: 'æˆ‘æƒ³æŸ¥è¯¢ä¸€ä¸‹è®¢å•',
    timestamp: new Date(),
    metadata: {
      senderInfo: { type: 'user', trustLevel: 'normal' }
    }
  },
  'msg_123456',
  {
    robotId: 'wt22phhjpt2xboerspxsote472xdnyq2',
    nickname: 'æ½˜è¯­æ¬£'
  }
);

console.log('ç”¨æˆ·æ¶ˆæ¯å·²ä¿å­˜');
```

### 7.2 ä¿å­˜ AI å›å¤

```javascript
// ä¿å­˜ AI å›å¤
await sessionMessageService.saveBotMessage(
  'session_test_group',
  'å¥½çš„ï¼Œè¯·æä¾›æ‚¨çš„è®¢å•å·ï¼Œæˆ‘å¸®æ‚¨æŸ¥è¯¢ã€‚',
  {
    userId: 'user123',
    userName: 'å¼ ä¸‰',
    groupId: 'test_group',
    groupName: 'æµ‹è¯•ç¾¤',
  },
  'order_query',
  {
    robotId: 'wt22phhjpt2xboerspxsote472xdnyq2',
    nickname: 'æ½˜è¯­æ¬£'
  }
);

console.log('AI å›å¤å·²ä¿å­˜');
```

### 7.3 è·å–ä¼šè¯æ¶ˆæ¯

```javascript
// è·å–ä¼šè¯æ¶ˆæ¯ï¼ˆæœ€è¿‘ 20 æ¡ï¼‰
const messages = await sessionMessageService.getSessionMessages(
  'session_test_group',
  20
);

console.log(`è·å–åˆ° ${messages.length} æ¡æ¶ˆæ¯`);
messages.forEach(msg => {
  console.log(`[${msg.isFromUser ? 'ç”¨æˆ·' : 'AI'}] ${msg.content}`);
});
```

### 7.4 è·å–æ´»è·ƒä¼šè¯åˆ—è¡¨

```javascript
// è·å–æœ€è¿‘ 24 å°æ—¶çš„æ´»è·ƒä¼šè¯ï¼ˆæœ€å¤š 50 ä¸ªï¼‰
const sessions = await sessionMessageService.getActiveSessions({
  limit: 50,
  hours: 24
});

console.log(`è·å–åˆ° ${sessions.length} ä¸ªæ´»è·ƒä¼šè¯`);
sessions.forEach(session => {
  console.log(`ä¼šè¯: ${session.groupName}`);
  console.log(`  ç”¨æˆ·: ${session.userName}`);
  console.log(`  æ¶ˆæ¯æ•°: ${session.messageCount}`);
  console.log(`  æœ€åæ´»åŠ¨: ${session.lastActivityTime}`);
  console.log(`  æœ€åä¸€æ¡æ¶ˆæ¯: ${session.lastUserMessage}`);
});
```

### 7.5 æœç´¢æ¶ˆæ¯

```javascript
// æœç´¢åŒ…å«"è®¢å•"çš„æ¶ˆæ¯
const messages = await sessionMessageService.searchMessages('è®¢å•', 50);

console.log(`æœç´¢åˆ° ${messages.length} æ¡ç›¸å…³æ¶ˆæ¯`);
messages.forEach(msg => {
  console.log(`[${msg.timestamp}] ${msg.userName}: ${msg.content}`);
});
```

### 7.6 è·å–ä¼šè¯ç»Ÿè®¡

```javascript
// è·å–ä¼šè¯ç»Ÿè®¡
const stats = await sessionMessageService.getSessionStats('session_test_group');

console.log('ä¼šè¯ç»Ÿè®¡:');
console.log(`  æ€»æ¶ˆæ¯æ•°: ${stats.total}`);
console.log(`  ç”¨æˆ·æ¶ˆæ¯: ${stats.userMessages}`);
console.log(`  æœºå™¨äººæ¶ˆæ¯: ${stats.botMessages}`);
console.log(`  äººå·¥æ¶ˆæ¯: ${stats.humanMessages}`);
```

---

## å…«ã€æœ€ä½³å®è·µ

### 8.1 æ¶ˆæ¯ä¿å­˜

**æœ€ä½³å®è·µ**:
1. âœ… å§‹ç»ˆä½¿ç”¨ `SessionMessageService` ä¿å­˜æ¶ˆæ¯ï¼Œä¸è¦ç›´æ¥æ“ä½œæ•°æ®åº“
2. âœ… ç”¨æˆ·æ¶ˆæ¯ã€AI å›å¤ã€äººå·¥å›å¤åˆ†åˆ«ä½¿ç”¨å¯¹åº”çš„æ–¹æ³•
3. âœ… ä¿å­˜åä¸éœ€è¦æ‰‹åŠ¨æ¸…ç†ç¼“å­˜ï¼ŒService ä¼šè‡ªåŠ¨å¤„ç†
4. âœ… ä¿å­˜å¤±è´¥çš„é”™è¯¯å·²ç»åœ¨ Service ä¸­å¤„ç†ï¼Œä¸éœ€è¦å†æ¬¡æ•è·

**é”™è¯¯ç¤ºä¾‹**:
```javascript
// âŒ é”™è¯¯ï¼šç›´æ¥æ“ä½œæ•°æ®åº“
const db = await getDb();
await db.insert(sessionMessages).values({...});

// âŒ é”™è¯¯ï¼šæ‰‹åŠ¨æ¸…ç†ç¼“å­˜
await messageCacheService.deleteSessionMessages(sessionId);
```

**æ­£ç¡®ç¤ºä¾‹**:
```javascript
// âœ… æ­£ç¡®ï¼šä½¿ç”¨ Service
await sessionMessageService.saveUserMessage(sessionId, messageContext, messageId, robot);
```

### 8.2 ä¸Šä¸‹æ–‡ç®¡ç†

**æœ€ä½³å®è·µ**:
1. âœ… ä¸Šä¸‹æ–‡è‡ªåŠ¨åŠ è½½ï¼Œä¸éœ€è¦æ‰‹åŠ¨ç®¡ç†
2. âœ… AI_REPLY èŠ‚ç‚¹é»˜è®¤ä½¿ç”¨ä¸Šä¸‹æ–‡ï¼Œé…ç½® `useHistory: true` å³å¯
3. âœ… ä¸Šä¸‹æ–‡ä¼šè‡ªåŠ¨ç¼“å­˜ï¼Œæé«˜æŸ¥è¯¢æ€§èƒ½
4. âœ… å†å²æ¶ˆæ¯æ•°é‡å»ºè®®è®¾ç½®ä¸º 10-20 æ¡

**é”™è¯¯ç¤ºä¾‹**:
```javascript
// âŒ é”™è¯¯ï¼šæ‰‹åŠ¨åŠ è½½ä¸Šä¸‹æ–‡
const messages = await sessionMessageService.getSessionMessages(sessionId, 10);
context.history = messages.map(...);
```

**æ­£ç¡®ç¤ºä¾‹**:
```javascript
// âœ… æ­£ç¡®ï¼šè‡ªåŠ¨åŠ è½½ä¸Šä¸‹æ–‡ï¼ˆåœ¨ createFlowInstance ä¸­ï¼‰
// AI_REPLY èŠ‚ç‚¹é…ç½®
{
  nodeType: 'ai_reply',
  data: {
    config: {
      useHistory: true,
      historyLength: 10
    }
  }
}
```

### 8.3 ç¼“å­˜ç®¡ç†

**æœ€ä½³å®è·µ**:
1. âœ… ç¼“å­˜è‡ªåŠ¨ç®¡ç†ï¼Œä¸éœ€è¦æ‰‹åŠ¨æ¸…ç†
2. âœ… æ–°æ¶ˆæ¯æ’å…¥åï¼Œç¼“å­˜ä¼šè‡ªåŠ¨å¤±æ•ˆ
3. âœ… å¯ä»¥é€šè¿‡è°ƒæ•´ TTL ä¼˜åŒ–æ€§èƒ½

**ç¼“å­˜ TTL å»ºè®®**:
- ä¼šè¯æ¶ˆæ¯: 60 ç§’
- ä¼šè¯ç»Ÿè®¡: 180 ç§’
- æœç´¢ç»“æœ: 60 ç§’

### 8.4 é”™è¯¯å¤„ç†

**æœ€ä½³å®è·µ**:
1. âœ… Service æ–¹æ³•å·²ç»åŒ…å«é”™è¯¯å¤„ç†ï¼Œä¸éœ€è¦å†æ¬¡æ•è·
2. âœ… ä¿å­˜å¤±è´¥ä¸ä¼šé˜»æ–­æµç¨‹ï¼Œåªè®°å½•æ—¥å¿—
3. âœ… å¦‚æœéœ€è¦è‡ªå®šä¹‰é”™è¯¯å¤„ç†ï¼Œå¯ä»¥åœ¨ Service å¤–éƒ¨åŒ…è£¹ try-catch

**ç¤ºä¾‹**:
```javascript
// âœ… æ­£ç¡®ï¼šService å·²ç»åŒ…å«é”™è¯¯å¤„ç†
await sessionMessageService.saveUserMessage(...);

// âœ… å¦‚æœéœ€è¦è‡ªå®šä¹‰å¤„ç†
try {
  await sessionMessageService.saveUserMessage(...);
} catch (error) {
  // è‡ªå®šä¹‰é”™è¯¯å¤„ç†
  console.error('è‡ªå®šä¹‰é”™è¯¯:', error);
}
```

---

## ä¹ã€æ•…éšœæ’æŸ¥

### 9.1 æ¶ˆæ¯æœªä¿å­˜åˆ°æ•°æ®åº“

**æ£€æŸ¥æ­¥éª¤**:

1. æ£€æŸ¥æ—¥å¿—
```bash
grep "ä¿å­˜ç”¨æˆ·æ¶ˆæ¯å¤±è´¥\|ä¿å­˜ AI å›å¤å¤±è´¥" /app/work/logs/bypass/app.log | tail -20
```

2. æ£€æŸ¥æ•°æ®åº“è¿æ¥
```javascript
const db = await getDb();
console.log('æ•°æ®åº“è¿æ¥çŠ¶æ€:', db ? 'æ­£å¸¸' : 'å¼‚å¸¸');
```

3. æ£€æŸ¥å­—æ®µé•¿åº¦
```sql
-- æ£€æŸ¥æ˜¯å¦æœ‰å­—æ®µé•¿åº¦è¶…é™
SELECT 
  session_id, 
  LENGTH(session_id) as session_id_length,
  robot_id, 
  LENGTH(robot_id) as robot_id_length,
  robot_name,
  LENGTH(robot_name) as robot_name_length
FROM session_messages 
WHERE created_at >= NOW() - INTERVAL '1 hour';
```

**å¸¸è§é—®é¢˜**:
- `robot_id` é•¿åº¦è¶…è¿‡ 64 å­—ç¬¦
- `robot_name` é•¿åº¦è¶…è¿‡ 255 å­—ç¬¦
- `session_id` é•¿åº¦è¶…è¿‡ 255 å­—ç¬¦

**è§£å†³æ–¹æ¡ˆ**:
```javascript
// æˆªæ–­è¿‡é•¿çš„å­—æ®µ
const robotId = robot.robotId?.substring(0, 64);
const robotName = robot.name?.substring(0, 255);
```

### 9.2 AI å›å¤æœªæ˜¾ç¤º

**æ£€æŸ¥æ­¥éª¤**:

1. æ£€æŸ¥ `session_messages` è¡¨
```sql
SELECT content, is_from_user, is_from_bot, timestamp
FROM session_messages
WHERE created_at >= NOW() - INTERVAL '5 minutes'
ORDER BY timestamp DESC
LIMIT 10;
```

2. æ£€æŸ¥ `flow_execution_logs` è¡¨
```sql
SELECT node_type, status, output_data
FROM flow_execution_logs
WHERE created_at >= NOW() - INTERVAL '5 minutes'
  AND node_type IN ('ai_reply', 'send_command')
ORDER BY created_at DESC
LIMIT 10;
```

3. æ£€æŸ¥ AI æœåŠ¡æ—¥å¿—
```bash
grep "AI å›å¤èŠ‚ç‚¹æ‰§è¡ŒæˆåŠŸ\|saveBotMessage" /app/work/logs/bypass/app.log | tail -20
```

**å¸¸è§é—®é¢˜**:
- AI_REPLY èŠ‚ç‚¹æœªè°ƒç”¨ `saveBotMessage()`
- SEND_COMMAND èŠ‚ç‚¹æœªè°ƒç”¨ `saveBotMessage()`
- `is_from_bot` å­—æ®µæœªæ­£ç¡®è®¾ç½®

**è§£å†³æ–¹æ¡ˆ**:
ç¡®ä¿åœ¨ `AI_REPLY` å’Œ `SEND_COMMAND` èŠ‚ç‚¹ä¸­è°ƒç”¨ï¼š
```javascript
await sessionMessageService.saveBotMessage(
  context.sessionId,
  result.content,
  {...},
  null,
  context.robot
);
```

### 9.3 å‰ç«¯æ— æ³•æ˜¾ç¤ºæ¶ˆæ¯

**æ£€æŸ¥æ­¥éª¤**:

1. æ£€æŸ¥ API è¿”å›
```bash
curl http://localhost:5000/api/admin/sessions/active?limit=10
```

2. æ£€æŸ¥ `session_messages` è¡¨
```sql
SELECT session_id, user_name, content, timestamp
FROM session_messages
WHERE created_at >= NOW() - INTERVAL '24 hours'
ORDER BY timestamp DESC
LIMIT 10;
```

3. æ£€æŸ¥å‰ç«¯è°ƒç”¨
```javascript
// å‰ç«¯ä»£ç 
fetch('/api/admin/sessions/active?limit=20')
  .then(res => res.json())
  .then(data => console.log(data));
```

**å¸¸è§é—®é¢˜**:
- API è¿”å› `userLoginSessions` è€Œé `sessionMessages`
- æ—¶é—´èŒƒå›´ä¸åŒ¹é…ï¼ˆå‰ç«¯æŸ¥è¯¢ 24 å°æ—¶ï¼Œä½†æ•°æ®æ˜¯ 1 å°æ—¶å‰çš„ï¼‰

**è§£å†³æ–¹æ¡ˆ**:
ç¡®ä¿ API è°ƒç”¨ï¼š
```javascript
const sessions = await sessionMessageService.getActiveSessions({
  limit: parseInt(limit),
  hours: parseInt(hours)
});
```

### 9.4 å†å²æ¶ˆæ¯æœªåŠ è½½

**æ£€æŸ¥æ­¥éª¤**:

1. æ£€æŸ¥ `context.history`
```javascript
console.log('å†å²æ¶ˆæ¯:', context.history);
console.log('å†å²æ¶ˆæ¯é•¿åº¦:', context.history?.length);
```

2. æ£€æŸ¥ç¼“å­˜
```bash
# æŸ¥çœ‹ Redis ç¼“å­˜
redis-cli KEYS "message:session:*"
redis-cli GET "message:session:session_test_group"
```

3. æ£€æŸ¥æ—¥å¿—
```bash
grep "å·²åŠ è½½å†å²æ¶ˆæ¯\|åŠ è½½å†å²æ¶ˆæ¯å¤±è´¥" /app/work/logs/bypass/app.log | tail -20
```

**å¸¸è§é—®é¢˜**:
- `sessionId` æ ¼å¼ä¸æ­£ç¡®
- ä¼šè¯ä¸å­˜åœ¨æˆ–æ²¡æœ‰æ¶ˆæ¯
- ç¼“å­˜æœªå‘½ä¸­

**è§£å†³æ–¹æ¡ˆ**:
ç¡®ä¿ `sessionId` æ ¼å¼æ­£ç¡®ï¼š
```javascript
const sessionId = message.groupName 
  ? `session_${message.groupName}` 
  : message.fromName 
    ? `session_${message.fromName}` 
    : null;
```

---

## åã€æ€»ç»“

### 10.1 æ ¸å¿ƒè¦ç‚¹

1. **ç»Ÿä¸€å…¥å£**: æ‰€æœ‰æ¶ˆæ¯ä¿å­˜å¿…é¡»é€šè¿‡ `SessionMessageService`
2. **è‡ªåŠ¨ç¼“å­˜**: æ¶ˆæ¯ç¼“å­˜è‡ªåŠ¨ç®¡ç†ï¼Œæ— éœ€æ‰‹åŠ¨æ¸…ç†
3. **ä¸Šä¸‹æ–‡è‡ªåŠ¨åŠ è½½**: æµç¨‹å¼•æ“è‡ªåŠ¨åŠ è½½å†å²æ¶ˆæ¯
4. **é”™è¯¯å¤„ç†**: Service æ–¹æ³•å·²åŒ…å«é”™è¯¯å¤„ç†
5. **åŒå†™ä¿éšœ**: AI å›å¤åœ¨ AI_REPLY å’Œ SEND_COMMAND èŠ‚ç‚¹éƒ½ä¼šä¿å­˜

### 10.2 æœåŠ¡è°ƒç”¨æ¸…å•

| åœºæ™¯ | è°ƒç”¨æ–¹æ³• | æ–‡ä»¶ |
|------|---------|------|
| ç”¨æˆ·æ¶ˆæ¯è¿›å…¥ | `saveUserMessage()` | flow-engine.service.js |
| AI ç”Ÿæˆå›å¤ | `saveBotMessage()` | flow-engine.service.js |
| å‘é€ AI å›å¤ | `saveBotMessage()` | flow-engine.service.js |
| å·¥ä½œäººå‘˜å›å¤ | `saveHumanMessage()` | message-processing.service.js |
| åŠ è½½å†å²æ¶ˆæ¯ | `getSessionMessages()` | flow-engine.service.js |
| è·å–æ´»è·ƒä¼šè¯ | `getActiveSessions()` | admin.api.js |
| æœç´¢æ¶ˆæ¯ | `searchMessages()` | admin.api.js |

### 10.3 æ•°æ®æµ

```
ç”¨æˆ·æ¶ˆæ¯
  â†“
sessionMessageService.saveUserMessage()
  â†“
session_messages è¡¨ (is_from_user: true)
  â†“
æµç¨‹å¼•æ“åŠ è½½å†å²æ¶ˆæ¯ (getSessionMessages)
  â†“
AI ç”Ÿæˆå›å¤ (ä½¿ç”¨ context.history)
  â†“
sessionMessageService.saveBotMessage()
  â†“
session_messages è¡¨ (is_from_bot: true)
  â†“
å‰ç«¯æŸ¥è¯¢ä¼šè¯ (getActiveSessions)
  â†“
æ˜¾ç¤ºæ¶ˆæ¯
```

---

## é™„å½•

### A. ç›¸å…³æ–‡æ¡£

- [æµç¨‹å¼•æ“è®¾è®¡æ–‡æ¡£](./FLOW_ENGINE_REDESIGN_V2.md)
- [ç³»ç»Ÿåˆ†ææŠ¥å‘Š](./SYSTEM_ANALYSIS_REPORT.md)
- [æ•°æ®åº“ Schema](../database/schema.js)

### B. ç›¸å…³æœåŠ¡

- `session-message.service.js` - ä¼šè¯æ¶ˆæ¯æœåŠ¡
- `message-cache.service.js` - æ¶ˆæ¯ç¼“å­˜æœåŠ¡
- `message-processing.service.js` - æ¶ˆæ¯å¤„ç†æœåŠ¡
- `flow-engine.service.js` - æµç¨‹å¼•æ“æœåŠ¡

### C. ç›¸å…³è¡¨

- `session_messages` - ä¼šè¯æ¶ˆæ¯è¡¨
- `messages` - åŸå§‹æ¶ˆæ¯è¡¨
- `staff_messages` - å·¥ä½œäººå‘˜æ¶ˆæ¯è¡¨
- `risk_messages` - é£é™©æ¶ˆæ¯è¡¨

### D. å¸¸ç”¨ SQL

```sql
-- æŸ¥çœ‹æœ€è¿‘çš„ç”¨æˆ·å’Œæœºå™¨äººæ¶ˆæ¯
SELECT session_id, user_name, content, is_from_user, is_from_bot, timestamp
FROM session_messages
WHERE created_at >= NOW() - INTERVAL '1 hour'
ORDER BY timestamp DESC
LIMIT 20;

-- ç»Ÿè®¡æ¶ˆæ¯ç±»å‹
SELECT 
  is_from_user,
  is_from_bot,
  is_human,
  COUNT(*) as count
FROM session_messages
WHERE created_at >= NOW() - INTERVAL '24 hours'
GROUP BY is_from_user, is_from_bot, is_human;

-- æŸ¥çœ‹æ´»è·ƒä¼šè¯
SELECT 
  session_id,
  user_name,
  COUNT(*) as message_count,
  MAX(timestamp) as last_activity
FROM session_messages
WHERE created_at >= NOW() - INTERVAL '24 hours'
GROUP BY session_id, user_name
ORDER BY last_activity DESC
LIMIT 20;

-- æœç´¢æ¶ˆæ¯
SELECT user_name, content, timestamp
FROM session_messages
WHERE content ILIKE '%è®¢å•%'
  AND created_at >= NOW() - INTERVAL '24 hours'
ORDER BY timestamp DESC
LIMIT 20;
```

---

**æ–‡æ¡£ç»“æŸ**

å¦‚æœ‰ç–‘é—®ï¼Œè¯·è”ç³»å¼€å‘å›¢é˜Ÿã€‚
