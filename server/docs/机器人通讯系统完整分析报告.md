# WorkTool AI ä¸­æ¢ç³»ç»Ÿ - æœºå™¨äººé€šè®¯ç³»ç»Ÿå®Œæ•´åˆ†ææŠ¥å‘Š

> **æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
> **åˆ›å»ºæ—¶é—´**: 2026-02-10  
> **ç»´æŠ¤è€…**: WorkTool AI å›¢é˜Ÿ

---

## ğŸ“‹ ç›®å½•

- [ä¸€ã€æ¦‚è¿°](#ä¸€æ¦‚è¿°)
- [äºŒã€é€šè®¯æ¶æ„](#äºŒé€šè®¯æ¶æ„)
- [ä¸‰ã€WorkTool å›è°ƒæ¥å£](#ä¸‰worktool-å›è°ƒæ¥å£)
- [å››ã€æœºå™¨äººç®¡ç†æ¥å£](#å››æœºå™¨äººç®¡ç†æ¥å£)
- [äº”ã€æœºå™¨äººæŒ‡ä»¤æ¥å£](#äº”æœºå™¨äººæŒ‡ä»¤æ¥å£)
- [å…­ã€æ¶ˆæ¯å‘é€æ¥å£](#å…­æ¶ˆæ¯å‘é€æ¥å£)
- [ä¸ƒã€æœºå™¨äººçŠ¶æ€ç›‘æ§æ¥å£](#ä¸ƒæœºå™¨äººçŠ¶æ€ç›‘æ§æ¥å£)
- [å…«ã€ååŒé€šè®¯æ¥å£](#å…«ååŒé€šè®¯æ¥å£)
- [ä¹ã€AI æœåŠ¡æ¥å£](#ä¹ai-æœåŠ¡æ¥å£)
- [åã€é€šè®¯æµç¨‹](#åé€šè®¯æµç¨‹)
- [åä¸€ã€æ•°æ®æ ¼å¼](#åä¸€æ•°æ®æ ¼å¼)
- [åäºŒã€å®‰å…¨æœºåˆ¶](#åäºŒå®‰å…¨æœºåˆ¶)
- [åä¸‰ã€é”™è¯¯å¤„ç†](#åä¸‰é”™è¯¯å¤„ç†)
- [åå››ã€æ€§èƒ½ä¼˜åŒ–](#åå››æ€§èƒ½ä¼˜åŒ–)
- [åäº”ã€æ•…éšœæ’æŸ¥](#åäº”æ•…éšœæ’æŸ¥)

---

## ä¸€ã€æ¦‚è¿°

### 1.1 ç³»ç»Ÿå®šä½

WorkTool AI ä¸­æ¢ç³»ç»Ÿé€šè¿‡å¤šç§æ¥å£ä¸ä¼ä¸šå¾®ä¿¡æœºå™¨äººè¿›è¡Œé€šè®¯ï¼Œå®ç°ï¼š
- **æ¶ˆæ¯æ¥æ”¶**ï¼šæ¥æ”¶ä¼ä¸šå¾®ä¿¡çš„ç”¨æˆ·æ¶ˆæ¯
- **æ¶ˆæ¯å‘é€**ï¼šå‘ä¼ä¸šå¾®ä¿¡ç”¨æˆ·å‘é€æ¶ˆæ¯
- **æŒ‡ä»¤ç®¡ç†**ï¼šç®¡ç†æœºå™¨äººæŒ‡ä»¤é˜Ÿåˆ—
- **çŠ¶æ€ç›‘æ§**ï¼šç›‘æ§æœºå™¨äººåœ¨çº¿çŠ¶æ€
- **ååŒå†³ç­–**ï¼šå¤šæœºå™¨äººååŒå’Œäººå·¥ä»‹å…¥

### 1.2 é€šè®¯æ–¹å¼

| é€šè®¯æ–¹å¼ | è¯´æ˜ | åè®® |
|---------|------|------|
| **Webhook å›è°ƒ** | ä¼ä¸šå¾®ä¿¡æ¨é€æ¶ˆæ¯åˆ°ç³»ç»Ÿ | HTTP POST |
| **API è°ƒç”¨** | ç³»ç»Ÿè°ƒç”¨ä¼ä¸šå¾®ä¿¡ API | HTTP POST/GET |
| **æŒ‡ä»¤é˜Ÿåˆ—** | å¼‚æ­¥æŒ‡ä»¤å¤„ç†æœºåˆ¶ | æ•°æ®åº“é˜Ÿåˆ— |
| **WebSocket** | å®æ—¶åŒå‘é€šè®¯ï¼ˆå¾…å®ç°ï¼‰ | WebSocket |

### 1.3 æ ¸å¿ƒæ¥å£æ¸…å•

| æ¥å£ç±»å‹ | è·¯å¾„ | ç”¨é€” | çŠ¶æ€ |
|---------|------|------|------|
| WorkTool å›è°ƒ | `/api/worktool/callback/*` | æ¥æ”¶ä¼ä¸šå¾®ä¿¡æ¨é€ | âœ… å·²å®ç° |
| æœºå™¨äººç®¡ç† | `/api/worktool/robot/*` | æœºå™¨äººä¿¡æ¯ç®¡ç† | âœ… å·²å®ç° |
| æœºå™¨äººæŒ‡ä»¤ | `/api/admin/robot-commands/*` | æŒ‡ä»¤é˜Ÿåˆ—ç®¡ç† | âœ… å·²å®ç° |
| æ¶ˆæ¯å‘é€ | `/api/worktool/robot/send-message` | å‘é€æ¶ˆæ¯åˆ°ä¼ä¸šå¾®ä¿¡ | âœ… å·²å®ç° |
| çŠ¶æ€ç›‘æ§ | `/api/worktool/robot/online-status` | æœºå™¨äººåœ¨çº¿çŠ¶æ€ | âœ… å·²å®ç° |
| ååŒå†³ç­– | `/api/collab/*` | ååŒå†³ç­–æœåŠ¡ | âš ï¸ éƒ¨åˆ†å®ç° |
| AI æœåŠ¡ | `/api/ai/*` | AI æ¨¡å‹è°ƒç”¨ | âœ… å·²å®ç° |

---

## äºŒã€é€šè®¯æ¶æ„

### 2.1 æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æœºå™¨äººé€šè®¯ç³»ç»Ÿæ¶æ„                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  ä¼ä¸šå¾®ä¿¡å¹³å° â”‚     â”‚ WorkTool å¹³å°â”‚     â”‚  AI æœåŠ¡å¹³å°  â”‚    â”‚
â”‚  â”‚              â”‚     â”‚              â”‚     â”‚              â”‚    â”‚
â”‚  â”‚ â€¢ ç¾¤æ¶ˆæ¯     â”‚â—€â”€â”€â”€â–¶â”‚ â€¢ å›è°ƒæ¥å£   â”‚â—€â”€â”€â”€â–¶â”‚ â€¢ è±†åŒ…       â”‚    â”‚
â”‚  â”‚ â€¢ ç§èŠæ¶ˆæ¯   â”‚     â”‚ â€¢ API æ¥å£   â”‚     â”‚ â€¢ DeepSeek   â”‚    â”‚
â”‚  â”‚ â€¢ æœºå™¨äººçŠ¶æ€ â”‚     â”‚ â€¢ æŒ‡ä»¤ç®¡ç†   â”‚     â”‚ â€¢ Kimi       â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚         â”‚                    â”‚                                 â”‚
â”‚         â”‚ HTTP               â”‚                                 â”‚
â”‚         â”‚                    â”‚                                 â”‚
â”‚         â–¼                    â–¼                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              WorkTool AI ä¸­æ¢ç³»ç»Ÿï¼ˆNode.jsï¼‰             â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚                                                         â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚ å›è°ƒæ¥æ”¶å±‚   â”‚  â”‚ æ¶ˆæ¯å¤„ç†å±‚   â”‚  â”‚ æŒ‡ä»¤é˜Ÿåˆ—å±‚   â”‚  â”‚   â”‚
â”‚  â”‚  â”‚              â”‚  â”‚              â”‚  â”‚              â”‚  â”‚   â”‚
â”‚  â”‚  â”‚ â€¢ ç­¾åæ ¡éªŒ   â”‚  â”‚ â€¢ å·¥ä½œäººå‘˜   â”‚  â”‚ â€¢ æŒ‡ä»¤åˆ›å»º   â”‚  â”‚   â”‚
â”‚  â”‚  â”‚ â€¢ å¹‚ç­‰å¤„ç†   â”‚  â”‚   è¯†åˆ«       â”‚  â”‚ â€¢ æŒ‡ä»¤æ‰§è¡Œ   â”‚  â”‚   â”‚
â”‚  â”‚  â”‚ â€¢ æ ¼å¼åŒ–     â”‚  â”‚ â€¢ ååŒå†³ç­–   â”‚  â”‚ â€¢ é‡è¯•æœºåˆ¶   â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â”‚                                                         â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚ API è°ƒç”¨å±‚   â”‚  â”‚ çŠ¶æ€ç›‘æ§å±‚   â”‚  â”‚ å®‰å…¨é˜²æŠ¤å±‚   â”‚  â”‚   â”‚
â”‚  â”‚  â”‚              â”‚  â”‚              â”‚  â”‚              â”‚  â”‚   â”‚
â”‚  â”‚  â”‚ â€¢ æ¶ˆæ¯å‘é€   â”‚  â”‚ â€¢ åœ¨çº¿æ£€æµ‹   â”‚  â”‚ â€¢ ç†”æ–­å™¨     â”‚  â”‚   â”‚
â”‚  â”‚  â”‚ â€¢ æœºå™¨äººä¿¡æ¯ â”‚  â”‚ â€¢ æ—¥å¿—ç›‘æ§   â”‚  â”‚ â€¢ é™æµ       â”‚  â”‚   â”‚
â”‚  â”‚  â”‚ â€¢ æŒ‡ä»¤æŸ¥è¯¢   â”‚  â”‚ â€¢ ç»Ÿè®¡åˆ†æ   â”‚  â”‚ â€¢ å®¡è®¡æ—¥å¿—   â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â”‚                                                         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚           â”‚                       â”‚                            â”‚
â”‚           â–¼                       â–¼                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ PostgreSQL   â”‚     â”‚    Redis     â”‚     â”‚  Object Storeâ”‚   â”‚
â”‚  â”‚              â”‚     â”‚              â”‚     â”‚   (OSS/S3)   â”‚   â”‚
â”‚  â”‚ â€¢ ä¼šè¯æ•°æ®   â”‚     â”‚ â€¢ ç¼“å­˜       â”‚     â”‚ â€¢ æ–‡ä»¶å­˜å‚¨   â”‚   â”‚
â”‚  â”‚ â€¢ æ¶ˆæ¯è®°å½•   â”‚     â”‚ â€¢ ä¼šè¯ç»Ÿè®¡   â”‚     â”‚ â€¢ å›¾ç‰‡å­˜å‚¨   â”‚   â”‚
â”‚  â”‚ â€¢ æŒ‡ä»¤é˜Ÿåˆ—   â”‚     â”‚ â€¢ é™æµ       â”‚     â”‚              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 é€šè®¯æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æ¶ˆæ¯æ¥æ”¶ä¸å¤„ç†æµç¨‹                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç”¨æˆ·å‘é€æ¶ˆæ¯
    â”‚
    â–¼
ä¼ä¸šå¾®ä¿¡å¹³å°
    â”‚
    â–¼ (Webhook)
WorkTool å¹³å°
    â”‚
    â–¼ (HTTP POST)
/system/api/worktool/callback/message
    â”‚
    â”œâ”€â–¶ [1] ç­¾åæ ¡éªŒï¼ˆå¯é€‰ï¼‰
    â”‚
    â”œâ”€â–¶ [2] å¹‚ç­‰æ£€æŸ¥
    â”‚
    â”œâ”€â–¶ [3] æœºå™¨äººéªŒè¯
    â”‚
    â”œâ”€â–¶ [4] è®°å½•ç›‘æ§æŒ‡æ ‡
    â”‚
    â”œâ”€â–¶ [5] å¼‚æ­¥å¤„ç†æ¶ˆæ¯
    â”‚       â”‚
    â”‚       â”œâ”€â–¶ [5.1] ä¿å­˜æ¶ˆæ¯åˆ°æ•°æ®åº“
    â”‚       â”‚
    â”‚       â”œâ”€â–¶ [5.2] è¯†åˆ«å·¥ä½œäººå‘˜
    â”‚       â”‚
    â”‚       â”œâ”€â–¶ [5.3] ååŒå†³ç­–
    â”‚       â”‚
    â”‚       â”œâ”€â–¶ [5.4] æ„å›¾è¯†åˆ«ï¼ˆAIï¼‰
    â”‚       â”‚
    â”‚       â”œâ”€â–¶ [5.5] ç”Ÿæˆå›å¤
    â”‚       â”‚
    â”‚       â””â”€â–¶ [5.6] å‘é€å›å¤
    â”‚
    â””â”€â–¶ [6] è¿”å›æˆåŠŸå“åº”
```

---

## ä¸‰ã€WorkTool å›è°ƒæ¥å£

### 3.1 æ¶ˆæ¯å›è°ƒ

#### æ¥å£ä¿¡æ¯

- **è·¯å¾„**: `/api/worktool/callback/message?robotId={robotId}`
- **æ–¹æ³•**: `POST`
- **Content-Type**: `application/json`
- **æ–‡ä»¶**: `server/routes/worktool.callback.js`

#### è¯·æ±‚å‚æ•°

```typescript
interface WorkToolMessageCallback {
  // æ¶ˆæ¯å†…å®¹
  spoken: string;           // é—®é¢˜æ–‡æœ¬
  rawSpoken: string;        // åŸå§‹é—®é¢˜æ–‡æœ¬

  // å‘é€è€…ä¿¡æ¯
  receivedName: string;     // æé—®è€…åç§°
  groupName: string;        // QAæ‰€åœ¨ç¾¤å
  groupRemark: string;      // QAæ‰€åœ¨ç¾¤å¤‡æ³¨å
  roomType: number;         // æˆ¿é—´ç±»å‹ï¼ˆ1=å¤–éƒ¨ç¾¤ 2=å¤–éƒ¨è”ç³»äºº 3=å†…éƒ¨ç¾¤ 4=å†…éƒ¨è”ç³»äººï¼‰

  // æ¶ˆæ¯å±æ€§
  atMe: boolean;            // æ˜¯å¦@æœºå™¨äºº
  textType: number;         // æ¶ˆæ¯ç±»å‹ï¼ˆ0=æœªçŸ¥ 1=æ–‡æœ¬ 2=å›¾ç‰‡ 3=è¯­éŸ³ç­‰ï¼‰

  // é™„ä»¶
  fileBase64?: string;      // å›¾ç‰‡base64ï¼ˆå¯é€‰ï¼‰
}
```

#### å“åº”æ ¼å¼

```typescript
interface WorkToolCallbackResponse {
  code: number;             // 0 è¡¨ç¤ºæˆåŠŸï¼Œ-1æˆ–å…¶ä»–å€¼è¡¨ç¤ºå¤±è´¥
  message: string;          // å¯¹æœ¬æ¬¡æ¥å£è°ƒç”¨çš„ä¿¡æ¯æè¿°
  data?: any;               // è¿”å›æ•°æ®ï¼ˆå¯é€‰ï¼‰
}
```

#### å¤„ç†æµç¨‹

```javascript
// 1. æ¥æ”¶å›è°ƒè¯·æ±‚
POST /api/worktool/callback/message?robotId={robotId}

// 2. ç­¾åæ ¡éªŒï¼ˆå¯é€‰ï¼‰
if (signatureSecret) {
  verifySignature(payload, signature, secret);
}

// 3. å¹‚ç­‰æ£€æŸ¥
const isDuplicate = await idempotencyChecker.check(requestId);
if (isDuplicate) {
  return successResponse(); // è¿”å›æˆåŠŸï¼Œé¿å…é‡å¤å¤„ç†
}

// 4. æœºå™¨äººéªŒè¯
const robot = await robotService.getRobotByRobotId(robotId);
if (!robot || !robot.isActive) {
  return errorResponse(403/404, 'æœºå™¨äººä¸å­˜åœ¨æˆ–æœªå¯ç”¨');
}

// 5. è®°å½•ç›‘æ§æŒ‡æ ‡
await monitorService.recordSystemMetric('callback_received', 1, {
  type: 'message',
  robotId
});

// 6. å¼‚æ­¥å¤„ç†æ¶ˆæ¯ï¼ˆä¸é˜»å¡å“åº”ï¼‰
setTimeout(async () => {
  try {
    // 6.1 ä¿å­˜æ¶ˆæ¯åˆ°æ•°æ®åº“
    await sessionMessageService.saveUserMessage(...);

    // 6.2 å¤„ç†æ¶ˆæ¯ï¼ˆå·¥ä½œäººå‘˜è¯†åˆ«ã€ååŒå†³ç­–ã€æ„å›¾è¯†åˆ«ï¼‰
    await messageProcessingService.processMessage(...);

    // 6.3 ç”Ÿæˆå›å¤
    const reply = await aiService.generateReply(...);

    // 6.4 å‘é€å›å¤
    await worktoolService.sendTextMessage(...);

  } catch (error) {
    console.error('å¼‚æ­¥å¤„ç†æ¶ˆæ¯å¤±è´¥:', error);
  }
}, 0);

// 7. ç«‹å³è¿”å›æˆåŠŸå“åº”
return successResponse({ requestId }, 'æ¶ˆæ¯å·²æ¥æ”¶');
```

#### æ ¸å¿ƒç‰¹æ€§

- âœ… **å¼‚æ­¥å¤„ç†**ï¼šæ¶ˆæ¯å¤„ç†ä¸é˜»å¡å“åº”ï¼Œæé«˜å¹¶å‘æ€§èƒ½
- âœ… **å¹‚ç­‰ä¿è¯**ï¼šé€šè¿‡ requestId é¿å…é‡å¤å¤„ç†
- âœ… **ç­¾åéªŒè¯**ï¼šå¯é€‰çš„ç­¾åéªŒè¯æœºåˆ¶ï¼Œé˜²æ­¢ä¼ªé€ è¯·æ±‚
- âœ… **ç†”æ–­ä¿æŠ¤**ï¼šç†”æ–­å™¨æ£€æŸ¥ï¼Œé˜²æ­¢çº§è”æ•…éšœ
- âœ… **ç›‘æ§è®°å½•**ï¼šè®°å½•å›è°ƒæ¥æ”¶æ¬¡æ•°å’Œå¤„ç†æ—¶é—´
- âœ… **å®¡è®¡æ—¥å¿—**ï¼šè®°å½•æ‰€æœ‰å›è°ƒè¯·æ±‚ï¼Œä¾¿äºå®¡è®¡

#### æ—¥å¿—ç¤ºä¾‹

```javascript
===== æ¶ˆæ¯å›è°ƒè¯·æ±‚ ===== {
  requestId: 'req_1234567890',
  robotId: 'wt22phhjpt2xboerspxsote472xdnyq2',
  timestamp: '2026-02-10T12:00:00.000Z',
  headers: {
    'content-type': 'application/json',
    'x-signature': '***',
    'user-agent': 'WorkTool/1.0'
  },
  callbackData: {
    spoken: 'ä½ å¥½ï¼Œæˆ‘æƒ³å’¨è¯¢äº§å“ä»·æ ¼',
    rawSpoken: 'ä½ å¥½ï¼Œæˆ‘æƒ³å’¨è¯¢äº§å“ä»·æ ¼',
    receivedName: 'å¼ ä¸‰',
    groupName: 'å®¢æˆ·ç¾¤',
    roomType: 1,
    atMe: true,
    textType: 1,
    hasFileBase64: false
  }
}

âœ… æœºå™¨äººéªŒè¯é€šè¿‡: æ½˜è¯­æ¬£ (wt22phhjpt2xboerspxsote472xdnyq2)
âœ… ç­¾åéªŒè¯é€šè¿‡
âœ… å¼€å§‹å¼‚æ­¥å¤„ç†æ¶ˆæ¯
```

---

### 3.2 æ‰§è¡Œç»“æœå›è°ƒ

#### æ¥å£ä¿¡æ¯

- **è·¯å¾„**: `/api/worktool/callback/action-result?robotId={robotId}`
- **æ–¹æ³•**: `POST`
- **Content-Type**: `application/json`
- **æ–‡ä»¶**: `server/routes/worktool.callback.js`

#### è¯·æ±‚å‚æ•°

```typescript
interface WorkToolActionResultCallback {
  robotId: string;          // æœºå™¨äººID
  messageId?: string;       // æ¶ˆæ¯ID
  command?: number;         // æŒ‡ä»¤ç±»å‹
  result: any;              // æ‰§è¡Œç»“æœ
  success: boolean;         // æ˜¯å¦æˆåŠŸ
  error?: string;           // é”™è¯¯ä¿¡æ¯
}
```

#### å¤„ç†æµç¨‹

```javascript
// 1. æ¥æ”¶å›è°ƒè¯·æ±‚
POST /api/worktool/callback/action-result?robotId={robotId}

// 2. æŸ¥æ‰¾å¯¹åº”çš„æŒ‡ä»¤
const command = await robotCommandService.getCommandByMessageId(messageId);

// 3. æ›´æ–°æŒ‡ä»¤çŠ¶æ€
if (success) {
  await robotCommandService.updateCommandStatus(commandId, 'completed', {
    result,
    completedAt: new Date()
  });
} else {
  await robotCommandService.updateCommandStatus(commandId, 'failed', {
    error,
    failedAt: new Date()
  });
}

// 4. è¿”å›æˆåŠŸå“åº”
return successResponse();
```

---

### 3.3 ç¾¤äºŒç»´ç å›è°ƒ

#### æ¥å£ä¿¡æ¯

- **è·¯å¾„**: `/api/worktool/callback/group-qrcode?robotId={robotId}`
- **æ–¹æ³•**: `POST`
- **Content-Type**: `application/json`
- **æ–‡ä»¶**: `server/routes/worktool.callback.js`

#### è¯·æ±‚å‚æ•°

```typescript
interface WorkToolGroupQrcodeCallback {
  robotId: string;          // æœºå™¨äººID
  groupName: string;        // ç¾¤åç§°
  qrcode: string;           // äºŒç»´ç å›¾ç‰‡URL
  groupChatId: string;      // ä¼ä¸šå¾®ä¿¡ç¾¤ID
}
```

#### å¤„ç†æµç¨‹

```javascript
// 1. æ¥æ”¶å›è°ƒè¯·æ±‚
POST /api/worktool/callback/group-qrcode?robotId={robotId}

// 2. ä¿å­˜ç¾¤äºŒç»´ç ä¿¡æ¯
await db.insert(groupQrcodes).values({
  robotId,
  groupName,
  qrcode,
  groupChatId
});

// 3. è¿”å›æˆåŠŸå“åº”
return successResponse();
```

---

### 3.4 æœºå™¨äººçŠ¶æ€å›è°ƒ

#### æ¥å£ä¿¡æ¯

- **è·¯å¾„**: `/api/worktool/callback/robot-status?robotId={robotId}`
- **æ–¹æ³•**: `POST`
- **Content-Type**: `application/json`
- **æ–‡ä»¶**: `server/routes/worktool.callback.js`

#### è¯·æ±‚å‚æ•°

```typescript
interface WorkToolRobotStatusCallback {
  robotId: string;          // æœºå™¨äººID
  status: 'online' | 'offline'; // æœºå™¨äººçŠ¶æ€
  timestamp: number;        // æ—¶é—´æˆ³
}
```

#### å¤„ç†æµç¨‹

```javascript
// 1. æ¥æ”¶å›è°ƒè¯·æ±‚
POST /api/worktool/callback/robot-status?robotId={robotId}

// 2. æ›´æ–°æœºå™¨äººçŠ¶æ€
await robotService.updateRobotStatus(robotId, status);

// 3. è®°å½•çŠ¶æ€å˜åŒ–æ—¥å¿—
await db.insert(robotStatusLogs).values({
  robotId,
  status,
  timestamp: new Date(timestamp)
});

// 4. è§¦å‘å‘Šè­¦ï¼ˆå¦‚æœæœºå™¨äººæ‰çº¿ï¼‰
if (status === 'offline') {
  await alertService.triggerAlert('robot_offline', { robotId });
}

// 5. è¿”å›æˆåŠŸå“åº”
return successResponse();
```

---

## å››ã€æœºå™¨äººç®¡ç†æ¥å£

### 4.1 å‘é€æ¶ˆæ¯

#### æ¥å£ä¿¡æ¯

- **è·¯å¾„**: `/api/worktool/robot/send-message`
- **æ–¹æ³•**: `POST`
- **Content-Type**: `application/json`
- **æ–‡ä»¶**: `server/routes/worktool-robot.api.js`

#### è¯·æ±‚å‚æ•°

```typescript
interface SendMessageRequest {
  robotId: string;          // æœºå™¨äººID
  toName: string;           // æ¥æ”¶è€…åç§°ï¼ˆå¥½å‹æ˜µç§°æˆ–ç¾¤åï¼‰
  content: string;          // æ¶ˆæ¯å†…å®¹
  messageType?: number;     // æ¶ˆæ¯ç±»å‹ï¼ˆ1=æ–‡æœ¬ 2=å›¾ç‰‡ 3=è§†é¢‘ç­‰ï¼‰ï¼Œé»˜è®¤ä¸º1
}
```

#### å“åº”æ ¼å¼

```typescript
interface SendMessageResponse {
  success: boolean;         // æ˜¯å¦æˆåŠŸ
  message: string;          // æ¶ˆæ¯è¯´æ˜
  data?: any;               // è¿”å›æ•°æ®
  sendId: string;           // å‘é€ID
  processingTime: number;   // å¤„ç†æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
}
```

#### å¤„ç†æµç¨‹

```javascript
// 1. æ¥æ”¶è¯·æ±‚
POST /api/worktool/robot/send-message

// 2. éªŒè¯å‚æ•°
if (!robotId || !toName || !content) {
  return errorResponse(400, 'ç¼ºå°‘å¿…å¡«å‚æ•°');
}

// 3. è·å–æœºå™¨äººé…ç½®
const robot = await robotService.getRobotByRobotId(robotId);
if (!robot || !robot.isActive) {
  return errorResponse(403/404, 'æœºå™¨äººä¸å­˜åœ¨æˆ–æœªå¯ç”¨');
}

// 4. æ„å»ºè¯·æ±‚ä½“
const requestBody = {
  socketType: 2,
  list: [{
    type: 203,
    titleList: [toName],
    receivedContent: content
  }],
  callbackUrl: robot.resultCallbackUrl || robot.messageCallbackUrl
};

// 5. è°ƒç”¨ WorkTool API
const response = await axios.post(
  `${robot.apiBaseUrl}/wework/sendRawMessage`,
  requestBody,
  {
    params: { robotId },
    timeout: 10000
  }
);

// 6. å¤„ç†å“åº”
if (response.data.code === 0) {
  return {
    success: true,
    message: 'å‘é€æˆåŠŸ',
    data: response.data.data,
    sendId,
    processingTime
  };
} else {
  return {
    success: false,
    message: response.data.message || 'å‘é€å¤±è´¥',
    sendId,
    processingTime
  };
}
```

#### æ—¥å¿—ç¤ºä¾‹

```javascript
[WorkTool] å¼€å§‹å‘é€æ¶ˆæ¯: {
  sendId: 'send-1234567890-abc123',
  robotId: 'wt22phhjpt2xboerspxsote472xdnyq2',
  toName: 'å¼ ä¸‰',
  contentLength: 20
}

[WorkTool] æœºå™¨äººéªŒè¯é€šè¿‡: {
  sendId: 'send-1234567890-abc123',
  robotId: 'wt22phhjpt2xboerspxsote472xdnyq2',
  robotName: 'æ½˜è¯­æ¬£',
  apiBaseUrl: 'https://api.worktool.com/wework'
}

[WorkTool] API å“åº”: {
  sendId: 'send-1234567890-abc123',
  statusCode: 200,
  responseData: { code: 0, message: 'æˆåŠŸ', data: { ... } },
  processingTime: 234
}

[WorkTool] å‘é€æˆåŠŸ: {
  sendId: 'send-1234567890-abc123',
  robotId: 'wt22phhjpt2xboerspxsote472xdnyq2',
  toName: 'å¼ ä¸‰',
  processingTime: 234
}
```

---

### 4.2 è·å–æœºå™¨äººä¿¡æ¯

#### æ¥å£ä¿¡æ¯

- **è·¯å¾„**: `/api/worktool/robot/info?robotId={robotId}`
- **æ–¹æ³•**: `GET`
- **æ–‡ä»¶**: `server/routes/worktool-robot.api.js`

#### å“åº”æ ¼å¼

```typescript
interface RobotInfo {
  robotId: string;          // æœºå™¨äººID
  name: string;             // æœºå™¨äººåç§°
  nickname: string;         // æœºå™¨äººæ˜µç§°
  avatar: string;           // å¤´åƒURL
  status: 'online' | 'offline'; // åœ¨çº¿çŠ¶æ€
  company: string;          // å…¬å¸åç§°
  apiBaseUrl: string;       // APIåŸºç¡€åœ°å€
}
```

#### å¤„ç†æµç¨‹

```javascript
// 1. æ¥æ”¶è¯·æ±‚
GET /api/worktool/robot/info?robotId={robotId}

// 2. è°ƒç”¨ WorkTool API
const apiBaseUrl = await getApiBaseUrl(robotId);
const url = `${apiBaseUrl}/robot/robotInfo/get?robotId=${robotId}`;

const response = await fetch(url);
const result = await response.json();

// 3. è¿”å›æœºå™¨äººä¿¡æ¯
return successResponse(result.data, 'è·å–æœºå™¨äººä¿¡æ¯æˆåŠŸ');
```

---

### 4.3 æŸ¥è¯¢æœºå™¨äººåœ¨çº¿çŠ¶æ€

#### æ¥å£ä¿¡æ¯

- **è·¯å¾„**: `/api/worktool/robot/online-status?robotId={robotId}`
- **æ–¹æ³•**: `GET`
- **æ–‡ä»¶**: `server/routes/worktool-robot.api.js`

#### å“åº”æ ¼å¼

```typescript
interface OnlineStatusResponse {
  isOnline: boolean;        // æ˜¯å¦åœ¨çº¿
}
```

#### å¤„ç†æµç¨‹

```javascript
// 1. æ¥æ”¶è¯·æ±‚
GET /api/worktool/robot/online-status?robotId={robotId}

// 2. è°ƒç”¨ WorkTool API
const apiBaseUrl = await getApiBaseUrl(robotId);
const url = `${apiBaseUrl}/robot/robotInfo/online?robotId=${robotId}`;

const response = await fetch(url);
const result = await response.json();

// 3. è¿”å›åœ¨çº¿çŠ¶æ€
return successResponse({
  isOnline: result.data === true
}, 'æŸ¥è¯¢æœºå™¨äººåœ¨çº¿çŠ¶æ€æˆåŠŸ');
```

---

### 4.4 æŸ¥è¯¢æœºå™¨äººç™»å½•æ—¥å¿—

#### æ¥å£ä¿¡æ¯

- **è·¯å¾„**: `/api/worktool/robot/login-logs?robotId={robotId}&page={page}&pageSize={pageSize}`
- **æ–¹æ³•**: `GET`
- **æ–‡ä»¶**: `server/routes/worktool-robot.api.js`

#### å“åº”æ ¼å¼

```typescript
interface LoginLogsResponse {
  total: number;            // æ€»æ•°
  page: number;             // å½“å‰é¡µ
  pageSize: number;         // æ¯é¡µå¤§å°
  logs: LoginLog[];         // æ—¥å¿—åˆ—è¡¨
}

interface LoginLog {
  loginTime: string;        // ç™»å½•æ—¶é—´
  logoutTime: string;       // ç™»å‡ºæ—¶é—´
  duration: number;         // åœ¨çº¿æ—¶é•¿ï¼ˆç§’ï¼‰
  ip: string;               // IPåœ°å€
}
```

#### å¤„ç†æµç¨‹

```javascript
// 1. æ¥æ”¶è¯·æ±‚
GET /api/worktool/robot/login-logs?robotId={robotId}&page={page}&pageSize={pageSize}

// 2. è°ƒç”¨ WorkTool API
const logs = await worktoolApiService.getRobotLoginLogs(robotId, {
  page: parseInt(page),
  pageSize: parseInt(pageSize)
});

// 3. è¿”å›ç™»å½•æ—¥å¿—
return successResponse(logs, 'æŸ¥è¯¢ç™»å½•æ—¥å¿—æˆåŠŸ');
```

---

### 4.5 æŸ¥è¯¢æŒ‡ä»¤æ¶ˆæ¯åˆ—è¡¨

#### æ¥å£ä¿¡æ¯

- **è·¯å¾„**: `/api/worktool/robot/command-messages?robotId={robotId}&page={page}&pageSize={pageSize}`
- **æ–¹æ³•**: `GET`
- **æ–‡ä»¶**: `server/routes/worktool-robot.api.js`

#### å“åº”æ ¼å¼

```typescript
interface CommandMessagesResponse {
  total: number;            // æ€»æ•°
  page: number;             // å½“å‰é¡µ
  pageSize: number;         // æ¯é¡µå¤§å°
  messages: CommandMessage[]; // æ¶ˆæ¯åˆ—è¡¨
}

interface CommandMessage {
  messageId: string;        // æ¶ˆæ¯ID
  command: number;          // æŒ‡ä»¤ç±»å‹
  content: string;          // æ¶ˆæ¯å†…å®¹
  createTime: string;       // åˆ›å»ºæ—¶é—´
}
```

#### å¤„ç†æµç¨‹

```javascript
// 1. æ¥æ”¶è¯·æ±‚
GET /api/worktool/robot/command-messages?robotId={robotId}&page={page}&pageSize={pageSize}

// 2. è°ƒç”¨ WorkTool API
const messages = await worktoolApiService.listRawMessages(robotId, {
  page: parseInt(page),
  pageSize: parseInt(pageSize)
});

// 3. è¿”å›æŒ‡ä»¤æ¶ˆæ¯
return successResponse(messages, 'æŸ¥è¯¢æŒ‡ä»¤æ¶ˆæ¯æˆåŠŸ');
```

---

### 4.6 æŸ¥è¯¢æŒ‡ä»¤æ‰§è¡Œç»“æœ

#### æ¥å£ä¿¡æ¯

- **è·¯å¾„**: `/api/worktool/robot/command-results?robotId={robotId}&page={page}&pageSize={pageSize}`
- **æ–¹æ³•**: `GET`
- **æ–‡ä»¶**: `server/routes/worktool-robot.api.js`

#### å“åº”æ ¼å¼

```typescript
interface CommandResultsResponse {
  total: number;            // æ€»æ•°
  page: number;             // å½“å‰é¡µ
  pageSize: number;         // æ¯é¡µå¤§å°
  results: CommandResult[]; // ç»“æœåˆ—è¡¨
}

interface CommandResult {
  messageId: string;        // æ¶ˆæ¯ID
  command: number;          // æŒ‡ä»¤ç±»å‹
  result: any;              // æ‰§è¡Œç»“æœ
  success: boolean;         // æ˜¯å¦æˆåŠŸ
  error?: string;           // é”™è¯¯ä¿¡æ¯
  createTime: string;       // åˆ›å»ºæ—¶é—´
}
```

#### å¤„ç†æµç¨‹

```javascript
// 1. æ¥æ”¶è¯·æ±‚
GET /api/worktool/robot/command-results?robotId={robotId}&page={page}&pageSize={pageSize}

// 2. è°ƒç”¨ WorkTool API
const results = await worktoolApiService.getCommandResults(robotId, {
  page: parseInt(page),
  pageSize: parseInt(pageSize)
});

// 3. è¿”å›æ‰§è¡Œç»“æœ
return successResponse(results, 'æŸ¥è¯¢æŒ‡ä»¤æ‰§è¡Œç»“æœæˆåŠŸ');
```

---

## äº”ã€æœºå™¨äººæŒ‡ä»¤æ¥å£

### 5.1 åˆ›å»ºæŒ‡ä»¤

#### æ¥å£ä¿¡æ¯

- **è·¯å¾„**: `/api/admin/robot-commands`
- **æ–¹æ³•**: `POST`
- **Content-Type**: `application/json`
- **æ–‡ä»¶**: `server/routes/robot-command.api.js`

#### è¯·æ±‚å‚æ•°

```typescript
interface CreateCommandRequest {
  robotId: string;          // æœºå™¨äººID
  commandType: string;      // æŒ‡ä»¤ç±»å‹
  commandPayload: any;      // æŒ‡ä»¤æ•°æ®ï¼ˆJSONå¯¹è±¡ï¼‰
  priority?: number;        // ä¼˜å…ˆçº§ï¼ˆ1-10ï¼Œ1æœ€é«˜ï¼‰ï¼Œé»˜è®¤ä¸º5
  maxRetries?: number;      // æœ€å¤§é‡è¯•æ¬¡æ•°ï¼Œé»˜è®¤ä¸º3
}
```

#### å“åº”æ ¼å¼

```typescript
interface CreateCommandResponse {
  id: string;               // æŒ‡ä»¤ID
  robotId: string;          // æœºå™¨äººID
  commandType: string;      // æŒ‡ä»¤ç±»å‹
  commandData: any;         // æŒ‡ä»¤æ•°æ®
  priority: number;         // ä¼˜å…ˆçº§
  status: string;           // çŠ¶æ€ï¼špending, processing, completed, failed
  retryCount: number;       // é‡è¯•æ¬¡æ•°
  maxRetries: number;       // æœ€å¤§é‡è¯•æ¬¡æ•°
  createdAt: string;        // åˆ›å»ºæ—¶é—´
  updatedAt: string;        // æ›´æ–°æ—¶é—´
}
```

#### å¤„ç†æµç¨‹

```javascript
// 1. æ¥æ”¶è¯·æ±‚
POST /api/admin/robot-commands

// 2. éªŒè¯å‚æ•°
if (!robotId || !commandType || !commandPayload) {
  return errorResponse(400, 'ç¼ºå°‘å¿…å¡«å‚æ•°');
}

// 3. éªŒè¯æœºå™¨äºº
const robot = await robotService.getRobotByRobotId(robotId);
if (!robot || !robot.isActive) {
  return errorResponse(403/404, 'æœºå™¨äººä¸å­˜åœ¨æˆ–æœªå¯ç”¨');
}

// 4. ç”ŸæˆæŒ‡ä»¤ID
const commandId = uuidv4();

// 5. åˆ›å»ºæŒ‡ä»¤è®°å½•
const command = await db.insert(robotCommands).values({
  id: commandId,
  robotId,
  commandType,
  commandData: commandPayload,
  priority: priority || 5,
  status: 'pending',
  retryCount: 0,
  maxRetries: maxRetries || 3,
  createdAt: new Date(),
  updatedAt: new Date()
}).returning();

// 6. æ·»åŠ åˆ°é˜Ÿåˆ—
await robotCommandService.addToQueue({
  id: uuidv4(),
  commandId,
  robotId,
  priority: priority || 5,
  status: 'pending',
  scheduledFor: new Date()
});

// 7. è¿”å›åˆ›å»ºçš„æŒ‡ä»¤
return successResponse(command[0], 'æŒ‡ä»¤åˆ›å»ºæˆåŠŸ');
```

---

### 5.2 è·å–æŒ‡ä»¤åˆ—è¡¨

#### æ¥å£ä¿¡æ¯

- **è·¯å¾„**: `/api/admin/robot-commands?robotId={robotId}&status={status}&commandType={commandType}&limit={limit}&offset={offset}`
- **æ–¹æ³•**: `GET`
- **æ–‡ä»¶**: `server/routes/robot-command.api.js`

#### å“åº”æ ¼å¼

```typescript
interface CommandsResponse {
  code: number;
  message: string;
  data: Command[];
}

interface Command {
  id: string;               // æŒ‡ä»¤ID
  robotId: string;          // æœºå™¨äººID
  commandType: string;      // æŒ‡ä»¤ç±»å‹
  commandData: any;         // æŒ‡ä»¤æ•°æ®
  priority: number;         // ä¼˜å…ˆçº§
  status: string;           // çŠ¶æ€
  retryCount: number;       // é‡è¯•æ¬¡æ•°
  maxRetries: number;       // æœ€å¤§é‡è¯•æ¬¡æ•°
  messageId?: string;       // WorkToolè¿”å›çš„æ¶ˆæ¯ID
  result?: any;             // æ‰§è¡Œç»“æœ
  error?: string;           // é”™è¯¯ä¿¡æ¯
  createdAt: string;        // åˆ›å»ºæ—¶é—´
  updatedAt: string;        // æ›´æ–°æ—¶é—´
  completedAt?: string;     // å®Œæˆæ—¶é—´
}
```

#### å¤„ç†æµç¨‹

```javascript
// 1. æ¥æ”¶è¯·æ±‚
GET /api/admin/robot-commands

// 2. æŸ¥è¯¢æŒ‡ä»¤åˆ—è¡¨
const commands = await robotCommandService.getCommands({
  robotId,
  status,
  commandType,
  limit: parseInt(limit),
  offset: parseInt(offset)
});

// 3. è¿”å›æŒ‡ä»¤åˆ—è¡¨
return successResponse(commands, 'è·å–æŒ‡ä»¤åˆ—è¡¨æˆåŠŸ');
```

---

### 5.3 è·å–æŒ‡ä»¤è¯¦æƒ…

#### æ¥å£ä¿¡æ¯

- **è·¯å¾„**: `/api/admin/robot-commands/:id`
- **æ–¹æ³•**: `GET`
- **æ–‡ä»¶**: `server/routes/robot-command.api.js`

#### å“åº”æ ¼å¼

```typescript
interface CommandDetailResponse {
  code: number;
  message: string;
  data: Command;
}
```

#### å¤„ç†æµç¨‹

```javascript
// 1. æ¥æ”¶è¯·æ±‚
GET /api/admin/robot-commands/:id

// 2. æŸ¥è¯¢æŒ‡ä»¤è¯¦æƒ…
const command = await robotCommandService.getCommandById(id);

// 3. è¿”å›æŒ‡ä»¤è¯¦æƒ…
return successResponse(command, 'è·å–æŒ‡ä»¤è¯¦æƒ…æˆåŠŸ');
```

---

### 5.4 é‡è¯•æŒ‡ä»¤

#### æ¥å£ä¿¡æ¯

- **è·¯å¾„**: `/api/admin/robot-commands/:id/retry`
- **æ–¹æ³•**: `POST`
- **æ–‡ä»¶**: `server/routes/robot-command.api.js`

#### å“åº”æ ¼å¼

```typescript
interface RetryCommandResponse {
  code: number;
  message: string;
  data: Command;
}
```

#### å¤„ç†æµç¨‹

```javascript
// 1. æ¥æ”¶è¯·æ±‚
POST /api/admin/robot-commands/:id/retry

// 2. é‡è¯•æŒ‡ä»¤
const result = await robotCommandService.retryCommand(id);

// 3. è¿”å›é‡è¯•ç»“æœ
return successResponse(result, 'é‡è¯•æŒ‡ä»¤æˆåŠŸ');
```

---

### 5.5 è·å–é˜Ÿåˆ—ç»Ÿè®¡ä¿¡æ¯

#### æ¥å£ä¿¡æ¯

- **è·¯å¾„**: `/api/admin/robot-commands/queue/stats`
- **æ–¹æ³•**: `GET`
- **æ–‡ä»¶**: `server/routes/robot-command.api.js`

#### å“åº”æ ¼å¼

```typescript
interface QueueStatsResponse {
  code: number;
  message: string;
  data: {
    pending: number;        // å¾…å¤„ç†æ•°é‡
    processing: number;     // å¤„ç†ä¸­æ•°é‡
    completed: number;      // å·²å®Œæˆæ•°é‡
    failed: number;         // å¤±è´¥æ•°é‡
    total: number;          // æ€»æ•°
  };
}
```

#### å¤„ç†æµç¨‹

```javascript
// 1. æ¥æ”¶è¯·æ±‚
GET /api/admin/robot-commands/queue/stats

// 2. è·å–é˜Ÿåˆ—ç»Ÿè®¡
const stats = await robotCommandService.getQueueStats();

// 3. è¿”å›ç»Ÿè®¡ä¿¡æ¯
return successResponse(stats, 'è·å–é˜Ÿåˆ—ç»Ÿè®¡æˆåŠŸ');
```

---

## å…­ã€æ¶ˆæ¯å‘é€æ¥å£

### 6.1 WorkTool API å®¢æˆ·ç«¯

#### ç±»ä¿¡æ¯

- **æ–‡ä»¶**: `server/services/worktool-api.service.js`
- **ç±»å**: `WorkToolApiService`

#### æ–¹æ³•åˆ—è¡¨

| æ–¹æ³•å | è¯´æ˜ | å‚æ•° | è¿”å›å€¼ |
|--------|------|------|--------|
| `getApiBaseUrl()` | è·å– API Base URL | `robotId` | `Promise<string>` |
| `sendRawMessage()` | å‘é€æ¶ˆæ¯ | `robotId, message` | `Promise<object>` |
| `updateRobotInfo()` | æ›´æ–°æœºå™¨äººä¿¡æ¯ | `robotId, robotInfo` | `Promise<object>` |
| `getRobotInfo()` | è·å–æœºå™¨äººä¿¡æ¯ | `robotId` | `Promise<object>` |
| `isRobotOnline()` | æŸ¥è¯¢æœºå™¨äººæ˜¯å¦åœ¨çº¿ | `robotId` | `Promise<boolean>` |
| `getRobotLoginLogs()` | æŸ¥è¯¢ç™»å½•æ—¥å¿— | `robotId, options` | `Promise<object>` |
| `listRawMessages()` | æŸ¥è¯¢æŒ‡ä»¤æ¶ˆæ¯ | `robotId, options` | `Promise<object>` |
| `getCommandResults()` | æŸ¥è¯¢æ‰§è¡Œç»“æœ | `robotId, options` | `Promise<object>` |

#### æ–¹æ³•å®ç°ç¤ºä¾‹

```javascript
class WorkToolApiService {
  /**
   * è·å– WorkTool API Base URL
   */
  async getApiBaseUrl(robotId) {
    try {
      const db = await getDb();
      const robot = await db.select()
        .from(robots)
        .where(eq(robots.robotId, robotId))
        .limit(1);

      if (robot.length === 0) {
        throw new Error(`æœºå™¨äººä¸å­˜åœ¨: ${robotId}`);
      }

      const apiBaseUrl = robot[0].apiBaseUrl;

      if (!apiBaseUrl) {
        throw new Error(`æœºå™¨äºº ${robotId} æœªé…ç½® apiBaseUrl`);
      }

      // ä» apiBaseUrl æå–åŸºç¡€åœ°å€ï¼ˆç§»é™¤ /wework/ åç¼€ï¼‰
      const baseUrl = apiBaseUrl.replace(/\/wework\/?$/, '').replace(/\/$/, '');

      this.apiBaseUrl = baseUrl;
      return this.apiBaseUrl;
    } catch (error) {
      logger.error('è·å– API Base URL å¤±è´¥', { robotId, error: error.message });
      throw error;
    }
  }

  /**
   * å‘é€æ¶ˆæ¯
   */
  async sendRawMessage(robotId, message) {
    try {
      const apiBaseUrl = await this.getApiBaseUrl(robotId);
      const url = `${apiBaseUrl}/wework/sendRawMessage?robotId=${robotId}`;

      logger.info('å‘é€æ¶ˆæ¯', { robotId, toName: message.toName, messageType: message.messageType });

      const response = await fetch(url, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(message)
      });

      const result = await response.json();

      if (result.code !== 200) {
        throw new Error(`å‘é€æ¶ˆæ¯å¤±è´¥: ${result.message}`);
      }

      logger.info('å‘é€æ¶ˆæ¯æˆåŠŸ', { robotId, messageId: result.data?.messageId });
      return result;
    } catch (error) {
      logger.error('å‘é€æ¶ˆæ¯å¤±è´¥', { robotId, error: error.message });
      throw error;
    }
  }
}
```

---

### 6.2 WorkTool æœåŠ¡

#### ç±»ä¿¡æ¯

- **æ–‡ä»¶**: `server/services/worktool.service.js`
- **ç±»å**: `WorkToolService`

#### æ–¹æ³•åˆ—è¡¨

| æ–¹æ³•å | è¯´æ˜ | å‚æ•° | è¿”å›å€¼ |
|--------|------|------|--------|
| `sendTextMessage()` | å‘é€æ–‡æœ¬æ¶ˆæ¯ | `robotId, toName, content, atList` | `Promise<object>` |
| `sendImageMessage()` | å‘é€å›¾ç‰‡æ¶ˆæ¯ | `robotId, toName, imageUrl` | `Promise<object>` |
| `sendFileMessage()` | å‘é€æ–‡ä»¶æ¶ˆæ¯ | `robotId, toName, fileUrl` | `Promise<object>` |

#### æ–¹æ³•å®ç°ç¤ºä¾‹

```javascript
class WorkToolService {
  /**
   * å‘é€æ–‡æœ¬æ¶ˆæ¯
   */
  async sendTextMessage(robotId, toName, content, atList = []) {
    const sendId = `send-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
    const startTime = Date.now();

    try {
      logger.info('WorkTool', 'å¼€å§‹å‘é€æ–‡æœ¬æ¶ˆæ¯', {
        sendId,
        robotId,
        toName,
        contentLength: content.length,
        atList
      });

      // è·å–æœºå™¨äººé…ç½®
      const robot = await robotService.getRobotByRobotId(robotId);

      if (!robot || !robot.isActive) {
        throw new Error(`æœºå™¨äººä¸å­˜åœ¨æˆ–æœªå¯ç”¨: ${robotId}`);
      }

      // æ„å»ºè¯·æ±‚ä½“
      const requestBody = {
        socketType: 2,
        list: [{
          type: 203,
          titleList: [toName],
          receivedContent: content,
          ...(atList.length > 0 && { atList })
        }],
        callbackUrl: robot.resultCallbackUrl || robot.messageCallbackUrl
      };

      // è°ƒç”¨ WorkTool API
      const response = await axios.post(
        `${robot.apiBaseUrl}/wework/sendRawMessage`,
        requestBody,
        {
          params: { robotId },
          timeout: 10000
        }
      );

      const processingTime = Date.now() - startTime;

      // å¤„ç†å“åº”
      if (response.data.code === 0) {
        return {
          success: true,
          message: 'å‘é€æˆåŠŸ',
          data: response.data.data,
          sendId,
          processingTime
        };
      } else {
        return {
          success: false,
          message: response.data.message || 'å‘é€å¤±è´¥',
          sendId,
          processingTime
        };
      }
    } catch (error) {
      logger.error('WorkTool', 'å‘é€æ¶ˆæ¯å¤±è´¥', {
        sendId,
        robotId,
        error: error.message
      });
      throw error;
    }
  }
}
```

---

## ä¸ƒã€æœºå™¨äººçŠ¶æ€ç›‘æ§æ¥å£

### 7.1 çŠ¶æ€ç›‘æ§æœåŠ¡

#### ç±»ä¿¡æ¯

- **æ–‡ä»¶**: `server/services/robot-monitoring.service.js`
- **ç±»å**: `RobotMonitoringService`

#### åŠŸèƒ½è¯´æ˜

| åŠŸèƒ½ | è¯´æ˜ |
|------|------|
| åœ¨çº¿çŠ¶æ€æ£€æµ‹ | å®šæœŸæ£€æµ‹æœºå™¨äººåœ¨çº¿çŠ¶æ€ |
| çŠ¶æ€å˜åŒ–é€šçŸ¥ | çŠ¶æ€å˜åŒ–æ—¶å‘é€é€šçŸ¥ |
| çŠ¶æ€å†å²è®°å½• | è®°å½•çŠ¶æ€å˜åŒ–å†å² |
| çŠ¶æ€ç»Ÿè®¡åˆ†æ | ç»Ÿè®¡åœ¨çº¿æ—¶é•¿ã€æ‰çº¿æ¬¡æ•°ç­‰ |

#### æ–¹æ³•åˆ—è¡¨

| æ–¹æ³•å | è¯´æ˜ | å‚æ•° | è¿”å›å€¼ |
|--------|------|------|--------|
| `checkRobotStatus()` | æ£€æŸ¥æœºå™¨äººçŠ¶æ€ | `robotId` | `Promise<object>` |
| `getAllRobotStatus()` | è·å–æ‰€æœ‰æœºå™¨äººçŠ¶æ€ | - | `Promise<object>` |
| `getStatusHistory()` | è·å–çŠ¶æ€å†å² | `robotId, options` | `Promise<object>` |
| `getStatusStatistics()` | è·å–çŠ¶æ€ç»Ÿè®¡ | `robotId, options` | `Promise<object>` |

---

### 7.2 çŠ¶æ€æ£€æµ‹æµç¨‹

```javascript
/**
 * å®šæœŸæ£€æµ‹æœºå™¨äººçŠ¶æ€
 */
async checkRobotStatus(robotId) {
  try {
    // 1. è°ƒç”¨ WorkTool API æ£€æµ‹åœ¨çº¿çŠ¶æ€
    const isOnline = await worktoolApiService.isRobotOnline(robotId);

    // 2. è·å–æœºå™¨äººå½“å‰çŠ¶æ€
    const robot = await robotService.getRobotByRobotId(robotId);
    const previousStatus = robot.status;

    // 3. å¦‚æœçŠ¶æ€å‘ç”Ÿå˜åŒ–
    if (previousStatus !== (isOnline ? 'online' : 'offline')) {
      // 3.1 æ›´æ–°æœºå™¨äººçŠ¶æ€
      await robotService.updateRobotStatus(robotId, isOnline ? 'online' : 'offline');

      // 3.2 è®°å½•çŠ¶æ€å˜åŒ–å†å²
      await this.recordStatusChange(robotId, previousStatus, isOnline ? 'online' : 'offline');

      // 3.3 å‘é€é€šçŸ¥
      await this.notifyStatusChange(robotId, previousStatus, isOnline ? 'online' : 'offline');

      // 3.4 è§¦å‘å‘Šè­¦ï¼ˆå¦‚æœæœºå™¨äººæ‰çº¿ï¼‰
      if (!isOnline) {
        await alertService.triggerAlert('robot_offline', { robotId });
      }
    }

    // 4. è¿”å›çŠ¶æ€ä¿¡æ¯
    return {
      robotId,
      status: isOnline ? 'online' : 'offline',
      previousStatus,
      changed: previousStatus !== (isOnline ? 'online' : 'offline')
    };
  } catch (error) {
    console.error('æ£€æµ‹æœºå™¨äººçŠ¶æ€å¤±è´¥:', error);
    throw error;
  }
}
```

---

## å…«ã€ååŒé€šè®¯æ¥å£

### 8.1 ååŒåˆ†ææœåŠ¡

#### ç±»ä¿¡æ¯

- **æ–‡ä»¶**: `server/services/collaboration.service.js`
- **ç±»å**: `CollaborationService`

#### åŠŸèƒ½è¯´æ˜

| åŠŸèƒ½ | è¯´æ˜ |
|------|------|
| å·¥ä½œäººå‘˜è¯†åˆ« | è¯†åˆ«æ¶ˆæ¯å‘é€è€…æ˜¯å¦ä¸ºå·¥ä½œäººå‘˜ |
| å·¥ä½œäººå‘˜æ¶ˆæ¯è®°å½• | è®°å½•å·¥ä½œäººå‘˜çš„æ¶ˆæ¯å’Œæ´»åŠ¨ |
| æ´»åŠ¨è·Ÿè¸ª | è·Ÿè¸ªå·¥ä½œäººå‘˜çš„æ´»åŠ¨è½¨è¿¹ |
| ååŒå†³ç­– | å¤šæœºå™¨äººååŒå†³ç­– |

---

### 8.2 å·¥ä½œäººå‘˜è¯†åˆ«

#### ç±»ä¿¡æ¯

- **æ–‡ä»¶**: `server/services/collaboration.service.js`
- **ç±»å**: `StaffIdentifier`

#### è¯†åˆ«è§„åˆ™

```typescript
interface StaffFeatures {
  // ä¼ä¸šåç§°ç‰¹å¾
  companyNames: string[];

  // å¤‡æ³¨åç‰¹å¾
  remarkNames: string[];

  // æ˜µç§°ç‰¹å¾
  nicknames: string[];

  // ç‰¹æ®Šæ ‡è¯†
  specialIds: string[];
}
```

#### è¯†åˆ«æ–¹æ³•

```javascript
/**
 * è¯†åˆ«æ˜¯å¦ä¸ºå·¥ä½œäººå‘˜
 */
static identify(userInfo) {
  const {
    userName = '',
    groupName = '',
    remarkName = '',
    company = '',
    userId = ''
  } = userInfo;

  const reasons = [];
  let isStaff = false;
  let staffInfo = {
    staffUserId: userId,
    staffName: userName || remarkName || 'æœªçŸ¥å·¥ä½œäººå‘˜'
  };

  // 1. æ£€æŸ¥ä¼ä¸šåç§°ç‰¹å¾
  if (company && STAFF_FEATURES.companyNames.some(feature => company.includes(feature))) {
    isStaff = true;
    reasons.push(`ä¼ä¸šåç§°åŒ¹é…: ${company}`);
  }

  // 2. æ£€æŸ¥å¤‡æ³¨åç‰¹å¾
  if (remarkName && STAFF_FEATURES.remarkNames.some(feature => remarkName.includes(feature))) {
    isStaff = true;
    reasons.push(`å¤‡æ³¨ååŒ¹é…: ${remarkName}`);
  }

  // 3. æ£€æŸ¥æ˜µç§°ç‰¹å¾
  if (userName && STAFF_FEATURES.nicknames.some(feature => userName.includes(feature))) {
    isStaff = true;
    reasons.push(`æ˜µç§°åŒ¹é…: ${userName}`);
  }

  // 4. æ£€æŸ¥ç‰¹æ®Šæ ‡è¯†
  if (userId && STAFF_FEATURES.specialIds.some(feature => userId.toLowerCase().includes(feature))) {
    isStaff = true;
    reasons.push(`ç”¨æˆ·IDåŒ¹é…: ${userId}`);
  }

  return {
    isStaff,
    staffInfo,
    reasons,
    confidence: reasons.length > 0 ? 1.0 : 0.0
  };
}
```

---

### 8.3 æ¶ˆæ¯å¤„ç†æœåŠ¡

#### ç±»ä¿¡æ¯

- **æ–‡ä»¶**: `server/services/message-processing.service.js`
- **ç±»å**: `MessageProcessingService`

#### å¤„ç†æµç¨‹

```javascript
/**
 * å¤„ç†æ¶ˆæ¯ï¼ˆä¸»å…¥å£ï¼‰
 */
async processMessage(context, message, robot) {
  try {
    // 1. è¯†åˆ«å·¥ä½œäººå‘˜
    const staffInfo = await staffIdentifierService.identifyStaff(context, message, robot);

    // 2. å¦‚æœæ˜¯å·¥ä½œäººå‘˜æ¶ˆæ¯
    if (staffInfo.isStaff) {
      return await this.handleStaffMessage(context, message, staffInfo, robot);
    }

    // 3. éå·¥ä½œäººå‘˜æ¶ˆæ¯ï¼Œè¿›è¡ŒååŒå†³ç­–
    return await this.handleUserMessage(context, message, robot);
  } catch (error) {
    console.error('å¤„ç†æ¶ˆæ¯å¤±è´¥:', error);
    throw error;
  }
}

/**
 * å¤„ç†å·¥ä½œäººå‘˜æ¶ˆæ¯
 */
async handleStaffMessage(context, message, staffInfo, robot) {
  // 1. è®°å½•å·¥ä½œäººå‘˜æ¶ˆæ¯
  await this.recordStaffMessage(context, message, staffInfo);

  // 2. è®°å½•å·¥ä½œäººå‘˜æ´»åŠ¨
  await staffTrackerService.updateActivity(...);

  // 3. æ›´æ–°ä¼šè¯çŠ¶æ€
  await staffTrackerService.updateSessionStaffStatus(...);

  // 4. æ£€æŸ¥å·¥ä½œäººå‘˜æŒ‡ä»¤
  const commandInfo = await staffCommandService.detectCommand(message);
  if (commandInfo) {
    const commandResult = await staffCommandService.executeCommand(...);
    return {
      success: true,
      type: 'staff_command',
      shouldTriggerAI: false
    };
  }

  // 5. æ™®é€šå·¥ä½œäººå‘˜æ¶ˆæ¯ï¼Œä¸è§¦å‘AIå›å¤
  return {
    success: true,
    type: 'staff_message',
    shouldTriggerAI: false
  };
}

/**
 * å¤„ç†éå·¥ä½œäººå‘˜æ¶ˆæ¯
 */
async handleUserMessage(context, message, robot) {
  // 1. æ£€æŸ¥ååŒåŠŸèƒ½æ˜¯å¦å¯ç”¨
  if (!robot.enableCollaboration) {
    return {
      success: true,
      shouldTriggerAI: true
    };
  }

  // 2. è¿›è¡ŒååŒå†³ç­–
  const decision = await collabDecisionService.makeDecision(context, robot);

  // 3. è¿”å›å¤„ç†ç»“æœ
  return {
    success: true,
    shouldTriggerAI: decision.shouldAIReply,
    decision
  };
}
```

---

## ä¹ã€AI æœåŠ¡æ¥å£

### 9.1 AI æœåŠ¡

#### ç±»ä¿¡æ¯

- **æ–‡ä»¶**: `server/services/ai.service.js`
- **ç±»å**: `AIService`

#### æ”¯æŒçš„ AI æ¨¡å‹

| æ¨¡å‹ | æœåŠ¡ç±» | è¯´æ˜ |
|------|--------|------|
| è±†åŒ… | `DoubaoService` | å­—èŠ‚è·³åŠ¨çš„ AI æ¨¡å‹ |
| DeepSeek | `DeepSeekService` | DeepSeek çš„ AI æ¨¡å‹ |
| Kimi | `KimiService` | æœˆä¹‹æš—é¢çš„ AI æ¨¡å‹ |

#### æ–¹æ³•åˆ—è¡¨

| æ–¹æ³•å | è¯´æ˜ | å‚æ•° | è¿”å›å€¼ |
|--------|------|------|--------|
| `generateReply()` | ç”Ÿæˆå›å¤ | `context, message, robot` | `Promise<string>` |
| `identifyIntent()` | è¯†åˆ«æ„å›¾ | `message, robot` | `Promise<object>` |
| `detectRisk()` | æ£€æµ‹é£é™© | `message, robot` | `Promise<object>` |

---

### 9.2 AI æœåŠ¡å·¥å‚

#### ç±»ä¿¡æ¯

- **æ–‡ä»¶**: `server/services/ai/AIServiceFactory.js`
- **ç±»å**: `AIServiceFactory`

#### å·¥å‚æ–¹æ³•

```javascript
/**
 * åˆ›å»º AI æœåŠ¡å®ä¾‹
 */
static createService(modelType) {
  switch (modelType) {
    case 'doubao':
      return new DoubaoService();
    case 'deepseek':
      return new DeepSeekService();
    case 'kimi':
      return new KimiService();
    default:
      throw new Error(`ä¸æ”¯æŒçš„ AI æ¨¡å‹ç±»å‹: ${modelType}`);
  }
}
```

---

## åã€é€šè®¯æµç¨‹

### 10.1 æ¶ˆæ¯æ¥æ”¶å®Œæ•´æµç¨‹

```
ç”¨æˆ·å‘é€æ¶ˆæ¯
    â”‚
    â–¼
ä¼ä¸šå¾®ä¿¡å¹³å°
    â”‚
    â–¼ (Webhook)
WorkTool å¹³å°
    â”‚
    â–¼ (HTTP POST)
/system/api/worktool/callback/message?robotId={robotId}
    â”‚
    â”œâ”€â–¶ [1] æ¥æ”¶è¯·æ±‚
    â”‚       â”œâ”€ è¯»å–è¯·æ±‚ä½“
    â”‚       â”œâ”€ éªŒè¯ Content-Type
    â”‚       â””â”€ æå–å‚æ•°
    â”‚
    â”œâ”€â–¶ [2] ç­¾åæ ¡éªŒï¼ˆå¯é€‰ï¼‰
    â”‚       â”œâ”€ æ£€æŸ¥ X-Signature å¤´
    â”‚       â”œâ”€ è®¡ç®—ç­¾å
    â”‚       â””â”€ å¯¹æ¯”ç­¾å
    â”‚
    â”œâ”€â–¶ [3] å¹‚ç­‰æ£€æŸ¥
    â”‚       â”œâ”€ ç”Ÿæˆ requestId
    â”‚       â”œâ”€ æŸ¥è¯¢ç¼“å­˜
    â”‚       â””â”€ åˆ¤æ–­æ˜¯å¦é‡å¤
    â”‚
    â”œâ”€â–¶ [4] æœºå™¨äººéªŒè¯
    â”‚       â”œâ”€ æŸ¥è¯¢æœºå™¨äººä¿¡æ¯
    â”‚       â”œâ”€ æ£€æŸ¥æœºå™¨äººæ˜¯å¦å­˜åœ¨
    â”‚       â””â”€ æ£€æŸ¥æœºå™¨äººæ˜¯å¦å¯ç”¨
    â”‚
    â”œâ”€â–¶ [5] è®°å½•ç›‘æ§æŒ‡æ ‡
    â”‚       â”œâ”€ å›è°ƒæ¥æ”¶æ•° +1
    â”‚       â”œâ”€ è®°å½•æ—¶é—´æˆ³
    â”‚       â””â”€ è®°å½•æœºå™¨äººID
    â”‚
    â”œâ”€â–¶ [6] ç«‹å³è¿”å›å“åº”ï¼ˆå¼‚æ­¥å¤„ç†ï¼‰
    â”‚       â””â”€ è¿”å› successResponse
    â”‚
    â””â”€â–¶ [7] å¼‚æ­¥å¤„ç†æ¶ˆæ¯ï¼ˆåå°ï¼‰
            â”‚
            â”œâ”€â–¶ [7.1] ä¿å­˜æ¶ˆæ¯åˆ°æ•°æ®åº“
            â”‚       â”œâ”€ æ’å…¥ session_messages è¡¨
            â”‚       â”œâ”€ è®°å½•æ¶ˆæ¯ç±»å‹
            â”‚       â””â”€ è®°å½•å‘é€è€…ä¿¡æ¯
            â”‚
            â”œâ”€â–¶ [7.2] è¯†åˆ«å·¥ä½œäººå‘˜
            â”‚       â”œâ”€ æ£€æŸ¥ç”¨æˆ·ç‰¹å¾
            â”‚       â”œâ”€ åˆ¤æ–­æ˜¯å¦ä¸ºå·¥ä½œäººå‘˜
            â”‚       â””â”€ è¿”å›è¯†åˆ«ç»“æœ
            â”‚
            â”œâ”€â–¶ [7.3] ååŒå†³ç­–
            â”‚       â”œâ”€ æ£€æŸ¥ååŒåŠŸèƒ½æ˜¯å¦å¯ç”¨
            â”‚       â”œâ”€ è¿›è¡Œå†³ç­–è®¡ç®—
            â”‚       â””â”€ è¿”å›å†³ç­–ç»“æœ
            â”‚
            â”œâ”€â–¶ [7.4] æ„å›¾è¯†åˆ«ï¼ˆAIï¼‰
            â”‚       â”œâ”€ è°ƒç”¨ AI æœåŠ¡
            â”‚       â”œâ”€ è¯†åˆ«æ„å›¾ç±»å‹
            â”‚       â””â”€ è¿”å›è¯†åˆ«ç»“æœ
            â”‚
            â”œâ”€â–¶ [7.5] ç”Ÿæˆå›å¤
            â”‚       â”œâ”€ æ ¹æ®æ„å›¾ç”Ÿæˆå›å¤
            â”‚       â”œâ”€ é€‰æ‹©å›å¤ç­–ç•¥
            â”‚       â””â”€ è¿”å›å›å¤å†…å®¹
            â”‚
            â””â”€â–¶ [7.6] å‘é€å›å¤
                    â”œâ”€ è°ƒç”¨ WorkTool API
                    â”œâ”€ å‘é€æ¶ˆæ¯åˆ°ä¼ä¸šå¾®ä¿¡
                    â””â”€ è®°å½•å‘é€ç»“æœ
```

---

### 10.2 æ¶ˆæ¯å‘é€å®Œæ•´æµç¨‹

```
ç³»ç»Ÿå‘é€æ¶ˆæ¯
    â”‚
    â–¼
åˆ›å»ºæŒ‡ä»¤
    â”‚
    â”œâ”€â–¶ [1] éªŒè¯å‚æ•°
    â”‚       â”œâ”€ éªŒè¯ robotId
    â”‚       â”œâ”€ éªŒè¯ toName
    â”‚       â””â”€ éªŒè¯ content
    â”‚
    â”œâ”€â–¶ [2] æœºå™¨äººéªŒè¯
    â”‚       â”œâ”€ æŸ¥è¯¢æœºå™¨äººä¿¡æ¯
    â”‚       â”œâ”€ æ£€æŸ¥æœºå™¨äººæ˜¯å¦å­˜åœ¨
    â”‚       â””â”€ æ£€æŸ¥æœºå™¨äººæ˜¯å¦å¯ç”¨
    â”‚
    â”œâ”€â–¶ [3] åˆ›å»ºæŒ‡ä»¤è®°å½•
    â”‚       â”œâ”€ ç”ŸæˆæŒ‡ä»¤ID
    â”‚       â”œâ”€ æ’å…¥ robot_commands è¡¨
    â”‚       â””â”€ è®°å½•æŒ‡ä»¤çŠ¶æ€
    â”‚
    â”œâ”€â–¶ [4] æ·»åŠ åˆ°é˜Ÿåˆ—
    â”‚       â”œâ”€ æ’å…¥ robot_command_queue è¡¨
    â”‚       â””â”€ è®°å½•ä¼˜å…ˆçº§
    â”‚
    â””â”€â–¶ [5] è¿”å›åˆ›å»ºç»“æœ
            â””â”€ è¿”å›æŒ‡ä»¤IDå’ŒçŠ¶æ€

é˜Ÿåˆ—å¤„ç†
    â”‚
    â”œâ”€â–¶ [1] è·å–å¾…å¤„ç†æŒ‡ä»¤
    â”‚       â”œâ”€ æŸ¥è¯¢é˜Ÿåˆ—
    â”‚       â”œâ”€ æŒ‰ä¼˜å…ˆçº§æ’åº
    â”‚       â””â”€ è·å–æŒ‡ä»¤
    â”‚
    â”œâ”€â–¶ [2] æ›´æ–°æŒ‡ä»¤çŠ¶æ€
    â”‚       â”œâ”€ æ›´æ–°ä¸º processing
    â”‚       â””â”€ è®°å½•å¤„ç†æ—¶é—´
    â”‚
    â”œâ”€â–¶ [3] æ„å»º WorkTool è¯·æ±‚
    â”‚       â”œâ”€ æ„å»º requestBody
    â”‚       â”œâ”€ è®¾ç½® callbackUrl
    â”‚       â””â”€ è®¾ç½®è¶…æ—¶æ—¶é—´
    â”‚
    â”œâ”€â–¶ [4] è°ƒç”¨ WorkTool API
    â”‚       â”œâ”€ å‘é€ POST è¯·æ±‚
    â”‚       â”œâ”€ ç­‰å¾…å“åº”
    â”‚       â””â”€ è®°å½•å“åº”æ—¶é—´
    â”‚
    â”œâ”€â–¶ [5] å¤„ç†å“åº”
    â”‚       â”œâ”€ æ£€æŸ¥å“åº”çŠ¶æ€
    â”‚       â”œâ”€ è§£æå“åº”æ•°æ®
    â”‚       â””â”€ è®°å½•å‘é€ç»“æœ
    â”‚
    â”œâ”€â–¶ [6] æ›´æ–°æŒ‡ä»¤çŠ¶æ€
    â”‚       â”œâ”€ æˆåŠŸï¼šæ›´æ–°ä¸º completed
    â”‚       â”œâ”€ å¤±è´¥ï¼šæ›´æ–°ä¸º failed
    â”‚       â””â”€ è®°å½•å®Œæˆæ—¶é—´
    â”‚
    â””â”€â–¶ [7] é”™è¯¯å¤„ç†
            â”œâ”€ åˆ¤æ–­æ˜¯å¦éœ€è¦é‡è¯•
            â”œâ”€ å¢åŠ é‡è¯•æ¬¡æ•°
            â”œâ”€ é‡æ–°åŠ å…¥é˜Ÿåˆ—
            â””â”€ è¶…è¿‡æœ€å¤§é‡è¯•æ¬¡æ•°åˆ™åœæ­¢
```

---

## åä¸€ã€æ•°æ®æ ¼å¼

### 11.1 è¯·æ±‚æ ¼å¼

#### WorkTool å›è°ƒè¯·æ±‚

```json
{
  "spoken": "ä½ å¥½ï¼Œæˆ‘æƒ³å’¨è¯¢äº§å“ä»·æ ¼",
  "rawSpoken": "ä½ å¥½ï¼Œæˆ‘æƒ³å’¨è¯¢äº§å“ä»·æ ¼",
  "receivedName": "å¼ ä¸‰",
  "groupName": "å®¢æˆ·ç¾¤",
  "groupRemark": "",
  "roomType": 1,
  "atMe": true,
  "textType": 1,
  "fileBase64": ""
}
```

#### å‘é€æ¶ˆæ¯è¯·æ±‚

```json
{
  "socketType": 2,
  "list": [
    {
      "type": 203,
      "titleList": ["å¼ ä¸‰"],
      "receivedContent": "æ‚¨å¥½ï¼æˆ‘ä»¬çš„äº§å“ä»·æ ¼å¦‚ä¸‹ï¼šæ ‡å‡†ç‰ˆ 999 å…ƒ/å¹´ï¼Œä¸“ä¸šç‰ˆ 1999 å…ƒ/å¹´"
    }
  ],
  "callbackUrl": "https://your-domain.com/api/worktool/callback/action-result"
}
```

---

### 11.2 å“åº”æ ¼å¼

#### WorkTool æ ‡å‡†å“åº”

```json
{
  "code": 0,
  "message": "success",
  "data": {}
}
```

#### é”™è¯¯å“åº”

```json
{
  "code": -1,
  "message": "é”™è¯¯ä¿¡æ¯",
  "data": null
}
```

---

### 11.3 æ•°æ®åº“æ ¼å¼

#### æœºå™¨äººè¡¨ï¼ˆrobotsï¼‰

```sql
CREATE TABLE robots (
  id VARCHAR(36) PRIMARY KEY DEFAULT gen_random_uuid(),
  robot_id VARCHAR(64) NOT NULL UNIQUE,
  name VARCHAR(255) NOT NULL,
  nickname VARCHAR(255),
  status VARCHAR(20) DEFAULT 'offline',
  is_active BOOLEAN DEFAULT true,
  api_base_url VARCHAR(500),
  company VARCHAR(255),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

#### æŒ‡ä»¤è¡¨ï¼ˆrobot_commandsï¼‰

```sql
CREATE TABLE robot_commands (
  id VARCHAR(36) PRIMARY KEY DEFAULT gen_random_uuid(),
  robot_id VARCHAR(64) NOT NULL,
  command_type VARCHAR(50) NOT NULL,
  command_data JSONB NOT NULL,
  priority INTEGER DEFAULT 5,
  status VARCHAR(20) DEFAULT 'pending',
  retry_count INTEGER DEFAULT 0,
  max_retries INTEGER DEFAULT 3,
  message_id VARCHAR(64),
  result JSONB,
  error TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  completed_at TIMESTAMP WITH TIME ZONE
);
```

#### æŒ‡ä»¤é˜Ÿåˆ—è¡¨ï¼ˆrobot_command_queueï¼‰

```sql
CREATE TABLE robot_command_queue (
  id VARCHAR(36) PRIMARY KEY DEFAULT gen_random_uuid(),
  command_id VARCHAR(36) NOT NULL,
  robot_id VARCHAR(64) NOT NULL,
  priority INTEGER DEFAULT 5,
  status VARCHAR(20) DEFAULT 'pending',
  scheduled_for TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  processing_started_at TIMESTAMP WITH TIME ZONE,
  completed_at TIMESTAMP WITH TIME ZONE
);
```

---

## åäºŒã€å®‰å…¨æœºåˆ¶

### 12.1 ç­¾åæ ¡éªŒ

#### å®ç°ä½ç½®

- **æ–‡ä»¶**: `server/lib/utils.js`
- **å‡½æ•°**: `verifySignature()`

#### éªŒè¯æµç¨‹

```javascript
/**
 * éªŒè¯ç­¾å
 */
function verifySignature(payload, signature, secret) {
  if (!signature) {
    return false;
  }

  // è®¡ç®—ç­¾å
  const crypto = require('crypto');
  const hmac = crypto.createHmac('sha256', secret);
  const calculatedSignature = hmac.update(JSON.stringify(payload)).digest('hex');

  // å¯¹æ¯”ç­¾å
  return signature === calculatedSignature;
}
```

#### ä½¿ç”¨æ–¹å¼

```javascript
// åœ¨å›è°ƒæ¥å£ä¸­ä½¿ç”¨
const signature = request.headers['x-signature'];
const secret = config.get('callback.signatureSecret');

if (secret && !verifySignature(callbackData, signature, secret)) {
  return reply.status(403).send(errorResponse(403, 'ç­¾åéªŒè¯å¤±è´¥'));
}
```

---

### 12.2 å¹‚ç­‰å¤„ç†

#### å®ç°ä½ç½®

- **æ–‡ä»¶**: `server/lib/utils.js`
- **ç±»**: `IdempotencyChecker`

#### å®ç°åŸç†

```javascript
class IdempotencyChecker {
  constructor(redis) {
    this.redis = redis;
    this.ttl = 600; // 10åˆ†é’Ÿè¿‡æœŸ
  }

  /**
   * æ£€æŸ¥æ˜¯å¦ä¸ºé‡å¤è¯·æ±‚
   */
  async check(requestId) {
    const key = `idempotency:${requestId}`;
    const exists = await this.redis.exists(key);

    if (exists) {
      return true; // é‡å¤è¯·æ±‚
    }

    // æ ‡è®°ä¸ºå·²å¤„ç†
    await this.redis.setex(key, this.ttl, '1');
    return false; // é¦–æ¬¡è¯·æ±‚
  }
}
```

---

### 12.3 ç†”æ–­å™¨

#### å®ç°ä½ç½®

- **æ–‡ä»¶**: `server/services/alert.service.js`
- **æ–¹æ³•**: `isCircuitBreakerOpen()`

#### ç†”æ–­è§„åˆ™

| æ¡ä»¶ | è¯´æ˜ |
|------|------|
| é”™è¯¯ç‡è¶…è¿‡é˜ˆå€¼ | é”™è¯¯ç‡è¶…è¿‡ 10% æ—¶è§¦å‘ |
| è¿ç»­å¤±è´¥æ¬¡æ•° | è¿ç»­å¤±è´¥ 5 æ¬¡æ—¶è§¦å‘ |
| æ‰‹åŠ¨ç†”æ–­ | ç®¡ç†å‘˜æ‰‹åŠ¨è§¦å‘ |

#### å®ç°åŸç†

```javascript
/**
 * æ£€æŸ¥ç†”æ–­å™¨æ˜¯å¦æ‰“å¼€
 */
async isCircuitBreakerOpen() {
  const key = 'circuit_breaker:status';
  const isOpen = await this.redis.get(key);

  return isOpen === '1';
}

/**
 * æ‰“å¼€ç†”æ–­å™¨
 */
async openCircuitBreaker() {
  const key = 'circuit_breaker:status';
  await this.redis.setex(key, 300, '1'); // 5åˆ†é’Ÿåè‡ªåŠ¨å…³é—­
}

/**
 * å…³é—­ç†”æ–­å™¨
 */
async closeCircuitBreaker() {
  const key = 'circuit_breaker:status';
  await this.redis.del(key);
}
```

---

### 12.4 é™æµ

#### å®ç°ä½ç½®

- **æ–‡ä»¶**: `server/services/alert-rate-limiter.service.js`
- **ç±»**: `AlertRateLimiter`

#### é™æµè§„åˆ™

| ç»´åº¦ | é™åˆ¶ |
|------|------|
| æ¯ä¸ªæœºå™¨äººæ¯åˆ†é’Ÿ | 100 æ¬¡è¯·æ±‚ |
| æ¯ä¸ªç”¨æˆ·æ¯åˆ†é’Ÿ | 20 æ¬¡è¯·æ±‚ |
| å…¨å±€æ¯ç§’ | 1000 æ¬¡è¯·æ±‚ |

---

## åä¸‰ã€é”™è¯¯å¤„ç†

### 13.1 é”™è¯¯ç±»å‹

| é”™è¯¯ç±»å‹ | HTTP çŠ¶æ€ç  | è¯´æ˜ |
|---------|-----------|------|
| å‚æ•°é”™è¯¯ | 400 | ç¼ºå°‘å¿…å¡«å‚æ•° |
| è®¤è¯å¤±è´¥ | 401 | ç­¾åéªŒè¯å¤±è´¥ |
| æƒé™ä¸è¶³ | 403 | æœºå™¨äººæœªå¯ç”¨ |
| èµ„æºä¸å­˜åœ¨ | 404 | æœºå™¨äººä¸å­˜åœ¨ |
| æœåŠ¡ä¸å¯ç”¨ | 503 | ç†”æ–­å™¨æ‰“å¼€ |
| æœåŠ¡å™¨é”™è¯¯ | 500 | æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ |

### 13.2 é”™è¯¯å“åº”æ ¼å¼

```json
{
  "code": -1,
  "message": "é”™è¯¯æè¿°",
  "data": {
    "errorType": "ErrorType",
    "errorMessage": "è¯¦ç»†é”™è¯¯ä¿¡æ¯",
    "timestamp": "2026-02-10T12:00:00.000Z"
  }
}
```

### 13.3 é”™è¯¯å¤„ç†æµç¨‹

```javascript
try {
  // ä¸šåŠ¡é€»è¾‘
  const result = await doSomething();
  return successResponse(result);
} catch (error) {
  console.error('å¤„ç†å¤±è´¥:', error);

  // è®°å½•é”™è¯¯æ—¥å¿—
  logger.error('API', 'å¤„ç†å¤±è´¥', {
    error: error.message,
    stack: error.stack
  });

  // è¿”å›é”™è¯¯å“åº”
  return reply.status(500).send(errorResponse(500, error.message));
}
```

---

## åå››ã€æ€§èƒ½ä¼˜åŒ–

### 14.1 å¼‚æ­¥å¤„ç†

**ä¼˜åŒ–ç‚¹**: æ¶ˆæ¯å¤„ç†ä¸é˜»å¡å“åº”

**å®ç°**:

```javascript
// ç«‹å³è¿”å›å“åº”
setTimeout(async () => {
  try {
    // å¼‚æ­¥å¤„ç†æ¶ˆæ¯
    await processMessageAsync(context, message, robot);
  } catch (error) {
    console.error('å¼‚æ­¥å¤„ç†å¤±è´¥:', error);
  }
}, 0);

return successResponse({ requestId }, 'æ¶ˆæ¯å·²æ¥æ”¶');
```

**æ•ˆæœ**: 
- å“åº”æ—¶é—´ä» ~200ms é™ä½åˆ° ~20ms
- å¹¶å‘å¤„ç†èƒ½åŠ›æå‡ 10 å€

---

### 14.2 ç¼“å­˜ä¼˜åŒ–

**ä¼˜åŒ–ç‚¹**: ç¼“å­˜æœºå™¨äººä¿¡æ¯ã€ä¼šè¯ç»Ÿè®¡ç­‰

**å®ç°**:

```javascript
// ç¼“å­˜æœºå™¨äººä¿¡æ¯
async getRobotByRobotId(robotId) {
  const cacheKey = `robot:${robotId}`;
  
  // å°è¯•ä»ç¼“å­˜è·å–
  const cached = await this.redis.get(cacheKey);
  if (cached) {
    return JSON.parse(cached);
  }

  // ä»æ•°æ®åº“æŸ¥è¯¢
  const robot = await db.select().from(robots)
    .where(eq(robots.robotId, robotId))
    .limit(1);

  // å†™å…¥ç¼“å­˜ï¼ˆ5åˆ†é’Ÿè¿‡æœŸï¼‰
  await this.redis.setex(cacheKey, 300, JSON.stringify(robot[0]));

  return robot[0];
}
```

**æ•ˆæœ**:
- æœºå™¨äººä¿¡æ¯æŸ¥è¯¢æ—¶é—´ä» ~50ms é™ä½åˆ° ~5ms
- æ•°æ®åº“å‹åŠ›é™ä½ 90%

---

### 14.3 æŒ‡ä»¤é˜Ÿåˆ—

**ä¼˜åŒ–ç‚¹**: ä½¿ç”¨é˜Ÿåˆ—ç®¡ç†æŒ‡ä»¤ï¼Œé¿å…å¹¶å‘å†²çª

**å®ç°**:

```javascript
// æ·»åŠ åˆ°é˜Ÿåˆ—
async addToQueue(queueData) {
  const db = await getDb();
  await db.insert(robotCommandQueue).values(queueData);
}

// æŒ‰ä¼˜å…ˆçº§è·å–æŒ‡ä»¤
async getNextCommand(robotId) {
  const db = await getDb();
  const commands = await db.select()
    .from(robotCommandQueue)
    .where(and(
      eq(robotCommandQueue.robotId, robotId),
      eq(robotCommandQueue.status, 'pending')
    ))
    .orderBy(robotCommandQueue.priority)
    .limit(1);

  return commands[0] || null;
}
```

**æ•ˆæœ**:
- æŒ‡ä»¤æ‰§è¡Œæœ‰åºï¼Œé¿å…å†²çª
- æ”¯æŒä¼˜å…ˆçº§è°ƒåº¦
- æ”¯æŒé‡è¯•æœºåˆ¶

---

### 14.4 æ‰¹é‡å¤„ç†

**ä¼˜åŒ–ç‚¹**: æ‰¹é‡æ’å…¥æ¶ˆæ¯ï¼Œæé«˜æ•°æ®åº“å†™å…¥æ€§èƒ½

**å®ç°**:

```javascript
// æ‰¹é‡æ’å…¥æ¶ˆæ¯
async batchInsertMessages(messages) {
  const db = await getDb();
  await db.insert(sessionMessages).values(messages);
}
```

**æ•ˆæœ**:
- æ‰¹é‡å†™å…¥æ€§èƒ½æå‡ 5 å€
- æ•°æ®åº“è¿æ¥æ•°é™ä½ 80%

---

## åäº”ã€æ•…éšœæ’æŸ¥

### 15.1 å¸¸è§é—®é¢˜

#### é—®é¢˜1: å›è°ƒæ¥æ”¶ä¸åˆ°æ¶ˆæ¯

**å¯èƒ½åŸå› **:
1. WorkTool é…ç½®çš„å›è°ƒåœ°å€é”™è¯¯
2. ç½‘ç»œä¸é€šæˆ–é˜²ç«å¢™æ‹¦æˆª
3. ç­¾åéªŒè¯å¤±è´¥

**æ’æŸ¥æ­¥éª¤**:
```bash
# 1. æ£€æŸ¥å›è°ƒåœ°å€é…ç½®
# ç™»å½• WorkTool å¹³å°ï¼ŒæŸ¥çœ‹æœºå™¨äººé…ç½®çš„å›è°ƒåœ°å€

# 2. æµ‹è¯•ç½‘ç»œè¿é€šæ€§
curl -X POST https://your-domain.com/api/worktool/callback/message?robotId=test

# 3. æŸ¥çœ‹æœåŠ¡å™¨æ—¥å¿—
tail -f /app/work/logs/bypass/app.log | grep "æ¶ˆæ¯å›è°ƒ"

# 4. æ£€æŸ¥ç­¾åé…ç½®
# æŸ¥çœ‹ .env æ–‡ä»¶ä¸­çš„ CALLBACK_SIGNATURE_SECRET é…ç½®
```

---

#### é—®é¢˜2: æ¶ˆæ¯å‘é€å¤±è´¥

**å¯èƒ½åŸå› **:
1. æœºå™¨äººæœªå¯ç”¨æˆ–æ‰çº¿
2. WorkTool API åœ°å€é”™è¯¯
3. API è°ƒç”¨è¶…æ—¶

**æ’æŸ¥æ­¥éª¤**:
```bash
# 1. æ£€æŸ¥æœºå™¨äººçŠ¶æ€
curl http://localhost:5001/api/worktool/robot/online-status?robotId={robotId}

# 2. æ£€æŸ¥ API åœ°å€é…ç½®
# æŸ¥çœ‹æ•°æ®åº“ä¸­ robots è¡¨çš„ api_base_url å­—æ®µ

# 3. æŸ¥çœ‹ API è°ƒç”¨æ—¥å¿—
tail -f /app/work/logs/bypass/app.log | grep "WorkTool.*å‘é€æ¶ˆæ¯"

# 4. æµ‹è¯• API è¿é€šæ€§
curl -X POST https://api.worktool.com/wework/sendRawMessage?robotId={robotId}
```

---

#### é—®é¢˜3: æŒ‡ä»¤é˜Ÿåˆ—é˜»å¡

**å¯èƒ½åŸå› **:
1. æŒ‡ä»¤æ‰§è¡Œå¤±è´¥ï¼Œé‡è¯•æ¬¡æ•°è¿‡å¤š
2. WorkTool API å“åº”æ…¢
3. é˜Ÿåˆ—å¤„ç†è¿›ç¨‹å¼‚å¸¸

**æ’æŸ¥æ­¥éª¤**:
```bash
# 1. æŸ¥çœ‹é˜Ÿåˆ—ç»Ÿè®¡
curl http://localhost:5001/api/admin/robot-commands/queue/stats

# 2. æŸ¥çœ‹å¤±è´¥çš„æŒ‡ä»¤
curl http://localhost:5001/api/admin/robot-commands?status=failed

# 3. é‡è¯•å¤±è´¥çš„æŒ‡ä»¤
curl -X POST http://localhost:5001/api/admin/robot-commands/{id}/retry

# 4. æ¸…ç†é˜»å¡çš„æŒ‡ä»¤
# æ‰‹åŠ¨æ›´æ–°æ•°æ®åº“ï¼Œå°†é•¿æ—¶é—´å¤„ç†ä¸­çš„æŒ‡ä»¤é‡ç½®ä¸º pending
```

---

#### é—®é¢˜4: AI å›å¤å¤±è´¥

**å¯èƒ½åŸå› **:
1. AI æœåŠ¡ API å¯†é’¥é”™è¯¯
2. AI æœåŠ¡ä¸å¯ç”¨
3. è¯·æ±‚è¶…æ—¶

**æ’æŸ¥æ­¥éª¤**:
```bash
# 1. æ£€æŸ¥ AI æœåŠ¡é…ç½®
# æŸ¥çœ‹ .env æ–‡ä»¶ä¸­çš„ AI ç›¸å…³é…ç½®

# 2. æŸ¥çœ‹ AI è°ƒç”¨æ—¥å¿—
tail -f /app/work/logs/bypass/app.log | grep "AI.*ç”Ÿæˆå›å¤"

# 3. æµ‹è¯• AI æœåŠ¡è¿æ¥
# æ‰‹åŠ¨è°ƒç”¨ AI æœåŠ¡ API æµ‹è¯•

# 4. æŸ¥çœ‹é”™è¯¯è¯¦æƒ…
# æŸ¥çœ‹æ•°æ®åº“ä¸­çš„ ai_io_logs è¡¨
```

---

### 15.2 æ—¥å¿—æŸ¥çœ‹

#### ç³»ç»Ÿæ—¥å¿—

```bash
# æŸ¥çœ‹åº”ç”¨æ—¥å¿—
tail -f /app/work/logs/bypass/app.log

# æŸ¥çœ‹é”™è¯¯æ—¥å¿—
tail -f /app/work/logs/bypass/app.log | grep -i "error"

# æŸ¥çœ‹ç‰¹å®šæ¨¡å—æ—¥å¿—
tail -f /app/work/logs/bypass/app.log | grep "WorkTool"
```

#### æ•°æ®åº“æ—¥å¿—

```bash
# æŸ¥çœ‹ PostgreSQL æ—¥å¿—
tail -f /var/log/postgresql/postgresql-*.log

# æŸ¥çœ‹æ…¢æŸ¥è¯¢
grep "duration:" /var/log/postgresql/postgresql-*.log
```

#### Redis æ—¥å¿—

```bash
# æŸ¥çœ‹ Redis æ—¥å¿—
tail -f /var/log/redis/redis-server.log
```

---

### 15.3 æ€§èƒ½ç›‘æ§

#### ç³»ç»ŸæŒ‡æ ‡

```bash
# æŸ¥çœ‹ç³»ç»Ÿèµ„æºä½¿ç”¨
top

# æŸ¥çœ‹å†…å­˜ä½¿ç”¨
free -h

# æŸ¥çœ‹ç£ç›˜ä½¿ç”¨
df -h

# æŸ¥çœ‹ç½‘ç»œè¿æ¥
netstat -tuln
```

#### åº”ç”¨æŒ‡æ ‡

```bash
# æŸ¥çœ‹æ¥å£å“åº”æ—¶é—´
curl -w "@curl-format.txt" -o /dev/null -s http://localhost:5001/api/admin/health

# æŸ¥çœ‹å¹¶å‘è¿æ¥æ•°
ss -tuln | grep :5001

# æŸ¥çœ‹è¿›ç¨‹çŠ¶æ€
ps aux | grep node
```

#### æ•°æ®åº“æŒ‡æ ‡

```bash
# è¿æ¥ PostgreSQL
psql -U postgres -d worktool

# æŸ¥çœ‹æ´»è·ƒè¿æ¥æ•°
SELECT count(*) FROM pg_stat_activity;

# æŸ¥çœ‹æ…¢æŸ¥è¯¢
SELECT * FROM pg_stat_statements ORDER BY total_time DESC LIMIT 10;

# æŸ¥çœ‹è¡¨å¤§å°
SELECT schemaname, tablename, 
  pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS size
FROM pg_tables 
WHERE schemaname = 'public'
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;
```

#### Redis æŒ‡æ ‡

```bash
# è¿æ¥ Redis
redis-cli

# æŸ¥çœ‹å†…å­˜ä½¿ç”¨
INFO memory

# æŸ¥çœ‹è¿æ¥æ•°
INFO clients

# æŸ¥çœ‹å‘½ä»¤ç»Ÿè®¡
INFO commandstats

# æŸ¥çœ‹æ…¢æŸ¥è¯¢
SLOWLOG GET 10
```

---

## åå…­ã€æ€»ç»“

### 16.1 ç³»ç»Ÿä¼˜åŠ¿

1. **é«˜å¯ç”¨æ€§**
   - å¼‚æ­¥å¤„ç†ï¼Œé¿å…é˜»å¡
   - ç†”æ–­å™¨ä¿æŠ¤ï¼Œé˜²æ­¢çº§è”æ•…éšœ
   - é‡è¯•æœºåˆ¶ï¼Œæé«˜æˆåŠŸç‡

2. **é«˜æ€§èƒ½**
   - ç¼“å­˜ä¼˜åŒ–ï¼Œå‡å°‘æ•°æ®åº“æŸ¥è¯¢
   - æŒ‡ä»¤é˜Ÿåˆ—ï¼Œæœ‰åºè°ƒåº¦
   - æ‰¹é‡å¤„ç†ï¼Œæé«˜å†™å…¥æ€§èƒ½

3. **å®‰å…¨æ€§**
   - ç­¾åæ ¡éªŒï¼Œé˜²æ­¢ä¼ªé€ è¯·æ±‚
   - å¹‚ç­‰å¤„ç†ï¼Œé¿å…é‡å¤æ‰§è¡Œ
   - é™æµä¿æŠ¤ï¼Œé˜²æ­¢æ»¥ç”¨

4. **å¯æ‰©å±•æ€§**
   - æ¨¡å—åŒ–è®¾è®¡ï¼Œæ˜“äºæ‰©å±•
   - æ”¯æŒå¤š AI æ¨¡å‹
   - æ”¯æŒå¤šæœºå™¨äººååŒ

5. **å¯ç»´æŠ¤æ€§**
   - å®Œå–„çš„æ—¥å¿—è®°å½•
   - è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
   - ä¸°å¯Œçš„ç›‘æ§æŒ‡æ ‡

### 16.2 ç³»ç»Ÿä¸è¶³

1. **å®æ—¶æ€§**
   - WebSocket åŠŸèƒ½æœªå®Œå…¨å®ç°
   - æ¶ˆæ¯æ¨é€ä¾èµ–è½®è¯¢

2. **å¯é æ€§**
   - éƒ¨åˆ†åŠŸèƒ½ä¾èµ–å¤–éƒ¨æœåŠ¡
   - éœ€è¦å¢åŠ é™çº§æœºåˆ¶

3. **æ€§èƒ½**
   - æ•°æ®åº“æŸ¥è¯¢å¯è¿›ä¸€æ­¥ä¼˜åŒ–
   - ç¼“å­˜ç­–ç•¥å¯è¿›ä¸€æ­¥å®Œå–„

### 16.3 ä¼˜åŒ–å»ºè®®

1. **å®ç° WebSocket**
   - å®ç°å®æ—¶æ¶ˆæ¯æ¨é€
   - é™ä½æœåŠ¡å™¨è´Ÿè½½

2. **å¢åŠ é™çº§æœºåˆ¶**
   - AI æœåŠ¡ä¸å¯ç”¨æ—¶çš„é™çº§ç­–ç•¥
   - WorkTool API ä¸å¯ç”¨æ—¶çš„é™çº§ç­–ç•¥

3. **ä¼˜åŒ–æ•°æ®åº“**
   - æ·»åŠ æ›´å¤šç´¢å¼•
   - ä¼˜åŒ–æ…¢æŸ¥è¯¢
   - è€ƒè™‘åˆ†åº“åˆ†è¡¨

4. **å®Œå–„ç›‘æ§**
   - å¢åŠ æ›´å¤šç›‘æ§æŒ‡æ ‡
   - å®ç°è‡ªåŠ¨å‘Šè­¦
   - å®ç°æ€§èƒ½åˆ†æ

---

## é™„å½•

### A. ç›¸å…³æ–‡æ¡£

- [WorkTool AI ä¸­æ¢ç³»ç»Ÿå®Œæ•´åˆ†ææŠ¥å‘Š](./WorkTool_AI_ä¸­æ¢ç³»ç»Ÿå®Œæ•´åˆ†ææŠ¥å‘Š.md)
- [æ¶ˆæ¯ä¸­å¿ƒä¸ä¸Šä¸‹æ–‡ç®¡ç†å®Œæ•´æŒ‡å—](./æ¶ˆæ¯ä¸­å¿ƒä¸ä¸Šä¸‹æ–‡ç®¡ç†å®Œæ•´æŒ‡å—.md)
- [API å‚è€ƒæ–‡æ¡£](../docs/API_REFERENCE.md)

### B. æ¥å£æ¸…å•

| æ¥å£ | è·¯å¾„ | æ–¹æ³• | è¯´æ˜ |
|------|------|------|------|
| æ¶ˆæ¯å›è°ƒ | `/api/worktool/callback/message` | POST | æ¥æ”¶æ¶ˆæ¯å›è°ƒ |
| æ‰§è¡Œç»“æœå›è°ƒ | `/api/worktool/callback/action-result` | POST | æ¥æ”¶æ‰§è¡Œç»“æœå›è°ƒ |
| ç¾¤äºŒç»´ç å›è°ƒ | `/api/worktool/callback/group-qrcode` | POST | æ¥æ”¶ç¾¤äºŒç»´ç å›è°ƒ |
| æœºå™¨äººçŠ¶æ€å›è°ƒ | `/api/worktool/callback/robot-status` | POST | æ¥æ”¶æœºå™¨äººçŠ¶æ€å›è°ƒ |
| å‘é€æ¶ˆæ¯ | `/api/worktool/robot/send-message` | POST | å‘é€æ¶ˆæ¯åˆ°ä¼ä¸šå¾®ä¿¡ |
| è·å–æœºå™¨äººä¿¡æ¯ | `/api/worktool/robot/info` | GET | è·å–æœºå™¨äººä¿¡æ¯ |
| æŸ¥è¯¢åœ¨çº¿çŠ¶æ€ | `/api/worktool/robot/online-status` | GET | æŸ¥è¯¢æœºå™¨äººåœ¨çº¿çŠ¶æ€ |
| åˆ›å»ºæŒ‡ä»¤ | `/api/admin/robot-commands` | POST | åˆ›å»ºæœºå™¨äººæŒ‡ä»¤ |
| è·å–æŒ‡ä»¤åˆ—è¡¨ | `/api/admin/robot-commands` | GET | è·å–æŒ‡ä»¤åˆ—è¡¨ |
| é‡è¯•æŒ‡ä»¤ | `/api/admin/robot-commands/:id/retry` | POST | é‡è¯•å¤±è´¥æŒ‡ä»¤ |

### C. è”ç³»æ–¹å¼

- **ç»´æŠ¤å›¢é˜Ÿ**: WorkTool AI å›¢é˜Ÿ
- **æ–‡æ¡£ç‰ˆæœ¬**: v1.0
- **åˆ›å»ºæ—¶é—´**: 2026-02-10

---

**æ–‡æ¡£ç»“æŸ**
