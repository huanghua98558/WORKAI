# WorkTool AI ä¸­æ¢ç³»ç»Ÿ - æ•°æ®åº“è®¾è®¡æ–‡æ¡£

## ğŸ“‹ ç›®å½•

1. [æ•°æ®åº“æ¦‚è¿°](#1-æ•°æ®åº“æ¦‚è¿°)
2. [ERå›¾](#2-erå›¾)
3. [è¡¨ç»“æ„è®¾è®¡](#3-è¡¨ç»“æ„è®¾è®¡)
4. [ç´¢å¼•è®¾è®¡](#4-ç´¢å¼•è®¾è®¡)
5. [æ•°æ®å­—å…¸](#5-æ•°æ®å­—å…¸)

---

## 1. æ•°æ®åº“æ¦‚è¿°

### 1.1 æ•°æ®åº“ä¿¡æ¯

```
æ•°æ®åº“ç±»å‹ï¼šPostgreSQL 15
æ•°æ®åº“åç§°ï¼šworktool_ai
å­—ç¬¦é›†ï¼šUTF8
æ’åºè§„åˆ™ï¼šen_US.UTF-8
```

### 1.2 è¡¨åˆ†ç±»

```
ç”¨æˆ·æƒé™ç±»
â”œâ”€â”€ users (ç”¨æˆ·è¡¨)
â”œâ”€â”€ roles (è§’è‰²è¡¨)
â”œâ”€â”€ permissions (æƒé™è¡¨)
â”œâ”€â”€ role_permissions (è§’è‰²æƒé™å…³è”è¡¨)
â””â”€â”€ user_roles (ç”¨æˆ·è§’è‰²å…³è”è¡¨)

ä¼šè¯æ¶ˆæ¯ç±»
â””â”€â”€ session_messages (ä¼šè¯æ¶ˆæ¯è¡¨)

å‘Šè­¦ç®¡ç†ç±»
â”œâ”€â”€ alerts (å‘Šè­¦è¡¨)
â”œâ”€â”€ alert_notifications (å‘Šè­¦é€šçŸ¥è¡¨)
â””â”€â”€ alert_configurations (å‘Šè­¦é…ç½®è¡¨)

å”®åä»»åŠ¡ç±»
â”œâ”€â”€ after_sales_tasks (å”®åä»»åŠ¡è¡¨)
â”œâ”€â”€ task_comments (ä»»åŠ¡è¯„è®ºè¡¨)
â”œâ”€â”€ task_attachments (ä»»åŠ¡é™„ä»¶è¡¨)
â””â”€â”€ tencent_docs_sync_logs (è…¾è®¯æ–‡æ¡£åŒæ­¥æ—¥å¿—è¡¨)

ååŒåˆ†æç±»
â”œâ”€â”€ staff_activities (å·¥ä½œäººå‘˜æ´»åŠ¨è¡¨)
â”œâ”€â”€ user_satisfaction_records (ç”¨æˆ·æ»¡æ„åº¦è®°å½•è¡¨)
â”œâ”€â”€ collaboration_decisions (ååŒå†³ç­–è¡¨)
â””â”€â”€ satisfaction_feedback (æ»¡æ„åº¦åé¦ˆè¡¨)

ç³»ç»Ÿç®¡ç†ç±»
â”œâ”€â”€ robots (æœºå™¨äººè¡¨)
â”œâ”€â”€ system_settings (ç³»ç»Ÿè®¾ç½®è¡¨)
â”œâ”€â”€ audit_logs (å®¡è®¡æ—¥å¿—è¡¨)
â””â”€â”€ ai_configurations (AIé…ç½®è¡¨)
```

---

## 2. ERå›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              ERå›¾                                           â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚  â”‚  users   â”‚        â”‚ user_roles   â”‚        â”‚  roles   â”‚                â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                â”‚
â”‚  â”‚ id (PK)  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”‚ user_id (FK) â”‚â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ id (PK)  â”‚                â”‚
â”‚  â”‚ username â”‚        â”‚ role_id (FK) â”‚        â”‚ name     â”‚                â”‚
â”‚  â”‚ email    â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                â”‚
â”‚  â”‚ password â”‚                                       â”‚       â”‚                â”‚
â”‚  â”‚ status   â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚       â”‚                â”‚
â”‚  â”‚ created  â”‚        â”‚role_permissionsâ”‚               â”‚       â”‚                â”‚
â”‚  â”‚ updated  â”‚        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                â”‚       â”‚                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚ role_id (FK) â”‚â”€â”€â”€â”€â”€â”€â”€â”        â”‚       â”‚                â”‚
â”‚                      â”‚ perm_id (FK)  â”‚       â”‚        â”‚       â”‚                â”‚
â”‚                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚        â”‚       â”‚                â”‚
â”‚                                             â”‚        â”‚       â”‚                â”‚
â”‚                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â–¼â”€â”€â”             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚permissions   â”‚       â”‚   â”‚ permissions â”‚             â”‚
â”‚  â”‚sessions  â”‚        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤       â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤             â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤        â”‚ id (PK)      â”‚       â”‚   â”‚ id (PK)    â”‚             â”‚
â”‚  â”‚ id (PK)  â”‚        â”‚ name         â”‚       â”‚   â”‚ name       â”‚             â”‚
â”‚  â”‚ user_id  â”‚        â”‚ module       â”‚       â”‚   â”‚ module     â”‚             â”‚
â”‚  â”‚ group_id â”‚        â”‚ action       â”‚       â”‚   â”‚ action     â”‚             â”‚
â”‚  â”‚ status   â”‚        â”‚ description  â”‚       â”‚   â”‚ descriptionâ”‚             â”‚
â”‚  â”‚ created  â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚  â”‚ updated  â”‚                               â”‚                              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                               â”‚                              â”‚
â”‚                                             â”‚                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                               â”‚                              â”‚
â”‚  â”‚ messages â”‚                               â”‚                              â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                               â”‚                              â”‚
â”‚  â”‚ id (PK)  â”‚                               â”‚                              â”‚
â”‚  â”‚sess_id   â”‚                               â”‚                              â”‚
â”‚  â”‚ user_id  â”‚                               â”‚                              â”‚
â”‚  â”‚ content  â”‚                               â”‚                              â”‚
â”‚  â”‚sentiment â”‚                               â”‚                              â”‚
â”‚  â”‚ created  â”‚                               â”‚                              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                               â”‚                              â”‚
â”‚                                             â”‚                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚                              â”‚
â”‚  â”‚  alerts  â”‚        â”‚alert_notifs  â”‚       â”‚                              â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤       â”‚                              â”‚
â”‚  â”‚ id (PK)  â”‚        â”‚ alert_id (FK) â”‚       â”‚                              â”‚
â”‚  â”‚ type     â”‚        â”‚ channel      â”‚       â”‚                              â”‚
â”‚  â”‚ level    â”‚        â”‚ status       â”‚       â”‚                              â”‚
â”‚  â”‚ status   â”‚        â”‚ sent_at      â”‚       â”‚                              â”‚
â”‚  â”‚ sess_id  â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚                              â”‚
â”‚  â”‚ user_id  â”‚                               â”‚                              â”‚
â”‚  â”‚ reason   â”‚                               â”‚                              â”‚
â”‚  â”‚ created  â”‚                               â”‚                              â”‚
â”‚  â”‚ updated  â”‚                               â”‚                              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                               â”‚                              â”‚
â”‚                                             â”‚                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚                              â”‚
â”‚  â”‚  tasks   â”‚        â”‚task_comments â”‚       â”‚                              â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤       â”‚                              â”‚
â”‚  â”‚ id (PK)  â”‚        â”‚ task_id (FK) â”‚       â”‚                              â”‚
â”‚  â”‚ type     â”‚        â”‚ staff_id (FK)â”‚       â”‚                              â”‚
â”‚  â”‚ sess_id  â”‚        â”‚ content      â”‚       â”‚                              â”‚
â”‚  â”‚ user_id  â”‚        â”‚ created_at   â”‚       â”‚                              â”‚
â”‚  â”‚ status   â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚                              â”‚
â”‚  â”‚ priority â”‚                               â”‚                              â”‚
â”‚  â”‚ assigned â”‚                               â”‚                              â”‚
â”‚  â”‚ created  â”‚                               â”‚                              â”‚
â”‚  â”‚ updated  â”‚                               â”‚                              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                               â”‚                              â”‚
â”‚                                             â”‚                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚                              â”‚
â”‚  â”‚staff_act â”‚        â”‚collab_decs   â”‚       â”‚                              â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤       â”‚                              â”‚
â”‚  â”‚ id (PK)  â”‚        â”‚ id (PK)      â”‚       â”‚                              â”‚
â”‚  â”‚ staff_id â”‚        â”‚ sess_id      â”‚       â”‚                              â”‚
â”‚  â”‚ type     â”‚        â”‚ type         â”‚       â”‚                              â”‚
â”‚  â”‚ activity â”‚        â”‚ status       â”‚       â”‚                              â”‚
â”‚  â”‚ created  â”‚        â”‚ assigned_to  â”‚       â”‚                              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚ created_at   â”‚       â”‚                              â”‚
â”‚                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚                              â”‚
â”‚                                             â”‚                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. è¡¨ç»“æ„è®¾è®¡

### 3.1 ç”¨æˆ·æƒé™ç±»è¡¨

#### users (ç”¨æˆ·è¡¨)

```sql
CREATE TABLE users (
  id VARCHAR(36) PRIMARY KEY DEFAULT gen_random_uuid(),
  username VARCHAR(50) UNIQUE NOT NULL,
  email VARCHAR(100) UNIQUE NOT NULL,
  password_hash VARCHAR(255) NOT NULL,
  real_name VARCHAR(100),
  avatar TEXT,
  status VARCHAR(20) DEFAULT 'active' CHECK (status IN ('active', 'inactive', 'locked')),
  last_login_at TIMESTAMP,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_users_username ON users(username);
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_status ON users(status);
```

#### roles (è§’è‰²è¡¨)

```sql
CREATE TABLE roles (
  id VARCHAR(36) PRIMARY KEY DEFAULT gen_random_uuid(),
  name VARCHAR(50) UNIQUE NOT NULL,
  description TEXT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_roles_name ON roles(name);
```

#### permissions (æƒé™è¡¨)

```sql
CREATE TABLE permissions (
  id VARCHAR(36) PRIMARY KEY DEFAULT gen_random_uuid(),
  name VARCHAR(100) UNIQUE NOT NULL,
  module VARCHAR(50) NOT NULL,
  action VARCHAR(50) NOT NULL,
  description TEXT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_permissions_module ON permissions(module);
CREATE INDEX idx_permissions_name ON permissions(name);
```

#### role_permissions (è§’è‰²æƒé™å…³è”è¡¨)

```sql
CREATE TABLE role_permissions (
  id VARCHAR(36) PRIMARY KEY DEFAULT gen_random_uuid(),
  role_id VARCHAR(36) NOT NULL REFERENCES roles(id) ON DELETE CASCADE,
  permission_id VARCHAR(36) NOT NULL REFERENCES permissions(id) ON DELETE CASCADE,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  UNIQUE(role_id, permission_id)
);

CREATE INDEX idx_role_permissions_role_id ON role_permissions(role_id);
CREATE INDEX idx_role_permissions_permission_id ON role_permissions(permission_id);
```

#### user_roles (ç”¨æˆ·è§’è‰²å…³è”è¡¨)

```sql
CREATE TABLE user_roles (
  id VARCHAR(36) PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id VARCHAR(36) NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  role_id VARCHAR(36) NOT NULL REFERENCES roles(id) ON DELETE CASCADE,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  UNIQUE(user_id, role_id)
);

CREATE INDEX idx_user_roles_user_id ON user_roles(user_id);
CREATE INDEX idx_user_roles_role_id ON user_roles(role_id);
```

### 3.2 ä¼šè¯æ¶ˆæ¯ç±»è¡¨

#### session_messages (ä¼šè¯æ¶ˆæ¯è¡¨)

```sql
CREATE TABLE session_messages (
  id VARCHAR(36) PRIMARY KEY DEFAULT gen_random_uuid(),
  message_id VARCHAR(100) UNIQUE NOT NULL,
  session_id VARCHAR(100) NOT NULL,
  user_id VARCHAR(36) NOT NULL REFERENCES users(id) ON DELETE SET NULL,
  user_name VARCHAR(100) NOT NULL,
  group_id VARCHAR(100),
  group_name VARCHAR(100),
  content TEXT NOT NULL,
  media_url TEXT,
  image_text TEXT,
  voice_text TEXT,
  message_type VARCHAR(20) DEFAULT 'text' CHECK (message_type IN ('text', 'image', 'voice', 'file', 'video', 'link', 'emoji')),
  is_from_user BOOLEAN DEFAULT false,
  is_from_bot BOOLEAN DEFAULT false,
  is_human BOOLEAN DEFAULT false,
  sentiment VARCHAR(20) CHECK (sentiment IN ('positive', 'neutral', 'negative')),
  sentiment_intensity VARCHAR(20) CHECK (sentiment_intensity IN ('low', 'medium', 'high')),
  timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_session_messages_session_id ON session_messages(session_id);
CREATE INDEX idx_session_messages_user_id ON session_messages(user_id);
CREATE INDEX idx_session_messages_group_id ON session_messages(group_id);
CREATE INDEX idx_session_messages_timestamp ON session_messages(timestamp DESC);
CREATE INDEX idx_session_messages_sentiment ON session_messages(sentiment);
```

### 3.3 å‘Šè­¦ç®¡ç†ç±»è¡¨

#### alerts (å‘Šè­¦è¡¨)

```sql
CREATE TABLE alerts (
  id VARCHAR(36) PRIMARY KEY DEFAULT gen_random_uuid(),
  alert_id VARCHAR(100) UNIQUE NOT NULL,
  alert_type VARCHAR(50) NOT NULL CHECK (alert_type IN ('user_complaint', 'after_sales', 'low_satisfaction', 'frequent_complaint', 'human_intervention_request', 'system_error')),
  alert_level VARCHAR(10) NOT NULL CHECK (alert_level IN ('P0', 'P1', 'P2', 'P3')),
  session_id VARCHAR(100),
  user_id VARCHAR(36) REFERENCES users(id) ON DELETE SET NULL,
  user_name VARCHAR(100),
  group_id VARCHAR(100),
  group_name VARCHAR(100),
  message_content TEXT,
  reason TEXT NOT NULL,
  status VARCHAR(20) DEFAULT 'created' CHECK (status IN ('created', 'acknowledged', 'processing', 'resolved', 'cancelled')),
  acknowledged_by VARCHAR(36) REFERENCES users(id) ON DELETE SET NULL,
  acknowledged_at TIMESTAMP,
  processed_by VARCHAR(36) REFERENCES users(id) ON DELETE SET NULL,
  processed_at TIMESTAMP,
  resolved_by VARCHAR(36) REFERENCES users(id) ON DELETE SET NULL,
  resolved_at TIMESTAMP,
  cancelled_by VARCHAR(36) REFERENCES users(id) ON DELETE SET NULL,
  cancelled_at TIMESTAMP,
  cancel_reason TEXT,
  escalation_level INTEGER DEFAULT 0,
  escalation_history JSONB DEFAULT '[]'::jsonb,
  notification_history JSONB DEFAULT '[]'::jsonb,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_alerts_alert_id ON alerts(alert_id);
CREATE INDEX idx_alerts_session_id ON alerts(session_id);
CREATE INDEX idx_alerts_user_id ON alerts(user_id);
CREATE INDEX idx_alerts_status ON alerts(status);
CREATE INDEX idx_alerts_alert_level ON alerts(alert_level);
CREATE INDEX idx_alerts_created_at ON alerts(created_at DESC);
```

#### alert_notifications (å‘Šè­¦é€šçŸ¥è¡¨)

```sql
CREATE TABLE alert_notifications (
  id VARCHAR(36) PRIMARY KEY DEFAULT gen_random_uuid(),
  alert_id VARCHAR(100) NOT NULL REFERENCES alerts(alert_id) ON DELETE CASCADE,
  channel VARCHAR(20) NOT NULL CHECK (channel IN ('wechat_work', 'wechat', 'email', 'sms')),
  status VARCHAR(20) DEFAULT 'pending' CHECK (status IN ('pending', 'sent', 'failed')),
  sent_at TIMESTAMP,
  error TEXT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_alert_notifications_alert_id ON alert_notifications(alert_id);
CREATE INDEX idx_alert_notifications_status ON alert_notifications(status);
```

#### alert_configurations (å‘Šè­¦é…ç½®è¡¨)

```sql
CREATE TABLE alert_configurations (
  id VARCHAR(36) PRIMARY KEY DEFAULT gen_random_uuid(),
  config_key VARCHAR(100) UNIQUE NOT NULL,
  config_value JSONB NOT NULL,
  description TEXT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_alert_configurations_config_key ON alert_configurations(config_key);
```

### 3.4 å”®åä»»åŠ¡ç±»è¡¨

#### after_sales_tasks (å”®åä»»åŠ¡è¡¨)

```sql
CREATE TABLE after_sales_tasks (
  id VARCHAR(36) PRIMARY KEY DEFAULT gen_random_uuid(),
  task_id VARCHAR(100) UNIQUE NOT NULL,
  task_type VARCHAR(50) NOT NULL CHECK (task_type IN ('refund', 'product_issue', 'service_issue', 'order_issue', 'other')),
  session_id VARCHAR(100) NOT NULL,
  user_id VARCHAR(36) NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  user_name VARCHAR(100) NOT NULL,
  group_id VARCHAR(100),
  group_name VARCHAR(100),
  description TEXT NOT NULL,
  details JSONB DEFAULT '{}'::jsonb,
  priority VARCHAR(10) DEFAULT 'P2' CHECK (priority IN ('P0', 'P1', 'P2', 'P3')),
  status VARCHAR(20) DEFAULT 'pending' CHECK (status IN ('pending', 'in_progress', 'completed', 'cancelled')),
  assigned_to VARCHAR(36) REFERENCES users(id) ON DELETE SET NULL,
  assigned_at TIMESTAMP,
  completed_by VARCHAR(36) REFERENCES users(id) ON DELETE SET NULL,
  completed_at TIMESTAMP,
  completion_notes TEXT,
  cancelled_by VARCHAR(36) REFERENCES users(id) ON DELETE SET NULL,
  cancelled_at TIMESTAMP,
  cancel_reason TEXT,
  collaboration_team TEXT[],
  source VARCHAR(50) DEFAULT 'manual' CHECK (source IN ('manual', 'ai_detected', 'user_submitted')),
  sync_to_tencent_docs BOOLEAN DEFAULT true,
  tencent_docs_id VARCHAR(100),
  tencent_docs_row_number INTEGER,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_after_sales_tasks_task_id ON after_sales_tasks(task_id);
CREATE INDEX idx_after_sales_tasks_session_id ON after_sales_tasks(session_id);
CREATE INDEX idx_after_sales_tasks_user_id ON after_sales_tasks(user_id);
CREATE INDEX idx_after_sales_tasks_status ON after_sales_tasks(status);
CREATE INDEX idx_after_sales_tasks_priority ON after_sales_tasks(priority);
CREATE INDEX idx_after_sales_tasks_assigned_to ON after_sales_tasks(assigned_to);
CREATE INDEX idx_after_sales_tasks_created_at ON after_sales_tasks(created_at DESC);
```

#### task_comments (ä»»åŠ¡è¯„è®ºè¡¨)

```sql
CREATE TABLE task_comments (
  id VARCHAR(36) PRIMARY KEY DEFAULT gen_random_uuid(),
  task_id VARCHAR(100) NOT NULL REFERENCES after_sales_tasks(task_id) ON DELETE CASCADE,
  staff_id VARCHAR(36) NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  staff_name VARCHAR(100) NOT NULL,
  content TEXT NOT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_task_comments_task_id ON task_comments(task_id);
CREATE INDEX idx_task_comments_staff_id ON task_comments(staff_id);
```

#### task_attachments (ä»»åŠ¡é™„ä»¶è¡¨)

```sql
CREATE TABLE task_attachments (
  id VARCHAR(36) PRIMARY KEY DEFAULT gen_random_uuid(),
  task_id VARCHAR(100) NOT NULL REFERENCES after_sales_tasks(task_id) ON DELETE CASCADE,
  file_name VARCHAR(255) NOT NULL,
  file_url TEXT NOT NULL,
  file_size BIGINT,
  file_type VARCHAR(50),
  uploaded_by VARCHAR(36) REFERENCES users(id) ON DELETE SET NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_task_attachments_task_id ON task_attachments(task_id);
```

#### tencent_docs_sync_logs (è…¾è®¯æ–‡æ¡£åŒæ­¥æ—¥å¿—è¡¨)

```sql
CREATE TABLE tencent_docs_sync_logs (
  id VARCHAR(36) PRIMARY KEY DEFAULT gen_random_uuid(),
  task_id VARCHAR(100) NOT NULL REFERENCES after_sales_tasks(task_id) ON DELETE CASCADE,
  document_id VARCHAR(100),
  row_number INTEGER,
  status VARCHAR(20) NOT NULL CHECK (status IN ('insert', 'update', 'failed')),
  error TEXT,
  synced_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_tencent_docs_sync_logs_task_id ON tencent_docs_sync_logs(task_id);
CREATE INDEX idx_tencent_docs_sync_logs_status ON tencent_docs_sync_logs(status);
```

### 3.5 ååŒåˆ†æç±»è¡¨

#### staff_activities (å·¥ä½œäººå‘˜æ´»åŠ¨è¡¨)

```sql
CREATE TABLE staff_activities (
  id VARCHAR(36) PRIMARY KEY DEFAULT gen_random_uuid(),
  staff_id VARCHAR(36) NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  staff_name VARCHAR(100) NOT NULL,
  activity_type VARCHAR(50) NOT NULL CHECK (activity_type IN ('send_message', 'receive_message', 'acknowledge_alert', 'process_alert', 'resolve_alert', 'create_task', 'update_task', 'complete_task', 'cancel_task')),
  activity_data JSONB DEFAULT '{}'::jsonb,
  activity_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_staff_activities_staff_id ON staff_activities(staff_id);
CREATE INDEX idx_staff_activities_activity_type ON staff_activities(activity_type);
CREATE INDEX idx_staff_activities_activity_time ON staff_activities(activity_time DESC);
```

#### user_satisfaction_records (ç”¨æˆ·æ»¡æ„åº¦è®°å½•è¡¨)

```sql
CREATE TABLE user_satisfaction_records (
  id VARCHAR(36) PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id VARCHAR(36) NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  satisfaction_score INTEGER CHECK (satisfaction_score BETWEEN 0 AND 100),
  sentiment VARCHAR(20),
  sentiment_intensity VARCHAR(20),
  feedback TEXT,
  session_id VARCHAR(100),
  task_id VARCHAR(100),
  recorded_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_user_satisfaction_records_user_id ON user_satisfaction_records(user_id);
CREATE INDEX idx_user_satisfaction_records_recorded_at ON user_satisfaction_records(recorded_at DESC);
```

#### collaboration_decisions (ååŒå†³ç­–è¡¨)

```sql
CREATE TABLE collaboration_decisions (
  id VARCHAR(36) PRIMARY KEY DEFAULT gen_random_uuid(),
  decision_id VARCHAR(100) UNIQUE NOT NULL,
  decision_type VARCHAR(50) NOT NULL CHECK (decision_type IN ('human_intervention', 'staff_assignment', 'resource_scheduling')),
  session_id VARCHAR(100),
  user_id VARCHAR(36) REFERENCES users(id) ON DELETE SET NULL,
  user_name VARCHAR(100),
  reason TEXT NOT NULL,
  context JSONB DEFAULT '{}'::jsonb,
  priority VARCHAR(10) DEFAULT 'P2' CHECK (priority IN ('P0', 'P1', 'P2', 'P3')),
  status VARCHAR(20) DEFAULT 'pending' CHECK (status IN ('pending', 'assigned', 'completed', 'cancelled')),
  assigned_to VARCHAR(36) REFERENCES users(id) ON DELETE SET NULL,
  assigned_at TIMESTAMP,
  completed_by VARCHAR(36) REFERENCES users(id) ON DELETE SET NULL,
  completed_at TIMESTAMP,
  notes TEXT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_collaboration_decisions_decision_id ON collaboration_decisions(decision_id);
CREATE INDEX idx_collaboration_decisions_session_id ON collaboration_decisions(session_id);
CREATE INDEX idx_collaboration_decisions_status ON collaboration_decisions(status);
```

#### satisfaction_feedback (æ»¡æ„åº¦åé¦ˆè¡¨)

```sql
CREATE TABLE satisfaction_feedback (
  id VARCHAR(36) PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id VARCHAR(36) NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  session_id VARCHAR(100),
  task_id VARCHAR(100),
  rating INTEGER CHECK (rating BETWEEN 1 AND 5),
  comment TEXT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_satisfaction_feedback_user_id ON satisfaction_feedback(user_id);
CREATE INDEX idx_satisfaction_feedback_session_id ON satisfaction_feedback(session_id);
```

### 3.6 ç³»ç»Ÿç®¡ç†ç±»è¡¨

#### robots (æœºå™¨äººè¡¨)

```sql
CREATE TABLE robots (
  id VARCHAR(36) PRIMARY KEY DEFAULT gen_random_uuid(),
  robot_id VARCHAR(100) UNIQUE NOT NULL,
  robot_name VARCHAR(100) NOT NULL,
  robot_type VARCHAR(50) NOT NULL CHECK (robot_type IN ('main_bot', 'after_sales_bot', 'emergency_bot', 'backup_bot')),
  webhook_url TEXT NOT NULL,
  status VARCHAR(20) DEFAULT 'active' CHECK (status IN ('active', 'inactive', 'offline')),
  priority INTEGER DEFAULT 0,
  current_load INTEGER DEFAULT 0,
  last_active_at TIMESTAMP,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_robots_robot_id ON robots(robot_id);
CREATE INDEX idx_robots_status ON robots(status);
CREATE INDEX idx_robots_robot_type ON robots(robot_type);
```

#### system_settings (ç³»ç»Ÿè®¾ç½®è¡¨)

```sql
CREATE TABLE system_settings (
  id VARCHAR(36) PRIMARY KEY DEFAULT gen_random_uuid(),
  setting_key VARCHAR(100) UNIQUE NOT NULL,
  setting_value TEXT NOT NULL,
  setting_type VARCHAR(20) DEFAULT 'string' CHECK (setting_type IN ('string', 'number', 'boolean', 'json')),
  description TEXT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_system_settings_setting_key ON system_settings(setting_key);
```

#### audit_logs (å®¡è®¡æ—¥å¿—è¡¨)

```sql
CREATE TABLE audit_logs (
  id VARCHAR(36) PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id VARCHAR(36) REFERENCES users(id) ON DELETE SET NULL,
  user_name VARCHAR(100),
  action VARCHAR(100) NOT NULL,
  resource_type VARCHAR(50),
  resource_id VARCHAR(100),
  request_ip VARCHAR(50),
  request_method VARCHAR(10),
  request_url TEXT,
  request_data JSONB,
  response_status INTEGER,
  error_message TEXT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_audit_logs_user_id ON audit_logs(user_id);
CREATE INDEX idx_audit_logs_action ON audit_logs(action);
CREATE INDEX idx_audit_logs_resource_type ON audit_logs(resource_type);
CREATE INDEX idx_audit_logs_created_at ON audit_logs(created_at DESC);
```

#### ai_configurations (AIé…ç½®è¡¨)

```sql
CREATE TABLE ai_configurations (
  id VARCHAR(36) PRIMARY KEY DEFAULT gen_random_uuid(),
  config_key VARCHAR(100) UNIQUE NOT NULL,
  config_value JSONB NOT NULL,
  description TEXT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_ai_configurations_config_key ON ai_configurations(config_key);
```

---

## 4. ç´¢å¼•è®¾è®¡

### 4.1 ç´¢å¼•ç­–ç•¥

```
ä¸»é”®ç´¢å¼•ï¼šæ‰€æœ‰è¡¨éƒ½æœ‰ä¸»é”®ç´¢å¼•
å”¯ä¸€ç´¢å¼•ï¼šç¡®ä¿æ•°æ®å”¯ä¸€æ€§
æ™®é€šç´¢å¼•ï¼šä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½
å¤åˆç´¢å¼•ï¼šä¼˜åŒ–å¤šæ¡ä»¶æŸ¥è¯¢
JSONBç´¢å¼•ï¼šä¼˜åŒ–JSONæ•°æ®æŸ¥è¯¢
```

### 4.2 ç´¢å¼•æ¸…å•

```
ç”¨æˆ·æƒé™ç±»
- idx_users_username
- idx_users_email
- idx_users_status
- idx_roles_name
- idx_permissions_module
- idx_permissions_name
- idx_role_permissions_role_id
- idx_role_permissions_permission_id
- idx_user_roles_user_id
- idx_user_roles_role_id

ä¼šè¯æ¶ˆæ¯ç±»
- idx_session_messages_session_id
- idx_session_messages_user_id
- idx_session_messages_group_id
- idx_session_messages_timestamp
- idx_session_messages_sentiment

å‘Šè­¦ç®¡ç†ç±»
- idx_alerts_alert_id
- idx_alerts_session_id
- idx_alerts_user_id
- idx_alerts_status
- idx_alerts_alert_level
- idx_alerts_created_at
- idx_alert_notifications_alert_id
- idx_alert_notifications_status
- idx_alert_configurations_config_key

å”®åä»»åŠ¡ç±»
- idx_after_sales_tasks_task_id
- idx_after_sales_tasks_session_id
- idx_after_sales_tasks_user_id
- idx_after_sales_tasks_status
- idx_after_sales_tasks_priority
- idx_after_sales_tasks_assigned_to
- idx_after_sales_tasks_created_at
- idx_task_comments_task_id
- idx_task_comments_staff_id
- idx_task_attachments_task_id
- idx_tencent_docs_sync_logs_task_id
- idx_tencent_docs_sync_logs_status

ååŒåˆ†æç±»
- idx_staff_activities_staff_id
- idx_staff_activities_activity_type
- idx_staff_activities_activity_time
- idx_user_satisfaction_records_user_id
- idx_user_satisfaction_records_recorded_at
- idx_collaboration_decisions_decision_id
- idx_collaboration_decisions_session_id
- idx_collaboration_decisions_status
- idx_satisfaction_feedback_user_id
- idx_satisfaction_feedback_session_id

ç³»ç»Ÿç®¡ç†ç±»
- idx_robots_robot_id
- idx_robots_status
- idx_robots_robot_type
- idx_system_settings_setting_key
- idx_audit_logs_user_id
- idx_audit_logs_action
- idx_audit_logs_resource_type
- idx_audit_logs_created_at
- idx_ai_configurations_config_key
```

---

## 5. æ•°æ®å­—å…¸

### 5.1 æšä¸¾å€¼

#### å‘Šè­¦ç±»å‹ (alert_type)
```
user_complaint - ç”¨æˆ·æŠ•è¯‰
after_sales - å”®åä»»åŠ¡
low_satisfaction - ä½æ»¡æ„åº¦é¢„è­¦
frequent_complaint - é¢‘ç¹æŠ•è¯‰é¢„è­¦
human_intervention_request - äººå·¥ä»‹å…¥è¯·æ±‚
system_error - ç³»ç»Ÿå¼‚å¸¸
```

#### å‘Šè­¦çº§åˆ« (alert_level)
```
P0 - æœ€é«˜ä¼˜å…ˆçº§
P1 - é«˜ä¼˜å…ˆçº§
P2 - ä¸­ä¼˜å…ˆçº§
P3 - ä½ä¼˜å…ˆçº§
```

#### å‘Šè­¦çŠ¶æ€ (alert_status)
```
created - å·²åˆ›å»º
acknowledged - å·²ç¡®è®¤
processing - å¤„ç†ä¸­
resolved - å·²è§£å†³
cancelled - å·²å–æ¶ˆ
```

#### ä»»åŠ¡ç±»å‹ (task_type)
```
refund - é€€æ¬¾
product_issue - äº§å“é—®é¢˜
service_issue - æœåŠ¡é—®é¢˜
order_issue - è®¢å•é—®é¢˜
other - å…¶ä»–é—®é¢˜
```

#### ä»»åŠ¡çŠ¶æ€ (task_status)
```
pending - å¾…å¤„ç†
in_progress - å¤„ç†ä¸­
completed - å·²å®Œæˆ
cancelled - å·²å–æ¶ˆ
```

#### æœºå™¨äººç±»å‹ (robot_type)
```
main_bot - ä¸»è¦æœºå™¨äºº
after_sales_bot - å”®åæœºå™¨äºº
emergency_bot - åº”æ€¥æœºå™¨äºº
backup_bot - å¤‡ç”¨æœºå™¨äºº
```

#### æ¶ˆæ¯ç±»å‹ (message_type)
```
text - æ–‡æœ¬æ¶ˆæ¯
image - å›¾ç‰‡æ¶ˆæ¯
voice - è¯­éŸ³æ¶ˆæ¯
file - æ–‡ä»¶æ¶ˆæ¯
video - è§†é¢‘æ¶ˆæ¯
link - é“¾æ¥æ¶ˆæ¯
emoji - è¡¨æƒ…æ¶ˆæ¯
```

#### æƒ…æ„Ÿç±»å‹ (sentiment)
```
positive - æ­£é¢
neutral - ä¸­æ€§
negative - è´Ÿé¢
```

#### æƒ…æ„Ÿå¼ºåº¦ (sentiment_intensity)
```
low - ä½å¼ºåº¦
medium - ä¸­å¼ºåº¦
high - é«˜å¼ºåº¦
```

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0

**æœ€åæ›´æ–°**ï¼š2024-01-10

**æ–‡æ¡£ä½œè€…**ï¼šWorkTool AI å›¢é˜Ÿ
