# WorkTool AI 中枢系统 - 故障排查指南

## 📋 目录

1. [故障分类](#1-故障分类)
2. [快速诊断](#2-快速诊断)
3. [常见故障](#3-常见故障)
4. [故障排查工具](#4-故障排查工具)
5. [故障上报流程](#5-故障上报流程)
6. [故障预防](#6-故障预防)

---

## 1. 故障分类

### 1.1 按严重程度分类

```
P0 - 严重故障
- 系统完全不可用
- 数据丢失或损坏
- 安全漏洞被利用
- 影响范围：所有用户
- 响应时间：立即

P1 - 高优先级故障
- 核心功能不可用
- 性能严重下降
- 部分用户无法使用
- 影响范围：大部分用户
- 响应时间：30分钟内

P2 - 中优先级故障
- 部分功能不可用
- 性能轻微下降
- 影响范围：部分用户
- 响应时间：2小时内

P3 - 低优先级故障
- 非核心功能问题
- 界面显示异常
- 影响范围：少数用户
- 响应时间：1个工作日内
```

### 1.2 按故障类型分类

```
服务故障
- 应用服务宕机
- 数据库服务宕机
- 缓存服务宕机
- 负载均衡故障

网络故障
- 网络中断
- DNS解析失败
- 防火墙拦截
- 端口不可达

数据故障
- 数据损坏
- 数据丢失
- 数据不一致
- 数据库锁死

性能故障
- 响应缓慢
- CPU/内存过高
- 磁盘I/O过载
- 网络拥塞

功能故障
- 功能异常
- 逻辑错误
- 数据错误
- 集成异常

安全故障
- 未授权访问
- 数据泄露
- 攻击入侵
- 恶意操作
```

---

## 2. 快速诊断

### 2.1 服务状态检查

```bash
#!/bin/bash
# 快速诊断脚本 quick_diagnosis.sh

echo "=== WorkTool AI 快速诊断 ==="

# 1. 检查服务状态
echo "1. 检查服务状态"
echo "---应用服务---"
systemctl status worktool-api --no-pager -l | head -20
echo "---数据库服务---"
systemctl status postgresql --no-pager -l | head -20
echo "---缓存服务---"
systemctl status redis --no-pager -l | head -20

# 2. 检查端口
echo "2. 检查端口状态"
ss -tuln | grep -E ":5000|:5432|:6379"

# 3. 检查进程
echo "3. 检查进程状态"
ps aux | grep -E "worktool|postgres|redis" | grep -v grep

# 4. 检查资源使用
echo "4. 检查资源使用"
echo "---CPU---"
top -bn1 | grep "Cpu(s)" | sed "s/.*, *\([0-9.]*\)%id.*/\1/" | awk '{print 100 - $1"%"}'
echo "---内存---"
free -h | grep Mem | awk '{print $3"/"$2}'
echo "---磁盘---"
df -h | grep -E "/var|/tmp"

# 5. 检查错误日志
echo "5. 检查最近的错误"
tail -20 /var/log/worktool/api-error.log

# 6. 检查数据库连接
echo "6. 检查数据库连接"
psql -U worktool -d worktool_ai -c "SELECT count(*) as connections FROM pg_stat_activity;" 2>&1

# 7. 检查Redis连接
echo "7. 检查Redis连接"
redis-cli ping 2>&1

echo "=== 诊断完成 ==="
```

### 2.2 健康检查接口

```bash
# 应用健康检查
curl http://localhost:5000/health

# 预期响应
{
  "status": "healthy",
  "timestamp": "2024-01-10T10:00:00Z",
  "checks": {
    "database": "ok",
    "redis": "ok",
    "ai_service": "ok"
  }
}

# 数据库健康检查
curl http://localhost:5000/health/database

# Redis健康检查
curl http://localhost:5000/health/redis
```

### 2.3 监控指标检查

```yaml
关键指标:
  应用:
    - QPS: > 100/s
    - RT: < 500ms
    - 错误率: < 0.1%

  数据库:
    - 连接数: < 80%
    - 慢查询: < 10/min
    - 缓冲区命中率: > 99%

  缓存:
    - 命中率: > 90%
    - 响应时间: < 10ms

  系统:
    - CPU使用率: < 80%
    - 内存使用率: < 85%
    - 磁盘使用率: < 85%
```

---

## 3. 常见故障

### 3.1 应用无法启动

#### 症状
```bash
# 启动服务失败
systemctl start worktool-api
# Job for worktool-api.service failed.

# 服务立即退出
systemctl status worktool-api
# Active: inactive (dead)
```

#### 可能原因
```
1. 端口被占用
2. 配置文件错误
3. 数据库连接失败
4. 环境变量缺失
5. 依赖包缺失
```

#### 排查步骤

```bash
# 1. 检查端口占用
ss -tuln | grep 5000
# 如果端口被占用，找到进程并关闭
lsof -i:5000 | grep LISTEN
kill -9 <PID>

# 2. 检查配置文件
worktool config validate
# 如果配置错误，查看具体错误
cat /etc/worktool/config.toml

# 3. 检查数据库连接
psql -U worktool -d worktool_ai -c "SELECT 1;"
# 如果连接失败，检查数据库状态
systemctl status postgresql

# 4. 检查环境变量
env | grep WORKTOOL
# 查看配置文件中的环境变量
cat /etc/worktool/config.toml | grep -E "host|port|user|password"

# 5. 检查依赖
npm list
# 如果依赖缺失，重新安装
npm install

# 6. 查看详细日志
journalctl -u worktool-api -n 100
tail -100 /var/log/worktool/api-error.log
```

#### 解决方案

```bash
# 场景1：端口被占用
netstat -tuln | grep 5000
kill -9 <PID>
systemctl start worktool-api

# 场景2：配置文件错误
cp /etc/worktool/config.toml.bak /etc/worktool/config.toml
vim /etc/worktool/config.toml
systemctl restart worktool-api

# 场景3：数据库连接失败
systemctl start postgresql
systemctl restart worktool-api

# 场景4：依赖缺失
cd /opt/worktool
npm install
systemctl restart worktool-api
```

### 3.2 数据库连接失败

#### 症状
```javascript
// 应用日志显示
Error: connect ECONNREFUSED 127.0.0.1:5432

// 健康检查失败
{
  "status": "unhealthy",
  "checks": {
    "database": "failed"
  }
}
```

#### 可能原因
```
1. 数据库服务未启动
2. 连接数达到上限
3. 网络不可达
4. 用户名/密码错误
5. 数据库不存在
6. 防火墙拦截
```

#### 排查步骤

```bash
# 1. 检查数据库服务状态
systemctl status postgresql

# 2. 检查数据库连接数
psql -U worktool -d worktool_ai -c "SELECT count(*) FROM pg_stat_activity;"

# 3. 检查最大连接数限制
psql -U postgres -d postgres -c "SHOW max_connections;"

# 4. 测试网络连接
ping localhost
telnet localhost 5432

# 5. 检查防火墙
iptables -L -n | grep 5432
firewall-cmd --list-ports

# 6. 测试连接
psql -U worktool -d worktool_ai -c "SELECT 1;"
```

#### 解决方案

```bash
# 场景1：数据库服务未启动
systemctl start postgresql
systemctl enable postgresql

# 场景2：连接数达到上限
# 查看当前连接
psql -U worktool -d worktool_ai -c "SELECT * FROM pg_stat_activity;"
# 终止空闲连接
psql -U postgres -d postgres -c "SELECT pg_terminate_backend(pid) FROM pg_stat_activity WHERE state = 'idle';"

# 场景3：防火墙拦截
firewall-cmd --add-port=5432/tcp --permanent
firewall-cmd --reload

# 场景4：增加最大连接数
vim /etc/postgresql/15/main/postgresql.conf
# 修改 max_connections = 100
systemctl restart postgresql
```

### 3.3 Redis连接失败

#### 症状
```javascript
// 应用日志显示
Error: Connection refused to Redis

// 健康检查失败
{
  "status": "unhealthy",
  "checks": {
    "redis": "failed"
  }
}
```

#### 可能原因
```
1. Redis服务未启动
2. 内存不足
3. 最大连接数达到上限
4. 密码错误
5. 网络不可达
```

#### 排查步骤

```bash
# 1. 检查Redis服务状态
systemctl status redis

# 2. 测试Redis连接
redis-cli ping

# 3. 检查Redis配置
redis-cli INFO server | grep redis_version

# 4. 检查内存使用
redis-cli INFO memory | grep used_memory_human

# 5. 检查连接数
redis-cli INFO clients | grep connected_clients
```

#### 解决方案

```bash
# 场景1：Redis服务未启动
systemctl start redis
systemctl enable redis

# 场景2：内存不足
# 清理过期键
redis-cli --scan --pattern "temp:*" | xargs redis-cli del
# 或者重启Redis释放内存
systemctl restart redis

# 场景3：连接数达到上限
# 查看客户端列表
redis-cli CLIENT LIST
# 关闭空闲客户端
redis-cli --scan --pattern "temp:*" | xargs redis-cli del
```

### 3.4 性能问题

#### 症状
```
1. API响应时间 > 3秒
2. 页面加载缓慢
3. CPU/内存使用率过高
4. 数据库查询缓慢
```

#### 可能原因
```
1. 数据库慢查询
2. 缓存未命中
3. 并发量过大
4. 资源不足
5. 代码逻辑问题
```

#### 排查步骤

```bash
# 1. 检查系统资源
top
htop
free -h

# 2. 检查应用性能
curl -w "@curl-format.txt" http://localhost:5000/api/sessions

# 3. 检查数据库慢查询
tail -50 /var/log/postgresql/postgresql-slow.log

# 4. 检查缓存命中率
redis-cli INFO stats | grep keyspace_hits
redis-cli INFO stats | grep keyspace_misses

# 5. 检查网络
ping -c 10 localhost
iperf3 -c localhost
```

#### 解决方案

```sql
-- 场景1：数据库慢查询
-- 1. 启用慢查询日志
ALTER SYSTEM SET log_min_duration_statement = '1000';
SELECT pg_reload_conf();

-- 2. 分析慢查询
SELECT query, mean_exec_time, calls
FROM pg_stat_statements
ORDER BY mean_exec_time DESC
LIMIT 10;

-- 3. 创建索引
CREATE INDEX CONCURRENTLY idx_session_messages_user_id_timestamp
ON session_messages(user_id, timestamp DESC);

-- 4. 更新统计信息
ANALYZE;

-- 场景2：缓存未命中
-- 优化缓存策略，增加缓存时间
-- 或使用预热机制
```

### 3.5 AI调用失败

#### 症状
```javascript
// 应用日志显示
Error: AI service unavailable
Error: Rate limit exceeded
Error: Invalid API key
```

#### 可能原因
```
1. API密钥失效
2. 配额用尽
3. 网络问题
4. AI服务故障
5. 请求格式错误
```

#### 排查步骤

```bash
# 1. 检查AI配置
cat /etc/worktool/config.toml | grep -A 5 "\[ai\]"

# 2. 测试AI连接
curl https://api.openai.com/v1/models \
  -H "Authorization: Bearer YOUR_API_KEY"

# 3. 检查AI调用日志
tail -50 /var/log/worktool/ai.log

# 4. 检查配额
curl https://api.openai.com/v1/usage \
  -H "Authorization: Bearer YOUR_API_KEY"
```

#### 解决方案

```bash
# 场景1：API密钥失效
# 更新API密钥
vim /etc/worktool/config.toml
# 修改 [ai] 部分
systemctl reload worktool-api

# 场景2：配额用尽
# 联系AI服务商增加配额
# 或优化调用频率，减少不必要的调用

# 场景3：网络问题
# 检查网络连接
curl -I https://api.openai.com
# 配置代理（如果需要）
export https_proxy=http://proxy:port
```

---

## 4. 故障排查工具

### 4.1 系统工具

```bash
# 系统监控
top          # 实时系统监控
htop         # 交互式进程管理
iotop        # 磁盘I/O监控
iftop        # 网络流量监控

# 系统分析
vmstat       # 虚拟内存统计
iostat       # CPU和I/O统计
sar          # 系统活动报告
dstat        # 全能统计工具

# 网络工具
ping         # 网络连通性测试
traceroute   # 路由追踪
netstat      # 网络统计
ss           # 套接字统计
tcpdump      # 抓包工具
```

### 4.2 数据库工具

```bash
# PostgreSQL工具
psql         # 命令行客户端
pg_dump      # 数据库备份
pg_restore   # 数据库恢复
pgbench      # 性能测试
pg_stat_statements # 查询统计

# 监控查询
-- 查看活跃查询
SELECT * FROM pg_stat_activity WHERE state = 'active';

-- 查看锁等待
SELECT * FROM pg_stat_activity WHERE wait_event_type = 'Lock';

-- 查看表大小
SELECT
  relname AS table_name,
  pg_size_pretty(pg_total_relation_size(relid)) AS size
FROM pg_catalog.pg_statio_user_tables
ORDER BY pg_total_relation_size(relid) DESC;
```

### 4.3 日志工具

```bash
# 日志查看
journalctl    # 系统日志
tail -f       # 实时查看
grep          # 搜索日志
awk           # 日志分析

# 日志分析
# 统计错误数量
grep ERROR /var/log/worktool/api-error.log | wc -l

# 统计响应时间
grep "duration" /var/log/worktool/api.log | awk '{print $NF}' | sort -n | tail -10

# 统计QPS
grep "$(date +%Y-%m-%d)" /var/log/worktool/api-access.log | wc -l
```

---

## 5. 故障上报流程

### 5.1 故障上报模板

```markdown
# 故障报告

## 基本信息
- 故障ID: ALT-2024-01-10-001
- 故障级别: P0/P1/P2/P3
- 发现时间: 2024-01-10 10:00:00
- 上报人: 姓名
- 联系方式: 电话/邮箱

## 故障描述
[简要描述故障现象]

## 影响范围
- 影响用户: 全部/部分/个别
- 影响功能: [具体功能列表]
- 影响程度: [严重/中等/轻微]

## 初步诊断
[初步判断的故障原因]

## 排查过程
[详细的排查步骤和结果]

## 当前状态
- [ ] 已定位
- [ ] 处理中
- [ ] 已解决
- [ ] 待验证

## 备注
[其他需要说明的信息]
```

### 5.2 上报渠道

```
P0/P1级故障:
1. 电话：立即通知相关负责人
2. IM群：发送到技术支持群
3. 邮件：发送故障报告邮件

P2/P3级故障:
1. IM群：发送到技术支持群
2. 邮件：发送故障报告邮件
3. 工单系统：创建故障工单
```

### 5.3 响应时间要求

```
P0级故障:
- 响应时间: 15分钟内
- 处理时间: 2小时内
- 恢复时间: 4小时内

P1级故障:
- 响应时间: 30分钟内
- 处理时间: 4小时内
- 恢复时间: 8小时内

P2级故障:
- 响应时间: 2小时内
- 处理时间: 1个工作日内
- 恢复时间: 2个工作日内

P3级故障:
- 响应时间: 1个工作日内
- 处理时间: 2个工作日内
- 恢复时间: 5个工作日内
```

---

## 6. 故障预防

### 6.1 监控告警

```yaml
实时监控:
  - 服务状态
  - 性能指标
  - 资源使用
  - 业务指标

告警规则:
  - 服务异常: 立即告警
  - 性能下降: 告警
  - 资源不足: 告警
  - 业务异常: 告警

告警渠道:
  - IM通知
  - 邮件通知
  - 短信通知
  - 电话通知
```

### 6.2 定期维护

```yaml
每日维护:
  - 服务状态检查
  - 错误日志检查
  - 资源使用检查
  - 备份完整性检查

每周维护:
  - 日志清理
  - 数据库清理
  - 索引重建
  - 性能分析

每月维护:
  - 安全扫描
  - 容量规划
  - 备份验证
  - 灾备演练
```

### 6.3 灾备方案

```yaml
备份策略:
  - 数据库: 每日全量+每小时增量
  - 应用: 每日备份
  - 配置: 版本控制
  - 代码: Git版本管理

灾备演练:
  - 每季度演练
  - 模拟故障场景
  - 验证恢复流程
  - 更新预案

恢复流程:
  - 确认故障
  - 评估影响
  - 启动恢复
  - 验证结果
  - 总结改进
```

---

**文档版本**：v1.0

**最后更新**：2024-01-10

**文档作者**：WorkTool AI 团队
