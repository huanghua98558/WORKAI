# WorkTool AI ä¸­æ¢ç³»ç»Ÿ - æ¨¡å—å‡çº§è¯¦è§£ï¼ˆAIåˆ†ææµç¨‹ç¯‡ï¼‰

## ğŸ“‹ ç›®å½•

1. [AIåˆ†æç³»ç»Ÿæ¦‚è¿°](#1-aiåˆ†æç³»ç»Ÿæ¦‚è¿°)
2. [æ„å›¾è¯†åˆ«](#2-æ„å›¾è¯†åˆ«)
3. [æƒ…æ„Ÿåˆ†æ](#3-æƒ…æ„Ÿåˆ†æ)
4. [å›å¤ç”Ÿæˆ](#4-å›å¤ç”Ÿæˆ)
5. [å‘Šè­¦åˆ¤æ–­](#5-å‘Šè­¦åˆ¤æ–­)
6. [ä»‹å…¥åˆ¤æ–­](#6-ä»‹å…¥åˆ¤æ–­)
7. [AIåˆ†ææµç¨‹](#7-aiåˆ†ææµç¨‹)

---

## 1. AIåˆ†æç³»ç»Ÿæ¦‚è¿°

### 1.1 ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           AIåˆ†æç³»ç»Ÿ                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  è¾“å…¥å±‚ (Input Layer)                                                 â”‚  â”‚
â”‚  â”‚  - æ–°æ¶ˆæ¯ï¼ˆç”¨æˆ·å‘é€çš„æ¶ˆæ¯ï¼‰                                            â”‚  â”‚
â”‚  â”‚  - ä¸Šä¸‹æ–‡ï¼ˆå†å²æ¶ˆæ¯ã€ç”¨æˆ·ç”»åƒã€å”®åä»»åŠ¡ç­‰ï¼‰                             â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                    â†“                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  åˆ†æå±‚ (Analysis Layer)                                              â”‚  â”‚
â”‚  â”‚  - æ„å›¾è¯†åˆ« (Intent Recognition)                                       â”‚  â”‚
â”‚  â”‚  - æƒ…æ„Ÿåˆ†æ (Sentiment Analysis)                                       â”‚  â”‚
â”‚  â”‚  - ä¼˜å…ˆçº§åˆ¤æ–­ (Priority Judgment)                                      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                    â†“                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  å†³ç­–å±‚ (Decision Layer)                                              â”‚  â”‚
â”‚  â”‚  - å‘Šè­¦åˆ¤æ–­ (Alert Judgment)                                           â”‚  â”‚
â”‚  â”‚  - ä»‹å…¥åˆ¤æ–­ (Intervention Judgment)                                    â”‚  â”‚
â”‚  â”‚  - å›å¤ç”Ÿæˆå†³ç­– (Reply Generation Decision)                            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                    â†“                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  è¾“å‡ºå±‚ (Output Layer)                                                 â”‚  â”‚
â”‚  â”‚  - intent: æ„å›¾ç±»å‹ï¼ˆdaily_chat, after_sales, complaint, queryï¼‰       â”‚  â”‚
â”‚  â”‚  - sentiment: æƒ…æ„Ÿï¼ˆpositive, neutral, negativeï¼‰                      â”‚  â”‚
â”‚  â”‚  - sentimentIntensity: æƒ…æ„Ÿå¼ºåº¦ï¼ˆlow, medium, highï¼‰                   â”‚  â”‚
â”‚  â”‚  - priority: ä¼˜å…ˆçº§ï¼ˆP0, P1, P2, P3ï¼‰                                  â”‚  â”‚
â”‚  â”‚  - needReply: æ˜¯å¦éœ€è¦å›å¤                                              â”‚  â”‚
â”‚  â”‚  - needAlert: æ˜¯å¦éœ€è¦å‘Šè­¦                                              â”‚  â”‚
â”‚  â”‚  - needIntervention: æ˜¯å¦éœ€è¦äººå·¥ä»‹å…¥                                   â”‚  â”‚
â”‚  â”‚  - alertLevel: å‘Šè­¦ç­‰çº§ï¼ˆP0, P1, P2, P3ï¼‰                              â”‚  â”‚
â”‚  â”‚  - alertReason: å‘Šè­¦åŸå›                                                â”‚  â”‚
â”‚  â”‚  - interventionReason: ä»‹å…¥åŸå›                                         â”‚  â”‚
â”‚  â”‚  - replySuggestion: å›å¤å»ºè®®                                            â”‚  â”‚
â”‚  â”‚  - taskType: å”®åä»»åŠ¡ç±»å‹ï¼ˆå¦‚æœæœ‰ï¼‰                                     â”‚  â”‚
â”‚  â”‚  - taskDescription: ä»»åŠ¡æè¿°ï¼ˆå¦‚æœæœ‰ï¼‰                                  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 AIåˆ†æèƒ½åŠ›çŸ©é˜µ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    åˆ†æèƒ½åŠ›       â”‚    è¾“å…¥ä¿¡æ¯     â”‚    è¾“å‡ºç»“æœ     â”‚    åº”ç”¨åœºæ™¯     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ„å›¾è¯†åˆ«          â”‚ æ¶ˆæ¯å†…å®¹+ä¸Šä¸‹æ–‡  â”‚ æ„å›¾ç±»å‹        â”‚ åˆ†æµå¤„ç†        â”‚
â”‚ æƒ…æ„Ÿåˆ†æ          â”‚ æ¶ˆæ¯å†…å®¹        â”‚ æƒ…æ„Ÿ+å¼ºåº¦       â”‚ å‘Šè­¦åˆ¤æ–­        â”‚
â”‚ ä¼˜å…ˆçº§åˆ¤æ–­        â”‚ æ„å›¾+æƒ…æ„Ÿ+ä¸Šä¸‹æ–‡ â”‚ ä¼˜å…ˆçº§          â”‚ èµ„æºåˆ†é…        â”‚
â”‚ å‘Šè­¦åˆ¤æ–­          â”‚ æƒ…æ„Ÿ+å¼ºåº¦+å†å²   â”‚ å‘Šè­¦+ç­‰çº§       â”‚ å”¤é†’äººå·¥        â”‚
â”‚ ä»‹å…¥åˆ¤æ–­          â”‚ æƒ…æ„Ÿ+å†å²+çŠ¶æ€   â”‚ ä»‹å…¥+åŸå›        â”‚ äººå·¥ååŒ        â”‚
â”‚ å›å¤ç”Ÿæˆ          â”‚ æ„å›¾+ä¸Šä¸‹æ–‡     â”‚ å›å¤å»ºè®®        â”‚ è‡ªåŠ¨å›å¤        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. æ„å›¾è¯†åˆ«

### 2.1 æ„å›¾åˆ†ç±»

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              æ„å›¾åˆ†ç±»                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  1. æ—¥å¸¸èŠå¤© (daily_chat)                                              â”‚  â”‚
â”‚  â”‚     - é—®å€™ã€é—²èŠã€è¡¨æƒ…                                                  â”‚  â”‚
â”‚  â”‚     - ä¸éœ€è¦ç‰¹æ®Šå¤„ç†                                                    â”‚  â”‚
â”‚  â”‚     - ä¼˜å…ˆçº§ï¼šP3                                                        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  2. å”®åä»»åŠ¡ (after_sales)                                              â”‚  â”‚
â”‚  â”‚     - é€€æ¬¾ã€æŠ•è¯‰ã€äº§å“é—®é¢˜ã€æœåŠ¡é—®é¢˜                                    â”‚  â”‚
â”‚  â”‚     - éœ€è¦åˆ›å»ºå”®åä»»åŠ¡                                                  â”‚  â”‚
â”‚  â”‚     - ä¼˜å…ˆçº§ï¼šP1 æˆ– P2                                                  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  3. ç”¨æˆ·æŠ•è¯‰ (complaint)                                                â”‚  â”‚
â”‚  â”‚     - ä¸¥é‡ä¸æ»¡ã€å¨èƒæŠ•è¯‰ã€å¤šæ¬¡é‡å¤                                      â”‚  â”‚
â”‚  â”‚     - éœ€è¦åˆ›å»ºP0å‘Šè­¦                                                    â”‚  â”‚
â”‚  â”‚     - ä¼˜å…ˆçº§ï¼šP0                                                        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  4. æŸ¥è¯¢å’¨è¯¢ (query)                                                    â”‚  â”‚
â”‚  â”‚     - äº§å“å’¨è¯¢ã€ä»·æ ¼å’¨è¯¢ã€åŠŸèƒ½å’¨è¯¢                                      â”‚  â”‚
â”‚  â”‚     - éœ€è¦AIå›å¤                                                        â”‚  â”‚
â”‚  â”‚     - ä¼˜å…ˆçº§ï¼šP2                                                        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 æ„å›¾è¯†åˆ«Promptè®¾è®¡

**æ–‡ä»¶ä½ç½®ï¼š** `server/prompts/intent-recognition.prompt.txt`

```
# æ„å›¾è¯†åˆ«ä»»åŠ¡

## ä»»åŠ¡æè¿°
ä½ éœ€è¦è¯†åˆ«ç”¨æˆ·æ¶ˆæ¯çš„æ„å›¾ï¼Œåˆ¤æ–­æ¶ˆæ¯å±äºä»¥ä¸‹å“ªç§ç±»å‹ï¼š
1. daily_chat - æ—¥å¸¸èŠå¤©
2. after_sales - å”®åä»»åŠ¡
3. complaint - ç”¨æˆ·æŠ•è¯‰
4. query - æŸ¥è¯¢å’¨è¯¢

## è¾“å…¥ä¿¡æ¯
- ç”¨æˆ·æ¶ˆæ¯å†…å®¹
- å†å²ä¸Šä¸‹æ–‡ï¼ˆæœ€è¿‘Næ¡æ¶ˆæ¯ï¼‰
- ç”¨æˆ·ç”»åƒï¼ˆæ»¡æ„åº¦è¯„åˆ†ã€æŠ•è¯‰æ¬¡æ•°ï¼‰

## åˆ¤æ–­è§„åˆ™

### daily_chat (æ—¥å¸¸èŠå¤©)
- é—®å€™è¯­ï¼šä½ å¥½ã€å—¨ã€åœ¨å—ã€æ—©ä¸Šå¥½ã€æ™šå®‰ç­‰
- é—²èŠï¼šè¡¨æƒ…ç¬¦å·ã€æ— å…³ç´§è¦çš„å¯¹è¯
- é—²èŠè¯é¢˜ï¼šå¤©æ°”ã€å¿ƒæƒ…ã€æ—¥å¸¸çäº‹ç­‰

ç¤ºä¾‹ï¼š
- "ä½ å¥½" â†’ daily_chat
- "åœ¨å—ï¼Ÿ" â†’ daily_chat
- "ğŸ˜Š" â†’ daily_chat
- "ä»Šå¤©å¤©æ°”ä¸é”™" â†’ daily_chat

### after_sales (å”®åä»»åŠ¡)
- é€€æ¬¾ç›¸å…³ï¼šé€€æ¬¾ã€é€€é’±ã€æˆ‘è¦é€€æ¬¾ã€ç”³è¯·é€€æ¬¾
- æŠ•è¯‰ç›¸å…³ï¼šæŠ•è¯‰ã€æˆ‘è¦æŠ•è¯‰ã€ä½ ä»¬å¤ªå·®äº†
- äº§å“é—®é¢˜ï¼šåäº†ã€ä¸å·¥ä½œã€è´¨é‡é—®é¢˜ã€æ•…éšœ
- æœåŠ¡é—®é¢˜ï¼šæœåŠ¡å¤ªå·®ã€æ€åº¦ä¸å¥½ã€æ²¡äººç†æˆ‘
- äº¤æ˜“é—®é¢˜ï¼šè®¢å•é—®é¢˜ã€å‘è´§é—®é¢˜ã€åˆ°è´§é—®é¢˜

ç¤ºä¾‹ï¼š
- "æˆ‘è¦é€€æ¬¾" â†’ after_sales
- "äº§å“è´¨é‡å¤ªå·®äº†" â†’ after_sales
- "æˆ‘çš„è®¢å•ä¸ºä»€ä¹ˆè¿˜æ²¡å‘è´§" â†’ after_sales
- "ä½ ä»¬çš„æœåŠ¡å¤ªå·®äº†" â†’ after_sales

### complaint (ç”¨æˆ·æŠ•è¯‰)
- ä¸¥é‡ä¸æ»¡ï¼šéå¸¸ä¸æ»¡ã€æå…¶å¤±æœ›ã€æ°”æ­»æˆ‘äº†
- å¨èƒæŠ•è¯‰ï¼šæˆ‘è¦æŠ•è¯‰ä½ ä»¬ã€æˆ‘è¦å‘Šä½ ä»¬ã€æˆ‘ä¸€å®šè¦æ›å…‰ä½ ä»¬
- é‡å¤æŠ±æ€¨ï¼šå¤šæ¬¡è¡¨è¾¾ä¸æ»¡ï¼ˆå†å²æ¶ˆæ¯ä¸­æœ‰å¤šæ¬¡è´Ÿé¢æƒ…ç»ªï¼‰
- æç«¯è¯æ±‡ï¼šéª—å­ã€åƒåœ¾ã€ç³Ÿç³•é€é¡¶

ç¤ºä¾‹ï¼š
- "ä½ ä»¬è¿™ç¾¤éª—å­ï¼" â†’ complaint
- "æˆ‘ä¸€å®šè¦æ›å…‰ä½ ä»¬" â†’ complaint
- "å¤ªç³Ÿç³•äº†ï¼Œæˆ‘è¦æŠ•è¯‰ï¼" â†’ complaint

### query (æŸ¥è¯¢å’¨è¯¢)
- äº§å“å’¨è¯¢ï¼šè¿™ä¸ªäº§å“æ€ä¹ˆæ ·ã€æœ‰ä»€ä¹ˆåŠŸèƒ½ã€å¤šå°‘é’±
- ä»·æ ¼å’¨è¯¢ï¼šä»·æ ¼å¤šå°‘ã€æœ‰ä¼˜æƒ å—ã€èƒ½ä¾¿å®œç‚¹
- åŠŸèƒ½å’¨è¯¢ï¼šæ€ä¹ˆç”¨ã€å¦‚ä½•æ“ä½œã€åŠŸèƒ½è¯´æ˜
- æ”¿ç­–å’¨è¯¢ï¼šå”®åæ”¿ç­–ã€é€€æ¢è´§æ”¿ç­–ã€ä¿ä¿®æ”¿ç­–

ç¤ºä¾‹ï¼š
- "è¿™ä¸ªäº§å“å¤šå°‘é’±" â†’ query
- "æ€ä¹ˆé€€æ¢è´§" â†’ query
- "æœ‰ä»€ä¹ˆåŠŸèƒ½" â†’ query

## è¾“å‡ºæ ¼å¼
è¯·ä»¥JSONæ ¼å¼è¾“å‡ºï¼š

```json
{
  "intent": "æ„å›¾ç±»å‹",
  "confidence": 0.95,
  "reason": "åˆ¤æ–­åŸå› "
}
```

## ç¤ºä¾‹

### ç¤ºä¾‹1
è¾“å…¥ï¼š
- ç”¨æˆ·æ¶ˆæ¯ï¼š"æˆ‘è¦é€€æ¬¾"
- å†å²ä¸Šä¸‹æ–‡ï¼šæ— 
- ç”¨æˆ·ç”»åƒï¼šæ»¡æ„åº¦60åˆ†ï¼ŒæŠ•è¯‰æ¬¡æ•°0

è¾“å‡ºï¼š
```json
{
  "intent": "after_sales",
  "confidence": 0.98,
  "reason": "ç”¨æˆ·æ˜ç¡®è¡¨è¾¾äº†é€€æ¬¾éœ€æ±‚ï¼Œå±äºå”®åä»»åŠ¡"
}
```

### ç¤ºä¾‹2
è¾“å…¥ï¼š
- ç”¨æˆ·æ¶ˆæ¯ï¼š"ä½ ä»¬è¿™ç¾¤éª—å­ï¼"
- å†å²ä¸Šä¸‹æ–‡ï¼šæœ€è¿‘5æ¡æ¶ˆæ¯ä¸­æœ‰3æ¡è´Ÿé¢æƒ…ç»ª
- ç”¨æˆ·ç”»åƒï¼šæ»¡æ„åº¦30åˆ†ï¼ŒæŠ•è¯‰æ¬¡æ•°3

è¾“å‡ºï¼š
```json
{
  "intent": "complaint",
  "confidence": 0.95,
  "reason": "ç”¨æˆ·ä½¿ç”¨äº†æç«¯è´Ÿé¢è¯æ±‡ï¼Œç»“åˆå†å²è´Ÿé¢æƒ…ç»ªå’Œä½æ»¡æ„åº¦ï¼Œåˆ¤å®šä¸ºæŠ•è¯‰"
}
```

### ç¤ºä¾‹3
è¾“å…¥ï¼š
- ç”¨æˆ·æ¶ˆæ¯ï¼š"è¿™ä¸ªäº§å“å¤šå°‘é’±"
- å†å²ä¸Šä¸‹æ–‡ï¼šæ— 
- ç”¨æˆ·ç”»åƒï¼šæ»¡æ„åº¦70åˆ†ï¼ŒæŠ•è¯‰æ¬¡æ•°0

è¾“å‡ºï¼š
```json
{
  "intent": "query",
  "confidence": 0.92,
  "reason": "ç”¨æˆ·è¯¢é—®äº§å“ä»·æ ¼ï¼Œå±äºå’¨è¯¢æŸ¥è¯¢"
}
```

### ç¤ºä¾‹4
è¾“å…¥ï¼š
- ç”¨æˆ·æ¶ˆæ¯ï¼š"ä½ å¥½"
- å†å²ä¸Šä¸‹æ–‡ï¼šæ— 
- ç”¨æˆ·ç”»åƒï¼šæ»¡æ„åº¦80åˆ†ï¼ŒæŠ•è¯‰æ¬¡æ•°0

è¾“å‡ºï¼š
```json
{
  "intent": "daily_chat",
  "confidence": 0.90,
  "reason": "ç”¨æˆ·ä½¿ç”¨é—®å€™è¯­ï¼Œå±äºæ—¥å¸¸èŠå¤©"
}
```
```

### 2.3 æ„å›¾è¯†åˆ«å®ç°

**æ–‡ä»¶ä½ç½®ï¼š** `server/services/intent-recognition.service.js`

```javascript
const llmService = require('../lib/llm-service');
const logger = require('./system-logger.service');

class IntentRecognitionService {
  constructor() {
    this.promptTemplate = this.loadPromptTemplate();
  }

  /**
   * è¯†åˆ«æ„å›¾
   */
  async recognizeIntent(message, context) {
    try {
      logger.info('[æ„å›¾è¯†åˆ«] å¼€å§‹è¯†åˆ«æ„å›¾', {
        messageId: message.id,
        userId: message.userId,
      });

      // æ„å»ºPrompt
      const prompt = this.buildPrompt(message, context);

      // è°ƒç”¨LLM
      const llmResponse = await llmService.call(prompt);

      // è§£æç»“æœ
      const result = this.parseLLMResponse(llmResponse);

      logger.info('[æ„å›¾è¯†åˆ«] æ„å›¾è¯†åˆ«å®Œæˆ', {
        messageId: message.id,
        intent: result.intent,
        confidence: result.confidence,
      });

      return result;
    } catch (error) {
      logger.error('[æ„å›¾è¯†åˆ«] æ„å›¾è¯†åˆ«å¤±è´¥', {
        messageId: message.id,
        error: error.message,
        stack: error.stack,
      });
      throw error;
    }
  }

  /**
   * åŠ è½½Promptæ¨¡æ¿
   */
  loadPromptTemplate() {
    const fs = require('fs');
    const path = require('path');

    const promptPath = path.join(__dirname, '../prompts/intent-recognition.prompt.txt');
    const promptContent = fs.readFileSync(promptPath, 'utf-8');

    return promptContent;
  }

  /**
   * æ„å»ºPrompt
   */
  buildPrompt(message, context) {
    const userProfile = context.userProfile || {};
    const currentConversation = context.currentConversation || [];
    const afterSalesTasks = context.afterSalesTasks || [];

    // æ ¼å¼åŒ–å†å²æ¶ˆæ¯
    const historyText = currentConversation
      .map((msg, index) => `${index + 1}. [${msg.userName}]: ${msg.content}`)
      .join('\n');

    // æ ¼å¼åŒ–ç”¨æˆ·ç”»åƒ
    const userProfileText = userProfile ? `
      ç”¨æˆ·ç”»åƒï¼š
      - ç”¨æˆ·åï¼š${userProfile.username}
      - æ»¡æ„åº¦è¯„åˆ†ï¼š${userProfile.satisfactionScore}åˆ†
      - æŠ•è¯‰æ¬¡æ•°ï¼š${userProfile.complaintCount}æ¬¡
      - æ³¨å†Œæ—¶é—´ï¼š${userProfile.registeredAt}
    ` : '';

    // æ ¼å¼åŒ–å”®åä»»åŠ¡
    const afterSalesTasksText = afterSalesTasks.length > 0 ? `
      å”®åä»»åŠ¡ï¼š
      ${afterSalesTasks.map(task => `- ${task.taskType}: ${task.status}`).join('\n')}
    ` : '';

    // æ›¿æ¢Promptä¸­çš„å ä½ç¬¦
    let prompt = this.promptTemplate;

    prompt = prompt.replace(
      /## è¾“å…¥ä¿¡æ¯[\s\S]*?(?=\n## |$)/,
      `## è¾“å…¥ä¿¡æ¯
- ç”¨æˆ·æ¶ˆæ¯å†…å®¹ï¼š${message.content}
- å†å²ä¸Šä¸‹æ–‡ï¼š
${historyText || 'æ— '}
${userProfileText}
${afterSalesTasksText}`
    );

    return prompt;
  }

  /**
   * è§£æLLMå“åº”
   */
  parseLLMResponse(llmResponse) {
    try {
      // æå–JSONéƒ¨åˆ†
      const jsonMatch = llmResponse.match(/\{[\s\S]*\}/);

      if (!jsonMatch) {
        throw new Error('æ— æ³•è§£æLLMå“åº”ä¸­çš„JSON');
      }

      const result = JSON.parse(jsonMatch[0]);

      // éªŒè¯å¿…å¡«å­—æ®µ
      if (!result.intent || !result.confidence) {
        throw new Error('LLMå“åº”ç¼ºå°‘å¿…å¡«å­—æ®µ');
      }

      // éªŒè¯æ„å›¾ç±»å‹
      const validIntents = ['daily_chat', 'after_sales', 'complaint', 'query'];
      if (!validIntents.includes(result.intent)) {
        throw new Error(`æ— æ•ˆçš„æ„å›¾ç±»å‹ï¼š${result.intent}`);
      }

      // éªŒè¯ç½®ä¿¡åº¦
      if (result.confidence < 0 || result.confidence > 1) {
        throw new Error(`æ— æ•ˆçš„ç½®ä¿¡åº¦ï¼š${result.confidence}`);
      }

      return result;
    } catch (error) {
      logger.error('[æ„å›¾è¯†åˆ«] è§£æLLMå“åº”å¤±è´¥', {
        llmResponse,
        error: error.message,
      });

      // è¿”å›é»˜è®¤å€¼
      return {
        intent: 'daily_chat',
        confidence: 0.5,
        reason: 'è§£æå¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å€¼',
      };
    }
  }
}

module.exports = new IntentRecognitionService();
```

---

## 3. æƒ…æ„Ÿåˆ†æ

### 3.1 æƒ…æ„Ÿåˆ†ç±»

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              æƒ…æ„Ÿåˆ†ç±»                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  1. æ­£é¢ (positive)                                                    â”‚  â”‚
â”‚  â”‚     - è¡¨è¾¾æ»¡æ„ã€æ„Ÿè°¢ã€èµç¾                                              â”‚  â”‚
â”‚  â”‚     - å¼ºåº¦ï¼šlowï¼ˆä½ï¼‰ã€mediumï¼ˆä¸­ï¼‰ã€highï¼ˆé«˜ï¼‰                           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  2. ä¸­æ€§ (neutral)                                                     â”‚  â”‚
â”‚  â”‚     - è¡¨è¾¾å®¢è§‚äº‹å®ã€å’¨è¯¢                                                â”‚  â”‚
â”‚  â”‚     - å¼ºåº¦ï¼šlowï¼ˆä½ï¼‰                                                   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  3. è´Ÿé¢ (negative)                                                    â”‚  â”‚
â”‚  â”‚     - è¡¨è¾¾ä¸æ»¡ã€æŠ±æ€¨ã€æ„¤æ€’                                              â”‚  â”‚
â”‚  â”‚     - å¼ºåº¦ï¼šlowï¼ˆä½ï¼‰ã€mediumï¼ˆä¸­ï¼‰ã€highï¼ˆé«˜ï¼‰                           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 æƒ…æ„Ÿåˆ†æPromptè®¾è®¡

**æ–‡ä»¶ä½ç½®ï¼š** `server/prompts/sentiment-analysis.prompt.txt`

```
# æƒ…æ„Ÿåˆ†æä»»åŠ¡

## ä»»åŠ¡æè¿°
ä½ éœ€è¦åˆ†æç”¨æˆ·æ¶ˆæ¯çš„æƒ…æ„Ÿï¼Œåˆ¤æ–­æ¶ˆæ¯çš„æƒ…æ„Ÿç±»å‹å’Œå¼ºåº¦ã€‚

## æƒ…æ„Ÿç±»å‹

### positive (æ­£é¢)
- è¡¨è¾¾æ»¡æ„ï¼šæ»¡æ„ã€å–œæ¬¢ã€ä¸é”™ã€å¾ˆå¥½ã€å¤ªæ£’äº†
- è¡¨è¾¾æ„Ÿè°¢ï¼šè°¢è°¢ã€æ„Ÿè°¢ã€å¤šè°¢ã€æ„Ÿæ¿€
- è¡¨è¾¾èµç¾ï¼šæ¼‚äº®ã€ç¾è§‚ã€ä¸“ä¸šã€ä¼˜ç§€ã€å‰å®³

### neutral (ä¸­æ€§)
- è¡¨è¾¾äº‹å®ï¼šä»€ä¹ˆã€å“ªé‡Œã€ä¸ºä»€ä¹ˆ
- è¡¨è¾¾å’¨è¯¢ï¼šè¯·é—®ã€æƒ³é—®ã€å’¨è¯¢
- è¡¨è¾¾å®¢è§‚ï¼šæ˜¯ã€ä¸æ˜¯ã€å¯ä»¥ã€ä¸å¯ä»¥

### negative (è´Ÿé¢)
- è¡¨è¾¾ä¸æ»¡ï¼šä¸æ»¡ã€å¤±æœ›ã€éš¾è¿‡ã€é—æ†¾
- è¡¨è¾¾æŠ±æ€¨ï¼šå¤ªå·®äº†ã€ç³Ÿç³•ã€ä¸è¡Œã€ä¸è¡Œå•Š
- è¡¨è¾¾æ„¤æ€’ï¼šç”Ÿæ°”ã€æ„¤æ€’ã€æ°”æ­»æˆ‘äº†ã€è®¨åŒ

## æƒ…æ„Ÿå¼ºåº¦

### low (ä½)
- è½»å¾®çš„æƒ…æ„Ÿè¡¨è¾¾
- ç¤¼è²Œçš„æ„Ÿè°¢æˆ–æŠ±æ€¨
- å®¢è§‚çš„æè¿°

### medium (ä¸­)
- æ˜æ˜¾çš„æƒ…æ„Ÿè¡¨è¾¾
- æ¸…æ™°çš„æ»¡æ„æˆ–ä¸æ»¡
- å¸¸è§çš„è´Ÿé¢è¯æ±‡

### high (é«˜)
- å¼ºçƒˆçš„æƒ…æ„Ÿè¡¨è¾¾
- æç«¯çš„æ­£é¢æˆ–è´Ÿé¢è¯æ±‡
- å¤šæ¬¡é‡å¤çš„è¡¨è¾¾
- è¡¨æƒ…ç¬¦å·åŠ å¼ºï¼ˆğŸ˜ ğŸ˜¡ğŸ˜­ï¼‰

## è¾“å‡ºæ ¼å¼
è¯·ä»¥JSONæ ¼å¼è¾“å‡ºï¼š

```json
{
  "sentiment": "æƒ…æ„Ÿç±»å‹",
  "intensity": "æƒ…æ„Ÿå¼ºåº¦",
  "confidence": 0.95,
  "reason": "åˆ†æåŸå› "
}
```

## ç¤ºä¾‹

### ç¤ºä¾‹1
è¾“å…¥ï¼š"ä½ ä»¬çš„æœåŠ¡çœŸçš„å¤ªæ£’äº†ï¼éå¸¸æ»¡æ„ï¼"

è¾“å‡ºï¼š
```json
{
  "sentiment": "positive",
  "intensity": "high",
  "confidence": 0.98,
  "reason": "ä½¿ç”¨äº†å¼ºçƒˆçš„æ­£é¢è¯æ±‡'å¤ªæ£’äº†'å’Œ'éå¸¸æ»¡æ„'"
}
```

### ç¤ºä¾‹2
è¾“å…¥ï¼š"è¿™ä¸ªäº§å“å¤šå°‘é’±"

è¾“å‡ºï¼š
```json
{
  "sentiment": "neutral",
  "intensity": "low",
  "confidence": 0.95,
  "reason": "è¿™æ˜¯ä¸€ä¸ªå®¢è§‚çš„ä»·æ ¼å’¨è¯¢ï¼Œæ²¡æœ‰æƒ…æ„Ÿè¡¨è¾¾"
}
```

### ç¤ºä¾‹3
è¾“å…¥ï¼š"ä½ ä»¬è¿™ç¾¤éª—å­ï¼æ°”æ­»æˆ‘äº†ï¼ğŸ˜¡"

è¾“å‡ºï¼š
```json
{
  "sentiment": "negative",
  "intensity": "high",
  "confidence": 0.99,
  "reason": "ä½¿ç”¨äº†æç«¯è´Ÿé¢è¯æ±‡'éª—å­'å’Œ'æ°”æ­»æˆ‘äº†'ï¼Œå¹¶æœ‰æ„¤æ€’è¡¨æƒ…"
}
```

### ç¤ºä¾‹4
è¾“å…¥ï¼š"ä¸å¤ªæ»¡æ„"

è¾“å‡ºï¼š
```json
{
  "sentiment": "negative",
  "intensity": "low",
  "confidence": 0.85,
  "reason": "è¡¨è¾¾äº†ä¸æ»¡æ„ï¼Œä½†è¯­æ°”è¾ƒç¼“å’Œ"
}
```
```

### 3.3 æƒ…æ„Ÿåˆ†æå®ç°

**æ–‡ä»¶ä½ç½®ï¼š** `server/services/sentiment-analysis.service.js`

```javascript
const llmService = require('../lib/llm-service');
const logger = require('./system-logger.service');

class SentimentAnalysisService {
  constructor() {
    this.promptTemplate = this.loadPromptTemplate();
  }

  /**
   * åˆ†ææƒ…æ„Ÿ
   */
  async analyzeSentiment(message) {
    try {
      logger.info('[æƒ…æ„Ÿåˆ†æ] å¼€å§‹åˆ†ææƒ…æ„Ÿ', {
        messageId: message.id,
        userId: message.userId,
      });

      // æ„å»ºPrompt
      const prompt = this.buildPrompt(message);

      // è°ƒç”¨LLM
      const llmResponse = await llmService.call(prompt);

      // è§£æç»“æœ
      const result = this.parseLLMResponse(llmResponse);

      logger.info('[æƒ…æ„Ÿåˆ†æ] æƒ…æ„Ÿåˆ†æå®Œæˆ', {
        messageId: message.id,
        sentiment: result.sentiment,
        intensity: result.intensity,
      });

      return result;
    } catch (error) {
      logger.error('[æƒ…æ„Ÿåˆ†æ] æƒ…æ„Ÿåˆ†æå¤±è´¥', {
        messageId: message.id,
        error: error.message,
        stack: error.stack,
      });
      throw error;
    }
  }

  /**
   * åŠ è½½Promptæ¨¡æ¿
   */
  loadPromptTemplate() {
    const fs = require('fs');
    const path = require('path');

    const promptPath = path.join(__dirname, '../prompts/sentiment-analysis.prompt.txt');
    const promptContent = fs.readFileSync(promptPath, 'utf-8');

    return promptContent;
  }

  /**
   * æ„å»ºPrompt
   */
  buildPrompt(message) {
    return `
${this.promptTemplate}

è¯·åˆ†æä»¥ä¸‹æ¶ˆæ¯çš„æƒ…æ„Ÿï¼š

æ¶ˆæ¯å†…å®¹ï¼š${message.content}

è¯·æŒ‰ç…§ä¸Šè¿°æ ¼å¼è¾“å‡ºJSONç»“æœã€‚
`;
  }

  /**
   * è§£æLLMå“åº”
   */
  parseLLMResponse(llmResponse) {
    try {
      // æå–JSONéƒ¨åˆ†
      const jsonMatch = llmResponse.match(/\{[\s\S]*\}/);

      if (!jsonMatch) {
        throw new Error('æ— æ³•è§£æLLMå“åº”ä¸­çš„JSON');
      }

      const result = JSON.parse(jsonMatch[0]);

      // éªŒè¯å¿…å¡«å­—æ®µ
      if (!result.sentiment || !result.intensity || !result.confidence) {
        throw new Error('LLMå“åº”ç¼ºå°‘å¿…å¡«å­—æ®µ');
      }

      // éªŒè¯æƒ…æ„Ÿç±»å‹
      const validSentiments = ['positive', 'neutral', 'negative'];
      if (!validSentiments.includes(result.sentiment)) {
        throw new Error(`æ— æ•ˆçš„æƒ…æ„Ÿç±»å‹ï¼š${result.sentiment}`);
      }

      // éªŒè¯æƒ…æ„Ÿå¼ºåº¦
      const validIntensities = ['low', 'medium', 'high'];
      if (!validIntensities.includes(result.intensity)) {
        throw new Error(`æ— æ•ˆçš„æƒ…æ„Ÿå¼ºåº¦ï¼š${result.intensity}`);
      }

      // éªŒè¯ç½®ä¿¡åº¦
      if (result.confidence < 0 || result.confidence > 1) {
        throw new Error(`æ— æ•ˆçš„ç½®ä¿¡åº¦ï¼š${result.confidence}`);
      }

      return result;
    } catch (error) {
      logger.error('[æƒ…æ„Ÿåˆ†æ] è§£æLLMå“åº”å¤±è´¥', {
        llmResponse,
        error: error.message,
      });

      // è¿”å›é»˜è®¤å€¼
      return {
        sentiment: 'neutral',
        intensity: 'low',
        confidence: 0.5,
        reason: 'è§£æå¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å€¼',
      };
    }
  }
}

module.exports = new SentimentAnalysisService();
```

---

## 4. å›å¤ç”Ÿæˆ

### 4.1 å›å¤ç­–ç•¥

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              å›å¤ç­–ç•¥                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  1. æ—¥å¸¸èŠå¤©å›å¤                                                       â”‚  â”‚
â”‚  â”‚     - é—®å€™å›å¤ï¼šæ ‡å‡†é—®å€™è¯­                                              â”‚  â”‚
â”‚  â”‚     - é—²èŠå›å¤ï¼šå‹å¥½çš„ç®€å•å›å¤                                          â”‚  â”‚
â”‚  â”‚     - è¡¨æƒ…å›å¤ï¼šåŒ¹é…è¡¨æƒ…                                                 â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  2. æŸ¥è¯¢å’¨è¯¢å›å¤                                                       â”‚  â”‚
â”‚  â”‚     - åŸºäºçŸ¥è¯†åº“çš„å›ç­”                                                  â”‚  â”‚
â”‚  â”‚     - å¼•å¯¼ç”¨æˆ·è·å–æ›´å¤šä¿¡æ¯                                              â”‚  â”‚
â”‚  â”‚     - è½¬æ¥äººå·¥ï¼ˆå¦‚éœ€è¦ï¼‰                                                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  3. å”®åä»»åŠ¡å›å¤                                                       â”‚  â”‚
â”‚  â”‚     - ç¡®è®¤é—®é¢˜                                                         â”‚  â”‚
â”‚  â”‚     - å®‰æŠšç”¨æˆ·æƒ…ç»ª                                                     â”‚  â”‚
â”‚  â”‚     - å‘ŠçŸ¥å¤„ç†æµç¨‹                                                     â”‚  â”‚
â”‚  â”‚     - è½¬æ¥äººå·¥å”®å                                                     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  4. æŠ•è¯‰å®‰æŠšå›å¤                                                       â”‚  â”‚
â”‚  â”‚     - æ·±åˆ»é“æ­‰                                                         â”‚  â”‚
â”‚  â”‚     - å…±æƒ…ç†è§£                                                         â”‚  â”‚
â”‚  â”‚     - æ‰¿è¯ºå°½å¿«å¤„ç†                                                     â”‚  â”‚
â”‚  â”‚     - ä¼˜å…ˆè½¬æ¥äººå·¥                                                     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 å›å¤ç”ŸæˆPromptè®¾è®¡

**æ–‡ä»¶ä½ç½®ï¼š** `server/prompts/reply-generation.prompt.txt`

```
# å›å¤ç”Ÿæˆä»»åŠ¡

## ä»»åŠ¡æè¿°
æ ¹æ®ç”¨æˆ·æ¶ˆæ¯å’Œä¸Šä¸‹æ–‡ï¼Œç”Ÿæˆåˆé€‚çš„å›å¤ã€‚

## å›å¤åŸåˆ™

### 1. å‹å¥½ç¤¼è²Œ
- ä½¿ç”¨ç¤¼è²Œç”¨è¯­ï¼ˆæ‚¨å¥½ã€è¯·é—®ã€è°¢è°¢ï¼‰
- è¯­æ°”æ¸©å’Œã€çœŸè¯š
- è¡¨è¾¾ç†è§£å’Œå…³å¿ƒ

### 2. å‡†ç¡®ä¸“ä¸š
- å›ç­”è¦å‡†ç¡®ã€æœ‰æ®
- ä¸“ä¸šæœ¯è¯­è¦è§£é‡Šæ¸…æ¥š
- ä¸ç¡®å®šæ—¶ä¸»åŠ¨è½¬æ¥äººå·¥

### 3. é«˜æ•ˆç®€æ´
- å›å¤è¦ç®€æ´æ˜äº†
- é¿å…å†—é•¿å•°å—¦
- ç›´æ¥å›ç­”ç”¨æˆ·é—®é¢˜

### 4. ä¸ªæ€§åŒ–
- æ ¹æ®ç”¨æˆ·ç”»åƒè°ƒæ•´è¯­æ°”
- å‚è€ƒå†å²å¯¹è¯ä¸Šä¸‹æ–‡
- ä¿æŒå¯¹è¯è¿è´¯æ€§

## å›å¤ç­–ç•¥

### daily_chat (æ—¥å¸¸èŠå¤©)
- é—®å€™ï¼šå›å¤å‹å¥½çš„é—®å€™
- é—²èŠï¼šç®€çŸ­å‹å¥½çš„å›å¤
- è¡¨æƒ…ï¼šå›å¤ç›¸åº”çš„è¡¨æƒ…

### query (æŸ¥è¯¢å’¨è¯¢)
- æŸ¥è¯¢çŸ¥è¯†åº“ï¼Œæä¾›å‡†ç¡®ç­”æ¡ˆ
- å¦‚ä¸ç¡®å®šï¼Œå¼•å¯¼ç”¨æˆ·å’¨è¯¢äººå·¥
- æä¾›ç›¸å…³å¸®åŠ©ä¿¡æ¯

### after_sales (å”®åä»»åŠ¡)
- è¡¨è¾¾ç†è§£å’Œæ­‰æ„
- ç¡®è®¤é—®é¢˜ç»†èŠ‚
- å‘ŠçŸ¥å¤„ç†æµç¨‹
- æ‰¿è¯ºå°½å¿«å¤„ç†
- è½¬æ¥äººå·¥å”®å

### complaint (ç”¨æˆ·æŠ•è¯‰)
- æ·±åˆ»é“æ­‰
- è¡¨è¾¾ç†è§£
- æ‰¿è¯ºå°½å¿«å¤„ç†
- è½¬æ¥äººå·¥å¤„ç†

## è¾“å‡ºæ ¼å¼
è¯·ä»¥JSONæ ¼å¼è¾“å‡ºï¼š

```json
{
  "reply": "å›å¤å†…å®¹",
  "needReply": true,
  "reason": "å›å¤åŸå› "
}
```

## ç¤ºä¾‹

### ç¤ºä¾‹1 - æ—¥å¸¸èŠå¤©
è¾“å…¥ï¼š
- ç”¨æˆ·æ¶ˆæ¯ï¼š"ä½ å¥½"
- æ„å›¾ï¼šdaily_chat
- æƒ…æ„Ÿï¼šneutral

è¾“å‡ºï¼š
```json
{
  "reply": "æ‚¨å¥½ï¼æœ‰ä»€ä¹ˆæˆ‘å¯ä»¥å¸®åŠ©æ‚¨çš„å—ï¼Ÿ",
  "needReply": true,
  "reason": "ç”¨æˆ·é—®å€™ï¼Œå›å¤å‹å¥½é—®å€™"
}
```

### ç¤ºä¾‹2 - æŸ¥è¯¢å’¨è¯¢
è¾“å…¥ï¼š
- ç”¨æˆ·æ¶ˆæ¯ï¼š"è¿™ä¸ªäº§å“å¤šå°‘é’±"
- æ„å›¾ï¼šquery
- æƒ…æ„Ÿï¼šneutral

è¾“å‡ºï¼š
```json
{
  "reply": "æ‚¨å¥½ï¼è¿™æ¬¾äº§å“çš„ä»·æ ¼æ˜¯XXXå…ƒã€‚å¦‚éœ€äº†è§£æ›´å¤šè¯¦æƒ…æˆ–è´­ä¹°ï¼Œè¯·éšæ—¶è”ç³»æˆ‘ä»¬çš„å®¢æœã€‚",
  "needReply": true,
  "reason": "ç”¨æˆ·å’¨è¯¢äº§å“ä»·æ ¼ï¼Œæä¾›ä»·æ ¼ä¿¡æ¯"
}
```

### ç¤ºä¾‹3 - å”®åä»»åŠ¡
è¾“å…¥ï¼š
- ç”¨æˆ·æ¶ˆæ¯ï¼š"æˆ‘è¦é€€æ¬¾"
- æ„å›¾ï¼šafter_sales
- æƒ…æ„Ÿï¼šnegative
- å”®åä»»åŠ¡ï¼šæ— 

è¾“å‡ºï¼š
```json
{
  "reply": "éå¸¸æŠ±æ­‰ç»™æ‚¨å¸¦æ¥ä¸ä¾¿ï¼æˆ‘ä¼šç«‹å³ä¸ºæ‚¨åˆ›å»ºå”®åé€€æ¬¾ä»»åŠ¡ï¼Œæˆ‘ä»¬çš„å”®åå›¢é˜Ÿä¼šå°½å¿«ä¸æ‚¨è”ç³»å¤„ç†ã€‚è¯·æ‚¨è€å¿ƒç­‰å¾…ã€‚",
  "needReply": true,
  "reason": "ç”¨æˆ·è¦æ±‚é€€æ¬¾ï¼Œéœ€è¦åˆ›å»ºå”®åä»»åŠ¡å¹¶å®‰æŠšç”¨æˆ·"
}
```

### ç¤ºä¾‹4 - ç”¨æˆ·æŠ•è¯‰
è¾“å…¥ï¼š
- ç”¨æˆ·æ¶ˆæ¯ï¼š"ä½ ä»¬è¿™ç¾¤éª—å­ï¼"
- æ„å›¾ï¼šcomplaint
- æƒ…æ„Ÿï¼šnegative
- å¼ºåº¦ï¼šhigh

è¾“å‡ºï¼š
```json
{
  "reply": "éå¸¸æŠ±æ­‰è®©æ‚¨æœ‰è¿™æ ·çš„æ„Ÿå—ï¼æˆ‘éå¸¸ç†è§£æ‚¨çš„å¿ƒæƒ…ã€‚æˆ‘ä¼šç«‹å³é€šçŸ¥ç®¡ç†å±‚ï¼Œå°½å¿«ä¸ºæ‚¨å¤„ç†ã€‚è¯·æ‚¨ç¨å€™ï¼Œæˆ‘ä»¬çš„ä¸»ç®¡é©¬ä¸Šä¼šè”ç³»æ‚¨ã€‚",
  "needReply": true,
  "reason": "ç”¨æˆ·ä¸¥é‡æŠ•è¯‰ï¼Œéœ€è¦ç«‹å³å®‰æŠšå¹¶è½¬æ¥é«˜å±‚å¤„ç†"
}
```
```

---

## 5. å‘Šè­¦åˆ¤æ–­

### 5.1 å‘Šè­¦è§„åˆ™

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              å‘Šè­¦è§„åˆ™                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  P0å‘Šè­¦ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰                                                   â”‚  â”‚
â”‚  â”‚  - æ„å›¾ï¼šcomplaint                                                      â”‚  â”‚
â”‚  â”‚  - æƒ…æ„Ÿï¼šnegative                                                       â”‚  â”‚
â”‚  â”‚  - å¼ºåº¦ï¼šhigh                                                           â”‚  â”‚
â”‚  â”‚  - å†å²æŠ•è¯‰æ¬¡æ•°ï¼š>= 1                                                   â”‚  â”‚
â”‚  â”‚  - ç”¨æˆ·æ»¡æ„åº¦ï¼š< 50                                                     â”‚  â”‚
â”‚  â”‚  - é€šçŸ¥å¯¹è±¡ï¼šç®¡ç†å±‚ã€è¿è¥è€æ¿                                            â”‚  â”‚
â”‚  â”‚  - å“åº”æ—¶é—´ï¼š< 5åˆ†é’Ÿ                                                    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  P1å‘Šè­¦ï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰                                                     â”‚  â”‚
â”‚  â”‚  - æ„å›¾ï¼šafter_sales                                                    â”‚  â”‚
â”‚  â”‚  - æƒ…æ„Ÿï¼šnegative                                                       â”‚  â”‚
â”‚  â”‚  - å¼ºåº¦ï¼šhigh æˆ– medium                                                 â”‚  â”‚
â”‚  â”‚  - é€šçŸ¥å¯¹è±¡ï¼šå”®åå›¢é˜Ÿã€è¿è¥å›¢é˜Ÿ                                          â”‚  â”‚
â”‚  â”‚  - å“åº”æ—¶é—´ï¼š< 15åˆ†é’Ÿ                                                   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  P2å‘Šè­¦ï¼ˆä¸­ä¼˜å…ˆçº§ï¼‰                                                     â”‚  â”‚
â”‚  â”‚  - æ„å›¾ï¼šafter_sales                                                    â”‚  â”‚
â”‚  â”‚  - æƒ…æ„Ÿï¼šnegative                                                       â”‚  â”‚
â”‚  â”‚  - å¼ºåº¦ï¼šlow                                                            â”‚  â”‚
â”‚  â”‚  - é€šçŸ¥å¯¹è±¡ï¼šå”®åå›¢é˜Ÿ                                                   â”‚  â”‚
â”‚  â”‚  - å“åº”æ—¶é—´ï¼š< 30åˆ†é’Ÿ                                                   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  P3å‘Šè­¦ï¼ˆä½ä¼˜å…ˆçº§ï¼‰                                                     â”‚  â”‚
â”‚  â”‚  - æ„å›¾ï¼šquery æˆ– daily_chat                                           â”‚  â”‚
â”‚  â”‚  - æƒ…æ„Ÿï¼šnegative                                                       â”‚  â”‚
â”‚  â”‚  - å¼ºåº¦ï¼šlow                                                            â”‚  â”‚
â”‚  â”‚  - é€šçŸ¥å¯¹è±¡ï¼šå”®åå›¢é˜Ÿï¼ˆä½œä¸ºé¢„è­¦ï¼‰                                        â”‚  â”‚
â”‚  â”‚  - å“åº”æ—¶é—´ï¼š< 1å°æ—¶                                                    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 å‘Šè­¦åˆ¤æ–­å®ç°

**æ–‡ä»¶ä½ç½®ï¼š** `server/services/alert-judgment.service.js`

```javascript
const logger = require('./system-logger.service');

class AlertJudgmentService {
  /**
   * åˆ¤æ–­æ˜¯å¦éœ€è¦å‘Šè­¦
   */
  async shouldAlert(analysisResult, context) {
    try {
      logger.info('[å‘Šè­¦åˆ¤æ–­] å¼€å§‹åˆ¤æ–­å‘Šè­¦', {
        messageId: analysisResult.messageId,
        intent: analysisResult.intent,
        sentiment: analysisResult.sentiment,
      });

      const { intent, sentiment, sentimentIntensity } = analysisResult;
      const userProfile = context.userProfile || {};

      // è·å–å‘Šè­¦è§„åˆ™
      const alertRules = await this.getAlertRules();

      // éå†å‘Šè­¦è§„åˆ™
      for (const rule of alertRules) {
        if (this.matchRule(rule, analysisResult, userProfile)) {
          logger.info('[å‘Šè­¦åˆ¤æ–­] åŒ¹é…åˆ°å‘Šè­¦è§„åˆ™', {
            alertLevel: rule.alertLevel,
            rule: rule.name,
          });

          return {
            needAlert: true,
            alertLevel: rule.alertLevel,
            alertType: rule.alertType,
            alertReason: rule.description,
            notifyTargets: rule.notifyTargets,
            responseTime: rule.responseTime,
          };
        }
      }

      logger.info('[å‘Šè­¦åˆ¤æ–­] ä¸éœ€è¦å‘Šè­¦');

      return {
        needAlert: false,
      };
    } catch (error) {
      logger.error('[å‘Šè­¦åˆ¤æ–­] å‘Šè­¦åˆ¤æ–­å¤±è´¥', {
        messageId: analysisResult.messageId,
        error: error.message,
        stack: error.stack,
      });
      throw error;
    }
  }

  /**
   * è·å–å‘Šè­¦è§„åˆ™
   */
  async getAlertRules() {
    return [
      {
        name: 'P0ä¸¥é‡æŠ•è¯‰',
        alertLevel: 'P0',
        alertType: 'user_complaint',
        description: 'ç”¨æˆ·ä¸¥é‡æŠ•è¯‰ï¼Œéœ€è¦ç«‹å³å¤„ç†',
        conditions: {
          intent: 'complaint',
          sentiment: 'negative',
          sentimentIntensity: 'high',
          minComplaintCount: 1,
          maxSatisfactionScore: 50,
        },
        notifyTargets: ['management', 'operator'],
        responseTime: 5, // 5åˆ†é’Ÿ
      },
      {
        name: 'P1é«˜ä¼˜å…ˆçº§å”®å',
        alertLevel: 'P1',
        alertType: 'after_sales',
        description: 'ç”¨æˆ·æƒ…ç»ªè¾ƒä¸ºæ¿€çƒˆçš„å”®åéœ€æ±‚',
        conditions: {
          intent: 'after_sales',
          sentiment: 'negative',
          sentimentIntensity: ['high', 'medium'],
        },
        notifyTargets: ['after_sales_team', 'operation_team'],
        responseTime: 15, // 15åˆ†é’Ÿ
      },
      {
        name: 'P2ä¸­ä¼˜å…ˆçº§å”®å',
        alertLevel: 'P2',
        alertType: 'after_sales',
        description: 'ç”¨æˆ·æƒ…ç»ªè¾ƒä¸ºæ¸©å’Œçš„å”®åéœ€æ±‚',
        conditions: {
          intent: 'after_sales',
          sentiment: 'negative',
          sentimentIntensity: 'low',
        },
        notifyTargets: ['after_sales_team'],
        responseTime: 30, // 30åˆ†é’Ÿ
      },
      {
        name: 'P3ä½ä¼˜å…ˆçº§é¢„è­¦',
        alertLevel: 'P3',
        alertType: 'early_warning',
        description: 'ç”¨æˆ·æƒ…ç»ªè´Ÿé¢çš„é¢„è­¦',
        conditions: {
          intent: ['query', 'daily_chat'],
          sentiment: 'negative',
          sentimentIntensity: 'low',
        },
        notifyTargets: ['after_sales_team'],
        responseTime: 60, // 1å°æ—¶
      },
    ];
  }

  /**
   * åŒ¹é…å‘Šè­¦è§„åˆ™
   */
  matchRule(rule, analysisResult, userProfile) {
    const { intent, sentiment, sentimentIntensity } = analysisResult;
    const { satisfactionScore, complaintCount } = userProfile;

    const conditions = rule.conditions;

    // æ£€æŸ¥æ„å›¾
    if (Array.isArray(conditions.intent)) {
      if (!conditions.intent.includes(intent)) {
        return false;
      }
    } else {
      if (conditions.intent && intent !== conditions.intent) {
        return false;
      }
    }

    // æ£€æŸ¥æƒ…æ„Ÿ
    if (conditions.sentiment && sentiment !== conditions.sentiment) {
      return false;
    }

    // æ£€æŸ¥æƒ…æ„Ÿå¼ºåº¦
    if (Array.isArray(conditions.sentimentIntensity)) {
      if (!conditions.sentimentIntensity.includes(sentimentIntensity)) {
        return false;
      }
    } else {
      if (conditions.sentimentIntensity && sentimentIntensity !== conditions.sentimentIntensity) {
        return false;
      }
    }

    // æ£€æŸ¥æŠ•è¯‰æ¬¡æ•°
    if (conditions.minComplaintCount !== undefined) {
      const count = complaintCount || 0;
      if (count < conditions.minComplaintCount) {
        return false;
      }
    }

    // æ£€æŸ¥æ»¡æ„åº¦
    if (conditions.maxSatisfactionScore !== undefined) {
      const score = satisfactionScore || 50;
      if (score > conditions.maxSatisfactionScore) {
        return false;
      }
    }

    return true;
  }
}

module.exports = new AlertJudgmentService();
```

---

## 6. ä»‹å…¥åˆ¤æ–­

### 6.1 ä»‹å…¥è§„åˆ™

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              ä»‹å…¥è§„åˆ™                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  è§¦å‘æ¡ä»¶ï¼š                                                            â”‚  â”‚
â”‚  â”‚  1. ç”¨æˆ·è¿ç»­3æ¬¡ä»¥ä¸Šè¡¨è¾¾è´Ÿé¢æƒ…ç»ª                                         â”‚  â”‚
â”‚  â”‚  2. ç”¨æˆ·æ»¡æ„åº¦ < 40 åˆ†                                                 â”‚  â”‚
â”‚  â”‚  3. ç”¨æˆ·æŠ•è¯‰æ¬¡æ•° >= 2 æ¬¡                                                â”‚  â”‚
â”‚  â”‚  4. ç”¨æˆ·æ˜ç¡®è¦æ±‚äººå·¥æœåŠ¡                                                â”‚  â”‚
â”‚  â”‚  5. AIæ— æ³•ç†è§£ç”¨æˆ·æ„å›¾                                                  â”‚  â”‚
â”‚  â”‚  6. å¯¹è¯è½®æ¬¡ > 10 è½®ä»æœªè§£å†³é—®é¢˜                                         â”‚  â”‚
â”‚  â”‚                                                                        â”‚  â”‚
â”‚  â”‚  ä»‹å…¥å†³ç­–ï¼š                                                            â”‚  â”‚
â”‚  â”‚  - decisionType: human_intervention                                     â”‚  â”‚
â”‚  â”‚  - reason: ä»‹å…¥åŸå›                                                      â”‚  â”‚
â”‚  â”‚  - priority: ä»‹å…¥ä¼˜å…ˆçº§ï¼ˆP0, P1, P2ï¼‰                                    â”‚  â”‚
â”‚  â”‚  - recommendedStaff: æ¨èå·¥ä½œäººå‘˜ï¼ˆå”®åäººå·¥Aã€å”®åäººå·¥Bï¼‰               â”‚  â”‚
â”‚  â”‚                                                                        â”‚  â”‚
â”‚  â”‚  é€šçŸ¥å¯¹è±¡ï¼š                                                            â”‚  â”‚
â”‚  â”‚  - å”®åå›¢é˜Ÿ                                                           â”‚  â”‚
â”‚  â”‚  - æ¨èå·¥ä½œäººå‘˜                                                         â”‚  â”‚
â”‚  â”‚  - è¿è¥å›¢é˜Ÿï¼ˆP0çº§åˆ«ï¼‰                                                   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.2 ä»‹å…¥åˆ¤æ–­å®ç°

**æ–‡ä»¶ä½ç½®ï¼š** `server/services/intervention-judgment.service.js`

```javascript
const logger = require('./system-logger.service');

class InterventionJudgmentService {
  /**
   * åˆ¤æ–­æ˜¯å¦éœ€è¦äººå·¥ä»‹å…¥
   */
  async shouldIntervene(analysisResult, context) {
    try {
      logger.info('[ä»‹å…¥åˆ¤æ–­] å¼€å§‹åˆ¤æ–­ä»‹å…¥', {
        messageId: analysisResult.messageId,
        intent: analysisResult.intent,
        sentiment: analysisResult.sentiment,
      });

      const { intent, sentiment, sentimentIntensity } = analysisResult;
      const userProfile = context.userProfile || {};
      const currentConversation = context.currentConversation || [];

      // è·å–ä»‹å…¥è§„åˆ™
      const interventionRules = await this.getInterventionRules();

      // éå†ä»‹å…¥è§„åˆ™
      for (const rule of interventionRules) {
        if (this.matchRule(rule, analysisResult, userProfile, currentConversation)) {
          logger.info('[ä»‹å…¥åˆ¤æ–­] åŒ¹é…åˆ°ä»‹å…¥è§„åˆ™', {
            priority: rule.priority,
            rule: rule.name,
          });

          return {
            needIntervention: true,
            decisionType: 'human_intervention',
            reason: rule.description,
            priority: rule.priority,
            recommendedStaff: rule.recommendedStaff,
          };
        }
      }

      logger.info('[ä»‹å…¥åˆ¤æ–­] ä¸éœ€è¦ä»‹å…¥');

      return {
        needIntervention: false,
      };
    } catch (error) {
      logger.error('[ä»‹å…¥åˆ¤æ–­] ä»‹å…¥åˆ¤æ–­å¤±è´¥', {
        messageId: analysisResult.messageId,
        error: error.message,
        stack: error.stack,
      });
      throw error;
    }
  }

  /**
   * è·å–ä»‹å…¥è§„åˆ™
   */
  async getInterventionRules() {
    return [
      {
        name: 'è¿ç»­è´Ÿé¢æƒ…ç»ª',
        priority: 'P1',
        description: 'ç”¨æˆ·è¿ç»­å¤šæ¬¡è¡¨è¾¾è´Ÿé¢æƒ…ç»ªï¼Œéœ€è¦äººå·¥ä»‹å…¥å®‰æŠš',
        conditions: {
          consecutiveNegativeCount: 3,
        },
        recommendedStaff: ['å”®åäººå·¥A', 'å”®åäººå·¥B'],
      },
      {
        name: 'ä½æ»¡æ„åº¦ç”¨æˆ·',
        priority: 'P1',
        description: 'ç”¨æˆ·æ»¡æ„åº¦æä½ï¼Œéœ€è¦äººå·¥ä»‹å…¥æ”¹å–„ä½“éªŒ',
        conditions: {
          maxSatisfactionScore: 40,
        },
        recommendedStaff: ['å”®åäººå·¥A'],
      },
      {
        name: 'é«˜æŠ•è¯‰æ¬¡æ•°ç”¨æˆ·',
        priority: 'P0',
        description: 'ç”¨æˆ·æŠ•è¯‰æ¬¡æ•°è¿‡å¤šï¼Œéœ€è¦é«˜å±‚ä»‹å…¥',
        conditions: {
          minComplaintCount: 2,
        },
        recommendedStaff: ['è¿è¥è€æ¿', 'å”®åäººå·¥A'],
      },
      {
        name: 'ç”¨æˆ·æ˜ç¡®è¦æ±‚äººå·¥',
        priority: 'P0',
        description: 'ç”¨æˆ·æ˜ç¡®è¦æ±‚äººå·¥æœåŠ¡ï¼Œä¼˜å…ˆçº§æœ€é«˜',
        conditions: {
          requireHumanService: true,
        },
        recommendedStaff: ['å”®åäººå·¥A', 'å”®åäººå·¥B'],
      },
      {
        name: 'AIæ— æ³•ç†è§£',
        priority: 'P1',
        description: 'AIæ— æ³•ç†è§£ç”¨æˆ·æ„å›¾ï¼Œéœ€è¦äººå·¥ä»‹å…¥',
        conditions: {
          aiConfidenceThreshold: 0.5,
        },
        recommendedStaff: ['å”®åäººå·¥A', 'å”®åäººå·¥B'],
      },
      {
        name: 'å¯¹è¯è½®æ¬¡è¿‡å¤š',
        priority: 'P1',
        description: 'å¯¹è¯è½®æ¬¡è¿‡å¤šä»æœªè§£å†³é—®é¢˜ï¼Œéœ€è¦äººå·¥ä»‹å…¥',
        conditions: {
          maxConversationRounds: 10,
        },
        recommendedStaff: ['å”®åäººå·¥A', 'å”®åäººå·¥B'],
      },
    ];
  }

  /**
   * åŒ¹é…ä»‹å…¥è§„åˆ™
   */
  matchRule(rule, analysisResult, userProfile, currentConversation) {
    const { intent, confidence } = analysisResult;
    const { satisfactionScore, complaintCount } = userProfile;

    const conditions = rule.conditions;

    // æ£€æŸ¥è¿ç»­è´Ÿé¢æƒ…ç»ªæ¬¡æ•°
    if (conditions.consecutiveNegativeCount !== undefined) {
      const consecutiveCount = this.countConsecutiveNegativeSentiments(currentConversation);
      if (consecutiveCount < conditions.consecutiveNegativeCount) {
        return false;
      }
    }

    // æ£€æŸ¥æ»¡æ„åº¦
    if (conditions.maxSatisfactionScore !== undefined) {
      const score = satisfactionScore || 50;
      if (score > conditions.maxSatisfactionScore) {
        return false;
      }
    }

    // æ£€æŸ¥æŠ•è¯‰æ¬¡æ•°
    if (conditions.minComplaintCount !== undefined) {
      const count = complaintCount || 0;
      if (count < conditions.minComplaintCount) {
        return false;
      }
    }

    // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦è¦æ±‚äººå·¥æœåŠ¡
    if (conditions.requireHumanService !== undefined) {
      const message = analysisResult.message?.content || '';
      const requireKeywords = ['äººå·¥', 'è½¬äººå·¥', 'æˆ‘è¦äººå·¥', 'æ‰¾äººå·¥'];
      const isRequireHuman = requireKeywords.some(keyword => message.includes(keyword));
      if (isRequireHuman !== conditions.requireHumanService) {
        return false;
      }
    }

    // æ£€æŸ¥AIç½®ä¿¡åº¦
    if (conditions.aiConfidenceThreshold !== undefined) {
      if (confidence && confidence < conditions.aiConfidenceThreshold) {
        return false;
      }
    }

    // æ£€æŸ¥å¯¹è¯è½®æ¬¡
    if (conditions.maxConversationRounds !== undefined) {
      const roundCount = this.countConversationRounds(currentConversation);
      if (roundCount < conditions.maxConversationRounds) {
        return false;
      }
    }

    return true;
  }

  /**
   * ç»Ÿè®¡è¿ç»­è´Ÿé¢æƒ…ç»ªæ¬¡æ•°
   */
  countConsecutiveNegativeSentiments(conversation) {
    let count = 0;

    // ä»æœ€æ–°æ¶ˆæ¯å¼€å§‹ç»Ÿè®¡
    for (let i = conversation.length - 1; i >= 0; i--) {
      const message = conversation[i];

      if (message.sentiment === 'negative' && message.isFromUser) {
        count++;
      } else if (message.sentiment !== 'negative' && message.isFromUser) {
        break;
      }
    }

    return count;
  }

  /**
   * ç»Ÿè®¡å¯¹è¯è½®æ¬¡
   */
  countConversationRounds(conversation) {
    // æ¯ä¸€ä¸ªç”¨æˆ·æ¶ˆæ¯ + ä¸€ä¸ªAIå›å¤ = 1è½®
    let rounds = 0;
    let lastMessageWasFromUser = false;

    for (const message of conversation) {
      if (message.isFromUser) {
        if (lastMessageWasFromUser) {
          // è¿ç»­ä¸¤æ¡ç”¨æˆ·æ¶ˆæ¯ï¼Œä¹Ÿç®—ä¸€è½®
          rounds++;
        }
        lastMessageWasFromUser = true;
      } else if (message.isFromBot) {
        if (lastMessageWasFromUser) {
          rounds++;
        }
        lastMessageWasFromUser = false;
      }
    }

    return rounds;
  }
}

module.exports = new InterventionJudgmentService();
```

---

## 7. AIåˆ†ææµç¨‹

### 7.1 å®Œæ•´æµç¨‹

```
æ–°æ¶ˆæ¯
    â†“
æ„å›¾è¯†åˆ«
    â”œâ”€ è¾“å…¥ï¼šæ¶ˆæ¯å†…å®¹ + ä¸Šä¸‹æ–‡
    â”œâ”€ è¾“å‡ºï¼šintent + confidence + reason
    â””â”€ è€—æ—¶ï¼š~1-2ç§’
    â†“
æƒ…æ„Ÿåˆ†æ
    â”œâ”€ è¾“å…¥ï¼šæ¶ˆæ¯å†…å®¹
    â”œâ”€ è¾“å‡ºï¼šsentiment + intensity + confidence + reason
    â””â”€ è€—æ—¶ï¼š~1-2ç§’
    â†“
ä¼˜å…ˆçº§åˆ¤æ–­
    â”œâ”€ è¾“å…¥ï¼šintent + sentiment + intensity + ä¸Šä¸‹æ–‡
    â”œâ”€ è¾“å‡ºï¼špriority (P0/P1/P2/P3)
    â””â”€ è§„åˆ™ï¼š
        - complaint + negative + high â†’ P0
        - after_sales + negative + high â†’ P1
        - after_sales + negative + medium â†’ P2
        - query + neutral â†’ P2
        - daily_chat + neutral â†’ P3
    â†“
å‘Šè­¦åˆ¤æ–­
    â”œâ”€ è¾“å…¥ï¼šintent + sentiment + intensity + ç”¨æˆ·ç”»åƒ
    â”œâ”€ è¾“å‡ºï¼šneedAlert + alertLevel + alertReason + notifyTargets
    â””â”€ å¦‚æœneedAlert=true â†’ åˆ›å»ºå‘Šè­¦è®°å½•
    â†“
ä»‹å…¥åˆ¤æ–­
    â”œâ”€ è¾“å…¥ï¼šintent + sentiment + ç”¨æˆ·ç”»åƒ + å¯¹è¯å†å²
    â”œâ”€ è¾“å‡ºï¼šneedIntervention + reason + priority + recommendedStaff
    â””â”€ å¦‚æœneedIntervention=true â†’ åˆ›å»ºä»‹å…¥è®°å½•
    â†“
å›å¤ç”Ÿæˆ
    â”œâ”€ è¾“å…¥ï¼šintent + sentiment + ä¸Šä¸‹æ–‡
    â”œâ”€ è¾“å‡ºï¼šreply + needReply + reason
    â””â”€ å¦‚æœneedReply=true â†’ å‡†å¤‡å‘é€å›å¤
    â†“
ç»„è£…AIåˆ†æç»“æœ
    â”œâ”€ intent
    â”œâ”€ sentiment
    â”œâ”€ sentimentIntensity
    â”œâ”€ priority
    â”œâ”€ needReply
    â”œâ”€ needAlert
    â”œâ”€ needIntervention
    â”œâ”€ alertLevel
    â”œâ”€ alertReason
    â”œâ”€ interventionReason
    â”œâ”€ replySuggestion
    â””â”€ è¿”å›ç»™æ¶ˆæ¯æ¥æ”¶æµç¨‹
```

### 7.2 AIåˆ†ææœåŠ¡å®ç°

**æ–‡ä»¶ä½ç½®ï¼š** `server/services/ai-analysis.service.js`

```javascript
const intentRecognitionService = require('./intent-recognition.service');
const sentimentAnalysisService = require('./sentiment-analysis.service');
const alertJudgmentService = require('./alert-judgment.service');
const interventionJudgmentService = require('./intervention-judgment.service');
const replyGenerationService = require('./reply-generation.service');
const logger = require('./system-logger.service');

class AIAnalysisService {
  /**
   * åˆ†ææ¶ˆæ¯
   */
  async analyze({ message, context }) {
    const startTime = Date.now();

    try {
      logger.info('[AIåˆ†æ] å¼€å§‹åˆ†ææ¶ˆæ¯', {
        messageId: message.id,
        userId: message.userId,
      });

      // 1. æ„å›¾è¯†åˆ«
      const intentResult = await intentRecognitionService.recognizeIntent(message, context);

      // 2. æƒ…æ„Ÿåˆ†æ
      const sentimentResult = await sentimentAnalysisService.analyzeSentiment(message);

      // 3. ä¼˜å…ˆçº§åˆ¤æ–­
      const priority = this.calculatePriority(intentResult, sentimentResult, context);

      // 4. å‘Šè­¦åˆ¤æ–­
      const alertResult = await alertJudgmentService.shouldAlert(
        {
          ...message,
          intent: intentResult.intent,
          sentiment: sentimentResult.sentiment,
          sentimentIntensity: sentimentResult.intensity,
          confidence: Math.max(intentResult.confidence, sentimentResult.confidence),
        },
        context
      );

      // 5. ä»‹å…¥åˆ¤æ–­
      const interventionResult = await interventionJudgmentService.shouldIntervene(
        {
          ...message,
          intent: intentResult.intent,
          sentiment: sentimentResult.sentiment,
          sentimentIntensity: sentimentResult.intensity,
          confidence: Math.max(intentResult.confidence, sentimentResult.confidence),
        },
        context
      );

      // 6. å›å¤ç”Ÿæˆ
      let replyResult = null;
      const needReply = this.shouldReply(intentResult, sentimentResult, context);

      if (needReply) {
        replyResult = await replyGenerationService.generateReply({
          message,
          intent: intentResult.intent,
          sentiment: sentimentResult.sentiment,
          sentimentIntensity: sentimentResult.intensity,
          context,
        });
      }

      // ç»„è£…AIåˆ†æç»“æœ
      const analysisResult = {
        messageId: message.id,
        intent: intentResult.intent,
        intentConfidence: intentResult.confidence,
        intentReason: intentResult.reason,

        sentiment: sentimentResult.sentiment,
        sentimentIntensity: sentimentResult.intensity,
        sentimentConfidence: sentimentResult.confidence,
        sentimentReason: sentimentResult.reason,

        priority,

        needReply,
        replySuggestion: replyResult?.reply || null,

        needAlert: alertResult.needAlert,
        alertLevel: alertResult.alertLevel || null,
        alertType: alertResult.alertType || null,
        alertReason: alertResult.alertReason || null,
        notifyTargets: alertResult.notifyTargets || [],
        responseTime: alertResult.responseTime || null,

        needIntervention: interventionResult.needIntervention,
        interventionReason: interventionResult.reason || null,
        interventionPriority: interventionResult.priority || null,
        recommendedStaff: interventionResult.recommendedStaff || [],

        // å¦‚æœæ˜¯å”®åä»»åŠ¡ï¼Œæå–ä»»åŠ¡ä¿¡æ¯
        taskType: intentResult.intent === 'after_sales' ? this.extractTaskType(message.content) : null,
        taskDescription: intentResult.intent === 'after_sales' ? message.content : null,

        analyzedAt: new Date(),
        analysisDuration: Date.now() - startTime,
      };

      logger.info('[AIåˆ†æ] åˆ†æå®Œæˆ', {
        messageId: message.id,
        intent: analysisResult.intent,
        sentiment: analysisResult.sentiment,
        priority: analysisResult.priority,
        needReply: analysisResult.needReply,
        needAlert: analysisResult.needAlert,
        needIntervention: analysisResult.needIntervention,
        analysisDuration: analysisResult.analysisDuration,
      });

      return analysisResult;
    } catch (error) {
      logger.error('[AIåˆ†æ] åˆ†æå¤±è´¥', {
        messageId: message.id,
        error: error.message,
        stack: error.stack,
      });
      throw error;
    }
  }

  /**
   * è®¡ç®—ä¼˜å…ˆçº§
   */
  calculatePriority(intentResult, sentimentResult, context) {
    const { intent } = intentResult;
    const { sentiment, intensity } = sentimentResult;

    // æŠ•è¯‰æ„å›¾ â†’ P0
    if (intent === 'complaint') {
      return 'P0';
    }

    // å”®åä»»åŠ¡ + è´Ÿé¢æƒ…ç»ª + é«˜å¼ºåº¦ â†’ P1
    if (intent === 'after_sales' && sentiment === 'negative' && intensity === 'high') {
      return 'P1';
    }

    // å”®åä»»åŠ¡ + è´Ÿé¢æƒ…ç»ª + ä¸­å¼ºåº¦ â†’ P2
    if (intent === 'after_sales' && sentiment === 'negative' && intensity === 'medium') {
      return 'P2';
    }

    // å”®åä»»åŠ¡ + ä¸­æ€§æƒ…ç»ª â†’ P2
    if (intent === 'after_sales' && sentiment === 'neutral') {
      return 'P2';
    }

    // æŸ¥è¯¢å’¨è¯¢ â†’ P2
    if (intent === 'query') {
      return 'P2';
    }

    // æ—¥å¸¸èŠå¤© â†’ P3
    if (intent === 'daily_chat') {
      return 'P3';
    }

    // é»˜è®¤P2
    return 'P2';
  }

  /**
   * åˆ¤æ–­æ˜¯å¦éœ€è¦å›å¤
   */
  shouldReply(intentResult, sentimentResult, context) {
    const { intent } = intentResult;

    // å¦‚æœæ˜¯æŠ•è¯‰ï¼Œéœ€è¦å›å¤
    if (intent === 'complaint') {
      return true;
    }

    // å¦‚æœæ˜¯å”®åä»»åŠ¡ï¼Œéœ€è¦å›å¤
    if (intent === 'after_sales') {
      return true;
    }

    // å¦‚æœæ˜¯æŸ¥è¯¢å’¨è¯¢ï¼Œéœ€è¦å›å¤
    if (intent === 'query') {
      return true;
    }

    // å¦‚æœæ˜¯æ—¥å¸¸èŠå¤©ï¼Œéœ€è¦å›å¤
    if (intent === 'daily_chat') {
      return true;
    }

    // é»˜è®¤ä¸å›å¤
    return false;
  }

  /**
   * æå–ä»»åŠ¡ç±»å‹
   */
  extractTaskType(messageContent) {
    const keywords = {
      'é€€æ¬¾': 'refund',
      'é€€é’±': 'refund',
      'æŠ•è¯‰': 'complaint',
      'äº§å“é—®é¢˜': 'product_issue',
      'è´¨é‡é—®é¢˜': 'quality_issue',
      'æœåŠ¡é—®é¢˜': 'service_issue',
      'è®¢å•é—®é¢˜': 'order_issue',
      'å‘è´§é—®é¢˜': 'shipping_issue',
      'åˆ°è´§é—®é¢˜': 'delivery_issue',
    };

    for (const [keyword, taskType] of Object.entries(keywords)) {
      if (messageContent.includes(keyword)) {
        return taskType;
      }
    }

    return 'other';
  }
}

module.exports = new AIAnalysisService();
```

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0

**æœ€åæ›´æ–°**ï¼š2024-01-10

**æ–‡æ¡£ä½œè€…**ï¼šWorkTool AI å›¢é˜Ÿ
