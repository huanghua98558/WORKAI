# WorkTool AI ä¸­æ¢ç³»ç»Ÿ - è¿ç»´æ‰‹å†Œ

## ğŸ“‹ ç›®å½•

1. [è¿ç»´æ¦‚è¿°](#1-è¿ç»´æ¦‚è¿°)
2. [æ—¥å¸¸è¿ç»´](#2-æ—¥å¸¸è¿ç»´)
3. [ç³»ç»Ÿç›‘æ§](#3-ç³»ç»Ÿç›‘æ§)
4. [æ—¥å¿—ç®¡ç†](#4-æ—¥å¿—ç®¡ç†)
5. [å¤‡ä»½æ¢å¤](#5-å¤‡ä»½æ¢å¤)
6. [æ€§èƒ½ä¼˜åŒ–](#6-æ€§èƒ½ä¼˜åŒ–)
7. [æ•…éšœå¤„ç†](#7-æ•…éšœå¤„ç†)
8. [é…ç½®ç®¡ç†](#8-é…ç½®ç®¡ç†)

---

## 1. è¿ç»´æ¦‚è¿°

### 1.1 ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   å®¢æˆ·ç«¯                             â”‚
â”‚                  (ä¼ä¸šå¾®ä¿¡)                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚ HTTPS/WebSocket
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              è´Ÿè½½å‡è¡¡å™¨ (Nginx)                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            åº”ç”¨æœåŠ¡å™¨ (Fastify)                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚ å®ä¾‹1   â”‚  â”‚ å®ä¾‹2   â”‚  â”‚ å®ä¾‹3   â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              æ•°æ®åº“ (PostgreSQL)                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚ ä¸»åº“    â”‚  â”‚ ä»åº“1   â”‚  â”‚ ä»åº“2   â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ç¼“å­˜å±‚ (Redis)                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”‚
â”‚  â”‚ ä¸»èŠ‚ç‚¹  â”‚  â”‚ ä»èŠ‚ç‚¹  â”‚                            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 è¿ç»´èŒè´£

```
ç³»ç»Ÿè¿ç»´
- æœåŠ¡å™¨ç®¡ç†
- æœåŠ¡éƒ¨ç½²
- èµ„æºç›‘æ§
- é…ç½®ç®¡ç†

æ•°æ®è¿ç»´
- æ•°æ®å¤‡ä»½
- æ•°æ®æ¢å¤
- æ•°æ®è¿ç§»
- æ•°æ®æ¸…ç†

åº”ç”¨è¿ç»´
- åº”ç”¨éƒ¨ç½²
- ç‰ˆæœ¬å‡çº§
- æ•…éšœæ’æŸ¥
- æ€§èƒ½ä¼˜åŒ–

å®‰å…¨è¿ç»´
- å®‰å…¨å®¡è®¡
- æ¼æ´æ‰«æ
- å®‰å…¨åŠ å›º
- åº”æ€¥å“åº”
```

---

## 2. æ—¥å¸¸è¿ç»´

### 2.1 æ¯æ—¥å·¡æ£€

```bash
#!/bin/bash
# æ¯æ—¥å·¡æ£€è„šæœ¬ daily_check.sh

echo "=== WorkTool AI æ¯æ—¥å·¡æ£€å¼€å§‹ ==="
echo "æ£€æŸ¥æ—¶é—´: $(date)"

# 1. æœåŠ¡çŠ¶æ€æ£€æŸ¥
echo "1. æ£€æŸ¥æœåŠ¡çŠ¶æ€"
systemctl status worktool-api | grep -E "Active|Loaded"
systemctl status postgresql | grep -E "Active|Loaded"
systemctl status redis | grep -E "Active|Loaded"

# 2. ç«¯å£æ£€æŸ¥
echo "2. æ£€æŸ¥ç«¯å£çŠ¶æ€"
ss -tuln | grep -E ":5000|:5432|:6379"

# 3. ç£ç›˜ç©ºé—´æ£€æŸ¥
echo "3. æ£€æŸ¥ç£ç›˜ç©ºé—´"
df -h | grep -E "/var|/tmp"

# 4. å†…å­˜ä½¿ç”¨æ£€æŸ¥
echo "4. æ£€æŸ¥å†…å­˜ä½¿ç”¨"
free -h

# 5. æ•°æ®åº“è¿æ¥æ£€æŸ¥
echo "5. æ£€æŸ¥æ•°æ®åº“è¿æ¥"
psql -U worktool -d worktool_ai -c "SELECT count(*) FROM pg_stat_activity;"

# 6. Redisè¿æ¥æ£€æŸ¥
echo "6. æ£€æŸ¥Redisè¿æ¥"
redis-cli INFO clients | grep connected_clients

# 7. åº”ç”¨æ—¥å¿—é”™è¯¯æ£€æŸ¥
echo "7. æ£€æŸ¥åº”ç”¨é”™è¯¯æ—¥å¿—"
tail -100 /var/log/worktool/api-error.log | grep -i error

# 8. æ•°æ®åº“æ…¢æŸ¥è¯¢æ£€æŸ¥
echo "8. æ£€æŸ¥æ•°æ®åº“æ…¢æŸ¥è¯¢"
tail -20 /var/log/postgresql/postgresql-slow.log

echo "=== WorkTool AI æ¯æ—¥å·¡æ£€ç»“æŸ ==="
```

### 2.2 æ¯å‘¨ç»´æŠ¤

```bash
#!/bin/bash
# æ¯å‘¨ç»´æŠ¤è„šæœ¬ weekly_maintenance.sh

echo "=== WorkTool AI æ¯å‘¨ç»´æŠ¤å¼€å§‹ ==="

# 1. æ•°æ®åº“æ¸…ç†
echo "1. æ‰§è¡Œæ•°æ®åº“æ¸…ç†"
psql -U worktool -d worktool_ai -c "VACUUM ANALYZE;"

# 2. æ—¥å¿—æ¸…ç†
echo "2. æ¸…ç†å†å²æ—¥å¿—"
find /var/log/worktool -name "*.log" -mtime +7 -delete

# 3. ä¸´æ—¶æ–‡ä»¶æ¸…ç†
echo "3. æ¸…ç†ä¸´æ—¶æ–‡ä»¶"
find /tmp -name "worktool-*" -mtime +3 -delete

# 4. ç´¢å¼•é‡å»º
echo "4. é‡å»ºæ•°æ®åº“ç´¢å¼•"
psql -U worktool -d worktool_ai -c "REINDEX DATABASE worktool_ai;"

# 5. ç»Ÿè®¡ä¿¡æ¯æ›´æ–°
echo "5. æ›´æ–°ç»Ÿè®¡ä¿¡æ¯"
psql -U worktool -d worktool_ai -c "ANALYZE;"

echo "=== WorkTool AI æ¯å‘¨ç»´æŠ¤ç»“æŸ ==="
```

### 2.3 æ¯æœˆæ£€æŸ¥

```bash
#!/bin/bash
# æ¯æœˆæ£€æŸ¥è„šæœ¬ monthly_check.sh

echo "=== WorkTool AI æ¯æœˆæ£€æŸ¥å¼€å§‹ ==="

# 1. æ€§èƒ½æŒ‡æ ‡åˆ†æ
echo "1. ç”Ÿæˆæ€§èƒ½æŠ¥å‘Š"
sh /opt/scripts/generate-performance-report.sh

# 2. å®‰å…¨æ£€æŸ¥
echo "2. æ‰§è¡Œå®‰å…¨æ£€æŸ¥"
sh /opt/scripts/security-scan.sh

# 3. å®¹é‡è§„åˆ’
echo "3. ç”Ÿæˆå®¹é‡è§„åˆ’æŠ¥å‘Š"
sh /opt/scripts/capacity-planning.sh

# 4. å¤‡ä»½éªŒè¯
echo "4. éªŒè¯å¤‡ä»½å®Œæ•´æ€§"
sh /opt/scripts/verify-backups.sh

echo "=== WorkTool AI æ¯æœˆæ£€æŸ¥ç»“æŸ ==="
```

---

## 3. ç³»ç»Ÿç›‘æ§

### 3.1 ç›‘æ§æŒ‡æ ‡

#### åº”ç”¨æŒ‡æ ‡

```yaml
åº”ç”¨çŠ¶æ€:
  - æœåŠ¡è¿è¡ŒçŠ¶æ€
  - è¿›ç¨‹æ•°
  - çº¿ç¨‹æ•°
  - ç«¯å£ç›‘å¬çŠ¶æ€

æ€§èƒ½æŒ‡æ ‡:
  - QPS (æ¯ç§’è¯·æ±‚æ•°)
  - RT (å“åº”æ—¶é—´)
  - é”™è¯¯ç‡
  - å¹¶å‘è¿æ¥æ•°

èµ„æºä½¿ç”¨:
  - CPUä½¿ç”¨ç‡
  - å†…å­˜ä½¿ç”¨ç‡
  - ç£ç›˜I/O
  - ç½‘ç»œæµé‡
```

#### æ•°æ®åº“æŒ‡æ ‡

```yaml
è¿æ¥çŠ¶æ€:
  - æ´»è·ƒè¿æ¥æ•°
  - ç©ºé—²è¿æ¥æ•°
  - ç­‰å¾…è¿æ¥æ•°
  - è¿æ¥è¶…æ—¶æ•°

æŸ¥è¯¢æ€§èƒ½:
  - æ…¢æŸ¥è¯¢æ•°é‡
  - æŸ¥è¯¢å¹³å‡æ—¶é—´
  - TPS (æ¯ç§’äº‹åŠ¡æ•°)
  - é”ç­‰å¾…æ—¶é—´

èµ„æºä½¿ç”¨:
  - CPUä½¿ç”¨ç‡
  - å†…å­˜ä½¿ç”¨ç‡
  - ç¼“å†²åŒºå‘½ä¸­ç‡
  - ç£ç›˜I/O

å­˜å‚¨çŠ¶æ€:
  - æ•°æ®åº“å¤§å°
  - è¡¨ç©ºé—´ä½¿ç”¨
  - ç´¢å¼•å¤§å°
  - æ—¥å¿—å¤§å°
```

#### ç¼“å­˜æŒ‡æ ‡

```yaml
è¿æ¥çŠ¶æ€:
  - è¿æ¥æ•°
  - å®¢æˆ·ç«¯æ•°

æ€§èƒ½æŒ‡æ ‡:
  - QPS
  - å‘½ä¸­ç‡
  - å¹³å‡å“åº”æ—¶é—´

å†…å­˜ä½¿ç”¨:
  - å·²ç”¨å†…å­˜
  - å†…å­˜ç¢ç‰‡ç‡
  - é”®è¿‡æœŸæ•°

æŒä¹…åŒ–:
  - RDBçŠ¶æ€
  - AOFçŠ¶æ€
  - æŒä¹…åŒ–å»¶è¿Ÿ
```

### 3.2 ç›‘æ§å·¥å…·

#### Prometheus + Grafana

```yaml
Prometheus:
  éƒ¨ç½²æ–¹å¼: Docker
  ç«¯å£: 9090
  æ•°æ®ä¿ç•™: 15å¤©
  é‡‡é›†é—´éš”: 15ç§’

Grafana:
  éƒ¨ç½²æ–¹å¼: Docker
  ç«¯å£: 3000
  æ•°æ®æº: Prometheus
  å‘Šè­¦é›†æˆ: AlertManager
```

#### ç›‘æ§é¢æ¿

```
åº”ç”¨ç›‘æ§é¢æ¿
- å®æ—¶QPS
- å¹³å‡å“åº”æ—¶é—´
- é”™è¯¯ç‡
- å¹¶å‘è¿æ¥æ•°
- CPU/å†…å­˜ä½¿ç”¨ç‡

æ•°æ®åº“ç›‘æ§é¢æ¿
- æ´»è·ƒè¿æ¥æ•°
- æ…¢æŸ¥è¯¢æ•°
- ç¼“å†²åŒºå‘½ä¸­ç‡
- ç£ç›˜I/O
- è¡¨ç©ºé—´ä½¿ç”¨

ä¸šåŠ¡ç›‘æ§é¢æ¿
- ä»Šæ—¥ä¼šè¯æ•°
- å‘Šè­¦æ•°é‡
- ä»»åŠ¡æ•°é‡
- AIè°ƒç”¨æ¬¡æ•°
- ç”¨æˆ·æ»¡æ„åº¦
```

### 3.3 å‘Šè­¦è§„åˆ™

```yaml
æœåŠ¡å‘Šè­¦:
  - æœåŠ¡å®•æœº: ç«‹å³å‘Šè­¦
  - å“åº”æ—¶é—´ > 3ç§’: è­¦å‘Š
  - å“åº”æ—¶é—´ > 5ç§’: ä¸¥é‡
  - é”™è¯¯ç‡ > 1%: è­¦å‘Š
  - é”™è¯¯ç‡ > 5%: ä¸¥é‡

æ•°æ®åº“å‘Šè­¦:
  - ä¸»ä»å»¶è¿Ÿ > 10ç§’: è­¦å‘Š
  - æ…¢æŸ¥è¯¢ > 10ä¸ª/åˆ†é’Ÿ: è­¦å‘Š
  - è¿æ¥æ•° > 80%: è­¦å‘Š
  - ç£ç›˜ä½¿ç”¨ > 80%: ä¸¥é‡

ç³»ç»Ÿå‘Šè­¦:
  - CPUä½¿ç”¨ > 80%: è­¦å‘Š
  - CPUä½¿ç”¨ > 95%: ä¸¥é‡
  - å†…å­˜ä½¿ç”¨ > 85%: è­¦å‘Š
  - ç£ç›˜ä½¿ç”¨ > 85%: ä¸¥é‡
```

---

## 4. æ—¥å¿—ç®¡ç†

### 4.1 æ—¥å¿—åˆ†ç±»

```
åº”ç”¨æ—¥å¿—
- /var/log/worktool/api.log          # åº”ç”¨ä¸»æ—¥å¿—
- /var/log/worktool/api-error.log    # åº”ç”¨é”™è¯¯æ—¥å¿—
- /var/log/worktool/api-access.log   # APIè®¿é—®æ—¥å¿—
- /var/log/worktool/ai.log           # AIè°ƒç”¨æ—¥å¿—

æ•°æ®åº“æ—¥å¿—
- /var/log/postgresql/postgresql.log # æ•°æ®åº“ä¸»æ—¥å¿—
- /var/log/postgresql/postgresql-slow.log # æ…¢æŸ¥è¯¢æ—¥å¿—
- /var/log/postgresql/postgresql-error.log  # é”™è¯¯æ—¥å¿—

ç³»ç»Ÿæ—¥å¿—
- /var/log/nginx/access.log          # Nginxè®¿é—®æ—¥å¿—
- /var/log/nginx/error.log           # Nginxé”™è¯¯æ—¥å¿—
- /var/log/syslog                    # ç³»ç»Ÿæ—¥å¿—
```

### 4.2 æ—¥å¿—æ”¶é›†

```yaml
å·¥å…·: ELK Stack (Elasticsearch + Logstash + Kibana)

Logstashé…ç½®:
  è¾“å…¥: æ–‡ä»¶ã€ç³»ç»Ÿæ—¥å¿—ã€åº”ç”¨æ—¥å¿—
  è¿‡æ»¤: è§£æã€å»é‡ã€æ ¼å¼åŒ–
  è¾“å‡º: Elasticsearch

Elasticsearch:
  é›†ç¾¤: 3èŠ‚ç‚¹
  å‰¯æœ¬æ•°: 2
  ä¿ç•™æœŸ: 30å¤©

Kibana:
  å¯è§†åŒ–: æ—¥å¿—æŸ¥è¯¢ã€å›¾è¡¨å±•ç¤º
  å‘Šè­¦: æ—¥å¿—å¼‚å¸¸å‘Šè­¦
```

### 4.3 æ—¥å¿—æŸ¥è¯¢

```bash
# æŸ¥çœ‹æœ€æ–°é”™è¯¯
tail -f /var/log/worktool/api-error.log | grep ERROR

# æŸ¥çœ‹æ…¢æŸ¥è¯¢
grep "duration:" /var/log/postgresql/postgresql-slow.log | tail -20

# æŸ¥çœ‹ç‰¹å®šç”¨æˆ·çš„æ“ä½œæ—¥å¿—
grep "user-001" /var/log/worktool/api-access.log | tail -20

# æŸ¥çœ‹AIè°ƒç”¨å¤±è´¥æ—¥å¿—
grep "AI_ERROR" /var/log/worktool/ai.log | tail -20

# ç»Ÿè®¡ä»Šæ—¥é”™è¯¯æ•°é‡
grep "$(date +%Y-%m-%d)" /var/log/worktool/api-error.log | wc -l
```

---

## 5. å¤‡ä»½æ¢å¤

### 5.1 å¤‡ä»½ç­–ç•¥

```yaml
æ•°æ®åº“å¤‡ä»½:
  å…¨é‡å¤‡ä»½:
    - é¢‘ç‡: æ¯å¤©02:00
    - ä¿ç•™: 7å¤©
    - å·¥å…·: pg_dump

  å¢é‡å¤‡ä»½:
    - é¢‘ç‡: æ¯å°æ—¶
    - ä¿ç•™: 24å°æ—¶
    - å·¥å…·: WALå½’æ¡£

åº”ç”¨å¤‡ä»½:
    - é¢‘ç‡: æ¯å¤©å‡Œæ™¨
    - ä¿ç•™: 30å¤©
    - å†…å®¹: é…ç½®æ–‡ä»¶ã€ä¸Šä¼ æ–‡ä»¶

ä»£ç å¤‡ä»½:
    - é¢‘ç‡: æ¯æ¬¡å‘å¸ƒ
    - ä¿ç•™: æ°¸ä¹…
    - å·¥å…·: Git
```

### 5.2 å¤‡ä»½è„šæœ¬

```bash
#!/bin/bash
# æ•°æ®åº“å¤‡ä»½è„šæœ¬ backup_db.sh

BACKUP_DIR="/backup/postgresql"
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_FILE="$BACKUP_DIR/worktool_ai_$DATE.dmp"

# åˆ›å»ºå¤‡ä»½ç›®å½•
mkdir -p $BACKUP_DIR

# æ‰§è¡Œå…¨é‡å¤‡ä»½
pg_dump -U worktool -d worktool_ai -F c -b -v -f $BACKUP_FILE

# å‹ç¼©å¤‡ä»½æ–‡ä»¶
gzip $BACKUP_FILE

# åˆ é™¤7å¤©å‰çš„å¤‡ä»½
find $BACKUP_DIR -name "*.dmp.gz" -mtime +7 -delete

echo "å¤‡ä»½å®Œæˆ: $BACKUP_FILE.gz"
```

### 5.3 æ¢å¤æµç¨‹

```bash
#!/bin/bash
# æ•°æ®åº“æ¢å¤è„šæœ¬ restore_db.sh

if [ $# -ne 1 ]; then
    echo "Usage: $0 <backup_file>"
    exit 1
fi

BACKUP_FILE=$1

# è§£å‹å¤‡ä»½æ–‡ä»¶
gunzip -c $BACKUP_FILE > /tmp/restore.dmp

# åœæ­¢åº”ç”¨
systemctl stop worktool-api

# åˆ é™¤ç°æœ‰æ•°æ®åº“
psql -U worktool -d postgres -c "DROP DATABASE worktool_ai;"

# åˆ›å»ºæ–°æ•°æ®åº“
psql -U worktool -d postgres -c "CREATE DATABASE worktool_ai;"

# æ¢å¤æ•°æ®
pg_restore -U worktool -d worktool_ai /tmp/restore.dmp

# å¯åŠ¨åº”ç”¨
systemctl start worktool-api

echo "æ¢å¤å®Œæˆ"
```

---

## 6. æ€§èƒ½ä¼˜åŒ–

### 6.1 æ•°æ®åº“ä¼˜åŒ–

```sql
-- 1. æŸ¥çœ‹æ…¢æŸ¥è¯¢
SELECT query, mean_exec_time, calls
FROM pg_stat_statements
ORDER BY mean_exec_time DESC
LIMIT 10;

-- 2. åˆ†ææŸ¥è¯¢è®¡åˆ’
EXPLAIN ANALYZE
SELECT * FROM session_messages
WHERE user_id = 'user-001'
ORDER BY timestamp DESC
LIMIT 100;

-- 3. åˆ›å»ºç´¢å¼•
CREATE INDEX CONCURRENTLY idx_session_messages_user_id_timestamp
ON session_messages(user_id, timestamp DESC);

-- 4. æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
ANALYZE session_messages;

-- 5. æ¸…ç†æ­»å…ƒç»„
VACUUM session_messages;
```

### 6.2 åº”ç”¨ä¼˜åŒ–

```typescript
// 1. è¿æ¥æ± é…ç½®
const pool = new Pool({
  host: process.env.DB_HOST,
  port: parseInt(process.env.DB_PORT),
  database: process.env.DB_NAME,
  user: process.env.DB_USER,
  password: process.env.DB_PASSWORD,
  max: 20,              // æœ€å¤§è¿æ¥æ•°
  idleTimeoutMillis: 30000,
  connectionTimeoutMillis: 2000,
});

// 2. Redisç¼“å­˜
import Redis from 'ioredis';

const redis = new Redis({
  host: process.env.REDIS_HOST,
  port: parseInt(process.env.REDIS_PORT),
  retryStrategy(times) {
    const delay = Math.min(times * 50, 2000);
    return delay;
  },
});

// 3. æŸ¥è¯¢ä¼˜åŒ–
async function getSessionMessages(sessionId: string) {
  // å…ˆæŸ¥ç¼“å­˜
  const cached = await redis.get(`session:${sessionId}`);
  if (cached) {
    return JSON.parse(cached);
  }

  // æŸ¥è¯¢æ•°æ®åº“
  const messages = await db
    .select()
    .from(sessionMessages)
    .where(eq(sessionMessages.sessionId, sessionId))
    .limit(100);

  // å†™å…¥ç¼“å­˜ï¼ˆ5åˆ†é’Ÿè¿‡æœŸï¼‰
  await redis.setex(`session:${sessionId}`, 300, JSON.stringify(messages));

  return messages;
}
```

### 6.3 ç³»ç»Ÿä¼˜åŒ–

```bash
# 1. è°ƒæ•´æ–‡ä»¶æè¿°ç¬¦é™åˆ¶
echo "* soft nofile 65535" >> /etc/security/limits.conf
echo "* hard nofile 65535" >> /etc/security/limits.conf

# 2. ä¼˜åŒ–TCPå‚æ•°
echo "net.ipv4.tcp_tw_reuse = 1" >> /etc/sysctl.conf
echo "net.ipv4.tcp_keepalive_time = 600" >> /etc/sysctl.conf
echo "net.ipv4.tcp_keepalive_intvl = 30" >> /etc/sysctl.conf
echo "net.ipv4.tcp_keepalive_probes = 3" >> /etc/sysctl.conf
sysctl -p

# 3. ä¼˜åŒ–PostgreSQLå‚æ•°
# ç¼–è¾‘ /etc/postgresql/15/main/postgresql.conf
shared_buffers = 256MB
effective_cache_size = 1GB
maintenance_work_mem = 64MB
checkpoint_completion_target = 0.9
wal_buffers = 16MB
default_statistics_target = 100
random_page_cost = 1.1
effective_io_concurrency = 200
work_mem = 2621kB
min_wal_size = 1GB
max_wal_size = 4GB
max_worker_processes = 4
max_parallel_workers_per_gather = 2
max_parallel_workers = 4
max_parallel_maintenance_workers = 2
```

---

## 7. æ•…éšœå¤„ç†

### 7.1 å¸¸è§æ•…éšœ

#### æœåŠ¡æ— æ³•å¯åŠ¨

```bash
# æ£€æŸ¥ç«¯å£å ç”¨
ss -tuln | grep 5000

# æ£€æŸ¥æ—¥å¿—
tail -100 /var/log/worktool/api-error.log

# æ£€æŸ¥é…ç½®
cat /etc/worktool/config.toml

# é‡å¯æœåŠ¡
systemctl restart worktool-api

# æŸ¥çœ‹çŠ¶æ€
systemctl status worktool-api
```

#### æ•°æ®åº“è¿æ¥å¤±è´¥

```bash
# æ£€æŸ¥æ•°æ®åº“çŠ¶æ€
systemctl status postgresql

# æ£€æŸ¥è¿æ¥æ•°
psql -U worktool -d worktool_ai -c "SELECT count(*) FROM pg_stat_activity;"

# æ£€æŸ¥è¿æ¥é™åˆ¶
psql -U worktool -d postgres -c "SHOW max_connections;"

# æ£€æŸ¥è¿æ¥æ± é…ç½®
cat /etc/worktool/config.toml | grep database

# æµ‹è¯•è¿æ¥
psql -U worktool -d worktool_ai -c "SELECT 1;"
```

#### Redisè¿æ¥å¤±è´¥

```bash
# æ£€æŸ¥RedisçŠ¶æ€
systemctl status redis

# æµ‹è¯•è¿æ¥
redis-cli ping

# æ£€æŸ¥å†…å­˜ä½¿ç”¨
redis-cli INFO memory

# æ£€æŸ¥è¿æ¥æ•°
redis-cli INFO clients
```

### 7.2 æ•…éšœä¸ŠæŠ¥æµç¨‹

```
1. å‘ç°æ•…éšœ
   â†“
2. ç¡®è®¤æ•…éšœçº§åˆ«
   - P0: ç³»ç»Ÿå®Œå…¨ä¸å¯ç”¨
   - P1: æ ¸å¿ƒåŠŸèƒ½ä¸å¯ç”¨
   - P2: éƒ¨åˆ†åŠŸèƒ½å—å½±å“
   - P3: è½»å¾®é—®é¢˜
   â†“
3. ä¸ŠæŠ¥ç›¸å…³äººå‘˜
   - P0/P1: ç«‹å³ç”µè¯é€šçŸ¥
   - P2/P3: é‚®ä»¶/IMé€šçŸ¥
   â†“
4. æ•…éšœå¤„ç†
   - å®šä½é—®é¢˜
   - ä¸´æ—¶æ–¹æ¡ˆ
   - æ ¹æœ¬ä¿®å¤
   â†“
5. æ¢å¤éªŒè¯
   - åŠŸèƒ½æµ‹è¯•
   - ä¸šåŠ¡éªŒè¯
   - ç›‘æ§ç¡®è®¤
   â†“
6. æ•…éšœæ€»ç»“
   - åŸå› åˆ†æ
   - æ”¹è¿›æªæ–½
   - çŸ¥è¯†æ²‰æ·€
```

---

## 8. é…ç½®ç®¡ç†

### 8.1 é…ç½®æ–‡ä»¶

```toml
# /etc/worktool/config.toml

[server]
port = 5000
host = "0.0.0.0"
mode = "production"

[database]
host = "localhost"
port = 5432
name = "worktool_ai"
user = "worktool"
password = "encrypted_password"
max_connections = 20
connection_timeout = 2000
idle_timeout = 30000

[redis]
host = "localhost"
port = 6379
password = ""
db = 0
max_retries = 3

[ai]
provider = "openai"
api_key = "encrypted_api_key"
model = "gpt-4"
max_tokens = 1000
temperature = 0.7

[logging]
level = "info"
file = "/var/log/worktool/api.log"
error_file = "/var/log/worktool/api-error.log"
max_size = "100MB"
max_backups = 10
max_age = 30
```

### 8.2 é…ç½®æ›´æ–°

```bash
# 1. å¤‡ä»½é…ç½®
cp /etc/worktool/config.toml /etc/worktool/config.toml.bak

# 2. ç¼–è¾‘é…ç½®
vim /etc/worktool/config.toml

# 3. éªŒè¯é…ç½®
worktool config validate

# 4. é‡è½½é…ç½®
systemctl reload worktool-api

# 5. éªŒè¯ç”Ÿæ•ˆ
systemctl status worktool-api
```

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0

**æœ€åæ›´æ–°**ï¼š2024-01-10

**æ–‡æ¡£ä½œè€…**ï¼šWorkTool AI å›¢é˜Ÿ
