# WorkTool AI 中枢系统 - 模块升级详解（告警系统流程篇）

## 📋 目录

1. [告警系统概述](#1-告警系统概述)
2. [告警类型与级别](#2-告警类型与级别)
3. [告警创建流程](#3-告警创建流程)
4. [告警升级流程](#4-告警升级流程)
5. [告警取消流程](#5-告警取消流程)
6. [告警通知流程](#6-告警通知流程)
7. [告警配置管理](#7-告警配置管理)

---

## 1. 告警系统概述

### 1.1 系统架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           告警系统                                           │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │  触发层 (Trigger Layer)                                                │  │
│  │  - AI分析触发：用户投诉、售后任务                                       │  │
│  │  - 规则触发：满意度阈值、投诉次数阈值                                    │  │
│  │  - 手动触发：工作人员创建                                               │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                    ↓                                        │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │  处理层 (Processing Layer)                                            │  │
│  │  - 告警创建：创建告警记录                                               │  │
│  │  - 优先级判断：确定告警级别                                             │  │
│  │  - 告警升级：超时未处理自动升级                                         │  │
│  │  - 告警取消：问题解决后取消告警                                         │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                    ↓                                        │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │  通知层 (Notification Layer)                                          │  │
│  │  - 多渠道通知：微信、企业微信、邮件、短信                                │  │
│  │  - 分级通知：根据告警级别通知不同对象                                    │  │
│  │  - 通知确认：工作人员确认收到                                           │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                    ↓                                        │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │  监控层 (Monitoring Layer)                                            │  │
│  │  - 告警状态监控：实时监控告警状态                                        │  │
│  │  - 告警升级监控：监控超时告警                                            │  │
│  │  - 告警统计：告警数量、处理时效                                          │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 1.2 告警生命周期

```
created（已创建） → acknowledged（已确认） → processing（处理中） → resolved（已解决）
                          ↓                      ↓
                    cancelled（已取消）         escalated（已升级）
```

---

## 2. 告警类型与级别

### 2.1 告警类型

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              告警类型                                        │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │  1. 用户投诉 (user_complaint)                                           │  │
│  │     - 用户严重投诉                                                      │  │
│  │     - 威胁曝光、诉讼                                                     │  │
│  │     - 默认级别：P0                                                       │  │
│  │     - 响应要求：5分钟内响应                                              │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │  2. 售后任务 (after_sales)                                              │  │
│  │     - 退款、产品质量问题、服务问题                                       │  │
│  │     - 默认级别：P1 或 P2                                                 │  │
│  │     - 响应要求：15-30分钟内响应                                          │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │  3. 低满意度预警 (low_satisfaction)                                     │  │
│  │     - 用户满意度低于阈值                                                │  │
│  │     - 默认级别：P2                                                       │  │
│  │     - 响应要求：30分钟内响应                                              │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │  4. 频繁投诉预警 (frequent_complaint)                                   │  │
│  │     - 用户短时间内多次投诉                                               │  │
│  │     - 默认级别：P1 或 P0                                                 │  │
│  │     - 响应要求：15分钟内响应                                              │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │  5. 人工介入请求 (human_intervention_request)                            │  │
│  │     - AI判断需要人工介入                                                 │  │
│  │     - 默认级别：P1                                                       │  │
│  │     - 响应要求：15分钟内响应                                              │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │  6. 系统异常 (system_error)                                             │  │
│  │     - 系统故障、服务不可用                                               │  │
│  │     - 默认级别：P0                                                       │  │
│  │     - 响应要求：5分钟内响应                                              │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 2.2 告警级别与响应要求

```
┌──────────────────┬────────────────┬────────────────┬────────────────┐
│    告警级别       │    响应时间     │    升级时间     │    通知对象     │
├──────────────────┼────────────────┼────────────────┼────────────────┤
│ P0（最高）        │ < 5分钟        │ < 15分钟        │ 管理层、运营    │
│ P1（高）          │ < 15分钟       │ < 30分钟        │ 售后团队、运营  │
│ P2（中）          │ < 30分钟       │ < 1小时         │ 售后团队        │
│ P3（低）          │ < 1小时        | 不升级          | 售后团队        │
└──────────────────┴────────────────┴────────────────┴────────────────┘
```

---

## 3. 告警创建流程

### 3.1 流程图

```
AI分析完成
    ↓
判断是否需要告警
    ├─ 否 → 不创建告警
    └─ 是 → 继续
    ↓
确定告警类型和级别
    ├─ 用户投诉 → user_complaint, P0
    ├─ 售后任务 → after_sales, P1/P2
    ├─ 低满意度 → low_satisfaction, P2
    └─ 其他 → 根据规则判断
    ↓
创建告警记录
    ├─ 告警ID：自动生成
    ├─ 会话ID：当前会话
    ├─ 用户ID：当前用户
    ├─ 群组ID：当前群组
    ├─ 告警类型：alertType
    ├─ 告警级别：alertLevel
    ├─ 告警原因：reason
    ├─ 创建时间：createdAt
    └─ 状态：created
    ↓
关联消息记录
    ├─ 记录触发告警的消息ID
    ├─ 记录告警相关的上下文
    └─ 保存到alerts表
    ↓
发送通知
    ├─ 根据告警级别确定通知对象
    ├─ 根据通知配置确定通知渠道
    ├─ 发送通知消息
    └─ 记录通知历史
    ↓
启动升级监控
    ├─ 设置定时任务
    ├─ 监控告警状态
    └─ 超时未处理则自动升级
```

### 3.2 详细实现

**文件位置：** `server/services/alert.service.js`

```javascript
const { getDb } = require('coze-coding-dev-sdk');
const { alerts, eq } = require('../database/schema');
const alertNotificationService = require('./alert-notification.service');
const alertEscalationService = require('./alert-escalation.service');
const logger = require('./system-logger.service');

class AlertService {
  /**
   * 创建告警
   */
  async createAlert(alertData) {
    const db = await getDb();

    try {
      logger.info('[告警服务] 创建告警', {
        alertType: alertData.alertType,
        alertLevel: alertData.alertLevel,
        sessionId: alertData.sessionId,
        userId: alertData.userId,
      });

      // 1. 验证告警数据
      this.validateAlertData(alertData);

      // 2. 创建告警记录
      const alert = await db.insert(alerts).values({
        alertId: this.generateAlertId(),
        alertType: alertData.alertType,
        alertLevel: alertData.alertLevel,
        sessionId: alertData.sessionId,
        userId: alertData.userId,
        userName: alertData.userName,
        groupId: alertData.groupId,
        groupName: alertData.groupName,
        messageContent: alertData.messageContent,
        reason: alertData.reason,
        status: 'created',
        acknowledgedBy: null,
        acknowledgedAt: null,
        processedBy: null,
        processedAt: null,
        resolvedBy: null,
        resolvedAt: null,
        escalationLevel: 0,
        escalationHistory: [],
        notificationHistory: [],
        createdAt: new Date(),
        updatedAt: new Date(),
      }).returning();

      // 3. 发送通知
      await alertNotificationService.sendNotifications(alert[0]);

      // 4. 启动升级监控
      await alertEscalationService.startEscalationMonitoring(alert[0]);

      logger.info('[告警服务] 告警创建成功', {
        alertId: alert[0].alertId,
        alertType: alert[0].alertType,
        alertLevel: alert[0].alertLevel,
      });

      return alert[0];
    } catch (error) {
      logger.error('[告警服务] 创建告警失败', {
        error: error.message,
        stack: error.stack,
      });
      throw error;
    }
  }

  /**
   * 确认告警
   */
  async acknowledgeAlert(alertId, acknowledgedBy) {
    const db = await getDb();

    try {
      logger.info('[告警服务] 确认告警', { alertId, acknowledgedBy });

      // 更新告警状态
      const alert = await db
        .update(alerts)
        .set({
          status: 'acknowledged',
          acknowledgedBy,
          acknowledgedAt: new Date(),
          updatedAt: new Date(),
        })
        .where(eq(alerts.alertId, alertId))
        .returning();

      // 停止升级监控
      await alertEscalationService.stopEscalationMonitoring(alertId);

      logger.info('[告警服务] 告警确认成功', { alertId });

      return alert[0];
    } catch (error) {
      logger.error('[告警服务] 确认告警失败', {
        alertId,
        error: error.message,
        stack: error.stack,
      });
      throw error;
    }
  }

  /**
   * 处理告警
   */
  async processAlert(alertId, processedBy, processNotes) {
    const db = await getDb();

    try {
      logger.info('[告警服务] 处理告警', { alertId, processedBy });

      // 更新告警状态
      const alert = await db
        .update(alerts)
        .set({
          status: 'processing',
          processedBy,
          processedAt: new Date(),
          processNotes,
          updatedAt: new Date(),
        })
        .where(eq(alerts.alertId, alertId))
        .returning();

      logger.info('[告警服务] 告警处理开始', { alertId });

      return alert[0];
    } catch (error) {
      logger.error('[告警服务] 处理告警失败', {
        alertId,
        error: error.message,
        stack: error.stack,
      });
      throw error;
    }
  }

  /**
   * 解决告警
   */
  async resolveAlert(alertId, resolvedBy, resolveNotes) {
    const db = await getDb();

    try {
      logger.info('[告警服务] 解决告警', { alertId, resolvedBy });

      // 更新告警状态
      const alert = await db
        .update(alerts)
        .set({
          status: 'resolved',
          resolvedBy,
          resolvedAt: new Date(),
          resolveNotes,
          updatedAt: new Date(),
        })
        .where(eq(alerts.alertId, alertId))
        .returning();

      // 停止升级监控
      await alertEscalationService.stopEscalationMonitoring(alertId);

      logger.info('[告警服务] 告警解决成功', { alertId });

      return alert[0];
    } catch (error) {
      logger.error('[告警服务] 解决告警失败', {
        alertId,
        error: error.message,
        stack: error.stack,
      });
      throw error;
    }
  }

  /**
   * 取消告警
   */
  async cancelAlert(alertId, cancelledBy, cancelReason) {
    const db = await getDb();

    try {
      logger.info('[告警服务] 取消告警', { alertId, cancelledBy });

      // 更新告警状态
      const alert = await db
        .update(alerts)
        .set({
          status: 'cancelled',
          cancelledBy,
          cancelledAt: new Date(),
          cancelReason,
          updatedAt: new Date(),
        })
        .where(eq(alerts.alertId, alertId))
        .returning();

      // 停止升级监控
      await alertEscalationService.stopEscalationMonitoring(alertId);

      logger.info('[告警服务] 告警取消成功', { alertId });

      return alert[0];
    } catch (error) {
      logger.error('[告警服务] 取消告警失败', {
        alertId,
        error: error.message,
        stack: error.stack,
      });
      throw error;
    }
  }

  /**
   * 获取告警详情
   */
  async getAlertDetails(alertId) {
    const db = await getDb();

    const alert = await db
      .select()
      .from(alerts)
      .where(eq(alerts.alertId, alertId))
      .limit(1);

    if (alert.length === 0) {
      return null;
    }

    return alert[0];
  }

  /**
   * 获取告警列表
   */
  async getAlertList(params) {
    const db = await getDb();

    const { page = 1, pageSize = 20, status, alertLevel, alertType } = params;
    const offset = (page - 1) * pageSize;

    // 构建查询条件
    const conditions = [];

    if (status) {
      conditions.push(eq(alerts.status, status));
    }

    if (alertLevel) {
      conditions.push(eq(alerts.alertLevel, alertLevel));
    }

    if (alertType) {
      conditions.push(eq(alerts.alertType, alertType));
    }

    // 执行查询
    const alertList = await db
      .select()
      .from(alerts)
      .where(conditions.length > 0 ? sql`${sql.and(...conditions)}` : sql`1=1`)
      .orderBy(desc(alerts.createdAt))
      .limit(pageSize)
      .offset(offset);

    return {
      list: alertList,
      page,
      pageSize,
    };
  }

  /**
   * 验证告警数据
   */
  validateAlertData(alertData) {
    const requiredFields = ['alertType', 'alertLevel', 'sessionId', 'userId', 'reason'];

    for (const field of requiredFields) {
      if (!alertData[field]) {
        throw new Error(`缺少必填字段：${field}`);
      }
    }

    // 验证告警类型
    const validAlertTypes = [
      'user_complaint',
      'after_sales',
      'low_satisfaction',
      'frequent_complaint',
      'human_intervention_request',
      'system_error',
    ];

    if (!validAlertTypes.includes(alertData.alertType)) {
      throw new Error(`无效的告警类型：${alertData.alertType}`);
    }

    // 验证告警级别
    const validAlertLevels = ['P0', 'P1', 'P2', 'P3'];

    if (!validAlertLevels.includes(alertData.alertLevel)) {
      throw new Error(`无效的告警级别：${alertData.alertLevel}`);
    }
  }

  /**
   * 生成告警ID
   */
  generateAlertId() {
    const timestamp = Date.now();
    const random = Math.floor(Math.random() * 10000).toString().padStart(4, '0');
    return `ALT-${timestamp}-${random}`;
  }
}

module.exports = new AlertService();
```

---

## 4. 告警升级流程

### 4.1 升级规则

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              升级规则                                        │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │  升级条件：                                                            │  │
│  │  1. 告警状态为 created 或 acknowledged                                 │  │
│  │  2. 超过响应时间未处理                                                 │  │
│  │  3. 升级次数 < 最大升级次数                                             │  │
│  │                                                                        │  │
│  │  升级策略：                                                            │  │
│  │  - P0告警：15分钟未确认 → 升级到P0+（通知更高级别人员）                │  │
│  │  - P1告警：30分钟未确认 → 升级到P0（通知管理层）                        │  │
│  │  - P2告警：60分钟未确认 → 升级到P1（通知运营团队）                      │  │
│  │  - P3告警：不升级                                                       │  │
│  │                                                                        │  │
│  │  升级通知：                                                            │  │
│  │  - 通知原通知对象（提醒）                                               │  │
│  │  - 通知更高级别的通知对象                                               │  │
│  │  - 记录升级历史                                                        │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 4.2 详细实现

**文件位置：** `server/services/alert-escalation.service.js`

```javascript
const { getDb } = require('coze-coding-dev-sdk');
const { alerts, eq, sql } = require('../database/schema');
const alertNotificationService = require('./alert-notification.service');
const logger = require('./system-logger.service');

class AlertEscalationService {
  constructor() {
    this.monitoringTimers = new Map();
  }

  /**
   * 启动升级监控
   */
  async startEscalationMonitoring(alert) {
    try {
      logger.info('[告警升级] 启动升级监控', {
        alertId: alert.alertId,
        alertLevel: alert.alertLevel,
      });

      // 获取升级配置
      const escalationConfig = this.getEscalationConfig(alert.alertLevel);

      // 设置定时任务
      const timer = setTimeout(async () => {
        await this.checkEscalation(alert.alertId);
      }, escalationConfig.escalationTime * 60 * 1000); // 转换为毫秒

      // 保存定时器
      this.monitoringTimers.set(alert.alertId, timer);

      logger.info('[告警升级] 升级监控已启动', {
        alertId: alert.alertId,
        escalationTime: escalationConfig.escalationTime,
      });
    } catch (error) {
      logger.error('[告警升级] 启动升级监控失败', {
        alertId: alert.alertId,
        error: error.message,
        stack: error.stack,
      });
    }
  }

  /**
   * 停止升级监控
   */
  stopEscalationMonitoring(alertId) {
    try {
      const timer = this.monitoringTimers.get(alertId);

      if (timer) {
        clearTimeout(timer);
        this.monitoringTimers.delete(alertId);

        logger.info('[告警升级] 升级监控已停止', { alertId });
      }
    } catch (error) {
      logger.error('[告警升级] 停止升级监控失败', {
        alertId,
        error: error.message,
      });
    }
  }

  /**
   * 检查是否需要升级
   */
  async checkEscalation(alertId) {
    const db = await getDb();

    try {
      logger.info('[告警升级] 检查告警是否需要升级', { alertId });

      // 获取告警信息
      const alert = await db
        .select()
        .from(alerts)
        .where(eq(alerts.alertId, alertId))
        .limit(1);

      if (alert.length === 0) {
        logger.info('[告警升级] 告警不存在', { alertId });
        return;
      }

      const alertData = alert[0];

      // 检查告警状态
      if (alertData.status === 'resolved' || alertData.status === 'cancelled') {
        logger.info('[告警升级] 告警已解决或取消，无需升级', {
          alertId,
          status: alertData.status,
        });
        this.stopEscalationMonitoring(alertId);
        return;
      }

      if (alertData.status === 'processing') {
        logger.info('[告警升级] 告警正在处理中，无需升级', { alertId });
        return;
      }

      // 检查升级次数
      const maxEscalationLevel = this.getMaxEscalationLevel(alertData.alertLevel);

      if (alertData.escalationLevel >= maxEscalationLevel) {
        logger.info('[告警升级] 已达到最大升级次数', {
          alertId,
          escalationLevel: alertData.escalationLevel,
        });
        this.stopEscalationMonitoring(alertId);
        return;
      }

      // 执行升级
      await this.escalateAlert(alertData);
    } catch (error) {
      logger.error('[告警升级] 检查升级失败', {
        alertId,
        error: error.message,
        stack: error.stack,
      });
    }
  }

  /**
   * 升级告警
   */
  async escalateAlert(alert) {
    const db = await getDb();

    try {
      logger.info('[告警升级] 升级告警', {
        alertId: alert.alertId,
        currentLevel: alert.alertLevel,
      });

      // 获取升级配置
      const escalationConfig = this.getEscalationConfig(alert.alertLevel);

      // 更新升级历史
      const newEscalationLevel = alert.escalationLevel + 1;
      const newEscalationHistory = [
        ...(alert.escalationHistory || []),
        {
          level: newEscalationLevel,
          previousLevel: alert.alertLevel,
          escalatedAt: new Date(),
          reason: `超过${escalationConfig.escalationTime}分钟未处理`,
        },
      ];

      // 更新告警
      const updatedAlert = await db
        .update(alerts)
        .set({
          escalationLevel: newEscalationLevel,
          escalationHistory: newEscalationHistory,
          updatedAt: new Date(),
        })
        .where(eq(alerts.alertId, alert.alertId))
        .returning();

      // 发送升级通知
      await alertNotificationService.sendEscalationNotification(updatedAlert[0], escalationConfig);

      // 继续监控下一次升级
      await this.startEscalationMonitoring(updatedAlert[0]);

      logger.info('[告警升级] 告警升级成功', {
        alertId: alert.alertId,
        escalationLevel: newEscalationLevel,
      });

      return updatedAlert[0];
    } catch (error) {
      logger.error('[告警升级] 升级告警失败', {
        alertId: alert.alertId,
        error: error.message,
        stack: error.stack,
      });
      throw error;
    }
  }

  /**
   * 获取升级配置
   */
  getEscalationConfig(alertLevel) {
    const configs = {
      P0: {
        escalationTime: 15, // 15分钟
        newLevel: 'P0+', // 仍为P0，但通知更高级别人员
        notifyAdditionalTargets: ['management'],
      },
      P1: {
        escalationTime: 30, // 30分钟
        newLevel: 'P0',
        notifyAdditionalTargets: ['management', 'operator'],
      },
      P2: {
        escalationTime: 60, // 60分钟
        newLevel: 'P1',
        notifyAdditionalTargets: ['operation_team'],
      },
      P3: {
        escalationTime: null, // 不升级
        newLevel: 'P3',
        notifyAdditionalTargets: [],
      },
    };

    return configs[alertLevel] || configs.P3;
  }

  /**
   * 获取最大升级次数
   */
  getMaxEscalationLevel(alertLevel) {
    const maxLevels = {
      P0: 2,
      P1: 2,
      P2: 2,
      P3: 0,
    };

    return maxLevels[alertLevel] || 0;
  }
}

module.exports = new AlertEscalationService();
```

---

## 5. 告警取消流程

### 5.1 取消条件

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              取消条件                                        │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │  自动取消：                                                            │  │
│  │  1. 用户满意度提升到正常水平                                           │  │
│  │  2. 用户问题已解决（通过售后任务状态）                                   │  │
│  │  3. 用户连续3条正面消息                                                 │  │
│  │                                                                        │  │
│  │  手动取消：                                                            │  │
│  │  1. 工作人员判断无需告警                                               │  │
│  │  2. 误报                                                               │  │
│  │  3. 用户撤销投诉                                                       │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 6. 告警通知流程

### 6.1 通知渠道

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              通知渠道                                        │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │  1. 企业微信                                                           │  │
│  │     - 发送企业微信群消息                                                │  │
│  │     - @相关人员                                                        │  │
│  │     - 优先级最高，主要用于P0/P1告警                                     │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │  2. 微信                                                               │  │
│  │     - 发送微信个人消息                                                  │  │
│  │     - 用于通知特定人员                                                 │  │
│  │     - 用于P0告警                                                        │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │  3. 邮件                                                               │  │
│  │     - 发送详细告警信息                                                  │  │
│  │     - 包含告警详情、会话历史、用户信息                                   │  │
│  │     - 用于所有告警级别                                                 │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │  4. 短信                                                               │  │
│  │     - 发送简短告警通知                                                  │  │
│  │     - 用于P0告警的紧急通知                                              │  │
│  │     - 包含告警ID和简要信息                                              │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 6.2 详细实现

**文件位置：** `server/services/alert-notification.service.js`

```javascript
const { getDb } = require('coze-coding-dev-sdk');
const { alertNotifications, eq } = require('../database/schema');
const weChatWorkService = require('./wechat-work.service');
const weChatService = require('./wechat.service');
const emailService = require('./email.service');
const smsService = require('./sms.service');
const logger = require('./system-logger.service');

class AlertNotificationService {
  /**
   * 发送通知
   */
  async sendNotifications(alert) {
    try {
      logger.info('[告警通知] 发送告警通知', {
        alertId: alert.alertId,
        alertLevel: alert.alertLevel,
      });

      // 获取通知配置
      const notificationConfig = await this.getNotificationConfig(alert);

      // 根据配置发送通知
      const notificationPromises = [];

      if (notificationConfig.sendWeChatWork && notificationConfig.weChatWorkWebhook) {
        notificationPromises.push(
          this.sendWeChatWorkNotification(alert, notificationConfig)
        );
      }

      if (notificationConfig.sendWeChat && notificationConfig.weChatTargets) {
        notificationPromises.push(
          this.sendWeChatNotification(alert, notificationConfig)
        );
      }

      if (notificationConfig.sendEmail && notificationConfig.emailTargets) {
        notificationPromises.push(
          this.sendEmailNotification(alert, notificationConfig)
        );
      }

      if (notificationConfig.sendSms && notificationConfig.smsTargets && alert.alertLevel === 'P0') {
        notificationPromises.push(
          this.sendSmsNotification(alert, notificationConfig)
        );
      }

      // 等待所有通知发送完成
      const results = await Promise.allSettled(notificationPromises);

      // 记录通知历史
      const notificationHistory = results.map((result, index) => ({
        channel: Object.keys(notificationConfig)[index],
        status: result.status === 'fulfilled' ? 'sent' : 'failed',
        sentAt: new Date(),
        error: result.status === 'rejected' ? result.reason.message : null,
      }));

      await this.recordNotificationHistory(alert.alertId, notificationHistory);

      logger.info('[告警通知] 告警通知发送完成', {
        alertId: alert.alertId,
        successCount: results.filter(r => r.status === 'fulfilled').length,
        failureCount: results.filter(r => r.status === 'rejected').length,
      });
    } catch (error) {
      logger.error('[告警通知] 发送告警通知失败', {
        alertId: alert.alertId,
        error: error.message,
        stack: error.stack,
      });
      throw error;
    }
  }

  /**
   * 发送升级通知
   */
  async sendEscalationNotification(alert, escalationConfig) {
    try {
      logger.info('[告警通知] 发送告警升级通知', {
        alertId: alert.alertId,
        escalationLevel: alert.escalationLevel,
      });

      // 构建升级通知消息
      const message = this.buildEscalationMessage(alert, escalationConfig);

      // 发送到企业微信
      await weChatWorkService.sendMessage({
        webhook: process.env.WECHAT_WORK_ALERT_WEBHOOK,
        message: {
          msgtype: 'markdown',
          markdown: {
            content: message,
          },
        },
      });

      logger.info('[告警通知] 告警升级通知发送成功', {
        alertId: alert.alertId,
      });
    } catch (error) {
      logger.error('[告警通知] 发送告警升级通知失败', {
        alertId: alert.alertId,
        error: error.message,
        stack: error.stack,
      });
      throw error;
    }
  }

  /**
   * 发送企业微信通知
   */
  async sendWeChatWorkNotification(alert, config) {
    try {
      logger.info('[告警通知] 发送企业微信通知', {
        alertId: alert.alertId,
      });

      const message = this.buildWeChatWorkMessage(alert);

      await weChatWorkService.sendMessage({
        webhook: config.weChatWorkWebhook,
        message: {
          msgtype: 'markdown',
          markdown: {
            content: message,
          },
        },
      });

      return { channel: 'wechat_work', status: 'success' };
    } catch (error) {
      logger.error('[告警通知] 发送企业微信通知失败', {
        alertId: alert.alertId,
        error: error.message,
      });
      return { channel: 'wechat_work', status: 'failed', error: error.message };
    }
  }

  /**
   * 发送微信通知
   */
  async sendWeChatNotification(alert, config) {
    try {
      logger.info('[告警通知] 发送微信通知', {
        alertId: alert.alertId,
      });

      const message = this.buildWeChatMessage(alert);

      for (const target of config.weChatTargets) {
        await weChatService.sendMessage({
          userId: target.userId,
          message,
        });
      }

      return { channel: 'wechat', status: 'success' };
    } catch (error) {
      logger.error('[告警通知] 发送微信通知失败', {
        alertId: alert.alertId,
        error: error.message,
      });
      return { channel: 'wechat', status: 'failed', error: error.message };
    }
  }

  /**
   * 发送邮件通知
   */
  async sendEmailNotification(alert, config) {
    try {
      logger.info('[告警通知] 发送邮件通知', {
        alertId: alert.alertId,
      });

      const subject = `[${alert.alertLevel}] 告警：${alert.alertType}`;
      const html = this.buildEmailHtml(alert);

      await emailService.sendEmail({
        to: config.emailTargets,
        subject,
        html,
      });

      return { channel: 'email', status: 'success' };
    } catch (error) {
      logger.error('[告警通知] 发送邮件通知失败', {
        alertId: alert.alertId,
        error: error.message,
      });
      return { channel: 'email', status: 'failed', error: error.message };
    }
  }

  /**
   * 发送短信通知
   */
  async sendSmsNotification(alert, config) {
    try {
      logger.info('[告警通知] 发送短信通知', {
        alertId: alert.alertId,
      });

      const message = `[${alert.alertLevel}] 告警：${alert.alertType}。用户：${alert.userName}。详情请查看邮件。`;

      for (const target of config.smsTargets) {
        await smsService.sendSms({
          phone: target.phone,
          message,
        });
      }

      return { channel: 'sms', status: 'success' };
    } catch (error) {
      logger.error('[告警通知] 发送短信通知失败', {
        alertId: alert.alertId,
        error: error.message,
      });
      return { channel: 'sms', status: 'failed', error: error.message };
    }
  }

  /**
   * 获取通知配置
   */
  async getNotificationConfig(alert) {
    const configs = {
      P0: {
        sendWeChatWork: true,
        sendWeChat: true,
        sendEmail: true,
        sendSms: true,
        weChatWorkWebhook: process.env.WECHAT_WORK_P0_ALERT_WEBHOOK,
        weChatTargets: [
          { userId: 'operator_boss' },
        ],
        emailTargets: ['management@company.com', 'operator@company.com'],
        smsTargets: [
          { phone: '13800000000' },
        ],
      },
      P1: {
        sendWeChatWork: true,
        sendWeChat: false,
        sendEmail: true,
        sendSms: false,
        weChatWorkWebhook: process.env.WECHAT_WORK_P1_ALERT_WEBHOOK,
        emailTargets: ['after_sales@company.com', 'operation@company.com'],
      },
      P2: {
        sendWeChatWork: true,
        sendWeChat: false,
        sendEmail: true,
        sendSms: false,
        weChatWorkWebhook: process.env.WECHAT_WORK_P2_ALERT_WEBHOOK,
        emailTargets: ['after_sales@company.com'],
      },
      P3: {
        sendWeChatWork: true,
        sendWeChat: false,
        sendEmail: true,
        sendSms: false,
        weChatWorkWebhook: process.env.WECHAT_WORK_P3_ALERT_WEBHOOK,
        emailTargets: ['after_sales@company.com'],
      },
    };

    return configs[alert.alertLevel] || configs.P3;
  }

  /**
   * 记录通知历史
   */
  async recordNotificationHistory(alertId, notificationHistory) {
    const db = await getDb();

    await db.insert(alertNotifications).values(
      notificationHistory.map(history => ({
        alertId,
        ...history,
      }))
    );
  }

  /**
   * 构建企业微信消息
   */
  buildWeChatWorkMessage(alert) {
    const levelColor = {
      P0: '🔴',
      P1: '🟠',
      P2: '🟡',
      P3: '🟢',
    };

    return `
# ${levelColor[alert.alertLevel]} 【${alert.alertLevel}】告警通知

**告警类型**：${alert.alertType}
**告警级别**：${alert.alertLevel}
**用户**：${alert.userName}
**群组**：${alert.groupName}
**告警原因**：${alert.reason}

**消息内容**：
${alert.messageContent}

**创建时间**：${alert.createdAt.toLocaleString('zh-CN')}
**告警ID**：${alert.alertId}

请及时处理！
`;
  }

  /**
   * 构建升级通知消息
   */
  buildEscalationMessage(alert, escalationConfig) {
    return `
# ⚠️ 【告警升级通知】

**告警ID**：${alert.alertId}
**升级级别**：第${alert.escalationLevel}级
**升级原因**：${escalationConfig.reason}

**原告警信息**：
- 告警类型：${alert.alertType}
- 告警级别：${alert.alertLevel}
- 用户：${alert.userName}
- 群组：${alert.groupName}

**升级时间**：${new Date().toLocaleString('zh-CN')}

请立即处理！
`;
  }

  /**
   * 构建微信消息
   */
  buildWeChatMessage(alert) {
    return `
【${alert.alertLevel}】告警通知

告警类型：${alert.alertType}
用户：${alert.userName}
群组：${alert.groupName}
原因：${alert.reason}

消息：${alert.messageContent}

请及时处理。
`;
  }

  /**
   * 构建邮件HTML
   */
  buildEmailHtml(alert) {
    return `
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>告警通知</title>
</head>
<body>
  <h1>【${alert.alertLevel}】告警通知</h1>

  <table>
    <tr><td>告警ID</td><td>${alert.alertId}</td></tr>
    <tr><td>告警类型</td><td>${alert.alertType}</td></tr>
    <tr><td>告警级别</td><td>${alert.alertLevel}</td></tr>
    <tr><td>用户</td><td>${alert.userName}</td></tr>
    <tr><td>群组</td><td>${alert.groupName}</td></tr>
    <tr><td>告警原因</td><td>${alert.reason}</td></tr>
    <tr><td>创建时间</td><td>${alert.createdAt.toLocaleString('zh-CN')}</td></tr>
  </table>

  <h2>消息内容</h2>
  <p>${alert.messageContent}</p>

  <p>请及时处理！</p>
</body>
</html>
`;
  }
}

module.exports = new AlertNotificationService();
```

---

## 7. 告警配置管理

### 7.1 配置项

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              配置项                                          │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │  1. 时间间隔配置                                                       │  │
│  │     - P0响应时间：5分钟                                                 │  │
│  │     - P0升级时间：15分钟                                                │  │
│  │     - P1响应时间：15分钟                                                │  │
│  │     - P1升级时间：30分钟                                                │  │
│  │     - P2响应时间：30分钟                                                │  │
│  │     - P2升级时间：60分钟                                                │  │
│  │     - P3响应时间：60分钟                                                │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │  2. 等级策略配置                                                       │  │
│  │     - 投诉默认级别：P0                                                 │  │
│  │     - 售后任务默认级别：P1                                             │  │
│  │     - 低满意度阈值：50分                                               │  │
│  │     - 高投诉次数阈值：2次                                               │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │  3. 通知配置                                                           │  │
│  │     - 企业微信Webhook URL                                              │  │
│  │     - 邮件收件人                                                       │  │
│  │     - 短信收件人                                                       │  │
│  │     - 微信通知目标                                                     │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

**文档版本**：v1.0

**最后更新**：2024-01-10

**文档作者**：WorkTool AI 团队
