# WorkTool AI ä¸­æ¢ç³»ç»Ÿ - æ¨¡å—å‡çº§è¯¦è§£ï¼ˆæµç¨‹å¼•æ“ç¯‡ï¼‰

## ğŸ“‹ ç›®å½•

1. [æ ¸å¿ƒæµç¨‹æ¦‚è¿°](#1-æ ¸å¿ƒæµç¨‹æ¦‚è¿°)
2. [æ¶ˆæ¯æ¥æ”¶æµç¨‹](#2-æ¶ˆæ¯æ¥æ”¶æµç¨‹)
3. [ä¸Šä¸‹æ–‡ç³»ç»Ÿ](#3-ä¸Šä¸‹æ–‡ç³»ç»Ÿ)
4. [ä¼šè¯ç®¡ç†ç³»ç»Ÿ](#4-ä¼šè¯ç®¡ç†ç³»ç»Ÿ)
5. [AIåˆ†ææµç¨‹](#5-aiåˆ†ææµç¨‹)
6. [å‘Šè­¦ç³»ç»Ÿæµç¨‹](#6-å‘Šè­¦ç³»ç»Ÿæµç¨‹)
7. [ååŒåˆ†ææµç¨‹](#7-ååŒåˆ†ææµç¨‹)
8. [æ¶ˆæ¯å‘é€æµç¨‹](#8-æ¶ˆæ¯å‘é€æµç¨‹)

---

## 1. æ ¸å¿ƒæµç¨‹æ¦‚è¿°

### 1.1 æ•´ä½“æµç¨‹æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           æ ¸å¿ƒæµç¨‹å¼•æ“                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  1. æ¶ˆæ¯æ¥æ”¶æ¨¡å—                                                      â”‚  â”‚
â”‚  â”‚     - æ¥æ”¶ä¼ä¸šå¾®ä¿¡æœºå™¨äººä¸ŠæŠ¥çš„æ¶ˆæ¯                                     â”‚  â”‚
â”‚  â”‚     - è§£ææ¶ˆæ¯å†…å®¹ï¼ˆæ–‡æœ¬ã€å›¾ç‰‡ç­‰ï¼‰                                      â”‚  â”‚
â”‚  â”‚     - ä¿å­˜æ¶ˆæ¯åˆ°æ•°æ®åº“                                                 â”‚  â”‚
â”‚  â”‚     - è§¦å‘åç»­æµç¨‹                                                     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                    â†“                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  2. ä¸Šä¸‹æ–‡æ£€ç´¢æ¨¡å—                                                    â”‚  â”‚
â”‚  â”‚     - æ£€ç´¢ç”¨æˆ·ä¼šè¯ä¸Šä¸‹æ–‡                                               â”‚  â”‚
â”‚  â”‚     - æ£€ç´¢ç¾¤ä¼šè¯ä¸Šä¸‹æ–‡                                                 â”‚  â”‚
â”‚  â”‚     - æ„å»ºä¸Šä¸‹æ–‡çª—å£                                                   â”‚  â”‚
â”‚  â”‚     - æ£€ç´¢å†å²æ¶ˆæ¯                                                     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                    â†“                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  3. AIåˆ†ææ¨¡å—                                                        â”‚  â”‚
â”‚  â”‚     - æ„å›¾è¯†åˆ«                                                         â”‚  â”‚
â”‚  â”‚     - æƒ…æ„Ÿåˆ†æ                                                         â”‚  â”‚
â”‚  â”‚     - å›å¤ç”Ÿæˆ                                                         â”‚  â”‚
â”‚  â”‚     - å‘Šè­¦åˆ¤æ–­                                                         â”‚  â”‚
â”‚  â”‚     - ä»‹å…¥åˆ¤æ–­                                                         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                    â†“                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  4. ä¼šè¯ç®¡ç†æ¨¡å—                                                      â”‚  â”‚
â”‚  â”‚     - åˆ›å»º/æ›´æ–°ä¼šè¯                                                   â”‚  â”‚
â”‚  â”‚     - ä¼šè¯çŠ¶æ€ç®¡ç†                                                     â”‚  â”‚
â”‚  â”‚     - ä¼šè¯ä¸Šä¸‹æ–‡ç®¡ç†                                                   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                    â†“                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  5. å‘Šè­¦ç³»ç»Ÿæ¨¡å—                                                      â”‚  â”‚
â”‚  â”‚     - å‘Šè­¦è§„åˆ™åˆ¤æ–­                                                     â”‚  â”‚
â”‚  â”‚     - å‘Šè­¦åˆ›å»º/æ›´æ–°/å–æ¶ˆ                                               â”‚  â”‚
â”‚  â”‚     - å‘Šè­¦å‡çº§                                                         â”‚  â”‚
â”‚  â”‚     - å‘Šè­¦é€šçŸ¥                                                         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                    â†“                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  6. ååŒåˆ†ææ¨¡å—                                                      â”‚  â”‚
â”‚  â”‚     - å·¥ä½œäººå‘˜ç›‘æ§                                                     â”‚  â”‚
â”‚  â”‚     - ç”¨æˆ·æ»¡æ„åº¦åˆ†æ                                                   â”‚  â”‚
â”‚  â”‚     - äººå·¥ä»‹å…¥åˆ†æ                                                     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                    â†“                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  7. æ¶ˆæ¯å‘é€æ¨¡å—                                                      â”‚  â”‚
â”‚  â”‚     - é€‰æ‹©åˆé€‚çš„æœºå™¨äºº                                                 â”‚  â”‚
â”‚  â”‚     - è®¡ç®—å›å¤å»¶è¿Ÿ                                                     â”‚  â”‚
â”‚  â”‚     - å‘é€æ¶ˆæ¯ç»™æœºå™¨äºº                                                 â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 æ ¸å¿ƒæµç¨‹æ•°æ®æµ

```
æ¶ˆæ¯è¾“å…¥ â†’ æ¶ˆæ¯æ¥æ”¶ â†’ æ¶ˆæ¯ä¿å­˜ â†’ ä¸Šä¸‹æ–‡æ£€ç´¢ â†’ AIåˆ†æ â†’ æ„å›¾è¯†åˆ« â†’ åˆ¤æ–­æµç¨‹åˆ†æ”¯
                                                              â†“
                                                         â”œâ”€ å”®åä»»åŠ¡ â†’ åˆ›å»ºä»»åŠ¡ â†’ é€šçŸ¥å”®å â†’ ç›‘æ§è¿›åº¦
                                                         â”œâ”€ ç”¨æˆ·æŠ•è¯‰ â†’ è§¦å‘P0å‘Šè­¦ â†’ é€šçŸ¥ç®¡ç†å±‚
                                                         â”œâ”€ æ—¥å¸¸èŠå¤© â†’ AIå›å¤ â†’ é€‰æ‹©æœºå™¨äºº â†’ å‘é€
                                                         â”œâ”€ éœ€è¦å‘Šè­¦ â†’ åˆ›å»ºå‘Šè­¦ â†’ å‘Šè­¦å‡çº§ â†’ é€šçŸ¥
                                                         â””â”€ éœ€è¦ä»‹å…¥ â†’ åˆ›å»ºä»‹å…¥è®°å½• â†’ é€šçŸ¥äººå·¥
```

---

## 2. æ¶ˆæ¯æ¥æ”¶æµç¨‹

### 2.1 æµç¨‹æ¦‚è¿°

æ¶ˆæ¯æ¥æ”¶æµç¨‹è´Ÿè´£æ¥æ”¶ä¼ä¸šå¾®ä¿¡æœºå™¨äººä¸ŠæŠ¥çš„æ¶ˆæ¯ï¼Œè§£ææ¶ˆæ¯å†…å®¹ï¼Œå¹¶ä¿å­˜åˆ°æ•°æ®åº“ã€‚

### 2.2 æµç¨‹å›¾

```
ä¼ä¸šå¾®ä¿¡ç¾¤èŠ
    â†“
æœºå™¨äººæ£€æµ‹åˆ°æ–°æ¶ˆæ¯
    â†“
æœºå™¨äººæå–æ¶ˆæ¯ä¿¡æ¯
    â”œâ”€ å‘é€è€…ï¼ˆuserIdã€userNameï¼‰
    â”œâ”€ æ¶ˆæ¯å†…å®¹ï¼ˆtextã€imageç­‰ï¼‰
    â”œâ”€ æ¶ˆæ¯ç±»å‹ï¼ˆtextã€imageã€voiceç­‰ï¼‰
    â”œâ”€ æ—¶é—´æˆ³
    â””â”€ ç¾¤èŠä¿¡æ¯ï¼ˆgroupIdã€groupNameï¼‰
    â†“
æœºå™¨äººé€šè¿‡APIä¸ŠæŠ¥ç»™ç³»ç»Ÿ
    â†“
ç³»ç»Ÿæ¥æ”¶æ¶ˆæ¯
    â†“
éªŒè¯æ¶ˆæ¯æ ¼å¼å’Œå®Œæ•´æ€§
    â†“
è§£ææ¶ˆæ¯å†…å®¹
    â”œâ”€ æ–‡æœ¬æ¶ˆæ¯ï¼šç›´æ¥æå–æ–‡æœ¬
    â”œâ”€ å›¾ç‰‡æ¶ˆæ¯ï¼šæå–å›¾ç‰‡URLï¼Œè°ƒç”¨å›¾ç‰‡è¯†åˆ«
    â”œâ”€ è¯­éŸ³æ¶ˆæ¯ï¼šæå–è¯­éŸ³URLï¼Œè°ƒç”¨è¯­éŸ³è¯†åˆ«
    â””â”€ æ–‡ä»¶æ¶ˆæ¯ï¼šæå–æ–‡ä»¶URL
    â†“
è¯†åˆ«å‘é€è€…ç±»å‹
    â”œâ”€ ç”¨æˆ·ï¼ˆå·ä¸»ï¼‰
    â”œâ”€ å·¥ä½œäººå‘˜ï¼ˆå”®åã€ç¾¤åŠ©ç†ï¼‰
    â”œâ”€ è¿è¥ï¼ˆè€æ¿ï¼‰
    â””â”€ æœºå™¨äºº
    â†“
ä¿å­˜æ¶ˆæ¯åˆ°æ•°æ®åº“ï¼ˆsession_messagesè¡¨ï¼‰
    â†“
å¦‚æœæ˜¯å·¥ä½œäººå‘˜ï¼Œè®°å½•å·¥ä½œäººå‘˜æ´»åŠ¨
    â†“
è§¦å‘åç»­æµç¨‹ï¼ˆä¸Šä¸‹æ–‡æ£€ç´¢ï¼‰
```

### 2.3 è¯¦ç»†å®ç°

**æ–‡ä»¶ä½ç½®ï¼š** `server/services/message-receive.service.js`

```javascript
const { getDb } = require('coze-coding-dev-sdk');
const { sessionMessages, robots, eq } = require('../database/schema');
const contextService = require('./context.service');
const aiAnalysisService = require('./ai-analysis.service');
const staffActivityService = require('./staff-activity.service');
const sessionService = require('./session.service');
const robotService = require('./robot.service');
const logger = require('./system-logger.service');

class MessageReceiveService {
  /**
   * æ¥æ”¶æ¶ˆæ¯
   */
  async receiveMessage(messageData) {
    const db = await getDb();

    try {
      logger.info('[æ¶ˆæ¯æ¥æ”¶] å¼€å§‹å¤„ç†æ¶ˆæ¯', {
        messageId: messageData.messageId,
        messageType: messageData.messageType,
      });

      // 1. éªŒè¯æ¶ˆæ¯æ ¼å¼
      this.validateMessage(messageData);

      // 2. è§£ææ¶ˆæ¯å†…å®¹
      const parsedMessage = await this.parseMessage(messageData);

      // 3. è¯†åˆ«å‘é€è€…ç±»å‹
      const senderType = await this.identifySenderType(parsedMessage);

      // 4. ä¿å­˜æ¶ˆæ¯åˆ°æ•°æ®åº“
      const savedMessage = await this.saveMessage(parsedMessage, senderType);

      // 5. è®°å½•å·¥ä½œäººå‘˜æ´»åŠ¨ï¼ˆå¦‚æœæ˜¯å·¥ä½œäººå‘˜ï¼‰
      if (senderType === 'staff') {
        await staffActivityService.logActivity({
          staffId: parsedMessage.userId,
          staffName: parsedMessage.userName,
          activityType: 'send_message',
          activityData: {
            sessionId: parsedMessage.sessionId,
            groupId: parsedMessage.groupId,
            messageContent: parsedMessage.content,
          },
        });
      }

      // 6. æ›´æ–°ä¼šè¯ä¿¡æ¯
      await sessionService.updateSessionActivity(parsedMessage.sessionId, savedMessage.id);

      // 7. è§¦å‘åç»­æµç¨‹
      await this.triggerNextProcess(savedMessage, senderType);

      logger.info('[æ¶ˆæ¯æ¥æ”¶] æ¶ˆæ¯å¤„ç†å®Œæˆ', {
        messageId: savedMessage.id,
        senderType,
      });

      return {
        success: true,
        messageId: savedMessage.id,
      };
    } catch (error) {
      logger.error('[æ¶ˆæ¯æ¥æ”¶] æ¶ˆæ¯å¤„ç†å¤±è´¥', {
        error: error.message,
        stack: error.stack,
      });
      throw error;
    }
  }

  /**
   * éªŒè¯æ¶ˆæ¯æ ¼å¼
   */
  validateMessage(messageData) {
    const requiredFields = ['messageId', 'sessionId', 'messageType', 'timestamp'];

    for (const field of requiredFields) {
      if (!messageData[field]) {
        throw new Error(`ç¼ºå°‘å¿…å¡«å­—æ®µï¼š${field}`);
      }
    }

    // éªŒè¯æ¶ˆæ¯ç±»å‹
    const validMessageTypes = ['text', 'image', 'voice', 'file', 'video', 'link', 'emoji'];
    if (!validMessageTypes.includes(messageData.messageType)) {
      throw new Error(`æ— æ•ˆçš„æ¶ˆæ¯ç±»å‹ï¼š${messageData.messageType}`);
    }
  }

  /**
   * è§£ææ¶ˆæ¯å†…å®¹
   */
  async parseMessage(messageData) {
    const parsed = {
      messageId: messageData.messageId,
      sessionId: messageData.sessionId,
      groupId: messageData.groupId,
      groupName: messageData.groupName,
      userId: messageData.userId,
      userName: messageData.userName,
      messageType: messageData.messageType,
      content: messageData.content,
      mediaUrl: messageData.mediaUrl,
      timestamp: new Date(messageData.timestamp),
    };

    // å¦‚æœæ˜¯å›¾ç‰‡æ¶ˆæ¯ï¼Œè°ƒç”¨å›¾ç‰‡è¯†åˆ«
    if (messageData.messageType === 'image') {
      parsed.imageText = await this.recognizeImage(messageData.mediaUrl);
    }

    // å¦‚æœæ˜¯è¯­éŸ³æ¶ˆæ¯ï¼Œè°ƒç”¨è¯­éŸ³è¯†åˆ«
    if (messageData.messageType === 'voice') {
      parsed.voiceText = await this.recognizeVoice(messageData.mediaUrl);
    }

    return parsed;
  }

  /**
   * è¯†åˆ«å‘é€è€…ç±»å‹
   */
  async identifySenderType(parsedMessage) {
    const db = await getDb();

    // æ£€æŸ¥æ˜¯å¦æ˜¯æœºå™¨äºº
    const robot = await db.select().from(robots)
      .where(eq(robots.robotId, parsedMessage.userId))
      .limit(1);

    if (robot.length > 0) {
      return 'robot';
    }

    // æ£€æŸ¥æ˜¯å¦æ˜¯å·¥ä½œäººå‘˜ï¼ˆæ ¹æ®ç”¨æˆ·åæˆ–ç”¨æˆ·IDåˆ¤æ–­ï¼‰
    const staffUsernames = ['å”®åäººå·¥A', 'å”®åäººå·¥B', 'ç¾¤åŠ©ç†A', 'ç¾¤åŠ©ç†B'];
    if (staffUsernames.includes(parsedMessage.userName)) {
      return 'staff';
    }

    // æ£€æŸ¥æ˜¯å¦æ˜¯è¿è¥ï¼ˆè€æ¿ï¼‰
    if (parsedMessage.userName === 'è¿è¥è€æ¿') {
      return 'operator';
    }

    // é»˜è®¤æ˜¯ç”¨æˆ·ï¼ˆå·ä¸»ï¼‰
    return 'user';
  }

  /**
   * ä¿å­˜æ¶ˆæ¯åˆ°æ•°æ®åº“
   */
  async saveMessage(parsedMessage, senderType) {
    const db = await getDb();

    // ç¡®å®šæ¶ˆæ¯æ¥æº
    const isFromUser = senderType === 'user';
    const isFromBot = senderType === 'robot';
    const isHuman = senderType === 'staff' || senderType === 'operator';

    // ä¿å­˜æ¶ˆæ¯
    const message = await db.insert(sessionMessages).values({
      messageId: parsedMessage.messageId,
      sessionId: parsedMessage.sessionId,
      userId: parsedMessage.userId,
      userName: parsedMessage.userName,
      groupId: parsedMessage.groupId,
      groupName: parsedMessage.groupName,
      content: parsedMessage.content,
      mediaUrl: parsedMessage.mediaUrl,
      imageText: parsedMessage.imageText,
      voiceText: parsedMessage.voiceText,
      messageType: parsedMessage.messageType,
      isFromUser,
      isFromBot,
      isHuman,
      timestamp: parsedMessage.timestamp,
    }).returning();

    return message[0];
  }

  /**
   * è§¦å‘åç»­æµç¨‹
   */
  async triggerNextProcess(message, senderType) {
    // å¦‚æœæ˜¯ç”¨æˆ·æ¶ˆæ¯ï¼Œéœ€è¦è¿›è¡ŒAIåˆ†æå’Œå›å¤
    if (senderType === 'user') {
      // æ£€ç´¢ä¸Šä¸‹æ–‡
      const context = await contextService.retrieveContext(message.sessionId);

      // AIåˆ†æ
      const aiResult = await aiAnalysisService.analyze({
        message,
        context,
      });

      // æ ¹æ®AIåˆ†æç»“æœæ‰§è¡Œç›¸åº”æ“ä½œ
      await this.handleAIResult(message, aiResult);
    }

    // å¦‚æœæ˜¯å·¥ä½œäººå‘˜æ¶ˆæ¯ï¼Œåªéœ€è¦è®°å½•ï¼Œä¸éœ€è¦å›å¤
    // å¦‚æœæ˜¯è¿è¥æ¶ˆæ¯ï¼Œå¯èƒ½éœ€è¦å®‰æŠšç”¨æˆ·
    if (senderType === 'operator') {
      const context = await contextService.retrieveContext(message.sessionId);
      const aiResult = await aiAnalysisService.analyze({
        message,
        context,
      });

      // è¿è¥æ¶ˆæ¯çš„AIåˆ†æç»“æœç”¨äºç›‘æ§ï¼Œä¸è‡ªåŠ¨å›å¤
      logger.info('[æ¶ˆæ¯æ¥æ”¶] è¿è¥æ¶ˆæ¯åˆ†æç»“æœ', {
        messageId: message.id,
        aiResult,
      });
    }
  }

  /**
   * å¤„ç†AIåˆ†æç»“æœ
   */
  async handleAIResult(message, aiResult) {
    const { intent, sentiment, needReply, needAlert, needIntervention, replySuggestion } = aiResult;

    // 1. å¦‚æœéœ€è¦å‘Šè­¦ï¼Œåˆ›å»ºå‘Šè­¦
    if (needAlert) {
      await this.createAlert(message, aiResult);
    }

    // 2. å¦‚æœéœ€è¦ä»‹å…¥ï¼Œåˆ›å»ºä»‹å…¥è®°å½•
    if (needIntervention) {
      await this.createIntervention(message, aiResult);
    }

    // 3. å¦‚æœæ˜¯å”®åä»»åŠ¡ï¼Œåˆ›å»ºå”®åä»»åŠ¡
    if (intent === 'after_sales') {
      await this.createAfterSalesTask(message, aiResult);
    }

    // 4. å¦‚æœéœ€è¦å›å¤ï¼Œç”Ÿæˆå›å¤
    if (needReply) {
      await this.sendReply(message, aiResult);
    }
  }

  /**
   * åˆ›å»ºå‘Šè­¦
   */
  async createAlert(message, aiResult) {
    const alertService = require('./alert.service');

    await alertService.createAlert({
      alertType: aiResult.alertType || 'user_complaint',
      alertLevel: aiResult.alertLevel || 'P2',
      sessionId: message.sessionId,
      userId: message.userId,
      userName: message.userName,
      groupId: message.groupId,
      groupName: message.groupName,
      messageContent: message.content,
      reason: aiResult.alertReason,
    });
  }

  /**
   * åˆ›å»ºä»‹å…¥è®°å½•
   */
  async createIntervention(message, aiResult) {
    const collaborationDecisionService = require('../lib/services/collaboration-decision-service');

    await collaborationDecisionService.createDecision({
      sessionId: message.sessionId,
      userId: message.userId,
      userName: message.userName,
      decisionType: 'human_intervention',
      reason: aiResult.interventionReason,
      context: {
        message: message.content,
        sentiment: aiResult.sentiment,
      },
    });
  }

  /**
   * åˆ›å»ºå”®åä»»åŠ¡
   */
  async createAfterSalesTask(message, aiResult) {
    const afterSalesTaskService = require('../services/after-sales-task-service');

    await afterSalesTaskService.createTask({
      sessionId: message.sessionId,
      userId: message.userId,
      userName: message.userName,
      groupId: message.groupId,
      groupName: message.groupName,
      taskType: aiResult.taskType,
      description: aiResult.taskDescription,
      priority: 'high',
      source: 'ai_detected',
    });
  }

  /**
   * å‘é€å›å¤
   */
  async sendReply(message, aiResult) {
    const messageSendService = require('./message-send.service');

    // é€‰æ‹©æœºå™¨äºº
    const robot = await robotService.selectRobotForReply(
      aiResult.intent,
      aiResult.priority || 'P2'
    );

    // è·å–å›å¤å»¶è¿Ÿ
    const delay = await messageSendService.getReplyDelay(
      aiResult.intent,
      aiResult.priority || 'P2'
    );

    // å‘é€æ¶ˆæ¯
    await messageSendService.sendMessage({
      robot,
      sessionId: message.sessionId,
      groupId: message.groupId,
      content: aiResult.replySuggestion,
      delay,
    });
  }

  /**
   * å›¾ç‰‡è¯†åˆ«
   */
  async recognizeImage(imageUrl) {
    // è°ƒç”¨å›¾ç‰‡è¯†åˆ«æœåŠ¡
    // è¿™é‡Œéœ€è¦é›†æˆç¬¬ä¸‰æ–¹å›¾ç‰‡è¯†åˆ«API
    // æš‚æ—¶è¿”å›ç©ºå­—ç¬¦ä¸²
    return '';
  }

  /**
   * è¯­éŸ³è¯†åˆ«
   */
  async recognizeVoice(voiceUrl) {
    // è°ƒç”¨è¯­éŸ³è¯†åˆ«æœåŠ¡
    // è¿™é‡Œéœ€è¦é›†æˆç¬¬ä¸‰æ–¹è¯­éŸ³è¯†åˆ«API
    // æš‚æ—¶è¿”å›ç©ºå­—ç¬¦ä¸²
    return '';
  }
}

module.exports = new MessageReceiveService();
```

---

## 3. ä¸Šä¸‹æ–‡ç³»ç»Ÿ

### 3.1 ç³»ç»Ÿæ¦‚è¿°

ä¸Šä¸‹æ–‡ç³»ç»Ÿè´Ÿè´£æ£€ç´¢å’Œç®¡ç†ç”¨æˆ·ä¼šè¯ä¸Šä¸‹æ–‡ã€ç¾¤ä¼šè¯ä¸Šä¸‹æ–‡ï¼Œä¸ºAIåˆ†ææä¾›å†å²æ¶ˆæ¯èƒŒæ™¯ã€‚

### 3.2 ä¸Šä¸‹æ–‡ç±»å‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              ä¸Šä¸‹æ–‡ç³»ç»Ÿ                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  1. ç”¨æˆ·ä¼šè¯ä¸Šä¸‹æ–‡                                                    â”‚  â”‚
â”‚  â”‚     - è¯¥ç”¨æˆ·åœ¨æ‰€æœ‰ç¾¤ç»„ä¸­çš„å†å²æ¶ˆæ¯                                     â”‚  â”‚
â”‚  â”‚     - ç”¨æˆ·ç”»åƒï¼ˆåŸºæœ¬ä¿¡æ¯ã€æ»¡æ„åº¦ã€å†å²æŠ•è¯‰ç­‰ï¼‰                          â”‚  â”‚
â”‚  â”‚     - å”®åä»»åŠ¡å†å²                                                     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  2. ç¾¤ä¼šè¯ä¸Šä¸‹æ–‡                                                      â”‚  â”‚
â”‚  â”‚     - è¯¥ç¾¤ç»„ä¸­çš„æ‰€æœ‰å†å²æ¶ˆæ¯                                           â”‚  â”‚
â”‚  â”‚     - ç¾¤ç»„ä¿¡æ¯ï¼ˆç¾¤ä¸»ã€æˆå‘˜ã€åˆ›å»ºæ—¶é—´ç­‰ï¼‰                                â”‚  â”‚
â”‚  â”‚     - ç¾¤ç»„æ´»åŠ¨ç»Ÿè®¡                                                     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  3. å½“å‰å¯¹è¯ä¸Šä¸‹æ–‡                                                    â”‚  â”‚
â”‚  â”‚     - å½“å‰ä¼šè¯ä¸­çš„æœ€è¿‘Næ¡æ¶ˆæ¯                                          â”‚  â”‚
â”‚  â”‚     - å‘é€è€…ä¿¡æ¯                                                       â”‚  â”‚
â”‚  â”‚     - æ¶ˆæ¯æ—¶é—´çº¿                                                       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.3 ä¸Šä¸‹æ–‡æ£€ç´¢æµç¨‹

```
æ–°æ¶ˆæ¯
    â†“
ç¡®å®šä¼šè¯IDå’Œç”¨æˆ·ID
    â†“
æ£€ç´¢å½“å‰å¯¹è¯ä¸Šä¸‹æ–‡
    â”œâ”€ è·å–è¯¥ä¼šè¯çš„æœ€è¿‘Næ¡æ¶ˆæ¯
    â”œâ”€ æŒ‰æ—¶é—´å€’åºæ’åˆ—
    â””â”€ ä¿ç•™æŒ‡å®šçª—å£å¤§å°çš„æ¶ˆæ¯
    â†“
æ£€ç´¢ç”¨æˆ·ä¼šè¯ä¸Šä¸‹æ–‡
    â”œâ”€ è·å–è¯¥ç”¨æˆ·åœ¨æ‰€æœ‰ç¾¤ç»„ä¸­çš„æœ€è¿‘Næ¡æ¶ˆæ¯
    â”œâ”€ æŒ‰æ—¶é—´å€’åºæ’åˆ—
    â””â”€ ä¿ç•™æŒ‡å®šçª—å£å¤§å°çš„æ¶ˆæ¯
    â†“
æ£€ç´¢ç¾¤ä¼šè¯ä¸Šä¸‹æ–‡
    â”œâ”€ è·å–è¯¥ç¾¤ç»„ä¸­çš„æœ€è¿‘Næ¡æ¶ˆæ¯
    â”œâ”€ æŒ‰æ—¶é—´å€’åºæ’åˆ—
    â””â”€ ä¿ç•™æŒ‡å®šçª—å£å¤§å°çš„æ¶ˆæ¯
    â†“
æ£€ç´¢ç”¨æˆ·ç”»åƒ
    â”œâ”€ è·å–ç”¨æˆ·åŸºæœ¬ä¿¡æ¯
    â”œâ”€ è·å–ç”¨æˆ·æ»¡æ„åº¦è¯„åˆ†
    â”œâ”€ è·å–ç”¨æˆ·å†å²æŠ•è¯‰è®°å½•
    â””â”€ è·å–ç”¨æˆ·å”®åä»»åŠ¡å†å²
    â†“
æ£€ç´¢å”®åä»»åŠ¡çŠ¶æ€
    â”œâ”€ æ£€æŸ¥æ˜¯å¦æœ‰æœªå®Œæˆçš„å”®åä»»åŠ¡
    â”œâ”€ æ£€æŸ¥ä»»åŠ¡è¿›åº¦
    â””â”€ æ£€æŸ¥ä»»åŠ¡å¤„ç†äºº
    â†“
ç»„è£…ä¸Šä¸‹æ–‡
    â”œâ”€ å½“å‰å¯¹è¯ä¸Šä¸‹æ–‡
    â”œâ”€ ç”¨æˆ·ä¼šè¯ä¸Šä¸‹æ–‡
    â”œâ”€ ç¾¤ä¼šè¯ä¸Šä¸‹æ–‡
    â”œâ”€ ç”¨æˆ·ç”»åƒ
    â””â”€ å”®åä»»åŠ¡çŠ¶æ€
    â†“
è¿”å›ä¸Šä¸‹æ–‡ç»™AIåˆ†æ
```

### 3.4 è¯¦ç»†å®ç°

**æ–‡ä»¶ä½ç½®ï¼š** `server/services/context.service.js`

```javascript
const { getDb } = require('coze-coding-dev-sdk');
const { sessionMessages, users, afterSalesTasks, eq, sql, desc } = require('../database/schema');
const { redis } = require('../lib/redis');
const logger = require('./system-logger.service');

class ContextService {
  /**
   * æ£€ç´¢ä¸Šä¸‹æ–‡
   */
  async retrieveContext(sessionId, userId = null) {
    try {
      logger.info('[ä¸Šä¸‹æ–‡æ£€ç´¢] å¼€å§‹æ£€ç´¢ä¸Šä¸‹æ–‡', { sessionId, userId });

      // 1. è·å–ä¸Šä¸‹æ–‡çª—å£å¤§å°é…ç½®
      const windowSize = await this.getContextWindowSize();

      // 2. æ£€ç´¢å½“å‰å¯¹è¯ä¸Šä¸‹æ–‡
      const currentConversationContext = await this.retrieveCurrentConversationContext(sessionId, windowSize);

      // 3. æ£€ç´¢ç”¨æˆ·ä¼šè¯ä¸Šä¸‹æ–‡
      const userContext = userId ? await this.retrieveUserContext(userId, windowSize) : null;

      // 4. æ£€ç´¢ç¾¤ä¼šè¯ä¸Šä¸‹æ–‡
      const groupContext = await this.retrieveGroupContext(sessionId, windowSize);

      // 5. æ£€ç´¢ç”¨æˆ·ç”»åƒ
      const userProfile = userId ? await this.retrieveUserProfile(userId) : null;

      // 6. æ£€ç´¢å”®åä»»åŠ¡çŠ¶æ€
      const afterSalesTasks = userId ? await this.retrieveAfterSalesTasks(userId) : null;

      // ç»„è£…ä¸Šä¸‹æ–‡
      const context = {
        currentConversation: currentConversationContext,
        userContext,
        groupContext,
        userProfile,
        afterSalesTasks,
        retrievedAt: new Date(),
      };

      logger.info('[ä¸Šä¸‹æ–‡æ£€ç´¢] ä¸Šä¸‹æ–‡æ£€ç´¢å®Œæˆ', {
        sessionId,
        userId,
        currentMessageCount: currentConversationContext.length,
        userMessageCount: userContext?.length || 0,
        groupMessageCount: groupContext.length,
      });

      return context;
    } catch (error) {
      logger.error('[ä¸Šä¸‹æ–‡æ£€ç´¢] ä¸Šä¸‹æ–‡æ£€ç´¢å¤±è´¥', {
        sessionId,
        userId,
        error: error.message,
        stack: error.stack,
      });
      throw error;
    }
  }

  /**
   * æ£€ç´¢å½“å‰å¯¹è¯ä¸Šä¸‹æ–‡
   */
  async retrieveCurrentConversationContext(sessionId, windowSize) {
    const db = await getDb();

    const cacheKey = `context:current:${sessionId}`;

    // å°è¯•ä»ç¼“å­˜è·å–
    if (redis) {
      try {
        const cached = await redis.get(cacheKey);
        if (cached) {
          return JSON.parse(cached);
        }
      } catch (error) {
        logger.error('[ä¸Šä¸‹æ–‡æ£€ç´¢] è¯»å–ç¼“å­˜å¤±è´¥', { error: error.message });
      }
    }

    // ä»æ•°æ®åº“æ£€ç´¢
    const messages = await db
      .select()
      .from(sessionMessages)
      .where(eq(sessionMessages.sessionId, sessionId))
      .orderBy(desc(sessionMessages.timestamp))
      .limit(windowSize);

    // ç¼“å­˜5åˆ†é’Ÿ
    if (redis) {
      try {
        await redis.set(cacheKey, JSON.stringify(messages), 'EX', 300);
      } catch (error) {
        logger.error('[ä¸Šä¸‹æ–‡æ£€ç´¢] ä¿å­˜ç¼“å­˜å¤±è´¥', { error: error.message });
      }
    }

    // æŒ‰æ—¶é—´æ­£åºæ’åˆ—ï¼ˆä»æ—§åˆ°æ–°ï¼‰
    return messages.reverse();
  }

  /**
   * æ£€ç´¢ç”¨æˆ·ä¼šè¯ä¸Šä¸‹æ–‡
   */
  async retrieveUserContext(userId, windowSize) {
    const db = await getDb();

    const cacheKey = `context:user:${userId}`;

    // å°è¯•ä»ç¼“å­˜è·å–
    if (redis) {
      try {
        const cached = await redis.get(cacheKey);
        if (cached) {
          return JSON.parse(cached);
        }
      } catch (error) {
        logger.error('[ä¸Šä¸‹æ–‡æ£€ç´¢] è¯»å–ç¼“å­˜å¤±è´¥', { error: error.message });
      }
    }

    // ä»æ•°æ®åº“æ£€ç´¢
    const messages = await db
      .select()
      .from(sessionMessages)
      .where(eq(sessionMessages.userId, userId))
      .orderBy(desc(sessionMessages.timestamp))
      .limit(windowSize);

    // ç¼“å­˜5åˆ†é’Ÿ
    if (redis) {
      try {
        await redis.set(cacheKey, JSON.stringify(messages), 'EX', 300);
      } catch (error) {
        logger.error('[ä¸Šä¸‹æ–‡æ£€ç´¢] ä¿å­˜ç¼“å­˜å¤±è´¥', { error: error.message });
      }
    }

    // æŒ‰æ—¶é—´æ­£åºæ’åˆ—ï¼ˆä»æ—§åˆ°æ–°ï¼‰
    return messages.reverse();
  }

  /**
   * æ£€ç´¢ç¾¤ä¼šè¯ä¸Šä¸‹æ–‡
   */
  async retrieveGroupContext(sessionId, windowSize) {
    const db = await getDb();

    // å…ˆè·å–ç¾¤ç»„ID
    const sessionInfo = await db
      .select({ groupId: sessionMessages.groupId })
      .from(sessionMessages)
      .where(eq(sessionMessages.sessionId, sessionId))
      .limit(1);

    if (sessionInfo.length === 0) {
      return [];
    }

    const groupId = sessionInfo[0].groupId;
    const cacheKey = `context:group:${groupId}`;

    // å°è¯•ä»ç¼“å­˜è·å–
    if (redis) {
      try {
        const cached = await redis.get(cacheKey);
        if (cached) {
          return JSON.parse(cached);
        }
      } catch (error) {
        logger.error('[ä¸Šä¸‹æ–‡æ£€ç´¢] è¯»å–ç¼“å­˜å¤±è´¥', { error: error.message });
      }
    }

    // ä»æ•°æ®åº“æ£€ç´¢
    const messages = await db
      .select()
      .from(sessionMessages)
      .where(eq(sessionMessages.groupId, groupId))
      .orderBy(desc(sessionMessages.timestamp))
      .limit(windowSize);

    // ç¼“å­˜5åˆ†é’Ÿ
    if (redis) {
      try {
        await redis.set(cacheKey, JSON.stringify(messages), 'EX', 300);
      } catch (error) {
        logger.error('[ä¸Šä¸‹æ–‡æ£€ç´¢] ä¿å­˜ç¼“å­˜å¤±è´¥', { error: error.message });
      }
    }

    // æŒ‰æ—¶é—´æ­£åºæ’åˆ—ï¼ˆä»æ—§åˆ°æ–°ï¼‰
    return messages.reverse();
  }

  /**
   * æ£€ç´¢ç”¨æˆ·ç”»åƒ
   */
  async retrieveUserProfile(userId) {
    const db = await getDb();

    const cacheKey = `profile:${userId}`;

    // å°è¯•ä»ç¼“å­˜è·å–
    if (redis) {
      try {
        const cached = await redis.get(cacheKey);
        if (cached) {
          return JSON.parse(cached);
        }
      } catch (error) {
        logger.error('[ä¸Šä¸‹æ–‡æ£€ç´¢] è¯»å–ç¼“å­˜å¤±è´¥', { error: error.message });
      }
    }

    // è·å–ç”¨æˆ·åŸºæœ¬ä¿¡æ¯
    const user = await db
      .select()
      .from(users)
      .where(eq(users.id, userId))
      .limit(1);

    if (user.length === 0) {
      return null;
    }

    // è·å–ç”¨æˆ·æ»¡æ„åº¦è¯„åˆ†
    const satisfactionScore = await this.calculateUserSatisfactionScore(userId);

    // è·å–ç”¨æˆ·å†å²æŠ•è¯‰è®°å½•
    const complaintCount = await this.getUserComplaintCount(userId);

    // ç»„è£…ç”¨æˆ·ç”»åƒ
    const profile = {
      userId: user[0].id,
      username: user[0].username,
      email: user[0].email,
      realName: user[0].realName,
      satisfactionScore,
      complaintCount,
      registeredAt: user[0].createdAt,
      lastActiveAt: user[0].updatedAt,
    };

    // ç¼“å­˜30åˆ†é’Ÿ
    if (redis) {
      try {
        await redis.set(cacheKey, JSON.stringify(profile), 'EX', 1800);
      } catch (error) {
        logger.error('[ä¸Šä¸‹æ–‡æ£€ç´¢] ä¿å­˜ç¼“å­˜å¤±è´¥', { error: error.message });
      }
    }

    return profile;
  }

  /**
   * æ£€ç´¢å”®åä»»åŠ¡çŠ¶æ€
   */
  async retrieveAfterSalesTasks(userId) {
    const db = await getDb();

    const tasks = await db
      .select()
      .from(afterSalesTasks)
      .where(eq(afterSalesTasks.userId, userId))
      .orderBy(desc(afterSalesTasks.createdAt))
      .limit(10);

    return tasks.map(task => ({
      taskId: task.id,
      taskType: task.taskType,
      status: task.status,
      priority: task.priority,
      assignedTo: task.assignedTo,
      createdAt: task.createdAt,
      completedAt: task.completedAt,
    }));
  }

  /**
   * è·å–ä¸Šä¸‹æ–‡çª—å£å¤§å°é…ç½®
   */
  async getContextWindowSize() {
    const systemSettingService = require('./system-setting.service');

    const windowSize = await systemSettingService.getSetting('context_window_size');

    return parseInt(windowSize) || 20;
  }

  /**
   * è®¡ç®—ç”¨æˆ·æ»¡æ„åº¦è¯„åˆ†
   */
  async calculateUserSatisfactionScore(userId) {
    const db = await getDb();

    const result = await db
      .select({
        total: sql`COUNT(*)`,
        positiveCount: sql`SUM(CASE WHEN sentiment = 'positive' THEN 1 ELSE 0 END)`,
        negativeCount: sql`SUM(CASE WHEN sentiment = 'negative' THEN 1 ELSE 0 END)`,
      })
      .from(sessionMessages)
      .where(eq(sessionMessages.userId, userId));

    const stats = result[0];
    const total = parseInt(stats.total) || 0;

    if (total === 0) {
      return 50; // é»˜è®¤50åˆ†
    }

    const positiveCount = parseInt(stats.positiveCount) || 0;
    const negativeCount = parseInt(stats.negativeCount) || 0;

    // æ»¡æ„åº¦è¯„åˆ† = (æ­£é¢æ•° - è´Ÿé¢æ•°) / æ€»æ•° * 50 + 50
    const score = ((positiveCount - negativeCount) / total) * 50 + 50;

    return Math.round(Math.max(0, Math.min(100, score)));
  }

  /**
   * è·å–ç”¨æˆ·æŠ•è¯‰æ¬¡æ•°
   */
  async getUserComplaintCount(userId) {
    const db = await getDb();

    const result = await db
      .select({ count: sql`COUNT(*)` })
      .from(sessionMessages)
      .where(sql`
        ${sessionMessages.userId} = ${userId}
        AND ${sessionMessages.sentiment} = 'negative'
        AND ${sessionMessages.sentimentIntensity} = 'high'
      `);

    return parseInt(result[0].count) || 0;
  }

  /**
   * æ¸…é™¤ä¸Šä¸‹æ–‡ç¼“å­˜
   */
  async clearContextCache(sessionId, userId = null, groupId = null) {
    if (!redis) {
      return;
    }

    const keysToDelete = [];

    // æ¸…é™¤å½“å‰å¯¹è¯ä¸Šä¸‹æ–‡ç¼“å­˜
    if (sessionId) {
      keysToDelete.push(`context:current:${sessionId}`);
    }

    // æ¸…é™¤ç”¨æˆ·ä¸Šä¸‹æ–‡ç¼“å­˜
    if (userId) {
      keysToDelete.push(`context:user:${userId}`);
      keysToDelete.push(`profile:${userId}`);
    }

    // æ¸…é™¤ç¾¤ä¼šè¯ä¸Šä¸‹æ–‡ç¼“å­˜
    if (groupId) {
      keysToDelete.push(`context:group:${groupId}`);
    }

    for (const key of keysToDelete) {
      try {
        await redis.del(key);
      } catch (error) {
        logger.error('[ä¸Šä¸‹æ–‡æ£€ç´¢] æ¸…é™¤ç¼“å­˜å¤±è´¥', { key, error: error.message });
      }
    }
  }
}

module.exports = new ContextService();
```

---

## 4. ä¼šè¯ç®¡ç†ç³»ç»Ÿ

### 4.1 ç³»ç»Ÿæ¦‚è¿°

ä¼šè¯ç®¡ç†ç³»ç»Ÿè´Ÿè´£åˆ›å»ºã€æ›´æ–°ã€æŸ¥è¯¢ä¼šè¯ï¼Œä»¥åŠä¼šè¯çŠ¶æ€ç®¡ç†ã€‚

### 4.2 ä¼šè¯ç±»å‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              ä¼šè¯ç±»å‹                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  1. ç”¨æˆ·ä¼šè¯                                                          â”‚  â”‚
â”‚  â”‚     - ç”¨æˆ·ä¸ç³»ç»Ÿçš„å¯¹è¯                                                 â”‚  â”‚
â”‚  â”‚     - åŒ…å«ç”¨æˆ·æ¶ˆæ¯å’Œç³»ç»Ÿå›å¤                                           â”‚  â”‚
â”‚  â”‚     - æ”¯æŒå¤šè½®å¯¹è¯                                                     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  2. ç¾¤ä¼šè¯                                                            â”‚  â”‚
â”‚  â”‚     - ç¾¤ç»„ä¸­çš„æ‰€æœ‰æ¶ˆæ¯                                                 â”‚  â”‚
â”‚  â”‚     - åŒ…å«å¤šä¸ªç”¨æˆ·çš„äº¤äº’                                               â”‚  â”‚
â”‚  â”‚     - æ”¯æŒç¾¤ç»„ç®¡ç†                                                     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  3. å”®åä¼šè¯                                                          â”‚  â”‚
â”‚  â”‚     - å”®åä»»åŠ¡ç›¸å…³çš„ä¼šè¯                                               â”‚  â”‚
â”‚  â”‚     - åŒ…å«å”®åå¤„ç†è®°å½•                                                 â”‚  â”‚
â”‚  â”‚     - æ”¯æŒä»»åŠ¡è¿½è¸ª                                                     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.3 ä¼šè¯çŠ¶æ€

```
ä¼šè¯çŠ¶æ€è½¬æ¢ï¼š
activeï¼ˆæ´»è·ƒï¼‰ â†’ processingï¼ˆå¤„ç†ä¸­ï¼‰ â†’ completedï¼ˆå·²å®Œæˆï¼‰
                        â†“
                   pausedï¼ˆæš‚åœï¼‰
```

### 4.4 è¯¦ç»†å®ç°

**æ–‡ä»¶ä½ç½®ï¼š** `server/services/session-management.service.js`

```javascript
const { getDb } = require('coze-coding-dev-sdk');
const { sessionMessages, sql } = require('drizzle-orm');
const logger = require('./system-logger.service');

class SessionManagementService {
  /**
   * åˆ›å»ºä¼šè¯
   */
  async createSession(sessionData) {
    const db = await getDb();

    try {
      logger.info('[ä¼šè¯ç®¡ç†] åˆ›å»ºä¼šè¯', {
        sessionId: sessionData.sessionId,
        userId: sessionData.userId,
      });

      // æ£€æŸ¥ä¼šè¯æ˜¯å¦å·²å­˜åœ¨
      const existingSession = await db
        .select()
        .from(sessionMessages)
        .where(sql`session_id = ${sessionData.sessionId}`)
        .limit(1);

      if (existingSession.length > 0) {
        logger.info('[ä¼šè¯ç®¡ç†] ä¼šè¯å·²å­˜åœ¨', {
          sessionId: sessionData.sessionId,
        });
        return existingSession[0];
      }

      // åˆ›å»ºä¼šè¯ï¼ˆé€šè¿‡æ’å…¥ç¬¬ä¸€æ¡æ¶ˆæ¯ï¼‰
      const session = await db.insert(sessionMessages).values({
        messageId: sessionData.messageId || `msg_${Date.now()}`,
        sessionId: sessionData.sessionId,
        userId: sessionData.userId,
        userName: sessionData.userName,
        groupId: sessionData.groupId,
        groupName: sessionData.groupName,
        content: sessionData.content || '',
        isFromUser: true,
        isFromBot: false,
        isHuman: false,
        timestamp: new Date(),
      }).returning();

      logger.info('[ä¼šè¯ç®¡ç†] ä¼šè¯åˆ›å»ºæˆåŠŸ', {
        sessionId: session[0].sessionId,
      });

      return session[0];
    } catch (error) {
      logger.error('[ä¼šè¯ç®¡ç†] åˆ›å»ºä¼šè¯å¤±è´¥', {
        error: error.message,
        stack: error.stack,
      });
      throw error;
    }
  }

  /**
   * æ›´æ–°ä¼šè¯æ´»åŠ¨
   */
  async updateSessionActivity(sessionId, messageId) {
    const db = await getDb();

    try {
      // æ›´æ–°ä¼šè¯çš„æœ€åæ´»åŠ¨æ—¶é—´
      // è¿™é‡Œå¯ä»¥æ·»åŠ ä¼šè¯çŠ¶æ€æ›´æ–°é€»è¾‘
      logger.info('[ä¼šè¯ç®¡ç†] æ›´æ–°ä¼šè¯æ´»åŠ¨', {
        sessionId,
        messageId,
      });

      return { success: true };
    } catch (error) {
      logger.error('[ä¼šè¯ç®¡ç†] æ›´æ–°ä¼šè¯æ´»åŠ¨å¤±è´¥', {
        error: error.message,
        stack: error.stack,
      });
      throw error;
    }
  }

  /**
   * è·å–ä¼šè¯ä¿¡æ¯
   */
  async getSessionInfo(sessionId) {
    const db = await getDb();

    const result = await db.execute(sql`
      SELECT
        session_id as "sessionId",
        user_id as "userId",
        user_name as "userName",
        group_id as "groupId",
        group_name as "groupName",
        MIN(created_at) as "createdAt",
        MAX(created_at) as "lastActiveTime",
        COUNT(*) as "messageCount",
        SUM(CASE WHEN is_from_bot = true THEN 1 ELSE 0 END) as "botReplyCount",
        SUM(CASE WHEN is_human = true THEN 1 ELSE 0 END) as "humanReplyCount"
      FROM session_messages
      WHERE session_id = ${sessionId}
      GROUP BY session_id, user_id, user_name, group_id, group_name
    `);

    if (result.rows.length === 0) {
      return null;
    }

    return result.rows[0];
  }

  /**
   * è·å–ä¼šè¯åˆ—è¡¨
   */
  async getSessionList(params) {
    const db = await getDb();

    const { page = 1, pageSize = 20, userId, groupId, status } = params;
    const offset = (page - 1) * pageSize;

    let query = sql`
      SELECT
        session_id as "sessionId",
        user_id as "userId",
        user_name as "userName",
        group_id as "groupId",
        group_name as "groupName",
        MAX(created_at) as "lastActiveTime",
        COUNT(*) as "messageCount"
      FROM session_messages
      WHERE 1=1
    `;

    // æ·»åŠ ç­›é€‰æ¡ä»¶
    if (userId) {
      query = sql`${query} AND user_id = ${userId}`;
    }

    if (groupId) {
      query = sql`${query} AND group_id = ${groupId}`;
    }

    // æ·»åŠ åˆ†ç»„å’Œæ’åº
    query = sql`
      ${query}
      GROUP BY session_id, user_id, user_name, group_id, group_name
      ORDER BY MAX(created_at) DESC
      LIMIT ${pageSize} OFFSET ${offset}
    `;

    const result = await db.execute(query);

    return {
      list: result.rows,
      page,
      pageSize,
    };
  }

  /**
   * å…³é—­ä¼šè¯
   */
  async closeSession(sessionId) {
    const db = await getDb();

    try {
      logger.info('[ä¼šè¯ç®¡ç†] å…³é—­ä¼šè¯', { sessionId });

      // æ›´æ–°ä¼šè¯çŠ¶æ€ä¸ºå·²å…³é—­
      // è¿™é‡Œå¯ä»¥æ·»åŠ ä¼šè¯çŠ¶æ€æ›´æ–°é€»è¾‘

      return { success: true };
    } catch (error) {
      logger.error('[ä¼šè¯ç®¡ç†] å…³é—­ä¼šè¯å¤±è´¥', {
        error: error.message,
        stack: error.stack,
      });
      throw error;
    }
  }
}

module.exports = new SessionManagementService();
```

---

ç”±äºæ–‡æ¡£è¿‡é•¿ï¼Œæˆ‘å°†åœ¨åç»­æ–‡ä»¶ä¸­ç»§ç»­ç”Ÿæˆå…¶ä»–æ ¸å¿ƒæµç¨‹çš„è¯¦ç»†æ–‡æ¡£ï¼š

**æŸ¥çœ‹åç»­æ–‡æ¡£ï¼š**
- `æ¨¡å—å‡çº§è¯¦è§£-AIåˆ†ææµç¨‹ç¯‡.md` - æ„å›¾è¯†åˆ«ã€æƒ…æ„Ÿåˆ†æã€å›å¤ç”Ÿæˆã€å‘Šè­¦åˆ¤æ–­ã€ä»‹å…¥åˆ¤æ–­
- `æ¨¡å—å‡çº§è¯¦è§£-å‘Šè­¦ç³»ç»Ÿæµç¨‹ç¯‡.md` - å‘Šè­¦é…ç½®ã€å¤šçº§å‘Šè­¦ã€è‡ªåŠ¨å‡çº§ã€å‘Šè­¦é€šçŸ¥
- `æ¨¡å—å‡çº§è¯¦è§£-ååŒåˆ†ææµç¨‹ç¯‡.md` - å·¥ä½œäººå‘˜ç›‘æ§ã€ç”¨æˆ·æ»¡æ„åº¦åˆ†æ
- `æ¨¡å—å‡çº§è¯¦è§£-å”®åä»»åŠ¡ååŒæµç¨‹ç¯‡.md` - è…¾è®¯æ–‡æ¡£å¯¹æ¥ã€ååŒæµç¨‹
- `æ¨¡å—å‡çº§è¯¦è§£-æ¶ˆæ¯å‘é€æµç¨‹ç¯‡.md` - æœºå™¨äººé€‰æ‹©ã€å›å¤å»¶è¿Ÿã€æ¶ˆæ¯å‘é€

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0

**æœ€åæ›´æ–°**ï¼š2024-01-10

**æ–‡æ¡£ä½œè€…**ï¼šWorkTool AI å›¢é˜Ÿ
