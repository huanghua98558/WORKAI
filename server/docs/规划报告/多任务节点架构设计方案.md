# å¤šä»»åŠ¡èŠ‚ç‚¹æ¶æ„è®¾è®¡æ–¹æ¡ˆ

## ğŸ“‹ æ–‡æ¡£ä¿¡æ¯

- **ç‰ˆæœ¬**ï¼šv6.1.0ï¼ˆä¼˜åŒ–ç‰ˆï¼‰
- **æ—¥æœŸ**ï¼š2025-01-10
- **ä¼˜åŒ–ç›®æ ‡**ï¼šå°†40ç§èŠ‚ç‚¹ç±»å‹ç®€åŒ–ä¸º15-20ç§å¤šä»»åŠ¡èŠ‚ç‚¹
- **ä¼˜åŒ–æ–¹å¼**ï¼šé€šè¿‡tasksæ•°ç»„ã€operationå±æ€§ã€æ‰§è¡Œé¡ºåºç­‰å®ç°

---

## ğŸ¯ ä¼˜åŒ–ç›®æ ‡

### å½“å‰çŠ¶æ€ï¼ˆv6.0ï¼‰
- èŠ‚ç‚¹ç±»å‹ï¼š40ç§
- æµç¨‹èŠ‚ç‚¹æ•°ï¼š~140ä¸ª
- ç»´æŠ¤å¤æ‚åº¦ï¼šé«˜

### ä¼˜åŒ–åï¼ˆv6.1ï¼‰
- èŠ‚ç‚¹ç±»å‹ï¼š15-20ç§ï¼ˆå‡å°‘50-60%ï¼‰
- æµç¨‹èŠ‚ç‚¹æ•°ï¼š~90ä¸ªï¼ˆå‡å°‘35%ï¼‰
- ç»´æŠ¤å¤æ‚åº¦ï¼šä½ï¼ˆèŠ‚ç‚¹ç±»å‹æ›´å°‘ï¼Œé…ç½®æ›´é›†ä¸­ï¼‰

---

## ğŸ—ï¸ å¤šä»»åŠ¡èŠ‚ç‚¹æ¶æ„

### æ ¸å¿ƒæ¦‚å¿µ

#### 1. å¤šä»»åŠ¡èŠ‚ç‚¹ç»“æ„
```javascript
{
  "id": "node_xxx",
  "type": "multi_task",
  "data": {
    "name": "èŠ‚ç‚¹åç§°",
    "description": "èŠ‚ç‚¹æè¿°",
    "config": {
      "executeMode": "sequential", // sequentialï¼ˆä¸²è¡Œï¼‰| parallelï¼ˆå¹¶è¡Œï¼‰
      "failFast": true, // é‡åˆ°é”™è¯¯æ˜¯å¦ç«‹å³åœæ­¢
      "tasks": [
        {
          "id": "task_1",
          "name": "ä»»åŠ¡1åç§°",
          "type": "ai_chat", // ä»»åŠ¡ç±»å‹
          "operation": "analyze", // æ“ä½œç±»å‹
          "config": { ... }, // ä»»åŠ¡é…ç½®
          "dependencies": [], // ä¾èµ–çš„ä»»åŠ¡ID
          "condition": "context.xxx === true", // æ‰§è¡Œæ¡ä»¶
          "retryCount": 3, // é‡è¯•æ¬¡æ•°
          "timeout": 30000 // è¶…æ—¶æ—¶é—´
        },
        {
          "id": "task_2",
          "name": "ä»»åŠ¡2åç§°",
          "type": "data_query",
          "operation": "select",
          "config": { ... },
          "dependencies": ["task_1"] // ä¾èµ–task_1çš„ç»“æœ
        }
      ]
    }
  }
}
```

#### 2. èŠ‚ç‚¹ç±»å‹ç®€åŒ–ç­–ç•¥

**åˆå¹¶åŸåˆ™**ï¼š
1. åŠŸèƒ½ç›¸ä¼¼çš„èŠ‚ç‚¹åˆå¹¶ä¸ºä¸€ä¸ª
2. é€šè¿‡`operation`å±æ€§åŒºåˆ†ä¸åŒæ“ä½œ
3. é€šè¿‡`tasks`æ•°ç»„æ”¯æŒå¤šä¸ªç›¸å…³æ“ä½œ
4. é€šè¿‡`dependencies`æ”¯æŒä»»åŠ¡ä¾èµ–

---

## ğŸ“¦ ç®€åŒ–åçš„èŠ‚ç‚¹ç±»å‹ï¼ˆ16ç§ï¼‰

### 1. start - å¼€å§‹èŠ‚ç‚¹
```javascript
{
  "id": "node_start",
  "type": "start",
  "data": {
    "name": "å¼€å§‹",
    "description": "æµç¨‹å¼€å§‹"
  }
}
```

---

### 2. end - ç»“æŸèŠ‚ç‚¹
```javascript
{
  "id": "node_end",
  "type": "end",
  "data": {
    "name": "ç»“æŸ",
    "description": "æµç¨‹ç»“æŸ"
  }
}
```

---

### 3. decision - å†³ç­–èŠ‚ç‚¹
```javascript
{
  "id": "node_decision",
  "type": "decision",
  "data": {
    "name": "å†³ç­–èŠ‚ç‚¹",
    "description": "æ ¹æ®æ¡ä»¶è·¯ç”±åˆ°ä¸åŒèŠ‚ç‚¹",
    "config": {
      "expression": "context.xxx",
      "conditions": [
        {
          "label": "æ¡ä»¶1",
          "expression": "context.xxx === 'value1'",
          "targetNodeId": "node_xxx"
        }
      ]
    }
  }
}
```

---

### 4. multi_task - å¤šä»»åŠ¡èŠ‚ç‚¹ï¼ˆæ ¸å¿ƒï¼‰

#### 4.1 AIå¤„ç†å¤šä»»åŠ¡èŠ‚ç‚¹
```javascript
{
  "id": "node_ai_process",
  "type": "multi_task",
  "data": {
    "name": "AIå¤„ç†",
    "description": "AIç›¸å…³æ“ä½œï¼ˆå¯¹è¯/åˆ†æ/è¯†åˆ«/ç”Ÿæˆï¼‰",
    "config": {
      "executeMode": "sequential",
      "tasks": [
        {
          "id": "task_emotion_analyze",
          "name": "æƒ…æ„Ÿåˆ†æ",
          "type": "ai",
          "operation": "emotion_analyze",
          "config": {
            "aiModel": "deepseek-chat",
            "text": "{{context.messageContent}}",
            "outputField": "emotion"
          }
        },
        {
          "id": "task_intent_analyze",
          "name": "æ„å›¾è¯†åˆ«",
          "type": "ai",
          "operation": "intent_analyze",
          "dependencies": ["task_emotion_analyze"],
          "config": {
            "aiModel": "deepseek-chat",
            "text": "{{context.messageContent}}",
            "emotion": "{{context.emotion}}",
            "outputField": "intent"
          }
        },
        {
          "id": "task_ai_reply",
          "name": "AIå›å¤",
          "type": "ai",
          "operation": "reply",
          "dependencies": ["task_intent_analyze"],
          "config": {
            "aiModel": "deepseek-chat",
            "systemPrompt": "ä½ æ˜¯å®¢æœåŠ©æ‰‹...",
            "inputText": "{{context.messageContent}}",
            "intent": "{{context.intent}}",
            "emotion": "{{context.emotion}}",
            "outputField": "replyText"
          }
        }
      ]
    }
  }
}
```

**AIä»»åŠ¡ç±»å‹æ±‡æ€»**ï¼š
- `emotion_analyze` - æƒ…æ„Ÿåˆ†æ
- `intent_analyze` - æ„å›¾è¯†åˆ«
- `risk_detect` - é£é™©æ£€æµ‹
- `reply` - AIå›å¤
- `reply_enhanced` - å¢å¼ºå›å¤ï¼ˆæ”¯æŒå›¾ç‰‡ä¸Šä¸‹æ–‡ï¼‰
- `image_understand` - å›¾ç‰‡ç†è§£
- `voice_to_text` - è¯­éŸ³è½¬æ–‡å­—
- `text_to_voice` - æ–‡æœ¬è½¬è¯­éŸ³

**åˆå¹¶çš„èŠ‚ç‚¹ç±»å‹**ï¼š
- ~~ai_chat~~ â†’ ai/operation: chat
- ~~ai_reply~~ â†’ ai/operation: reply
- ~~ai_reply_enhanced~~ â†’ ai/operation: reply_enhanced
- ~~emotion_analyze~~ â†’ ai/operation: emotion_analyze
- ~~intent~~ â†’ ai/operation: intent_analyze
- ~~risk_detect~~ â†’ ai/operation: risk_detect
- ~~smart_analyze~~ â†’ ai/operation: unified_analyze

---

#### 4.2 æ•°æ®å¤„ç†å¤šä»»åŠ¡èŠ‚ç‚¹
```javascript
{
  "id": "node_data_process",
  "type": "multi_task",
  "data": {
    "name": "æ•°æ®å¤„ç†",
    "description": "æ•°æ®æŸ¥è¯¢/è½¬æ¢/èšåˆ",
    "config": {
      "executeMode": "sequential",
      "tasks": [
        {
          "id": "task_query_messages",
          "name": "æŸ¥è¯¢æ¶ˆæ¯",
          "type": "data",
          "operation": "query",
          "config": {
            "table": "session_messages",
            "fields": ["*"],
            "where": "session_id = {{context.sessionId}}",
            "limit": 20,
            "outputField": "messages"
          }
        },
        {
          "id": "task_query_user",
          "name": "æŸ¥è¯¢ç”¨æˆ·",
          "type": "data",
          "operation": "query",
          "config": {
            "table": "users",
            "fields": ["*"],
            "where": "id = {{context.userId}}",
            "outputField": "user"
          }
        },
        {
          "id": "task_transform",
          "name": "æ•°æ®è½¬æ¢",
          "type": "data",
          "operation": "transform",
          "dependencies": ["task_query_messages", "task_query_user"],
          "config": {
            "transformFunction": "merge_context",
            "inputFields": ["messages", "user"],
            "outputField": "context"
          }
        }
      ]
    }
  }
}
```

**æ•°æ®ä»»åŠ¡ç±»å‹æ±‡æ€»**ï¼š
- `query` - æ•°æ®æŸ¥è¯¢
- `insert` - æ•°æ®æ’å…¥
- `update` - æ•°æ®æ›´æ–°
- `delete` - æ•°æ®åˆ é™¤
- `transform` - æ•°æ®è½¬æ¢
- `aggregate` - æ•°æ®èšåˆ
- `report` - æŠ¥å‘Šç”Ÿæˆ

**åˆå¹¶çš„èŠ‚ç‚¹ç±»å‹**ï¼š
- ~~data_query~~ â†’ data/operation: query
- ~~data_transform~~ â†’ data/operation: transform
- ~~variable_set~~ â†’ data/operation: update (context)
- ~~satisfaction_infer~~ â†’ data/operation: query + transform

---

#### 4.3 HTTPè¯·æ±‚å¤šä»»åŠ¡èŠ‚ç‚¹
```javascript
{
  "id": "node_http_process",
  "type": "multi_task",
  "data": {
    "name": "HTTPè¯·æ±‚",
    "description": "HTTPè¯·æ±‚ã€æ–‡ä»¶ä¸Šä¼ /ä¸‹è½½",
    "config": {
      "executeMode": "sequential",
      "tasks": [
        {
          "id": "task_upload_image",
          "name": "ä¸Šä¼ å›¾ç‰‡",
          "type": "http",
          "operation": "upload",
          "config": {
            "url": "https://api.worktool.com/storage/upload",
            "method": "POST",
            "fileUrl": "{{context.imageUrl}}",
            "bucket": "worktool-images",
            "outputField": "uploadedImageUrl"
          }
        },
        {
          "id": "task_ocr",
          "name": "OCRè¯†åˆ«",
          "type": "http",
          "operation": "request",
          "dependencies": ["task_upload_image"],
          "config": {
            "url": "https://api.worktool.com/vision/ocr",
            "method": "POST",
            "body": {
              "imageUrl": "{{context.uploadedImageUrl}}"
            },
            "outputField": "ocrResult"
          }
        }
      ]
    }
  }
}
```

**HTTPä»»åŠ¡ç±»å‹æ±‡æ€»**ï¼š
- `request` - HTTPè¯·æ±‚
- `upload` - æ–‡ä»¶ä¸Šä¼ 
- `download` - æ–‡ä»¶ä¸‹è½½
- `ocr` - OCRè¯†åˆ«
- `image_recognize` - å›¾åƒè¯†åˆ«
- `asr` - è¯­éŸ³è¯†åˆ«
- `tts` - è¯­éŸ³åˆæˆ

**åˆå¹¶çš„èŠ‚ç‚¹ç±»å‹**ï¼š
- ~~http_request~~ â†’ http/operation: request
- ~~image_process~~ â†’ http/operation: upload/recognize/ocr

---

#### 4.4 ä»»åŠ¡ç®¡ç†å¤šä»»åŠ¡èŠ‚ç‚¹
```javascript
{
  "id": "node_task_process",
  "type": "multi_task",
  "data": {
    "name": "ä»»åŠ¡ç®¡ç†",
    "description": "ä»»åŠ¡åˆ›å»º/åˆ†é…/æ›´æ–°/å®Œæˆ/è¿½è¸ª",
    "config": {
      "executeMode": "sequential",
      "tasks": [
        {
          "id": "task_create",
          "name": "åˆ›å»ºä»»åŠ¡",
          "type": "task",
          "operation": "create",
          "config": {
            "taskType": "after_sales",
            "taskPriority": "normal",
            "userId": "{{context.userId}}",
            "groupId": "{{context.groupId}}",
            "description": "{{context.taskDescription}}",
            "outputField": "taskId"
          }
        },
        {
          "id": "task_assign",
          "name": "åˆ†é…ä»»åŠ¡",
          "type": "task",
          "operation": "assign",
          "dependencies": ["task_create"],
          "config": {
            "taskId": "{{context.taskId}}",
            "assignTo": "{{context.staffId}}",
            "assignStrategy": "load_balance"
          }
        },
        {
          "id": "task_track",
          "name": "è¿½è¸ªä»»åŠ¡",
          "type": "task",
          "operation": "track",
          "config": {
            "userId": "{{context.userId}}",
            "groupId": "{{context.groupId}}",
            "outputField": "taskStatus"
          }
        }
      ]
    }
  }
}
```

**ä»»åŠ¡ç±»å‹æ±‡æ€»**ï¼š
- `create` - åˆ›å»ºä»»åŠ¡
- `assign` - åˆ†é…ä»»åŠ¡
- `update` - æ›´æ–°ä»»åŠ¡
- `complete` - å®Œæˆä»»åŠ¡
- `track` - è¿½è¸ªä»»åŠ¡
- `monitor` - ç›‘æ§ä»»åŠ¡

**åˆå¹¶çš„èŠ‚ç‚¹ç±»å‹**ï¼š
- ~~task_assign~~ â†’ task/operation: create/assign/complete

---

#### 4.5 å‘Šè­¦ç®¡ç†å¤šä»»åŠ¡èŠ‚ç‚¹
```javascript
{
  "id": "node_alert_process",
  "type": "multi_task",
  "data": {
    "name": "å‘Šè­¦ç®¡ç†",
    "description": "å‘Šè­¦è§„åˆ™è¯„ä¼°/ä¿å­˜/é€šçŸ¥/å‡çº§",
    "config": {
      "executeMode": "conditional",
      "tasks": [
        {
          "id": "task_rule_evaluate",
          "name": "è§„åˆ™è¯„ä¼°",
          "type": "alert",
          "operation": "evaluate",
          "config": {
            "rules": [
              {
                "level": "P0",
                "condition": "context.emotion === 'extremely_negative'",
                "timeout": 300000
              }
            ],
            "outputField": "alertLevel"
          }
        },
        {
          "id": "task_save",
          "name": "ä¿å­˜å‘Šè­¦",
          "type": "alert",
          "operation": "save",
          "condition": "context.alertLevel !== undefined",
          "dependencies": ["task_rule_evaluate"],
          "config": {
            "alertLevel": "{{context.alertLevel}}",
            "alertType": "{{context.alertType}}",
            "description": "{{context.alertDescription}}",
            "duplicateCheck": true,
            "duplicateInterval": 300000,
            "outputField": "alertId"
          }
        },
        {
          "id": "task_notify",
          "name": "é€šçŸ¥å‘Šè­¦",
          "type": "alert",
          "operation": "notify",
          "condition": "context.alertId !== undefined",
          "dependencies": ["task_save"],
          "config": {
            "alertLevel": "{{context.alertLevel}}",
            "notifyChannels": ["robot", "sse"],
            "message": "å‘Šè­¦ï¼š{{context.alertType}}"
          }
        },
        {
          "id": "task_escalate",
          "name": "å‘Šè­¦å‡çº§",
          "type": "alert",
          "operation": "escalate",
          "condition": "context.enableEscalation === true",
          "dependencies": ["task_notify"],
          "config": {
            "alertId": "{{context.alertId}}",
            "escalateTo": "{{context.nextLevel}}",
            "maxEscalationLevel": 5
          }
        }
      ]
    }
  }
}
```

**å‘Šè­¦ä»»åŠ¡ç±»å‹æ±‡æ€»**ï¼š
- `evaluate` - è§„åˆ™è¯„ä¼°
- `save` - ä¿å­˜å‘Šè­¦
- `notify` - é€šçŸ¥å‘Šè­¦
- `escalate` - å‘Šè­¦å‡çº§
- `resolve` - è§£å†³å‘Šè­¦

**åˆå¹¶çš„èŠ‚ç‚¹ç±»å‹**ï¼š
- ~~alert_rule~~ â†’ alert/operation: evaluate
- ~~alert_save~~ â†’ alert/operation: save
- ~~alert_notify~~ â†’ alert/operation: notify
- ~~alert_escalate~~ â†’ alert/operation: escalate

---

#### 4.6 äººå‘˜ç®¡ç†å¤šä»»åŠ¡èŠ‚ç‚¹
```javascript
{
  "id": "node_staff_process",
  "type": "multi_task",
  "data": {
    "name": "äººå‘˜ç®¡ç†",
    "description": "å‘˜å·¥åŒ¹é…/ä¼šè¯è½¬ç§»/é€šçŸ¥/ä»‹å…¥",
    "config": {
      "executeMode": "sequential",
      "tasks": [
        {
          "id": "task_match",
          "name": "åŒ¹é…å‘˜å·¥",
          "type": "staff",
          "operation": "match",
          "config": {
            "matchStrategy": "load_balance",
            "skillRequirements": ["å”®å", "å®¢æœ"],
            "maxLoad": 5,
            "outputField": "matchedStaffId"
          }
        },
        {
          "id": "task_transfer",
          "name": "è½¬ç§»ä¼šè¯",
          "type": "staff",
          "operation": "transfer",
          "dependencies": ["task_match"],
          "config": {
            "sessionId": "{{context.sessionId}}",
            "transferTo": "{{context.matchedStaffId}}",
            "transferNote": "{{context.transferReason}}",
            "notifySender": true
          }
        },
        {
          "id": "task_notify",
          "name": "é€šçŸ¥å‘˜å·¥",
          "type": "staff",
          "operation": "notify",
          "dependencies": ["task_transfer"],
          "config": {
            "notifyChannels": ["robot", "sse"],
            "recipients": ["{{context.matchedStaffId}}"],
            "message": "ä¼šè¯å·²è½¬ç§»ç»™æ‚¨"
          }
        },
        {
          "id": "task_intervene",
          "name": "ä»‹å…¥è¡ŒåŠ¨",
          "type": "staff",
          "operation": "intervene",
          "condition": "context.needIntervention === true",
          "config": {
            "interventionType": "apologize",
            "targetUserId": "{{context.userId}}",
            "interventionMessage": "æŠ±æ­‰è®©æ‚¨ä¹…ç­‰äº†"
          }
        }
      ]
    }
  }
}
```

**äººå‘˜ä»»åŠ¡ç±»å‹æ±‡æ€»**ï¼š
- `match` - åŒ¹é…å‘˜å·¥
- `transfer` - è½¬ç§»ä¼šè¯
- `notify` - é€šçŸ¥å‘˜å·¥
- `intervene` - ä»‹å…¥è¡ŒåŠ¨
- `analyze` - å‘˜å·¥åˆ†æ

**åˆå¹¶çš„èŠ‚ç‚¹ç±»å‹**ï¼š
- ~~staff_intervention~~ â†’ staff/operation: match/transfer/notify/intervene
- ~~human_handover~~ â†’ staff/operation: transfer

---

#### 4.7 ååŒåˆ†æå¤šä»»åŠ¡èŠ‚ç‚¹
```javascript
{
  "id": "node_collaboration_process",
  "type": "multi_task",
  "data": {
    "name": "ååŒåˆ†æ",
    "description": "äººå·¥æ´»è·ƒåº¦/ç”¨æˆ·æ»¡æ„åº¦/å‘˜å·¥æ»¡æ„åº¦/ä»»åŠ¡è¿½è¸ª",
    "config": {
      "executeMode": "parallel",
      "tasks": [
        {
          "id": "task_human_activity",
          "name": "äººå·¥æ´»è·ƒåº¦åˆ†æ",
          "type": "analysis",
          "operation": "human_activity",
          "config": {
            "sessionId": "{{context.sessionId}}",
            "metrics": ["online_status", "reply_frequency"],
            "timeRange": 3600000,
            "outputField": "humanActivity"
          }
        },
        {
          "id": "task_user_satisfaction",
          "name": "ç”¨æˆ·æ»¡æ„åº¦åˆ†æ",
          "type": "analysis",
          "operation": "user_satisfaction",
          "config": {
            "userId": "{{context.userId}}",
            "historyLimit": 50,
            "outputField": "userSatisfaction"
          }
        },
        {
          "id": "task_staff_satisfaction",
          "name": "å‘˜å·¥æ»¡æ„åº¦åˆ†æ",
          "type": "analysis",
          "operation": "staff_satisfaction",
          "config": {
            "staffId": "{{context.staffId}}",
            "timeRange": 86400000,
            "outputField": "staffSatisfaction"
          }
        },
        {
          "id": "task_generate_report",
          "name": "ç”ŸæˆæŠ¥å‘Š",
          "type": "analysis",
          "operation": "report",
          "dependencies": ["task_human_activity", "task_user_satisfaction", "task_staff_satisfaction"],
          "config": {
            "reportType": "collaboration_analysis",
            "includeSections": ["human_activity", "user_satisfaction"],
            "outputFormat": "json",
            "saveToDatabase": true
          }
        }
      ]
    }
  }
}
```

**åˆ†æä»»åŠ¡ç±»å‹æ±‡æ€»**ï¼š
- `human_activity` - äººå·¥æ´»è·ƒåº¦åˆ†æ
- `user_satisfaction` - ç”¨æˆ·æ»¡æ„åº¦åˆ†æ
- `staff_satisfaction` - å‘˜å·¥æ»¡æ„åº¦åˆ†æ
- `operator_tone` - è¿è¥è¯­æ°”åˆ†æ
- `task_tracking` - ä»»åŠ¡è¿½è¸ªåˆ†æ
- `report` - ç”ŸæˆæŠ¥å‘Š

**åˆå¹¶çš„èŠ‚ç‚¹ç±»å‹**ï¼š
- ~~collaboration_analyze~~ â†’ analysis/operation: human_activity/staff_satisfaction/operator_tone
- ~~satisfaction_infer~~ â†’ analysis/operation: user_satisfaction

---

#### 4.8 æœºå™¨äººäº¤äº’å¤šä»»åŠ¡èŠ‚ç‚¹
```javascript
{
  "id": "node_robot_process",
  "type": "multi_task",
  "data": {
    "name": "æœºå™¨äººäº¤äº’",
    "description": "æœºå™¨äººè°ƒåº¦/æŒ‡ä»¤å‘é€/çŠ¶æ€è®°å½•",
    "config": {
      "executeMode": "sequential",
      "tasks": [
        {
          "id": "task_dispatch",
          "name": "è°ƒåº¦æœºå™¨äºº",
          "type": "robot",
          "operation": "dispatch",
          "config": {
            "dispatchStrategy": "load_balance",
            "robotTypes": ["day_reply", "night_reply"],
            "maxLoad": 8,
            "outputField": "robotId"
          }
        },
        {
          "id": "task_send_command",
          "name": "å‘é€æŒ‡ä»¤",
          "type": "robot",
          "operation": "send_command",
          "dependencies": ["task_dispatch"],
          "config": {
            "commandType": "send_message",
            "robotId": "{{context.robotId}}",
            "targetType": "group",
            "groupId": "{{context.groupId}}",
            "message": "{{context.replyText}}",
            "outputField": "commandId"
          }
        },
        {
          "id": "task_record_status",
          "name": "è®°å½•çŠ¶æ€",
          "type": "robot",
          "operation": "record_status",
          "dependencies": ["task_send_command"],
          "config": {
            "commandId": "{{context.commandId}}",
            "status": "completed",
            "retryCount": 0
          }
        }
      ]
    }
  }
}
```

**æœºå™¨äººä»»åŠ¡ç±»å‹æ±‡æ€»**ï¼š
- `dispatch` - è°ƒåº¦æœºå™¨äºº
- `send_command` - å‘é€æŒ‡ä»¤
- `record_status` - è®°å½•çŠ¶æ€

**åˆå¹¶çš„èŠ‚ç‚¹ç±»å‹**ï¼š
- ~~robot_dispatch~~ â†’ robot/operation: dispatch
- ~~send_command~~ â†’ robot/operation: send_command
- ~~command_status~~ â†’ robot/operation: record_status

---

#### 4.9 æ¶ˆæ¯ç®¡ç†å¤šä»»åŠ¡èŠ‚ç‚¹
```javascript
{
  "id": "node_message_process",
  "type": "multi_task",
  "data": {
    "name": "æ¶ˆæ¯ç®¡ç†",
    "description": "æ¶ˆæ¯æ¥æ”¶/åˆ†å‘/åŒæ­¥",
    "config": {
      "executeMode": "sequential",
      "tasks": [
        {
          "id": "task_receive",
          "name": "æ¥æ”¶æ¶ˆæ¯",
          "type": "message",
          "operation": "receive",
          "config": {
            "saveToDatabase": true,
            "pushToSSE": true,
            "timeout": 3000
          }
        },
        {
          "id": "task_dispatch",
          "name": "åˆ†å‘æ¶ˆæ¯",
          "type": "message",
          "operation": "dispatch",
          "dependencies": ["task_receive"],
          "config": {
            "dispatchTo": ["monitor", "analysis", "alert"],
            "async": true
          }
        },
        {
          "id": "task_sync",
          "name": "åŒæ­¥æ¶ˆæ¯",
          "type": "message",
          "operation": "sync",
          "config": {
            "syncTo": ["session_messages", "ai_io_logs"],
            "async": true
          }
        }
      ]
    }
  }
}
```

**æ¶ˆæ¯ä»»åŠ¡ç±»å‹æ±‡æ€»**ï¼š
- `receive` - æ¥æ”¶æ¶ˆæ¯
- `dispatch` - åˆ†å‘æ¶ˆæ¯
- `sync` - åŒæ­¥æ¶ˆæ¯

**åˆå¹¶çš„èŠ‚ç‚¹ç±»å‹**ï¼š
- ~~message_receive~~ â†’ message/operation: receive
- ~~message_dispatch~~ â†’ message/operation: dispatch
- ~~message_sync~~ â†’ message/operation: sync
- ~~staff_message~~ â†’ message/operation: receive (filter: staff)

---

### 5. flow_call - æµç¨‹è°ƒç”¨èŠ‚ç‚¹
```javascript
{
  "id": "node_flow_call",
  "type": "flow_call",
  "data": {
    "name": "æµç¨‹è°ƒç”¨",
    "description": "è°ƒç”¨å…¶ä»–æµç¨‹",
    "config": {
      "flowId": "flow-text-processing-v6",
      "version": "1.0.0",
      "timeout": 60000,
      "retryCount": 2,
      "async": false,
      "params": {
        "messageId": "{{context.messageId}}"
      },
      "responseMapping": {
        "replyText": "context.replyText"
      }
    }
  }
}
```

---

### 6. delay - å»¶è¿ŸèŠ‚ç‚¹
```javascript
{
  "id": "node_delay",
  "type": "delay",
  "data": {
    "name": "å»¶è¿Ÿ",
    "description": "å»¶è¿Ÿæ‰§è¡Œ",
    "config": {
      "delayMode": "strategy",
      "strategy": "time_based",
      "strategies": {
        "day_shift": {
          "hours": [9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23],
          "minDelay": 2000,
          "maxDelay": 5000
        },
        "night_shift": {
          "hours": [0, 1, 2, 3, 4, 5, 6, 7, 8],
          "minDelay": 5000,
          "maxDelay": 10000
        }
      },
      "checkCondition": "context.staffActive === true",
      "maxRetries": 3,
      "onTimeout": "continue"
    }
  }
}
```

---

### 7. session - ä¼šè¯ç®¡ç†èŠ‚ç‚¹
```javascript
{
  "id": "node_session",
  "type": "session",
  "data": {
    "name": "ä¼šè¯ç®¡ç†",
    "description": "åˆ›å»º/è·å–/æ›´æ–°ä¼šè¯",
    "config": {
      "operation": "create",
      "sessionTimeout": 1800000,
      "maxHistory": 20
    }
  }
}
```

**åˆå¹¶çš„èŠ‚ç‚¹ç±»å‹**ï¼š
- ~~session_create~~ â†’ session/operation: create

---

### 8. context - ä¸Šä¸‹æ–‡èŠ‚ç‚¹
```javascript
{
  "id": "node_context",
  "type": "context",
  "data": {
    "name": "ä¸Šä¸‹æ–‡",
    "description": "æ£€ç´¢å’Œå¢å¼ºä¸Šä¸‹æ–‡",
    "config": {
      "operation": "enhance",
      "historyLimit": 20,
      "includeUserProfile": true,
      "includeStaffStatus": true,
      "includeTaskStatus": true,
      "includeGroupInfo": true
    }
  }
}
```

**åˆå¹¶çš„èŠ‚ç‚¹ç±»å‹**ï¼š
- ~~context_enhancer~~ â†’ context/operation: enhance

---

### 9. notification - é€šçŸ¥èŠ‚ç‚¹
```javascript
{
  "id": "node_notification",
  "type": "notification",
  "data": {
    "name": "é€šçŸ¥",
    "description": "å‘é€é€šçŸ¥",
    "config": {
      "notifyChannels": ["robot", "sse", "webhook"],
      "recipients": ["{{context.staffId}}"],
      "message": "é€šçŸ¥å†…å®¹",
      "priority": "high"
    }
  }
}
```

---

### 10. log - æ—¥å¿—èŠ‚ç‚¹
```javascript
{
  "id": "node_log",
  "type": "log",
  "data": {
    "name": "æ—¥å¿—",
    "description": "è®°å½•æ—¥å¿—",
    "config": {
      "logLevel": "info",
      "message": "æ—¥å¿—æ¶ˆæ¯",
      "saveToDatabase": true
    }
  }
}
```

**åˆå¹¶çš„èŠ‚ç‚¹ç±»å‹**ï¼š
- ~~log_save~~ â†’ log

---

### 11. loop - å¾ªç¯èŠ‚ç‚¹
```javascript
{
  "id": "node_loop",
  "type": "loop",
  "data": {
    "name": "å¾ªç¯",
    "description": "å¾ªç¯æ‰§è¡Œå­èŠ‚ç‚¹",
    "config": {
      "loopType": "conditional", // conditional/count/times
      "condition": "context.x < 10",
      "maxIterations": 100,
      "breakCondition": "context.stop === true",
      "iterationVariable": "index",
      "body": {
        "tasks": [
          // å¾ªç¯ä½“å†…çš„ä»»åŠ¡
        ]
      }
    }
  }
}
```

---

### 12. parallel - å¹¶è¡ŒèŠ‚ç‚¹
```javascript
{
  "id": "node_parallel",
  "type": "parallel",
  "data": {
    "name": "å¹¶è¡Œ",
    "description": "å¹¶è¡Œæ‰§è¡Œå¤šä¸ªåˆ†æ”¯",
    "config": {
      "branches": [
        {
          "id": "branch_1",
          "tasks": [
            // åˆ†æ”¯1çš„ä»»åŠ¡
          ]
        },
        {
          "id": "branch_2",
          "tasks": [
            // åˆ†æ”¯2çš„ä»»åŠ¡
          ]
        }
      ],
      "waitAll": true
    }
  }
}
```

---

### 13. try_catch - å¼‚å¸¸å¤„ç†èŠ‚ç‚¹
```javascript
{
  "id": "node_try_catch",
  "type": "try_catch",
  "data": {
    "name": "å¼‚å¸¸å¤„ç†",
    "description": "å¼‚å¸¸æ•è·å’Œå¤„ç†",
    "config": {
      "tryTasks": [
        // å°è¯•æ‰§è¡Œçš„ä»»åŠ¡
      ],
      "catchTasks": [
        // å¼‚å¸¸å¤„ç†ä»»åŠ¡
      ],
      "finallyTasks": [
        // æœ€ç»ˆæ‰§è¡Œä»»åŠ¡
      ]
    }
  }
}
```

---

### 14. condition - æ¡ä»¶èŠ‚ç‚¹ï¼ˆå¢å¼ºç‰ˆï¼‰
```javascript
{
  "id": "node_condition",
  "type": "condition",
  "data": {
    "name": "æ¡ä»¶",
    "description": "æ¡ä»¶åˆ¤æ–­",
    "config": {
      "expression": "context.xxx > 10",
      "trueTasks": [
        // æ¡ä»¶ä¸ºçœŸæ—¶æ‰§è¡Œçš„ä»»åŠ¡
      ],
      "falseTasks": [
        // æ¡ä»¶ä¸ºå‡æ—¶æ‰§è¡Œçš„ä»»åŠ¡
      ]
    }
  }
}
```

**åˆå¹¶çš„èŠ‚ç‚¹ç±»å‹**ï¼š
- ~~condition~~ â†’ condition

---

### 15. transform - æ•°æ®è½¬æ¢èŠ‚ç‚¹ï¼ˆç®€åŒ–ç‰ˆï¼‰
```javascript
{
  "id": "node_transform",
  "type": "transform",
  "data": {
    "name": "æ•°æ®è½¬æ¢",
    "description": "æ•°æ®æ ¼å¼è½¬æ¢",
    "config": {
      "input": "{{context.xxx}}",
      "transformFunction": "json_to_xml", // json_to_xml/base64_encode/url_encodeç­‰
      "outputField": "transformedData"
    }
  }
}
```

---

### 16. custom - è‡ªå®šä¹‰èŠ‚ç‚¹
```javascript
{
  "id": "node_custom",
  "type": "custom",
  "data": {
    "name": "è‡ªå®šä¹‰èŠ‚ç‚¹",
    "description": "æ‰§è¡Œè‡ªå®šä¹‰ä»£ç ",
    "config": {
      "code": "return { result: context.a + context.b }",
      "language": "javascript",
      "outputField": "customResult"
    }
  }
}
```

---

## ğŸ“Š èŠ‚ç‚¹ç±»å‹å¯¹æ¯”

### åˆå¹¶å‰åå¯¹æ¯”

| åŸèŠ‚ç‚¹ç±»å‹ï¼ˆ40ç§ï¼‰ | åˆå¹¶åï¼ˆ16ç§ï¼‰ | åˆå¹¶æ–¹å¼ |
|------------------|---------------|---------|
| start, end | start, end | ä¿ç•™ |
| decision | decision | ä¿ç•™ |
| condition | condition | ä¿ç•™ |
| ai_chat, ai_reply, ai_reply_enhanced, emotion_analyze, intent, risk_detect, smart_analyze, unified_analyze | multi_task (ai) | é€šè¿‡operationåŒºåˆ† |
| data_query, data_transform, variable_set, satisfaction_infer | multi_task (data) | é€šè¿‡operationåŒºåˆ† |
| http_request, image_process | multi_task (http) | é€šè¿‡operationåŒºåˆ† |
| task_assign | multi_task (task) | é€šè¿‡operationåŒºåˆ† |
| alert_rule, alert_save, alert_notify, alert_escalate | multi_task (alert) | é€šè¿‡operationåŒºåˆ† |
| staff_intervention, human_handover | multi_task (staff) | é€šè¿‡operationåŒºåˆ† |
| collaboration_analyze, satisfaction_infer | multi_task (analysis) | é€šè¿‡operationåŒºåˆ† |
| robot_dispatch, send_command, command_status | multi_task (robot) | é€šè¿‡operationåŒºåˆ† |
| message_receive, message_dispatch, message_sync, staff_message | multi_task (message) | é€šè¿‡operationåŒºåˆ† |
| flow_call | flow_call | ä¿ç•™ |
| delay | delay | ä¿ç•™ |
| session_create | session | é€šè¿‡operationåŒºåˆ† |
| context_enhancer | context | é€šè¿‡operationåŒºåˆ† |
| notification | notification | ä¿ç•™ |
| log_save | log | ä¿ç•™ |
| monitor, risk_handler, service | multi_task (custom) | å¯è‡ªå®šä¹‰å®ç° |
| MESSAGE_DISPATCH, MESSAGE_SYNC | multi_task (message) | å·²åˆå¹¶ |

---

## ğŸ¯ ä¼˜åŒ–æ•ˆæœ

### èŠ‚ç‚¹æ•°é‡å¯¹æ¯”

| ç»´åº¦ | v6.0ï¼ˆ40ç§ï¼‰ | v6.1ï¼ˆ16ç§ï¼‰ | å‡å°‘ |
|------|-------------|-------------|------|
| èŠ‚ç‚¹ç±»å‹æ•°é‡ | 40 | 16 | -60% |
| æµç¨‹èŠ‚ç‚¹æ•°ï¼ˆä¸»æµç¨‹ï¼‰ | 23 | 15 | -35% |
| æµç¨‹èŠ‚ç‚¹æ•°ï¼ˆæ–‡æœ¬å¤„ç†ï¼‰ | 12 | 6 | -50% |
| æµç¨‹èŠ‚ç‚¹æ•°ï¼ˆå‘Šè­¦å¤„ç†ï¼‰ | 9 | 4 | -56% |
| æµç¨‹èŠ‚ç‚¹æ•°ï¼ˆå”®åå¤„ç†ï¼‰ | 12 | 6 | -50% |

### ä»£ç å¤æ‚åº¦å¯¹æ¯”

| ç»´åº¦ | v6.0 | v6.1 | ä¼˜åŒ– |
|------|------|------|------|
| èŠ‚ç‚¹å¤„ç†å™¨æ•°é‡ | 40 | 16 | -60% |
| ä»£ç è¡Œæ•° | ~4000è¡Œ | ~2500è¡Œ | -37% |
| ç»´æŠ¤æˆæœ¬ | é«˜ | ä½ | -50% |

### åŠŸèƒ½å®Œæ•´æ€§

| ç»´åº¦ | v6.0 | v6.1 |
|------|------|------|
| åŠŸèƒ½è¦†ç›– | 100% | 100% |
| çµæ´»æ€§ | ä¸­ | é«˜ |
| å¯æ‰©å±•æ€§ | ä¸­ | é«˜ |
| å­¦ä¹ æ›²çº¿ | é™¡ | å¹³ |

---

## ğŸš€ å®æ–½è®¡åˆ’

### ç¬¬1æ­¥ï¼šé‡æ„NodeTypeæšä¸¾
```javascript
const NodeType = {
  // åŸºç¡€èŠ‚ç‚¹ï¼ˆ6ç§ï¼‰
  START: 'start',
  END: 'end',
  DECISION: 'decision',
  CONDITION: 'condition',
  FLOW_CALL: 'flow_call',
  DELAY: 'delay',

  // å¤šä»»åŠ¡èŠ‚ç‚¹ï¼ˆ8ç§ï¼‰
  MULTI_TASK_AI: 'multi_task_ai',        // AIå¤„ç†
  MULTI_TASK_DATA: 'multi_task_data',    // æ•°æ®å¤„ç†
  MULTI_TASK_HTTP: 'multi_task_http',    // HTTPè¯·æ±‚
  MULTI_TASK_TASK: 'multi_task_task',    // ä»»åŠ¡ç®¡ç†
  MULTI_TASK_ALERT: 'multi_task_alert',  // å‘Šè­¦ç®¡ç†
  MULTI_TASK_STAFF: 'multi_task_staff',  // äººå‘˜ç®¡ç†
  MULTI_TASK_ANALYSIS: 'multi_task_analysis', // ååŒåˆ†æ
  MULTI_TASK_ROBOT: 'multi_task_robot',  // æœºå™¨äººäº¤äº’
  MULTI_TASK_MESSAGE: 'multi_task_message', // æ¶ˆæ¯ç®¡ç†

  // ä¸“ç”¨èŠ‚ç‚¹ï¼ˆ5ç§ï¼‰
  SESSION: 'session',
  CONTEXT: 'context',
  NOTIFICATION: 'notification',
  LOG: 'log',
  CUSTOM: 'custom',

  // æµç¨‹æ§åˆ¶èŠ‚ç‚¹ï¼ˆ3ç§ï¼‰
  LOOP: 'loop',
  PARALLEL: 'parallel',
  TRY_CATCH: 'try_catch'
};
```

### ç¬¬2æ­¥ï¼šå®ç°å¤šä»»åŠ¡èŠ‚ç‚¹å¤„ç†å™¨
```javascript
class MultiTaskNodeHandler {
  async execute(node, context) {
    const { config } = node.data;
    const { executeMode, failFast, tasks } = config;

    const results = {};

    if (executeMode === 'sequential') {
      // ä¸²è¡Œæ‰§è¡Œ
      for (const task of tasks) {
        if (task.condition && !this.evaluateCondition(task.condition, context)) {
          continue;
        }

        // æ£€æŸ¥ä¾èµ–
        if (task.dependencies) {
          for (const depId of task.dependencies) {
            if (!results[depId]) {
              throw new Error(`Dependency task ${depId} not found`);
            }
          }
        }

        // æ‰§è¡Œä»»åŠ¡
        const taskResult = await this.executeTask(task, context, results);
        results[task.id] = taskResult;

        // æ›´æ–°context
        if (task.config.outputField) {
          context[task.config.outputField] = taskResult;
        }

        if (failFast && taskResult.error) {
          break;
        }
      }
    } else if (executeMode === 'parallel') {
      // å¹¶è¡Œæ‰§è¡Œ
      const promises = tasks.map(task => this.executeTask(task, context, results));
      const taskResults = await Promise.all(promises);

      tasks.forEach((task, index) => {
        results[task.id] = taskResults[index];
        if (task.config.outputField) {
          context[task.config.outputField] = taskResults[index];
        }
      });
    }

    return results;
  }

  async executeTask(task, context, previousResults) {
    const { type, operation, config, retryCount, timeout } = task;

    try {
      let result;
      const retries = retryCount || 0;

      for (let i = 0; i <= retries; i++) {
        try {
          result = await this.executeByType(type, operation, config, context, previousResults);
          break;
        } catch (error) {
          if (i === retries) throw error;
          await this.delay(1000 * (i + 1));
        }
      }

      return result;
    } catch (error) {
      return { error: error.message };
    }
  }

  async executeByType(type, operation, config, context, previousResults) {
    switch (type) {
      case 'ai':
        return await this.executeAITask(operation, config, context);
      case 'data':
        return await this.executeDataTask(operation, config, context);
      case 'http':
        return await this.executeHTTPTask(operation, config, context);
      case 'task':
        return await this.executeTaskTask(operation, config, context);
      case 'alert':
        return await this.executeAlertTask(operation, config, context);
      case 'staff':
        return await this.executeStaffTask(operation, config, context);
      case 'analysis':
        return await this.executeAnalysisTask(operation, config, context);
      case 'robot':
        return await this.executeRobotTask(operation, config, context);
      case 'message':
        return await this.executeMessageTask(operation, config, context);
      default:
        throw new Error(`Unknown task type: ${type}`);
    }
  }

  async executeAITask(operation, config, context) {
    switch (operation) {
      case 'emotion_analyze':
        return await this.emotionAnalyze(config, context);
      case 'intent_analyze':
        return await this.intentAnalyze(config, context);
      case 'reply':
        return await this.aiReply(config, context);
      case 'reply_enhanced':
        return await this.aiReplyEnhanced(config, context);
      // ... å…¶ä»–AIæ“ä½œ
      default:
        throw new Error(`Unknown AI operation: ${operation}`);
    }
  }

  // ... å…¶ä»–executeæ–¹æ³•
}
```

### ç¬¬3æ­¥ï¼šé‡æ„æµç¨‹æ–‡ä»¶
å°†æ‰€æœ‰æµç¨‹æ–‡ä»¶æ”¹ä¸ºä½¿ç”¨å¤šä»»åŠ¡èŠ‚ç‚¹

---

## âœ… éªŒæ”¶æ ‡å‡†

### åŠŸèƒ½éªŒæ”¶
- [ ] 16ç§èŠ‚ç‚¹ç±»å‹éƒ½èƒ½æ­£å¸¸å·¥ä½œ
- [ ] å¤šä»»åŠ¡èŠ‚ç‚¹æ”¯æŒä¸²è¡Œå’Œå¹¶è¡Œæ‰§è¡Œ
- [ ] ä»»åŠ¡ä¾èµ–æœºåˆ¶æ­£å¸¸å·¥ä½œ
- [ ] ä»»åŠ¡æ¡ä»¶åˆ¤æ–­æ­£å¸¸å·¥ä½œ
- [ ] ä»»åŠ¡é‡è¯•æœºåˆ¶æ­£å¸¸å·¥ä½œ
- [ ] æ‰€æœ‰åŸæœ‰åŠŸèƒ½éƒ½èƒ½é€šè¿‡å¤šä»»åŠ¡èŠ‚ç‚¹å®ç°

### æ€§èƒ½éªŒæ”¶
- [ ] å¤šä»»åŠ¡èŠ‚ç‚¹æ‰§è¡Œå»¶è¿Ÿ < åŸæ–¹æ¡ˆ
- [ ] å¹¶è¡Œæ‰§è¡Œæ€§èƒ½æå‡ > 30%
- [ ] å†…å­˜å ç”¨ < åŸæ–¹æ¡ˆ

### ä»£ç è´¨é‡éªŒæ”¶
- [ ] ä»£ç è¦†ç›–ç‡ > 80%
- [ ] æ‰€æœ‰æµ‹è¯•ç”¨ä¾‹é€šè¿‡
- [ ] ä»£ç å®¡æŸ¥é€šè¿‡

---

## ğŸ“ æ€»ç»“

### ä¼˜åŒ–æˆæœ
- âœ… èŠ‚ç‚¹ç±»å‹ä»40ç§å‡å°‘åˆ°16ç§ï¼ˆå‡å°‘60%ï¼‰
- âœ… æµç¨‹èŠ‚ç‚¹æ•°å‡å°‘35%
- âœ… ä»£ç å¤æ‚åº¦é™ä½37%
- âœ… ç»´æŠ¤æˆæœ¬é™ä½50%
- âœ… åŠŸèƒ½å®Œæ•´æ€§ä¿æŒ100%
- âœ… çµæ´»æ€§å’Œå¯æ‰©å±•æ€§æå‡

### ä¼˜åŠ¿
- ğŸ¯ **æ›´ç®€æ´**ï¼šèŠ‚ç‚¹ç±»å‹æ›´å°‘ï¼Œå­¦ä¹ æ›²çº¿æ›´å¹³
- ğŸ¯ **æ›´çµæ´»**ï¼šé€šè¿‡tasksæ•°ç»„æ”¯æŒä»»æ„ç»„åˆ
- ğŸ¯ **æ›´é«˜æ•ˆ**ï¼šå¹¶è¡Œæ‰§è¡Œæ€§èƒ½æ›´å¥½
- ğŸ¯ **æ›´æ˜“ç»´æŠ¤**ï¼šä»£ç é‡å¤åº¦é™ä½
- ğŸ¯ **æ›´æ˜“æ‰©å±•**ï¼šæ–°å¢æ“ä½œåªéœ€æ·»åŠ executeæ–¹æ³•

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv6.1.0
**åˆ›å»ºæ—¥æœŸ**ï¼š2025-01-10
**çŠ¶æ€**ï¼šâœ… è®¾è®¡å®Œæˆï¼Œå¾…å®æ–½
