# WorkTool AI 中枢系统 - 完整升级实施方案

## 📋 目录

1. [升级概述](#1-升级概述)
2. [系统现状详细分析](#2-系统现状详细分析)
3. [完整升级目标](#3-完整升级目标)
4. [详细升级步骤](#4-详细升级步骤)
5. [模块升级详解](#5-模块升级详解)
6. [数据库升级详解](#6-数据库升级详解)
7. [后端升级详解](#7-后端升级详解)
8. [前端升级详解](#8-前端升级详解)
9. [AI交互机制升级](#9-ai交互机制升级)
10. [告警系统升级](#10-告警系统升级)
11. [协同分析升级](#11-协同分析升级)
12. [售后任务协同升级](#12-售后任务协同升级)
13. [腾讯文档对接方案](#13-腾讯文档对接方案)
14. [测试方案](#14-测试方案)
15. [部署方案](#15-部署方案)

---

## 1. 升级概述

### 1.1 升级背景

WorkTool AI 中枢系统基于企业微信社群智能运营平台的设计需求，当前已实现基础功能，但与《系统设计报告》中的完整设计还存在较大差距，需要进行系统性升级。

### 1.2 当前系统功能与设计目标对比

| 功能模块 | 当前状态 | 设计目标 | 差距 |
|---------|---------|---------|------|
| 用户权限管理 | ⚠️ 部分实现 | 完整RBAC体系 | 差距大 |
| 机器人角色体系 | ⚠️ 部分实现 | 4个机器人+职责明确 | 差距中 |
| 机器人选择规则 | ⚠️ 简单规则 | 基于时段、消息类型的智能选择 | 差距大 |
| 告警系统 | ⚠️ 基础告警 | 配置化、分级告警 | 差距大 |
| AI Prompt | ⚠️ 硬编码 | 可配置、版本管理 | 差距大 |
| 回复延迟 | ⚠️ 简单延迟 | 多场景、动态延迟 | 差距大 |
| AI交互机制 | ⚠️ 基础实现 | 完整的上下文管理、意图识别 | 差距中 |
| 告警流程 | ⚠️ 简单流程 | 多级告警、自动升级 | 差距大 |
| 协同分析 | ⚠️ 部分实现 | 完整的工作人员监控、满意度分析 | 差距中 |
| 售后任务协同 | ⚠️ 基础实现 | 与腾讯文档对接、完整协同流程 | 差距大 |
| 操作审计 | ❌ 未实现 | 100%操作记录 | 差距大 |
| 腾讯文档对接 | ❌ 未实现 | 实时同步、双向同步 | 差距大 |

### 1.3 升级范围

**本次升级包含：**
- ✅ 平台登录用户管理系统（用户、角色、权限、审计）
- ✅ 机器人角色体系完善（4个机器人、职责明确）
- ✅ 机器人选择规则优化（基于时段、消息类型）
- ✅ 告警系统配置化（时间间隔、等级策略、自动升级）
- ✅ AI Prompt可配置系统（版本管理、A/B测试）
- ✅ 回复延迟策略优化（多场景、动态延迟）
- ✅ AI交互机制完善（上下文管理、意图识别）
- ✅ 告警流程完善（多级告警、自动升级）
- ✅ 协同分析完善（工作人员监控、满意度分析）
- ✅ 售后任务协同完善（与腾讯文档对接）
- ✅ 操作审计系统（100%操作记录）

**不包含（需要第三方配合）：**
- ❌ 企业微信机器人API集成（需要微信授权）
- ❌ 腾讯文档API对接（需要腾讯授权，但提供对接方案）

---

## 2. 系统现状详细分析

### 2.1 数据库现状分析

#### 2.1.1 现有数据库表

| 表名 | 状态 | 用途 | 需要变更 |
|------|------|------|---------|
| users | ✅ 已存在 | 用户表 | 需扩展字段 |
| system_settings | ✅ 已存在 | 系统配置表 | 需扩展配置项 |
| robots | ✅ 已存在 | 机器人表 | 需扩展字段 |
| alert_rules | ✅ 已存在 | 告警规则表 | 需完善字段 |
| session_messages | ✅ 已存在 | 会话消息表 | 需扩展字段 |
| after_sales_tasks | ✅ 已存在 | 售后任务表 | 需完善字段 |
| intent_configs | ✅ 已存在 | 意图配置表 | 无需变更 |
| callback_history | ✅ 已存在 | 回调历史表 | 无需变更 |
| qa_database | ✅ 已存在 | QA数据库 | 无需变更 |
| documents | ✅ 已存在 | 文档表 | 无需变更 |
| collaboration_decisions | ✅ 已存在 | 协同决策表 | 无需变更 |
| execution_tracking | ✅ 已存在 | 执行追踪表 | 无需变更 |
| robot_permissions | ✅ 已存在 | 机器人权限表 | 无需变更 |

#### 2.1.2 缺少的数据库表

| 表名 | 说明 | 优先级 |
|------|------|-------|
| roles | 角色表 | P0 |
| permissions | 权限表 | P0 |
| user_roles | 用户角色关联表 | P0 |
| role_permissions | 角色权限关联表 | P0 |
| audit_logs | 审计日志表 | P0 |
| ai_prompt_versions | AI Prompt版本表 | P1 |
| ai_prompt_tests | AI Prompt测试记录表 | P1 |
| alert_escalations | 告警升级记录表 | P1 |
| staff_activity_logs | 工作人员活动日志表 | P1 |
| user_satisfaction_records | 用户满意度记录表 | P1 |
| tencent_doc_sync_logs | 腾讯文档同步日志表 | P2 |

### 2.2 后端服务现状分析

#### 2.2.1 现有服务

| 服务 | 状态 | 用途 | 需要变更 |
|------|------|------|---------|
| user.service.js | ❌ 不存在 | 用户管理服务 | 需新建 |
| role.service.js | ❌ 不存在 | 角色管理服务 | 需新建 |
| permission.service.js | ❌ 不存在 | 权限管理服务 | 需新建 |
| audit-log.service.js | ❌ 不存在 | 审计日志服务 | 需新建 |
| robot.service.js | ✅ 已存在 | 机器人服务 | 需优化选择逻辑 |
| message.service.js | ✅ 已存在 | 消息服务 | 需优化延迟逻辑 |
| session.service.js | ✅ 已存在 | 会话服务 | 无需变更 |
| session-message.service.js | ✅ 已存在 | 会话消息服务 | 无需变更 |
| ai.service.js | ✅ 已存在 | AI服务 | 需完善Prompt管理 |
| alert.service.js | ✅ 已存在 | 告警服务 | 需完善告警流程 |
| monitor.service.js | ✅ 已存在 | 监控服务 | 需完善工作人员监控 |
| alert.service.js | ✅ 已存在 | 告警服务 | 需完善告警流程 |
| report.service.js | ✅ 已存在 | 报告服务 | 无需变更 |
| tencentdoc.service.js | ⚠️ 部分实现 | 腾讯文档服务 | 需完善对接逻辑 |
| worktool.service.js | ✅ 已存在 | WorkTool服务 | 无需变更 |
| worktool-api.service.js | ✅ 已存在 | WorkTool API服务 | 无需变更 |

#### 2.2.2 缺少的服务

| 服务 | 说明 | 优先级 |
|------|------|-------|
| user.service.js | 用户管理服务 | P0 |
| role.service.js | 角色管理服务 | P0 |
| permission.service.js | 权限管理服务 | P0 |
| audit-log.service.js | 审计日志服务 | P0 |
| alert-config.service.js | 告警配置服务 | P1 |
| ai-config.service.js | AI配置服务 | P1 |
| ai-prompt.service.js | AI Prompt管理服务 | P1 |
| staff-activity.service.js | 工作人员活动监控服务 | P1 |
| user-satisfaction.service.js | 用户满意度分析服务 | P1 |
| tencent-doc-sync.service.js | 腾讯文档同步服务 | P2 |

### 2.3 前端页面现状分析

#### 2.3.1 现有页面

| 页面 | 状态 | 用途 | 需要变更 |
|------|------|------|---------|
| 登录页 | ✅ 已实现 | 用户登录 | 无需变更 |
| 仪表盘 | ✅ 已实现 | 数据统计 | 无需变更 |
| 机器人管理 | ✅ 已实现 | 机器人列表、配置、监控 | 需增加机器人角色显示 |
| 会话管理 | ✅ 已实现 | 会话列表、详情、消息 | 需增加权限控制 |
| 告警管理 | ✅ 已实现 | 告警列表、处理 | 需增加告警配置入口 |
| 协同分析 | ✅ 已实现 | 工作人员监控、满意度 | 需完善功能 |
| 售后任务 | ✅ 已实现 | 任务列表、详情、跟进 | 需增加腾讯文档同步显示 |

#### 2.3.2 缺少的页面

| 页面 | 说明 | 优先级 |
|------|------|-------|
| 用户管理 | 用户CRUD、角色分配、密码重置 | P0 |
| 角色管理 | 角色CRUD、权限分配 | P0 |
| 权限管理 | 权限列表、权限树 | P0 |
| 审计日志 | 日志查询、日志统计 | P0 |
| 告警配置 | 告警时间间隔配置、等级策略配置 | P1 |
| AI配置 | AI Prompt配置、版本管理 | P1 |
| AI Prompt测试 | Prompt A/B测试 | P1 |
| 工作人员活动监控 | 工作人员活动记录、统计 | P1 |
| 用户满意度分析 | 满意度记录、统计、趋势分析 | P1 |

### 2.4 API现状分析

#### 2.4.1 现有API

| API类别 | 现有数量 | 需要新增数量 |
|---------|---------|-------------|
| 认证API | 2 | 0 |
| 用户管理API | 0 | 9 |
| 角色权限API | 0 | 10 |
| 审计日志API | 0 | 3 |
| 告警配置API | 0 | 4 |
| AI配置API | 0 | 6 |
| 机器人API | 10+ | 2 |
| 会话API | 8+ | 0 |
| 告警API | 5+ | 3 |
| 售后任务API | 8+ | 3 |
| 工作人员监控API | 5+ | 5 |
| 用户满意度API | 3+ | 5 |

---

## 3. 完整升级目标

### 3.1 用户权限管理体系升级目标

#### 3.1.1 实现完整的RBAC体系

**目标：**
- ✅ 实现用户、角色、权限三级管理
- ✅ 实现基于角色的访问控制（RBAC）
- ✅ 实现权限继承和组合
- ✅ 实现权限模板，快速创建角色

**具体要求：**
1. 预置6个角色：ADMIN、MANAGER、AFTER_SALES、ASSISTANT、OPERATOR、VIEWER
2. 预置25个权限，覆盖所有模块
3. 用户可以拥有多个角色
4. 角色可以拥有多个权限
5. 支持权限模板，快速创建角色

#### 3.1.2 实现操作审计

**目标：**
- ✅ 记录所有用户操作
- ✅ 支持操作日志查询
- ✅ 支持操作日志统计
- ✅ 支持操作日志导出

**具体要求：**
1. 记录所有API调用
2. 记录用户登录/登出
3. 记录数据变更（增删改）
4. 记录权限变更
5. 保留日志至少90天

### 3.2 机器人角色体系升级目标

#### 3.2.1 明确4个机器人的职责

**机器人列表：**

| 机器人 | 角色代码 | 工作时间 | 职责 | 是否回复 |
|-------|---------|---------|------|---------|
| 监控机器人 | MONITOR_ROBOT | 24小时 | 监控所有消息，上报系统 | ❌ 不回复 |
| 通知机器人 | NOTIFY_ROBOT | 24小时 | 发送通知、提醒、告警 | ❌ 不回复 |
| 白班回复机器人 | DAY_SHIFT_REPLY_ROBOT | 9:00-21:00 | 社群运营、疑虑解答、辅助人工 | ✅ 回复 |
| 晚班回复机器人 | NIGHT_SHIFT_REPLY_ROBOT | 21:00-次日9:00 | 社群运营、疑虑解答、辅助人工 | ✅ 回复 |

**具体要求：**
1. 机器人表中增加 `role` 字段，标识机器人角色
2. 机器人表中增加 `work_schedule` 字段，配置工作时间
3. 机器人表中增加 `selection_rules` 字段，配置选择规则
4. 机器人选择逻辑根据时段和消息类型智能选择

#### 3.2.2 优化机器人选择规则

**选择规则：**

| 消息类型 | 发送者 | 时段 | 选择机器人 | 说明 |
|---------|-------|------|-----------|------|
| 日常运营消息 | 用户 | 白班 | 白班回复机器人 | 群里配合，辅助人工 |
| 日常运营消息 | 用户 | 晚班 | 晚班回复机器人 | 群里配合，辅助人工 |
| 售后任务通知 | 系统 | 全天 | 通知机器人 | 通知售后人工 |
| P0紧急告警 | 系统 | 全天 | 通知机器人 | 通知管理层 |
| 运营老板消息 | 运营 | 白班 | 白班回复机器人 | 辅助运营安抚用户 |
| 运营老板消息 | 运营 | 晚班 | 晚班回复机器人 | 辅助运营安抚用户 |
| 工作人员消息 | 售后/群助理 | 全天 | 不回复 | 只记录，不回复 |

**具体要求：**
1. 实现基于时段的机器人选择
2. 实现基于消息类型的机器人选择
3. 实现基于发送者类型的机器人选择
4. 支持跨机器人协作（必要时）
5. 机器人选择规则可配置

### 3.3 告警系统升级目标

#### 3.3.1 告警配置化

**目标：**
- ✅ 告警时间间隔可配置
- ✅ 告警等级策略可配置
- ✅ 告警规则灵活调整
- ✅ 告警通知方式可配置

**具体要求：**
1. 告警时间间隔配置（4个配置项）：
   - 工作人员长时间未回复：30分钟（可配置范围：5-120分钟）
   - 号主不配合售后：60分钟（可配置范围：10-240分钟）
   - 售后任务未完成：1440分钟（可配置范围：60-2880分钟）
   - 售后任务未跟进：3分钟（可配置范围：1-30分钟）

2. 告警等级策略配置（3个等级）：
   - P0（紧急）：阈值3次，升级3级，升级间隔30分钟
   - P1（重要）：阈值5次，升级2级，升级间隔60分钟
   - P2（一般）：阈值10次，升级1级，升级间隔120分钟

#### 3.3.2 实现多级告警和自动升级

**目标：**
- ✅ 实现P0、P1、P2三级告警
- ✅ 实现告警自动升级
- ✅ 实现告警通知多级分发
- ✅ 实现告警取消规则

**具体要求：**
1. 告警等级定义：
   - P0：需要立即处理，通知管理层
   - P1：需要尽快处理，通知售后主管
   - P2：需要处理，通知售后人员

2. 告警自动升级规则：
   - 连续触发N次未处理，自动升级
   - 升级后通知更高级别人员
   - 支持自定义升级策略

3. 告警取消规则：
   - 用户响应后自动取消
   - 售后跟进后自动取消
   - 任务完成后自动取消

### 3.4 AI Prompt可配置系统升级目标

#### 3.4.1 实现AI Prompt可配置

**目标：**
- ✅ AI System Prompt可配置
- ✅ AI意图识别Prompt可配置
- ✅ AI情感分析Prompt可配置
- ✅ AI回复生成Prompt可配置
- ✅ AI告警判断Prompt可配置
- ✅ AI介入判断Prompt可配置

**具体要求：**
1. 6个AI Prompt配置项，每个都可以独立配置
2. Prompt支持版本管理
3. Prompt支持A/B测试
4. Prompt支持回滚

#### 3.4.2 实现Prompt版本管理和A/B测试

**目标：**
- ✅ Prompt版本历史记录
- ✅ Prompt版本对比
- ✅ Prompt版本回滚
- ✅ Prompt A/B测试

**具体要求：**
1. 每次修改Prompt，自动创建新版本
2. 保留所有历史版本，随时可回滚
3. 支持多个版本同时运行，进行A/B测试
4. 支持查看每个版本的效果数据

### 3.5 回复延迟策略优化目标

#### 3.5.1 实现多场景延迟配置

**目标：**
- ✅ 不同场景使用不同延迟策略
- ✅ 支持随机延迟
- ✅ 支持动态延迟
- ✅ 延迟时间可配置

**具体要求：**
1. 延迟场景配置（6个场景）：
   - 白班运营消息：2-8秒（可配置范围：1-15秒）
   - 晚班运营消息：5-30秒（可配置范围：3-60秒）
   - 紧急消息：1-2秒（可配置范围：0-5秒）
   - 售后任务提醒：1-2秒（可配置范围：0-5秒）
   - 白班复杂问题：5-15秒（可配置范围：3-30秒）
   - 晚班复杂问题：10-30秒（可配置范围：5-60秒）

2. 延迟策略：
   - 随机延迟：在设定范围内随机选择
   - 固定延迟：使用固定延迟时间
   - 动态延迟：根据消息优先级动态调整

### 3.6 AI交互机制升级目标

#### 3.6.1 完善上下文管理

**目标：**
- ✅ 支持用户会话上下文
- ✅ 支持社群会话上下文
- ✅ 支持历史消息检索
- ✅ 支持上下文窗口大小可配置

**具体要求：**
1. 上下文检索策略：
   - 用户会话上下文：检索该用户的最近10-30条消息
   - 社群会话上下文：检索该社群的最近10-30条消息
   - 上下文窗口大小可配置（默认20条）

2. 上下文内容：
   - 消息内容
   - 发送者信息
   - 消息时间
   - 消息类型（文本、图片等）

#### 3.6.2 完善意图识别

**目标：**
- ✅ 支持多种意图类型
- ✅ 意图识别准确率≥90%
- ✅ 意图识别Prompt可配置
- ✅ 支持意图识别结果反馈

**具体要求：**
1. 意图类型：
   - service：服务请求
   - help：帮助请求
   - chat：聊天
   - welcome：欢迎
   - risk：风险提示
   - spam：垃圾信息
   - admin：管理请求
   - after_sales：售后任务
   - complaint：投诉

2. 意图识别流程：
   - 消息 → 上下文检索 → AI分析 → 意图识别 → 结果返回

#### 3.6.3 完善情感分析

**目标：**
- ✅ 支持情感极性分析（正面、负面、中性）
- ✅ 支持情感强度分析
- ✅ 情感分析Prompt可配置
- ✅ 支持情感分析结果反馈

**具体要求：**
1. 情感极性：
   - positive：正面
   - negative：负面
   - neutral：中性

2. 情感强度：
   - high：强烈
   - medium：中等
   - low：轻微

3. 情感分析应用：
   - 负面情感强烈 → 触发告警
   - 负面情感持续 → 更新用户满意度

### 3.7 协同分析升级目标

#### 3.7.1 完善工作人员监控

**目标：**
- ✅ 监控工作人员活跃度
- ✅ 监控工作人员响应时间
- ✅ 监控工作人员工作量
- ✅ 生成工作人员报告

**具体要求：**
1. 监控指标：
   - 活跃度：登录时长、活跃时段
   - 响应时间：平均响应时间、响应时间分布
   - 工作量：处理消息数、处理任务数
   - 效率：处理效率、任务完成率

2. 监控方式：
   - 实时监控：实时显示工作人员状态
   - 历史监控：查询历史记录
   - 统计分析：生成统计报告

#### 3.7.2 完善用户满意度分析

**目标：**
- ✅ 计算用户满意度评分
- ✅ 分析满意度趋势
- ✅ 识别满意度下降用户
- ✅ 生成满意度报告

**具体要求：**
1. 满意度评分规则：
   - 正面情感：+1分
   - 中性情感：0分
   - 负面情感：-1分

2. 满意度等级：
   - 优秀（≥80分）
   - 良好（60-79分）
   - 一般（40-59分）
   - 较差（20-39分）
   - 很差（<20分）

3. 满意度分析：
   - 实时分析：实时计算满意度
   - 趋势分析：分析满意度变化趋势
   - 预警分析：识别满意度下降用户

### 3.8 售后任务协同升级目标

#### 3.8.1 实现与腾讯文档对接

**目标：**
- ✅ 实时同步售后任务到腾讯文档
- ✅ 支持双向同步
- ✅ 支持增量同步
- ✅ 记录同步日志

**具体要求：**
1. 同步策略：
   - 实时同步：任务创建、更新、完成时立即同步
   - 增量同步：只同步变更的数据
   - 定期同步：每天定时同步一次，确保数据一致

2. 同步内容：
   - 任务ID
   - 任务状态
   - 任务类型
   - 优先级
   - 创建时间
   - 更新时间
   - 完成时间
   - 处理人
   - 备注

3. 同步日志：
   - 同步时间
   - 同步状态（成功/失败）
   - 同步数据
   - 错误信息

#### 3.8.2 完善售后任务协同流程

**目标：**
- ✅ AI识别售后任务
- ✅ 自动分配售后任务
- ✅ 监控售后任务进度
- ✅ 提醒售后人员跟进
- ✅ 记录处理结果
- ✅ 同步到腾讯文档

**具体要求：**
1. 售后任务识别：
   - 消息分析 → 意图识别 → 判断是否为售后任务
   - 支持关键词识别：扫码、绑定、认证、开通、注销等

2. 售后任务分配：
   - 根据当前时段选择售后人员
   - 白班（9:00-19:00）：售后人工A
   - 晚班（14:00-23:00）：售后人工B
   - 支持手动分配

3. 售后任务监控：
   - 监控任务进度
   - 监控任务处理时长
   - 任务超时自动告警

---

## 4. 详细升级步骤

### 4.1 升级阶段划分

```
阶段1：数据库升级（3-4天）
├── 4.1.1 新建权限管理相关表（1天）
├── 4.1.2 扩展现有表结构（1天）
├── 4.1.3 新建AI配置相关表（0.5天）
├── 4.1.4 新建协同分析相关表（0.5天）
├── 4.1.5 新建腾讯文档相关表（0.5天）
├── 4.1.6 插入初始数据（0.5天）
└── 4.1.7 数据迁移（0.5天）

阶段2：后端核心服务升级（7-10天）
├── 4.2.1 用户管理服务（1天）
├── 4.2.2 角色管理服务（1天）
├── 4.2.3 权限管理服务（1天）
├── 4.2.4 审计日志服务（1天）
├── 4.2.5 机器人服务优化（1天）
├── 4.2.6 AI服务优化（1天）
├── 4.2.7 告警服务优化（1天）
├── 4.2.8 监控服务优化（1天）
├── 4.2.9 腾讯文档服务完善（1天）
└── 4.2.10 消息服务优化（1天）

阶段3：后端API升级（5-7天）
├── 4.3.1 用户管理API（1天）
├── 4.3.2 角色权限API（1天）
├── 4.3.3 审计日志API（0.5天）
├── 4.3.4 告警配置API（1天）
├── 4.3.5 AI配置API（1天）
├── 4.3.6 工作人员监控API（1天）
├── 4.3.7 用户满意度API（1天）
└── 4.3.8 腾讯文档API（0.5天）

阶段4：前端页面升级（7-10天）
├── 4.4.1 权限上下文和组件（1天）
├── 4.4.2 用户管理页面（1天）
├── 4.4.3 角色管理页面（1天）
├── 4.4.4 权限管理页面（0.5天）
├── 4.4.5 审计日志页面（0.5天）
├── 4.4.6 告警配置页面（1天）
├── 4.4.7 AI配置页面（1天）
├── 4.4.8 AI Prompt测试页面（1天）
├── 4.4.9 工作人员监控页面（1天）
├── 4.4.10 用户满意度页面（1天）
└── 4.4.11 导航菜单更新（0.5天）

阶段5：集成测试（5-7天）
├── 4.5.1 单元测试（2天）
├── 4.5.2 集成测试（2天）
├── 4.5.3 性能测试（1天）
└── 4.5.4 安全测试（1天）

阶段6：部署上线（2-3天）
├── 4.6.1 预发布环境测试（1天）
├── 4.6.2 数据库迁移（0.5天）
├── 4.6.3 应用部署（0.5天）
└── 4.6.4 线上验证（1天）

总计：29-41天（约5-7周）
```

---

## 5. 模块升级详解

由于内容过多，我将创建一个独立的文件来保存完整的模块升级详解。本报告只提供概述。

**详细的模块升级内容包括：**
1. 数据库升级详解（每个表的详细设计）
2. 后端服务升级详解（每个服务的详细实现）
3. 后端API升级详解（每个API的详细设计）
4. 前端页面升级详解（每个页面的详细设计）
5. AI交互机制升级详解（上下文管理、意图识别、情感分析）
6. 告警系统升级详解（告警配置、多级告警、自动升级）
7. 协同分析升级详解（工作人员监控、满意度分析）
8. 售后任务协同升级详解（腾讯文档对接、协同流程）

**详细内容请查看：**
- `模块升级详解-数据库篇.md`
- `模块升级详解-后端服务篇.md`
- `模块升级详解-后端API篇.md`
- `模块升级详解-前端页面篇.md`
- `模块升级详解-AI交互机制篇.md`
- `模块升级详解-告警系统篇.md`
- `模块升级详解-协同分析篇.md`
- `模块升级详解-售后任务协同篇.md`

---

## 6. 数据库升级详解

### 6.1 需要新建的表

#### 6.1.1 角色表（roles）

```sql
CREATE TABLE roles (
  id VARCHAR(36) PRIMARY KEY DEFAULT gen_random_uuid(),
  role_name VARCHAR(50) NOT NULL UNIQUE,
  role_code VARCHAR(50) NOT NULL UNIQUE,
  description TEXT,
  is_system BOOLEAN NOT NULL DEFAULT FALSE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL
);

-- 索引
CREATE INDEX idx_roles_role_code ON roles(role_code);
CREATE INDEX idx_roles_is_system ON roles(is_system);
```

**初始数据：**
```sql
INSERT INTO roles (role_name, role_code, description, is_system) VALUES
('超级管理员', 'ADMIN', '拥有所有权限', TRUE),
('管理员', 'MANAGER', '管理普通用户和配置系统', TRUE),
('售后人员', 'AFTER_SALES', '处理售后任务', TRUE),
('群助理', 'ASSISTANT', '群组日常管理', TRUE),
('运营人员', 'OPERATOR', '视频号运营', TRUE),
('只读用户', 'VIEWER', '只能查看数据', TRUE);
```

#### 6.1.2 权限表（permissions）

```sql
CREATE TABLE permissions (
  id VARCHAR(36) PRIMARY KEY DEFAULT gen_random_uuid(),
  permission_name VARCHAR(100) NOT NULL,
  permission_code VARCHAR(100) NOT NULL UNIQUE,
  resource_type VARCHAR(50) NOT NULL,
  resource_id VARCHAR(36),
  action_type VARCHAR(50) NOT NULL,
  description TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL
);

-- 索引
CREATE INDEX idx_permissions_permission_code ON permissions(permission_code);
CREATE INDEX idx_permissions_resource_type ON permissions(resource_type);
CREATE INDEX idx_permissions_action_type ON permissions(action_type);
```

**初始数据：**
```sql
INSERT INTO permissions (permission_name, permission_code, resource_type, action_type, description) VALUES
('查看仪表盘', 'dashboard_view', 'dashboard', 'view', '可以访问仪表盘'),
('查看机器人', 'robot_view', 'robot', 'view', '可以查看机器人列表'),
('配置机器人', 'robot_config', 'robot', 'config', '可以配置机器人'),
('删除机器人', 'robot_delete', 'robot', 'delete', '可以删除机器人'),
('查看会话', 'session_view', 'session', 'view', '可以查看会话列表'),
('导出会话', 'session_export', 'session', 'export', '可以导出会话数据'),
('接管会话', 'session_takeover', 'session', 'takeover', '可以接管会话'),
('查看告警', 'alert_view', 'alert', 'view', '可以查看告警列表'),
('处理告警', 'alert_handle', 'alert', 'handle', '可以处理告警'),
('查看售后任务', 'after_sales_view', 'after_sales', 'view', '可以查看售后任务'),
('处理售后任务', 'after_sales_handle', 'after_sales', 'handle', '可以处理售后任务'),
('查看用户', 'user_view', 'user', 'view', '可以查看用户列表'),
('创建用户', 'user_create', 'user', 'create', '可以创建用户'),
('更新用户', 'user_update', 'user', 'update', '可以更新用户'),
('删除用户', 'user_delete', 'user', 'delete', '可以删除用户'),
('查看角色', 'role_view', 'role', 'view', '可以查看角色列表'),
('创建角色', 'role_create', 'role', 'create', '可以创建角色'),
('更新角色', 'role_update', 'role', 'update', '可以更新角色'),
('删除角色', 'role_delete', 'role', 'delete', '可以删除角色'),
('查看权限', 'permission_view', 'permission', 'view', '可以查看权限列表'),
('配置权限', 'permission_config', 'permission', 'config', '可以配置权限'),
('查看审计日志', 'audit_log_view', 'audit_log', 'view', '可以查看审计日志'),
('查看系统配置', 'config_view', 'config', 'view', '可以查看系统配置'),
('更新系统配置', 'config_update', 'config', 'update', '可以更新系统配置');
```

#### 6.1.3 用户角色关联表（user_roles）

```sql
CREATE TABLE user_roles (
  id VARCHAR(36) PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id VARCHAR(36) NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  role_id VARCHAR(36) NOT NULL REFERENCES roles(id) ON DELETE CASCADE,
  assigned_by VARCHAR(36),
  assigned_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,
  expires_at TIMESTAMP WITH TIME ZONE
);

-- 索引
CREATE INDEX idx_user_roles_user_id ON user_roles(user_id);
CREATE INDEX idx_user_roles_role_id ON user_roles(role_id);
CREATE UNIQUE INDEX idx_user_roles_user_role ON user_roles(user_id, role_id);
```

#### 6.1.4 角色权限关联表（role_permissions）

```sql
CREATE TABLE role_permissions (
  id VARCHAR(36) PRIMARY KEY DEFAULT gen_random_uuid(),
  role_id VARCHAR(36) NOT NULL REFERENCES roles(id) ON DELETE CASCADE,
  permission_id VARCHAR(36) NOT NULL REFERENCES permissions(id) ON DELETE CASCADE,
  assigned_by VARCHAR(36),
  assigned_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL
);

-- 索引
CREATE INDEX idx_role_permissions_role_id ON role_permissions(role_id);
CREATE INDEX idx_role_permissions_permission_id ON role_permissions(permission_id);
CREATE UNIQUE INDEX idx_role_permissions_role_permission ON role_permissions(role_id, permission_id);
```

#### 6.1.5 审计日志表（audit_logs）

```sql
CREATE TABLE audit_logs (
  id VARCHAR(36) PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id VARCHAR(36) REFERENCES users(id) ON DELETE SET NULL,
  user_name VARCHAR(255),
  operation_type VARCHAR(50) NOT NULL,
  resource_type VARCHAR(50) NOT NULL,
  resource_id VARCHAR(36),
  description TEXT,
  ip_address VARCHAR(45),
  user_agent TEXT,
  request_data JSONB DEFAULT '{}',
  response_data JSONB DEFAULT '{}',
  status VARCHAR(20) NOT NULL,
  error_message TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL
);

-- 索引
CREATE INDEX idx_audit_logs_user_id ON audit_logs(user_id);
CREATE INDEX idx_audit_logs_operation_type ON audit_logs(operation_type);
CREATE INDEX idx_audit_logs_resource_type ON audit_logs(resource_type);
CREATE INDEX idx_audit_logs_created_at ON audit_logs(created_at);
```

#### 6.1.6 AI Prompt版本表（ai_prompt_versions）

```sql
CREATE TABLE ai_prompt_versions (
  id VARCHAR(36) PRIMARY KEY DEFAULT gen_random_uuid(),
  prompt_key VARCHAR(100) NOT NULL,
  version INTEGER NOT NULL,
  prompt_content TEXT NOT NULL,
  is_active BOOLEAN NOT NULL DEFAULT FALSE,
  created_by VARCHAR(36) REFERENCES users(id) ON DELETE SET NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL
);

-- 索引
CREATE INDEX idx_ai_prompt_versions_prompt_key ON ai_prompt_versions(prompt_key);
CREATE INDEX idx_ai_prompt_versions_is_active ON ai_prompt_versions(is_active);
CREATE UNIQUE INDEX idx_ai_prompt_versions_key_version ON ai_prompt_versions(prompt_key, version);
```

**初始数据：**
```sql
-- AI System Prompt
INSERT INTO ai_prompt_versions (prompt_key, version, prompt_content, is_active) VALUES
('ai_system_prompt', 1, '你是一个智能客服助手，负责企业微信社群的自动回复和协同分析。', TRUE);

-- AI Intent Prompt
INSERT INTO ai_prompt_versions (prompt_key, version, prompt_content, is_active) VALUES
('ai_intent_prompt', 1, '请分析以下消息的意图，返回意图类型：', TRUE);

-- AI Sentiment Prompt
INSERT INTO ai_prompt_versions (prompt_key, version, prompt_content, is_active) VALUES
('ai_sentiment_prompt', 1, '请分析以下消息的情感极性（正面、负面、中性）：', TRUE);

-- AI Reply Prompt
INSERT INTO ai_prompt_versions (prompt_key, version, prompt_content, is_active) VALUES
('ai_reply_prompt', 1, '请根据上下文生成合适的回复：', TRUE);

-- AI Alert Prompt
INSERT INTO ai_prompt_versions (prompt_key, version, prompt_content, is_active) VALUES
('ai_alert_prompt', 1, '请判断是否需要告警：', TRUE);

-- AI Intervention Prompt
INSERT INTO ai_prompt_versions (prompt_key, version, prompt_content, is_active) VALUES
('ai_intervention_prompt', 1, '请判断是否需要人工介入：', TRUE);
```

#### 6.1.7 AI Prompt测试记录表（ai_prompt_tests）

```sql
CREATE TABLE ai_prompt_tests (
  id VARCHAR(36) PRIMARY KEY DEFAULT gen_random_uuid(),
  prompt_key VARCHAR(100) NOT NULL,
  version INTEGER NOT NULL,
  test_message TEXT NOT NULL,
  test_result JSONB NOT NULL,
  test_score DECIMAL(5, 2),
  created_by VARCHAR(36) REFERENCES users(id) ON DELETE SET NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL
);

-- 索引
CREATE INDEX idx_ai_prompt_tests_prompt_key ON ai_prompt_tests(prompt_key);
CREATE INDEX idx_ai_prompt_tests_version ON ai_prompt_tests(version);
CREATE INDEX idx_ai_prompt_tests_created_at ON ai_prompt_tests(created_at);
```

#### 6.1.8 告警升级记录表（alert_escalations）

```sql
CREATE TABLE alert_escalations (
  id VARCHAR(36) PRIMARY KEY DEFAULT gen_random_uuid(),
  alert_id VARCHAR(36) NOT NULL REFERENCES alerts(id) ON DELETE CASCADE,
  from_level VARCHAR(20) NOT NULL,
  to_level VARCHAR(20) NOT NULL,
  escalated_by VARCHAR(36),
  escalated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,
  reason TEXT
);

-- 索引
CREATE INDEX idx_alert_escalations_alert_id ON alert_escalations(alert_id);
CREATE INDEX idx_alert_escalations_escalated_at ON alert_escalations(escalated_at);
```

#### 6.1.9 工作人员活动日志表（staff_activity_logs）

```sql
CREATE TABLE staff_activity_logs (
  id VARCHAR(36) PRIMARY KEY DEFAULT gen_random_uuid(),
  staff_id VARCHAR(36) NOT NULL,
  staff_name VARCHAR(255),
  activity_type VARCHAR(50) NOT NULL,
  activity_data JSONB DEFAULT '{}',
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL
);

-- 索引
CREATE INDEX idx_staff_activity_logs_staff_id ON staff_activity_logs(staff_id);
CREATE INDEX idx_staff_activity_logs_activity_type ON staff_activity_logs(activity_type);
CREATE INDEX idx_staff_activity_logs_created_at ON staff_activity_logs(created_at);
```

#### 6.1.10 用户满意度记录表（user_satisfaction_records）

```sql
CREATE TABLE user_satisfaction_records (
  id VARCHAR(36) PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id VARCHAR(36) NOT NULL,
  user_name VARCHAR(255),
  group_id VARCHAR(36),
  group_name VARCHAR(255),
  sentiment VARCHAR(20) NOT NULL,
  sentiment_intensity VARCHAR(20),
  score INTEGER NOT NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL
);

-- 索引
CREATE INDEX idx_user_satisfaction_records_user_id ON user_satisfaction_records(user_id);
CREATE INDEX idx_user_satisfaction_records_group_id ON user_satisfaction_records(group_id);
CREATE INDEX idx_user_satisfaction_records_created_at ON user_satisfaction_records(created_at);
```

#### 6.1.11 腾讯文档同步日志表（tencent_doc_sync_logs）

```sql
CREATE TABLE tencent_doc_sync_logs (
  id VARCHAR(36) PRIMARY KEY DEFAULT gen_random_uuid(),
  sync_type VARCHAR(50) NOT NULL,
  data_type VARCHAR(50) NOT NULL,
  data_id VARCHAR(36) NOT NULL,
  sync_status VARCHAR(20) NOT NULL,
  sync_data JSONB DEFAULT '{}',
  error_message TEXT,
  synced_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL
);

-- 索引
CREATE INDEX idx_tencent_doc_sync_logs_sync_type ON tencent_doc_sync_logs(sync_type);
CREATE INDEX idx_tencent_doc_sync_logs_data_type ON tencent_doc_sync_logs(data_type);
CREATE INDEX idx_tencent_doc_sync_logs_data_id ON tencent_doc_sync_logs(data_id);
CREATE INDEX idx_tencent_doc_sync_logs_sync_status ON tencent_doc_sync_logs(sync_status);
CREATE INDEX idx_tencent_doc_sync_logs_synced_at ON tencent_doc_sync_logs(synced_at);
```

### 6.2 需要扩展的表

#### 6.2.1 用户表（users）扩展

```sql
-- 新增字段
ALTER TABLE users ADD COLUMN real_name VARCHAR(255);
ALTER TABLE users ADD COLUMN failed_login_count INTEGER DEFAULT 0;
ALTER TABLE users ADD COLUMN locked_until TIMESTAMP WITH TIME ZONE;
ALTER TABLE users ADD COLUMN deleted_at TIMESTAMP WITH TIME ZONE;

-- 索引
CREATE INDEX idx_users_deleted_at ON users(deleted_at);
```

#### 6.2.2 机器人表（robots）扩展

```sql
-- 新增字段
ALTER TABLE robots ADD COLUMN role VARCHAR(50);
ALTER TABLE robots ADD COLUMN work_schedule JSONB DEFAULT '{}';
ALTER TABLE robots ADD COLUMN selection_rules JSONB DEFAULT '{}';

-- 索引
CREATE INDEX idx_robots_role ON robots(role);
```

**更新现有机器人角色：**
```sql
UPDATE robots SET role = 'MONITOR_ROBOT' WHERE robot_id = 'monitor_robot_id';
UPDATE robots SET role = 'NOTIFY_ROBOT' WHERE robot_id = 'notify_robot_id';
UPDATE robots SET role = 'DAY_SHIFT_REPLY_ROBOT' WHERE robot_id = 'day_shift_reply_robot_id';
UPDATE robots SET role = 'NIGHT_SHIFT_REPLY_ROBOT' WHERE robot_id = 'night_shift_reply_robot_id';
```

#### 6.2.3 系统配置表（system_settings）扩展

```sql
-- 告警时间间隔配置
INSERT INTO system_settings (setting_key, setting_value, description) VALUES
('alert_interval_staff_no_reply', '30', '工作人员长时间未回复告警间隔（分钟）'),
('alert_interval_user_uncooperative', '60', '号主不配合售后告警间隔（分钟）'),
('alert_interval_task_unfinished', '1440', '售后任务未完成告警间隔（分钟）'),
('alert_interval_task_no_follow', '3', '售后任务未跟进告警间隔（分钟）');

-- 回复延迟配置
INSERT INTO system_settings (setting_key, setting_value, description) VALUES
('day_shift_start', '9', '白班开始时间（小时）'),
('day_shift_end', '21', '白班结束时间（小时）'),
('day_shift_operation_delay_min', '2', '白班运营消息最小延迟（秒）'),
('day_shift_operation_delay_max', '8', '白班运营消息最大延迟（秒）'),
('night_shift_operation_delay_min', '5', '晚班运营消息最小延迟（秒）'),
('night_shift_operation_delay_max', '30', '晚班运营消息最大延迟（秒）'),
('urgent_message_delay_min', '1', '紧急消息最小延迟（秒）'),
('urgent_message_delay_max', '2', '紧急消息最大延迟（秒）'),
('after_sales_notify_delay_min', '1', '售后任务提醒最小延迟（秒）'),
('after_sales_notify_delay_max', '2', '售后任务提醒最大延迟（秒）'),
('day_shift_complex_delay_min', '5', '白班复杂问题最小延迟（秒）'),
('day_shift_complex_delay_max', '15', '白班复杂问题最大延迟（秒）'),
('night_shift_complex_delay_min', '10', '晚班复杂问题最小延迟（秒）'),
('night_shift_complex_delay_max', '30', '晚班复杂问题最大延迟（秒）');

-- AI Prompt配置（初始值已在ai_prompt_versions表中）

-- 告警等级策略配置
INSERT INTO system_settings (setting_key, setting_value, description) VALUES
('alert_level_P0_threshold', '3', 'P0告警阈值'),
('alert_level_P0_escalation_level', '3', 'P0告警升级级别'),
('alert_level_P0_escalation_interval', '1800', 'P0告警升级间隔（秒）'),
('alert_level_P1_threshold', '5', 'P1告警阈值'),
('alert_level_P1_escalation_level', '2', 'P1告警升级级别'),
('alert_level_P1_escalation_interval', '3600', 'P1告警升级间隔（秒）'),
('alert_level_P2_threshold', '10', 'P2告警阈值'),
('alert_level_P2_escalation_level', '1', 'P2告警升级级别'),
('alert_level_P2_escalation_interval', '7200', 'P2告警升级间隔（秒）');

-- 上下文配置
INSERT INTO system_settings (setting_key, setting_value, description) VALUES
('context_window_size', '20', '上下文窗口大小（条消息）'),
('context_retention_days', '30', '上下文保留天数');
```

#### 6.2.4 会话消息表（session_messages）扩展

```sql
-- 新增字段（如果不存在）
-- 检查字段是否存在，不存在则添加
DO $$
BEGIN
  IF NOT EXISTS (
    SELECT 1 FROM information_schema.columns
    WHERE table_name = 'session_messages' AND column_name = 'sentiment'
  ) THEN
    ALTER TABLE session_messages ADD COLUMN sentiment VARCHAR(20);
  END IF;
END $$;

DO $$
BEGIN
  IF NOT EXISTS (
    SELECT 1 FROM information_schema.columns
    WHERE table_name = 'session_messages' AND column_name = 'sentiment_intensity'
  ) THEN
    ALTER TABLE session_messages ADD COLUMN sentiment_intensity VARCHAR(20);
  END IF;
END $$;

-- 索引
CREATE INDEX IF NOT EXISTS idx_session_messages_sentiment ON session_messages(sentiment);
```

### 6.3 数据迁移脚本

```sql
-- 迁移现有用户到默认角色
-- 将第一个用户设为超级管理员
INSERT INTO user_roles (user_id, role_id)
SELECT id, (SELECT id FROM roles WHERE role_code = 'ADMIN')
FROM users
WHERE id = (SELECT id FROM users ORDER BY created_at LIMIT 1);

-- 将其他用户设为只读用户
INSERT INTO user_roles (user_id, role_id)
SELECT id, (SELECT id FROM roles WHERE role_code = 'VIEWER')
FROM users
WHERE id NOT IN (SELECT user_id FROM user_roles);

-- 迁移机器人角色
-- 已在上面UPDATE语句中完成
```

---

**由于文档过长，后续内容将在其他文件中继续...**

**查看其他详细文档：**
- `模块升级详解-后端服务篇.md`
- `模块升级详解-后端API篇.md`
- `模块升级详解-前端页面篇.md`
- `模块升级详解-AI交互机制篇.md`
- `模块升级详解-告警系统篇.md`
- `模块升级详解-协同分析篇.md`
- `模块升级详解-售后任务协同篇.md`
- `测试方案.md`
- `部署方案.md`

---

**文档版本**：v1.0

**最后更新**：2024-01-10

**文档作者**：WorkTool AI 团队
