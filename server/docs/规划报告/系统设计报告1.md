# WorkTool AI 中枢系统 - 系统设计报告

## 📋 目录

1. [项目概述](#1-项目概述)
2. [业务模式](#2-业务模式)
3. [系统架构](#3-系统架构)
4. [功能模块设计](#4-功能模块设计)
5. [数据库设计](#5-数据库设计)
6. [API设计](#6-api设计)
7. [AI交互机制](#7-ai交互机制)
8. [告警流程设计](#8-告警流程设计)
9. [协同分析板块](#9-协同分析板块)
10. [机器人角色体系](#10-机器人角色体系)
11. [售后任务协同](#11-售后任务协同)
12. [腾讯文档对接](#12-腾讯文档对接)
13. [前端页面设计](#13-前端页面设计)
14. [技术栈](#14-技术栈)
15. [部署方案](#15-部署方案)
16. [需要确认的事项](#16-需要确认的事项)

---

## 1. 项目概述

### 1.1 项目背景

WorkTool AI 中枢系统是一个**企业微信社群智能运营平台**，为视频号运营服务商提供无人值守、可监控、可预警、可对接、可审计的完整解决方案。

### 1.2 核心目标

- **自动化运营**：通过AI机器人自动回复社群消息，减少人工干预
- **智能协同**：AI与人工协同工作，提高工作效率
- **实时监控**：实时监控社群消息、工作人员状态、用户满意度
- **智能告警**：及时发现问题并通知相关工作人员
- **数据审计**：记录所有操作日志，便于后续分析

### 1.3 服务对象

- **用户（号主）**：视频号所有者，需要配合运营和售后
- **运营（老板）**：第三方运营团队，负责视频号运营
- **售后人员**：负责售后任务处理（扫码、绑定、认证等）
- **群助理**：负责社群日常管理和状态跟进
- **管理层**：监控系统运行情况和告警信息

---

## 2. 业务模式

### 2.1 核心业务流程

```
前端转化客服 → 搭建视频号 → 分配给运营团队 → 运营（最少7天）→ 售后协同维护 → 满意度管理
```

### 2.2 服务周期

- **最少7天配合度和运营**：不满7天补号
- **拉入社群管理**：统一拉入企业微信社群进行管理、维护、售后、满意度维护

### 2.3 收益模式

- **服务费**：为运营团队提供视频号运营服务
- **补号服务**：不满7天补号服务

---

## 3. 系统架构

### 3.1 系统架构图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              用户层                                         │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │  企业微信群聊 │  │  管理后台    │  │  监控面板    │  │  腾讯文档    │  │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘  │
└─────────┼─────────────────┼─────────────────┼─────────────────┼───────────┘
          │                 │                 │                 │
┌─────────┼─────────────────┼─────────────────┼─────────────────┼───────────┐
│         │  机器人API层     │                 │  腾讯文档API    │           │
│  ┌──────▼───────┐  ┌──────▼───────┐  ┌──────▼───────┐  ┌──────▼───────┐  │
│  │ 监控机器人    │  │ 通知机器人    │  │ 白班回复机器人 │  │ 晚班回复机器人 │  │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘  │
└─────────┼─────────────────┼─────────────────┼─────────────────┼───────────┘
          │                 │                 │                 │
┌─────────┼─────────────────┼─────────────────┼─────────────────┼───────────┐
│         │      系统核心层                                                  │
│  ┌──────▼───────────────────────────────────────────────────────────────┐  │
│  │                    WorkTool AI 中枢系统                               │  │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌────────┐  │  │
│  │  │ 消息接收 │  │ 上下文系统 │  │ AI分析   │  │ 告警系统 │  │ 协同分析 │ │  │
│  │  └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬───┘  │  │
│  │       │            │            │            │            │       │  │
│  │  ┌────▼─────┐  ┌───▼─────┐  ┌───▼─────┐  ┌───▼─────┐  ┌───▼─────┐  │  │
│  │  │ 消息发送 │  │ 会话管理 │  │ 意图识别 │  │ 告警通知 │  │ 人工监测 │  │  │
│  │  └──────────┘  └─────────┘  └─────────┘  └─────────┘  └─────────┘  │  │
│  │                                                                      │  │
│  │  ┌─────────────────────────────────────────────────────────────┐    │  │
│  │  │                平台登录用户管理系统                           │    │  │
│  │  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐   │    │  │
│  │  │  │ 用户登录 │  │ 权限管理 │  │ 角色管理 │  │ 操作审计 │   │    │  │
│  │  │  └──────────┘  └──────────┘  └──────────┘  └──────────┘   │    │  │
│  │  └─────────────────────────────────────────────────────────────┘    │  │
│  └──────────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────┘
          │
┌─────────┼─────────────────────────────────────────────────────────────────┐
│         │      数据存储层                                                  │
│  ┌──────▼───────────────────────────────────────────────────────────────┐  │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌────────┐  │  │
│  │  │ PostgreSQL│  │   Redis   │  │ 对象存储 │  │ 腾讯文档 │  │ 日志系统│  │  │
│  │  └──────────┘  └──────────┘  └──────────┘  └──────────┘  └────────┘  │  │
│  └──────────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.2 系统分层

#### 3.2.1 用户层
- **企业微信群聊**：用户、运营、售后、群助理交互场所
- **管理后台**：管理系统配置、查看数据统计
- **监控面板**：实时监控社群消息、告警、工作人员状态
- **腾讯文档**：售后任务进度表

#### 3.2.2 机器人API层
- **监控机器人**：监控所有消息，上报系统
- **通知机器人**：发送通知、提醒、告警
- **白班回复机器人**：9:00-21:00 社群运营、疑虑解答
- **晚班回复机器人**：21:00-次日9:00 社群运营、疑虑解答

#### 3.2.3 系统核心层
- **消息接收**：接收机器人上报的消息
- **消息发送**：发送指令给机器人
- **上下文系统**：管理用户会话、社群会话、历史消息
- **会话管理**：创建、更新、查询会话
- **AI分析**：意图识别、情感分析、回复建议
- **意图识别**：识别用户意图
- **告警系统**：创建、更新、取消告警
- **告警通知**：发送告警通知
- **协同分析**：人工活跃度监测、用户满意度分析
- **人工监测**：监测工作人员状态和活跃度

#### 3.2.4 数据存储层
- **PostgreSQL**：持久化存储业务数据
- **Redis**：缓存热点数据、会话状态
- **对象存储**：存储图片、视频等媒体文件
- **腾讯文档**：售后任务进度表
- **日志系统**：记录系统运行日志

---

## 4. 功能模块设计

### 4.1 消息处理模块

#### 4.1.1 消息接收流程

```
企业微信群聊 → 机器人上报 → 系统接收 → 消息解析 → 消息保存 → 上下文检索 → AI分析 → 告警判断 → 回复判断 → 消息发送
```

#### 4.1.2 文本消息处理流程

```
1. 机器人检测到新消息
2. 机器人提取消息信息（发送者、消息内容、时间戳、群聊信息）
3. 机器人通过API上报给系统
4. 系统接收消息并保存到数据库
5. 系统识别发送者类型（用户/工作人员/运营）
6. 如果是工作人员，记录工作人员状态
7. 系统检索上下文（历史消息、用户画像、售后任务状态）
8. 系统发送给AI分析
9. AI返回分析结果（意图、情感、是否需要回复、回复建议、是否需要告警）
10. 如果需要告警，触发告警流程
11. 如果需要回复，选择机器人并发送回复
12. 系统保存回复记录
13. 系统更新会话状态
```

#### 4.1.3 图片消息处理流程

```
1. 机器人检测到新图片消息
2. 机器人提取消息信息（发送者、图片链接、时间戳、群聊信息）
3. 机器人通过API上报给系统
4. 系统接收消息并保存到数据库
5. 系统识别发送者类型（用户/工作人员/运营）
6. 如果是工作人员，记录工作人员状态
7. 系统调用图片识别服务识别图片内容
8. 系统检索上下文（历史消息、用户画像、售后任务状态）
9. 系统发送给AI分析（包含图片识别结果）
10. AI返回分析结果（意图、情感、是否需要回复、回复建议、是否需要告警）
11. 如果需要告警，触发告警流程
12. 如果需要回复，选择机器人并发送回复
13. 系统保存回复记录
14. 系统更新会话状态
```

### 4.2 上下文管理模块

#### 4.2.1 会话管理系统

**会话类型：**

1. **用户会话（User Session）**
   - 按用户ID/昵称创建会话
   - 记录用户在所有群聊中的对话历史
   - 用于分析用户的整体满意度、问题解决情况

2. **社群会话（Group Session）**
   - 按群聊群ID/群名创建会话
   - 记录群聊中的所有消息历史
   - 用于分析群聊的整体运营情况、成员活跃度

**会话创建规则：**

1. **用户会话创建：**
   - 当第一次收到某个用户的消息时，自动创建用户会话
   - 会话ID格式：`user_session_{timestamp}_{user_id}`
   - 记录用户信息：昵称、企业名称、加入时间、首次消息时间

2. **社群会话创建：**
   - 当第一次收到某个群聊的消息时，自动创建社群会话
   - 会话ID格式：`group_session_{timestamp}_{group_id}`
   - 记录群聊信息：群名、群成员数、创建时间、首次消息时间

**会话状态：**

| 状态 | 英文 | 触发条件 |
|------|------|----------|
| 活跃 | Active | 最近1小时内有新消息 |
| 空闲 | Idle | 最近1-24小时内有新消息 |
| 沉睡 | Inactive | 最近24小时-7天内有新消息 |
| 归档 | Archived | 超过7天无新消息 |

**会话元数据：**

1. **用户会话元数据：**
   - 用户ID
   - 用户昵称
   - 企业名称
   - 消息总数
   - 最后消息时间
   - 用户满意度评分（0-100）
   - 问题解决率（0-100%）
   - 工作人员分配记录

2. **社群会话元数据：**
   - 群聊ID
   - 群聊名称
   - 群成员数
   - 消息总数
   - 最后消息时间
   - 成员活跃度
   - 售后任务统计
   - 运营记录

#### 4.2.2 上下文检索机制

**上下文检索策略：**

```
┌─────────────────────────────────────────────────────────────────────┐
│  判断会话类型                                                              │
│  ┌─────────────────────────────────────────────────────────────────┐  │
│  │  如果是新会话（消息总数 = 0）                                    │  │
│  │  • 历史消息上下文：[]（空数组）                                   │  │
│  │  • 用户画像：使用默认值（满意度=50，新用户）                      │  │
│  │  • 售后任务状态：null                                             │  │
│  └─────────────────────────────────────────────────────────────────┘  │
│  ┌─────────────────────────────────────────────────────────────────┐  │
│  │  如果是老会话（消息总数 > 0）                                    │  │
│  │  • 历史消息上下文：检索最近N条消息（根据消息类型动态调整）         │  │
│  │  • 用户画像：使用历史数据                                         │  │
│  │  • 售后任务状态：使用当前任务状态                                 │  │
│  └─────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────┘
```

**上下文检索规则：**

1. **用户会话检索：**
   - 按用户ID检索用户会话
   - 获取用户在所有群聊中的消息历史
   - 按时间排序，返回最近N条消息

2. **社群会话检索：**
   - 按群聊ID检索社群会话
   - 获取群聊中的所有消息历史
   - 按时间排序，返回最近N条消息

3. **混合检索（新会话优化）：**
   - 如果用户是新用户（用户会话消息总数 < 5）
   - 检索该用户所在的其他群聊的历史消息（如果有）
   - 作为补充上下文

**上下文数据结构：**

```json
{
  "session_type": "user", // user | group
  "is_new_session": false,
  "session_id": "user_session_1234567890_user_001",
  "history_messages": [
    {
      "message_id": "msg_001",
      "sender_type": "user", // user | staff | operator
      "sender_name": "用户A",
      "sender_enterprise": "企业A",
      "sender_robot_id": null,
      "content": "大家好",
      "message_type": "text", // text | image | video
      "timestamp": "2024-01-01 12:00:00"
    },
    {
      "message_id": "msg_002",
      "sender_type": "staff",
      "sender_name": "运营助理",
      "sender_enterprise": "WorkTool",
      "sender_robot_id": "robot_001",
      "content": "您好，欢迎加入视频号A群",
      "message_type": "text",
      "timestamp": "2024-01-01 12:01:00"
    }
  ],
  "user_profile": {
    "user_id": "user_001",
    "user_name": "用户A",
    "enterprise_name": "企业A",
    "satisfaction_score": 75,
    "problem_resolution_rate": 80,
    "message_count": 5,
    "last_message_time": "2024-01-01 12:05:00",
    "joined_at": "2023-12-01 10:00:00"
  },
  "group_profile": {
    "group_id": "group_001",
    "group_name": "视频号A群",
    "member_count": 150,
    "message_count": 1250,
    "last_message_time": "2024-01-01 12:00:00"
  },
  "staff_status": {
    "staff_id": "staff_001",
    "staff_name": "售后A",
    "status": "online", // online | busy | offline
    "last_active_time": "2024-01-01 11:50:00"
  },
  "task_status": {
    "has_pending_task": true,
    "task_id": "task_12345",
    "task_type": "scan_qrcode",
    "task_status": "waiting_user_response"
  }
}
```

**上下文检索数量动态调整：**

| 消息类型 | 上下文数量 | 理由 |
|---------|-----------|------|
| 售后类（扫码、绑定） | 30条 | 需要追踪任务进度 |
| 疑虑解答类 | 20条 | 中等上下文 |
| 情绪不满类 | 15条 | 避免过多负面情绪 |
| 状态沟通类 | 10条 | 简单对话 |
| 闲聊类 | 10条 | 简单对话 |
| 新会话 | 0条 | 无历史上下文 |

**上下文检索数量动态调整实现：**

```typescript
function getContextCount(messageType: string, totalMessages: number): number {
  // 新会话
  if (totalMessages === 0) {
    return 0;
  }

  // 如果会话消息总数 < 30条，返回全部消息
  if (totalMessages < 30) {
    return totalMessages;
  }

  // 基于消息类型的动态调整
  switch (messageType) {
    case 'after_sales':
      return 30;
    case 'question_answer':
      return 20;
    case 'sentiment_negative':
      return 15;
    case 'status_communication':
    case 'chat':
      return 10;
    default:
      return 20;
  }
}
```

### 4.3 AI分析模块

#### 4.3.1 AI系统选择

**选择方案：统一AI（推荐）**

**理由：**
- 上下文传递更顺畅
- 意图和回复在同一上下文中分析
- 减少接口调用次数
- 成本更低

#### 4.3.2 AI交互流程

```
┌─────────────────────────────────────────────────────────────────────┐
│  系统准备上下文数据                                                      │
│  ├─ 判断会话类型（新会话/老会话）                                       │
│  ├─ 检索历史消息上下文（老会话：最近N条，新会话：空数组）                 │
│  ├─ 检索用户画像（老会话：历史数据，新会话：默认值）                      │
│  ├─ 检索工作人员状态（当前在线工作人员）                                 │
│  ├─ 检索售后任务状态（如果有）                                          │
│  ├─ 检索群聊信息（群名、群成员数）                                      │
│  ├─ 新会话优化：检索用户在其他群聊的历史消息（如果有）                    │
└─────────────────────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────────────┐
│  发送给AI                                                              │
│  POST /api/ai/analyze                                                 │
│  {                                                                     │
│    "current_message": { ... },                                        │
│    "context": { ... }                                                 │
│  }                                                                     │
└─────────────────────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────────────┐
│  AI处理上下文数据                                                       │
│  • 分析会话类型（新会话/老会话）                                        │
│  • 分析对话主题                                                         │
│  • 分析用户意图                                                         │
│  • 分析情感倾向                                                         │
│  • 判断是否需要回复                                                     │
│  • 判断是否需要告警                                                     │
│  • 判断是否需要介入人工                                                  │
│  • 判断AI介入场景                                                       │
│  • 分析工作人员状态                                                     │
│  • 更新用户满意度                                                       │
└─────────────────────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────────────┐
│  AI返回分析结果                                                         │
│  {                                                                     │
│    "intent": "...",                                                   │
│    "confidence": 0.95,                                                │
│    "sentiment": "...",                                                │
│    "need_reply": true/false,                                          │
│    "reply_suggestion": { ... },                                       │
│    "need_alert": true/false,                                          │
│    "alert_level": "...",                                              │
│    "alert_type": "...",                                               │
│    "need_intervention": true/false,                                   │
│    "intervention_reason": "...",                                      │
│    "ai_intervention": true/false,                                     │
│    "ai_intervention_scenario": "...",                                 │
│    "staff_status": { ... },                                           │
│    "user_satisfaction_update": 75                                     │
│  }                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

#### 4.3.3 AI Prompt设计

**统一AI Prompt示例：**

```
你是一个智能客服助手，负责企业微信社群的自动回复和协同分析。

【当前消息】
发送者：用户昵称（企业名称）
消息内容："@售后A 为什么我的视频号发不了作品？"
发送时间：2024-01-01 12:00:00
群聊：视频号A群

【历史上下文（最近20条）】
1. 用户："大家好"
2. 运营助理："您好，欢迎加入视频号A群"
3. 用户："我的视频号发不了作品"
4. 运营助理："@售后A 请协助用户处理"
5. 售后A："@用户 请扫码配合认证"

【用户画像】
用户满意度：50分（中等）
历史记录：首次咨询售后问题
用户类型：新用户

【工作人员状态】
在线工作人员：售后A（空闲）、群助理（忙碌）

【售后任务状态】
当前任务：视频号认证（进行中）

【你的任务】
1. 分析用户意图（选择以下一个）：
   - after_sales_scan_qrcode（售后扫码配合）
   - after_sales_bind_phone（售后绑定手机号）
   - after_sales_realname（售后实名认证）
   - after_sales_selfie（售后自拍申诉）
   - question_answer（疑虑解答）
   - status_communication（状态沟通）
   - chat（闲聊）
   - other（其他）

2. 分析用户情感（选择以下一个）：
   - positive（积极）
   - neutral（中性）
   - negative（消极）

3. 判断是否需要回复（true/false）
   - 如果是工作人员消息，不需要回复
   - 如果是用户消息，根据上下文判断是否需要回复

4. 生成回复建议（如果需要回复）
   - 回复内容
   - 回复类型（group_at_user/私聊/group_no_at）
   - 是否需要@用户

5. 判断是否需要告警（true/false）
   - 如果用户情感消极或连续未解决问题，需要告警

6. 判断是否需要介入人工（true/false）
   - 如果需要人工介入，提供介入原因

7. 判断AI介入场景（如果需要AI介入）
   - staff_busy（人工繁忙）
   - night_shift（夜间人工离线）
   - user_negative（用户情感消极）
   - complex_problem（复杂问题）
   - operator_harsh（运营语气过硬）

8. 分析工作人员状态（发送者是工作人员）
   - 是否是工作人员（true/false）
   - 工作人员姓名
   - 工作人员角色
   - 工作人员活跃度

9. 更新用户满意度（根据对话质量）
   - 满意度评分（0-100）

【返回格式（JSON）】
{
  "intent": "after_sales_scan_qrcode",
  "confidence": 0.95,
  "sentiment": "neutral",
  "need_reply": true,
  "reply_suggestion": {
    "content": "您好，请点击下方链接进行扫码操作：[链接]",
    "reply_type": "group_at_user",
    "at_user": true
  },
  "need_alert": false,
  "alert_level": null,
  "alert_type": null,
  "need_intervention": false,
  "intervention_reason": "",
  "ai_intervention": false,
  "ai_intervention_scenario": "",
  "staff_status": {
    "is_staff": false,
    "staff_name": null,
    "staff_role": null,
    "staff_activity": null
  },
  "user_satisfaction_update": 50
}
```

#### 4.3.4 AI返回数据结构

```json
{
  "intent": "after_sales_scan_qrcode",
  "confidence": 0.95,
  "sentiment": "neutral",
  "need_reply": true,
  "reply_suggestion": {
    "content": "您好，请点击下方链接进行扫码操作：[链接]",
    "reply_type": "group_at_user", // group_at_user | private_chat | group_no_at
    "at_user": true
  },
  "need_alert": false,
  "alert_level": null, // P0 | P1 | P2
  "alert_type": null, // user_complaint | operator_harsh | task_unfinished | staff_no_reply | user_uncooperative
  "need_intervention": false,
  "intervention_reason": "",
  "ai_intervention": false,
  "ai_intervention_scenario": "", // staff_busy | night_shift | user_negative | complex_problem | operator_harsh
  "staff_status": {
    "is_staff": false,
    "staff_name": null,
    "staff_role": null, // after_sales | assistant | operator
    "staff_activity": null
  },
  "user_satisfaction_update": 50
}
```

### 4.4 告警系统模块

#### 4.4.1 告警流程图

```
新消息 → AI分析 → 告警判断 → 触发告警 → 通知处理 → 处理完成 → 取消告警 → 记录留痕
```

#### 4.4.2 告警等级定义

| 告警等级 | 级别 | 触发场景 | 处理方式 |
|---------|------|---------|---------|
| P0 | 紧急 | 用户投诉、运营冲突、系统异常 | 立即通知管理层 + 立即处理 |
| P1 | 高优 | 用户不满、配合度低 | 通知售后 + 2小时内处理 |
| P2 | 普通 | 售后任务未完成、超时未回复 | 告警面板 + 4小时内处理 |

#### 4.4.3 告警触发场景

**1. 用户不满/投诉**
- **触发条件**：AI判断用户情感 = 消极 且 内容包含"投诉""不满意""退款"等关键词
- **告警等级**：P0
- **通知对象**：管理层
- **通知方式**：通知机器人 + 告警面板

**2. 运营语气过硬**
- **触发条件**：AI判断发送者 = 运营 且 情感 = 消极
- **告警等级**：P1
- **通知对象**：管理层
- **通知方式**：通知机器人 + 告警面板

**3. 售后任务未完成**
- **触发条件**：售后任务创建后，超过24小时未完成
- **告警等级**：P2
- **通知对象**：售后人员
- **通知方式**：告警面板

**4. 工作人员长时间未回复**
- **触发条件**：工作人员收到消息后，超过30分钟未回复
- **告警等级**：P2
- **通知对象**：工作人员
- **通知方式**：通知机器人 + 告警面板

**5. 号主不配合售后**
- **触发条件**：售后@用户后，用户未在1小时内响应
- **告警等级**：P2
- **通知对象**：售后人员
- **通知方式**：通知机器人 + 告警面板

#### 4.4.4 告警取消规则

| 取消条件 | 自动取消 | 手动取消 | 留痕 |
|---------|---------|---------|------|
| 问题已解决 | ✅ | ✅ | ✅ |
| 用户满意度恢复（>80%） | ✅ | ✅ | ✅ |
| 人工介入后 | ✅ | ✅ | ✅ |
| 超过24小时无新问题 | ✅ | - | ✅ |

**说明：**
- 告警取消后，告警次数保留，用于告警等级提升策略
- 告警历史记录永久保存，便于后续分析

#### 4.4.5 告警等级提升策略

**1. 同一用户连续告警**
- 同一用户P2告警2次 → 提升到P1
- 同一用户P1告警2次 → 提升到P0

**2. 同一问题多次告警**
- 同一问题P2告警2次 → 提升到P1
- 同一问题P1告警2次 → 提升到P0

**3. 用户满意度低**
- 首次满意度 < 50 → P2告警
- 连续2次满意度 < 50 → P1告警
- 连续3次满意度 < 50 → P0告警

**告警等级提升流程：**

```
┌─────────────────────────────────────────────────────────────────────┐
│  告警等级提升判断                                                      │
│  ┌─────────────────────────────────────────────────────────────────┐  │
│  │  1. 查询该用户的历史告警记录                                       │  │
│  │  2. 统计该用户的P2告警次数                                         │  │
│  │  3. 统计该用户的P1告警次数                                         │  │
│  │  4. 统计该问题的告警次数                                           │  │
│  │  5. 查询用户满意度历史                                             │  │
│  └─────────────────────────────────────────────────────────────────┘  │
│                              │                                        │
│  ┌─────────────────────────────────────────────────────────────────┐  │
│  │  判断是否需要提升告警等级                                           │  │
│  │  ┌───────────────────────────────────────────────────────────┐  │  │
│  │  │  如果满足以下任意条件，提升告警等级：                       │  │  │
│  │  │  • 同一用户P2告警2次 → P1                                 │  │  │
│  │  │  • 同一用户P1告警2次 → P0                                 │  │  │
│  │  │  • 同一问题P2告警2次 → P1                                 │  │  │
│  │  │  • 同一问题P1告警2次 → P0                                 │  │  │
│  │  │  • 连续2次满意度 < 50 → P1                                │  │  │
│  │  │  • 连续3次满意度 < 50 → P0                                │  │  │
│  │  └───────────────────────────────────────────────────────────┘  │  │
│  └─────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────┘
```

### 4.5 协同分析模块

#### 4.5.1 人工活跃度监测

**功能1：统计工作人员发言频率**
- 统计每小时发言次数
- 统计每天发言次数
- 统计每周发言次数
- 分析发言趋势

**功能2：分析工作人员回复速度**
- 统计平均响应时间
- 统计最长响应时间
- 统计最短响应时间
- 分析响应时间趋势

**功能3：监测工作人员回复质量**
- 统计用户满意度反馈
- 统计问题解决率
- 分析回复质量趋势

**功能4：分析工作人员状态转换**
- 监测在线 → 忙碌 → 离线状态转换
- 统计各状态持续时间
- 分析状态转换规律

#### 4.5.2 用户满意度分析

**功能1：实时分析用户消息情感**
- 分析每条消息的情感倾向（积极/中性/消极）
- 统计积极/中性/消极消息比例
- 分析情感趋势

**功能2：统计用户问题解决率**
- 统计已解决问题数量
- 统计进行中问题数量
- 统计未解决问题数量
- 计算问题解决率

**功能3：分析用户投诉和不满意情况**
- 统计用户投诉次数
- 统计用户不满意次数
- 分析投诉和不满意原因

**功能4：动态更新用户满意度评分**
- 根据对话质量更新满意度评分
- 满意度评分范围：0-100
- 分析满意度趋势

#### 4.5.3 AI介入判断

**AI介入场景：**

1. **人工繁忙无法及时回复**
   - 工作人员状态 = 忙碌
   - AI判断需要回复
   - AI介入：生成回复建议

2. **夜间人工离线**
   - 当前时段 = 夜间（21:00-次日9:00）
   - AI判断需要回复
   - AI介入：生成回复建议

3. **用户情感消极**
   - AI判断用户情感 = 消极
   - AI介入：安抚用户

4. **复杂问题需要AI辅助**
   - AI判断问题复杂度高
   - AI介入：生成详细解答

5. **运营语气过硬**
   - AI判断发送者 = 运营 且 情感 = 消极
   - AI介入：安抚用户

#### 4.5.4 售后任务协同

**功能1：创建售后任务记录**
- AI判断用户意图 = 售后任务
- 检查是否已有售后任务记录
- 如果没有，创建新售后任务
- 记录任务状态：等待用户响应

**功能2：更新售后任务状态**
- 用户响应@售后消息
- 更新任务状态：用户已响应
- 更新任务进度
- 分析用户配合度

**功能3：监控售后任务进度**
- 定时检查售后任务进度
- 如果用户响应但售后未跟进（超过3分钟）
- 触发告警：提醒售后跟进
- 通过通知机器人发送提醒

**功能4：分析售后工作效率**
- 统计售后任务完成数量
- 统计售后任务平均处理时间
- 分析售后工作效率趋势

### 4.6 自动调度模块

#### 4.6.1 机器人选择规则

**基本规则：**
- 哪个机器人上报消息，哪个机器人回复（日常社群运营）
- 售后协助和运营老板除外（可以跨机器人回复）

**详细规则：**

```
┌─────────────────────────────────────────────────────────────────────┐
│  判断是否需要回复                                                    │
│  ├─ 是工作人员消息 → 不回复                                         │
│  ├─ 是用户消息且不需要回复 → 不回复                                │
│  └─ 是用户消息且需要回复 → 选择机器人                              │
│      ├─ 判断是否是售后任务 → 是 → 选择售后机器人                    │
│      ├─ 判断是否需要通知 → 是 → 选择通知机器人                      │
│      └─ 判断当前时段 → 选择对应回复机器人（白班/晚班）              │
└─────────────────────────────────────────────────────────────────────┘
```

#### 4.6.2 自动调度逻辑

**1. 回复机器人选择**

| 时段 | 选择机器人 | 职责 |
|------|-----------|------|
| 9:00-21:00 | 白班回复机器人 | 社群运营、疑虑解答、辅助人工 |
| 21:00-次日9:00 | 晚班回复机器人 | 社群运营、疑虑解答、辅助人工 |

**2. 售后机器人选择**

| 时段 | 选择机器人 | 职责 |
|------|-----------|------|
| 9:00-19:00 | 售后（早班） | 售后处理（扫码、绑定、认证等） |
| 14:00-23:00 | 售后（晚班） | 售后处理（扫码、绑定、认证等） |

**3. 通知机器人选择**

- **通知机器人24小时在线**
- 通知对象：售后、管理层
- 通知内容：任务提醒、告警信息

**4. 回复延迟设置**

| 时段 | 延迟策略 | 延迟范围 |
|------|---------|---------|
| 白班（9:00-21:00） | 短延迟 | 3-10秒 |
| 晚班（21:00-次日9:00） | 随机延迟 | 5-30秒 |

**说明：**
- 白班用户活跃度高，回复速度要快
- 晚班用户活跃度低，可以适当延迟，增加人性化
- 随机延迟避免机器人回复过于机械化

### 4.7 通讯执行模块

#### 4.7.1 通讯执行流程

```
AI分析 → 提取回复信息 → 选择机器人 → 发送行动指令 → 机器人接收 → 执行发送 → 返回结果 → 记录结果
```

#### 4.7.2 通讯执行步骤

**1. 提取回复信息**
- 机器人ID
- 回复类型（群聊@用户/私聊/群聊不@）
- 回复内容
- 是否需要@用户
- @用户ID

**2. 选择机器人**
- 根据回复类型选择机器人
- 根据当前时段选择机器人
- 根据机器人状态选择机器人

**3. 发送行动指令**
- 调用机器人API接口
- 发送行动指令和回复内容
- 等待机器人返回结果

**4. 机器人接收并执行**
- 机器人接收行动指令
- 解析行动指令
- 执行发送消息
- 返回执行结果

**5. 返回结果**
- 机器人返回执行结果（成功/失败）
- 机器人返回消息ID
- 系统记录执行结果

#### 4.7.3 通讯执行结果处理

**1. 通讯成功**
- 记录发送成功
- 更新会话状态
- 更新消息记录

**2. 通讯失败**
- 记录发送失败
- 更新会话状态
- 触发告警：通讯失败
- 尝试重试（最多3次）

**3. 1分钟后执行结果反馈**
- 机器人返回执行结果（成功/失败）
- 更新消息记录
- 更新会话状态

### 4.8 图片识别模块

#### 4.8.1 图片识别流程

```
接收图片消息 → 保存图片链接 → 调用图片识别服务 → 返回识别结果 → 发送给AI分析
```

#### 4.8.2 图片识别服务

**1. 文字识别（OCR）**
- 识别图片中的文字内容
- 返回文字内容

**2. 图片分类**
- 识别图片类型（截图、照片、二维码等）
- 返回图片类型

**3. 图片内容分析**
- 分析图片内容（是否有敏感内容、是否有二维码等）
- 返回分析结果

#### 4.8.3 图片识别结果数据结构

```json
{
  "image_url": "https://example.com/image.jpg",
  "ocr_text": "图片中的文字内容",
  "image_type": "screenshot", // screenshot | photo | qrcode | other
  "has_sensitive_content": false,
  "has_qrcode": false,
  "recognition_confidence": 0.95
}
```

---

## 5. 数据库设计

### 5.1 核心业务表

#### 5.1.1 用户会话表（user_sessions）

| 字段名 | 类型 | 说明 | 索引 |
|-------|------|------|------|
| id | BIGINT | 主键 | PRIMARY |
| session_id | VARCHAR(100) | 会话ID（唯一） | UNIQUE |
| user_id | VARCHAR(100) | 用户ID | INDEX |
| user_name | VARCHAR(200) | 用户昵称 | INDEX |
| enterprise_name | VARCHAR(200) | 企业名称 | INDEX |
| satisfaction_score | INT | 用户满意度评分（0-100） | INDEX |
| problem_resolution_rate | DECIMAL(5,2) | 问题解决率（0-100%） | - |
| message_count | INT | 消息总数 | INDEX |
| last_message_time | TIMESTAMP | 最后消息时间 | INDEX |
| status | VARCHAR(20) | 会话状态（active/idle/inactive/archived） | INDEX |
| joined_at | TIMESTAMP | 加入时间 | INDEX |
| created_at | TIMESTAMP | 创建时间 | INDEX |
| updated_at | TIMESTAMP | 更新时间 | INDEX |

#### 5.1.2 社群会话表（group_sessions）

| 字段名 | 类型 | 说明 | 索引 |
|-------|------|------|------|
| id | BIGINT | 主键 | PRIMARY |
| session_id | VARCHAR(100) | 会话ID（唯一） | UNIQUE |
| group_id | VARCHAR(100) | 群聊ID | INDEX |
| group_name | VARCHAR(200) | 群聊名称 | INDEX |
| member_count | INT | 群成员数 | - |
| message_count | INT | 消息总数 | INDEX |
| last_message_time | TIMESTAMP | 最后消息时间 | INDEX |
| status | VARCHAR(20) | 会话状态（active/idle/inactive/archived） | INDEX |
| created_at | TIMESTAMP | 创建时间 | INDEX |
| updated_at | TIMESTAMP | 更新时间 | INDEX |

#### 5.1.3 会话消息表（session_messages）

| 字段名 | 类型 | 说明 | 索引 |
|-------|------|------|------|
| id | BIGINT | 主键 | PRIMARY |
| message_id | VARCHAR(100) | 消息ID（唯一） | UNIQUE |
| session_id | VARCHAR(100) | 会话ID | INDEX |
| group_id | VARCHAR(100) | 群聊ID | INDEX |
| sender_type | VARCHAR(20) | 发送者类型（user/staff/operator） | INDEX |
| sender_id | VARCHAR(100) | 发送者ID | INDEX |
| sender_name | VARCHAR(200) | 发送者昵称 | - |
| sender_enterprise | VARCHAR(200) | 发送者企业名称 | - |
| sender_robot_id | VARCHAR(100) | 发送者机器人ID | - |
| content | TEXT | 消息内容 | - |
| message_type | VARCHAR(20) | 消息类型（text/image/video） | INDEX |
| image_url | VARCHAR(500) | 图片URL（如果是图片消息） | - |
| image_recognition_result | JSONB | 图片识别结果（如果是图片消息） | - |
| timestamp | TIMESTAMP | 消息时间戳 | INDEX |
| is_staff | BOOLEAN | 是否是工作人员消息 | INDEX |
| created_at | TIMESTAMP | 创建时间 | INDEX |

#### 5.1.4 告警表（alerts）

| 字段名 | 类型 | 说明 | 索引 |
|-------|------|------|------|
| id | BIGINT | 主键 | PRIMARY |
| alert_id | VARCHAR(100) | 告警ID（唯一） | UNIQUE |
| alert_level | VARCHAR(10) | 告警等级（P0/P1/P2） | INDEX |
| alert_type | VARCHAR(50) | 告警类型（user_complaint/operator_harsh/task_unfinished/staff_no_reply/user_uncooperative） | INDEX |
| user_id | VARCHAR(100) | 用户ID | INDEX |
| group_id | VARCHAR(100) | 群聊ID | INDEX |
| message_id | VARCHAR(100) | 消息ID | - |
| description | TEXT | 告警描述 | - |
| status | VARCHAR(20) | 告警状态（active/resolved/cancelled） | INDEX |
| notified | BOOLEAN | 是否已通知 | INDEX |
| notified_to | JSONB | 通知对象列表 | - |
| resolved_at | TIMESTAMP | 解决时间 | - |
| cancelled_at | TIMESTAMP | 取消时间 | - |
| created_at | TIMESTAMP | 创建时间 | INDEX |

#### 5.1.5 告警历史表（alert_history）

| 字段名 | 类型 | 说明 | 索引 |
|-------|------|------|------|
| id | BIGINT | 主键 | PRIMARY |
| alert_id | VARCHAR(100) | 告警ID | INDEX |
| user_id | VARCHAR(100) | 用户ID | INDEX |
| alert_level | VARCHAR(10) | 告警等级 | INDEX |
| alert_type | VARCHAR(50) | 告警类型 | INDEX |
| created_at | TIMESTAMP | 创建时间 | INDEX |

**说明：**
- 告警历史表用于统计告警次数，用于告警等级提升策略
- 告警取消后，告警历史记录保留

#### 5.1.6 AI介入记录表（ai_interventions）

| 字段名 | 类型 | 说明 | 索引 |
|-------|------|------|------|
| id | BIGINT | 主键 | PRIMARY |
| intervention_id | VARCHAR(100) | 介入ID（唯一） | UNIQUE |
| message_id | VARCHAR(100) | 消息ID | INDEX |
| user_id | VARCHAR(100) | 用户ID | INDEX |
| group_id | VARCHAR(100) | 群聊ID | INDEX |
| scenario | VARCHAR(50) | 介入场景（staff_busy/night_shift/user_negative/complex_problem/operator_harsh） | INDEX |
| description | TEXT | 介入描述 | - |
| created_at | TIMESTAMP | 创建时间 | INDEX |

#### 5.1.7 工作人员活跃度表（staff_activities）

| 字段名 | 类型 | 说明 | 索引 |
|-------|------|------|------|
| id | BIGINT | 主键 | PRIMARY |
| staff_id | VARCHAR(100) | 工作人员ID | INDEX |
| staff_name | VARCHAR(200) | 工作人员姓名 | - |
| staff_role | VARCHAR(50) | 工作人员角色（after_sales/assistant/operator） | INDEX |
| status | VARCHAR(20) | 状态（online/busy/offline） | INDEX |
| message_count_per_hour | INT | 每小时发言次数 | - |
| message_count_per_day | INT | 每天发言次数 | - |
| message_count_per_week | INT | 每周发言次数 | - |
| average_response_time | INT | 平均响应时间（秒） | - |
| max_response_time | INT | 最长响应时间（秒） | - |
| last_active_time | TIMESTAMP | 最后活跃时间 | INDEX |
| created_at | TIMESTAMP | 创建时间 | INDEX |
| updated_at | TIMESTAMP | 更新时间 | INDEX |

#### 5.1.8 满意度分析表（satisfaction_analysis）

| 字段名 | 类型 | 说明 | 索引 |
|-------|------|------|------|
| id | BIGINT | 主键 | PRIMARY |
| analysis_id | VARCHAR(100) | 分析ID（唯一） | UNIQUE |
| user_id | VARCHAR(100) | 用户ID | INDEX |
| satisfaction_score | INT | 满意度评分（0-100） | INDEX |
| sentiment | VARCHAR(20) | 情感倾向（positive/neutral/negative） | INDEX |
| problem_resolution_count | INT | 已解决问题数量 | - |
| problem_in_progress_count | INT | 进行中问题数量 | - |
| problem_unresolved_count | INT | 未解决问题数量 | - |
| problem_resolution_rate | DECIMAL(5,2) | 问题解决率（0-100%） | - |
    complaint_count | INT | 投诉次数 | - |
| dissatisfaction_count | INT | 不满意次数 | - |
| analysis_date | DATE | 分析日期 | INDEX |
| created_at | TIMESTAMP | 创建时间 | INDEX |

#### 5.1.9 售后任务表（after_sales_tasks）

| 字段名 | 类型 | 说明 | 索引 |
|-------|------|------|------|
| id | BIGINT | 主键 | PRIMARY |
| task_id | VARCHAR(100) | 任务ID（唯一） | UNIQUE |
| user_id | VARCHAR(100) | 用户ID | INDEX |
| group_id | VARCHAR(100) | 群聊ID | INDEX |
| task_type | VARCHAR(50) | 任务类型（scan_qrcode/bind_phone/realname/selfie） | INDEX |
| task_status | VARCHAR(50) | 任务状态（waiting_user_response/user_responded/in_progress/completed/failed） | INDEX |
| task_description | TEXT | 任务描述 | - |
| assigned_staff_id | VARCHAR(100) | 分配的工作人员ID | INDEX |
| assigned_staff_name | VARCHAR(200) | 分配的工作人员姓名 | - |
| created_at | TIMESTAMP | 创建时间 | INDEX |
| updated_at | TIMESTAMP | 更新时间 | INDEX |
| completed_at | TIMESTAMP | 完成时间 | - |

#### 5.1.10 售后任务日志表（after_sales_task_logs）

| 字段名 | 类型 | 说明 | 索引 |
|-------|------|------|------|
| id | BIGINT | 主键 | PRIMARY |
| log_id | VARCHAR(100) | 日志ID（唯一） | UNIQUE |
| task_id | VARCHAR(100) | 任务ID | INDEX |
| action | VARCHAR(50) | 操作类型（created/updated/completed/failed/notified） | INDEX |
| action_description | TEXT | 操作描述 | - |
| action_by | VARCHAR(100) | 操作者（用户/工作人员/系统） | - |
| created_at | TIMESTAMP | 创建时间 | INDEX |

#### 5.1.11 执行跟踪表（execution_tracking）

| 字段名 | 类型 | 说明 | 索引 |
|-------|------|------|------|
| id | BIGINT | 主键 | PRIMARY |
| tracking_id | VARCHAR(100) | 跟踪ID（唯一） | UNIQUE |
| message_id | VARCHAR(100) | 消息ID | INDEX |
| robot_id | VARCHAR(100) | 机器人ID | INDEX |
| robot_name | VARCHAR(200) | 机器人名称 | - |
| action_type | VARCHAR(50) | 动作类型（send_message/send_notification） | INDEX |
| action_code | VARCHAR(100) | 行动指令代码 | - |
| execution_status | VARCHAR(20) | 执行状态（success/failed/pending） | INDEX |
| execution_result | JSONB | 执行结果 | - |
| error_message | TEXT | 错误消息 | - |
| retry_count | INT | 重试次数 | - |
| created_at | TIMESTAMP | 创建时间 | INDEX |
| updated_at | TIMESTAMP | 更新时间 | INDEX |

#### 5.1.12 AI IO日志表（ai_io_logs）

| 字段名 | 类型 | 说明 | 索引 |
|-------|------|------|------|
| id | BIGINT | 主键 | PRIMARY |
| log_id | VARCHAR(100) | 日志ID（唯一） | UNIQUE |
| message_id | VARCHAR(100) | 消息ID | INDEX |
| input_data | JSONB | 输入数据（发送给AI的内容） | - |
| output_data | JSONB | 输出数据（AI返回的内容） | - |
| response_time | INT | 响应时间（毫秒） | - |
| created_at | TIMESTAMP | 创建时间 | INDEX |

#### 5.1.13 会话工作人员状态表（session_staff_status）

| 字段名 | 类型 | 说明 | 索引 |
|-------|------|------|------|
| id | BIGINT | 主键 | PRIMARY |
| status_id | VARCHAR(100) | 状态ID（唯一） | UNIQUE |
| session_id | VARCHAR(100) | 会话ID | INDEX |
| group_id | VARCHAR(100) | 群聊ID | INDEX |
| staff_id | VARCHAR(100) | 工作人员ID | INDEX |
| staff_name | VARCHAR(200) | 工作人员姓名 | - |
| staff_role | VARCHAR(50) | 工作人员角色（after_sales/assistant/operator） | INDEX |
| status | VARCHAR(20) | 状态（online/busy/offline） | INDEX |
| last_active_time | TIMESTAMP | 最后活跃时间 | INDEX |
| created_at | TIMESTAMP | 创建时间 | INDEX |
| updated_at | TIMESTAMP | 更新时间 | INDEX |

---

### 5.2 平台登录用户管理表

#### 5.2.1 用户表（users）

| 字段名 | 类型 | 说明 | 索引 |
|-------|------|------|------|
| id | BIGINT | 主键 | PRIMARY |
| user_id | VARCHAR(100) | 用户ID（唯一） | UNIQUE |
| username | VARCHAR(100) | 用户名（登录账号） | UNIQUE |
| password_hash | VARCHAR(255) | 密码哈希（加密） | - |
| email | VARCHAR(200) | 邮箱 | UNIQUE |
| phone | VARCHAR(20) | 手机号 | UNIQUE |
| real_name | VARCHAR(100) | 真实姓名 | - |
| status | VARCHAR(20) | 状态（active/disabled/locked） | INDEX |
| last_login_time | TIMESTAMP | 最后登录时间 | - |
| last_login_ip | VARCHAR(50) | 最后登录IP | - |
| failed_login_attempts | INT | 失败登录次数 | - |
| locked_until | TIMESTAMP | 锁定到期时间 | - |
| created_at | TIMESTAMP | 创建时间 | INDEX |
| updated_at | TIMESTAMP | 更新时间 | - |
| deleted_at | TIMESTAMP | 删除时间（软删除） | INDEX |

#### 5.2.2 角色表（roles）

| 字段名 | 类型 | 说明 | 索引 |
|-------|------|------|------|
| id | BIGINT | 主键 | PRIMARY |
| role_id | VARCHAR(100) | 角色ID（唯一） | UNIQUE |
| role_name | VARCHAR(100) | 角色名称 | - |
| role_code | VARCHAR(50) | 角色代码 | UNIQUE |
| description | TEXT | 角色描述 | - |
| is_system | BOOLEAN | 是否系统角色（不可删除） | - |
| created_at | TIMESTAMP | 创建时间 | INDEX |
| updated_at | TIMESTAMP | 更新时间 | - |

**预置角色：**

| 角色代码 | 角色名称 | 说明 |
|---------|---------|------|
| ADMIN | 超级管理员 | 拥有所有权限 |
| MANAGER | 管理员 | 拥有管理权限 |
| AFTER_SALES | 售后人员 | 拥有售后相关权限 |
| ASSISTANT | 群助理 | 拥有群助理相关权限 |
| OPERATOR | 运营人员 | 拥有运营相关权限 |
| VIEWER | 只读用户 | 只能查看，不能操作 |

#### 5.2.3 权限表（permissions）

| 字段名 | 类型 | 说明 | 索引 |
|-------|------|------|------|
| id | BIGINT | 主键 | PRIMARY |
| permission_id | VARCHAR(100) | 权限ID（唯一） | UNIQUE |
| permission_name | VARCHAR(100) | 权限名称 | - |
| permission_code | VARCHAR(50) | 权限代码 | UNIQUE |
| resource_type | VARCHAR(50) | 资源类型（page/api/data） | INDEX |
| resource_id | VARCHAR(100) | 资源ID | INDEX |
| action | VARCHAR(50) | 操作类型（create/read/update/delete/export） | - |
| description | TEXT | 权限描述 | - |
| created_at | TIMESTAMP | 创建时间 | INDEX |

**预置权限：**

| 权限代码 | 权限名称 | 资源类型 | 操作类型 |
|---------|---------|---------|---------|
| dashboard_view | 查看监控面板 | page | read |
| session_view | 查看会话管理 | page | read |
| session_export | 导出会话数据 | data | export |
| alert_view | 查看告警管理 | page | read |
| alert_handle | 处理告警 | api | update |
| after_sales_view | 查看售后任务 | page | read |
| after_sales_handle | 处理售后任务 | api | update |
| robot_view | 查看机器人管理 | page | read |
| robot_config | 配置机器人 | api | update |
| user_view | 查看用户管理 | page | read |
| user_create | 创建用户 | api | create |
| user_update | 更新用户 | api | update |
| user_delete | 删除用户 | api | delete |
| role_view | 查看角色管理 | page | read |
| role_create | 创建角色 | api | create |
| role_update | 更新角色 | api | update |
| role_delete | 删除角色 | api | delete |
| config_view | 查看系统配置 | page | read |
| config_update | 更新系统配置 | api | update |

#### 5.2.4 用户角色关联表（user_roles）

| 字段名 | 类型 | 说明 | 索引 |
|-------|------|------|------|
| id | BIGINT | 主键 | PRIMARY |
| user_id | VARCHAR(100) | 用户ID | INDEX |
| role_id | VARCHAR(100) | 角色ID | INDEX |
| assigned_by | VARCHAR(100) | 分配者ID | - |
| assigned_at | TIMESTAMP | 分配时间 | INDEX |
| expires_at | TIMESTAMP | 过期时间（可选） | - |

**说明：**
- 一个用户可以拥有多个角色
- 一个角色可以分配给多个用户（多对多关系）

#### 5.2.5 角色权限关联表（role_permissions）

| 字段名 | 类型 | 说明 | 索引 |
|-------|------|------|------|
| id | BIGINT | 主键 | PRIMARY |
| role_id | VARCHAR(100) | 角色ID | INDEX |
| permission_id | VARCHAR(100) | 权限ID | INDEX |
| assigned_by | VARCHAR(100) | 分配者ID | - |
| assigned_at | TIMESTAMP | 分配时间 | INDEX |

**说明：**
- 一个角色可以拥有多个权限
- 一个权限可以分配给多个角色（多对多关系）

#### 5.2.6 操作审计日志表（audit_logs）

| 字段名 | 类型 | 说明 | 索引 |
|-------|------|------|------|
| id | BIGINT | 主键 | PRIMARY |
| log_id | VARCHAR(100) | 日志ID（唯一） | UNIQUE |
| user_id | VARCHAR(100) | 操作用户ID | INDEX |
| username | VARCHAR(100) | 操作用户名 | - |
| action | VARCHAR(50) | 操作类型（login/logout/create/update/delete） | INDEX |
| resource_type | VARCHAR(50) | 资源类型 | INDEX |
| resource_id | VARCHAR(100) | 资源ID | - |
| description | TEXT | 操作描述 | - |
| ip_address | VARCHAR(50) | IP地址 | INDEX |
| user_agent | VARCHAR(500) | 用户代理 | - |
| request_data | JSONB | 请求数据 | - |
| response_data | JSONB | 响应数据 | - |
| status | VARCHAR(20) | 状态（success/failed） | INDEX |
| error_message | TEXT | 错误消息 | - |
| created_at | TIMESTAMP | 创建时间 | INDEX |

**说明：**
- 记录所有用户操作日志
- 支持操作审计和追溯

---

### 5.3 ER图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              数据库ER图                                     │
└─────────────────────────────────────────────────────────────────────────────┘

平台登录用户管理系统
├── 用户表（users）
│    │
│    ├── 1:N ── 用户角色关联表（user_roles）
│    │            │
│    │            └── N:1 ── 角色表（roles）
│    │                        │
│    │                        └── 1:N ── 角色权限关联表（role_permissions）
│    │                                        │
│    │                                        └── N:1 ── 权限表（permissions）
│    │
│    └── 1:N ── 操作审计日志表（audit_logs）

核心业务系统
├── 用户会话表（user_sessions）
│    │
│    ├── 1:N ── 会话消息表（session_messages）
│    │            │
│    │            ├── N:1 ── 告警表（alerts）
│    │            │            │
│    │            │            └── 1:N ── 告警历史表（alert_history）
│    │            │
│    │            ├── 1:1 ── 执行跟踪表（execution_tracking）
│    │            │
│    │            ├── 1:1 ── AI IO日志表（ai_io_logs）
│    │            │
│    │            └── 1:N ── 售后任务表（after_sales_tasks）
│    │                          │
│    │                          └── 1:N ── 售后任务日志表（after_sales_task_logs）
│    │
│    ├── 1:N ── 满意度分析表（satisfaction_analysis）
│    │
│    └── 1:N ── AI介入记录表（ai_interventions）
│
├── 社群会话表（group_sessions）
│    │
│    ├── 1:N ── 会话消息表（session_messages）
│    │
│    └── 1:N ── 会话工作人员状态表（session_staff_status）
│                  │
│                  └── N:1 ── 工作人员活跃度表（staff_activities）
│
├── 告警表（alerts）
│    │
│    └── 1:N ── 告警历史表（alert_history）
│
└── 售后任务表（after_sales_tasks）
     │
     └── 1:N ── 售后任务日志表（after_sales_task_logs）

```

---

---

## 6. API设计

### 6.1 消息接收API

#### 6.1.1 接收机器人上报的消息

**接口路径：** `POST /api/messages/receive`

**请求参数：**

```json
{
  "message_id": "msg_001",
  "group_id": "group_001",
  "group_name": "视频号A群",
  "sender_type": "user", // user | staff | operator
  "sender_id": "user_001",
  "sender_name": "用户A",
  "sender_enterprise": "企业A",
  "sender_robot_id": null,
  "content": "为什么我的视频号发不了作品？",
  "message_type": "text", // text | image | video
  "image_url": null,
  "timestamp": "2024-01-01 12:00:00"
}
```

**返回参数：**

```json
{
  "code": 200,
  "message": "消息接收成功",
  "data": {
    "message_id": "msg_001",
    "session_id": "user_session_1234567890_user_001",
    "processed": true
  }
}
```

### 6.2 上下文管理API

#### 6.2.1 获取用户会话列表

**接口路径：** `GET /api/sessions/users`

**请求参数：**

| 参数名 | 类型 | 必填 | 说明 |
|-------|------|------|------|
| page | INT | 否 | 页码（默认1） |
| page_size | INT | 否 | 每页数量（默认20） |
| status | STRING | 否 | 会话状态（active/idle/inactive/archived） |
| keyword | STRING | 否 | 关键词（搜索用户昵称或企业名称） |

**返回参数：**

```json
{
  "code": 200,
  "message": "获取成功",
  "data": {
    "total": 100,
    "page": 1,
    "page_size": 20,
    "sessions": [
      {
        "session_id": "user_session_1234567890_user_001",
        "user_id": "user_001",
        "user_name": "用户A",
        "enterprise_name": "企业A",
        "satisfaction_score": 75,
        "problem_resolution_rate": 80,
        "message_count": 5,
        "last_message_time": "2024-01-01 12:05:00",
        "status": "active",
        "joined_at": "2023-12-01 10:00:00"
      }
    ]
  }
}
```

#### 6.2.2 获取社群会话列表

**接口路径：** `GET /api/sessions/groups`

**请求参数：**

| 参数名 | 类型 | 必填 | 说明 |
|-------|------|------|------|
| page | INT | 否 | 页码（默认1） |
| page_size | INT | 否 | 每页数量（默认20） |
| status | STRING | 否 | 会话状态（active/idle/inactive/archived） |
| keyword | STRING | 否 | 关键词（搜索群聊名称） |

**返回参数：**

```json
{
  "code": 200,
  "message": "获取成功",
  "data": {
    "total": 50,
    "page": 1,
    "page_size": 20,
    "sessions": [
      {
        "session_id": "group_session_1234567890_group_001",
        "group_id": "group_001",
        "group_name": "视频号A群",
        "member_count": 150,
        "message_count": 1250,
        "last_message_time": "2024-01-01 12:00:00",
        "status": "active",
        "created_at": "2023-12-01 10:00:00"
      }
    ]
  }
}
```

#### 6.2.3 获取会话详情

**接口路径：** `GET /api/sessions/:session_id`

**返回参数：**

```json
{
  "code": 200,
  "message": "获取成功",
  "data": {
    "session_id": "user_session_1234567890_user_001",
    "session_type": "user", // user | group
    "user_profile": {
      "user_id": "user_001",
      "user_name": "用户A",
      "enterprise_name": "企业A",
      "satisfaction_score": 75,
      "problem_resolution_rate": 80,
      "message_count": 5,
      "last_message_time": "2024-01-01 12:05:00",
      "joined_at": "2023-12-01 10:00:00"
    },
    "group_profile": {
      "group_id": "group_001",
      "group_name": "视频号A群",
      "member_count": 150,
      "message_count": 1250,
      "last_message_time": "2024-01-01 12:00:00"
    },
    "status": "active",
    "created_at": "2023-12-01 10:00:00"
  }
}
```

#### 6.2.4 获取会话消息历史

**接口路径：** `GET /api/sessions/:session_id/messages`

**请求参数：**

| 参数名 | 类型 | 必填 | 说明 |
|-------|------|------|------|
| page | INT | 否 | 页码（默认1） |
| page_size | INT | 否 | 每页数量（默认20） |

**返回参数：**

```json
{
  "code": 200,
  "message": "获取成功",
  "data": {
    "total": 50,
    "page": 1,
    "page_size": 20,
    "messages": [
      {
        "message_id": "msg_001",
        "sender_type": "user",
        "sender_name": "用户A",
        "sender_enterprise": "企业A",
        "content": "为什么我的视频号发不了作品？",
        "message_type": "text",
        "timestamp": "2024-01-01 12:00:00"
      }
    ]
  }
}
```

### 6.3 AI分析API

#### 6.3.1 发送消息给AI分析

**接口路径：** `POST /api/ai/analyze`

**请求参数：**

```json
{
  "current_message": {
    "message_id": "msg_001",
    "sender_type": "user",
    "sender_name": "用户A",
    "sender_enterprise": "企业A",
    "content": "为什么我的视频号发不了作品？",
    "message_type": "text",
    "timestamp": "2024-01-01 12:00:00"
  },
  "context": {
    "session_type": "user",
    "is_new_session": false,
    "session_id": "user_session_1234567890_user_001",
    "history_messages": [ ... ],
    "user_profile": { ... },
    "group_profile": { ... },
    "staff_status": { ... },
    "task_status": { ... }
  }
}
```

**返回参数：**

```json
{
  "code": 200,
  "message": "分析成功",
  "data": {
    "intent": "after_sales_scan_qrcode",
    "confidence": 0.95,
    "sentiment": "neutral",
    "need_reply": true,
    "reply_suggestion": {
      "content": "您好，请点击下方链接进行扫码操作：[链接]",
      "reply_type": "group_at_user",
      "at_user": true
    },
    "need_alert": false,
    "alert_level": null,
    "alert_type": null,
    "need_intervention": false,
    "intervention_reason": "",
    "ai_intervention": false,
    "ai_intervention_scenario": "",
    "staff_status": {
      "is_staff": false,
      "staff_name": null,
      "staff_role": null,
      "staff_activity": null
    },
    "user_satisfaction_update": 50
  }
}
```

### 6.4 告警系统API

#### 6.4.1 获取告警列表

**接口路径：** `GET /api/alerts`

**请求参数：**

| 参数名 | 类型 | 必填 | 说明 |
|-------|------|------|------|
| page | INT | 否 | 页码（默认1） |
| page_size | INT | 否 | 每页数量（默认20） |
| alert_level | STRING | 否 | 告警等级（P0/P1/P2） |
| alert_type | STRING | 否 | 告警类型 |
| status | STRING | 否 | 告警状态（active/resolved/cancelled） |

**返回参数：**

```json
{
  "code": 200,
  "message": "获取成功",
  "data": {
    "total": 10,
    "page": 1,
    "page_size": 20,
    "alerts": [
      {
        "alert_id": "alert_001",
        "alert_level": "P0",
        "alert_type": "user_complaint",
        "user_id": "user_001",
        "group_id": "group_001",
        "description": "用户投诉：服务不满意",
        "status": "active",
        "notified": true,
        "created_at": "2024-01-01 12:00:00"
      }
    ]
  }
}
```

#### 6.4.2 取消告警

**接口路径：** `POST /api/alerts/:alert_id/cancel`

**请求参数：**

```json
{
  "cancel_reason": "问题已解决"
}
```

**返回参数：**

```json
{
  "code": 200,
  "message": "取消成功",
  "data": {
    "alert_id": "alert_001",
    "status": "cancelled",
    "cancelled_at": "2024-01-01 12:30:00"
  }
}
```

### 6.5 售后任务API

#### 6.5.1 获取售后任务列表

**接口路径：** `GET /api/after-sales/tasks`

**请求参数：**

| 参数名 | 类型 | 必填 | 说明 |
|-------|------|------|------|
| page | INT | 否 | 页码（默认1） |
| page_size | INT | 否 | 每页数量（默认20） |
| task_status | STRING | 否 | 任务状态 |
| task_type | STRING | 否 | 任务类型 |

**返回参数：**

```json
{
  "code": 200,
  "message": "获取成功",
  "data": {
    "total": 50,
    "page": 1,
    "page_size": 20,
    "tasks": [
      {
        "task_id": "task_12345",
        "user_id": "user_001",
        "group_id": "group_001",
        "task_type": "scan_qrcode",
        "task_status": "waiting_user_response",
        "task_description": "用户需要扫码配合认证",
        "assigned_staff_id": "staff_001",
        "assigned_staff_name": "售后A",
        "created_at": "2024-01-01 10:00:00"
      }
    ]
  }
}
```

#### 6.5.2 创建售后任务

**接口路径：** `POST /api/after-sales/tasks`

**请求参数：**

```json
{
  "user_id": "user_001",
  "group_id": "group_001",
  "task_type": "scan_qrcode",
  "task_description": "用户需要扫码配合认证",
  "assigned_staff_id": "staff_001",
  "assigned_staff_name": "售后A"
}
```

**返回参数：**

```json
{
  "code": 200,
  "message": "创建成功",
  "data": {
    "task_id": "task_12345",
    "task_status": "waiting_user_response",
    "created_at": "2024-01-01 10:00:00"
  }
}
```

#### 6.5.3 更新售后任务状态

**接口路径：** `PUT /api/after-sales/tasks/:task_id/status`

**请求参数：**

```json
{
  "task_status": "user_responded",
  "status_note": "用户已响应，等待售后跟进"
}
```

**返回参数：**

```json
{
  "code": 200,
  "message": "更新成功",
  "data": {
    "task_id": "task_12345",
    "task_status": "user_responded",
    "updated_at": "2024-01-01 10:30:00"
  }
}
```

### 6.6 机器人API

#### 6.6.1 发送消息给机器人

**接口路径：** `POST /api/robots/send`

**请求参数：**

```json
{
  "robot_id": "robot_001",
  "group_id": "group_001",
  "message_type": "group_at_user",
  "content": "您好，请点击下方链接进行扫码操作：[链接]",
  "at_user": true,
  "user_id": "user_001"
}
```

**返回参数：**

```json
{
  "code": 200,
  "message": "发送成功",
  "data": {
    "tracking_id": "tracking_001",
    "message_id": "msg_002",
    "execution_status": "success",
    "created_at": "2024-01-01 12:01:00"
  }
}
```

#### 6.6.2 获取机器人列表

**接口路径：** `GET /api/robots`

**返回参数：**

```json
{
  "code": 200,
  "message": "获取成功",
  "data": {
    "robots": [
      {
        "robot_id": "robot_001",
        "robot_name": "白班回复机器人",
        "robot_type": "reply", // monitor | notify | reply | after_sales
        "status": "online", // online | offline | busy
        "time_slot": "9:00-21:00",
        "created_at": "2023-12-01 10:00:00"
      }
    ]
  }
}
```

### 6.7 用户管理API

#### 6.7.1 用户登录

**接口路径：** `POST /api/auth/login`

**请求参数：**

```json
{
  "username": "admin",
  "password": "123456",
  "captcha": "abc123"
}
```

**返回参数：**

```json
{
  "code": 200,
  "message": "登录成功",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "user": {
      "user_id": "user_001",
      "username": "admin",
      "real_name": "管理员",
      "email": "admin@example.com",
      "phone": "13800138000",
      "roles": ["ADMIN"],
      "permissions": ["dashboard_view", "session_view", "alert_view", "user_view", "role_view", "config_view"]
    },
    "expires_at": "2024-01-02 12:00:00"
  }
}
```

#### 6.7.2 用户登出

**接口路径：** `POST /api/auth/logout`

**请求头：**

```
Authorization: Bearer {token}
```

**返回参数：**

```json
{
  "code": 200,
  "message": "登出成功"
}
```

#### 6.7.3 获取用户列表

**接口路径：** `GET /api/users`

**请求参数：**

| 参数名 | 类型 | 必填 | 说明 |
|-------|------|------|------|
| page | INT | 否 | 页码（默认1） |
| page_size | INT | 否 | 每页数量（默认20） |
| keyword | STRING | 否 | 关键词（搜索用户名、邮箱、手机号） |
| status | STRING | 否 | 状态（active/disabled/locked） |
| role_id | STRING | 否 | 角色ID |

**请求头：**

```
Authorization: Bearer {token}
```

**返回参数：**

```json
{
  "code": 200,
  "message": "获取成功",
  "data": {
    "total": 100,
    "page": 1,
    "page_size": 20,
    "users": [
      {
        "user_id": "user_001",
        "username": "admin",
        "real_name": "管理员",
        "email": "admin@example.com",
        "phone": "13800138000",
        "status": "active",
        "roles": ["ADMIN"],
        "last_login_time": "2024-01-01 12:00:00",
        "created_at": "2023-12-01 10:00:00"
      }
    ]
  }
}
```

#### 6.7.4 创建用户

**接口路径：** `POST /api/users`

**请求参数：**

```json
{
  "username": "zhangsan",
  "password": "123456",
  "email": "zhangsan@example.com",
  "phone": "13800138001",
  "real_name": "张三",
  "role_ids": ["AFTER_SALES", "ASSISTANT"]
}
```

**请求头：**

```
Authorization: Bearer {token}
```

**返回参数：**

```json
{
  "code": 200,
  "message": "创建成功",
  "data": {
    "user_id": "user_002",
    "username": "zhangsan",
    "created_at": "2024-01-01 12:00:00"
  }
}
```

#### 6.7.5 更新用户

**接口路径：** `PUT /api/users/:user_id`

**请求参数：**

```json
{
  "email": "zhangsan_new@example.com",
  "phone": "13800138002",
  "real_name": "张三（更新）",
  "status": "active",
  "role_ids": ["AFTER_SALES"]
}
```

**请求头：**

```
Authorization: Bearer {token}
```

**返回参数：**

```json
{
  "code": 200,
  "message": "更新成功",
  "data": {
    "user_id": "user_002",
    "updated_at": "2024-01-01 13:00:00"
  }
}
```

#### 6.7.6 删除用户

**接口路径：** `DELETE /api/users/:user_id`

**请求头：**

```
Authorization: Bearer {token}
```

**返回参数：**

```json
{
  "code": 200,
  "message": "删除成功",
  "data": {
    "user_id": "user_002",
    "deleted_at": "2024-01-01 14:00:00"
  }
}
```

#### 6.7.7 获取角色列表

**接口路径：** `GET /api/roles`

**请求头：**

```
Authorization: Bearer {token}
```

**返回参数：**

```json
{
  "code": 200,
  "message": "获取成功",
  "data": {
    "roles": [
      {
        "role_id": "ADMIN",
        "role_name": "超级管理员",
        "role_code": "ADMIN",
        "description": "拥有所有权限",
        "is_system": true,
        "created_at": "2023-12-01 10:00:00"
      },
      {
        "role_id": "AFTER_SALES",
        "role_name": "售后人员",
        "role_code": "AFTER_SALES",
        "description": "拥有售后相关权限",
        "is_system": false,
        "created_at": "2023-12-01 10:00:00"
      }
    ]
  }
}
```

#### 6.7.8 创建角色

**接口路径：** `POST /api/roles`

**请求参数：**

```json
{
  "role_name": "测试角色",
  "role_code": "TEST_ROLE",
  "description": "这是一个测试角色",
  "permission_ids": ["dashboard_view", "session_view"]
}
```

**请求头：**

```
Authorization: Bearer {token}
```

**返回参数：**

```json
{
  "code": 200,
  "message": "创建成功",
  "data": {
    "role_id": "role_003",
    "role_name": "测试角色",
    "role_code": "TEST_ROLE",
    "created_at": "2024-01-01 12:00:00"
  }
}
```

#### 6.7.9 获取权限列表

**接口路径：** `GET /api/permissions`

**请求头：**

```
Authorization: Bearer {token}
```

**返回参数：**

```json
{
  "code": 200,
  "message": "获取成功",
  "data": {
    "permissions": [
      {
        "permission_id": "dashboard_view",
        "permission_name": "查看监控面板",
        "permission_code": "dashboard_view",
        "resource_type": "page",
        "resource_id": "dashboard",
        "action": "read",
        "description": "查看监控面板"
      },
      {
        "permission_id": "session_view",
        "permission_name": "查看会话管理",
        "permission_code": "session_view",
        "resource_type": "page",
        "resource_id": "session",
        "action": "read",
        "description": "查看会话管理"
      }
    ]
  }
}
```

#### 6.7.10 获取操作审计日志

**接口路径：** `GET /api/audit-logs`

**请求参数：**

| 参数名 | 类型 | 必填 | 说明 |
|-------|------|------|------|
| page | INT | 否 | 页码（默认1） |
| page_size | INT | 否 | 每页数量（默认20） |
| user_id | STRING | 否 | 用户ID |
| action | STRING | 否 | 操作类型 |
| resource_type | STRING | 否 | 资源类型 |
| start_date | DATE | 否 | 开始日期 |
| end_date | DATE | 否 | 结束日期 |

**请求头：**

```
Authorization: Bearer {token}
```

**返回参数：**

```json
{
  "code": 200,
  "message": "获取成功",
  "data": {
    "total": 1000,
    "page": 1,
    "page_size": 20,
    "logs": [
      {
        "log_id": "log_001",
        "user_id": "user_001",
        "username": "admin",
        "action": "login",
        "resource_type": "auth",
        "resource_id": "login",
        "description": "用户登录",
        "ip_address": "192.168.1.1",
        "status": "success",
        "created_at": "2024-01-01 12:00:00"
      }
    ]
  }
}
```

---

## 7. AI交互机制

### 7.1 AI交互流程

详见【4.3 AI分析模块】

### 7.2 AI Prompt设计

详见【4.3.3 AI Prompt设计】

### 7.3 AI返回数据结构

详见【4.3.4 AI返回数据结构】

---

## 8. 告警流程设计

### 8.1 告警流程图

详见【4.4.1 告警流程图】

### 8.2 告警等级定义

详见【4.4.2 告警等级定义】

### 8.3 告警触发场景

详见【4.4.3 告警触发场景】

### 8.4 告警取消规则

详见【4.4.4 告警取消规则】

### 8.5 告警等级提升策略

详见【4.4.5 告警等级提升策略】

---

## 9. 协同分析板块

### 9.1 人工活跃度监测

详见【4.5.1 人工活跃度监测】

### 9.2 用户满意度分析

详见【4.5.2 用户满意度分析】

### 9.3 AI介入判断

详见【4.5.3 AI介入判断】

### 9.4 售后任务协同

详见【4.5.4 售后任务协同】

---

## 10. 机器人角色体系

### 10.1 角色体系

**机器人角色（4个）：**

| 角色 | 时段 | 职责 |
|------|------|------|
| 监控机器人 | 24小时 | 监控所有消息，上报系统，不回复 |
| 通知机器人 | 24小时 | 发送通知、提醒、告警 |
| 白班回复机器人 | 9:00-21:00 | 社群运营、疑虑解答、辅助人工、群里配合 |
| 晚班回复机器人 | 21:00-次日9:00 | 社群运营、疑虑解答、辅助人工、群里配合 |

**人工角色（5个）：**

| 角色 | 时段 | 职责 |
|------|------|------|
| 售后人工A（早班） | 9:00-19:00 | 售后任务处理（扫码、绑定、认证等） |
| 售后人工B（晚班） | 14:00-23:00 | 售后任务处理（扫码、绑定、认证等） |
| 群助理（早班） | 9:00-19:00 | 前期人工处理，后期机器人 |
| 群助理（晚班） | 14:00-23:00 | 前期人工处理，后期机器人 |
| 用户（号主） | - | 社群成员 |

**第三方角色（1个）：**

| 角色 | 时段 | 职责 |
|------|------|------|
| 运营（老板） | - | 第三方运营团队，财神爷 |

**重要说明：**
1. **没有售后机器人**：目前只有2个售后人工（售后人工A、售后人工B）
2. **售后协同任务**：全程配合售后人工完善分析，系统负责监控、提醒、协同
3. **群里配合**：由2个回复机器人（白班+晚班）配合，辅助人工处理日常运营
4. **售后任务流程**：
   - AI识别售后任务 → 创建售后任务记录 → 分配给售后人工
   - 系统监控售后任务进度 → 提醒售后人工跟进
   - 售后人工处理任务 → 系统记录处理结果
   - 系统同步到腾讯文档

### 10.2 机器人选择规则

详见【4.6.1 机器人选择规则】

### 10.3 自动调度逻辑

详见【4.6.2 自动调度逻辑】

---

## 11. 售后任务协同

### 11.1 售后任务创建流程

详见【4.5.4 售后任务协同 - 功能1】

### 11.2 售后任务更新流程

详见【4.5.4 售后任务协同 - 功能2】

### 11.3 售后任务监控流程

详见【4.5.4 售后任务协同 - 功能3】

### 11.4 售后任务完成流程

详见【4.5.4 售后任务协同 - 功能4】

---

## 12. 腾讯文档对接

### 12.1 对接方案

**方案：通过腾讯文档API实时同步售后处理进度**

### 12.2 对接流程

```
售后任务创建 → 创建数据库记录 → 同步到腾讯文档
售后任务更新 → 更新数据库记录 → 更新腾讯文档
售后任务完成 → 更新数据库记录（状态=已完成） → 更新腾讯文档
```

### 12.3 腾讯文档API调用

#### 12.3.1 创建售后任务记录

**接口路径：** `POST /api/tencent-docs/create`

**请求参数：**

```json
{
  "task_id": "task_12345",
  "user_id": "user_001",
  "user_name": "用户A",
  "group_id": "group_001",
  "group_name": "视频号A群",
  "task_type": "scan_qrcode",
  "task_status": "waiting_user_response",
  "task_description": "用户需要扫码配合认证",
  "assigned_staff_id": "staff_001",
  "assigned_staff_name": "售后A",
  "created_at": "2024-01-01 10:00:00"
}
```

**返回参数：**

```json
{
  "code": 200,
  "message": "同步成功",
  "data": {
    "doc_id": "doc_001",
    "row_id": "row_001"
  }
}
```

#### 12.3.2 更新售后任务记录

**接口路径：** `PUT /api/tencent-docs/update/:task_id`

**请求参数：**

```json
{
  "task_status": "user_responded",
  "status_note": "用户已响应，等待售后跟进",
  "updated_at": "2024-01-01 10:30:00"
}
```

**返回参数：**

```json
{
  "code": 200,
  "message": "更新成功",
  "data": {
    "row_id": "row_001"
  }
}
```

### 12.4 腾讯文档表结构

| 字段名 | 说明 |
|-------|------|
| 任务ID | 任务唯一标识 |
| 用户ID | 用户ID |
| 用户昵称 | 用户昵称 |
| 群聊ID | 群聊ID |
| 群聊名称 | 群聊名称 |
| 任务类型 | 任务类型 |
| 任务状态 | 任务状态 |
| 任务描述 | 任务描述 |
| 分配人员ID | 分配的工作人员ID |
| 分配人员姓名 | 分配的工作人员姓名 |
| 创建时间 | 创建时间 |
| 更新时间 | 更新时间 |
| 完成时间 | 完成时间 |

---

## 13. 前端页面设计

### 13.1 页面结构

```
├── 首页（Dashboard）
│   ├── 统计概览
│   ├── 实时消息流
│   ├── 告警面板
│   ├── 机器人状态
│   └── 工作人员状态
│
├── 会话管理
│   ├── 用户会话列表
│   ├── 社群会话列表
│   └── 会话详情
│
├── 告警管理
│   ├── 告警列表
│   ├── 告警详情
│   └── 告警历史
│
├── 售后任务
│   ├── 售后任务列表
│   ├── 售后任务详情
│   └── 售后任务统计
│
├── 机器人管理
│   ├── 机器人列表
│   ├── 机器人配置
│   └── 机器人状态
│
├── 工作人员管理
│   ├── 工作人员列表
│   ├── 工作人员状态
│   └── 工作人员活跃度
│
├── 数据分析
│   ├── 用户满意度分析
│   ├── 工作人员效率分析
│   ├── 告警统计分析
│   └── 售后任务分析
│
└── 系统设置
    ├── 系统配置
    ├── 告警配置
    ├── AI配置
    └── 机器人配置
```

### 13.2 首页（Dashboard）

**功能模块：**

1. **统计概览**
   - 今日消息总数
   - 今日告警总数
   - 今日售后任务总数
   - 今日用户满意度平均分

2. **实时消息流**
   - 实时显示最新消息
   - 显示发送者、消息内容、时间
   - 支持筛选（用户/工作人员/运营）

3. **告警面板**
   - 显示当前活跃告警
   - 按告警等级排序（P0/P1/P2）
   - 支持取消告警

4. **机器人状态**
   - 显示所有机器人状态
   - 显示机器人在线/离线/忙碌状态

5. **工作人员状态**
   - 显示所有工作人员状态
   - 显示工作人员在线/离线/忙碌状态
   - 显示工作人员最后活跃时间

### 13.3 会话管理

**用户会话列表页：**
- 显示所有用户会话
- 支持搜索、筛选、排序
- 显示用户昵称、企业名称、满意度、消息数、最后消息时间
- 点击查看会话详情

**社群会话列表页：**
- 显示所有社群会话
- 支持搜索、筛选、排序
- 显示群聊名称、群成员数、消息数、最后消息时间
- 点击查看会话详情

**会话详情页：**
- 显示会话信息
- 显示消息历史
- 显示用户画像
- 显示工作人员状态
- 显示售后任务状态

### 13.4 告警管理

**告警列表页：**
- 显示所有告警
- 支持搜索、筛选、排序
- 按告警等级排序（P0/P1/P2）
- 支持取消告警

**告警详情页：**
- 显示告警信息
- 显示告警历史
- 显示相关消息

**告警历史页：**
- 显示告警历史记录
- 按用户、告警等级、告警类型筛选
- 统计告警次数

### 13.5 售后任务

**售后任务列表页：**
- 显示所有售后任务
- 支持搜索、筛选、排序
- 按任务状态、任务类型筛选
- 显示任务信息、分配人员、创建时间

**售后任务详情页：**
- 显示任务信息
- 显示任务日志
- 显示任务进度
- 支持更新任务状态

**售后任务统计页：**
- 显示任务完成数量
- 显示任务平均处理时间
- 显示任务完成率

### 13.6 机器人管理

**机器人列表页：**
- 显示所有机器人
- 显示机器人状态
- 显示机器人类型
- 显示机器人时段

**机器人配置页：**
- 配置机器人参数
- 配置机器人时段
- 配置机器人职责

**机器人状态页：**
- 显示机器人实时状态
- 显示机器人消息发送统计
- 显示机器人响应时间

### 13.7 工作人员管理

**工作人员列表页：**
- 显示所有工作人员
- 显示工作人员状态
- 显示工作人员角色

**工作人员状态页：**
- 显示工作人员实时状态
- 显示工作人员活跃度
- 显示工作人员响应时间

**工作人员活跃度页：**
- 显示工作人员发言统计
- 显示工作人员响应时间统计
- 显示工作人员效率分析

### 13.8 数据分析

**用户满意度分析页：**
- 显示用户满意度趋势
- 显示满意度分布
- 显示满意度排行榜

**工作人员效率分析页：**
- 显示工作人员任务完成数量
- 显示工作人员平均响应时间
- 显示工作人员效率排行榜

**告警统计分析页：**
- 显示告警数量趋势
- 显示告警等级分布
- 显示告警类型分布

**售后任务分析页：**
- 显示售后任务完成率
- 显示售后任务平均处理时间
- 显示售后任务类型分布

### 13.9 系统设置

**系统配置页：**
- 配置系统参数
- 配置告警规则
- 配置AI参数

**告警配置页：**
- 配置告警触发规则
- 配置告警取消规则
- 配置告警等级提升策略

**AI配置页：**
- 配置AI参数
- 配置AI Prompt
- 配置AI上下文

**机器人配置页：**
- 配置机器人参数
- 配置机器人时段
- 配置机器人职责

---

## 14. 技术栈

### 14.1 前端技术栈

| 技术 | 版本 | 说明 |
|------|------|------|
| Next.js | 16.1.1 | React框架 |
| React | 19.2.3 | 前端框架 |
| TypeScript | 5 | 编程语言 |
| shadcn/ui | - | UI组件库 |
| Tailwind CSS | 4 | CSS框架 |

### 14.2 后端技术栈

| 技术 | 版本 | 说明 |
|------|------|------|
| Fastify | 5.7.2 | Web框架 |
| PostgreSQL | - | 关系型数据库 |
| Drizzle ORM | - | ORM框架 |
| Redis | - | 缓存数据库 |
| ioredis | - | Redis客户端 |
| pnpm | 9.0.0 | 包管理器 |

### 14.3 AI技术栈

| 技术 | 说明 |
|------|------|
| 大语言模型（LLM） | 意图识别、情感分析、回复生成 |
| 图片识别服务 | 图片内容识别、OCR识别 |

### 14.4 对接服务

| 服务 | 说明 |
|------|------|
| 企业微信机器人API | 机器人消息接收和发送 |
| 腾讯文档API | 售后任务进度同步 |
| 对象存储（OSS） | 图片、视频等媒体文件存储 |

---

## 15. 部署方案

### 15.1 开发环境

**工作目录：** `/workspace/projects/`

**启动命令：**

```bash
coze dev
```

**服务端口：** 5000

### 15.2 生产环境

**构建命令：**

```bash
coze build
```

**启动命令：**

```bash
coze start
```

**服务端口：** 5000

### 15.3 环境变量

**.env 文件：**

```env
# 数据库配置
DATABASE_URL=postgresql://user:password@localhost:5432/worktool_ai
REDIS_URL=redis://localhost:6379

# 后端配置
BACKEND_URL=http://localhost:5000

# 企业微信机器人配置
ROBOT_API_URL=https://api.weixin.qq.com/robot
ROBOT_API_KEY=your_robot_api_key

# 腾讯文档配置
TENCENT_DOC_API_URL=https://docs.qq.com/api
TENCENT_DOC_API_KEY=your_tencent_doc_api_key

# AI配置
AI_API_URL=https://api.openai.com/v1
AI_API_KEY=your_ai_api_key

# 对象存储配置
OSS_ACCESS_KEY_ID=your_oss_access_key_id
OSS_ACCESS_KEY_SECRET=your_oss_access_key_secret
OSS_BUCKET=your_oss_bucket
OSS_ENDPOINT=your_oss_endpoint
```

### 15.4 部署架构

```
┌─────────────────────────────────────────────────────────────────────┐
│                              用户层                                   │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐              │
│  │  企业微信群聊 │  │  管理后台    │  │  监控面板    │              │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘              │
└─────────┼─────────────────┼─────────────────┼───────────────────────┘
          │                 │                 │
┌─────────┼─────────────────┼─────────────────┼───────────────────────┐
│         │      反向代理层（Nginx）                                   │
│  ┌──────▼───────────────────────────────────────────────────────────┐ │
│  │                    Nginx (端口 80/443)                          │ │
│  └─────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────┘
          │
┌─────────┼───────────────────────────────────────────────────────────┐
│         │      应用层（Next.js + Fastify）                          │
│  ┌──────▼───────────────────────────────────────────────────────────┐ │
│  │                    WorkTool AI 中枢系统（端口 5000）             │ │
│  └─────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────┘
          │
┌─────────┼───────────────────────────────────────────────────────────┐
│         │      数据层                                                 │
│  ┌──────▼───────────────────────────────────────────────────────────┐ │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐                      │ │
│  │  │ PostgreSQL│  │   Redis   │  │ 对象存储 │                      │ │
│  │  └──────────┘  └──────────┘  └──────────┘                      │ │
│  └─────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 16. 需要确认的事项

### 已确认事项（10项）

1. ✅ **告警通知的时间间隔可以自由设置** - 已设计配置化系统，支持动态调整
2. ✅ **告警等级提升策略合理** - 保持当前设计（P2→P1→P0）
3. ✅ **告警取消规则不需要补充** - 保持当前设计
4. ✅ **统一AI的方案可行** - 继续使用统一AI（意图识别+回复）
5. ✅ **AI Prompt需要优化，设置为可调节** - 已设计可配置系统，提供初始版本
6. ✅ **上下文检索数量（10-30条）是合理的** - 保持当前设计
7. ✅ **AI介入场景灵活，能依据实际情况调整** - 已设计可配置系统，支持开关各个场景
8. ✅ **机器人角色体系合理** - 已更新为：4个机器人（监控、通知、白班回复、晚班回复）+ 2个售后人工 + 2个群助理
9. ✅ **群里配合由2个回复机器人配合** - 已明确白班回复机器人和晚班回复机器人负责群里配合
10. ✅ **售后协同任务，全程配合售后完善分析** - 已明确系统负责监控、提醒、协同售后人工

### 待确认事项（6项）

11. ⏳ **机器人选择规则是否合理？**
    - 建议确认机器人选择规则是否符合实际需求
    - 是否需要调整或补充

12. ⏳ **回复延迟设置是否合理？**
    - 白班（9:00-21:00）：3-10秒
    - 晚班（21:00-次日9:00）：5-30秒
    - 建议确认是否需要调整

13. ⏳ **售后任务表与腾讯文档的对接细节是否需要进一步确认？**
    - 建议确认腾讯文档表结构
    - 建议确认同步规则
    - 建议确认同步频率

14. ⏳ **前端页面设计是否符合需求？**
    - 建议确认页面结构是否符合实际需求
    - 是否需要调整或补充

15. ⏳ **数据库表结构是否需要调整？**
    - 已添加平台登录用户管理相关表（users、roles、permissions、user_roles、role_permissions、audit_logs）
    - 建议确认数据库表结构是否符合实际需求
    - 是否需要补充或调整字段

16. ⏳ **部署方案是否需要调整？**
    - 建议确认部署方案是否符合实际需求
    - 是否需要调整或补充
    - 建议确认是否还有其他需要的功能

15. **还有哪些需要完善的地方？**
    - 建议指出还需要完善的地方

---

## 附录

### 附录A：名词解释

| 名词 | 解释 |
|------|------|
| 号主 | 视频号所有者，需要配合运营和售后 |
| 运营 | 第三方运营团队，负责视频号运营 |
| 售后 | 负责售后任务处理（扫码、绑定、认证等）的工作人员 |
| 群助理 | 负责社群日常管理和状态跟进的工作人员 |
| 监控机器人 | 监控所有消息，上报系统，不回复 |
| 通知机器人 | 发送通知、提醒、告警 |
| 白班回复机器人 | 9:00-21:00 社群运营、疑虑解答、辅助人工 |
| 晚班回复机器人 | 21:00-次日9:00 社群运营、疑虑解答、辅助人工 |
| 售后（早班） | 9:00-19:00 售后处理（扫码、绑定、认证等） |
| 售后（晚班） | 14:00-23:00 售后处理（扫码、绑定、认证等） |
| 群助理（早班） | 9:00-19:00 前期人工，后期机器人 |
| 群助理（晚班） | 14:00-23:00 前期人工，后期机器人 |

### 附录B：联系方式

如有任何疑问或建议，请联系项目负责人。

---

**文档版本：** v1.0

**最后更新：** 2024-01-01

**文档作者：** WorkTool AI 团队
