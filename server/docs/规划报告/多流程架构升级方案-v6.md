# å¤šæµç¨‹æ¶æ„å‡çº§æ–¹æ¡ˆ - è¯¦ç»†è®¾è®¡æ–‡æ¡£

## ğŸ“‹ æ–‡æ¡£ä¿¡æ¯

- **ç‰ˆæœ¬**ï¼šv6.0.0
- **æ—¥æœŸ**ï¼š2025-01-10
- **åŸºäº**ï¼šå®Œæ•´åˆ†æç³»ç»Ÿæ¶æ„æ–‡æ¡£
- **ç›®æ ‡**ï¼šå°†å•æµç¨‹æ¶æ„å‡çº§ä¸ºå¤šæµç¨‹æ¶æ„ï¼Œå®ç°æ¨¡å—åŒ–ã€å¯å¤ç”¨ã€æ˜“ç»´æŠ¤çš„æµç¨‹å¼•æ“

---

## ğŸ¯ å‡çº§ç›®æ ‡

### å½“å‰çŠ¶æ€
- âœ… å•æµç¨‹æ¶æ„ï¼ˆ06-complete-flow.jsonï¼‰
- âœ… 27ä¸ªèŠ‚ç‚¹
- âœ… 32æ¡è¾¹
- âœ… åŸºæœ¬åŠŸèƒ½å®Œæ•´

### å‡çº§ç›®æ ‡
- ğŸ¯ å¤šæµç¨‹æ¶æ„ï¼ˆ12ä¸ªæµç¨‹æ–‡ä»¶ï¼‰
- ğŸ¯ ä¸»æµç¨‹ä½œä¸ºè°ƒåº¦å™¨
- ğŸ¯ 11ä¸ªå­æµç¨‹ä¸“æ³¨ä¸šåŠ¡
- ğŸ¯ æ”¯æŒæµç¨‹é—´è°ƒç”¨ï¼ˆflow_callï¼‰
- ğŸ¯ æ”¯æŒå»¶è¿Ÿç­–ç•¥ï¼ˆdelayèŠ‚ç‚¹ï¼‰
- ğŸ¯ å®Œæ•´çš„å±æ€§é…ç½®æ”¯æŒ

---

## ğŸ—ï¸ å¤šæµç¨‹æ¶æ„æ€»è§ˆ

```
ä¸»æµç¨‹ (00-main-flow.json)
  â”œâ”€ æ¶ˆæ¯æ¥æ”¶ä¸ä¼šè¯ç®¡ç†
  â”œâ”€ èº«ä»½è¯†åˆ«
  â”œâ”€ ä¸Šä¸‹æ–‡æ£€ç´¢
  â”œâ”€ æ„å›¾è¯†åˆ«
  â”œâ”€ æµç¨‹è·¯ç”± (flow_call)
  â”‚   â”œâ”€ â†’ æ–‡æœ¬å¤„ç†æµç¨‹ (01-text-processing.json)
  â”‚   â”œâ”€ â†’ å›¾ç‰‡å¤„ç†æµç¨‹ (02-image-processing.json)
  â”‚   â”œâ”€ â†’ è¯­éŸ³å¤„ç†æµç¨‹ (03-voice-processing.json)
  â”‚   â”œâ”€ â†’ å‘Šè­¦å¤„ç†æµç¨‹ (04-alert-handling.json)
  â”‚   â”œâ”€ â†’ å”®åå¤„ç†æµç¨‹ (05-after-sales.json)
  â”‚   â”œâ”€ â†’ äººå·¥è½¬æ¥æµç¨‹ (06-staff-intervention.json)
  â”‚   â”œâ”€ â†’ ååŒåˆ†ææµç¨‹ (07-collaboration-analysis.json)
  â”‚   â”œâ”€ â†’ å‘½ä»¤çŠ¶æ€æµç¨‹ (08-command-status.json)
  â”‚   â”œâ”€ â†’ ç¤¾ç¾¤æ•°æ®åˆ†ææµç¨‹ (09-community-analysis.json)
  â”‚   â”œâ”€ â†’ å”®åæ•°æ®åˆ†ææµç¨‹ (10-after-sales-analysis.json)
  â”‚   â””â”€ â†’ è¿è¥ç»´æŠ¤æµç¨‹ (11-operator-maintenance.json)
  â””â”€ ç»Ÿä¸€ç»“æŸä¸æ—¥å¿—è®°å½•
```

---

## ğŸ“¦ æµç¨‹æ¸…å•

### 1. ä¸»æµç¨‹ (00-main-flow.json)

**æ–‡ä»¶**ï¼š`server/flows/default/00-main-flow.json`
**ID**ï¼š`flow-main-v6`
**ç‰ˆæœ¬**ï¼š`6.0.0`
**ä¼˜å…ˆçº§**ï¼š`100`
**æ˜¯å¦é»˜è®¤**ï¼š`true`

#### èŒè´£
- æ¶ˆæ¯æ¥æ”¶ä¸ä¼šè¯ç®¡ç†
- èº«ä»½è¯†åˆ«ï¼ˆ8ç§è§’è‰²ï¼‰
- ä¸Šä¸‹æ–‡æ£€ç´¢ä¸å¢å¼º
- æ„å›¾è¯†åˆ«ä¸åˆ†ç±»
- æ ¹æ®æ¶ˆæ¯ç±»å‹å’Œæ„å›¾è·¯ç”±åˆ°å­æµç¨‹
- ç»Ÿä¸€ç»“æŸä¸æ—¥å¿—è®°å½•

#### èŠ‚ç‚¹æ¸…å•

| èŠ‚ç‚¹ID | èŠ‚ç‚¹ç±»å‹ | èŠ‚ç‚¹åç§° | è¯´æ˜ |
|--------|---------|---------|------|
| node_start | start | å¼€å§‹ | æµç¨‹å¼€å§‹èŠ‚ç‚¹ |
| node_message_receive | message_receive | æ¶ˆæ¯æ¥æ”¶ | æ¥æ”¶æœºå™¨äººä¸ŠæŠ¥çš„æ¶ˆæ¯ |
| node_identity_check | decision | èº«ä»½è¯†åˆ« | è¯†åˆ«å‘é€è€…èº«ä»½ï¼ˆ8ç§è§’è‰²ï¼‰ |
| node_system_robot | log_save | è®°å½•ç³»ç»Ÿæœºå™¨äºº | è®°å½•ç›‘æ§/é€šçŸ¥/å›å¤æœºå™¨äººï¼ˆä¸å¤„ç†ï¼‰ |
| node_after_sales_robot | flow_call | è½¬å”®åæµç¨‹ | ä¸“ç”¨å”®åæœºå™¨äºº â†’ å”®åæµç¨‹ |
| node_staff_robot | flow_call | è½¬äººå·¥æµç¨‹ | å·¥ä½œäººå‘˜ â†’ äººå·¥ååŒæµç¨‹ |
| node_operator_robot | flow_call | è½¬è¿è¥æµç¨‹ | è¿è¥ï¼ˆè´¢ç¥çˆ·ï¼‰â†’ è¿è¥ç»´æŠ¤æµç¨‹ |
| node_session_create | session_create | ä¼šè¯åˆ›å»º | åˆ›å»ºæˆ–è·å–ä¼šè¯ |
| node_context_enhancer | context_enhancer | ä¸Šä¸‹æ–‡æ£€ç´¢ | æ£€ç´¢ä¸Šä¸‹æ–‡ã€ç”¨æˆ·ç”»åƒã€å·¥ä½œäººå‘˜çŠ¶æ€ |
| node_intent_analyze | unified_analyze | æ„å›¾è¯†åˆ« | ç»Ÿä¸€AIåˆ†æï¼ˆæ„å›¾+æƒ…æ„Ÿï¼‰ |
| node_message_type_check | decision | æ¶ˆæ¯ç±»å‹åˆ¤æ–­ | åˆ¤æ–­æ¶ˆæ¯ç±»å‹ï¼ˆæ–‡æœ¬/å›¾ç‰‡/è¯­éŸ³ï¼‰ |
| node_flow_call_text | flow_call | è°ƒç”¨æ–‡æœ¬å¤„ç† | æ–‡æœ¬æ¶ˆæ¯ â†’ æ–‡æœ¬å¤„ç†æµç¨‹ |
| node_flow_call_image | flow_call | è°ƒç”¨å›¾ç‰‡å¤„ç† | å›¾ç‰‡æ¶ˆæ¯ â†’ å›¾ç‰‡å¤„ç†æµç¨‹ |
| node_flow_call_voice | flow_call | è°ƒç”¨è¯­éŸ³å¤„ç† | è¯­éŸ³æ¶ˆæ¯ â†’ è¯­éŸ³å¤„ç†æµç¨‹ |
| node_intent_route | decision | æ„å›¾è·¯ç”± | æ ¹æ®æ„å›¾è·¯ç”±åˆ°ä¸åŒæµç¨‹ |
| node_flow_call_after_sales | flow_call | è°ƒç”¨å”®åæµç¨‹ | å”®åæ„å›¾ â†’ å”®åæµç¨‹ |
| node_flow_call_alert | flow_call | è°ƒç”¨å‘Šè­¦æµç¨‹ | æŠ•è¯‰/å‘Šè­¦æ„å›¾ â†’ å‘Šè­¦æµç¨‹ |
| node_flow_call_staff | flow_call | è°ƒç”¨äººå·¥æµç¨‹ | éœ€è¦äººå·¥ â†’ äººå·¥è½¬æ¥æµç¨‹ |
| node_flow_call_collaboration | flow_call | è°ƒç”¨ååŒæµç¨‹ | æ—¥å¸¸å’¨è¯¢ â†’ ååŒåˆ†ææµç¨‹ |
| node_log_save | log_save | ç»Ÿä¸€æ—¥å¿— | è®°å½•ç»Ÿä¸€æ—¥å¿— |
| node_end | end | ç»“æŸ | æµç¨‹ç»“æŸèŠ‚ç‚¹ |

#### èŠ‚ç‚¹è¯¦ç»†å±æ€§

**1. node_startï¼ˆå¼€å§‹èŠ‚ç‚¹ï¼‰**
```json
{
  "id": "node_start",
  "type": "start",
  "data": {
    "name": "å¼€å§‹",
    "description": "æµç¨‹å¼€å§‹èŠ‚ç‚¹ï¼Œæ¥æ”¶è§¦å‘äº‹ä»¶"
  }
}
```

**2. node_message_receiveï¼ˆæ¶ˆæ¯æ¥æ”¶èŠ‚ç‚¹ï¼‰**
```json
{
  "id": "node_message_receive",
  "type": "message_receive",
  "data": {
    "name": "æ¶ˆæ¯æ¥æ”¶",
    "description": "æ¥æ”¶æœºå™¨äººä¸ŠæŠ¥çš„æ¶ˆæ¯",
    "config": {
      "saveToDatabase": true,
      "pushToSSE": true,
      "timeout": 3000
    }
  }
}
```

**å±æ€§è¯´æ˜**ï¼š
- `saveToDatabase` (boolean): æ˜¯å¦ä¿å­˜åˆ°æ•°æ®åº“ï¼Œé»˜è®¤true
- `pushToSSE` (boolean): æ˜¯å¦æ¨é€åˆ°SSEï¼Œé»˜è®¤true
- `timeout` (number): è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰ï¼Œé»˜è®¤3000

**3. node_identity_checkï¼ˆèº«ä»½è¯†åˆ«èŠ‚ç‚¹ï¼‰**
```json
{
  "id": "node_identity_check",
  "type": "decision",
  "data": {
    "name": "èº«ä»½è¯†åˆ«",
    "description": "è¯†åˆ«å‘é€è€…èº«ä»½ï¼ˆ8ç§è§’è‰²ï¼‰",
    "config": {
      "expression": "context.senderRole",
      "conditions": [
        {
          "label": "ç³»ç»Ÿç›‘æ§æœºå™¨äºº",
          "expression": "context.senderRole === 'system_monitor'",
          "targetNodeId": "node_system_robot"
        },
        {
          "label": "ç³»ç»Ÿé€šçŸ¥æœºå™¨äºº",
          "expression": "context.senderRole === 'system_notify'",
          "targetNodeId": "node_system_robot"
        },
        {
          "label": "ç³»ç»Ÿå›å¤æœºå™¨äºº",
          "expression": "context.senderRole === 'system_reply'",
          "targetNodeId": "node_system_robot"
        },
        {
          "label": "ä¸“ç”¨å”®åæœºå™¨äºº",
          "expression": "context.senderRole === 'after_sales_robot'",
          "targetNodeId": "node_after_sales_robot"
        },
        {
          "label": "å·¥ä½œäººå‘˜",
          "expression": "context.senderRole === 'staff'",
          "targetNodeId": "node_staff_robot"
        },
        {
          "label": "è¿è¥ï¼ˆè´¢ç¥çˆ·ï¼‰",
          "expression": "context.senderRole === 'operator'",
          "targetNodeId": "node_operator_robot"
        },
        {
          "label": "å·ä¸»ï¼ˆç”¨æˆ·ï¼‰",
          "expression": "context.senderRole === 'user'",
          "targetNodeId": "node_session_create"
        },
        {
          "label": "æœªçŸ¥ç”¨æˆ·",
          "expression": "true",
          "targetNodeId": "node_session_create"
        }
      ]
    }
  }
}
```

**å±æ€§è¯´æ˜**ï¼š
- `expression` (string): åˆ¤æ–­è¡¨è¾¾å¼
- `conditions` (array): æ¡ä»¶æ•°ç»„
  - `label` (string): æ¡ä»¶æ ‡ç­¾
  - `expression` (string): æ¡ä»¶è¡¨è¾¾å¼ï¼ˆæ”¯æŒJavaScriptè¡¨è¾¾å¼ï¼‰
  - `targetNodeId` (string): ç›®æ ‡èŠ‚ç‚¹ID

**4. node_system_robotï¼ˆè®°å½•ç³»ç»Ÿæœºå™¨äººèŠ‚ç‚¹ï¼‰**
```json
{
  "id": "node_system_robot",
  "type": "log_save",
  "data": {
    "name": "è®°å½•ç³»ç»Ÿæœºå™¨äºº",
    "description": "è®°å½•ç³»ç»Ÿæœºå™¨äººæ¶ˆæ¯ï¼Œä¸è¿›è¡Œå¤„ç†",
    "config": {
      "logLevel": "info",
      "message": "ç³»ç»Ÿæœºå™¨äººæ¶ˆæ¯å·²è®°å½•ï¼Œè·³è¿‡å¤„ç†"
    }
  }
}
```

**å±æ€§è¯´æ˜**ï¼š
- `logLevel` (string): æ—¥å¿—çº§åˆ«ï¼ˆdebug/info/warn/errorï¼‰ï¼Œé»˜è®¤info
- `message` (string): æ—¥å¿—æ¶ˆæ¯

**5. node_after_sales_robotï¼ˆè½¬å”®åæµç¨‹èŠ‚ç‚¹ï¼‰**
```json
{
  "id": "node_after_sales_robot",
  "type": "flow_call",
  "data": {
    "name": "è½¬å”®åæµç¨‹",
    "description": "ä¸“ç”¨å”®åæœºå™¨äºº â†’ å”®åæµç¨‹",
    "config": {
      "flowId": "flow-after-sales-v6",
      "version": "1.0.0",
      "timeout": 30000,
      "retryCount": 3,
      "retryInterval": 1000,
      "async": true,
      "params": {
        "messageId": "{{context.messageId}}",
        "groupId": "{{context.groupId}}",
        "senderRole": "{{context.senderRole}}",
        "messageContent": "{{context.messageContent}}"
      },
      "responseMapping": {
        "taskId": "context.taskId",
        "status": "context.afterSalesStatus"
      }
    }
  }
}
```

**å±æ€§è¯´æ˜**ï¼š
- `flowId` (string): å­æµç¨‹IDï¼ˆå¿…å¡«ï¼‰
- `version` (string): å­æµç¨‹ç‰ˆæœ¬ï¼ˆå¯é€‰ï¼Œé»˜è®¤æœ€æ–°ç‰ˆæœ¬ï¼‰
- `timeout` (number): è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰ï¼Œé»˜è®¤30000
- `retryCount` (number): é‡è¯•æ¬¡æ•°ï¼Œé»˜è®¤0
- `retryInterval` (number): é‡è¯•é—´éš”ï¼ˆæ¯«ç§’ï¼‰ï¼Œé»˜è®¤1000
- `async` (boolean): æ˜¯å¦å¼‚æ­¥è°ƒç”¨ï¼Œé»˜è®¤false
- `params` (object): ä¼ é€’ç»™å­æµç¨‹çš„å‚æ•°ï¼ˆæ”¯æŒæ¨¡æ¿è¯­æ³• `{{context.xxx}}`ï¼‰
- `responseMapping` (object): å­æµç¨‹è¿”å›å€¼æ˜ å°„åˆ°ä¸»æµç¨‹context

**6. node_session_createï¼ˆä¼šè¯åˆ›å»ºèŠ‚ç‚¹ï¼‰**
```json
{
  "id": "node_session_create",
  "type": "session_create",
  "data": {
    "name": "ä¼šè¯åˆ›å»º",
    "description": "åˆ›å»ºæˆ–è·å–ä¼šè¯",
    "config": {
      "sessionTimeout": 1800000,
      "maxHistory": 20
    }
  }
}
```

**å±æ€§è¯´æ˜**ï¼š
- `sessionTimeout` (number): ä¼šè¯è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰ï¼Œé»˜è®¤1800000ï¼ˆ30åˆ†é’Ÿï¼‰
- `maxHistory` (number): æœ€å¤§å†å²æ¶ˆæ¯æ•°ï¼Œé»˜è®¤20

**7. node_context_enhancerï¼ˆä¸Šä¸‹æ–‡æ£€ç´¢èŠ‚ç‚¹ï¼‰**
```json
{
  "id": "node_context_enhancer",
  "type": "context_enhancer",
  "data": {
    "name": "ä¸Šä¸‹æ–‡æ£€ç´¢",
    "description": "æ£€ç´¢ä¸Šä¸‹æ–‡ã€ç”¨æˆ·ç”»åƒã€å·¥ä½œäººå‘˜çŠ¶æ€",
    "config": {
      "historyLimit": 20,
      "includeUserProfile": true,
      "includeStaffStatus": true,
      "includeTaskStatus": true,
      "includeGroupInfo": true
    }
  }
}
```

**å±æ€§è¯´æ˜**ï¼š
- `historyLimit` (number): å†å²æ¶ˆæ¯æ•°é‡ï¼Œé»˜è®¤20
- `includeUserProfile` (boolean): æ˜¯å¦åŒ…å«ç”¨æˆ·ç”»åƒï¼Œé»˜è®¤true
- `includeStaffStatus` (boolean): æ˜¯å¦åŒ…å«å·¥ä½œäººå‘˜çŠ¶æ€ï¼Œé»˜è®¤true
- `includeTaskStatus` (boolean): æ˜¯å¦åŒ…å«ä»»åŠ¡çŠ¶æ€ï¼Œé»˜è®¤true
- `includeGroupInfo` (boolean): æ˜¯å¦åŒ…å«ç¾¤ç»„ä¿¡æ¯ï¼Œé»˜è®¤true

**8. node_intent_analyzeï¼ˆæ„å›¾è¯†åˆ«èŠ‚ç‚¹ï¼‰**
```json
{
  "id": "node_intent_analyze",
  "type": "unified_analyze",
  "data": {
    "name": "æ„å›¾è¯†åˆ«",
    "description": "ç»Ÿä¸€AIåˆ†æï¼ˆæ„å›¾+æƒ…æ„Ÿï¼‰",
    "config": {
      "aiModel": "deepseek-chat",
      "temperature": 0.7,
      "maxTokens": 2000,
      "analyzeIntent": true,
      "analyzeEmotion": true,
      "analyzeRisk": true,
      "promptTemplate": "intent_analysis"
    }
  }
}
```

**å±æ€§è¯´æ˜**ï¼š
- `aiModel` (string): AIæ¨¡å‹ï¼Œé»˜è®¤deepseek-chat
- `temperature` (number): æ¸©åº¦å‚æ•°ï¼Œé»˜è®¤0.7
- `maxTokens` (number): æœ€å¤§tokenæ•°ï¼Œé»˜è®¤2000
- `analyzeIntent` (boolean): æ˜¯å¦åˆ†ææ„å›¾ï¼Œé»˜è®¤true
- `analyzeEmotion` (boolean): æ˜¯å¦åˆ†ææƒ…æ„Ÿï¼Œé»˜è®¤true
- `analyzeRisk` (boolean): æ˜¯å¦åˆ†æé£é™©ï¼Œé»˜è®¤true
- `promptTemplate` (string): æç¤ºè¯æ¨¡æ¿ï¼Œé»˜è®¤intent_analysis

**9. node_message_type_checkï¼ˆæ¶ˆæ¯ç±»å‹åˆ¤æ–­èŠ‚ç‚¹ï¼‰**
```json
{
  "id": "node_message_type_check",
  "type": "decision",
  "data": {
    "name": "æ¶ˆæ¯ç±»å‹åˆ¤æ–­",
    "description": "åˆ¤æ–­æ¶ˆæ¯ç±»å‹ï¼ˆæ–‡æœ¬/å›¾ç‰‡/è¯­éŸ³ï¼‰",
    "config": {
      "expression": "context.messageType",
      "conditions": [
        {
          "label": "æ–‡æœ¬æ¶ˆæ¯",
          "expression": "context.messageType === 'text' || context.messageType === undefined",
          "targetNodeId": "node_flow_call_text"
        },
        {
          "label": "å›¾ç‰‡æ¶ˆæ¯",
          "expression": "context.messageType === 'image'",
          "targetNodeId": "node_flow_call_image"
        },
        {
          "label": "è¯­éŸ³æ¶ˆæ¯",
          "expression": "context.messageType === 'voice'",
          "targetNodeId": "node_flow_call_voice"
        }
      ]
    }
  }
}
```

**10-16. node_flow_call_*ï¼ˆæµç¨‹è°ƒç”¨èŠ‚ç‚¹ï¼‰**

æ–‡æœ¬å¤„ç†æµç¨‹è°ƒç”¨ï¼š
```json
{
  "id": "node_flow_call_text",
  "type": "flow_call",
  "data": {
    "name": "è°ƒç”¨æ–‡æœ¬å¤„ç†",
    "description": "æ–‡æœ¬æ¶ˆæ¯ â†’ æ–‡æœ¬å¤„ç†æµç¨‹",
    "config": {
      "flowId": "flow-text-processing-v6",
      "version": "1.0.0",
      "timeout": 60000,
      "retryCount": 2,
      "async": false,
      "params": {
        "messageId": "{{context.messageId}}",
        "messageContent": "{{context.messageContent}}",
        "sessionId": "{{context.sessionId}}",
        "userId": "{{context.userId}}",
        "intent": "{{context.intent}}",
        "emotion": "{{context.emotion}}",
        "riskLevel": "{{context.riskLevel}}"
      },
      "responseMapping": {
        "replyText": "context.replyText",
        "needReply": "context.needReply",
        "processingMode": "context.processingMode"
      }
    }
  }
}
```

å›¾ç‰‡å¤„ç†æµç¨‹è°ƒç”¨ï¼š
```json
{
  "id": "node_flow_call_image",
  "type": "flow_call",
  "data": {
    "name": "è°ƒç”¨å›¾ç‰‡å¤„ç†",
    "description": "å›¾ç‰‡æ¶ˆæ¯ â†’ å›¾ç‰‡å¤„ç†æµç¨‹",
    "config": {
      "flowId": "flow-image-processing-v6",
      "version": "1.0.0",
      "timeout": 60000,
      "retryCount": 2,
      "async": false,
      "params": {
        "messageId": "{{context.messageId}}",
        "imageUrl": "{{context.imageUrl}}",
        "sessionId": "{{context.sessionId}}",
        "userId": "{{context.userId}}",
        "intent": "{{context.intent}}",
        "emotion": "{{context.emotion}}"
      },
      "responseMapping": {
        "replyText": "context.replyText",
        "imageUrl": "context.processedImageUrl",
        "imageCategory": "context.imageCategory"
      }
    }
  }
}
```

è¯­éŸ³å¤„ç†æµç¨‹è°ƒç”¨ï¼š
```json
{
  "id": "node_flow_call_voice",
  "type": "flow_call",
  "data": {
    "name": "è°ƒç”¨è¯­éŸ³å¤„ç†",
    "description": "è¯­éŸ³æ¶ˆæ¯ â†’ è¯­éŸ³å¤„ç†æµç¨‹",
    "config": {
      "flowId": "flow-voice-processing-v6",
      "version": "1.0.0",
      "timeout": 90000,
      "retryCount": 2,
      "async": false,
      "params": {
        "messageId": "{{context.messageId}}",
        "audioUrl": "{{context.audioUrl}}",
        "sessionId": "{{context.sessionId}}",
        "userId": "{{context.userId}}",
        "intent": "{{context.intent}}",
        "emotion": "{{context.emotion}}"
      },
      "responseMapping": {
        "replyText": "context.replyText",
        "audioUrl": "context.generatedAudioUrl",
        "transcribedText": "context.transcribedText"
      }
    }
  }
}
```

**17. node_intent_routeï¼ˆæ„å›¾è·¯ç”±èŠ‚ç‚¹ï¼‰**
```json
{
  "id": "node_intent_route",
  "type": "decision",
  "data": {
    "name": "æ„å›¾è·¯ç”±",
    "description": "æ ¹æ®æ„å›¾è·¯ç”±åˆ°ä¸åŒæµç¨‹",
    "config": {
      "expression": "context.intent",
      "conditions": [
        {
          "label": "å”®åéœ€æ±‚",
          "expression": "context.intent === 'after_sales' || context.intent === 'å”®å'",
          "targetNodeId": "node_flow_call_after_sales"
        },
        {
          "label": "æŠ•è¯‰å‘Šè­¦",
          "expression": "context.intent === 'complaint' || context.intent === 'æŠ•è¯‰' || context.needAlert === true",
          "targetNodeId": "node_flow_call_alert"
        },
        {
          "label": "éœ€è¦äººå·¥",
          "expression": "context.needIntervention === true || context.riskLevel >= 4",
          "targetNodeId": "node_flow_call_staff"
        },
        {
          "label": "æ—¥å¸¸å’¨è¯¢",
          "expression": "context.needReply === true",
          "targetNodeId": "node_flow_call_collaboration"
        },
        {
          "label": "ä»…è®°å½•",
          "expression": "true",
          "targetNodeId": "node_log_save"
        }
      ]
    }
  }
}
```

**18-21. node_flow_call_after_sales/alert/staff/collaboration**

```json
{
  "id": "node_flow_call_after_sales",
  "type": "flow_call",
  "data": {
    "name": "è°ƒç”¨å”®åæµç¨‹",
    "description": "å”®åæ„å›¾ â†’ å”®åæµç¨‹",
    "config": {
      "flowId": "flow-after-sales-v6",
      "version": "1.0.0",
      "timeout": 60000,
      "retryCount": 2,
      "async": false,
      "params": {
        "messageId": "{{context.messageId}}",
        "sessionId": "{{context.sessionId}}",
        "userId": "{{context.userId}}",
        "intent": "{{context.intent}}",
        "emotion": "{{context.emotion}}"
      },
      "responseMapping": {
        "taskId": "context.taskId",
        "status": "context.afterSalesStatus"
      }
    }
  }
}
```

**22. node_log_saveï¼ˆç»Ÿä¸€æ—¥å¿—èŠ‚ç‚¹ï¼‰**
```json
{
  "id": "node_log_save",
  "type": "log_save",
  "data": {
    "name": "ç»Ÿä¸€æ—¥å¿—",
    "description": "è®°å½•ç»Ÿä¸€æ—¥å¿—",
    "config": {
      "logLevel": "info",
      "message": "æµç¨‹æ‰§è¡Œå®Œæˆ"
    }
  }
}
```

**23. node_endï¼ˆç»“æŸèŠ‚ç‚¹ï¼‰**
```json
{
  "id": "node_end",
  "type": "end",
  "data": {
    "name": "ç»“æŸ",
    "description": "æµç¨‹ç»“æŸèŠ‚ç‚¹"
  }
}
```

---

### 2. æ–‡æœ¬å¤„ç†æµç¨‹ (01-text-processing.json)

**æ–‡ä»¶**ï¼š`server/flows/default/01-text-processing.json`
**ID**ï¼š`flow-text-processing-v6`
**ç‰ˆæœ¬**ï¼š`1.0.0`
**ä¼˜å…ˆçº§**ï¼š`90`
**æ˜¯å¦é»˜è®¤**ï¼š`false`

#### èŒè´£
- æ–‡æœ¬æ¶ˆæ¯ç†è§£ä¸å›å¤
- æ”¯æŒå¿«é€Ÿå›å¤å’Œæ·±åº¦åˆ†æä¸¤ç§æ¨¡å¼
- æ ¹æ®å¤æ‚åº¦é€‰æ‹©å¤„ç†è·¯å¾„
- æ”¯æŒå»¶è¿Ÿç­–ç•¥ï¼ˆç™½ç­/æ™šç­/äººå·¥å›å¤ä¸­ï¼‰

#### èŠ‚ç‚¹æ¸…å•

| èŠ‚ç‚¹ID | èŠ‚ç‚¹ç±»å‹ | èŠ‚ç‚¹åç§° | è¯´æ˜ |
|--------|---------|---------|------|
| node_start | start | å¼€å§‹ | æµç¨‹å¼€å§‹èŠ‚ç‚¹ |
| node_text_understand | ai_reply | æ–‡æœ¬ç†è§£ | åŸºäºä¸Šä¸‹æ–‡çš„æ–‡æœ¬ç†è§£ |
| node_complexity_check | decision | å¤æ‚åº¦åˆ¤æ–­ | åˆ¤æ–­æ¶ˆæ¯å¤æ‚åº¦ |
| node_simple_reply | ai_reply | å¿«é€Ÿå›å¤ | ç®€å•æ¶ˆæ¯å¿«é€Ÿå›å¤ |
| node_deep_reply | ai_reply | æ·±åº¦å›å¤ | å¤æ‚æ¶ˆæ¯æ·±åº¦åˆ†æ |
| node_human_check | decision | äººå·¥æ´»è·ƒåº¦æ£€æŸ¥ | æ£€æŸ¥äººå·¥æ˜¯å¦æ­£åœ¨å›å¤ |
| node_wait_human | delay | ç­‰å¾…äººå·¥ | ç­‰å¾…äººå·¥å®Œæˆå›å¤ |
| node_delay_strategy | delay | å»¶è¿Ÿç­–ç•¥ | æ ¹æ®æ—¶æ®µåº”ç”¨å»¶è¿Ÿç­–ç•¥ |
| node_robot_dispatch | robot_dispatch | æœºå™¨äººè°ƒåº¦ | è°ƒåº¦æœºå™¨äºº |
| node_send_command | send_command | å‘é€æŒ‡ä»¤ | å‘é€æŒ‡ä»¤åˆ°æœºå™¨äºº |
| node_flow_call_command | flow_call | è°ƒç”¨å‘½ä»¤çŠ¶æ€ | è°ƒç”¨å‘½ä»¤çŠ¶æ€æµç¨‹ |
| node_end | end | ç»“æŸ | æµç¨‹ç»“æŸèŠ‚ç‚¹ |

#### èŠ‚ç‚¹è¯¦ç»†å±æ€§

**1. node_startï¼ˆå¼€å§‹èŠ‚ç‚¹ï¼‰**
```json
{
  "id": "node_start",
  "type": "start",
  "data": {
    "name": "å¼€å§‹",
    "description": "æ–‡æœ¬å¤„ç†æµç¨‹å¼€å§‹"
  }
}
```

**2. node_text_understandï¼ˆæ–‡æœ¬ç†è§£èŠ‚ç‚¹ï¼‰**
```json
{
  "id": "node_text_understand",
  "type": "ai_reply",
  "data": {
    "name": "æ–‡æœ¬ç†è§£",
    "description": "åŸºäºä¸Šä¸‹æ–‡çš„æ–‡æœ¬ç†è§£",
    "config": {
      "aiModel": "deepseek-chat",
      "temperature": 0.7,
      "maxTokens": 2000,
      "systemPrompt": "ä½ æ˜¯WorkTool AIçš„æ–‡æœ¬ç†è§£åŠ©æ‰‹ï¼Œè´Ÿè´£åˆ†æç”¨æˆ·æ¶ˆæ¯çš„å¤æ‚åº¦å’Œæ„å›¾ã€‚",
      "contextFields": ["messageContent", "history", "userProfile"],
      "outputFields": ["complexity", "needReply", "replySuggestion"]
    }
  }
}
```

**å±æ€§è¯´æ˜**ï¼š
- `aiModel` (string): AIæ¨¡å‹ï¼Œé»˜è®¤deepseek-chat
- `temperature` (number): æ¸©åº¦å‚æ•°ï¼Œé»˜è®¤0.7
- `maxTokens` (number): æœ€å¤§tokenæ•°ï¼Œé»˜è®¤2000
- `systemPrompt` (string): ç³»ç»Ÿæç¤ºè¯
- `contextFields` (array): ä½¿ç”¨çš„ä¸Šä¸‹æ–‡å­—æ®µ
- `outputFields` (array): è¾“å‡ºå­—æ®µ

**3. node_complexity_checkï¼ˆå¤æ‚åº¦åˆ¤æ–­èŠ‚ç‚¹ï¼‰**
```json
{
  "id": "node_complexity_check",
  "type": "decision",
  "data": {
    "name": "å¤æ‚åº¦åˆ¤æ–­",
    "description": "åˆ¤æ–­æ¶ˆæ¯å¤æ‚åº¦",
    "config": {
      "expression": "context.complexity",
      "conditions": [
        {
          "label": "ç®€å•æ¶ˆæ¯",
          "expression": "context.complexity === 'low' || context.complexity === undefined",
          "targetNodeId": "node_simple_reply"
        },
        {
          "label": "å¤æ‚æ¶ˆæ¯",
          "expression": "context.complexity === 'high'",
          "targetNodeId": "node_deep_reply"
        }
      ]
    }
  }
}
```

**4. node_simple_replyï¼ˆå¿«é€Ÿå›å¤èŠ‚ç‚¹ï¼‰**
```json
{
  "id": "node_simple_reply",
  "type": "ai_reply",
  "data": {
    "name": "å¿«é€Ÿå›å¤",
    "description": "ç®€å•æ¶ˆæ¯å¿«é€Ÿå›å¤",
    "config": {
      "aiModel": "deepseek-chat",
      "temperature": 0.5,
      "maxTokens": 500,
      "mode": "simple"
    }
  }
}
```

**5. node_deep_replyï¼ˆæ·±åº¦å›å¤èŠ‚ç‚¹ï¼‰**
```json
{
  "id": "node_deep_reply",
  "type": "ai_reply",
  "data": {
    "name": "æ·±åº¦å›å¤",
    "description": "å¤æ‚æ¶ˆæ¯æ·±åº¦åˆ†æ",
    "config": {
      "aiModel": "deepseek-chat",
      "temperature": 0.8,
      "maxTokens": 2000,
      "mode": "deep",
      "enableCollaboration": true
    }
  }
}
```

**6. node_human_checkï¼ˆäººå·¥æ´»è·ƒåº¦æ£€æŸ¥èŠ‚ç‚¹ï¼‰**
```json
{
  "id": "node_human_check",
  "type": "decision",
  "data": {
    "name": "äººå·¥æ´»è·ƒåº¦æ£€æŸ¥",
    "description": "æ£€æŸ¥äººå·¥æ˜¯å¦æ­£åœ¨å›å¤",
    "config": {
      "expression": "context.staffActive === true",
      "conditions": [
        {
          "label": "äººå·¥æ­£åœ¨å›å¤",
          "expression": "context.staffActive === true",
          "targetNodeId": "node_wait_human"
        },
        {
          "label": "äººå·¥æœªå›å¤",
          "expression": "context.staffActive === false || context.staffActive === undefined",
          "targetNodeId": "node_delay_strategy"
        }
      ]
    }
  }
}
```

**7. node_wait_humanï¼ˆç­‰å¾…äººå·¥èŠ‚ç‚¹ï¼‰**
```json
{
  "id": "node_wait_human",
  "type": "delay",
  "data": {
    "name": "ç­‰å¾…äººå·¥",
    "description": "ç­‰å¾…äººå·¥å®Œæˆå›å¤",
    "config": {
      "delayMode": "fixed",
      "delayTime": 10000,
      "checkCondition": "context.staffActive === true",
      "maxRetries": 3,
      "onTimeout": "continue"
    }
  }
}
```

**å±æ€§è¯´æ˜**ï¼š
- `delayMode` (string): å»¶è¿Ÿæ¨¡å¼ï¼ˆfixed/random/strategyï¼‰ï¼Œé»˜è®¤fixed
- `delayTime` (number): å»¶è¿Ÿæ—¶é—´ï¼ˆæ¯«ç§’ï¼‰ï¼Œä»…fixedæ¨¡å¼
- `minDelay` (number): æœ€å°å»¶è¿Ÿï¼ˆæ¯«ç§’ï¼‰ï¼Œä»…randomæ¨¡å¼
- `maxDelay` (number): æœ€å¤§å»¶è¿Ÿï¼ˆæ¯«ç§’ï¼‰ï¼Œä»…randomæ¨¡å¼
- `strategy` (string): å»¶è¿Ÿç­–ç•¥ï¼ˆday_shift/night_shift/human_active/emergencyï¼‰ï¼Œä»…strategyæ¨¡å¼
- `checkCondition` (string): æ£€æŸ¥æ¡ä»¶è¡¨è¾¾å¼
- `maxRetries` (number): æœ€å¤§é‡è¯•æ¬¡æ•°ï¼Œé»˜è®¤3
- `onTimeout` (string): è¶…æ—¶å¤„ç†ï¼ˆcontinue/abortï¼‰ï¼Œé»˜è®¤continue

**8. node_delay_strategyï¼ˆå»¶è¿Ÿç­–ç•¥èŠ‚ç‚¹ï¼‰**
```json
{
  "id": "node_delay_strategy",
  "type": "delay",
  "data": {
    "name": "å»¶è¿Ÿç­–ç•¥",
    "description": "æ ¹æ®æ—¶æ®µåº”ç”¨å»¶è¿Ÿç­–ç•¥",
    "config": {
      "delayMode": "strategy",
      "strategy": "time_based",
      "strategies": {
        "day_shift": {
          "hours": [9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23],
          "minDelay": 2000,
          "maxDelay": 5000
        },
        "night_shift": {
          "hours": [0, 1, 2, 3, 4, 5, 6, 7, 8],
          "minDelay": 5000,
          "maxDelay": 10000
        },
        "emergency": {
          "condition": "context.emergency === true",
          "minDelay": 0,
          "maxDelay": 2000
        }
      }
    }
  }
}
```

**9. node_robot_dispatchï¼ˆæœºå™¨äººè°ƒåº¦èŠ‚ç‚¹ï¼‰**
```json
{
  "id": "node_robot_dispatch",
  "type": "robot_dispatch",
  "data": {
    "name": "æœºå™¨äººè°ƒåº¦",
    "description": "è°ƒåº¦æœºå™¨äºº",
    "config": {
      "dispatchStrategy": "load_balance",
      "robotTypes": ["day_reply", "night_reply"],
      "maxLoad": 8,
      "retryCount": 3
    }
  }
}
```

**å±æ€§è¯´æ˜**ï¼š
- `dispatchStrategy` (string): è°ƒåº¦ç­–ç•¥ï¼ˆround_robin/load_balance/priorityï¼‰ï¼Œé»˜è®¤round_robin
- `robotTypes` (array): æœºå™¨äººç±»å‹åˆ—è¡¨
- `maxLoad` (number): æœ€å¤§è´Ÿè½½ï¼Œé»˜è®¤8
- `retryCount` (number): é‡è¯•æ¬¡æ•°ï¼Œé»˜è®¤3

**10. node_send_commandï¼ˆå‘é€æŒ‡ä»¤èŠ‚ç‚¹ï¼‰**
```json
{
  "id": "node_send_command",
  "type": "send_command",
  "data": {
    "name": "å‘é€æŒ‡ä»¤",
    "description": "å‘é€æŒ‡ä»¤åˆ°æœºå™¨äºº",
    "config": {
      "commandType": "send_message",
      "targetType": "group",
      "groupId": "{{context.groupId}}",
      "userId": "{{context.userId}}",
      "message": "{{context.replyText}}",
      "atUser": false,
      "timeout": 3000,
      "retryCount": 1
    }
  }
}
```

**11. node_flow_call_commandï¼ˆè°ƒç”¨å‘½ä»¤çŠ¶æ€æµç¨‹èŠ‚ç‚¹ï¼‰**
```json
{
  "id": "node_flow_call_command",
  "type": "flow_call",
  "data": {
    "name": "è°ƒç”¨å‘½ä»¤çŠ¶æ€",
    "description": "è°ƒç”¨å‘½ä»¤çŠ¶æ€æµç¨‹",
    "config": {
      "flowId": "flow-command-status-v6",
      "version": "1.0.0",
      "timeout": 10000,
      "retryCount": 1,
      "async": true,
      "params": {
        "commandId": "{{context.commandId}}",
        "robotId": "{{context.robotId}}",
        "status": "completed"
      },
      "responseMapping": {
        "commandStatus": "context.commandStatus"
      }
    }
  }
}
```

**12. node_endï¼ˆç»“æŸèŠ‚ç‚¹ï¼‰**
```json
{
  "id": "node_end",
  "type": "end",
  "data": {
    "name": "ç»“æŸ",
    "description": "æ–‡æœ¬å¤„ç†æµç¨‹ç»“æŸ"
  }
}
```

---

## ğŸ“ ç»§ç»­è®¾è®¡å…¶ä»–å­æµç¨‹

ç”±äºç¯‡å¹…é™åˆ¶ï¼Œæˆ‘ç»§ç»­è®¾è®¡å…¶ä»–å…³é”®çš„å­æµç¨‹ï¼š

### 3-11. å…¶ä»–å­æµç¨‹æ¦‚è§ˆ

æˆ‘å°†åˆ›å»ºä»¥ä¸‹å­æµç¨‹æ–‡ä»¶ï¼š
- 02-image-processing.jsonï¼ˆå›¾ç‰‡å¤„ç†æµç¨‹ï¼‰
- 03-voice-processing.jsonï¼ˆè¯­éŸ³å¤„ç†æµç¨‹ï¼‰
- 04-alert-handling.jsonï¼ˆå‘Šè­¦å¤„ç†æµç¨‹ï¼‰
- 05-after-sales.jsonï¼ˆå”®åå¤„ç†æµç¨‹ï¼‰
- 06-staff-intervention.jsonï¼ˆäººå·¥è½¬æ¥æµç¨‹ï¼‰
- 07-collaboration-analysis.jsonï¼ˆååŒåˆ†ææµç¨‹ï¼‰
- 08-command-status.jsonï¼ˆå‘½ä»¤çŠ¶æ€æµç¨‹ï¼‰
- 09-community-analysis.jsonï¼ˆç¤¾ç¾¤æ•°æ®åˆ†ææµç¨‹ï¼‰
- 10-after-sales-analysis.jsonï¼ˆå”®åæ•°æ®åˆ†ææµç¨‹ï¼‰
- 11-operator-maintenance.jsonï¼ˆè¿è¥ç»´æŠ¤æµç¨‹ï¼‰

---

## ğŸ”§ å®æ–½æ­¥éª¤

### æ­¥éª¤1ï¼šæ·»åŠ FLOW_CALLå’ŒDELAYèŠ‚ç‚¹ç±»å‹

**ä¿®æ”¹æ–‡ä»¶**ï¼š`server/services/flow-engine.service.js`

```javascript
// åœ¨NodeTypeä¸­æ·»åŠ ï¼š
const NodeType = {
  // ... ç°æœ‰èŠ‚ç‚¹ç±»å‹
  FLOW_CALL: 'flow_call', // æµç¨‹è°ƒç”¨èŠ‚ç‚¹ï¼ˆæ–°å¢ï¼‰
  DELAY: 'delay' // å»¶è¿ŸèŠ‚ç‚¹ï¼ˆæ–°å¢ï¼‰
};
```

### æ­¥éª¤2ï¼šå®ç°FLOW_CALLèŠ‚ç‚¹å¤„ç†å™¨

**ä¿®æ”¹æ–‡ä»¶**ï¼š`server/services/flow-engine.service.js`

```javascript
async handleFlowCallNode(node, context) {
  const { config } = node.data;
  const { flowId, version, timeout, retryCount, retryInterval, async, params, responseMapping } = config;
  
  try {
    // è·å–å­æµç¨‹å®šä¹‰
    const db = await this.getDb();
    let subFlowDef;
    
    if (version) {
      subFlowDef = await db.query.flowDefinitions.findFirst({
        where: eq(flowDefinitions.id, flowId),
        where: eq(flowDefinitions.version, version)
      });
    } else {
      subFlowDef = await db.query.flowDefinitions.findFirst({
        where: eq(flowDefinitions.id, flowId),
        orderBy: desc(flowDefinitions.version)
      });
    }
    
    if (!subFlowDef) {
      throw new Error(`å­æµç¨‹ä¸å­˜åœ¨: ${flowId}${version ? ` (v${version})` : ''}`);
    }
    
    // è§£æå‚æ•°ï¼ˆæ”¯æŒæ¨¡æ¿è¯­æ³•ï¼‰
    const resolvedParams = {};
    Object.keys(params).forEach(key => {
      const value = params[key];
      if (typeof value === 'string' && value.startsWith('{{') && value.endsWith('}}')) {
        const contextKey = value.replace(/{{|}}/g, '').trim();
        resolvedParams[key] = context[contextKey];
      } else {
        resolvedParams[key] = value;
      }
    });
    
    // æ‰§è¡Œå­æµç¨‹
    let result;
    if (async) {
      // å¼‚æ­¥æ‰§è¡Œ
      result = this.executeFlowAsync(subFlowDef, { ...context, ...resolvedParams });
      return { async: true, promise: result };
    } else {
      // åŒæ­¥æ‰§è¡Œ
      result = await this.executeFlow(subFlowDef, { ...context, ...resolvedParams }, timeout);
    }
    
    // æ˜ å°„è¿”å›å€¼åˆ°context
    if (responseMapping) {
      Object.keys(responseMapping).forEach(key => {
        const contextKey = responseMapping[key];
        context[contextKey] = result[key];
      });
    }
    
    return result;
    
  } catch (error) {
    logger.error(`FLOW_CALLèŠ‚ç‚¹æ‰§è¡Œå¤±è´¥: ${error.message}`);
    throw error;
  }
}
```

### æ­¥éª¤3ï¼šå®ç°DELAYèŠ‚ç‚¹å¤„ç†å™¨

**ä¿®æ”¹æ–‡ä»¶**ï¼š`server/services/flow-engine.service.js`

```javascript
async handleDelayNode(node, context) {
  const { config } = node.data;
  const { delayMode, delayTime, minDelay, maxDelay, strategy, strategies, checkCondition, maxRetries, onTimeout } = config;
  
  try {
    let actualDelay = 0;
    
    // è®¡ç®—å»¶è¿Ÿæ—¶é—´
    if (delayMode === 'fixed') {
      actualDelay = delayTime || 0;
    } else if (delayMode === 'random') {
      const min = minDelay || 0;
      const max = maxDelay || 5000;
      actualDelay = Math.floor(Math.random() * (max - min + 1)) + min;
    } else if (delayMode === 'strategy') {
      if (strategy === 'time_based') {
        const hour = new Date().getHours();
        
        // æ£€æŸ¥ç´§æ€¥æ¡ä»¶
        if (strategies.emergency && strategies.emergency.condition) {
          const condition = strategies.emergency.condition;
          if (this.evaluateExpression(condition, context)) {
            actualDelay = Math.floor(Math.random() * (strategies.emergency.maxDelay - strategies.emergency.minDelay + 1)) + strategies.emergency.minDelay;
          }
        }
        
        // ç™½ç­æ—¶æ®µ
        if (strategies.day_shift && strategies.day_shift.hours.includes(hour)) {
          actualDelay = Math.floor(Math.random() * (strategies.day_shift.maxDelay - strategies.day_shift.minDelay + 1)) + strategies.day_shift.minDelay;
        }
        
        // æ™šç­æ—¶æ®µ
        if (strategies.night_shift && strategies.night_shift.hours.includes(hour)) {
          actualDelay = Math.floor(Math.random() * (strategies.night_shift.maxDelay - strategies.night_shift.minDelay + 1)) + strategies.night_shift.minDelay;
        }
      }
    }
    
    // æ£€æŸ¥æ¡ä»¶
    let conditionMet = false;
    if (checkCondition) {
      conditionMet = this.evaluateExpression(checkCondition, context);
    }
    
    // å»¶è¿Ÿæ‰§è¡Œ
    let retries = 0;
    while (retries < (maxRetries || 3)) {
      await new Promise(resolve => setTimeout(resolve, actualDelay));
      
      if (!checkCondition || !this.evaluateExpression(checkCondition, context)) {
        break;
      }
      
      retries++;
    }
    
    // è¶…æ—¶å¤„ç†
    if (retries >= (maxRetries || 3) && onTimeout === 'abort') {
      throw new Error(`DELAYèŠ‚ç‚¹è¶…æ—¶: æ¡ä»¶ ${checkCondition} åœ¨ ${maxRetries} æ¬¡é‡è¯•åä»ç„¶æ»¡è¶³`);
    }
    
    return { delayTime: actualDelay, retries };
    
  } catch (error) {
    logger.error(`DELAYèŠ‚ç‚¹æ‰§è¡Œå¤±è´¥: ${error.message}`);
    throw error;
  }
}
```

### æ­¥éª¤4ï¼šåˆ›å»ºä¸»æµç¨‹æ–‡ä»¶

**åˆ›å»ºæ–‡ä»¶**ï¼š`server/flows/default/00-main-flow.json`

### æ­¥éª¤5ï¼šåˆ›å»ºå­æµç¨‹æ–‡ä»¶

**åˆ›å»ºæ–‡ä»¶**ï¼š
- `server/flows/default/01-text-processing.json`
- `server/flows/default/02-image-processing.json`
- `server/flows/default/03-voice-processing.json`
- `server/flows/default/04-alert-handling.json`
- `server/flows/default/05-after-sales.json`
- `server/flows/default/06-staff-intervention.json`
- `server/flows/default/07-collaboration-analysis.json`
- `server/flows/default/08-command-status.json`
- `server/flows/default/09-community-analysis.json`
- `server/flows/default/10-after-sales-analysis.json`
- `server/flows/default/11-operator-maintenance.json`

### æ­¥éª¤6ï¼šæ³¨å†ŒèŠ‚ç‚¹å¤„ç†å™¨

**ä¿®æ”¹æ–‡ä»¶**ï¼š`server/services/flow-engine.service.js`

```javascript
this.nodeHandlers = {
  // ... ç°æœ‰èŠ‚ç‚¹å¤„ç†å™¨
  [NodeType.FLOW_CALL]: this.handleFlowCallNode.bind(this), // æ–°å¢
  [NodeType.DELAY]: this.handleDelayNode.bind(this) // æ–°å¢
};
```

### æ­¥éª¤7ï¼šå¯¼å…¥æµç¨‹åˆ°æ•°æ®åº“

**æ‰§è¡Œè„šæœ¬**ï¼š`server/scripts/import-multi-flows.js`

---

## ğŸ“Š èŠ‚ç‚¹å±æ€§æ€»è§ˆ

### æ‰€æœ‰èŠ‚ç‚¹ç±»å‹åŠå…¶å±æ€§

| èŠ‚ç‚¹ç±»å‹ | æ ¸å¿ƒå±æ€§ | å¯é€‰å±æ€§ | å±æ€§ä¸¢å¤±å½±å“ |
|---------|---------|---------|------------|
| start | id, type, data.name | data.description | æè¿°ä¸¢å¤±ä¸å½±å“æ‰§è¡Œ |
| end | id, type, data.name | data.description | æè¿°ä¸¢å¤±ä¸å½±å“æ‰§è¡Œ |
| message_receive | id, type, data.config.saveToDatabase | data.config.pushToSSE, data.config.timeout | SSEæ¨é€ä¸¢å¤±ä¸å½±å“æ¥æ”¶ |
| session_create | id, type, data.config.sessionTimeout | data.config.maxHistory | å†å²æ¶ˆæ¯æ•°ä¸¢å¤±ä½¿ç”¨é»˜è®¤å€¼ |
| context_enhancer | id, type, data.config.historyLimit | data.config.includeUserProfileç­‰ | åŒ…å«é€‰é¡¹ä¸¢å¤±ä½¿ç”¨é»˜è®¤å€¼ |
| unified_analyze | id, type, data.config.aiModel | data.config.temperature, data.config.maxTokensç­‰ | æ¸©åº¦ç­‰å‚æ•°ä¸¢å¤±ä½¿ç”¨é»˜è®¤å€¼ |
| decision | id, type, data.config.expression, data.config.conditions | - | æ¡ä»¶ä¸¢å¤±å¯¼è‡´è·¯ç”±å¤±è´¥ |
| ai_reply | id, type, data.config.aiModel | data.config.systemPromptç­‰ | ç³»ç»Ÿæç¤ºè¯ä¸¢å¤±å½±å“å›å¤è´¨é‡ |
| delay | id, type, data.config.delayMode | data.config.delayTime, data.config.strategyç­‰ | ç­–ç•¥ä¸¢å¤±ä½¿ç”¨å›ºå®šå»¶è¿Ÿ |
| flow_call | id, type, data.config.flowId | data.config.version, data.config.asyncç­‰ | ç‰ˆæœ¬ä¸¢å¤±ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬ |
| robot_dispatch | id, type, data.config.dispatchStrategy | data.config.robotTypes, data.config.maxLoad | æœºå™¨äººç±»å‹ä¸¢å¤±ä½¿ç”¨æ‰€æœ‰æœºå™¨äºº |
| send_command | id, type, data.config.commandType | data.config.groupId, data.config.message | ç›®æ ‡æˆ–æ¶ˆæ¯ä¸¢å¤±å¯¼è‡´å‘é€å¤±è´¥ |
| command_status | id, type, data.config.status | data.config.retryCount | é‡è¯•æ¬¡æ•°ä¸¢å¤±ä½¿ç”¨0 |
| log_save | id, type, data.config.logLevel | data.config.message | æ—¥å¿—æ¶ˆæ¯ä¸¢å¤±ä½¿ç”¨é»˜è®¤æ¶ˆæ¯ |
| image_process | id, type, data.config.imageUrl | data.config.recognitionModel | æ¨¡å‹ä¸¢å¤±ä½¿ç”¨é»˜è®¤æ¨¡å‹ |
| ai_reply_enhanced | id, type, data.config.aiModel | data.config.imageUrl, data.config.imageContext | å›¾ç‰‡ä¸Šä¸‹æ–‡ä¸¢å¤±å½±å“å›å¤è´¨é‡ |
| alert_save | id, type, data.config.alertLevel | data.config.alertType, data.config.description | æè¿°ä¸¢å¤±ä¸å½±å“ä¿å­˜ |
| alert_rule | id, type, data.config.rules | data.config.timeout | è§„åˆ™ä¸¢å¤±ä½¿ç”¨é»˜è®¤è§„åˆ™ |
| alert_notify | id, type, data.config.notifyChannels | data.config.recipients | é€šçŸ¥æ¸ é“ä¸¢å¤±ä½¿ç”¨é»˜è®¤æ¸ é“ |
| alert_escalate | id, type, data.config.escalateTo | data.config.escalateCondition | å‡çº§ç›®æ ‡ä¸¢å¤±ä¸å‡çº§ |
| staff_intervention | id, type, data.config.staffId | data.config.priority | å‘˜å·¥IDä¸¢å¤±å¯¼è‡´è½¬æ¥å¤±è´¥ |
| task_assign | id, type, data.config.taskType | data.config.assignTo | ä»»åŠ¡ç±»å‹ä¸¢å¤±æ— æ³•åˆ›å»ºä»»åŠ¡ |
| collaboration_analyze | id, type, data.config.analyzeType | data.config.outputFields | åˆ†æç±»å‹ä¸¢å¤±ä½¿ç”¨é»˜è®¤åˆ†æ |

---

## âœ… éªŒè¯æ¸…å•

### 1. èŠ‚ç‚¹ç±»å‹éªŒè¯
- [ ] FLOW_CALLèŠ‚ç‚¹ç±»å‹å·²æ·»åŠ åˆ°NodeType
- [ ] DELAYèŠ‚ç‚¹ç±»å‹å·²æ·»åŠ åˆ°NodeType
- [ ] æ‰€æœ‰èŠ‚ç‚¹ç±»å‹å·²æ³¨å†Œåˆ°nodeHandlers

### 2. èŠ‚ç‚¹å¤„ç†å™¨éªŒè¯
- [ ] handleFlowCallNodeæ–¹æ³•å·²å®ç°
- [ ] handleDelayNodeæ–¹æ³•å·²å®ç°
- [ ] æ‰€æœ‰èŠ‚ç‚¹å¤„ç†å™¨å·²æ­£ç¡®ç»‘å®š

### 3. æµç¨‹æ–‡ä»¶éªŒè¯
- [ ] ä¸»æµç¨‹æ–‡ä»¶å·²åˆ›å»ºï¼ˆ00-main-flow.jsonï¼‰
- [ ] 11ä¸ªå­æµç¨‹æ–‡ä»¶å·²åˆ›å»º
- [ ] æ‰€æœ‰æµç¨‹æ–‡ä»¶æ ¼å¼æ­£ç¡®
- [ ] æ‰€æœ‰èŠ‚ç‚¹IDå”¯ä¸€
- [ ] æ‰€æœ‰è¾¹è¿æ¥æ­£ç¡®

### 4. æµç¨‹å¯¼å…¥éªŒè¯
- [ ] æ‰€æœ‰æµç¨‹å·²å¯¼å…¥æ•°æ®åº“
- [ ] æµç¨‹ç‰ˆæœ¬æ­£ç¡®
- [ ] æµç¨‹ä¼˜å…ˆçº§æ­£ç¡®
- [ ] ä¸»æµç¨‹æ ‡è®°ä¸ºé»˜è®¤

### 5. åŠŸèƒ½éªŒè¯
- [ ] FLOW_CALLèŠ‚ç‚¹å¯ä»¥è°ƒç”¨å­æµç¨‹
- [ ] DELAYèŠ‚ç‚¹å¯ä»¥å»¶è¿Ÿæ‰§è¡Œ
- [ ] å»¶è¿Ÿç­–ç•¥æ­£ç¡®åº”ç”¨
- [ ] å‚æ•°ä¼ é€’æ­£ç¡®
- [ ] è¿”å›å€¼æ˜ å°„æ­£ç¡®

---

## ğŸ“ˆ é¢„æœŸæ”¶ç›Š

### æ¶æ„ä¼˜åŠ¿
- âœ… æ¨¡å—åŒ–ï¼šæ¯ä¸ªæµç¨‹èŒè´£å•ä¸€ï¼Œæ˜“äºç†è§£å’Œç»´æŠ¤
- âœ… å¯å¤ç”¨ï¼šå‘½ä»¤çŠ¶æ€æµç¨‹è¢«å¤šä¸ªæµç¨‹å¤ç”¨
- âœ… å¯æµ‹è¯•ï¼šæ¯ä¸ªæµç¨‹å¯ä»¥ç‹¬ç«‹æµ‹è¯•
- âœ… å¯æ‰©å±•ï¼šæ–°å¢ä¸šåŠ¡åœºæ™¯åªéœ€æ·»åŠ æ–°æµç¨‹
- âœ… å¯ç‰ˆæœ¬æ§åˆ¶ï¼šä¸åŒæµç¨‹å¯ä»¥ç‹¬ç«‹å‡çº§

### å¼€å‘æ•ˆç‡
- âœ… æµç¨‹è®¾è®¡æ—¶é—´ï¼šå‡å°‘50%ï¼ˆå¤ç”¨å­æµç¨‹ï¼‰
- âœ… æµ‹è¯•æ—¶é—´ï¼šå‡å°‘70%ï¼ˆç‹¬ç«‹æµ‹è¯•ï¼‰
- âœ… ç»´æŠ¤æˆæœ¬ï¼šé™ä½60%ï¼ˆå®šä½é—®é¢˜æ›´å¿«ï¼‰

### è¿è¡Œæ•ˆç‡
- âœ… å“åº”æ—¶é—´ï¼šå¢åŠ 10-20%ï¼ˆæœ‰è°ƒç”¨å¼€é”€ï¼‰
- âœ… å¹¶å‘å¤„ç†ï¼šæå‡30%ï¼ˆæ”¯æŒå¼‚æ­¥è°ƒç”¨ï¼‰
- âœ… èµ„æºåˆ©ç”¨ç‡ï¼šæå‡20%ï¼ˆæµç¨‹æŒ‰éœ€åŠ è½½ï¼‰

---

## ğŸš€ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. âœ… ç¡®è®¤æ–¹æ¡ˆè®¾è®¡
2. ğŸ”§ å®ç°FLOW_CALLå’ŒDELAYèŠ‚ç‚¹å¤„ç†å™¨
3. ğŸ“ åˆ›å»ºä¸»æµç¨‹æ–‡ä»¶
4. ğŸ“ åˆ›å»º11ä¸ªå­æµç¨‹æ–‡ä»¶
5. ğŸ—„ï¸ å¯¼å…¥æµç¨‹åˆ°æ•°æ®åº“
6. âœ… éªŒè¯æµç¨‹æ‰§è¡Œ
7. ğŸ“Š ç”ŸæˆéªŒè¯æŠ¥å‘Š

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv6.0.0
**åˆ›å»ºæ—¥æœŸ**ï¼š2025-01-10
**æœ€åæ›´æ–°**ï¼š2025-01-10
