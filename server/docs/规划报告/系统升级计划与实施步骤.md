# WorkTool AI 中枢系统 - 系统升级计划与实施步骤

**文档版本**：v1.0
**创建日期**：2026-02-10
**预计开始日期**：2026-02-10
**预计完成日期**：TBD

---

## 📋 目录

1. [升级概述](#1-升级概述)
2. [现有系统分析](#2-现有系统分析)
3. [升级目标](#3-升级目标)
4. [升级范围](#4-升级范围)
5. [升级风险与应对](#5-升级风险与应对)
6. [分阶段升级计划](#6-分阶段升级计划)
7. [详细实施步骤](#7-详细实施步骤)
8. [数据库升级方案](#8-数据库升级方案)
9. [后端API升级方案](#9-后端api升级方案)
10. [前端页面升级方案](#10-前端页面升级方案)
11. [测试计划](#11-测试计划)
12. [上线计划](#12-上线计划)
13. [回滚计划](#13-回滚计划)
14. [验收标准](#14-验收标准)

---

## 1. 升级概述

### 1.1 升级背景

基于`客服工作流程分析与优化.md`文档，WorkTool AI 中枢系统需要进行全面升级，以支持更完善的工作流程、更智能的协同分析、更完善的售后服务和更可靠的告警机制。

### 1.2 升级必要性

| 领域 | 现状 | 问题 | 升级必要性 |
|------|------|------|-----------|
| **消息类型识别** | 无明确的消息类型识别 | 无法根据消息类型选择处理策略 | ⭐⭐⭐ 高 |
| **工作人员介入判断** | 基础识别，逻辑简单 | 介入判断不够准确，协同分析不完整 | ⭐⭐⭐ 高 |
| **告警机制** | 基础告警，无等级提升 | 告警无法取消，等级无法提升 | ⭐⭐⭐ 高 |
| **售后服务流程** | 基础任务管理，无实时监控 | 任务分配不智能，用户响应无监控 | ⭐⭐⭐ 高 |
| **协同分析** | 部分实现，不完整 | 分析维度不全，结果不实时 | ⭐⭐ 中 |
| **机器人角色** | 4种机器人，规则明确 | 需要健康监控和智能选择 | ⭐⭐ 中 |
| **通讯结果处理** | 只处理接收成功 | 执行结果未知，无法判断发送状态 | ⭐ 低 |
| **前端页面** | 基础监控，缺少详细页面 | 需要用户会话、社群会话、售后大屏 | ⭐⭐ 中 |

### 1.3 升级原则

1. **渐进式升级**：分阶段进行，每个阶段独立可验证
2. **向后兼容**：保证现有功能不受影响
3. **可回滚**：每个升级点都有回滚方案
4. **数据安全**：升级过程中保证数据不丢失
5. **服务可用**：尽量减少服务中断时间

---

## 2. 现有系统分析

### 2.1 技术架构

```
前端 (Next.js 16)
  ├── 页面层
  │   ├── src/app/page.tsx (主页)
  │   ├── src/app/after-sales/page.tsx (售后管理)
  │   └── src/app/chat/page.tsx (聊天)
  ├── 组件层
  │   ├── src/components/ (shadcn/ui组件)
  │   └── src/hooks/ (自定义Hooks)
  └── API Routes
      └── src/app/api/ (Next.js API代理)

后端 (Fastify + Node.js 24)
  ├── 路由层 (server/routes/)
  │   ├── 40+ API路由文件
  │   ├── sse.api.js (SSE实时推送)
  │   └── worktool-robot.api.js (机器人通信)
  ├── 服务层 (server/services/)
  │   ├── 50+ 服务文件
  │   ├── message-processing.service.js (消息处理)
  │   ├── flow-engine.service.js (流程引擎)
  │   ├── collaboration.service.js (协同分析)
  │   ├── alert.service.js (告警服务)
  │   └── robot.service.js (机器人服务)
  └── 数据库层 (server/database/)
      └── schema.js (30+ 数据表)

数据库 (PostgreSQL 15)
  ├── 核心业务表 (session_messages, sessions, robots)
  ├── 告警相关表 (alert_rules, alert_history)
  ├── AI相关表 (ai_providers, ai_models, ai_roles)
  ├── 售后相关表 (after_sales_tasks, staff_activities)
  └── 流程引擎表 (flow_definitions, flow_instances)
```

### 2.2 现有功能清单

#### 已实现功能 ✅

| 功能模块 | 功能点 | 实现状态 | 备注 |
|---------|--------|---------|------|
| **消息接收** | 企业微信机器人上报消息 | ✅ 已实现 | worktool.callback.js |
| **消息保存** | 保存到session_messages表 | ✅ 已实现 | session-message.service.js |
| **工作人员识别** | 识别工作人员消息 | ✅ 已实现 | staff/staff-identifier.service.js |
| **流程引擎** | 流程定义和执行 | ✅ 已实现 | flow-engine.service.js |
| **SSE推送** | 实时消息推送 | ✅ 已实现 | sse.api.js |
| **告警系统** | 告警创建和通知 | ✅ 已实现 | alert.service.js |
| **协同分析** | 基础协同分析 | ✅ 已实现 | collaboration.service.js |
| **售后任务** | 任务创建和管理 | ✅ 已实现 | collaboration.service.js |
| **机器人管理** | 机器人配置和监控 | ✅ 已实现 | robot.service.js |
| **AI分析** | 意图识别和回复生成 | ✅ 已实现 | ai.service.js |
| **用户登录** | 平台登录用户管理 | ✅ 已实现 | auth-complete.api.js |

#### 未实现功能 ❌

| 功能模块 | 功能点 | 实现状态 | 优先级 |
|---------|--------|---------|--------|
| **消息类型识别** | 识别8种消息类型 | ❌ 未实现 | P0 |
| **工作人员介入判断** | 4种介入情况判断 | ❌ 未实现 | P0 |
| **告警取消机制** | 5种取消条件 | ❌ 未实现 | P0 |
| **告警等级提升** | Level 1-4提升策略 | ❌ 未实现 | P0 |
| **售后实时监控** | 实时监控大屏 | ❌ 未实现 | P1 |
| **用户响应监控** | 自动检测"在"、拒绝配合 | ❌ 未实现 | P1 |
| **售后任务自动分配** | 工作负载+技能匹配 | ❌ 未实现 | P1 |
| **每日售后报告** | 自动生成报告 | ❌ 未实现 | P2 |
| **用户会话页面** | 每个用户的会话详情 | ❌ 未实现 | P2 |
| **社群会话页面** | 每个社群的会话详情 | ❌ 未实现 | P2 |
| **通讯结果处理** | 60秒超时检查 | ❌ 未实现 | P2 |
| **机器人健康监控** | 健康分数和建议 | ❌ 未实现 | P2 |

### 2.3 现有数据库表

#### 核心业务表 (10张)

| 表名 | 说明 | 字段数 | 索引数 |
|------|------|--------|--------|
| sessions | 会话表 | 20+ | 5 |
| session_messages | 会话消息表 | 30+ | 10 |
| robots | 机器人表 | 20+ | 5 |
| users | 用户表 | 20+ | 2 |
| staff_activities | 工作人员活动表 | 10 | 3 |
| after_sales_tasks | 售后任务表 | 15 | 7 |

#### 告警相关表 (4张)

| 表名 | 说明 | 字段数 | 索引数 |
|------|------|--------|--------|
| alert_rules | 告警规则表 | 15 | 4 |
| alert_history | 告警历史表 | 30+ | 10 |
| notification_methods | 通知方式配置表 | 10 | 4 |
| alert_groups | 告警分组表 | 10 | 2 |

#### AI相关表 (6张)

| 表名 | 说明 | 字段数 | 索引数 |
|------|------|--------|--------|
| ai_providers | AI提供商配置表 | 12 | 4 |
| ai_models | AI模型配置表 | 15 | 4 |
| ai_roles | AI角色配置表 | 15 | 5 |
| ai_role_versions | AI角色版本表 | 10 | 3 |
| ai_model_usage | AI模型使用记录表 | 15 | 3 |
| prompt_category_templates | 话术分类模板表 | 12 | 3 |

#### 流程引擎表 (4张)

| 表名 | 说明 | 字段数 | 索引数 |
|------|------|--------|--------|
| flow_definitions | 流程定义表 | 20+ | 5 |
| flow_instances | 流程实例表 | 15 | 5 |
| flow_execution_logs | 流程执行日志表 | 15 | 3 |
| flow_nodes | 流程节点表 | 15 | 3 |

---

## 3. 升级目标

### 3.1 核心目标

#### 目标1：完善消息处理流程 ⭐⭐⭐

**现状**：
- 无明确的消息类型识别
- 工作人员介入判断逻辑简单
- 协同分析不完整

**目标**：
- 实现8种消息类型识别
- 实现4种工作人员介入情况判断
- 实现完整的协同分析逻辑（4个维度）

**衡量标准**：
- 消息类型识别准确率 > 90%
- 工作人员介入判断准确率 > 85%
- 协同分析覆盖所有关键指标

---

#### 目标2：完善告警机制 ⭐⭐⭐

**现状**：
- 告警无法自动取消
- 告警等级无法自动提升
- 告警通知方式单一

**目标**：
- 实现5种告警取消条件
- 实现4级告警等级提升策略
- 实现多通道告警通知（企业微信+电话+短信）

**衡量标准**：
- 告警取消准确率 > 95%
- 告警等级提升准确率 > 90%
- 告警通知送达率 > 99%

---

#### 目标3：完善售后服务流程 ⭐⭐⭐

**现状**：
- 售后任务手动分配
- 无实时监控大屏
- 无用户响应监控
- 无每日售后报告

**目标**：
- 实现售后任务自动分配（工作负载+技能匹配）
- 实现售后实时监控大屏
- 实现用户响应监控（自动检测"在"、拒绝配合）
- 实现每日售后报告自动生成

**衡量标准**：
- 售后任务自动分配准确率 > 85%
- 用户响应监控准确率 > 90%
- 售后报告生成成功率 > 99%

---

#### 目标4：优化机器人角色体系 ⭐⭐

**现状**：
- 4种机器人角色，规则明确
- 无机器人健康监控
- 无智能选择策略

**目标**：
- 实现机器人健康监控（健康分数、状态分级、改进建议）
- 实现智能机器人选择策略
- 优化机器人选择规则

**衡量标准**：
- 机器人健康监控覆盖率 = 100%
- 智能选择策略准确率 > 90%

---

#### 目标5：增强前端功能 ⭐⭐

**现状**：
- 基础监控页面
- 无用户会话详情页
- 无社群会话详情页
- 无售后实时监控大屏

**目标**：
- 实现用户会话列表和详情页
- 实现社群会话列表和详情页
- 实现售后实时监控大屏
- 优化现有监控页面

**衡量标准**：
- 页面加载时间 < 2秒
- 实时数据延迟 < 3秒
- 用户满意度 > 90%

---

### 3.2 非功能性目标

| 目标 | 当前值 | 目标值 | 衡量方法 |
|------|--------|--------|---------|
| **系统可用性** | 99.5% | 99.9% | 监控系统运行时间 |
| **响应时间** | 平均500ms | 平均<300ms | APM监控 |
| **并发处理** | 100 qps | 500 qps | 压力测试 |
| **数据准确性** | 99% | 99.9% | 数据校验 |
| **系统稳定性** | 偶尔报错 | 无重大错误 | 错误日志 |
| **扩展性** | 支持增加节点 | 支持水平扩展 | 架构设计 |

---

## 4. 升级范围

### 4.1 数据库升级

#### 新增表 (3张)

| 表名 | 说明 | 优先级 |
|------|------|--------|
| message_types | 消息类型配置表 | P0 |
| alert_levels | 告警级别配置表 | P0 |
| robot_health | 机器人健康状态表 | P2 |

#### 新增字段 (15+)

| 表名 | 新增字段 | 说明 | 优先级 |
|------|---------|------|--------|
| session_messages | messageType | 消息类型 | P0 |
| session_messages | isStaffIntervention | 是否工作人员介入 | P0 |
| session_messages | interventionReason | 介入原因 | P0 |
| alert_history | alertLevel | 告警级别 (1-4) | P0 |
| alert_history | cancelReason | 取消原因 | P0 |
| alert_history | cancelledAt | 取消时间 | P0 |
| alert_history | escalationCount | 升级次数 | P0 |
| after_sales_tasks | autoAssignedBy | 自动分配人 | P1 |
| after_sales_tasks | userResponseStatus | 用户响应状态 | P1 |
| after_sales_tasks | userResponseTime | 用户响应时间 | P1 |
| after_sales_tasks | userCooperationLevel | 用户配合度 | P1 |
| robots | healthScore | 健康分数 | P2 |
| robots | healthStatus | 健康状态 | P2 |
| robots | lastHealthCheck | 最后健康检查时间 | P2 |
| robots | recommendations | 改进建议 | P2 |

#### 新增索引 (10+)

| 表名 | 索引字段 | 优先级 |
|------|---------|--------|
| session_messages | messageType | P0 |
| alert_history | alertLevel | P0 |
| alert_history | cancelledAt | P0 |
| after_sales_tasks | userResponseStatus | P1 |
| robots | healthScore | P2 |

---

### 4.2 后端API升级

#### 新增服务 (8个)

| 服务文件 | 说明 | 优先级 |
|---------|------|--------|
| message-type-identification.service.js | 消息类型识别服务 | P0 |
| staff-intervention.service.js | 工作人员介入判断服务 | P0 |
| alert-cancellation.service.js | 告警取消服务 | P0 |
| alert-escalation.service.js | 告警升级服务 | P0 |
| after-sales-assignment.service.js | 售后任务自动分配服务 | P1 |
| user-response-monitor.service.js | 用户响应监控服务 | P1 |
| robot-health-monitor.service.js | 机器人健康监控服务 | P2 |
| command-status-monitor.service.js | 通讯状态监控服务 | P2 |

#### 新增API端点 (20+)

| 端点 | 方法 | 说明 | 优先级 |
|------|------|------|--------|
| /api/messages/types | GET | 获取消息类型列表 | P0 |
| /api/alerts/:id/cancel | POST | 取消告警 | P0 |
| /api/alerts/:id/escalate | POST | 升级告警 | P0 |
| /api/after-sales/assign | POST | 自动分配售后任务 | P1 |
| /api/after-sales/:taskId/user-response | GET | 获取用户响应状态 | P1 |
| /api/robots/:id/health | GET | 获取机器人健康状态 | P2 |
| /api/commands/:id/status | GET | 获取通讯状态 | P2 |
| /api/reports/daily-after-sales | GET | 获取每日售后报告 | P1 |
| /api/sessions/:sessionId | GET | 获取会话详情 | P2 |
| /api/groups/:groupId/sessions | GET | 获取社群会话列表 | P2 |

#### 修改现有服务 (10+)

| 服务文件 | 修改内容 | 优先级 |
|---------|---------|--------|
| message-processing.service.js | 集成消息类型识别 | P0 |
| message-processing.service.js | 集成工作人员介入判断 | P0 |
| alert.service.js | 集成告警取消机制 | P0 |
| alert.service.js | 集成告警升级机制 | P0 |
| collaboration.service.js | 完善协同分析逻辑 | P0 |
| collaboration.service.js | 集成用户响应监控 | P1 |
| collaboration.service.js | 集成每日售后报告 | P1 |
| robot.service.js | 集成健康监控 | P2 |
| robot-command.service.js | 集成通讯状态监控 | P2 |
| flow-engine.service.js | 增加新节点类型 | P0 |

---

### 4.3 前端页面升级

#### 新增页面 (5个)

| 页面路径 | 说明 | 优先级 |
|---------|------|--------|
| src/app/sessions/[sessionId]/page.tsx | 用户会话详情页 | P2 |
| src/app/groups/[groupId]/page.tsx | 社群会话详情页 | P2 |
| src/app/after-sales/dashboard/page.tsx | 售后实时监控大屏 | P1 |
| src/app/alerts/manage/page.tsx | 告警管理页 | P0 |
| src/app/reports/daily-after-sales/page.tsx | 每日售后报告页 | P1 |

#### 新增组件 (10+)

| 组件路径 | 说明 | 优先级 |
|---------|------|--------|
| src/components/message-type-badge.tsx | 消息类型徽章 | P0 |
| src/components/alert-level-badge.tsx | 告警级别徽章 | P0 |
| src/components/alert-cancel-modal.tsx | 告警取消弹窗 | P0 |
| src/components/alert-escalate-modal.tsx | 告警升级弹窗 | P0 |
| src/components/after-sales-dashboard.tsx | 售后监控大屏组件 | P1 |
| src/components/user-response-monitor.tsx | 用户响应监控组件 | P1 |
| src/components/robot-health-card.tsx | 机器人健康卡片 | P2 |
| src/components/session-detail-view.tsx | 会话详情视图 | P2 |
| src/components/session-list-view.tsx | 会话列表视图 | P2 |
| src/components/daily-after-sales-report.tsx | 每日售后报告组件 | P1 |

#### 修改现有页面 (5+)

| 页面路径 | 修改内容 | 优先级 |
|---------|---------|--------|
| src/app/after-sales/page.tsx | 增加告警取消、升级功能 | P0 |
| src/app/after-sales/page.tsx | 集成用户响应监控 | P1 |
| src/app/page.tsx | 增加机器人健康监控 | P2 |
| src/app/chat/page.tsx | 增加消息类型标识 | P0 |
| src/app/chat/page.tsx | 增加工作人员介入标识 | P0 |

---

## 5. 升级风险与应对

### 5.1 技术风险

| 风险 | 影响 | 概率 | 应对措施 |
|------|------|------|---------|
| **数据库迁移失败** | 数据丢失，系统不可用 | 中 | 1. 提前备份数据库<br>2. 分步迁移，每步验证<br>3. 准备回滚方案 |
| **现有功能被破坏** | 服务中断，用户投诉 | 中 | 1. 渐进式升级<br>2. 充分测试<br>3. 快速回滚机制 |
| **性能下降** | 响应时间变慢 | 低 | 1. 压力测试<br>2. 优化SQL<br>3. 增加缓存 |
| **并发问题** | 数据不一致 | 中 | 1. 事务管理<br>2. 乐观锁<br>3. 队列缓冲 |
| **AI调用失败** | 分析不准确 | 低 | 1. 降级策略<br>2. 重试机制<br>3. 备用AI模型 |

### 5.2 业务风险

| 风险 | 影响 | 概率 | 应对措施 |
|------|------|------|---------|
| **用户不适应新流程** | 使用体验下降 | 低 | 1. 用户培训<br>2. 操作指南<br>3. 渐进式切换 |
| **工作人员不适应新规则** | 工作效率下降 | 中 | 1. 内部培训<br>2. 试运行<br>3. 反馈收集 |
| **告警误报/漏报** | 影响业务决策 | 中 | 1. 充分测试<br>2. 灰度发布<br>3. 快速调整 |
| **售后任务分配错误** | 影响服务质量 | 低 | 1. 人工审核<br>2. 转派功能<br>3. 持续优化 |

### 5.3 时间风险

| 风险 | 影响 | 概率 | 应对措施 |
|------|------|------|---------|
| **开发时间超期** | 延期上线 | 中 | 1. 合理排期<br>2. 优先级管理<br>3. 并行开发 |
| **测试时间不足** | 质量问题 | 中 | 1. 提前测试<br>2. 自动化测试<br>3. 延长测试期 |
| **上线时间冲突** | 业务影响 | 低 | 1. 选择低峰期<br>2. 分批上线<br>3. 快速回滚 |

### 5.4 团队风险

| 风险 | 影响 | 概率 | 应对措施 |
|------|------|------|---------|
| **人员变动** | 开发延期 | 低 | 1. 代码规范<br>2. 文档完善<br>3. 知识共享 |
| **沟通不畅** | 需求理解偏差 | 中 | 1. 每日站会<br>2. 需求评审<br>3. 定期回顾 |

---

## 6. 分阶段升级计划

### 6.1 升级阶段划分

根据优先级和依赖关系，将升级分为4个阶段：

| 阶段 | 名称 | 优先级 | 预计工期 | 依赖 |
|------|------|--------|---------|------|
| **阶段1** | 消息处理流程升级 | P0 | 2周 | 无 |
| **阶段2** | 告警机制升级 | P0 | 1.5周 | 阶段1 |
| **阶段3** | 售后服务流程升级 | P1 | 2.5周 | 阶段1+2 |
| **阶段4** | 前端页面和机器人监控 | P2 | 2周 | 阶段1+2+3 |

**总工期**：约8周（2个月）

---

### 6.2 阶段1：消息处理流程升级 (P0)

#### 目标
- 实现消息类型识别
- 实现工作人员介入判断
- 完善协同分析逻辑

#### 工作内容

##### 1.1 数据库升级 (2天)
- 创建 `message_types` 表
- `session_messages` 表新增字段
  - `messageType`
  - `isStaffIntervention`
  - `interventionReason`
- 创建相关索引
- 编写迁移脚本
- 测试迁移

##### 1.2 后端服务开发 (5天)
- 创建 `message-type-identification.service.js`
  - 识别8种消息类型
  - 识别4种工作人员消息类型
- 创建 `staff-intervention.service.js`
  - 实现4种介入情况判断
- 修改 `message-processing.service.js`
  - 集成消息类型识别
  - 集成工作人员介入判断
- 修改 `collaboration.service.js`
  - 完善工作人员活跃度分析
  - 完善用户满意度分析
  - 完善人工介入分析
  - 完善协同效果分析

##### 1.3 后端API开发 (3天)
- 创建 `message-type-identification` API
- 修改 `messages` API，返回消息类型
- 修改 `collaboration` API，返回详细分析结果

##### 1.4 前端组件开发 (2天)
- 创建 `message-type-badge.tsx` 组件
- 创建 `intervention-indicator.tsx` 组件
- 修改 `chat/page.tsx`，显示消息类型和介入标识
- 修改 `after-sales/page.tsx`，显示协同分析结果

##### 1.5 测试 (3天)
- 单元测试
- 集成测试
- 手动测试

#### 验收标准
- ✅ 消息类型识别准确率 > 90%
- ✅ 工作人员介入判断准确率 > 85%
- ✅ 协同分析覆盖所有关键指标
- ✅ 所有测试用例通过

---

### 6.3 阶段2：告警机制升级 (P0)

#### 目标
- 实现告警取消机制
- 实现告警等级提升策略
- 实现多通道告警通知

#### 工作内容

##### 2.1 数据库升级 (1天)
- 创建 `alert_levels` 表
- `alert_history` 表新增字段
  - `alertLevel`
  - `cancelReason`
  - `cancelledAt`
  - `escalationCount`
- 创建相关索引
- 编写迁移脚本
- 测试迁移

##### 2.2 后端服务开发 (4天)
- 创建 `alert-cancellation.service.js`
  - 实现5种告警取消条件
  - 实现告警取消检查任务
- 创建 `alert-escalation.service.js`
  - 实现4级告警等级提升策略
  - 实现告警升级检查任务
- 修改 `alert.service.js`
  - 集成告警取消机制
  - 集成告警升级机制
- 修改 `notification.service.js`
  - 实现多通道通知（企业微信+电话+短信）

##### 2.3 后端API开发 (2天)
- 创建 `alert-cancel` API
- 创建 `alert-escalate` API
- 创建 `alert-levels` API
- 修改 `alert` API，返回告警级别

##### 2.4 前端组件开发 (2天)
- 创建 `alert-level-badge.tsx` 组件
- 创建 `alert-cancel-modal.tsx` 组件
- 创建 `alert-escalate-modal.tsx` 组件
- 修改 `after-sales/page.tsx`，增加告警管理功能

##### 2.5 测试 (2天)
- 单元测试
- 集成测试
- 告警取消测试
- 告警升级测试

#### 验收标准
- ✅ 告警取消准确率 > 95%
- ✅ 告警等级提升准确率 > 90%
- ✅ 告警通知送达率 > 99%
- ✅ 所有测试用例通过

---

### 6.4 阶段3：售后服务流程升级 (P1)

#### 目标
- 实现售后任务自动分配
- 实现用户响应监控
- 实现售后实时监控大屏
- 实现每日售后报告

#### 工作内容

##### 3.1 数据库升级 (1天)
- `after_sales_tasks` 表新增字段
  - `autoAssignedBy`
  - `userResponseStatus`
  - `userResponseTime`
  - `userCooperationLevel`
- 创建相关索引
- 编写迁移脚本
- 测试迁移

##### 3.2 后端服务开发 (7天)
- 创建 `after-sales-assignment.service.js`
  - 实现工作负载匹配
  - 实现技能匹配
  - 实现轮询分配
- 创建 `user-response-monitor.service.js`
  - 实现用户响应检测
  - 实现拒绝配合检测
  - 实现超时提醒
- 修改 `collaboration.service.js`
  - 集成用户响应监控
  - 实现每日售后报告生成

##### 3.3 后端API开发 (3天)
- 创建 `after-sales-assign` API
- 创建 `user-response` API
- 创建 `daily-after-sales-report` API
- 修改 `after-sales-tasks` API

##### 3.4 前端页面开发 (5天)
- 创建 `after-sales-dashboard/page.tsx` (售后实时监控大屏)
- 创建 `after-sales-dashboard.tsx` 组件
- 创建 `user-response-monitor.tsx` 组件
- 创建 `daily-after-sales-report.tsx` 组件
- 修改 `after-sales/page.tsx`，集成用户响应监控

##### 3.5 测试 (3天)
- 单元测试
- 集成测试
- 自动分配测试
- 用户响应监控测试

#### 验收标准
- ✅ 售后任务自动分配准确率 > 85%
- ✅ 用户响应监控准确率 > 90%
- ✅ 售后报告生成成功率 > 99%
- ✅ 所有测试用例通过

---

### 6.5 阶段4：前端页面和机器人监控 (P2)

#### 目标
- 实现用户会话详情页
- 实现社群会话详情页
- 实现机器人健康监控
- 实现通讯状态监控

#### 工作内容

##### 4.1 数据库升级 (1天)
- 创建 `robot_health` 表
- `robots` 表新增字段
  - `healthScore`
  - `healthStatus`
  - `lastHealthCheck`
  - `recommendations`
- 创建相关索引
- 编写迁移脚本
- 测试迁移

##### 4.2 后端服务开发 (4天)
- 创建 `robot-health-monitor.service.js`
  - 实现机器人健康检查
  - 实现健康分数计算
  - 实现改进建议生成
- 创建 `command-status-monitor.service.js`
  - 实现60秒超时检查
  - 实现执行结果处理
- 修改 `robot.service.js`
  - 集成健康监控
- 修改 `robot-command.service.js`
  - 集成通讯状态监控

##### 4.3 后端API开发 (3天)
- 创建 `robot-health` API
- 创建 `command-status` API
- 创建 `sessions/:sessionId` API
- 创建 `groups/:groupId/sessions` API

##### 4.4 前端页面开发 (7天)
- 创建 `sessions/[sessionId]/page.tsx` (用户会话详情页)
- 创建 `groups/[groupId]/page.tsx` (社群会话详情页)
- 创建 `session-detail-view.tsx` 组件
- 创建 `session-list-view.tsx` 组件
- 创建 `robot-health-card.tsx` 组件
- 修改 `page.tsx`，增加机器人健康监控

##### 4.5 测试 (2天)
- 单元测试
- 集成测试
- 页面性能测试

#### 验收标准
- ✅ 机器人健康监控覆盖率 = 100%
- ✅ 智能选择策略准确率 > 90%
- ✅ 页面加载时间 < 2秒
- ✅ 所有测试用例通过

---

## 7. 详细实施步骤

### 7.1 阶段1实施步骤 (第1-2周)

#### Week 1: Day 1-2 (数据库升级)

**任务清单：**
- [ ] 设计 `message_types` 表结构
- [ ] 编写创建表的SQL脚本
- [ ] 设计 `session_messages` 表新增字段
- [ ] 编写字段添加的SQL脚本
- [ ] 创建相关索引
- [ ] 编写数据迁移脚本（如有数据迁移）
- [ ] 在测试环境执行迁移脚本
- [ ] 验证表结构和数据
- [ ] 编写回滚脚本
- [ ] 文档化迁移过程

**产出：**
- SQL迁移脚本：`server/database/migrations/001_add_message_types.sql`
- 回滚脚本：`server/database/migrations/rollback_001_add_message_types.sql`
- 迁移文档：`server/docs/migrations/001_add_message_types.md`

---

#### Week 1: Day 3-7 (后端服务开发)

**Day 3-4: 消息类型识别服务**

**任务清单：**
- [ ] 设计消息类型识别算法
- [ ] 创建 `message-type-identification.service.js`
- [ ] 实现8种用户消息类型识别
- [ ] 实现4种工作人员消息类型识别
- [ ] 编写单元测试
- [ ] 集成测试

**代码框架：**
```javascript
// server/services/message-type-identification.service.js

class MessageTypeIdentificationService {
  /**
   * 识别用户消息类型
   * @param {string} message - 消息内容
   * @param {Array} context - 上下文消息
   * @returns {Object} { type, confidence, reason }
   */
  identifyUserMessageType(message, context) {
    // 实现逻辑
  }

  /**
   * 识别工作人员消息类型
   * @param {string} message - 消息内容
   * @param {Array} context - 上下文消息
   * @returns {Object} { type, confidence, reason }
   */
  identifyStaffMessageType(message, context) {
    // 实现逻辑
  }
}
```

---

**Day 5-6: 工作人员介入判断服务**

**任务清单：**
- [ ] 设计介入判断算法
- [ ] 创建 `staff-intervention.service.js`
- [ ] 实现4种介入情况判断
- [ ] 编写单元测试
- [ ] 集成测试

**代码框架：**
```javascript
// server/services/staff-intervention.service.js

class StaffInterventionService {
  /**
   * 判断是否需要介入
   * @param {Object} context - 上下文对象
   * @param {string} senderType - 发送者类型
   * @param {string} messageType - 消息类型
   * @returns {Object} { shouldIntervene, reason, priority, suggestion }
   */
  shouldIntervene(context, senderType, messageType) {
    // 实现逻辑
  }

  /**
   * 分析回复质量
   * @param {string} reply - 回复内容
   * @returns {number} 质量分数 (0-100)
   */
  analyzeReplyQuality(reply) {
    // 实现逻辑
  }
}
```

---

**Day 7: 集成到消息处理服务**

**任务清单：**
- [ ] 修改 `message-processing.service.js`
- [ ] 集成消息类型识别
- [ ] 集成工作人员介入判断
- [ ] 保存消息类型到数据库
- [ ] 保存介入信息到数据库
- [ ] 编写集成测试
- [ ] 手动测试

---

#### Week 2: Day 8-9 (完善协同分析)

**任务清单：**
- [ ] 完善 `collaboration.service.js`
- [ ] 实现工作人员活跃度分析
- [ ] 实现用户满意度分析
- [ ] 实现人工介入分析
- [ ] 实现协同效果分析
- [ ] 编写单元测试
- [ ] 集成测试

---

#### Week 2: Day 10-12 (后端API开发)

**任务清单：**
- [ ] 创建 `message-type-identification.api.js`
- [ ] 修改 `messages.api.js`，返回消息类型
- [ ] 修改 `collab.api.js`，返回详细分析结果
- [ ] 编写API测试
- [ ] 文档化API

---

#### Week 2: Day 13-14 (前端开发和测试)

**任务清单：**
- [ ] 创建 `message-type-badge.tsx` 组件
- [ ] 创建 `intervention-indicator.tsx` 组件
- [ ] 修改 `chat/page.tsx`
- [ ] 修改 `after-sales/page.tsx`
- [ ] 前端测试
- [ ] 集成测试
- [ ] 手动测试

---

### 7.2 阶段2实施步骤 (第3-4周)

#### Week 3: Day 15-16 (数据库升级)

**任务清单：**
- [ ] 设计 `alert_levels` 表结构
- [ ] 编写创建表的SQL脚本
- [ ] 设计 `alert_history` 表新增字段
- [ ] 编写字段添加的SQL脚本
- [ ] 创建相关索引
- [ ] 编写数据迁移脚本
- [ ] 在测试环境执行迁移脚本
- [ ] 验证表结构和数据
- [ ] 编写回滚脚本
- [ ] 文档化迁移过程

---

#### Week 3: Day 17-20 (告警取消和升级服务)

**Day 17-18: 告警取消服务**

**任务清单：**
- [ ] 设计告警取消算法
- [ ] 创建 `alert-cancellation.service.js`
- [ ] 实现5种告警取消条件
- [ ] 实现告警取消检查任务（定时）
- [ ] 编写单元测试
- [ ] 集成测试

**代码框架：**
```javascript
// server/services/alert-cancellation.service.js

class AlertCancellationService {
  /**
   * 检查告警是否应该取消
   * @param {string} alertId - 告警ID
   * @returns {Object} { shouldCancel, reason }
   */
  shouldCancelAlert(alertId) {
    // 实现逻辑
  }

  /**
   * 定时检查告警是否应该取消
   */
  async checkAlertsForCancellation() {
    // 实现逻辑
  }
}
```

---

**Day 19-20: 告警升级服务**

**任务清单：**
- [ ] 设计告警升级算法
- [ ] 创建 `alert-escalation.service.js`
- [ ] 实现4级告警等级提升策略
- [ ] 实现告警升级检查任务（定时）
- [ ] 编写单元测试
- [ ] 集成测试

**代码框架：**
```javascript
// server/services/alert-escalation.service.js

class AlertEscalationService {
  /**
   * 判断是否应该升级告警
   * @param {string} alertId - 告警ID
   * @returns {Object} { shouldEscalate, newLevel, reason }
   */
  shouldEscalateAlert(alertId) {
    // 实现逻辑
  }

  /**
   * 定时检查告警是否应该升级
   */
  async checkAlertsForEscalation() {
    // 实现逻辑
  }
}
```

---

#### Week 3: Day 21 (集成到告警服务)

**任务清单：**
- [ ] 修改 `alert.service.js`
- [ ] 集成告警取消机制
- [ ] 集成告警升级机制
- [ ] 修改 `notification.service.js`
- [ ] 实现多通道通知
- [ ] 编写集成测试

---

#### Week 4: Day 22-23 (后端API开发)

**任务清单：**
- [ ] 创建 `alert-cancel.api.js`
- [ ] 创建 `alert-escalate.api.js`
- [ ] 创建 `alert-levels.api.js`
- [ ] 修改 `alert.api.js`
- [ ] 编写API测试
- [ ] 文档化API

---

#### Week 4: Day 24-25 (前端开发和测试)

**任务清单：**
- [ ] 创建 `alert-level-badge.tsx` 组件
- [ ] 创建 `alert-cancel-modal.tsx` 组件
- [ ] 创建 `alert-escalate-modal.tsx` 组件
- [ ] 修改 `after-sales/page.tsx`
- [ ] 前端测试
- [ ] 集成测试
- [ ] 手动测试

---

### 7.3 阶段3实施步骤 (第5-7周)

#### Week 5: Day 26-27 (数据库升级)

**任务清单：**
- [ ] 设计 `after_sales_tasks` 表新增字段
- [ ] 编写字段添加的SQL脚本
- [ ] 创建相关索引
- [ ] 编写数据迁移脚本
- [ ] 在测试环境执行迁移脚本
- [ ] 验证表结构和数据
- [ ] 编写回滚脚本
- [ ] 文档化迁移过程

---

#### Week 5-6: Day 28-35 (售后服务开发)

**Day 28-30: 售后任务自动分配服务**

**任务清单：**
- [ ] 设计自动分配算法
- [ ] 创建 `after-sales-assignment.service.js`
- [ ] 实现工作负载匹配
- [ ] 实现技能匹配
- [ ] 实现轮询分配
- [ ] 编写单元测试
- [ ] 集成测试

**代码框架：**
```javascript
// server/services/after-sales-assignment.service.js

class AfterSalesAssignmentService {
  /**
   * 自动分配售后任务
   * @param {Object} task - 售后任务
   * @returns {Object} { staffUserId, staffName, assignmentReason }
   */
  autoAssignTask(task) {
    // 实现逻辑
  }
}
```

---

**Day 31-33: 用户响应监控服务**

**任务清单：**
- [ ] 设计用户响应监控算法
- [ ] 创建 `user-response-monitor.service.js`
- [ ] 实现用户响应检测
- [ ] 实现拒绝配合检测
- [ ] 实现超时提醒
- [ ] 编写单元测试
- [ ] 集成测试

**代码框架：**
```javascript
// server/services/user-response-monitor.service.js

class UserResponseMonitorService {
  /**
   * 监控用户响应
   * @param {string} taskId - 售后任务ID
   */
  monitorUserResponse(taskId) {
    // 实现逻辑
  }

  /**
   * 检测用户是否说"在"
   * @param {string} sessionId - 会话ID
   * @returns {boolean}
   */
  detectUserOnline(sessionId) {
    // 实现逻辑
  }
}
```

---

**Day 34-35: 每日售后报告**

**任务清单：**
- [ ] 修改 `collaboration.service.js`
- [ ] 集成用户响应监控
- [ ] 实现每日售后报告生成
- [ ] 设计报告模板
- [ ] 编写单元测试
- [ ] 集成测试

---

#### Week 6: Day 36-38 (后端API开发)

**任务清单：**
- [ ] 创建 `after-sales-assign.api.js`
- [ ] 创建 `user-response.api.js`
- [ ] 创建 `daily-after-sales-report.api.js`
- [ ] 修改 `after-sales-tasks.api.js`
- [ ] 编写API测试
- [ ] 文档化API

---

#### Week 6-7: Day 39-43 (前端页面开发)

**任务清单：**
- [ ] 创建 `after-sales-dashboard/page.tsx`
- [ ] 创建 `after-sales-dashboard.tsx` 组件
- [ ] 创建 `user-response-monitor.tsx` 组件
- [ ] 创建 `daily-after-sales-report.tsx` 组件
- [ ] 修改 `after-sales/page.tsx`
- [ ] 前端测试
- [ ] 集成测试

---

#### Week 7: Day 44-45 (测试)

**任务清单：**
- [ ] 单元测试
- [ ] 集成测试
- [ ] 自动分配测试
- [ ] 用户响应监控测试
- [ ] 手动测试

---

### 7.4 阶段4实施步骤 (第8-9周)

#### Week 8: Day 46-47 (数据库升级)

**任务清单：**
- [ ] 设计 `robot_health` 表结构
- [ ] 编写创建表的SQL脚本
- [ ] 设计 `robots` 表新增字段
- [ ] 编写字段添加的SQL脚本
- [ ] 创建相关索引
- [ ] 编写数据迁移脚本
- [ ] 在测试环境执行迁移脚本
- [ ] 验证表结构和数据
- [ ] 编写回滚脚本
- [ ] 文档化迁移过程

---

#### Week 8: Day 48-51 (机器人监控服务)

**Day 48-49: 机器人健康监控服务**

**任务清单：**
- [ ] 设计机器人健康监控算法
- [ ] 创建 `robot-health-monitor.service.js`
- [ ] 实现机器人健康检查
- [ ] 实现健康分数计算
- [ ] 实现改进建议生成
- [ ] 编写单元测试
- [ ] 集成测试

**代码框架：**
```javascript
// server/services/robot-health-monitor.service.js

class RobotHealthMonitorService {
  /**
   * 检查机器人健康状态
   * @param {string} robotId - 机器人ID
   * @returns {Object} { healthScore, healthStatus, recommendations }
   */
  checkRobotHealth(robotId) {
    // 实现逻辑
  }

  /**
   * 定时检查所有机器人健康状态
   */
  async checkAllRobotsHealth() {
    // 实现逻辑
  }
}
```

---

**Day 50-51: 通讯状态监控服务**

**任务清单：**
- [ ] 设计通讯状态监控算法
- [ ] 创建 `command-status-monitor.service.js`
- [ ] 实现60秒超时检查
- [ ] 实现执行结果处理
- [ ] 编写单元测试
- [ ] 集成测试

**代码框架：**
```javascript
// server/services/command-status-monitor.service.js

class CommandStatusMonitorService {
  /**
   * 监控通讯状态
   * @param {string} commandId - 指令ID
   */
  monitorCommandStatus(commandId) {
    // 实现逻辑
  }

  /**
   * 定时检查所有待确认的指令状态
   */
  async checkPendingCommands() {
    // 实现逻辑
  }
}
```

---

#### Week 8: Day 52-53 (后端API开发)

**任务清单：**
- [ ] 创建 `robot-health.api.js`
- [ ] 创建 `command-status.api.js`
- [ ] 创建 `sessions/:sessionId.api.js`
- [ ] 创建 `groups/:groupId/sessions.api.js`
- [ ] 编写API测试
- [ ] 文档化API

---

#### Week 8-9: Day 54-60 (前端页面开发)

**任务清单：**
- [ ] 创建 `sessions/[sessionId]/page.tsx`
- [ ] 创建 `groups/[groupId]/page.tsx`
- [ ] 创建 `session-detail-view.tsx` 组件
- [ ] 创建 `session-list-view.tsx` 组件
- [ ] 创建 `robot-health-card.tsx` 组件
- [ ] 修改 `page.tsx`
- [ ] 前端测试
- [ ] 集成测试
- [ ] 页面性能测试

---

#### Week 9: Day 61-62 (测试和优化)

**任务清单：**
- [ ] 单元测试
- [ ] 集成测试
- [ ] 性能测试
- [ ] 压力测试
- [ ] 手动测试
- [ ] Bug修复
- [ ] 性能优化

---

## 8. 数据库升级方案

### 8.1 数据库迁移脚本

#### 迁移001：消息类型识别

**文件路径：** `server/database/migrations/001_add_message_types.sql`

```sql
-- ============================================
-- 迁移001：添加消息类型识别功能
-- ============================================

-- 1. 创建消息类型配置表
CREATE TABLE IF NOT EXISTS message_types (
  id VARCHAR(36) PRIMARY KEY DEFAULT gen_random_uuid(),
  type_code VARCHAR(50) NOT NULL UNIQUE,
  type_name VARCHAR(100) NOT NULL,
  category VARCHAR(50) NOT NULL, -- user | staff | operator | robot
  description TEXT,
  is_enabled BOOLEAN NOT NULL DEFAULT true,
  priority INTEGER NOT NULL DEFAULT 5,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL
);

-- 创建索引
CREATE INDEX message_types_type_code_idx ON message_types(type_code);
CREATE INDEX message_types_category_idx ON message_types(category);
CREATE INDEX message_types_is_enabled_idx ON message_types(is_enabled);

-- 2. 插入预置消息类型

-- 用户消息类型
INSERT INTO message_types (type_code, type_name, category, description, priority) VALUES
('chat_daily', '日常聊天', 'user', '日常聊天、问候、日常交流', 5),
('chat_after_sales', '售后任务', 'user', '需要扫码、绑定、认证等售后任务', 1),
('chat_complaint', '用户投诉', 'user', '不满意、抱怨、怀疑', 1),
('chat_private_operation', '号主私自操作', 'user', '添加商品、删除作品、自己发布作品', 1),
('chat_cooperation', '需要配合', 'user', '发作品、自拍视频', 3),
('chat_complain_discuss', '闲聊抱怨', 'user', '号主之间闲聊、抱怨、怀疑', 4),
('chat_other', '其他', 'user', '其他用户消息', 10);

-- 工作人员消息类型
INSERT INTO message_types (type_code, type_name, category, description, priority) VALUES
('staff_reply_user', '回复用户', 'staff', '回复号主的疑虑或问题', 3),
('staff_at_user', '@用户', 'staff', '@号主进行售后任务或提醒', 1),
('staff_ask_user', '询问号主', 'staff', '询问号主情况', 3),
('staff_other', '其他', 'staff', '其他工作人员消息', 10);

-- 运营消息类型
INSERT INTO message_types (type_code, type_name, category, description, priority) VALUES
('operator_assign_user', '安排号主', 'operator', '安排号主配合工作', 2),
('operator_tone_hard', '语气硬', 'operator', '语气强硬，可能影响号主配合度', 1),
('operator_other', '其他', 'operator', '其他运营消息', 10);

-- 3. 修改session_messages表，添加消息类型字段
ALTER TABLE session_messages
ADD COLUMN IF NOT EXISTS message_type VARCHAR(50),
ADD COLUMN IF NOT EXISTS is_staff_intervention BOOLEAN DEFAULT false,
ADD COLUMN IF NOT EXISTS intervention_reason VARCHAR(255);

-- 创建索引
CREATE INDEX session_messages_message_type_idx ON session_messages(message_type);
CREATE INDEX session_messages_is_staff_intervention_idx ON session_messages(is_staff_intervention);

-- 4. 数据迁移（为现有消息设置默认消息类型）
UPDATE session_messages
SET message_type = 'chat_other'
WHERE message_type IS NULL;

-- 5. 添加外键约束
ALTER TABLE session_messages
ADD CONSTRAINT fk_message_type
FOREIGN KEY (message_type) REFERENCES message_types(type_code)
ON DELETE SET NULL;

-- 迁移完成记录
INSERT INTO migration_history (version, description, executed_at)
VALUES ('001_add_message_types', '添加消息类型识别功能', NOW())
ON CONFLICT (version) DO NOTHING;
```

---

**回滚脚本：** `server/database/migrations/rollback_001_add_message_types.sql`

```sql
-- ============================================
-- 回滚001：删除消息类型识别功能
-- ============================================

-- 1. 删除外键约束
ALTER TABLE session_messages
DROP CONSTRAINT IF EXISTS fk_message_type;

-- 2. 删除索引
DROP INDEX IF EXISTS session_messages_message_type_idx;
DROP INDEX IF EXISTS session_messages_is_staff_intervention_idx;

-- 3. 删除字段
ALTER TABLE session_messages
DROP COLUMN IF EXISTS message_type,
DROP COLUMN IF EXISTS is_staff_intervention,
DROP COLUMN IF EXISTS intervention_reason;

-- 4. 删除索引
DROP INDEX IF EXISTS message_types_type_code_idx;
DROP INDEX IF EXISTS message_types_category_idx;
DROP INDEX IF EXISTS message_types_is_enabled_idx;

-- 5. 删除表
DROP TABLE IF EXISTS message_types;

-- 回滚完成记录
DELETE FROM migration_history WHERE version = '001_add_message_types';
```

---

#### 迁移002：告警级别和取消

**文件路径：** `server/database/migrations/002_add_alert_levels.sql`

```sql
-- ============================================
-- 迁移002：添加告警级别和取消功能
-- ============================================

-- 1. 创建告警级别配置表
CREATE TABLE IF NOT EXISTS alert_levels (
  id VARCHAR(36) PRIMARY KEY DEFAULT gen_random_uuid(),
  level_code VARCHAR(20) NOT NULL UNIQUE,
  level_name VARCHAR(50) NOT NULL,
  level_value INTEGER NOT NULL UNIQUE,
  color VARCHAR(20) NOT NULL,
  notification_methods TEXT[], -- 通知方式数组
  notification_targets TEXT[], -- 通知对象数组
  description TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL
);

-- 创建索引
CREATE INDEX alert_levels_level_code_idx ON alert_levels(level_code);
CREATE INDEX alert_levels_level_value_idx ON alert_levels(level_value);

-- 2. 插入预置告警级别
INSERT INTO alert_levels (level_code, level_name, level_value, color, notification_methods, notification_targets, description) VALUES
('level_1', '信息告警', 1, 'green', ARRAY['wechat'], ARRAY['staff'], '首次告警，企业微信通知相关人员'),
('level_2', '警告告警', 2, 'yellow', ARRAY['wechat', 'reminder'], ARRAY['staff', 'supervisor'], '30分钟内再次告警，企业微信+提醒'),
('level_3', '严重告警', 3, 'orange', ARRAY['wechat', 'phone'], ARRAY['staff', 'supervisor', 'manager'], '60分钟内再次告警，企业微信+电话'),
('level_4', '紧急告警', 4, 'red', ARRAY['wechat', 'phone', 'sms'], ARRAY['all', 'manager'], '90分钟内再次告警，企业微信+电话+短信');

-- 3. 修改alert_history表，添加告警级别和取消字段
ALTER TABLE alert_history
ADD COLUMN IF NOT EXISTS alert_level INTEGER DEFAULT 1,
ADD COLUMN IF NOT EXISTS cancel_reason VARCHAR(255),
ADD COLUMN IF NOT EXISTS cancelled_at TIMESTAMP WITH TIME ZONE,
ADD COLUMN IF NOT EXISTS escalation_count INTEGER DEFAULT 0,
ADD COLUMN IF NOT EXISTS escalation_history JSONB DEFAULT '[]';

-- 创建索引
CREATE INDEX alert_history_alert_level_idx ON alert_history(alert_level);
CREATE INDEX alert_history_cancelled_at_idx ON alert_history(cancelled_at);

-- 4. 数据迁移（为现有告警设置默认告警级别）
UPDATE alert_history
SET alert_level = 1
WHERE alert_level IS NULL;

-- 5. 添加外键约束
ALTER TABLE alert_history
ADD CONSTRAINT fk_alert_level
FOREIGN KEY (alert_level) REFERENCES alert_levels(level_value)
ON DELETE SET NULL;

-- 迁移完成记录
INSERT INTO migration_history (version, description, executed_at)
VALUES ('002_add_alert_levels', '添加告警级别和取消功能', NOW())
ON CONFLICT (version) DO NOTHING;
```

---

**回滚脚本：** `server/database/migrations/rollback_002_add_alert_levels.sql`

```sql
-- ============================================
-- 回滚002：删除告警级别和取消功能
-- ============================================

-- 1. 删除外键约束
ALTER TABLE alert_history
DROP CONSTRAINT IF EXISTS fk_alert_level;

-- 2. 删除索引
DROP INDEX IF EXISTS alert_history_alert_level_idx;
DROP INDEX IF EXISTS alert_history_cancelled_at_idx;

-- 3. 删除字段
ALTER TABLE alert_history
DROP COLUMN IF EXISTS alert_level,
DROP COLUMN IF EXISTS cancel_reason,
DROP COLUMN IF EXISTS cancelled_at,
DROP COLUMN IF EXISTS escalation_count,
DROP COLUMN IF EXISTS escalation_history;

-- 4. 删除索引
DROP INDEX IF EXISTS alert_levels_level_code_idx;
DROP INDEX IF EXISTS alert_levels_level_value_idx;

-- 5. 删除表
DROP TABLE IF EXISTS alert_levels;

-- 回滚完成记录
DELETE FROM migration_history WHERE version = '002_add_alert_levels';
```

---

#### 迁移003：售后任务增强

**文件路径：** `server/database/migrations/003_enhance_after_sales_tasks.sql`

```sql
-- ============================================
-- 迁移003：增强售后任务功能
-- ============================================

-- 1. 修改after_sales_tasks表，添加自动分配和用户响应字段
ALTER TABLE after_sales_tasks
ADD COLUMN IF NOT EXISTS auto_assigned_by VARCHAR(36),
ADD COLUMN IF NOT EXISTS auto_assigned_at TIMESTAMP WITH TIME ZONE,
ADD COLUMN IF NOT EXISTS user_response_status VARCHAR(20) DEFAULT 'pending', -- pending | responded | refused | timeout
ADD COLUMN IF NOT EXISTS user_response_time TIMESTAMP WITH TIME ZONE,
ADD COLUMN IF NOT EXISTS user_cooperation_level VARCHAR(10) DEFAULT 'unknown', -- high | medium | low | unknown
ADD COLUMN IF NOT EXISTS staff_at_user_time TIMESTAMP WITH TIME ZONE,
ADD COLUMN IF NOT EXISTS staff_follow_up_time TIMESTAMP WITH TIME ZONE;

-- 创建索引
CREATE INDEX after_sales_tasks_user_response_status_idx ON after_sales_tasks(user_response_status);
CREATE INDEX after_sales_tasks_user_cooperation_level_idx ON after_sales_tasks(user_cooperation_level);
CREATE INDEX after_sales_tasks_auto_assigned_by_idx ON after_sales_tasks(auto_assigned_by);

-- 迁移完成记录
INSERT INTO migration_history (version, description, executed_at)
VALUES ('003_enhance_after_sales_tasks', '增强售后任务功能', NOW())
ON CONFLICT (version) DO NOTHING;
```

---

**回滚脚本：** `server/database/migrations/rollback_003_enhance_after_sales_tasks.sql`

```sql
-- ============================================
-- 回滚003：删除售后任务增强功能
-- ============================================

-- 1. 删除索引
DROP INDEX IF EXISTS after_sales_tasks_user_response_status_idx;
DROP INDEX IF EXISTS after_sales_tasks_user_cooperation_level_idx;
DROP INDEX IF EXISTS after_sales_tasks_auto_assigned_by_idx;

-- 2. 删除字段
ALTER TABLE after_sales_tasks
DROP COLUMN IF EXISTS auto_assigned_by,
DROP COLUMN IF EXISTS auto_assigned_at,
DROP COLUMN IF EXISTS user_response_status,
DROP COLUMN IF EXISTS user_response_time,
DROP COLUMN IF EXISTS user_cooperation_level,
DROP COLUMN IF EXISTS staff_at_user_time,
DROP COLUMN IF EXISTS staff_follow_up_time;

-- 回滚完成记录
DELETE FROM migration_history WHERE version = '003_enhance_after_sales_tasks';
```

---

#### 迁移004：机器人健康监控

**文件路径：** `server/database/migrations/004_add_robot_health.sql`

```sql
-- ============================================
-- 迁移004：添加机器人健康监控功能
-- ============================================

-- 1. 创建机器人健康状态表
CREATE TABLE IF NOT EXISTS robot_health (
  id VARCHAR(36) PRIMARY KEY DEFAULT gen_random_uuid(),
  robot_id VARCHAR(255) NOT NULL UNIQUE,
  health_score INTEGER NOT NULL DEFAULT 100, -- 0-100
  health_status VARCHAR(20) NOT NULL DEFAULT 'excellent', -- excellent | good | warning | critical
  last_health_check TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,
  message_count INTEGER NOT NULL DEFAULT 0,
  error_count INTEGER NOT NULL DEFAULT 0,
  success_rate DECIMAL(5, 2) DEFAULT 100.00,
  average_response_time INTEGER DEFAULT 0, -- 毫秒
  recommendations JSONB DEFAULT '[]',
  history JSONB DEFAULT '[]',
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL
);

-- 创建索引
CREATE INDEX robot_health_robot_id_idx ON robot_health(robot_id);
CREATE INDEX robot_health_health_status_idx ON robot_health(health_status);
CREATE INDEX robot_health_health_score_idx ON robot_health(health_score);

-- 2. 修改robots表，添加健康字段
ALTER TABLE robots
ADD COLUMN IF NOT EXISTS health_score INTEGER DEFAULT 100,
ADD COLUMN IF NOT EXISTS health_status VARCHAR(20) DEFAULT 'excellent',
ADD COLUMN IF NOT EXISTS last_health_check TIMESTAMP WITH TIME ZONE,
ADD COLUMN IF NOT EXISTS recommendations JSONB DEFAULT '[]';

-- 创建索引
CREATE INDEX robots_health_status_idx ON robots(health_status);
CREATE INDEX robots_health_score_idx ON robots(health_score);

-- 迁移完成记录
INSERT INTO migration_history (version, description, executed_at)
VALUES ('004_add_robot_health', '添加机器人健康监控功能', NOW())
ON CONFLICT (version) DO NOTHING;
```

---

**回滚脚本：** `server/database/migrations/rollback_004_add_robot_health.sql`

```sql
-- ============================================
-- 回滚004：删除机器人健康监控功能
-- ============================================

-- 1. 删除索引
DROP INDEX IF EXISTS robots_health_status_idx;
DROP INDEX IF EXISTS robots_health_score_idx;

-- 2. 删除字段
ALTER TABLE robots
DROP COLUMN IF EXISTS health_score,
DROP COLUMN IF EXISTS health_status,
DROP COLUMN IF EXISTS last_health_check,
DROP COLUMN IF EXISTS recommendations;

-- 3. 删除索引
DROP INDEX IF EXISTS robot_health_robot_id_idx;
DROP INDEX IF EXISTS robot_health_health_status_idx;
DROP INDEX IF EXISTS robot_health_health_score_idx;

-- 4. 删除表
DROP TABLE IF EXISTS robot_health;

-- 回滚完成记录
DELETE FROM migration_history WHERE version = '004_add_robot_health';
```

---

### 8.2 数据库迁移执行流程

#### 执行前准备

1. **备份数据库**
```bash
# 创建备份
pg_dump -h localhost -U postgres -d worktool_ai > backup_$(date +%Y%m%d_%H%M%S).sql

# 验证备份
ls -lh backup_*.sql
```

2. **检查迁移脚本**
```bash
# 语法检查
psql -h localhost -U postgres -d worktool_ai -f server/database/migrations/001_add_message_types.sql --dry-run

# 查看迁移计划
psql -h localhost -U postgres -d worktool_ai -c "SELECT * FROM migration_history ORDER BY executed_at DESC LIMIT 5;"
```

3. **准备回滚脚本**
```bash
# 确认回滚脚本存在
ls -l server/database/migrations/rollback_*.sql
```

---

#### 执行迁移

```bash
# 方式1：逐个执行（推荐）
psql -h localhost -U postgres -d worktool_ai -f server/database/migrations/001_add_message_types.sql
psql -h localhost -U postgres -d worktool_ai -f server/database/migrations/002_add_alert_levels.sql
psql -h localhost -U postgres -d worktool_ai -f server/database/migrations/003_enhance_after_sales_tasks.sql
psql -h localhost -U postgres -d worktool_ai -f server/database/migrations/004_add_robot_health.sql

# 方式2：批量执行（谨慎使用）
for file in server/database/migrations/*.sql; do
  echo "Executing: $file"
  psql -h localhost -U postgres -d worktool_ai -f "$file"
done
```

---

#### 验证迁移

```bash
# 检查迁移历史
psql -h localhost -U postgres -d worktool_ai -c "SELECT * FROM migration_history ORDER BY executed_at;"

# 检查表结构
psql -h localhost -U postgres -d worktool_ai -c "\d message_types"
psql -h localhost -U postgres -d worktool_ai -c "\d alert_levels"
psql -h localhost -U postgres -d worktool_ai -c "\d robot_health"

# 检查索引
psql -h localhost -U postgres -d worktool_ai -c "SELECT indexname, tablename FROM pg_indexes WHERE tablename IN ('message_types', 'alert_levels', 'robot_health');"

# 检查数据
psql -h localhost -U postgres -d worktool_ai -c "SELECT * FROM message_types LIMIT 5;"
psql -h localhost -U postgres -d worktool_ai -c "SELECT * FROM alert_levels LIMIT 5;"
```

---

#### 回滚流程

```bash
# 如果迁移失败，执行回滚
psql -h localhost -U postgres -d worktool_ai -f server/database/migrations/rollback_001_add_message_types.sql
psql -h localhost -U postgres -d worktool_ai -f server/database/migrations/rollback_002_add_alert_levels.sql
psql -h localhost -U postgres -d worktool_ai -f server/database/migrations/rollback_003_enhance_after_sales_tasks.sql
psql -h localhost -U postgres -d worktool_ai -f server/database/migrations/rollback_004_add_robot_health.sql

# 恢复备份（如果回滚失败）
psql -h localhost -U postgres -d worktool_ai < backup_YYYYMMDD_HHMMSS.sql
```

---

## 9. 后端API升级方案

### 9.1 新增API端点清单

#### 消息类型识别API

**端点1：获取消息类型列表**
```http
GET /api/messages/types
```

**响应示例：**
```json
{
  "code": 0,
  "message": "获取成功",
  "data": [
    {
      "type_code": "chat_daily",
      "type_name": "日常聊天",
      "category": "user",
      "description": "日常聊天、问候、日常交流",
      "priority": 5
    },
    {
      "type_code": "chat_after_sales",
      "type_name": "售后任务",
      "category": "user",
      "description": "需要扫码、绑定、认证等售后任务",
      "priority": 1
    }
  ]
}
```

**实现文件：** `server/routes/message-type-identification.api.js`

---

**端点2：识别消息类型**
```http
POST /api/messages/identify-type
```

**请求体：**
```json
{
  "message": "我无法认证视频号",
  "context": [
    {"role": "user", "content": "我的视频号发不了作品"},
    {"role": "assistant", "content": "需要扫码认证吗？"}
  ]
}
```

**响应示例：**
```json
{
  "code": 0,
  "message": "识别成功",
  "data": {
    "type": "chat_after_sales",
    "type_name": "售后任务",
    "confidence": 0.92,
    "reason": "用户反馈无法认证，属于售后任务"
  }
}
```

---

#### 告警取消和升级API

**端点3：取消告警**
```http
POST /api/alerts/:alertId/cancel
```

**请求体：**
```json
{
  "cancel_reason": "工作人员已介入处理",
  "cancelled_by": "staff_001"
}
```

**响应示例：**
```json
{
  "code": 0,
  "message": "告警已取消",
  "data": {
    "alert_id": "alert_001",
    "cancelled_at": "2026-02-10T10:30:00Z",
    "cancel_reason": "工作人员已介入处理",
    "status": "cancelled"
  }
}
```

**实现文件：** `server/routes/alert-cancellation.api.js`

---

**端点4：升级告警**
```http
POST /api/alerts/:alertId/escalate
```

**请求体：**
```json
{
  "escalate_to": 3,
  "escalate_reason": "用户未响应，需要升级处理"
}
```

**响应示例：**
```json
{
  "code": 0,
  "message": "告警已升级",
  "data": {
    "alert_id": "alert_001",
    "old_level": 2,
    "new_level": 3,
    "escalation_count": 1,
    "escalated_at": "2026-02-10T10:30:00Z",
    "notification_sent": true
  }
}
```

**实现文件：** `server/routes/alert-escalation.api.js`

---

#### 售后任务自动分配API

**端点5：自动分配售后任务**
```http
POST /api/after-sales/auto-assign
```

**请求体：**
```json
{
  "task_id": "task_001",
  "task_type": "扫码视频认证",
  "priority": "high",
  "session_id": "session_001"
}
```

**响应示例：**
```json
{
  "code": 0,
  "message": "自动分配成功",
  "data": {
    "task_id": "task_001",
    "assigned_staff": {
      "staff_user_id": "staff_001",
      "staff_name": "售后A",
      "current_tasks": 2
    },
    "assignment_reason": "技能匹配（扫码认证）+ 工作负载最少",
    "assigned_at": "2026-02-10T10:30:00Z"
  }
}
```

**实现文件：** `server/routes/after-sales-assignment.api.js`

---

#### 机器人健康监控API

**端点6：获取机器人健康状态**
```http
GET /api/robots/:robotId/health
```

**响应示例：**
```json
{
  "code": 0,
  "message": "获取成功",
  "data": {
    "robot_id": "robot_001",
    "robot_name": "白班回复机器人",
    "health_score": 85,
    "health_status": "good",
    "last_health_check": "2026-02-10T10:25:00Z",
    "message_count": 150,
    "error_count": 5,
    "success_rate": 96.67,
    "average_response_time": 450,
    "recommendations": [
      "优化响应速度",
      "检查网络连接"
    ]
  }
}
```

**实现文件：** `server/routes/robot-health.api.js`

---

### 9.2 API开发规范

#### 命名规范

- **路由文件名**：`kebab-case` (如 `message-type-identification.api.js`)
- **API端点**：`kebab-case` (如 `/api/messages/identify-type`)
- **服务文件名**：`kebab-case` (如 `message-type-identification.service.js`)
- **数据库表名**：`snake_case` (如 `message_types`)
- **数据库字段名**：`snake_case` (如 `message_type`)

#### 响应格式规范

```javascript
// 成功响应
{
  "code": 0,
  "message": "操作成功",
  "data": { /* 返回数据 */ }
}

// 失败响应
{
  "code": -1,
  "message": "操作失败",
  "error": "详细错误信息",
  "data": null
}
```

#### 错误处理规范

```javascript
try {
  // 业务逻辑
  const result = await someService.doSomething();
  return { code: 0, message: "操作成功", data: result };
} catch (error) {
  console.error('[API] Error:', error);
  return {
    code: -1,
    message: "操作失败",
    error: error.message,
    data: null
  };
}
```

---

## 10. 前端页面升级方案

### 10.1 新增页面清单

#### 页面1：用户会话详情页

**文件路径：** `src/app/sessions/[sessionId]/page.tsx`

**功能：**
- 显示用户基本信息
- 显示会话消息列表
- 显示消息类型标识
- 显示工作人员介入标识
- 显示协同分析结果
- 支持导出会话记录

**UI布局：**
```
┌─────────────────────────────────────────────────────────────┐
│  ← 返回 | 用户会话详情                                       │
├─────────────────────────────────────────────────────────────┤
│  用户信息                                                    │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │ 用户ID: user_001                                         │ │
│  │ 用户名: 张三                                             │ │
│  │ 企业: 示例企业                                           │ │
│  │ 群聊: 群1                                               │ │
│  └─────────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────────┤
│  协同分析                                                    │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │ 满意度: 85% | 介入次数: 2 | 协同率: 70%               │ │
│  └─────────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────────┤
│  消息列表                                                    │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │ [用户] 日常聊天: 大家好                                  │ │
│  │ [机器人] 回复: 欢迎大家                                  │ │
│  │ [用户] 售后任务: 我无法认证                              │ │
│  │ [工作人员] @张三 请扫码认证                              │ │
│  │ [用户] 在                                               │ │
│  └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

---

#### 页面2：售后实时监控大屏

**文件路径：** `src/app/after-sales/dashboard/page.tsx`

**功能：**
- 显示核心指标（待处理、处理中、今日完成、满意度）
- 显示任务列表
- 显示用户状态
- 显示售后人员状态
- 显示实时提醒
- 自动刷新（每5秒）

**UI布局：**
```
┌─────────────────────────────────────────────────────────────┐
│                    售后实时监控大屏                            │
├─────────────────────────────────────────────────────────────┤
│  核心指标                                                    │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐        │
│  │ 待处理:12│ │ 处理中:5 │ │ 今日:28  │ │ 满意:87% │        │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘        │
├─────────────────────────────────────────────────────────────┤
│  任务列表                  │  用户状态                        │
│  ┌─────────────────────┐   │ ┌─────────────────────┐        │
│  │ 任务ID │ 类型│状态  │   │ │ 用户   │状态│响应  │        │
│  │ task_001│扫码 │pending│   │ │ 张三   │在线 │已响应 │        │
│  │ task_002│认证 │in_pro│   │ │ 李四   │离线 │未响应 │        │
│  └─────────────────────┘   │ └─────────────────────┘        │
├─────────────────────────────┤                                  │
│  售后人员状态                │  实时提醒                       │
│  ┌─────────────────────┐   │ ┌─────────────────────┐        │
│  │ 人员  │任务│效率 │   │ │ ⚠️ 群1 张三说"在"  │        │
│  │ 售后A │3  │92分 │   │ │ ⚠️ 群2 李四未响应  │        │
│  │ 售后B │2  │88分 │   │ │ ⚠️ task_004 快超时 │        │
│  └─────────────────────┘   │ └─────────────────────┘        │
└─────────────────────────────────────────────────────────────┘
```

---

### 10.2 新增组件清单

#### 组件1：消息类型徽章

**文件路径：** `src/components/message-type-badge.tsx`

**功能：**
- 显示消息类型
- 根据类型显示不同颜色
- 显示优先级

**使用示例：**
```tsx
<MessageTypeBadge type="chat_after_sales" priority={1} />
// 显示: [售后任务] (红色)
```

---

#### 组件2：告警级别徽章

**文件路径：** `src/components/alert-level-badge.tsx`

**功能：**
- 显示告警级别
- 根据级别显示不同颜色
- 显示升级次数

**使用示例：**
```tsx
<AlertLevelBadge level={3} escalationCount={1} />
// 显示: [严重告警] (橙色)
```

---

#### 组件3：售后监控大屏组件

**文件路径：** `src/components/after-sales-dashboard.tsx`

**功能：**
- 显示核心指标
- 显示任务列表
- 显示用户状态
- 显示售后人员状态
- 显示实时提醒
- 自动刷新

**使用示例：**
```tsx
<AfterSalesDashboard
  refreshInterval={5000}
  onTaskClick={(task) => console.log(task)}
  onStaffClick={(staff) => console.log(staff)}
/>
```

---

### 10.3 前端开发规范

#### 组件命名规范
- 文件名：`PascalCase` (如 `MessageTypeBadge.tsx`)
- 组件名：`PascalCase` (如 `MessageTypeBadge`)
- Props：`camelCase` (如 `messageType`, `priority`)

#### 样式规范
- 使用 Tailwind CSS
- 使用 shadcn/ui 组件
- 响应式设计（mobile-first）

#### 状态管理规范
- 使用 React Hooks (useState, useEffect)
- 使用自定义 Hooks (useSSE, useAfterSalesSSE)
- 避免过度使用全局状态

---

## 11. 测试计划

### 11.1 测试类型

#### 单元测试

**目标：**
- 测试每个服务的独立功能
- 测试边界条件
- 测试错误处理

**工具：**
- Jest
- Supertest (API测试)

**覆盖率目标：**
- 核心服务：> 80%
- 一般服务：> 60%

---

#### 集成测试

**目标：**
- 测试服务之间的交互
- 测试API端点
- 测试数据库操作

**工具：**
- Jest
- Supertest
- Testcontainers (数据库)

---

#### 端到端测试

**目标：**
- 测试完整的用户流程
- 测试前端和后端的集成
- 测试关键业务场景

**工具：**
- Playwright
- Cypress

**测试场景：**
1. 用户发送消息 → AI回复
2. 工作人员发送消息 → 不触发AI回复
3. 告警创建 → 通知 → 取消
4. 售后任务创建 → 自动分配 → 用户响应监控
5. 机器人健康检查 → 状态更新

---

#### 性能测试

**目标：**
- 测试系统在高并发下的表现
- 测试响应时间
- 测试资源占用

**工具：**
- k6
- JMeter

**测试指标：**
- 响应时间 < 300ms (平均)
- 并发处理能力 > 500 qps
- CPU使用率 < 80%
- 内存使用率 < 80%

---

### 11.2 测试执行计划

#### 阶段1测试（第2周末）

**测试范围：**
- 消息类型识别服务
- 工作人员介入判断服务
- 消息处理服务集成

**测试用例：**
- [ ] 消息类型识别准确率测试
- [ ] 工作人员介入判断准确率测试
- [ ] 协同分析完整性测试
- [ ] API端点测试
- [ ] 前端组件渲染测试

---

#### 阶段2测试（第4周末）

**测试范围：**
- 告警取消服务
- 告警升级服务
- 告警服务集成

**测试用例：**
- [ ] 告警取消准确率测试
- [ ] 告警升级准确率测试
- [ ] 告警通知送达率测试
- [ ] API端点测试
- [ ] 前端组件交互测试

---

#### 阶段3测试（第7周末）

**测试范围：**
- 售后任务自动分配服务
- 用户响应监控服务
- 每日售后报告生成

**测试用例：**
- [ ] 售后任务自动分配准确率测试
- [ ] 用户响应监控准确率测试
- [ ] 售后报告生成成功率测试
- [ ] API端点测试
- [ ] 前端页面渲染测试
- [ ] 实时监控大屏测试

---

#### 阶段4测试（第9周末）

**测试范围：**
- 机器人健康监控服务
- 通讯状态监控服务
- 所有新增页面和组件

**测试用例：**
- [ ] 机器人健康监控覆盖率测试
- [ ] 智能选择策略准确率测试
- [ ] 通讯状态监控测试
- [ ] API端点测试
- [ ] 页面性能测试
- [ ] 端到端测试

---

## 12. 上线计划

### 12.1 上线策略

采用**灰度发布**策略，逐步推进：

1. **测试环境验证**（1周）
2. **预发布环境验证**（3天）
3. **灰度发布**（5% → 20% → 50% → 100%）
4. **全量发布**

---

### 12.2 上线时间表

| 日期 | 阶段 | 内容 | 负责人 |
|------|------|------|--------|
| 第9周末 | 测试环境验证 | 所有测试通过 | 测试团队 |
| 第10周初 | 预发布环境验证 | 验证所有功能 | 开发+测试 |
| 第10周中 | 灰度发布5% | 部分用户使用 | 运维+产品 |
| 第10周中 | 灰度发布20% | 扩大范围 | 运维+产品 |
| 第10周中 | 灰度发布50% | 大部分用户 | 运维+产品 |
| 第10周末 | 全量发布 | 所有用户 | 运维 |

---

### 12.3 上线前检查清单

#### 数据库检查
- [ ] 数据库备份完成
- [ ] 迁移脚本执行成功
- [ ] 数据验证通过
- [ ] 回滚脚本准备完毕

#### 代码检查
- [ ] 所有代码合并到主分支
- [ ] 代码审查通过
- [ ] 单元测试通过
- [ ] 集成测试通过
- [ ] 端到端测试通过

#### 环境检查
- [ ] 测试环境配置正确
- [ ] 预发布环境配置正确
- [ ] 生产环境配置正确
- [ ] 环境变量配置正确

#### 监控检查
- [ ] 监控系统部署完成
- [ ] 告警规则配置完成
- [ ] 日志系统配置完成
- [ ] 性能监控配置完成

#### 文档检查
- [ ] API文档更新完成
- [ ] 用户手册更新完成
- [ ] 运维文档更新完成
- [ ] 上线方案文档完成

---

## 13. 回滚计划

### 13.1 回滚触发条件

发生以下情况之一，立即回滚：

1. **数据丢失或损坏**
2. **核心功能不可用**
3. **严重性能问题（响应时间 > 5秒）**
4. **大量用户投诉**
5. **系统崩溃**
6. **安全问题**

---

### 13.2 回滚流程

#### 立即回滚（5分钟内）

```bash
# 1. 停止服务
coze stop

# 2. 回滚代码
git revert <commit_hash>

# 3. 回滚数据库
psql -h localhost -U postgres -d worktool_ai -f server/database/migrations/rollback_004_add_robot_health.sql
psql -h localhost -U postgres -d worktool_ai -f server/database/migrations/rollback_003_enhance_after_sales_tasks.sql
psql -h localhost -U postgres -d worktool_ai -f server/database/migrations/rollback_002_add_alert_levels.sql
psql -h localhost -U postgres -d worktool_ai -f server/database/migrations/rollback_001_add_message_types.sql

# 4. 重启服务
coze start

# 5. 验证服务
curl -I http://localhost:5000
```

---

#### 数据恢复（如果回滚失败）

```bash
# 恢复数据库备份
psql -h localhost -U postgres -d worktool_ai < backup_YYYYMMDD_HHMMSS.sql

# 重启服务
coze restart
```

---

### 13.3 回滚后处理

1. **通知相关人员**
2. **记录回滚原因**
3. **分析问题原因**
4. **修复问题**
5. **重新测试**
6. **重新上线**

---

## 14. 验收标准

### 14.1 功能验收标准

#### 阶段1验收标准

- ✅ 消息类型识别准确率 > 90%
- ✅ 工作人员介入判断准确率 > 85%
- ✅ 协同分析覆盖所有关键指标
- ✅ 所有测试用例通过
- ✅ 用户满意度 > 85%

---

#### 阶段2验收标准

- ✅ 告警取消准确率 > 95%
- ✅ 告警等级提升准确率 > 90%
- ✅ 告警通知送达率 > 99%
- ✅ 所有测试用例通过
- ✅ 用户满意度 > 85%

---

#### 阶段3验收标准

- ✅ 售后任务自动分配准确率 > 85%
- ✅ 用户响应监控准确率 > 90%
- ✅ 售后报告生成成功率 > 99%
- ✅ 所有测试用例通过
- ✅ 用户满意度 > 85%

---

#### 阶段4验收标准

- ✅ 机器人健康监控覆盖率 = 100%
- ✅ 智能选择策略准确率 > 90%
- ✅ 页面加载时间 < 2秒
- ✅ 所有测试用例通过
- ✅ 用户满意度 > 85%

---

### 14.2 性能验收标准

| 指标 | 目标值 | 测试方法 |
|------|--------|---------|
| **平均响应时间** | < 300ms | 压力测试 |
| **并发处理能力** | > 500 qps | 压力测试 |
| **系统可用性** | > 99.9% | 监控系统 |
| **CPU使用率** | < 80% | 性能监控 |
| **内存使用率** | < 80% | 性能监控 |

---

### 14.3 安全验收标准

| 棇标 | 目标值 | 测试方法 |
|------|--------|---------|
| **SQL注入** | 无 | 安全扫描 |
| **XSS攻击** | 无 | 安全扫描 |
| **CSRF攻击** | 无 | 安全扫描 |
| **敏感数据加密** | 100% | 代码审查 |
| **权限控制** | 正确 | 功能测试 |

---

### 14.4 用户体验验收标准

| 指标 | 目标值 | 测试方法 |
|------|--------|---------|
| **用户满意度** | > 85% | 用户调研 |
| **页面加载时间** | < 2秒 | 性能测试 |
| **操作便捷性** | 优秀 | 用户测试 |
| **界面美观度** | 良好 | 用户测试 |

---

## 15. 附录

### 15.1 参考资料

- [客服工作流程分析与优化.md](./客服工作流程分析与优化.md)
- [系统设计报告1.md](./系统设计报告1.md)
- [系统设计报告2.md](./系统设计报告2.md)
- [系统设计报告3.md](./系统设计报告3.md)
- [系统设计报告4.md](./系统设计报告4.md)
- [模块升级详解-流程引擎篇.md](./模块升级详解-流程引擎篇.md)
- [今日改造分析报告.md](./今日改造分析报告.md)

---

### 15.2 联系人

| 角色 | 姓名 | 联系方式 |
|------|------|---------|
| 项目经理 | TBD | TBD |
| 技术负责人 | TBD | TBD |
| 开发负责人 | TBD | TBD |
| 测试负责人 | TBD | TBD |
| 运维负责人 | TBD | TBD |

---

### 15.3 术语表

| 术语 | 说明 |
|------|------|
| P0 | 最高优先级，必须完成 |
| P1 | 高优先级，应该完成 |
| P2 | 中优先级，可以完成 |
| SSE | Server-Sent Events，服务器推送事件 |
| API | Application Programming Interface，应用程序接口 |
| CRUD | Create, Read, Update, Delete，增删改查 |
| UI | User Interface，用户界面 |
| UX | User Experience，用户体验 |

---

**文档结束**

请确认升级计划和实施步骤，我们准备开始升级！
