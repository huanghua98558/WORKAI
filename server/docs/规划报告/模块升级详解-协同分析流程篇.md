# WorkTool AI ä¸­æ¢ç³»ç»Ÿ - æ¨¡å—å‡çº§è¯¦è§£ï¼ˆååŒåˆ†ææµç¨‹ç¯‡ï¼‰

## ğŸ“‹ ç›®å½•

1. [ååŒåˆ†æç³»ç»Ÿæ¦‚è¿°](#1-ååŒåˆ†æç³»ç»Ÿæ¦‚è¿°)
2. [å·¥ä½œäººå‘˜ç›‘æ§](#2-å·¥ä½œäººå‘˜ç›‘æ§)
3. [ç”¨æˆ·æ»¡æ„åº¦åˆ†æ](#3-ç”¨æˆ·æ»¡æ„åº¦åˆ†æ)
4. [ååŒå†³ç­–ç®¡ç†](#4-ååŒå†³ç­–ç®¡ç†)
5. [ååŒåˆ†ææµç¨‹](#5-ååŒåˆ†ææµç¨‹)

---

## 1. ååŒåˆ†æç³»ç»Ÿæ¦‚è¿°

### 1.1 ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ååŒåˆ†æç³»ç»Ÿ                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  æ•°æ®é‡‡é›†å±‚ (Data Collection Layer)                                    â”‚  â”‚
â”‚  â”‚  - å·¥ä½œäººå‘˜æ´»åŠ¨é‡‡é›†                                                   â”‚  â”‚
â”‚  â”‚  - ç”¨æˆ·åé¦ˆé‡‡é›†                                                       â”‚  â”‚
â”‚  â”‚  - ä¼šè¯æ•°æ®é‡‡é›†                                                       â”‚  â”‚
â”‚  â”‚  - å”®åä»»åŠ¡é‡‡é›†                                                       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                    â†“                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  åˆ†æå±‚ (Analysis Layer)                                              â”‚  â”‚
â”‚  â”‚  - å·¥ä½œäººå‘˜æ´»åŠ¨åˆ†æ                                                   â”‚  â”‚
â”‚  â”‚  - ç”¨æˆ·æ»¡æ„åº¦åˆ†æ                                                     â”‚  â”‚
â”‚  â”‚  - ååŒæ•ˆç‡åˆ†æ                                                       â”‚  â”‚
â”‚  â”‚  - å·¥ä½œè´Ÿè½½åˆ†æ                                                       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                    â†“                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  å†³ç­–å±‚ (Decision Layer)                                              â”‚  â”‚
â”‚  â”‚  - äººå·¥ä»‹å…¥å†³ç­–                                                       â”‚  â”‚
â”‚  â”‚  - å·¥ä½œäººå‘˜åˆ†é…å†³ç­–                                                   â”‚  â”‚
â”‚  â”‚  - èµ„æºè°ƒåº¦å†³ç­–                                                       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                    â†“                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  å±•ç¤ºå±‚ (Presentation Layer)                                           â”‚  â”‚
â”‚  â”‚  - å·¥ä½œäººå‘˜ç›‘æ§ä»ªè¡¨ç›˜                                                 â”‚  â”‚
â”‚  â”‚  - ç”¨æˆ·æ»¡æ„åº¦æŠ¥è¡¨                                                     â”‚  â”‚
â”‚  â”‚  - ååŒæ•ˆç‡æŠ¥è¡¨                                                       â”‚  â”‚
â”‚  â”‚  - å‘Šè­¦ç»Ÿè®¡æŠ¥è¡¨                                                       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 ååŒåˆ†æèƒ½åŠ›

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    åˆ†æèƒ½åŠ›       â”‚    æ•°æ®æ¥æº     â”‚    åˆ†ææŒ‡æ ‡     â”‚    åº”ç”¨åœºæ™¯     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å·¥ä½œäººå‘˜ç›‘æ§      â”‚ å·¥ä½œäººå‘˜æ´»åŠ¨     â”‚ æ´»åŠ¨é¢‘æ¬¡ã€å“åº”æ—¶é—´  â”‚ ç›‘æ§å·¥ä½œäººå‘˜æ•ˆç‡  â”‚
â”‚ ç”¨æˆ·æ»¡æ„åº¦åˆ†æ    â”‚ ç”¨æˆ·åé¦ˆã€æƒ…æ„Ÿåˆ†æ  â”‚ æ»¡æ„åº¦è¯„åˆ†ã€è¶‹åŠ¿    â”‚ è¯„ä¼°æœåŠ¡è´¨é‡      â”‚
â”‚ ååŒæ•ˆç‡åˆ†æ      â”‚ ä¼šè¯è®°å½•ã€å”®åä»»åŠ¡  â”‚ å¤„ç†æ—¶é•¿ã€å®Œæˆç‡    â”‚ ä¼˜åŒ–ååŒæµç¨‹      â”‚
â”‚ å·¥ä½œè´Ÿè½½åˆ†æ      â”‚ å”®åä»»åŠ¡ã€å‘Šè­¦      â”‚ ä»»åŠ¡æ•°é‡ã€å·¥ä½œæ—¶é•¿  â”‚ åˆç†åˆ†é…å·¥ä½œ      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. å·¥ä½œäººå‘˜ç›‘æ§

### 2.1 ç›‘æ§ç»´åº¦

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              ç›‘æ§ç»´åº¦                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  1. æ´»åŠ¨ç›‘æ§                                                           â”‚  â”‚
â”‚  â”‚     - æ´»åŠ¨ç±»å‹ï¼šå‘é€æ¶ˆæ¯ã€å›å¤æ¶ˆæ¯ã€å¤„ç†ä»»åŠ¡ã€å…³é—­å‘Šè­¦                  â”‚  â”‚
â”‚  â”‚     - æ´»åŠ¨é¢‘æ¬¡ï¼šæ¯å°æ—¶æ´»åŠ¨æ•°é‡                                          â”‚  â”‚
â”‚  â”‚     - æ´»åŠ¨æ—¶é—´ï¼šæ´»åŠ¨æ—¶é—´åˆ†å¸ƒ                                            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  2. å“åº”ç›‘æ§                                                           â”‚  â”‚
â”‚  â”‚     - å“åº”æ—¶é—´ï¼šä»å‘Šè­¦åˆ›å»ºåˆ°ç¡®è®¤çš„æ—¶é—´                                  â”‚  â”‚
â”‚  â”‚     - å¤„ç†æ—¶é—´ï¼šä»ç¡®è®¤åˆ°è§£å†³çš„æ—¶é—´                                      â”‚  â”‚
â”‚  â”‚     - è¶…æ—¶æ¬¡æ•°ï¼šè¶…è¿‡å“åº”æ—¶é—´çš„å‘Šè­¦æ•°é‡                                  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  3. è´¨é‡ç›‘æ§                                                           â”‚  â”‚
â”‚  â”‚     - å¤„ç†è´¨é‡ï¼šç”¨æˆ·åé¦ˆè¯„åˆ†                                            â”‚  â”‚
â”‚  â”‚     - ååŒè´¨é‡ï¼šä¸å…¶ä»–å·¥ä½œäººå‘˜çš„ååŒæ•ˆç‡                                â”‚  â”‚
â”‚  â”‚     - è´¨é‡è¯„åˆ†ï¼šç»¼åˆè¯„åˆ†                                                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  4. è´Ÿè½½ç›‘æ§                                                           â”‚  â”‚
â”‚  â”‚     - å½“å‰ä»»åŠ¡ï¼šæ­£åœ¨å¤„ç†çš„ä»»åŠ¡æ•°é‡                                      â”‚  â”‚
â”‚  â”‚     - å†å²ä»»åŠ¡ï¼šå·²å®Œæˆçš„ä»»åŠ¡æ•°é‡                                        â”‚  â”‚
â”‚  â”‚     - å·¥ä½œæ—¶é•¿ï¼šç´¯è®¡å·¥ä½œæ—¶é•¿                                            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 è¯¦ç»†å®ç°

**æ–‡ä»¶ä½ç½®ï¼š** `server/services/staff-monitoring.service.js`

```javascript
const { getDb } = require('coze-coding-dev-sdk');
const { staffActivities, alerts, afterSalesTasks, eq, sql, desc, and, gte, lte } = require('../database/schema');
const logger = require('./system-logger.service');

class StaffMonitoringService {
  /**
   * è·å–å·¥ä½œäººå‘˜æ´»åŠ¨åˆ—è¡¨
   */
  async getStaffActivities(params) {
    const db = await getDb();

    const {
      staffId,
      staffName,
      activityType,
      startTime,
      endTime,
      page = 1,
      pageSize = 20,
    } = params;

    const offset = (page - 1) * pageSize;

    // æ„å»ºæŸ¥è¯¢æ¡ä»¶
    const conditions = [];

    if (staffId) {
      conditions.push(eq(staffActivities.staffId, staffId));
    }

    if (staffName) {
      conditions.push(eq(staffActivities.staffName, staffName));
    }

    if (activityType) {
      conditions.push(eq(staffActivities.activityType, activityType));
    }

    if (startTime) {
      conditions.push(gte(staffActivities.activityTime, new Date(startTime)));
    }

    if (endTime) {
      conditions.push(lte(staffActivities.activityTime, new Date(endTime)));
    }

    // æ‰§è¡ŒæŸ¥è¯¢
    const activities = await db
      .select()
      .from(staffActivities)
      .where(conditions.length > 0 ? and(...conditions) : sql`1=1`)
      .orderBy(desc(staffActivities.activityTime))
      .limit(pageSize)
      .offset(offset);

    return {
      list: activities,
      page,
      pageSize,
    };
  }

  /**
   * è·å–å·¥ä½œäººå‘˜æ´»åŠ¨ç»Ÿè®¡
   */
  async getStaffActivitiesStatistics(params) {
    const db = await getDb();

    const { staffId, startTime, endTime } = params;

    // æ„å»ºæŸ¥è¯¢æ¡ä»¶
    const conditions = [];

    if (staffId) {
      conditions.push(eq(staffActivities.staffId, staffId));
    }

    if (startTime) {
      conditions.push(gte(staffActivities.activityTime, new Date(startTime)));
    }

    if (endTime) {
      conditions.push(lte(staffActivities.activityTime, new Date(endTime)));
    }

    // ç»Ÿè®¡æ´»åŠ¨é¢‘æ¬¡
    const activityCountResult = await db
      .select({
        staffId: staffActivities.staffId,
        staffName: staffActivities.staffName,
        activityType: staffActivities.activityType,
        count: sql`COUNT(*)`,
      })
      .from(staffActivities)
      .where(conditions.length > 0 ? and(...conditions) : sql`1=1`)
      .groupBy(staffActivities.staffId, staffActivities.staffName, staffActivities.activityType);

    // ç»Ÿè®¡å“åº”æ—¶é—´
    const responseTimeResult = await db.execute(sql`
      SELECT
        aa.staff_id as "staffId",
        aa.staff_name as "staffName",
        AVG(EXTRACT(EPOCH FROM (aa.acknowledged_at - a.created_at))) as "avgResponseTime",
        MIN(EXTRACT(EPOCH FROM (aa.acknowledged_at - a.created_at))) as "minResponseTime",
        MAX(EXTRACT(EPOCH FROM (aa.acknowledged_at - a.created_at))) as "maxResponseTime"
      FROM alerts a
      JOIN staff_activities aa ON a.alert_id = aa.activity_data->>'alertId'
      WHERE aa.activity_type = 'acknowledge_alert'
        ${staffId ? sql`AND aa.staff_id = ${staffId}` : sql``}
        ${startTime ? sql`AND aa.activity_time >= ${new Date(startTime)}` : sql``}
        ${endTime ? sql`AND aa.activity_time <= ${new Date(endTime)}` : sql``}
      GROUP BY aa.staff_id, aa.staff_name
    `);

    return {
      activityCount: activityCountResult,
      responseTime: responseTimeResult.rows,
    };
  }

  /**
   * è·å–å·¥ä½œäººå‘˜å·¥ä½œè´Ÿè½½
   */
  async getStaffWorkload(params) {
    const db = await getDb();

    const { staffId } = params;

    // ç»Ÿè®¡å½“å‰ä»»åŠ¡
    const currentTasksResult = await db.execute(sql`
      SELECT
        assigned_to as "staffId",
        COUNT(*) as "currentTaskCount"
      FROM after_sales_tasks
      WHERE status IN ('pending', 'in_progress')
        ${staffId ? sql`AND assigned_to = ${staffId}` : sql``}
      GROUP BY assigned_to
    `);

    // ç»Ÿè®¡ä»Šæ—¥å®Œæˆä»»åŠ¡
    const todayTasksResult = await db.execute(sql`
      SELECT
        assigned_to as "staffId",
        COUNT(*) as "todayTaskCount"
      FROM after_sales_tasks
      WHERE status = 'completed'
        AND completed_at >= CURRENT_DATE
        ${staffId ? sql`AND assigned_to = ${staffId}` : sql``}
      GROUP BY assigned_to
    `);

    // ç»Ÿè®¡æœ¬å‘¨å®Œæˆä»»åŠ¡
    const weekTasksResult = await db.execute(sql`
      SELECT
        assigned_to as "staffId",
        COUNT(*) as "weekTaskCount"
      FROM after_sales_tasks
      WHERE status = 'completed'
        AND completed_at >= date_trunc('week', CURRENT_DATE)
        ${staffId ? sql`AND assigned_to = ${staffId}` : sql``}
      GROUP BY assigned_to
    `);

    return {
      currentTasks: currentTasksResult.rows,
      todayTasks: todayTasksResult.rows,
      weekTasks: weekTasksResult.rows,
    };
  }

  /**
   * è·å–å·¥ä½œäººå‘˜è´¨é‡è¯„åˆ†
   */
  async getStaffQualityScore(params) {
    const db = await getDb();

    const { staffId, startTime, endTime } = params;

    // è®¡ç®—å“åº”æ—¶é—´è¯„åˆ†
    const responseTimeScore = await this.calculateResponseTimeScore(db, staffId, startTime, endTime);

    // è®¡ç®—å¤„ç†è´¨é‡è¯„åˆ†
    const processingQualityScore = await this.calculateProcessingQualityScore(db, staffId, startTime, endTime);

    // è®¡ç®—ååŒè´¨é‡è¯„åˆ†
    const collaborationQualityScore = await this.calculateCollaborationQualityScore(db, staffId, startTime, endTime);

    // ç»¼åˆè¯„åˆ†
    const overallScore = (
      responseTimeScore * 0.4 +
      processingQualityScore * 0.4 +
      collaborationQualityScore * 0.2
    );

    return {
      staffId,
      responseTimeScore,
      processingQualityScore,
      collaborationQualityScore,
      overallScore,
    };
  }

  /**
   * è®¡ç®—å“åº”æ—¶é—´è¯„åˆ†
   */
  async calculateResponseTimeScore(db, staffId, startTime, endTime) {
    const result = await db.execute(sql`
      SELECT
        AVG(EXTRACT(EPOCH FROM (a.acknowledged_at - a.created_at))) as "avgResponseTime"
      FROM alerts a
      WHERE a.acknowledged_at IS NOT NULL
        ${staffId ? sql`AND a.acknowledged_by = ${staffId}` : sql``}
        ${startTime ? sql`AND a.created_at >= ${new Date(startTime)}` : sql``}
        ${endTime ? sql`AND a.created_at <= ${new Date(endTime)}` : sql``}
    `);

    if (result.rows.length === 0 || !result.rows[0].avgResponseTime) {
      return 50; // é»˜è®¤50åˆ†
    }

    const avgResponseTime = parseFloat(result.rows[0].avgResponseTime);

    // å“åº”æ—¶é—´è¯„åˆ†ï¼š5åˆ†é’Ÿå†…100åˆ†ï¼Œæ¯å¢åŠ 5åˆ†é’Ÿæ‰£10åˆ†ï¼Œæœ€ä½0åˆ†
    const score = Math.max(0, 100 - (avgResponseTime / 60 - 5) * 10);

    return Math.min(100, score);
  }

  /**
   * è®¡ç®—å¤„ç†è´¨é‡è¯„åˆ†
   */
  async calculateProcessingQualityScore(db, staffId, startTime, endTime) {
    const result = await db.execute(sql`
      SELECT
        AVG(
          CASE
            WHEN a.resolved_at IS NOT NULL THEN 100
            WHEN a.status = 'processing' THEN 50
            ELSE 0
          END
        ) as "qualityScore"
      FROM alerts a
      WHERE a.acknowledged_by IS NOT NULL
        ${staffId ? sql`AND a.acknowledged_by = ${staffId}` : sql``}
        ${startTime ? sql`AND a.created_at >= ${new Date(startTime)}` : sql``}
        ${endTime ? sql`AND a.created_at <= ${new Date(endTime)}` : sql``}
    `);

    if (result.rows.length === 0 || !result.rows[0].qualityScore) {
      return 50; // é»˜è®¤50åˆ†
    }

    return parseFloat(result.rows[0].qualityScore);
  }

  /**
   * è®¡ç®—ååŒè´¨é‡è¯„åˆ†
   */
  async calculateCollaborationQualityScore(db, staffId, startTime, endTime) {
    // ç»Ÿè®¡ååŒæ¬¡æ•°
    const collaborationCountResult = await db.execute(sql`
      SELECT COUNT(*) as "count"
      FROM after_sales_tasks
      WHERE assigned_to IS NOT NULL
        AND collaboration_team IS NOT NULL
        ${staffId ? sql`AND assigned_to = ${staffId}` : sql``}
        ${startTime ? sql`AND created_at >= ${new Date(startTime)}` : sql``}
        ${endTime ? sql`AND created_at <= ${new Date(endTime)}` : sql``}
    `);

    const collaborationCount = parseInt(collaborationCountResult.rows[0].count) || 0;

    // ååŒè´¨é‡è¯„åˆ†ï¼šååŒæ¬¡æ•°è¶Šå¤šï¼Œè¯„åˆ†è¶Šé«˜
    const score = Math.min(100, collaborationCount * 10);

    return score;
  }

  /**
   * è·å–å·¥ä½œäººå‘˜æ´»åŠ¨è¯¦æƒ…
   */
  async getStaffActivityDetails(activityId) {
    const db = await getDb();

    const activity = await db
      .select()
      .from(staffActivities)
      .where(eq(staffActivities.id, activityId))
      .limit(1);

    if (activity.length === 0) {
      return null;
    }

    return activity[0];
  }

  /**
   * è·å–å·¥ä½œäººå‘˜åˆ—è¡¨
   */
  async getStaffList() {
    const db = await getDb();

    const result = await db.execute(sql`
      SELECT DISTINCT
        staff_id as "staffId",
        staff_name as "staffName"
      FROM staff_activities
      ORDER BY staff_name
    `);

    return result.rows;
  }
}

module.exports = new StaffMonitoringService();
```

---

## 3. ç”¨æˆ·æ»¡æ„åº¦åˆ†æ

### 3.1 åˆ†æç»´åº¦

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              åˆ†æç»´åº¦                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  1. æ»¡æ„åº¦è¯„åˆ†                                                         â”‚  â”‚
â”‚  â”‚     - è¯„åˆ†æ¥æºï¼šæƒ…æ„Ÿåˆ†æã€ç”¨æˆ·åé¦ˆã€å”®åä»»åŠ¡è¯„ä»·                        â”‚  â”‚
â”‚  â”‚     - è¯„åˆ†èŒƒå›´ï¼š0-100åˆ†                                                â”‚  â”‚
â”‚  â”‚     - è¯„åˆ†è¶‹åŠ¿ï¼šæ»¡æ„åº¦å˜åŒ–è¶‹åŠ¿                                          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  2. æƒ…æ„Ÿåˆ†æ                                                           â”‚  â”‚
â”‚  â”‚     - æ­£é¢æ¶ˆæ¯æ•°é‡                                                      â”‚  â”‚
â”‚  â”‚     - ä¸­æ€§æ¶ˆæ¯æ•°é‡                                                      â”‚  â”‚
â”‚  â”‚     - è´Ÿé¢æ¶ˆæ¯æ•°é‡                                                      â”‚  â”‚
â”‚  â”‚     - æƒ…æ„Ÿå¼ºåº¦åˆ†å¸ƒ                                                      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  3. æŠ•è¯‰åˆ†æ                                                           â”‚  â”‚
â”‚  â”‚     - æŠ•è¯‰æ¬¡æ•°                                                          â”‚  â”‚
â”‚  â”‚     - æŠ•è¯‰ç±»å‹åˆ†å¸ƒ                                                      â”‚  â”‚
â”‚  â”‚     - æŠ•è¯‰å¤„ç†æ—¶æ•ˆ                                                      â”‚  â”‚
â”‚  â”‚     - æŠ•è¯‰è§£å†³ç‡                                                        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  4. å”®åä»»åŠ¡åˆ†æ                                                       â”‚  â”‚
â”‚  â”‚     - ä»»åŠ¡æ•°é‡                                                          â”‚  â”‚
â”‚  â”‚     - ä»»åŠ¡ç±»å‹åˆ†å¸ƒ                                                      â”‚  â”‚
â”‚  â”‚     - ä»»åŠ¡å¤„ç†æ—¶é•¿                                                      â”‚  â”‚
â”‚  â”‚     - ä»»åŠ¡å®Œæˆç‡                                                        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 è¯¦ç»†å®ç°

**æ–‡ä»¶ä½ç½®ï¼š** `server/services/user-satisfaction.service.js`

```javascript
const { getDb } = require('coze-coding-dev-sdk');
const { sessionMessages, users, afterSalesTasks, eq, sql, desc } = require('../database/schema');
const logger = require('./system-logger.service');

class UserSatisfactionService {
  /**
   * è·å–ç”¨æˆ·æ»¡æ„åº¦åˆ—è¡¨
   */
  async getUserSatisfactionList(params) {
    const db = await getDb();

    const {
      userId,
      userName,
      minScore,
      maxScore,
      startTime,
      endTime,
      page = 1,
      pageSize = 20,
    } = params;

    const offset = (page - 1) * pageSize;

    // è®¡ç®—ç”¨æˆ·æ»¡æ„åº¦è¯„åˆ†
    const result = await db.execute(sql`
      SELECT
        u.id as "userId",
        u.username as "username",
        u.real_name as "realName",
        u.email as "email",
        u.created_at as "createdAt",
        u.updated_at as "updatedAt",
        -- è®¡ç®—æ»¡æ„åº¦è¯„åˆ†
        (
          (
            SUM(CASE WHEN sm.sentiment = 'positive' THEN 1 ELSE 0 END) -
            SUM(CASE WHEN sm.sentiment = 'negative' THEN 1 ELSE 0 END)
          ) * 1.0 / NULLIF(COUNT(*), 0) * 50 + 50
        ) as "satisfactionScore",
        -- æ­£é¢æ¶ˆæ¯æ•°é‡
        SUM(CASE WHEN sm.sentiment = 'positive' THEN 1 ELSE 0 END) as "positiveCount",
        -- ä¸­æ€§æ¶ˆæ¯æ•°é‡
        SUM(CASE WHEN sm.sentiment = 'neutral' THEN 1 ELSE 0 END) as "neutralCount",
        -- è´Ÿé¢æ¶ˆæ¯æ•°é‡
        SUM(CASE WHEN sm.sentiment = 'negative' THEN 1 ELSE 0 END) as "negativeCount",
        -- æ€»æ¶ˆæ¯æ•°é‡
        COUNT(*) as "totalMessageCount",
        -- æŠ•è¯‰æ¬¡æ•°
        SUM(CASE
          WHEN sm.sentiment = 'negative'
            AND sm.sentiment_intensity = 'high'
          THEN 1
          ELSE 0
        END) as "complaintCount"
      FROM users u
      LEFT JOIN session_messages sm ON u.id = sm.user_id
      WHERE u.id IS NOT NULL
        ${userId ? sql`AND u.id = ${userId}` : sql``}
        ${userName ? sql`AND u.username LIKE ${'%' + userName + '%'}` : sql``}
        ${startTime ? sql`AND sm.created_at >= ${new Date(startTime)}` : sql``}
        ${endTime ? sql`AND sm.created_at <= ${new Date(endTime)}` : sql``}
      GROUP BY u.id, u.username, u.real_name, u.email, u.created_at, u.updated_at
      HAVING COUNT(*) > 0
        ${minScore !== undefined ? sql`AND (
          (
            SUM(CASE WHEN sm.sentiment = 'positive' THEN 1 ELSE 0 END) -
            SUM(CASE WHEN sm.sentiment = 'negative' THEN 1 ELSE 0 END)
          ) * 1.0 / NULLIF(COUNT(*), 0) * 50 + 50
        ) >= ${minScore}` : sql``}
        ${maxScore !== undefined ? sql`AND (
          (
            SUM(CASE WHEN sm.sentiment = 'positive' THEN 1 ELSE 0 END) -
            SUM(CASE WHEN sm.sentiment = 'negative' THEN 1 ELSE 0 END)
          ) * 1.0 / NULLIF(COUNT(*), 0) * 50 + 50
        ) <= ${maxScore}` : sql``}
      ORDER BY (
        (
          SUM(CASE WHEN sm.sentiment = 'positive' THEN 1 ELSE 0 END) -
          SUM(CASE WHEN sm.sentiment = 'negative' THEN 1 ELSE 0 END)
        ) * 1.0 / NULLIF(COUNT(*), 0) * 50 + 50
      ) DESC
      LIMIT ${pageSize} OFFSET ${offset}
    `);

    return {
      list: result.rows,
      page,
      pageSize,
    };
  }

  /**
   * è·å–ç”¨æˆ·æ»¡æ„åº¦ç»Ÿè®¡
   */
  async getUserSatisfactionStatistics(params) {
    const db = await getDb();

    const { startTime, endTime } = params;

    // æ€»ä½“æ»¡æ„åº¦
    const overallResult = await db.execute(sql`
      SELECT
        AVG(
          (
            (SUM(CASE WHEN sentiment = 'positive' THEN 1 ELSE 0 END) -
             SUM(CASE WHEN sentiment = 'negative' THEN 1 ELSE 0 END)
            ) * 1.0 / NULLIF(COUNT(*), 0) * 50 + 50
          )
        ) as "avgScore",
        MIN(
          (
            (SUM(CASE WHEN sentiment = 'positive' THEN 1 ELSE 0 END) -
             SUM(CASE WHEN sentiment = 'negative' THEN 1 ELSE 0 END)
            ) * 1.0 / NULLIF(COUNT(*), 0) * 50 + 50
          )
        ) as "minScore",
        MAX(
          (
            (SUM(CASE WHEN sentiment = 'positive' THEN 1 ELSE 0 END) -
             SUM(CASE WHEN sentiment = 'negative' THEN 1 ELSE 0 END)
            ) * 1.0 / NULLIF(COUNT(*), 0) * 50 + 50
          )
        ) as "maxScore",
        COUNT(DISTINCT user_id) as "totalUsers"
      FROM session_messages
      WHERE 1=1
        ${startTime ? sql`AND created_at >= ${new Date(startTime)}` : sql``}
        ${endTime ? sql`AND created_at <= ${new Date(endTime)}` : sql``}
    `);

    // æƒ…æ„Ÿåˆ†å¸ƒ
    const sentimentDistributionResult = await db.execute(sql`
      SELECT
        sentiment,
        COUNT(*) as "count",
        ROUND(COUNT(*) * 100.0 / SUM(COUNT(*)) OVER(), 2) as "percentage"
      FROM session_messages
      WHERE 1=1
        ${startTime ? sql`AND created_at >= ${new Date(startTime)}` : sql``}
        ${endTime ? sql`AND created_at <= ${new Date(endTime)}` : sql``}
      GROUP BY sentiment
    `);

    // æ»¡æ„åº¦åˆ†å¸ƒ
    const scoreDistributionResult = await db.execute(sql`
      SELECT
        CASE
          WHEN (
            (SUM(CASE WHEN sentiment = 'positive' THEN 1 ELSE 0 END) -
             SUM(CASE WHEN sentiment = 'negative' THEN 1 ELSE 0 END)
            ) * 1.0 / NULLIF(COUNT(*), 0) * 50 + 50
          ) >= 80 THEN 'ä¼˜ç§€'
          WHEN (
            (SUM(CASE WHEN sentiment = 'positive' THEN 1 ELSE 0 END) -
             SUM(CASE WHEN sentiment = 'negative' THEN 1 ELSE 0 END)
            ) * 1.0 / NULLIF(COUNT(*), 0) * 50 + 50
          ) >= 60 THEN 'è‰¯å¥½'
          WHEN (
            (SUM(CASE WHEN sentiment = 'positive' THEN 1 ELSE 0 END) -
             SUM(CASE WHEN sentiment = 'negative' THEN 1 ELSE 0 END)
            ) * 1.0 / NULLIF(COUNT(*), 0) * 50 + 50
          ) >= 40 THEN 'ä¸€èˆ¬'
          ELSE 'å·®'
        END as "scoreLevel",
        COUNT(DISTINCT user_id) as "userCount"
      FROM session_messages
      WHERE 1=1
        ${startTime ? sql`AND created_at >= ${new Date(startTime)}` : sql``}
        ${endTime ? sql`AND created_at <= ${new Date(endTime)}` : sql``}
      GROUP BY
        CASE
          WHEN (
            (SUM(CASE WHEN sentiment = 'positive' THEN 1 ELSE 0 END) -
             SUM(CASE WHEN sentiment = 'negative' THEN 1 ELSE 0 END)
            ) * 1.0 / NULLIF(COUNT(*), 0) * 50 + 50
          ) >= 80 THEN 'ä¼˜ç§€'
          WHEN (
            (SUM(CASE WHEN sentiment = 'positive' THEN 1 ELSE 0 END) -
             SUM(CASE WHEN sentiment = 'negative' THEN 1 ELSE 0 END)
            ) * 1.0 / NULLIF(COUNT(*), 0) * 50 + 50
          ) >= 60 THEN 'è‰¯å¥½'
          WHEN (
            (SUM(CASE WHEN sentiment = 'positive' THEN 1 ELSE 0 END) -
             SUM(CASE WHEN sentiment = 'negative' THEN 1 ELSE 0 END)
            ) * 1.0 / NULLIF(COUNT(*), 0) * 50 + 50
          ) >= 40 THEN 'ä¸€èˆ¬'
          ELSE 'å·®'
        END
    `);

    return {
      overall: overallResult.rows[0],
      sentimentDistribution: sentimentDistributionResult.rows,
      scoreDistribution: scoreDistributionResult.rows,
    };
  }

  /**
   * è·å–ç”¨æˆ·æ»¡æ„åº¦è¯¦æƒ…
   */
  async getUserSatisfactionDetails(userId) {
    const db = await getDb();

    // ç”¨æˆ·åŸºæœ¬ä¿¡æ¯
    const userResult = await db
      .select()
      .from(users)
      .where(eq(users.id, userId))
      .limit(1);

    if (userResult.length === 0) {
      return null;
    }

    const user = userResult[0];

    // è®¡ç®—æ»¡æ„åº¦è¯„åˆ†
    const scoreResult = await db.execute(sql`
      SELECT
        (
          (SUM(CASE WHEN sentiment = 'positive' THEN 1 ELSE 0 END) -
           SUM(CASE WHEN sentiment = 'negative' THEN 1 ELSE 0 END)
          ) * 1.0 / NULLIF(COUNT(*), 0) * 50 + 50
        ) as "satisfactionScore",
        SUM(CASE WHEN sentiment = 'positive' THEN 1 ELSE 0 END) as "positiveCount",
        SUM(CASE WHEN sentiment = 'neutral' THEN 1 ELSE 0 END) as "neutralCount",
        SUM(CASE WHEN sentiment = 'negative' THEN 1 ELSE 0 END) as "negativeCount",
        COUNT(*) as "totalMessageCount"
      FROM session_messages
      WHERE user_id = ${userId}
    `);

    const score = scoreResult.rows[0];

    // æƒ…æ„Ÿè¶‹åŠ¿
    const sentimentTrendResult = await db.execute(sql`
      SELECT
        DATE_TRUNC('day', created_at) as "date",
        sentiment,
        COUNT(*) as "count"
      FROM session_messages
      WHERE user_id = ${userId}
        AND created_at >= CURRENT_DATE - INTERVAL '30 days'
      GROUP BY DATE_TRUNC('day', created_at), sentiment
      ORDER BY date DESC, sentiment
    `);

    // æŠ•è¯‰è®°å½•
    const complaintResult = await db.execute(sql`
      SELECT
        id,
        session_id as "sessionId",
        user_id as "userId",
        user_name as "userName",
        content,
        created_at as "createdAt"
      FROM session_messages
      WHERE user_id = ${userId}
        AND sentiment = 'negative'
        AND sentiment_intensity = 'high'
      ORDER BY created_at DESC
      LIMIT 10
    `);

    // å”®åä»»åŠ¡
    const taskResult = await db.execute(sql`
      SELECT
        id,
        task_type as "taskType",
        status,
        priority,
        assigned_to as "assignedTo",
        created_at as "createdAt",
        completed_at as "completedAt"
      FROM after_sales_tasks
      WHERE user_id = ${userId}
      ORDER BY created_at DESC
      LIMIT 10
    `);

    return {
      user,
      score,
      sentimentTrend: sentimentTrendResult.rows,
      complaints: complaintResult.rows,
      tasks: taskResult.rows,
    };
  }

  /**
   * è·å–ç”¨æˆ·æ»¡æ„åº¦è¶‹åŠ¿
   */
  async getUserSatisfactionTrend(params) {
    const db = await getDb();

    const { userId, days = 30 } = params;

    const result = await db.execute(sql`
      SELECT
        DATE_TRUNC('day', created_at) as "date",
        ROUND(
          (
            (SUM(CASE WHEN sentiment = 'positive' THEN 1 ELSE 0 END) -
             SUM(CASE WHEN sentiment = 'negative' THEN 1 ELSE 0 END)
            ) * 1.0 / NULLIF(COUNT(*), 0) * 50 + 50
          ),
          2
        ) as "satisfactionScore",
        COUNT(*) as "messageCount"
      FROM session_messages
      WHERE user_id = ${userId}
        AND created_at >= CURRENT_DATE - INTERVAL '${days} days'
      GROUP BY DATE_TRUNC('day', created_at)
      ORDER BY date DESC
    `);

    return result.rows;
  }
}

module.exports = new UserSatisfactionService();
```

---

## 4. ååŒå†³ç­–ç®¡ç†

### 4.1 å†³ç­–ç±»å‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              å†³ç­–ç±»å‹                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  1. äººå·¥ä»‹å…¥å†³ç­–                                                       â”‚  â”‚
â”‚  â”‚     - AIåˆ¤æ–­éœ€è¦äººå·¥ä»‹å…¥                                                 â”‚  â”‚
â”‚  â”‚     - åˆ›å»ºä»‹å…¥è®°å½•                                                      â”‚  â”‚
â”‚  â”‚     - é€šçŸ¥ç›¸å…³å·¥ä½œäººå‘˜                                                   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  2. å·¥ä½œäººå‘˜åˆ†é…å†³ç­–                                                   â”‚  â”‚
â”‚  â”‚     - æ ¹æ®å·¥ä½œè´Ÿè½½åˆ†é…ä»»åŠ¡                                              â”‚  â”‚
â”‚  â”‚     - æ ¹æ®è´¨é‡è¯„åˆ†åˆ†é…é«˜ä¼˜å…ˆçº§ä»»åŠ¡                                       â”‚  â”‚
â”‚  â”‚     - æ ¹æ®å“åº”æ—¶é—´åˆ†é…ç´§æ€¥ä»»åŠ¡                                           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  3. èµ„æºè°ƒåº¦å†³ç­–                                                       â”‚  â”‚
â”‚  â”‚     - æ ¹æ®å‘Šè­¦çº§åˆ«è°ƒåº¦èµ„æº                                              â”‚  â”‚
â”‚  â”‚     - æ ¹æ®ä»»åŠ¡æ•°é‡å¢åŠ å·¥ä½œäººå‘˜                                           â”‚  â”‚
â”‚  â”‚     - æ ¹æ®æ—¶é—´æ®µè°ƒæ•´å·¥ä½œäººå‘˜é…ç½®                                         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 è¯¦ç»†å®ç°

**æ–‡ä»¶ä½ç½®ï¼š** `server/services/collaboration-decision.service.js`

```javascript
const { getDb } = require('coze-coding-dev-sdk');
const { collaborationDecisions, eq } = require('../database/schema');
const staffMonitoringService = require('./staff-monitoring.service');
const logger = require('./system-logger.service');

class CollaborationDecisionService {
  /**
   * åˆ›å»ºå†³ç­–
   */
  async createDecision(decisionData) {
    const db = await getDb();

    try {
      logger.info('[ååŒå†³ç­–] åˆ›å»ºå†³ç­–', {
        decisionType: decisionData.decisionType,
        sessionId: decisionData.sessionId,
      });

      const decision = await db.insert(collaborationDecisions).values({
        decisionId: this.generateDecisionId(),
        decisionType: decisionData.decisionType,
        sessionId: decisionData.sessionId,
        userId: decisionData.userId,
        userName: decisionData.userName,
        reason: decisionData.reason,
        context: decisionData.context || {},
        priority: decisionData.priority || 'P2',
        status: 'pending',
        assignedTo: null,
        assignedAt: null,
        completedBy: null,
        completedAt: null,
        notes: null,
        createdAt: new Date(),
        updatedAt: new Date(),
      }).returning();

      // å¦‚æœéœ€è¦è‡ªåŠ¨åˆ†é…å·¥ä½œäººå‘˜
      if (decisionData.decisionType === 'human_intervention' || decisionData.decisionType === 'staff_assignment') {
        await this.autoAssignStaff(decision[0]);
      }

      logger.info('[ååŒå†³ç­–] å†³ç­–åˆ›å»ºæˆåŠŸ', {
        decisionId: decision[0].decisionId,
      });

      return decision[0];
    } catch (error) {
      logger.error('[ååŒå†³ç­–] åˆ›å»ºå†³ç­–å¤±è´¥', {
        error: error.message,
        stack: error.stack,
      });
      throw error;
    }
  }

  /**
   * è‡ªåŠ¨åˆ†é…å·¥ä½œäººå‘˜
   */
  async autoAssignStaff(decision) {
    try {
      logger.info('[ååŒå†³ç­–] è‡ªåŠ¨åˆ†é…å·¥ä½œäººå‘˜', {
        decisionId: decision.decisionId,
      });

      // è·å–å·¥ä½œäººå‘˜å·¥ä½œè´Ÿè½½
      const workload = await staffMonitoringService.getStaffWorkload({});

      // è·å–å·¥ä½œäººå‘˜è´¨é‡è¯„åˆ†
      const qualityScores = await Promise.all(
        workload.currentTasks.map(async (task) => {
          const score = await staffMonitoringService.getStaffQualityScore({
            staffId: task.staffId,
          });
          return score;
        })
      );

      // é€‰æ‹©æœ€ä¼˜å·¥ä½œäººå‘˜
      const assignedStaff = this.selectBestStaff(workload.currentTasks, qualityScores);

      if (!assignedStaff) {
        logger.warn('[ååŒå†³ç­–] æ²¡æœ‰å¯åˆ†é…çš„å·¥ä½œäººå‘˜', {
          decisionId: decision.decisionId,
        });
        return;
      }

      // åˆ†é…å·¥ä½œäººå‘˜
      await this.assignDecision(decision.decisionId, assignedStaff.staffId);

      logger.info('[ååŒå†³ç­–] å·¥ä½œäººå‘˜åˆ†é…æˆåŠŸ', {
        decisionId: decision.decisionId,
        staffId: assignedStaff.staffId,
      });
    } catch (error) {
      logger.error('[ååŒå†³ç­–] è‡ªåŠ¨åˆ†é…å·¥ä½œäººå‘˜å¤±è´¥', {
        decisionId: decision.decisionId,
        error: error.message,
        stack: error.stack,
      });
      throw error;
    }
  }

  /**
   * é€‰æ‹©æœ€ä¼˜å·¥ä½œäººå‘˜
   */
  selectBestStaff(workloadList, qualityScores) {
    // è®¡ç®—æ¯ä¸ªå·¥ä½œäººå‘˜çš„å¾—åˆ†
    const scoredStaff = workloadList.map((workload) => {
      const quality = qualityScores.find(s => s.staffId === workload.staffId);

      const taskCount = parseInt(workload.currentTaskCount) || 0;
      const qualityScore = quality?.overallScore || 50;

      // å¾—åˆ† = è´¨é‡è¯„åˆ† * 0.6 + (10 - ä»»åŠ¡æ•°) * 0.4
      const score = qualityScore * 0.6 + Math.max(0, 10 - taskCount) * 4;

      return {
        staffId: workload.staffId,
        taskCount,
        qualityScore,
        score,
      };
    });

    // æŒ‰å¾—åˆ†æ’åº
    scoredStaff.sort((a, b) => b.score - a.score);

    // è¿”å›å¾—åˆ†æœ€é«˜çš„å·¥ä½œäººå‘˜
    return scoredStaff[0];
  }

  /**
   * åˆ†é…å†³ç­–
   */
  async assignDecision(decisionId, assignedTo) {
    const db = await getDb();

    const decision = await db
      .update(collaborationDecisions)
      .set({
        assignedTo,
        assignedAt: new Date(),
        status: 'assigned',
        updatedAt: new Date(),
      })
      .where(eq(collaborationDecisions.decisionId, decisionId))
      .returning();

    return decision[0];
  }

  /**
   * å®Œæˆå†³ç­–
   */
  async completeDecision(decisionId, completedBy, notes) {
    const db = await getDb();

    try {
      logger.info('[ååŒå†³ç­–] å®Œæˆå†³ç­–', {
        decisionId,
        completedBy,
      });

      const decision = await db
        .update(collaborationDecisions)
        .set({
          status: 'completed',
          completedBy,
          completedAt: new Date(),
          notes,
          updatedAt: new Date(),
        })
        .where(eq(collaborationDecisions.decisionId, decisionId))
        .returning();

      logger.info('[ååŒå†³ç­–] å†³ç­–å®ŒæˆæˆåŠŸ', {
        decisionId,
      });

      return decision[0];
    } catch (error) {
      logger.error('[ååŒå†³ç­–] å®Œæˆå†³ç­–å¤±è´¥', {
        decisionId,
        error: error.message,
        stack: error.stack,
      });
      throw error;
    }
  }

  /**
   * è·å–å†³ç­–åˆ—è¡¨
   */
  async getDecisionList(params) {
    const db = await getDb();

    const {
      decisionType,
      status,
      assignedTo,
      startTime,
      endTime,
      page = 1,
      pageSize = 20,
    } = params;

    const offset = (page - 1) * pageSize;

    // æ„å»ºæŸ¥è¯¢æ¡ä»¶
    const conditions = [];

    if (decisionType) {
      conditions.push(eq(collaborationDecisions.decisionType, decisionType));
    }

    if (status) {
      conditions.push(eq(collaborationDecisions.status, status));
    }

    if (assignedTo) {
      conditions.push(eq(collaborationDecisions.assignedTo, assignedTo));
    }

    if (startTime) {
      conditions.push(sql`created_at >= ${new Date(startTime)}`);
    }

    if (endTime) {
      conditions.push(sql`created_at <= ${new Date(endTime)}`);
    }

    // æ‰§è¡ŒæŸ¥è¯¢
    const decisions = await db
      .select()
      .from(collaborationDecisions)
      .where(conditions.length > 0 ? and(...conditions) : sql`1=1`)
      .orderBy(desc(collaborationDecisions.createdAt))
      .limit(pageSize)
      .offset(offset);

    return {
      list: decisions,
      page,
      pageSize,
    };
  }

  /**
   * è·å–å†³ç­–è¯¦æƒ…
   */
  async getDecisionDetails(decisionId) {
    const db = await getDb();

    const decision = await db
      .select()
      .from(collaborationDecisions)
      .where(eq(collaborationDecisions.decisionId, decisionId))
      .limit(1);

    if (decision.length === 0) {
      return null;
    }

    return decision[0];
  }

  /**
   * ç”Ÿæˆå†³ç­–ID
   */
  generateDecisionId() {
    const timestamp = Date.now();
    const random = Math.floor(Math.random() * 10000).toString().padStart(4, '0');
    return `DEC-${timestamp}-${random}`;
  }
}

module.exports = new CollaborationDecisionService();
```

---

## 5. ååŒåˆ†ææµç¨‹

### 5.1 å®Œæ•´æµç¨‹

```
ç”¨æˆ·æ¶ˆæ¯
    â†“
AIåˆ†æ
    â†“
åˆ¤æ–­æ˜¯å¦éœ€è¦äººå·¥ä»‹å…¥
    â”œâ”€ å¦ â†’ AIè‡ªåŠ¨å¤„ç†
    â””â”€ æ˜¯ â†’ ç»§ç»­
    â†“
åˆ›å»ºååŒå†³ç­–
    â”œâ”€ å†³ç­–ç±»å‹ï¼šhuman_intervention
    â”œâ”€ ä¼˜å…ˆçº§ï¼šP0/P1/P2
    â”œâ”€ çŠ¶æ€ï¼špending
    â””â”€ åŸå› ï¼šè®°å½•ä»‹å…¥åŸå› 
    â†“
è‡ªåŠ¨åˆ†é…å·¥ä½œäººå‘˜
    â”œâ”€ è·å–å·¥ä½œäººå‘˜å·¥ä½œè´Ÿè½½
    â”œâ”€ è·å–å·¥ä½œäººå‘˜è´¨é‡è¯„åˆ†
    â”œâ”€ é€‰æ‹©æœ€ä¼˜å·¥ä½œäººå‘˜
    â””â”€ åˆ†é…å†³ç­–
    â†“
é€šçŸ¥å·¥ä½œäººå‘˜
    â”œâ”€ ä¼ä¸šå¾®ä¿¡é€šçŸ¥
    â”œâ”€ å‘ŠçŸ¥ä¼šè¯ID
    â”œâ”€ å‘ŠçŸ¥åŸå› 
    â””â”€ æä¾›ä¸Šä¸‹æ–‡
    â†“
å·¥ä½œäººå‘˜ä»‹å…¥
    â”œâ”€ æŸ¥çœ‹ä¼šè¯å†å²
    â”œâ”€ æŸ¥çœ‹ç”¨æˆ·ç”»åƒ
    â”œâ”€ æŸ¥çœ‹å”®åä»»åŠ¡
    â””â”€ å†³å®šå¤„ç†æ–¹å¼
    â†“
å·¥ä½œäººå‘˜å¤„ç†
    â”œâ”€ å‘é€æ¶ˆæ¯ç»™ç”¨æˆ·
    â”œâ”€ å¤„ç†å”®åä»»åŠ¡
    â”œâ”€ å…³é—­å‘Šè­¦
    â””â”€ è®°å½•æ´»åŠ¨
    â†“
å®Œæˆå†³ç­–
    â”œâ”€ æ›´æ–°å†³ç­–çŠ¶æ€ä¸ºcompleted
    â”œâ”€ è®°å½•å¤„ç†äºº
    â”œâ”€ è®°å½•å¤„ç†æ—¶é—´
    â””â”€ è®°å½•å¤„ç†è¯´æ˜
    â†“
åˆ†æå¤„ç†æ•ˆæœ
    â”œâ”€ è®¡ç®—å“åº”æ—¶é—´
    â”œâ”€ è®¡ç®—å¤„ç†æ—¶é—´
    â”œâ”€ è®¡ç®—ç”¨æˆ·æ»¡æ„åº¦å˜åŒ–
    â””â”€ ç”ŸæˆæŠ¥è¡¨
```

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0

**æœ€åæ›´æ–°**ï¼š2024-01-10

**æ–‡æ¡£ä½œè€…**ï¼šWorkTool AI å›¢é˜Ÿ
