# WorkTool AI ä¸­æ¢ç³»ç»Ÿ - ä»£ç ä¿®æ”¹æŠ¥å‘Š

## ğŸ“‹ ç›®å½•

1. [ä¿®æ”¹è¯´æ˜](#1-ä¿®æ”¹è¯´æ˜)
2. [æ–‡ä»¶ä¿®æ”¹æ±‡æ€»](#2-æ–‡ä»¶ä¿®æ”¹æ±‡æ€»)
3. [è¯¦ç»†ä¿®æ”¹æ¸…å•](#3-è¯¦ç»†ä¿®æ”¹æ¸…å•)
4. [æ–°å»ºæ–‡ä»¶æ¸…å•](#4-æ–°å»ºæ–‡ä»¶æ¸…å•)
5. [æ— éœ€ä¿®æ”¹æ–‡ä»¶æ¸…å•](#5-æ— éœ€ä¿®æ”¹æ–‡ä»¶æ¸…å•)
6. [ä¿®æ”¹ä¼˜å…ˆçº§](#6-ä¿®æ”¹ä¼˜å…ˆçº§)

---

## 1. ä¿®æ”¹è¯´æ˜

### 1.1 ä¿®æ”¹ä¾æ®

æœ¬ä»£ç ä¿®æ”¹æŠ¥å‘ŠåŸºäºä»¥ä¸‹4ä»½ç³»ç»Ÿè®¾è®¡æŠ¥å‘Šï¼š
- ã€Šç³»ç»Ÿè®¾è®¡æŠ¥å‘Š1.mdã€‹ - ä¸»æŠ¥å‘Šï¼Œå®šä¹‰æ•´ä½“æ¶æ„å’ŒåŠŸèƒ½æ¨¡å—
- ã€Šç³»ç»Ÿè®¾è®¡æŠ¥å‘Š2.mdã€‹ - æ›´æ–°è¯´æ˜ï¼Œæ˜ç¡®å¹³å°ç™»å½•ç”¨æˆ·ç®¡ç†ç³»ç»Ÿ
- ã€Šç³»ç»Ÿè®¾è®¡æŠ¥å‘Š3.mdã€‹ - è¡¥å……å†…å®¹ï¼Œå‘Šè­¦å’ŒAIé…ç½®åŒ–è®¾è®¡
- ã€Šç³»ç»Ÿè®¾è®¡æŠ¥å‘Š4.mdã€‹ - æœ€ä¼˜è§£å»ºè®®ï¼Œæœºå™¨äººé€‰æ‹©è§„åˆ™ç­‰

### 1.2 ä¿®æ”¹åŸåˆ™

1. **æœ€å°åŒ–ä¿®æ”¹**ï¼šåªä¿®æ”¹å¿…è¦çš„æ–‡ä»¶ï¼Œé¿å…è¿‡åº¦ä¿®æ”¹
2. **å‘åå…¼å®¹**ï¼šæ–°åŠŸèƒ½ä¸å½±å“ç°æœ‰åŠŸèƒ½
3. **æ¨¡å—åŒ–**ï¼šæ–°å¢åŠŸèƒ½ç‹¬ç«‹æ¨¡å—ï¼Œä¾¿äºç»´æŠ¤
4. **å¯æµ‹è¯•**ï¼šæ¯ä¸ªä¿®æ”¹éƒ½å¯ç‹¬ç«‹æµ‹è¯•
5. **å¯å›æ»š**ï¼šæ¯ä¸ªä¿®æ”¹éƒ½å¯ç‹¬ç«‹å›æ»š

### 1.3 æ–‡ä»¶åˆ†ç±»

| åˆ†ç±» | è¯´æ˜ | æ•°é‡ |
|------|------|------|
| éœ€è¦ä¿®æ”¹ | ç°æœ‰æ–‡ä»¶éœ€è¦ä¿®æ”¹ | 15ä¸ª |
| éœ€è¦æ–°å»º | æ–°å¢çš„æ–‡ä»¶ | 45ä¸ª |
| æ— éœ€ä¿®æ”¹ | ä¿æŒä¸å˜çš„æ–‡ä»¶ | 60+ä¸ª |

---

## 2. æ–‡ä»¶ä¿®æ”¹æ±‡æ€»

### 2.1 æ•°æ®åº“å±‚

| åˆ†ç±» | æ–‡ä»¶è·¯å¾„ | æ“ä½œ | è¯´æ˜ |
|------|---------|------|------|
| ä¿®æ”¹ | `server/database/schema.js` | æ‰©å±• | æ·»åŠ æƒé™ç®¡ç†ç›¸å…³è¡¨å®šä¹‰ |
| æ–°å»º | `server/database/migrations/20240110_add_roles_table.sql` | æ–°å»º | è§’è‰²è¡¨è¿ç§»è„šæœ¬ |
| æ–°å»º | `server/database/migrations/20240110_add_permissions_table.sql` | æ–°å»º | æƒé™è¡¨è¿ç§»è„šæœ¬ |
| æ–°å»º | `server/database/migrations/20240110_add_user_roles_table.sql` | æ–°å»º | ç”¨æˆ·è§’è‰²å…³è”è¡¨è¿ç§»è„šæœ¬ |
| æ–°å»º | `server/database/migrations/20240110_add_role_permissions_table.sql` | æ–°å»º | è§’è‰²æƒé™å…³è”è¡¨è¿ç§»è„šæœ¬ |
| æ–°å»º | `server/database/migrations/20240110_add_audit_logs_table.sql` | æ–°å»º | å®¡è®¡æ—¥å¿—è¡¨è¿ç§»è„šæœ¬ |
| æ–°å»º | `server/database/migrations/20240110_add_robots_permissions_table.sql` | æ–°å»º | æœºå™¨äººæƒé™è¡¨è¿ç§»è„šæœ¬ |
| æ–°å»º | `server/database/migrations/20240110_alter_users_table.sql` | æ–°å»º | ç”¨æˆ·è¡¨ç»“æ„å˜æ›´ |
| æ–°å»º | `server/database/migrations/20240110_alter_robots_table.sql` | æ–°å»º | æœºå™¨äººè¡¨ç»“æ„å˜æ›´ |
| æ–°å»º | `server/database/migrations/20240110_alter_system_settings_table.sql` | æ–°å»º | ç³»ç»Ÿé…ç½®è¡¨ç»“æ„å˜æ›´ |
| æ–°å»º | `server/database/seeds/20240110_seed_roles_permissions.sql` | æ–°å»º | åˆå§‹æ•°æ®ç§å­è„šæœ¬ |
| æ–°å»º | `server/database/migrations/20240110_migrate_existing_data.sql` | æ–°å»º | æ•°æ®è¿ç§»è„šæœ¬ |

**å°è®¡ï¼šä¿®æ”¹1ä¸ªï¼Œæ–°å»º11ä¸ª**

### 2.2 åç«¯æœåŠ¡å±‚

| åˆ†ç±» | æ–‡ä»¶è·¯å¾„ | æ“ä½œ | è¯´æ˜ |
|------|---------|------|------|
| æ–°å»º | `server/services/user.service.js` | æ–°å»º | ç”¨æˆ·ç®¡ç†æœåŠ¡ |
| æ–°å»º | `server/services/role.service.js` | æ–°å»º | è§’è‰²ç®¡ç†æœåŠ¡ |
| æ–°å»º | `server/services/permission.service.js` | æ–°å»º | æƒé™ç®¡ç†æœåŠ¡ |
| æ–°å»º | `server/services/audit-log.service.js` | æ–°å»º | å®¡è®¡æ—¥å¿—æœåŠ¡ |
| ä¿®æ”¹ | `server/services/robot.service.js` | æ‰©å±• | ä¼˜åŒ–æœºå™¨äººé€‰æ‹©é€»è¾‘ |
| æ–°å»º | `server/services/alert-config.service.js` | æ–°å»º | å‘Šè­¦é…ç½®æœåŠ¡ |
| æ–°å»º | `server/services/ai-config.service.js` | æ–°å»º | AIé…ç½®æœåŠ¡ |
| ä¿®æ”¹ | `server/services/message.service.js` | ä¼˜åŒ– | ä¼˜åŒ–æ¶ˆæ¯å‘é€å»¶è¿Ÿ |

**å°è®¡ï¼šä¿®æ”¹2ä¸ªï¼Œæ–°å»º6ä¸ª**

### 2.3 åç«¯é’©å­å’Œä¸­é—´ä»¶

| åˆ†ç±» | æ–‡ä»¶è·¯å¾„ | æ“ä½œ | è¯´æ˜ |
|------|---------|------|------|
| æ–°å»º | `server/hooks/rbac.hook.js` | æ–°å»º | åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶é’©å­ |
| ä¿®æ”¹ | `server/hooks/auth.hook.js` | æ‰©å±• | æ‰©å±•è®¤è¯é’©å­ï¼Œå¢åŠ æƒé™æ£€æŸ¥ |
| æ–°å»º | `server/middleware/audit-middleware.js` | æ–°å»º | æ“ä½œå®¡è®¡ä¸­é—´ä»¶ |

**å°è®¡ï¼šä¿®æ”¹1ä¸ªï¼Œæ–°å»º2ä¸ª**

### 2.4 åç«¯é…ç½®å±‚

| åˆ†ç±» | æ–‡ä»¶è·¯å¾„ | æ“ä½œ | è¯´æ˜ |
|------|---------|------|------|
| æ–°å»º | `server/config/alert.config.js` | æ–°å»º | å‘Šè­¦é…ç½®å¸¸é‡ |
| æ–°å»º | `server/config/ai-prompts.config.js` | æ–°å»º | AI Prompté…ç½® |
| æ–°å»º | `server/config/reply-delay.config.js` | æ–°å»º | å›å¤å»¶è¿Ÿé…ç½® |
| ä¿®æ”¹ | `server/lib/config.js` | æ‰©å±• | æ‰©å±•é…ç½®åŠ è½½ |

**å°è®¡ï¼šä¿®æ”¹1ä¸ªï¼Œæ–°å»º3ä¸ª**

### 2.5 åç«¯è·¯ç”±å±‚

| åˆ†ç±» | æ–‡ä»¶è·¯å¾„ | æ“ä½œ | è¯´æ˜ |
|------|---------|------|------|
| ä¿®æ”¹ | `server/routes/admin.api.js` | æ‰©å±• | æ–°å¢ç”¨æˆ·ç®¡ç†ã€è§’è‰²æƒé™ã€å®¡è®¡æ—¥å¿—ã€å‘Šè­¦é…ç½®ã€AIé…ç½®API |

**å°è®¡ï¼šä¿®æ”¹1ä¸ª**

### 2.6 å‰ç«¯é¡µé¢å±‚

| åˆ†ç±» | æ–‡ä»¶è·¯å¾„ | æ“ä½œ | è¯´æ˜ |
|------|---------|------|------|
| ä¿®æ”¹ | `src/app/layout.tsx` | æ‰©å±• | æ›´æ–°ä¾§è¾¹æ å¯¼èˆª |
| ä¿®æ”¹ | `src/components/layout/Sidebar.tsx` | æ‰©å±• | æ–°å¢è®¾ç½®èœå•é¡¹ |
| æ–°å»º | `src/app/settings/users/page.tsx` | æ–°å»º | ç”¨æˆ·ç®¡ç†é¡µé¢ |
| æ–°å»º | `src/components/users/UserForm.tsx` | æ–°å»º | ç”¨æˆ·è¡¨å•ç»„ä»¶ |
| æ–°å»º | `src/components/users/UserList.tsx` | æ–°å»º | ç”¨æˆ·åˆ—è¡¨ç»„ä»¶ |
| æ–°å»º | `src/app/settings/roles/page.tsx` | æ–°å»º | è§’è‰²ç®¡ç†é¡µé¢ |
| æ–°å»º | `src/components/roles/RoleForm.tsx` | æ–°å»º | è§’è‰²è¡¨å•ç»„ä»¶ |
| æ–°å»º | `src/components/roles/RolePermissionSelector.tsx` | æ–°å»º | è§’è‰²æƒé™é€‰æ‹©å™¨ |
| æ–°å»º | `src/app/settings/permissions/page.tsx` | æ–°å»º | æƒé™ç®¡ç†é¡µé¢ |
| æ–°å»º | `src/components/permissions/PermissionTree.tsx` | æ–°å»º | æƒé™æ ‘ç»„ä»¶ |
| æ–°å»º | `src/app/settings/audit-logs/page.tsx` | æ–°å»º | å®¡è®¡æ—¥å¿—é¡µé¢ |
| æ–°å»º | `src/components/audit-logs/AuditLogList.tsx` | æ–°å»º | å®¡è®¡æ—¥å¿—åˆ—è¡¨ |
| æ–°å»º | `src/app/settings/alert-config/page.tsx` | æ–°å»º | å‘Šè­¦é…ç½®é¡µé¢ |
| æ–°å»º | `src/components/alert-config/AlertIntervalForm.tsx` | æ–°å»º | å‘Šè­¦æ—¶é—´é—´éš”é…ç½®è¡¨å• |
| æ–°å»º | `src/components/alert-config/AlertLevelForm.tsx` | æ–°å»º | å‘Šè­¦ç­‰çº§ç­–ç•¥é…ç½®è¡¨å• |
| æ–°å»º | `src/app/settings/ai-config/page.tsx` | æ–°å»º | AIé…ç½®é¡µé¢ |
| æ–°å»º | `src/components/ai-config/AIPromptForm.tsx` | æ–°å»º | AI Promptè¡¨å• |
| æ–°å»º | `src/components/ai-config/PromptVersionList.tsx` | æ–°å»º | Promptç‰ˆæœ¬åˆ—è¡¨ |

**å°è®¡ï¼šä¿®æ”¹2ä¸ªï¼Œæ–°å»º15ä¸ª**

### 2.7 å‰ç«¯æœåŠ¡å±‚

| åˆ†ç±» | æ–‡ä»¶è·¯å¾„ | æ“ä½œ | è¯´æ˜ |
|------|---------|------|------|
| æ–°å»º | `src/lib/services/user-service.ts` | æ–°å»º | ç”¨æˆ·ç®¡ç†æœåŠ¡ |
| æ–°å»º | `src/lib/services/role-service.ts` | æ–°å»º | è§’è‰²ç®¡ç†æœåŠ¡ |
| æ–°å»º | `src/lib/services/permission-service.ts` | æ–°å»º | æƒé™ç®¡ç†æœåŠ¡ |
| æ–°å»º | `src/lib/services/audit-log-service.ts` | æ–°å»º | å®¡è®¡æ—¥å¿—æœåŠ¡ |
| æ–°å»º | `src/lib/services/alert-config-service.ts` | æ–°å»º | å‘Šè­¦é…ç½®æœåŠ¡ |
| æ–°å»º | `src/lib/services/ai-config-service.ts` | æ–°å»º | AIé…ç½®æœåŠ¡ |

**å°è®¡ï¼šæ–°å»º6ä¸ª**

### 2.8 æµ‹è¯•å±‚

| åˆ†ç±» | æ–‡ä»¶è·¯å¾„ | æ“ä½œ | è¯´æ˜ |
|------|---------|------|------|
| æ–°å»º | `server/tests/services/user.service.test.js` | æ–°å»º | ç”¨æˆ·æœåŠ¡æµ‹è¯• |
| æ–°å»º | `server/tests/services/role.service.test.js` | æ–°å»º | è§’è‰²æœåŠ¡æµ‹è¯• |
| æ–°å»º | `server/tests/services/permission.service.test.js` | æ–°å»º | æƒé™æœåŠ¡æµ‹è¯• |
| æ–°å»º | `server/tests/services/audit-log.service.test.js` | æ–°å»º | å®¡è®¡æ—¥å¿—æœåŠ¡æµ‹è¯• |
| æ–°å»º | `server/tests/services/alert-config.service.test.js` | æ–°å»º | å‘Šè­¦é…ç½®æœåŠ¡æµ‹è¯• |
| æ–°å»º | `server/tests/services/ai-config.service.test.js` | æ–°å»º | AIé…ç½®æœåŠ¡æµ‹è¯• |
| æ–°å»º | `server/tests/services/robot.service.test.js` | æ–°å»º | æœºå™¨äººæœåŠ¡æµ‹è¯• |
| æ–°å»º | `server/tests/integration/auth.integration.test.js` | æ–°å»º | è®¤è¯é›†æˆæµ‹è¯• |
| æ–°å»º | `server/tests/integration/rbac.integration.test.js` | æ–°å»º | RBACé›†æˆæµ‹è¯• |
| æ–°å»º | `server/tests/integration/alert.integration.test.js` | æ–°å»º | å‘Šè­¦é›†æˆæµ‹è¯• |
| æ–°å»º | `server/tests/integration/ai.integration.test.js` | æ–°å»º | AIé›†æˆæµ‹è¯• |
| æ–°å»º | `server/tests/integration/robot.integration.test.js` | æ–°å»º | æœºå™¨äººé›†æˆæµ‹è¯• |

**å°è®¡ï¼šæ–°å»º12ä¸ª**

---

## 3. è¯¦ç»†ä¿®æ”¹æ¸…å•

### 3.1 æ•°æ®åº“å±‚ä¿®æ”¹

#### ä¿®æ”¹æ–‡ä»¶ï¼š`server/database/schema.js`

**ä¿®æ”¹å†…å®¹ï¼š**

1. **æ–°å¢è§’è‰²è¡¨ï¼ˆrolesï¼‰**
```javascript
exports.roles = pgTable("roles", {
  id: varchar("id", { length: 36 }).primaryKey().default(sql`gen_random_uuid()`),
  roleName: varchar("role_name", { length: 50 }).notNull().unique(),
  roleCode: varchar("role_code", { length: 50 }).notNull().unique(),
  description: text("description"),
  isSystem: boolean("is_system").notNull().default(false),
  createdAt: timestamp("created_at", { withTimezone: true }).defaultNow().notNull(),
  updatedAt: timestamp("updated_at", { withTimezone: true }).defaultNow().notNull(),
});
```

2. **æ–°å¢æƒé™è¡¨ï¼ˆpermissionsï¼‰**
```javascript
exports.permissions = pgTable("permissions", {
  id: varchar("id", { length: 36 }).primaryKey().default(sql`gen_random_uuid()`),
  permissionName: varchar("permission_name", { length: 100 }).notNull(),
  permissionCode: varchar("permission_code", { length: 100 }).notNull().unique(),
  resourceType: varchar("resource_type", { length: 50 }).notNull(),
  resourceId: varchar("resource_id", { length: 36 }),
  actionType: varchar("action_type", { length: 50 }).notNull(),
  description: text("description"),
  createdAt: timestamp("created_at", { withTimezone: true }).defaultNow().notNull(),
});
```

3. **æ–°å¢ç”¨æˆ·è§’è‰²å…³è”è¡¨ï¼ˆuser_rolesï¼‰**
```javascript
exports.userRoles = pgTable("user_roles", {
  id: varchar("id", { length: 36 }).primaryKey().default(sql`gen_random_uuid()`),
  userId: varchar("user_id", { length: 36 }).notNull().references("users.id").onDelete("cascade"),
  roleId: varchar("role_id", { length: 36 }).notNull().references("roles.id").onDelete("cascade"),
  assignedBy: varchar("assigned_by", { length: 36 }),
  assignedAt: timestamp("assigned_at", { withTimezone: true }).defaultNow().notNull(),
  expiresAt: timestamp("expires_at", { withTimezone: true }),
});
```

4. **æ–°å¢è§’è‰²æƒé™å…³è”è¡¨ï¼ˆrole_permissionsï¼‰**
```javascript
exports.rolePermissions = pgTable("role_permissions", {
  id: varchar("id", { length: 36 }).primaryKey().default(sql`gen_random_uuid()`),
  roleId: varchar("role_id", { length: 36 }).notNull().references("roles.id").onDelete("cascade"),
  permissionId: varchar("permission_id", { length: 36 }).notNull().references("permissions.id").onDelete("cascade"),
  assignedBy: varchar("assigned_by", { length: 36 }),
  assignedAt: timestamp("assigned_at", { withTimezone: true }).defaultNow().notNull(),
});
```

5. **æ–°å¢å®¡è®¡æ—¥å¿—è¡¨ï¼ˆaudit_logsï¼‰**
```javascript
exports.auditLogs = pgTable("audit_logs", {
  id: varchar("id", { length: 36 }).primaryKey().default(sql`gen_random_uuid()`),
  userId: varchar("user_id", { length: 36 }).references("users.id").onDelete("set null"),
  userName: varchar("user_name", { length: 255 }),
  operationType: varchar("operation_type", { length: 50 }).notNull(),
  resourceType: varchar("resource_type", { length: 50 }).notNull(),
  resourceId: varchar("resource_id", { length: 36 }),
  description: text("description"),
  ipAddress: varchar("ip_address", { length: 45 }),
  userAgent: text("user_agent"),
  requestData: jsonb("request_data").default("{}"),
  responseData: jsonb("response_data").default("{}"),
  status: varchar("status", { length: 20 }).notNull(),
  errorMessage: text("error_message"),
  createdAt: timestamp("created_at", { withTimezone: true }).defaultNow().notNull(),
});
```

6. **æ–°å¢æœºå™¨äººæƒé™è¡¨ï¼ˆrobots_permissionsï¼‰**
```javascript
exports.robotsPermissions = pgTable("robots_permissions", {
  id: varchar("id", { length: 36 }).primaryKey().default(sql`gen_random_uuid()`),
  userId: varchar("user_id", { length: 36 }).notNull().references("users.id").onDelete("cascade"),
  robotId: varchar("robot_id", { length: 36 }).notNull().references("robots.id").onDelete("cascade"),
  robotName: varchar("robot_name", { length: 255 }),
  permissionType: varchar("permission_type", { length: 20 }).notNull().default("read"),
  canView: boolean("can_view").default(true).notNull(),
  canEdit: boolean("can_edit").default(false).notNull(),
  canDelete: boolean("can_delete").default(false).notNull(),
  canSendMessage: boolean("can_send_message").default(true).notNull(),
  canViewSessions: boolean("can_view_sessions").default(true).notNull(),
  canViewMessages: boolean("can_view_messages").default(true).notNull(),
  assignedBy: varchar("assigned_by", { length: 36 }),
  assignedByName: varchar("assigned_by_name", { length: 255 }),
  assignedAt: timestamp("assigned_at", { withTimezone: true }).defaultNow().notNull(),
  isActive: boolean("is_active").default(true).notNull(),
  notes: text("notes"),
  createdAt: timestamp("created_at", { withTimezone: true }).defaultNow().notNull(),
  updatedAt: timestamp("updated_at", { withTimezone: true }).defaultNow().notNull(),
});
```

7. **æ‰©å±•ç”¨æˆ·è¡¨ï¼ˆusersï¼‰**
```javascript
// åœ¨ç°æœ‰usersè¡¨ä¸­æ–°å¢å­—æ®µ
realName: varchar("real_name", { length: 255 }),
failedLoginCount: integer("failed_login_count").default(0),
lockedUntil: timestamp("locked_until", { withTimezone: true }),
deletedAt: timestamp("deleted_at", { withTimezone: true }),
```

8. **æ‰©å±•æœºå™¨äººè¡¨ï¼ˆrobotsï¼‰**
```javascript
// åœ¨ç°æœ‰robotsè¡¨ä¸­æ–°å¢å­—æ®µ
role: varchar("role", { length: 50 }),
workSchedule: jsonb("work_schedule").default("{}"),
selectionRules: jsonb("selection_rules").default("{}"),
```

9. **æ‰©å±•ç³»ç»Ÿé…ç½®è¡¨ï¼ˆsystem_settingsï¼‰**
```javascript
// æ–°å¢é…ç½®é¡¹
// alert_interval_staff_no_reply: å·¥ä½œäººå‘˜é•¿æ—¶é—´æœªå›å¤å‘Šè­¦é—´éš”
// alert_interval_user_uncooperative: å·ä¸»ä¸é…åˆå”®åå‘Šè­¦é—´éš”
// alert_interval_task_unfinished: å”®åä»»åŠ¡æœªå®Œæˆå‘Šè­¦é—´éš”
// alert_interval_task_no_follow: å”®åä»»åŠ¡æœªè·Ÿè¿›å‘Šè­¦é—´éš”
// day_shift_operation_delay: ç™½ç­è¿è¥æ¶ˆæ¯å»¶è¿Ÿ
// night_shift_operation_delay: æ™šç­è¿è¥æ¶ˆæ¯å»¶è¿Ÿ
// urgent_message_delay: ç´§æ€¥æ¶ˆæ¯å»¶è¿Ÿ
// after_sales_notify_delay: å”®åä»»åŠ¡æé†’å»¶è¿Ÿ
// day_shift_complex_delay: ç™½ç­å¤æ‚é—®é¢˜å»¶è¿Ÿ
// night_shift_complex_delay: æ™šç­å¤æ‚é—®é¢˜å»¶è¿Ÿ
// ai_system_prompt: AIç³»ç»ŸPrompt
// ai_intent_prompt: AIæ„å›¾è¯†åˆ«Prompt
// ai_sentiment_prompt: AIæƒ…æ„Ÿåˆ†æPrompt
// ai_reply_prompt: AIå›å¤ç”ŸæˆPrompt
// ai_alert_prompt: AIå‘Šè­¦åˆ¤æ–­Prompt
// ai_intervention_prompt: AIä»‹å…¥åˆ¤æ–­Prompt
```

---

### 3.2 åç«¯æœåŠ¡å±‚ä¿®æ”¹

#### ä¿®æ”¹æ–‡ä»¶ï¼š`server/services/robot.service.js`

**ä¿®æ”¹å†…å®¹ï¼š**

1. **ä¼˜åŒ–æœºå™¨äººé€‰æ‹©é€»è¾‘**
```javascript
/**
 * æ ¹æ®æ¶ˆæ¯ç±»å‹å’Œæ—¶æ®µé€‰æ‹©åˆé€‚çš„æœºå™¨äºº
 */
async selectRobotForReply(messageType, priority, timeSlot) {
  const { getDb } = require('coze-coding-dev-sdk');
  const db = await getDb();
  const config = require('../config/reply-delay.config');

  // P0ç´§æ€¥æ¶ˆæ¯ï¼šç«‹å³å›å¤
  if (priority === 'P0') {
    // ä¼˜å…ˆé€‰æ‹©å½“å‰åœ¨çº¿çš„å›å¤æœºå™¨äºº
    const timeSlot = this.getCurrentTimeSlot();
    const robotRole = timeSlot === 'day_shift' ? 'DAY_SHIFT_REPLY_ROBOT' : 'NIGHT_SHIFT_REPLY_ROBOT';
    return await this.getRobotByRole(robotRole);
  }

  // å”®åä»»åŠ¡æé†’ï¼šé€šçŸ¥æœºå™¨äºº
  if (messageType === 'after_sales_notify') {
    return await this.getRobotByRole('NOTIFY_ROBOT');
  }

  // æ—¥å¸¸ç¤¾ç¾¤è¿è¥ï¼šæ ¹æ®æ—¶æ®µé€‰æ‹©å›å¤æœºå™¨äºº
  if (messageType === 'operation') {
    const timeSlot = this.getCurrentTimeSlot();
    const robotRole = timeSlot === 'day_shift' ? 'DAY_SHIFT_REPLY_ROBOT' : 'NIGHT_SHIFT_REPLY_ROBOT';
    return await this.getRobotByRole(robotRole);
  }

  // é»˜è®¤ï¼šé€‰æ‹©ç™½ç­å›å¤æœºå™¨äºº
  return await this.getRobotByRole('DAY_SHIFT_REPLY_ROBOT');
}

/**
 * è·å–å½“å‰æ—¶æ®µ
 */
getCurrentTimeSlot() {
  const hour = new Date().getHours();
  const config = require('../config/reply-delay.config');

  if (hour >= config.dayShiftStart && hour < config.dayShiftEnd) {
    return 'day_shift';
  } else {
    return 'night_shift';
  }
}

/**
 * æ ¹æ®è§’è‰²è·å–æœºå™¨äºº
 */
async getRobotByRole(role) {
  const { getDb } = require('coze-coding-dev-sdk');
  const { robots, eq } = require('../database/schema');
  const db = await getDb();

  const result = await db.select().from(robots).where(eq(robots.role, role)).limit(1);
  return result[0] || null;
}
```

#### ä¿®æ”¹æ–‡ä»¶ï¼š`server/services/message.service.js`

**ä¿®æ”¹å†…å®¹ï¼š**

1. **ä¼˜åŒ–æ¶ˆæ¯å‘é€å»¶è¿Ÿé€»è¾‘**
```javascript
/**
 * è·å–å›å¤å»¶è¿Ÿæ—¶é—´
 */
async getReplyDelay(messageType, priority, timeSlot) {
  const config = require('../config/reply-delay.config');

  // P0ç´§æ€¥æ¶ˆæ¯ï¼šç«‹å³å›å¤
  if (priority === 'P0') {
    return this.randomBetween(config.urgentMessageDelay.min, config.urgentMessageDelay.max);
  }

  // å”®åä»»åŠ¡æé†’ï¼šç«‹å³æé†’
  if (messageType === 'after_sales_notify') {
    return this.randomBetween(config.afterSalesNotifyDelay.min, config.afterSalesNotifyDelay.max);
  }

  // æ ¹æ®æ—¶æ®µå’Œæ¶ˆæ¯ç±»å‹ç¡®å®šå»¶è¿ŸèŒƒå›´
  if (timeSlot === 'day_shift') {
    if (messageType === 'complex') {
      return this.randomBetween(config.dayShiftComplexDelay.min, config.dayShiftComplexDelay.max);
    } else {
      return this.randomBetween(config.dayShiftOperationDelay.min, config.dayShiftOperationDelay.max);
    }
  } else { // night_shift
    if (messageType === 'complex') {
      return this.randomBetween(config.nightShiftComplexDelay.min, config.nightShiftComplexDelay.max);
    } else {
      return this.randomBetween(config.nightShiftOperationDelay.min, config.nightShiftOperationDelay.max);
    }
  }
}

/**
 * éšæœºå»¶è¿Ÿ
 */
randomBetween(min, max) {
  return Math.floor(Math.random() * (max - min + 1)) + min;
}
```

---

### 3.3 åç«¯é’©å­å’Œä¸­é—´ä»¶ä¿®æ”¹

#### ä¿®æ”¹æ–‡ä»¶ï¼š`server/hooks/auth.hook.js`

**ä¿®æ”¹å†…å®¹ï¼š**

1. **æ‰©å±•è®¤è¯é’©å­ï¼Œå¢åŠ æƒé™æ£€æŸ¥**
```javascript
const jwt = require('jsonwebtoken');
const { getDb } = require('coze-coding-dev-sdk');
const { users, userRoles, roles, rolePermissions, permissions } = require('../database/schema');

/**
 * éªŒè¯JWT token
 */
async function verifyAuth(request, reply) {
  try {
    const token = request.headers.authorization?.replace('Bearer ', '');

    if (!token) {
      return reply.status(401).send({
        code: -1,
        message: 'æœªæˆæƒè®¿é—®'
      });
    }

    const decoded = jwt.verify(token, process.env.JWT_SECRET);
    const db = await getDb();

    // è·å–ç”¨æˆ·ä¿¡æ¯
    const user = await db.select().from(users).where(eq(users.id, decoded.userId)).limit(1);

    if (!user || !user[0]) {
      return reply.status(401).send({
        code: -1,
        message: 'ç”¨æˆ·ä¸å­˜åœ¨'
      });
    }

    // æ£€æŸ¥ç”¨æˆ·çŠ¶æ€
    if (user[0].status === 'inactive' || user[0].deletedAt) {
      return reply.status(403).send({
        code: -1,
        message: 'ç”¨æˆ·å·²è¢«ç¦ç”¨æˆ–åˆ é™¤'
      });
    }

    // æ£€æŸ¥è´¦æˆ·é”å®šçŠ¶æ€
    if (user[0].lockedUntil && new Date() < new Date(user[0].lockedUntil)) {
      return reply.status(403).send({
        code: -1,
        message: 'è´¦æˆ·å·²è¢«é”å®š'
      });
    }

    // å°†ç”¨æˆ·ä¿¡æ¯æ³¨å…¥åˆ°requestä¸­
    request.user = user[0];

    // è·å–ç”¨æˆ·è§’è‰²å’Œæƒé™
    request.userRoles = await this.getUserRoles(decoded.userId);
    request.userPermissions = await this.getUserPermissions(decoded.userId);
  } catch (error) {
    return reply.status(401).send({
      code: -1,
      message: 'è®¤è¯å¤±è´¥'
    });
  }
}

/**
 * è·å–ç”¨æˆ·è§’è‰²
 */
async function getUserRoles(userId) {
  const db = await getDb();
  const result = await db.select({
    roleId: userRoles.roleId,
    roleName: roles.roleName,
    roleCode: roles.roleCode,
  })
  .from(userRoles)
  .innerJoin(roles, eq(userRoles.roleId, roles.id))
  .where(eq(userRoles.userId, userId));

  return result;
}

/**
 * è·å–ç”¨æˆ·æƒé™
 */
async function getUserPermissions(userId) {
  const db = await getDb();
  const result = await db.select({
    permissionCode: permissions.permissionCode,
    permissionName: permissions.permissionName,
  })
  .from(userRoles)
  .innerJoin(rolePermissions, eq(userRoles.roleId, rolePermissions.roleId))
  .innerJoin(permissions, eq(rolePermissions.permissionId, permissions.id))
  .where(eq(userRoles.userId, userId));

  return result.map(p => p.permissionCode);
}
```

---

### 3.4 åç«¯é…ç½®å±‚ä¿®æ”¹

#### ä¿®æ”¹æ–‡ä»¶ï¼š`server/lib/config.js`

**ä¿®æ”¹å†…å®¹ï¼š**

1. **æ‰©å±•é…ç½®åŠ è½½**
```javascript
// åŠ è½½å‘Šè­¦é…ç½®
const alertConfig = {
  intervals: {
    staffNoReply: parseInt(process.env.ALERT_INTERVAL_STAFF_NO_REPLY) || 30, // åˆ†é’Ÿ
    userUncooperative: parseInt(process.env.ALERT_INTERVAL_USER_UNCOOPERATIVE) || 60, // åˆ†é’Ÿ
    taskUnfinished: parseInt(process.env.ALERT_INTERVAL_TASK_UNFINISHED) || 1440, // åˆ†é’Ÿ
    taskNoFollow: parseInt(process.env.ALERT_INTERVAL_TASK_NO_FOLLOW) || 3, // åˆ†é’Ÿ
  },
  levels: {
    P0: {
      threshold: 3,
      escalationLevel: 3,
      escalationInterval: 1800, // ç§’
    },
    P1: {
      threshold: 5,
      escalationLevel: 2,
      escalationInterval: 3600, // ç§’
    },
    P2: {
      threshold: 10,
      escalationLevel: 1,
      escalationInterval: 7200, // ç§’
    },
  },
};

// åŠ è½½å›å¤å»¶è¿Ÿé…ç½®
const replyDelayConfig = {
  dayShiftTimeRange: '09:00-21:00',
  nightShiftTimeRange: '21:00-09:00',
  dayShiftOperationDelay: { min: 2, max: 8 }, // ç§’
  nightShiftOperationDelay: { min: 5, max: 30 }, // ç§’
  urgentMessageDelay: { min: 1, max: 2 }, // ç§’
  afterSalesNotifyDelay: { min: 1, max: 2 }, // ç§’
  dayShiftComplexDelay: { min: 5, max: 15 }, // ç§’
  nightShiftComplexDelay: { min: 10, max: 30 }, // ç§’
};

// åŠ è½½AI Prompté…ç½®
const aiPromptsConfig = {
  systemPrompt: process.env.AI_SYSTEM_PROMPT || '',
  intentPrompt: process.env.AI_INTENT_PROMPT || '',
  sentimentPrompt: process.env.AI_SENTIMENT_PROMPT || '',
  replyPrompt: process.env.AI_REPLY_PROMPT || '',
  alertPrompt: process.env.AI_ALERT_PROMPT || '',
  interventionPrompt: process.env.AI_INTERVENTION_PROMPT || '',
};

module.exports = {
  // ... ç°æœ‰é…ç½®
  alertConfig,
  replyDelayConfig,
  aiPromptsConfig,
};
```

---

### 3.5 åç«¯è·¯ç”±å±‚ä¿®æ”¹

#### ä¿®æ”¹æ–‡ä»¶ï¼š`server/routes/admin.api.js`

**ä¿®æ”¹å†…å®¹ï¼š**

1. **æ–°å¢ç”¨æˆ·ç®¡ç†APIè·¯ç”±**
```javascript
// è·å–ç”¨æˆ·åˆ—è¡¨
fastify.get('/users', {
  onRequest: [verifyAuth, requirePermission('user_view')],
}, async (request, reply) => {
  // ... å®ç°
});

// åˆ›å»ºç”¨æˆ·
fastify.post('/users', {
  onRequest: [verifyAuth, requirePermission('user_create')],
}, async (request, reply) => {
  // ... å®ç°
});

// æ›´æ–°ç”¨æˆ·
fastify.put('/users/:user_id', {
  onRequest: [verifyAuth, requirePermission('user_update')],
}, async (request, reply) => {
  // ... å®ç°
});

// åˆ é™¤ç”¨æˆ·
fastify.delete('/users/:user_id', {
  onRequest: [verifyAuth, requirePermission('user_delete')],
}, async (request, reply) => {
  // ... å®ç°
});

// é‡ç½®å¯†ç 
fastify.post('/users/:user_id/reset-password', {
  onRequest: [verifyAuth, requirePermission('user_update')],
}, async (request, reply) => {
  // ... å®ç°
});

// é”å®šç”¨æˆ·
fastify.post('/users/:user_id/lock', {
  onRequest: [verifyAuth, requirePermission('user_update')],
}, async (request, reply) => {
  // ... å®ç°
});

// è§£é”ç”¨æˆ·
fastify.post('/users/:user_id/unlock', {
  onRequest: [verifyAuth, requirePermission('user_update')],
}, async (request, reply) => {
  // ... å®ç°
});
```

2. **æ–°å¢è§’è‰²æƒé™APIè·¯ç”±**
```javascript
// è·å–è§’è‰²åˆ—è¡¨
fastify.get('/roles', {
  onRequest: [verifyAuth, requirePermission('role_view')],
}, async (request, reply) => {
  // ... å®ç°
});

// åˆ›å»ºè§’è‰²
fastify.post('/roles', {
  onRequest: [verifyAuth, requirePermission('role_create')],
}, async (request, reply) => {
  // ... å®ç°
});

// æ›´æ–°è§’è‰²
fastify.put('/roles/:role_id', {
  onRequest: [verifyAuth, requirePermission('role_update')],
}, async (request, reply) => {
  // ... å®ç°
});

// åˆ é™¤è§’è‰²
fastify.delete('/roles/:role_id', {
  onRequest: [verifyAuth, requirePermission('role_delete')],
}, async (request, reply) => {
  // ... å®ç°
});

// è·å–è§’è‰²æƒé™
fastify.get('/roles/:role_id/permissions', {
  onRequest: [verifyAuth, requirePermission('role_view')],
}, async (request, reply) => {
  // ... å®ç°
});

// æ›´æ–°è§’è‰²æƒé™
fastify.put('/roles/:role_id/permissions', {
  onRequest: [verifyAuth, requirePermission('role_update')],
}, async (request, reply) => {
  // ... å®ç°
});

// è·å–æƒé™åˆ—è¡¨
fastify.get('/permissions', {
  onRequest: [verifyAuth, requirePermission('role_view')],
}, async (request, reply) => {
  // ... å®ç°
});

// è·å–æƒé™æ ‘
fastify.get('/permissions/tree', {
  onRequest: [verifyAuth, requirePermission('role_view')],
}, async (request, reply) => {
  // ... å®ç°
});
```

3. **æ–°å¢å®¡è®¡æ—¥å¿—APIè·¯ç”±**
```javascript
// è·å–å®¡è®¡æ—¥å¿—åˆ—è¡¨
fastify.get('/audit-logs', {
  onRequest: [verifyAuth, requirePermission('role_view')],
}, async (request, reply) => {
  // ... å®ç°
});

// è·å–æ—¥å¿—è¯¦æƒ…
fastify.get('/audit-logs/:log_id', {
  onRequest: [verifyAuth, requirePermission('role_view')],
}, async (request, reply) => {
  // ... å®ç°
});

// è·å–æ—¥å¿—ç»Ÿè®¡
fastify.get('/audit-logs/statistics', {
  onRequest: [verifyAuth, requirePermission('role_view')],
}, async (request, reply) => {
  // ... å®ç°
});
```

4. **æ–°å¢å‘Šè­¦é…ç½®APIè·¯ç”±**
```javascript
// è·å–å‘Šè­¦æ—¶é—´é—´éš”é…ç½®
fastify.get('/alerts/config/intervals', {
  onRequest: [verifyAuth, requirePermission('config_view')],
}, async (request, reply) => {
  // ... å®ç°
});

// æ›´æ–°å‘Šè­¦æ—¶é—´é—´éš”é…ç½®
fastify.put('/alerts/config/intervals', {
  onRequest: [verifyAuth, requirePermission('config_update')],
}, async (request, reply) => {
  // ... å®ç°
});

// è·å–å‘Šè­¦ç­‰çº§é…ç½®
fastify.get('/alerts/config/levels', {
  onRequest: [verifyAuth, requirePermission('config_view')],
}, async (request, reply) => {
  // ... å®ç°
});

// æ›´æ–°å‘Šè­¦ç­‰çº§é…ç½®
fastify.put('/alerts/config/levels', {
  onRequest: [verifyAuth, requirePermission('config_update')],
}, async (request, reply) => {
  // ... å®ç°
});
```

5. **æ–°å¢AIé…ç½®APIè·¯ç”±**
```javascript
// è·å–AI Prompté…ç½®
fastify.get('/ai/config/prompts', {
  onRequest: [verifyAuth, requirePermission('config_view')],
}, async (request, reply) => {
  // ... å®ç°
});

// æ›´æ–°AI Prompté…ç½®
fastify.put('/ai/config/prompts', {
  onRequest: [verifyAuth, requirePermission('config_update')],
}, async (request, reply) => {
  // ... å®ç°
});

// åˆ›å»ºPromptç‰ˆæœ¬
fastify.post('/ai/config/prompts/:prompt_id/version', {
  onRequest: [verifyAuth, requirePermission('config_update')],
}, async (request, reply) => {
  // ... å®ç°
});

// è·å–Promptç‰ˆæœ¬åˆ—è¡¨
fastify.get('/ai/config/prompts/:prompt_id/versions', {
  onRequest: [verifyAuth, requirePermission('config_view')],
}, async (request, reply) => {
  // ... å®ç°
});

// æ¿€æ´»Promptç‰ˆæœ¬
fastify.put('/ai/config/prompts/:prompt_id/activate', {
  onRequest: [verifyAuth, requirePermission('config_update')],
}, async (request, reply) => {
  // ... å®ç°
});
```

---

### 3.6 å‰ç«¯é¡µé¢å±‚ä¿®æ”¹

#### ä¿®æ”¹æ–‡ä»¶ï¼š`src/app/layout.tsx`

**ä¿®æ”¹å†…å®¹ï¼š**

1. **æ›´æ–°ä¾§è¾¹æ å¯¼èˆªï¼Œæ–°å¢è®¾ç½®èœå•**
```typescript
// åœ¨ä¾§è¾¹æ å¯¼èˆªä¸­æ–°å¢è®¾ç½®èœå•
{
  title: 'ç³»ç»Ÿè®¾ç½®',
  icon: Settings,
  items: [
    {
      title: 'ç”¨æˆ·ç®¡ç†',
      href: '/settings/users',
      icon: Users,
    },
    {
      title: 'è§’è‰²ç®¡ç†',
      href: '/settings/roles',
      icon: Shield,
    },
    {
      title: 'æƒé™ç®¡ç†',
      href: '/settings/permissions',
      icon: Key,
    },
    {
      title: 'å®¡è®¡æ—¥å¿—',
      href: '/settings/audit-logs',
      icon: FileText,
    },
    {
      title: 'å‘Šè­¦é…ç½®',
      href: '/settings/alert-config',
      icon: AlertTriangle,
    },
    {
      title: 'AIé…ç½®',
      href: '/settings/ai-config',
      icon: Bot,
    },
  ],
}
```

---

## 4. æ–°å»ºæ–‡ä»¶æ¸…å•

### 4.1 æ•°æ®åº“è¿ç§»æ–‡ä»¶ï¼ˆ11ä¸ªï¼‰

| æ–‡ä»¶è·¯å¾„ | è¯´æ˜ | ä¼˜å…ˆçº§ |
|---------|------|-------|
| `server/database/migrations/20240110_add_roles_table.sql` | åˆ›å»ºè§’è‰²è¡¨ | P0 |
| `server/database/migrations/20240110_add_permissions_table.sql` | åˆ›å»ºæƒé™è¡¨ | P0 |
| `server/database/migrations/20240110_add_user_roles_table.sql` | åˆ›å»ºç”¨æˆ·è§’è‰²å…³è”è¡¨ | P0 |
| `server/database/migrations/20240110_add_role_permissions_table.sql` | åˆ›å»ºè§’è‰²æƒé™å…³è”è¡¨ | P0 |
| `server/database/migrations/20240110_add_audit_logs_table.sql` | åˆ›å»ºå®¡è®¡æ—¥å¿—è¡¨ | P0 |
| `server/database/migrations/20240110_add_robots_permissions_table.sql` | åˆ›å»ºæœºå™¨äººæƒé™è¡¨ | P0 |
| `server/database/migrations/20240110_alter_users_table.sql` | ä¿®æ”¹ç”¨æˆ·è¡¨ç»“æ„ | P0 |
| `server/database/migrations/20240110_alter_robots_table.sql` | ä¿®æ”¹æœºå™¨äººè¡¨ç»“æ„ | P0 |
| `server/database/migrations/20240110_alter_system_settings_table.sql` | ä¿®æ”¹ç³»ç»Ÿé…ç½®è¡¨ç»“æ„ | P0 |
| `server/database/seeds/20240110_seed_roles_permissions.sql` | åˆå§‹æ•°æ®ç§å­ | P1 |
| `server/database/migrations/20240110_migrate_existing_data.sql` | æ•°æ®è¿ç§»è„šæœ¬ | P1 |

### 4.2 åç«¯æœåŠ¡æ–‡ä»¶ï¼ˆ6ä¸ªï¼‰

| æ–‡ä»¶è·¯å¾„ | è¯´æ˜ | ä¼˜å…ˆçº§ |
|---------|------|-------|
| `server/services/user.service.js` | ç”¨æˆ·ç®¡ç†æœåŠ¡ | P0 |
| `server/services/role.service.js` | è§’è‰²ç®¡ç†æœåŠ¡ | P0 |
| `server/services/permission.service.js` | æƒé™ç®¡ç†æœåŠ¡ | P0 |
| `server/services/audit-log.service.js` | å®¡è®¡æ—¥å¿—æœåŠ¡ | P0 |
| `server/services/alert-config.service.js` | å‘Šè­¦é…ç½®æœåŠ¡ | P1 |
| `server/services/ai-config.service.js` | AIé…ç½®æœåŠ¡ | P1 |

### 4.3 åç«¯é’©å­å’Œä¸­é—´ä»¶æ–‡ä»¶ï¼ˆ2ä¸ªï¼‰

| æ–‡ä»¶è·¯å¾„ | è¯´æ˜ | ä¼˜å…ˆçº§ |
|---------|------|-------|
| `server/hooks/rbac.hook.js` | åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶é’©å­ | P0 |
| `server/middleware/audit-middleware.js` | æ“ä½œå®¡è®¡ä¸­é—´ä»¶ | P0 |

### 4.4 åç«¯é…ç½®æ–‡ä»¶ï¼ˆ3ä¸ªï¼‰

| æ–‡ä»¶è·¯å¾„ | è¯´æ˜ | ä¼˜å…ˆçº§ |
|---------|------|-------|
| `server/config/alert.config.js` | å‘Šè­¦é…ç½®å¸¸é‡ | P1 |
| `server/config/ai-prompts.config.js` | AI Prompté…ç½® | P1 |
| `server/config/reply-delay.config.js` | å›å¤å»¶è¿Ÿé…ç½® | P1 |

### 4.5 å‰ç«¯é¡µé¢æ–‡ä»¶ï¼ˆ15ä¸ªï¼‰

| æ–‡ä»¶è·¯å¾„ | è¯´æ˜ | ä¼˜å…ˆçº§ |
|---------|------|-------|
| `src/app/settings/users/page.tsx` | ç”¨æˆ·ç®¡ç†é¡µé¢ | P0 |
| `src/components/users/UserForm.tsx` | ç”¨æˆ·è¡¨å•ç»„ä»¶ | P0 |
| `src/components/users/UserList.tsx` | ç”¨æˆ·åˆ—è¡¨ç»„ä»¶ | P0 |
| `src/app/settings/roles/page.tsx` | è§’è‰²ç®¡ç†é¡µé¢ | P0 |
| `src/components/roles/RoleForm.tsx` | è§’è‰²è¡¨å•ç»„ä»¶ | P0 |
| `src/components/roles/RolePermissionSelector.tsx` | è§’è‰²æƒé™é€‰æ‹©å™¨ | P0 |
| `src/app/settings/permissions/page.tsx` | æƒé™ç®¡ç†é¡µé¢ | P0 |
| `src/components/permissions/PermissionTree.tsx` | æƒé™æ ‘ç»„ä»¶ | P0 |
| `src/app/settings/audit-logs/page.tsx` | å®¡è®¡æ—¥å¿—é¡µé¢ | P0 |
| `src/components/audit-logs/AuditLogList.tsx` | å®¡è®¡æ—¥å¿—åˆ—è¡¨ | P0 |
| `src/app/settings/alert-config/page.tsx` | å‘Šè­¦é…ç½®é¡µé¢ | P1 |
| `src/components/alert-config/AlertIntervalForm.tsx` | å‘Šè­¦æ—¶é—´é—´éš”é…ç½®è¡¨å• | P1 |
| `src/components/alert-config/AlertLevelForm.tsx` | å‘Šè­¦ç­‰çº§ç­–ç•¥é…ç½®è¡¨å• | P1 |
| `src/app/settings/ai-config/page.tsx` | AIé…ç½®é¡µé¢ | P1 |
| `src/components/ai-config/AIPromptForm.tsx` | AI Promptè¡¨å• | P1 |
| `src/components/ai-config/PromptVersionList.tsx` | Promptç‰ˆæœ¬åˆ—è¡¨ | P1 |

### 4.6 å‰ç«¯æœåŠ¡æ–‡ä»¶ï¼ˆ6ä¸ªï¼‰

| æ–‡ä»¶è·¯å¾„ | è¯´æ˜ | ä¼˜å…ˆçº§ |
|---------|------|-------|
| `src/lib/services/user-service.ts` | ç”¨æˆ·ç®¡ç†æœåŠ¡ | P0 |
| `src/lib/services/role-service.ts` | è§’è‰²ç®¡ç†æœåŠ¡ | P0 |
| `src/lib/services/permission-service.ts` | æƒé™ç®¡ç†æœåŠ¡ | P0 |
| `src/lib/services/audit-log-service.ts` | å®¡è®¡æ—¥å¿—æœåŠ¡ | P0 |
| `src/lib/services/alert-config-service.ts` | å‘Šè­¦é…ç½®æœåŠ¡ | P1 |
| `src/lib/services/ai-config-service.ts` | AIé…ç½®æœåŠ¡ | P1 |

### 4.7 æµ‹è¯•æ–‡ä»¶ï¼ˆ12ä¸ªï¼‰

| æ–‡ä»¶è·¯å¾„ | è¯´æ˜ | ä¼˜å…ˆçº§ |
|---------|------|-------|
| `server/tests/services/user.service.test.js` | ç”¨æˆ·æœåŠ¡æµ‹è¯• | P2 |
| `server/tests/services/role.service.test.js` | è§’è‰²æœåŠ¡æµ‹è¯• | P2 |
| `server/tests/services/permission.service.test.js` | æƒé™æœåŠ¡æµ‹è¯• | P2 |
| `server/tests/services/audit-log.service.test.js` | å®¡è®¡æ—¥å¿—æœåŠ¡æµ‹è¯• | P2 |
| `server/tests/services/alert-config.service.test.js` | å‘Šè­¦é…ç½®æœåŠ¡æµ‹è¯• | P2 |
| `server/tests/services/ai-config.service.test.js` | AIé…ç½®æœåŠ¡æµ‹è¯• | P2 |
| `server/tests/services/robot.service.test.js` | æœºå™¨äººæœåŠ¡æµ‹è¯• | P2 |
| `server/tests/integration/auth.integration.test.js` | è®¤è¯é›†æˆæµ‹è¯• | P2 |
| `server/tests/integration/rbac.integration.test.js` | RBACé›†æˆæµ‹è¯• | P2 |
| `server/tests/integration/alert.integration.test.js` | å‘Šè­¦é›†æˆæµ‹è¯• | P2 |
| `server/tests/integration/ai.integration.test.js` | AIé›†æˆæµ‹è¯• | P2 |
| `server/tests/integration/robot.integration.test.js` | æœºå™¨äººé›†æˆæµ‹è¯• | P2 |

**æ–°å»ºæ–‡ä»¶æ€»è®¡ï¼š55ä¸ª**

---

## 5. æ— éœ€ä¿®æ”¹æ–‡ä»¶æ¸…å•

### 5.1 æ•°æ®åº“å±‚

ä»¥ä¸‹æ•°æ®åº“ç›¸å…³æ–‡ä»¶æ— éœ€ä¿®æ”¹ï¼š

| æ–‡ä»¶è·¯å¾„ | è¯´æ˜ |
|---------|------|
| `server/database/index.js` | æ•°æ®åº“å¯¼å‡ºæ–‡ä»¶ |
| `server/database/userManager.js` | ç”¨æˆ·ç®¡ç†å™¨ |
| `server/database/systemSettingManager.js` | ç³»ç»Ÿè®¾ç½®ç®¡ç†å™¨ |

### 5.2 åç«¯æœåŠ¡å±‚

ä»¥ä¸‹æœåŠ¡æ–‡ä»¶æ— éœ€ä¿®æ”¹ï¼š

| æ–‡ä»¶è·¯å¾„ | è¯´æ˜ |
|---------|------|
| `server/services/session.service.js` | ä¼šè¯ç®¡ç†æœåŠ¡ |
| `server/services/session-message.service.js` | ä¼šè¯æ¶ˆæ¯æœåŠ¡ |
| `server/services/ai.service.js` | AIåˆ†ææœåŠ¡ |
| `server/services/monitor.service.js` | ç›‘æ§æœåŠ¡ |
| `server/services/report.service.js` | æŠ¥å‘ŠæœåŠ¡ |
| `server/services/alert.service.js` | å‘Šè­¦æœåŠ¡ |
| `server/services/tencentdoc.service.js` | è…¾è®¯æ–‡æ¡£æœåŠ¡ |
| `server/services/worktool.service.js` | WorkToolæœåŠ¡ |
| `server/services/worktool-api.service.js` | WorkTool APIæœåŠ¡ |
| `server/services/message-save-diagnostics.js` | æ¶ˆæ¯ä¿å­˜è¯Šæ–­æœåŠ¡ |
| `server/services/message-cache.service.js` | æ¶ˆæ¯ç¼“å­˜æœåŠ¡ |
| `server/services/system-logger.service.js` | ç³»ç»Ÿæ—¥å¿—æœåŠ¡ |
| `server/services/context-helper.js` | ä¸Šä¸‹æ–‡å¸®åŠ©å™¨ |
| `server/services/flow-engine.service.js` | æµç¨‹å¼•æ“æœåŠ¡ |

### 5.3 åç«¯é’©å­æ–‡ä»¶

ä»¥ä¸‹é’©å­æ–‡ä»¶æ— éœ€ä¿®æ”¹ï¼š

| æ–‡ä»¶è·¯å¾„ | è¯´æ˜ |
|---------|------|
| `server/hooks/robot.hook.js` | æœºå™¨äººé’©å­ |

### 5.4 åç«¯è·¯ç”±æ–‡ä»¶

ä»¥ä¸‹è·¯ç”±æ–‡ä»¶æ— éœ€ä¿®æ”¹ï¼š

| æ–‡ä»¶è·¯å¾„ | è¯´æ˜ |
|---------|------|
| `server/routes/index.js` | è·¯ç”±å…¥å£ |
| `server/routes/api.js` | APIè·¯ç”± |
| `server/routes/auth.api.js` | è®¤è¯APIè·¯ç”± |

### 5.5 å‰ç«¯é¡µé¢æ–‡ä»¶

ä»¥ä¸‹å‰ç«¯é¡µé¢æ–‡ä»¶æ— éœ€ä¿®æ”¹ï¼š

| æ–‡ä»¶è·¯å¾„ | è¯´æ˜ |
|---------|------|
| `src/app/page.tsx` | ä¸»é¡µé¢ |
| `src/app/auth/login/page.tsx` | ç™»å½•é¡µé¢ |
| `src/app/dashboard/page.tsx` | ä»ªè¡¨ç›˜é¡µé¢ |
| `src/app/robots/page.tsx` | æœºå™¨äººç®¡ç†é¡µé¢ |
| `src/app/sessions/page.tsx` | ä¼šè¯ç®¡ç†é¡µé¢ |
| `src/app/alerts/page.tsx` | å‘Šè­¦ç®¡ç†é¡µé¢ |
| `src/app/collaboration/page.tsx` | ååŒåˆ†æé¡µé¢ |
| `src/app/after-sales/page.tsx` | å”®åä»»åŠ¡é¡µé¢ |

### 5.6 å‰ç«¯ç»„ä»¶æ–‡ä»¶

ä»¥ä¸‹å‰ç«¯ç»„ä»¶æ–‡ä»¶æ— éœ€ä¿®æ”¹ï¼š

| æ–‡ä»¶è·¯å¾„ | è¯´æ˜ |
|---------|------|
| `src/components/ui/*` | shadcn/uiç»„ä»¶åº“ |
| `src/components/layout/Header.tsx` | å¤´éƒ¨ç»„ä»¶ |
| `src/components/risk/*` | é£é™©åˆ†æç»„ä»¶ |
| `src/components/robot/*` | æœºå™¨äººç»„ä»¶ |
| `src/components/session/*` | ä¼šè¯ç»„ä»¶ |
| `src/components/alert/*` | å‘Šè­¦ç»„ä»¶ |

### 5.7 å‰ç«¯æœåŠ¡æ–‡ä»¶

ä»¥ä¸‹å‰ç«¯æœåŠ¡æ–‡ä»¶æ— éœ€ä¿®æ”¹ï¼š

| æ–‡ä»¶è·¯å¾„ | è¯´æ˜ |
|---------|------|
| `src/lib/services/session-service.ts` | ä¼šè¯æœåŠ¡ |
| `src/lib/services/session-lifecycle-service.ts` | ä¼šè¯ç”Ÿå‘½å‘¨æœŸæœåŠ¡ |
| `src/lib/services/collaboration-decision-service.ts` | ååŒå†³ç­–æœåŠ¡ |
| `src/lib/services/intervention-service.ts` | ä»‹å…¥æœåŠ¡ |
| `src/lib/services/message-service.ts` | æ¶ˆæ¯æœåŠ¡ |
| `src/lib/services/robot-service.ts` | æœºå™¨äººæœåŠ¡ |
| `src/lib/services/alert-service.ts` | å‘Šè­¦æœåŠ¡ |
| `src/lib/services/monitor-service.ts` | ç›‘æ§æœåŠ¡ |
| `src/services/after-sales-task-service.ts` | å”®åä»»åŠ¡æœåŠ¡ |
| `src/services/staff-message-context-service.ts` | å·¥ä½œäººå‘˜æ¶ˆæ¯ä¸Šä¸‹æ–‡æœåŠ¡ |

---

## 6. ä¿®æ”¹ä¼˜å…ˆçº§

### 6.1 ä¼˜å…ˆçº§è¯´æ˜

| ä¼˜å…ˆçº§ | è¯´æ˜ | å®Œæˆæ—¶é—´ |
|-------|------|---------|
| P0 | æ ¸å¿ƒåŠŸèƒ½ï¼Œå¿…é¡»ä¼˜å…ˆå®Œæˆ | ç¬¬1-2å‘¨ |
| P1 | é‡è¦åŠŸèƒ½ï¼Œéœ€è¦å°½å¿«å®Œæˆ | ç¬¬3-4å‘¨ |
| P2 | æµ‹è¯•åŠŸèƒ½ï¼Œå¯ä»¥å»¶åå®Œæˆ | ç¬¬5-6å‘¨ |

### 6.2 P0çº§æ–‡ä»¶æ¸…å•ï¼ˆå¿…é¡»ä¼˜å…ˆå®Œæˆï¼‰

**æ•°æ®åº“å±‚ï¼ˆ9ä¸ªï¼‰ï¼š**
1. `server/database/migrations/20240110_add_roles_table.sql`
2. `server/database/migrations/20240110_add_permissions_table.sql`
3. `server/database/migrations/20240110_add_user_roles_table.sql`
4. `server/database/migrations/20240110_add_role_permissions_table.sql`
5. `server/database/migrations/20240110_add_audit_logs_table.sql`
6. `server/database/migrations/20240110_add_robots_permissions_table.sql`
7. `server/database/migrations/20240110_alter_users_table.sql`
8. `server/database/migrations/20240110_alter_robots_table.sql`
9. `server/database/migrations/20240110_alter_system_settings_table.sql`

**åç«¯æœåŠ¡å±‚ï¼ˆ4ä¸ªï¼‰ï¼š**
1. `server/services/user.service.js`
2. `server/services/role.service.js`
3. `server/services/permission.service.js`
4. `server/services/audit-log.service.js`

**åç«¯é’©å­å’Œä¸­é—´ä»¶ï¼ˆ2ä¸ªï¼‰ï¼š**
1. `server/hooks/rbac.hook.js`
2. `server/middleware/audit-middleware.js`

**å‰ç«¯é¡µé¢å±‚ï¼ˆ10ä¸ªï¼‰ï¼š**
1. `src/app/settings/users/page.tsx`
2. `src/components/users/UserForm.tsx`
3. `src/components/users/UserList.tsx`
4. `src/app/settings/roles/page.tsx`
5. `src/components/roles/RoleForm.tsx`
6. `src/components/roles/RolePermissionSelector.tsx`
7. `src/app/settings/permissions/page.tsx`
8. `src/components/permissions/PermissionTree.tsx`
9. `src/app/settings/audit-logs/page.tsx`
10. `src/components/audit-logs/AuditLogList.tsx`

**å‰ç«¯æœåŠ¡å±‚ï¼ˆ4ä¸ªï¼‰ï¼š**
1. `src/lib/services/user-service.ts`
2. `src/lib/services/role-service.ts`
3. `src/lib/services/permission-service.ts`
4. `src/lib/services/audit-log-service.ts`

**éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶ï¼ˆ5ä¸ªï¼‰ï¼š**
1. `server/database/schema.js`
2. `server/services/robot.service.js`
3. `server/services/message.service.js`
4. `server/hooks/auth.hook.js`
5. `server/lib/config.js`
6. `server/routes/admin.api.js`
7. `src/app/layout.tsx`

### 6.3 P1çº§æ–‡ä»¶æ¸…å•ï¼ˆé‡è¦åŠŸèƒ½ï¼Œéœ€è¦å°½å¿«å®Œæˆï¼‰

**æ•°æ®åº“å±‚ï¼ˆ2ä¸ªï¼‰ï¼š**
1. `server/database/seeds/20240110_seed_roles_permissions.sql`
2. `server/database/migrations/20240110_migrate_existing_data.sql`

**åç«¯æœåŠ¡å±‚ï¼ˆ2ä¸ªï¼‰ï¼š**
1. `server/services/alert-config.service.js`
2. `server/services/ai-config.service.js`

**åç«¯é…ç½®å±‚ï¼ˆ3ä¸ªï¼‰ï¼š**
1. `server/config/alert.config.js`
2. `server/config/ai-prompts.config.js`
3. `server/config/reply-delay.config.js`

**å‰ç«¯é¡µé¢å±‚ï¼ˆ6ä¸ªï¼‰ï¼š**
1. `src/app/settings/alert-config/page.tsx`
2. `src/components/alert-config/AlertIntervalForm.tsx`
3. `src/components/alert-config/AlertLevelForm.tsx`
4. `src/app/settings/ai-config/page.tsx`
5. `src/components/ai-config/AIPromptForm.tsx`
6. `src/components/ai-config/PromptVersionList.tsx`

**å‰ç«¯æœåŠ¡å±‚ï¼ˆ2ä¸ªï¼‰ï¼š**
1. `src/lib/services/alert-config-service.ts`
2. `src/lib/services/ai-config-service.ts`

### 6.4 P2çº§æ–‡ä»¶æ¸…å•ï¼ˆæµ‹è¯•åŠŸèƒ½ï¼Œå¯ä»¥å»¶åå®Œæˆï¼‰

**æµ‹è¯•å±‚ï¼ˆ12ä¸ªï¼‰ï¼š**
1. `server/tests/services/user.service.test.js`
2. `server/tests/services/role.service.test.js`
3. `server/tests/services/permission.service.test.js`
4. `server/tests/services/audit-log.service.test.js`
5. `server/tests/services/alert-config.service.test.js`
6. `server/tests/services/ai-config.service.test.js`
7. `server/tests/services/robot.service.test.js`
8. `server/tests/integration/auth.integration.test.js`
9. `server/tests/integration/rbac.integration.test.js`
10. `server/tests/integration/alert.integration.test.js`
11. `server/tests/integration/ai.integration.test.js`
12. `server/tests/integration/robot.integration.test.js`

---

## é™„å½•

### A. æ–‡ä»¶ç»Ÿè®¡

| åˆ†ç±» | ä¿®æ”¹ | æ–°å»º | æ— éœ€ä¿®æ”¹ | æ€»è®¡ |
|------|------|------|---------|------|
| æ•°æ®åº“å±‚ | 1 | 11 | 3 | 15 |
| åç«¯æœåŠ¡å±‚ | 2 | 6 | 14 | 22 |
| åç«¯é’©å­å’Œä¸­é—´ä»¶ | 1 | 2 | 1 | 4 |
| åç«¯é…ç½®å±‚ | 1 | 3 | 0 | 4 |
| åç«¯è·¯ç”±å±‚ | 1 | 0 | 3 | 4 |
| å‰ç«¯é¡µé¢å±‚ | 2 | 15 | 8 | 25 |
| å‰ç«¯ç»„ä»¶å±‚ | 0 | 0 | 20+ | 20+ |
| å‰ç«¯æœåŠ¡å±‚ | 0 | 6 | 10 | 16 |
| æµ‹è¯•å±‚ | 0 | 12 | 0 | 12 |
| **æ€»è®¡** | **8** | **55** | **60+** | **123+** |

### B. ä¿®æ”¹å·¥ä½œé‡ä¼°ç®—

| é˜¶æ®µ | æ–‡ä»¶æ•° | é¢„è®¡å·¥æ—¶ |
|------|-------|---------|
| æ•°æ®åº“å±‚ | 12 | 8-12å°æ—¶ |
| åç«¯æœåŠ¡å±‚ | 8 | 24-32å°æ—¶ |
| åç«¯é’©å­å’Œä¸­é—´ä»¶ | 3 | 8-12å°æ—¶ |
| åç«¯é…ç½®å±‚ | 4 | 6-8å°æ—¶ |
| åç«¯è·¯ç”±å±‚ | 1 | 12-16å°æ—¶ |
| å‰ç«¯é¡µé¢å±‚ | 17 | 32-40å°æ—¶ |
| å‰ç«¯æœåŠ¡å±‚ | 6 | 12-16å°æ—¶ |
| æµ‹è¯•å±‚ | 12 | 16-20å°æ—¶ |
| **æ€»è®¡** | **63** | **118-156å°æ—¶** |

### C. å…³é”®ä¾èµ–å…³ç³»

```
æ•°æ®åº“å±‚
  â†“
åç«¯æœåŠ¡å±‚
  â†“
åç«¯è·¯ç”±å±‚
  â†“
å‰ç«¯æœåŠ¡å±‚
  â†“
å‰ç«¯é¡µé¢å±‚
  â†“
æµ‹è¯•å±‚
```

**è¯´æ˜ï¼š**
1. æ•°æ®åº“å±‚å¿…é¡»å…ˆå®Œæˆï¼Œåç»­æ‰€æœ‰å¼€å‘éƒ½ä¾èµ–æ•°æ®åº“è¡¨
2. åç«¯æœåŠ¡å±‚ä¾èµ–æ•°æ®åº“å±‚
3. åç«¯è·¯ç”±å±‚ä¾èµ–åç«¯æœåŠ¡å±‚
4. å‰ç«¯æœåŠ¡å±‚ä¾èµ–åç«¯è·¯ç”±å±‚
5. å‰ç«¯é¡µé¢å±‚ä¾èµ–å‰ç«¯æœåŠ¡å±‚
6. æµ‹è¯•å±‚ä¾èµ–ä»¥ä¸Šæ‰€æœ‰å±‚

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0

**æœ€åæ›´æ–°**ï¼š2024-01-10

**æ–‡æ¡£ä½œè€…**ï¼šWorkTool AI å›¢é˜Ÿ
