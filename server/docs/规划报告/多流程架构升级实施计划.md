# 多流程架构升级实施计划

## 📋 项目信息

- **项目名称**：WorkTool AI 流程引擎多流程架构升级
- **目标版本**：v6.0.0
- **当前版本**：v5.0.0（单流程架构）
- **预计工期**：5-7天
- **优先级**：P0（高优先级）

---

## 🎯 升级目标

### 主要目标
1. ✅ 将单流程架构升级为多流程架构
2. ✅ 实现FLOW_CALL节点（流程调用）
3. ✅ 实现DELAY节点（延迟策略）
4. ✅ 创建12个流程文件（1个主流程 + 11个子流程）
5. ✅ 支持完整的消息处理场景

### 预期收益
- 🎯 **可维护性**：提升60%（模块化设计）
- 🎯 **开发效率**：提升50%（流程复用）
- 🎯 **测试效率**：提升70%（独立测试）
- 🎯 **扩展性**：提升80%（新增流程容易）

---

## 📦 工作范围

### 1. 节点类型扩展（2个新增）

| 节点类型 | 说明 | 优先级 |
|---------|------|--------|
| FLOW_CALL | 流程调用节点，支持调用其他流程 | P0 |
| DELAY | 延迟节点，支持多种延迟策略 | P0 |

### 2. 节点处理器实现（2个）

| 处理器 | 文件 | 行数估算 | 优先级 |
|--------|------|---------|--------|
| handleFlowCallNode | flow-engine.service.js | ~200行 | P0 |
| handleDelayNode | flow-engine.service.js | ~150行 | P0 |

### 3. 流程文件创建（12个）

| 文件名 | 节点数 | 边数估算 | 优先级 |
|--------|--------|---------|--------|
| 00-main-flow.json | 23 | ~35 | P0 |
| 01-text-processing.json | 12 | ~18 | P0 |
| 02-image-processing.json | 7 | ~10 | P0 |
| 03-voice-processing.json | 7 | ~10 | P0 |
| 04-alert-handling.json | 9 | ~14 | P0 |
| 05-after-sales.json | 12 | ~18 | P0 |
| 06-staff-intervention.json | 6 | ~8 | P0 |
| 07-collaboration-analysis.json | 9 | ~14 | P1 |
| 08-command-status.json | 6 | ~8 | P1 |
| 09-community-analysis.json | 8 | ~12 | P1 |
| 10-after-sales-analysis.json | 8 | ~12 | P1 |
| 11-operator-maintenance.json | 8 | ~12 | P1 |

---

## 📅 实施步骤

### 第1天：节点类型扩展和处理器实现

#### 任务1.1：添加FLOW_CALL和DELAY节点类型
- **文件**：`server/services/flow-engine.service.js`
- **修改内容**：
  ```javascript
  const NodeType = {
    // ... 现有节点类型
    FLOW_CALL: 'flow_call',
    DELAY: 'delay'
  };
  ```
- **预计时间**：5分钟
- **验证**：检查NodeType枚举是否正确

#### 任务1.2：实现handleFlowCallNode处理器
- **文件**：`server/services/flow-engine.service.js`
- **实现内容**：
  - 解析flow_call配置（flowId, version, timeout, retryCount, async, params, responseMapping）
  - 获取子流程定义
  - 解析参数（支持模板语法 `{{context.xxx}}`）
  - 执行子流程（同步/异步）
  - 映射返回值到context
- **预计时间**：1.5小时
- **验证**：
  - 测试同步调用子流程
  - 测试异步调用子流程
  - 测试参数传递
  - 测试返回值映射

#### 任务1.3：实现handleDelayNode处理器
- **文件**：`server/services/flow-engine.service.js`
- **实现内容**：
  - 解析delay配置（delayMode, delayTime, minDelay, maxDelay, strategy, strategies）
  - 计算延迟时间（fixed/random/strategy）
  - 实现时间策略（day_shift/night_shift/emergency）
  - 支持条件检查和重试
  - 支持超时处理（continue/abort）
- **预计时间**：1小时
- **验证**：
  - 测试固定延迟
  - 测试随机延迟
  - 测试时间策略
  - 测试条件检查
  - 测试重试和超时

#### 任务1.4：注册节点处理器
- **文件**：`server/services/flow-engine.service.js`
- **修改内容**：
  ```javascript
  this.nodeHandlers = {
    // ... 现有节点处理器
    [NodeType.FLOW_CALL]: this.handleFlowCallNode.bind(this),
    [NodeType.DELAY]: this.handleDelayNode.bind(this)
  };
  ```
- **预计时间**：5分钟
- **验证**：检查处理器是否正确注册

**第1天预计总时间**：~3小时

---

### 第2-3天：创建主流程和核心子流程

#### 任务2.1：创建主流程文件（00-main-flow.json）
- **文件**：`server/flows/default/00-main-flow.json`
- **节点清单**：23个节点
  - 1. start
  - 2. message_receive
  - 3. decision（身份识别）
  - 4-6. log_save/flow_call（系统机器人/售后机器人/工作人员/运营）
  - 7. session_create
  - 8. context_enhancer
  - 9. unified_analyze
  - 10. decision（消息类型判断）
  - 11-13. flow_call（文本/图片/语音）
  - 14. decision（意图路由）
  - 15-18. flow_call（售后/告警/人工/协同）
  - 19. log_save
  - 20. end
- **边数**：~35条
- **预计时间**：2小时
- **验证**：
  - 检查节点ID唯一性
  - 检查边连接正确性
  - 检查flow_call配置正确性

#### 任务2.2：创建文本处理流程文件（01-text-processing.json）
- **文件**：`server/flows/default/01-text-processing.json`
- **节点清单**：12个节点
  - 1. start
  - 2. ai_reply（文本理解）
  - 3. decision（复杂度判断）
  - 4-5. ai_reply（简单/深度回复）
  - 6. decision（人工活跃度检查）
  - 7. delay（等待人工）
  - 8. delay（延迟策略）
  - 9. robot_dispatch
  - 10. send_command
  - 11. flow_call（命令状态）
  - 12. end
- **边数**：~18条
- **预计时间**：1.5小时
- **验证**：
  - 检查decision分支逻辑
  - 检查delay策略配置
  - 检查flow_call配置

#### 任务2.3：创建图片处理流程文件（02-image-processing.json）
- **文件**：`server/flows/default/02-image-processing.json`
- **节点清单**：7个节点
  - 1. start
  - 2. image_process（上传）
  - 3. image_process（识别）
  - 4. ai_reply_enhanced（分析）
  - 5. ai_reply_enhanced（回复）
  - 6. flow_call（命令状态）
  - 7. end
- **边数**：~10条
- **预计时间**：1小时
- **验证**：
  - 检查image_process配置
  - 检查ai_reply_enhanced配置

#### 任务2.4：创建语音处理流程文件（03-voice-processing.json）
- **文件**：`server/flows/default/03-voice-processing.json`
- **节点清单**：7个节点
  - 1. start
  - 2. http_request（上传）
  - 3. http_request（ASR）
  - 4. flow_call（文本处理）
  - 5. http_request（TTS）
  - 6. flow_call（命令状态）
  - 7. end
- **边数**：~10条
- **预计时间**：1小时
- **验证**：
  - 检查http_request配置
  - 检查flow_call配置

#### 任务2.5：创建告警处理流程文件（04-alert-handling.json）
- **文件**：`server/flows/default/04-alert-handling.json`
- **节点清单**：9个节点
  - 1. start
  - 2. alert_rule（规则评估）
  - 3. decision（告警检查）
  - 4. alert_save（保存）
  - 5. alert_notify（通知）
  - 6. decision（升级检查）
  - 7. alert_escalate（升级）
  - 8. log_save
  - 9. end
- **边数**：~14条
- **预计时间**：1.5小时
- **验证**：
  - 检查alert_rule配置
  - 检查升级循环逻辑
  - 检查alert_notify配置

**第2-3天预计总时间**：~7小时

---

### 第4天：创建业务子流程

#### 任务3.1：创建售后处理流程文件（05-after-sales.json）
- **文件**：`server/flows/default/05-after-sales.json`
- **节点清单**：12个节点
  - 1. start
  - 2. decision（任务检测）
  - 3. task_assign（创建）
  - 4. task_assign（分配）
  - 5. flow_call（协同分析）
  - 6. delay（监控）
  - 7. decision（超时检查）
  - 8. notification（提醒）
  - 9. decision（完成检查）
  - 10. task_assign（完成）
  - 11. flow_call（命令状态）
  - 12. end
- **边数**：~18条
- **预计时间**：1.5小时
- **验证**：
  - 检查task_assign配置
  - 检查超时提醒逻辑
  - 检查完成检查逻辑

#### 任务3.2：创建人工转接流程文件（06-staff-intervention.json）
- **文件**：`server/flows/default/06-staff-intervention.json`
- **节点清单**：6个节点
  - 1. start
  - 2. staff_intervention（匹配）
  - 3. staff_intervention（转移）
  - 4. notification（通知）
  - 5. flow_call（命令状态）
  - 6. end
- **边数**：~8条
- **预计时间**：1小时
- **验证**：
  - 检查staff_intervention配置
  - 检查会话转移逻辑

#### 任务3.3：创建协同分析流程文件（07-collaboration-analysis.json）
- **文件**：`server/flows/default/07-collaboration-analysis.json`
- **节点清单**：9个节点
  - 1. start
  - 2. collaboration_analyze（人工活跃度）
  - 3. satisfaction_infer（用户满意度）
  - 4. collaboration_analyze（员工满意度）
  - 5. task_assign（任务追踪）
  - 6. collaboration_analyze（运营语气）
  - 7. decision（介入决策）
  - 8. staff_intervention（介入行动）
  - 9. data_transform（报告生成）
  - 10. end
- **边数**：~14条
- **预计时间**：1.5小时
- **验证**：
  - 检查collaboration_analyze配置
  - 检查satisfaction_infer配置
  - 检查介入决策逻辑

**第4天预计总时间**：~4小时

---

### 第5天：创建辅助子流程和导入数据库

#### 任务4.1：创建命令状态流程文件（08-command-status.json）
- **文件**：`server/flows/default/08-command-status.json`
- **节点清单**：6个节点
  - 1. start
  - 2. robot_dispatch
  - 3. send_command
  - 4. command_status
  - 5. log_save
  - 6. end
- **边数**：~8条
- **预计时间**：30分钟
- **验证**：
  - 检查command_status配置
  - 检查流程可被其他流程调用

#### 任务4.2：创建社群数据分析流程文件（09-community-analysis.json）
- **文件**：`server/flows/default/09-community-analysis.json`
- **节点清单**：8个节点
  - 1. start
  - 2. data_query（用户活跃度）
  - 3. data_query（消息类型）
  - 4. data_query（意图分析）
  - 5. data_query（工作人员分析）
  - 6. data_query（机器人分析）
  - 7. data_transform（报告生成）
  - 8. end
- **边数**：~12条
- **预计时间**：1小时
- **验证**：
  - 检查data_query配置
  - 检查report生成配置

#### 任务4.3：创建售后数据分析流程文件（10-after-sales-analysis.json）
- **文件**：`server/flows/default/10-after-sales-analysis.json`
- **节点清单**：8个节点
  - 1. start
  - 2. data_query（售后效率）
  - 3. data_query（售后场景）
  - 4. data_query（售后人员）
  - 5. data_query（改进建议）
  - 6. data_transform（报告生成）
  - 7. end
- **边数**：~12条
- **预计时间**：1小时
- **验证**：
  - 检查data_query配置
  - 检查report生成配置

#### 任务4.4：创建运营维护流程文件（11-operator-maintenance.json）
- **文件**：`server/flows/default/11-operator-maintenance.json`
- **节点清单**：8个节点
  - 1. start
  - 2. decision（优先级判断）
  - 3. collaboration_analyze（语气监控）
  - 4. satisfaction_infer（配合度监控）
  - 5. data_query（建议采纳率）
  - 6. notification（定期回访）
  - 7. end
- **边数**：~12条
- **预计时间**：1小时
- **验证**：
  - 检查collaboration_analyze配置
  - 检查notification配置

#### 任务4.5：创建流程导入脚本
- **文件**：`server/scripts/import-multi-flows.js`
- **功能**：
  - 读取所有流程文件
  - 验证流程格式
  - 导入到数据库
  - 设置版本和优先级
- **预计时间**：1小时
- **验证**：
  - 测试导入脚本
  - 检查数据库中的流程记录
  - 检查流程版本

**第5天预计总时间**：~4.5小时

---

### 第6天：测试和验证

#### 任务5.1：FLOW_CALL节点测试
- **测试用例**：
  - 测试同步调用子流程
  - 测试异步调用子流程
  - 测试参数传递（模板语法）
  - 测试返回值映射
  - 测试子流程不存在
  - 测试超时处理
  - 测试重试机制
- **预计时间**：1.5小时
- **验证标准**：所有测试用例通过

#### 任务5.2：DELAY节点测试
- **测试用例**：
  - 测试固定延迟
  - 测试随机延迟
  - 测试时间策略（白班/晚班）
  - 测试紧急消息延迟
  - 测试条件检查
  - 测试重试机制
  - 测试超时处理
- **预计时间**：1.5小时
- **验证标准**：所有测试用例通过

#### 任务5.3：主流程测试
- **测试用例**：
  - 测试消息接收
  - 测试身份识别（8种角色）
  - 测试消息类型判断（文本/图片/语音）
  - 测试意图路由（售后/告警/人工/协同）
  - 测试流程调用
  - 测试日志记录
- **预计时间**：2小时
- **验证标准**：所有测试用例通过

#### 任务5.4：子流程测试
- **测试用例**：
  - 测试文本处理流程
  - 测试图片处理流程
  - 测试语音处理流程
  - 测试告警处理流程（含升级循环）
  - 测试售后处理流程
  - 测试人工转接流程
- **预计时间**：2.5小时
- **验证标准**：所有测试用例通过

**第6天预计总时间**：~7.5小时

---

### 第7天：文档和交付

#### 任务6.1：更新文档
- **文档列表**：
  - 流程引擎架构说明
  - 节点类型文档
  - 流程使用指南
  - API接口文档
- **预计时间**：2小时

#### 任务6.2：生成测试报告
- **内容**：
  - 测试用例清单
  - 测试结果统计
  - 问题清单
  - 修复建议
- **预计时间**：1小时

#### 任务6.3：代码审查
- **审查内容**：
  - 代码质量
  - 命名规范
  - 注释完整性
  - 错误处理
- **预计时间**：1.5小时

#### 任务6.4：部署准备
- **内容**：
  - 备份现有流程
  - 准备回滚方案
  - 编写部署脚本
- **预计时间**：1小时

**第7天预计总时间**：~5.5小时

---

## 📊 时间统计

| 阶段 | 预计时间 | 占比 |
|------|---------|------|
| 节点扩展 | 3小时 | 10% |
| 主流程和核心子流程 | 7小时 | 24% |
| 业务子流程 | 4小时 | 14% |
| 辅助子流程和导入 | 4.5小时 | 15% |
| 测试验证 | 7.5小时 | 26% |
| 文档和交付 | 5.5小时 | 19% |
| **总计** | **31.5小时** | **100%** |

**工作日计算**：31.5小时 ÷ 6小时/天 = **5.25天**

**建议工期**：**6天**（留1天缓冲）

---

## ✅ 验收标准

### 功能验收
- [ ] FLOW_CALL节点可以正常调用子流程
- [ ] DELAY节点可以正常延迟执行
- [ ] 主流程可以正确路由到子流程
- [ ] 12个流程文件格式正确
- [ ] 所有节点配置完整
- [ ] 所有流程可以导入数据库

### 质量验收
- [ ] 代码覆盖率 > 80%
- [ ] 所有测试用例通过
- [ ] 无P0/P1级别bug
- [ ] 文档完整
- [ ] 代码审查通过

### 性能验收
- [ ] 流程执行时间 < 100ms（不含子流程）
- [ ] FLOW_CALL调用延迟 < 50ms
- [ ] DELAY精度误差 < 100ms
- [ ] 并发处理能力 > 100 req/s

---

## 🚨 风险和应对

| 风险 | 概率 | 影响 | 应对措施 |
|------|------|------|---------|
| FLOW_CALL节点实现复杂 | 中 | 高 | 提前设计，分步实现 |
| 子流程间参数传递错误 | 中 | 中 | 编写单元测试，严格验证 |
| 延迟策略逻辑错误 | 低 | 中 | 详细设计，充分测试 |
| 流程导入失败 | 低 | 高 | 备份现有流程，准备回滚 |
| 性能问题 | 中 | 中 | 性能测试，优化关键路径 |
| 时间延期 | 中 | 中 | 预留缓冲时间，优先完成P0任务 |

---

## 📝 交付物

### 代码交付
1. ✅ 修改后的`flow-engine.service.js`（新增2个节点处理器）
2. ✅ 12个流程文件（JSON格式）
3. ✅ 流程导入脚本

### 文档交付
1. ✅ 多流程架构设计文档（v6.0.0）
2. ✅ 节点类型文档
3. ✅ 流程使用指南
4. ✅ API接口文档
5. ✅ 测试报告

### 数据交付
1. ✅ 数据库流程定义记录
2. ✅ 测试数据

---

## 🎯 成功标准

项目成功的标准：
1. ✅ 所有P0功能实现
2. ✅ 所有测试用例通过
3. ✅ 文档完整
4. ✅ 代码审查通过
5. ✅ 无严重bug
6. ✅ 性能满足要求
7. ✅ 按时交付

---

**文档版本**：v1.0
**创建日期**：2025-01-10
**预计开始时间**：2025-01-11
**预计完成时间**：2025-01-16
